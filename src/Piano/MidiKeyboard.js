"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const events_1 = require("events");
const WebMidi = require('webmidi');
class MidiKeyboard extends events_1.EventEmitter {
    constructor() {
        super();
        this.connectedDevices = new Map();
        this.msgs = [];
        console.group(`MidiKeyboard.constructor()`);
        this.ready = new Promise((done, error) => {
            WebMidi.enable((e) => {
                if (e) {
                    error(e);
                }
                WebMidi.addListener('connected', (event) => {
                    console.log(`%cWebMidi connected (name: ${event.port.name}, type: ${event.port.type})`, 'color: #0F9D58', event);
                    if (event.port.type === 'input') {
                        this._addListeners(event.port);
                    }
                });
                WebMidi.addListener('disconnected', (event) => {
                    console.log(`%cWebMidi disconnected (name: ${event.port.name}, type: ${event.port.type})`, 'color: #DB4437', event);
                    this._removeListeners(event.port);
                });
                done();
            });
        });
        console.groupEnd();
    }
    _addListeners(device) {
        if (!this.connectedDevices.has(device.id)) {
            this.connectedDevices.set(device.id, device);
            console.log(`connected device id: ${device.id}`);
            device.addListener('noteon', 'all', (event) => {
                const msg = {
                    time: event.timestamp / 1000,
                    note: event.note.number,
                    kind: 'on',
                    velocity: event.rawVelocity
                };
                this.msgs.push(msg);
                console.log('%cnoteon', 'color: #0F9D58', msg);
                this.emit('keyDown', `${event.note.name}${event.note.octave}`, event.velocity);
            });
            device.addListener('noteoff', 'all', (event) => {
                const msg = {
                    time: event.timestamp / 1000,
                    note: event.note.number,
                    kind: 'off',
                };
                console.log('%cnoteoff', 'color: #DB4437', msg);
                this.msgs.push(msg);
                this.emit('keyUp', `${event.note.name}${event.note.octave}`, event.velocity);
            });
            device.addListener('controlchange', 'all', (event) => {
                if (event.controller.name === 'holdpedal') {
                    this.emit(event.value ? 'pedalDown' : 'pedalUp');
                }
            });
        }
    }
    _removeListeners(event) {
        if (this.connectedDevices.has(event.id)) {
            const device = this.connectedDevices.get(event.id);
            this.connectedDevices.delete(event.id);
            device.removeListener('noteon');
            device.removeListener('noteoff');
            device.removeListener('controlchange');
        }
    }
}
exports.MidiKeyboard = MidiKeyboard;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWlkaUtleWJvYXJkLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTWlkaUtleWJvYXJkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQXFDO0FBTXJDLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUVuQyxNQUFhLFlBQWEsU0FBUSxxQkFBWTtJQU0xQztRQUNJLEtBQUssRUFBRSxDQUFDO1FBTEoscUJBQWdCLEdBQXVCLElBQUksR0FBRyxFQUFFLENBQUM7UUFFaEQsU0FBSSxHQUFXLEVBQUUsQ0FBQztRQUl2QixPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixDQUFDLENBQUM7UUFFNUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUVyQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2pCLElBQUssQ0FBQyxFQUFHO29CQUNMLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDWDtnQkFDRCxPQUFPLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUV2QyxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksV0FBVyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUNqSCxJQUFLLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLE9BQU8sRUFBRzt3QkFDL0IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7cUJBQ2pDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO2dCQUNILE9BQU8sQ0FBQyxXQUFXLENBQUMsY0FBYyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7b0JBQzFDLE9BQU8sQ0FBQyxHQUFHLENBQUMs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QyxLQUFLLENBQUMsRUFBRSxDQUFDLEVBQUc7WUFDdkMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbkQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkMsTUFBTSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNoQyxNQUFNLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUE7U0FFekM7SUFDTCxDQUFDO0NBQ0o7QUFsRkQsb0NBa0ZDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJ1xuaW1wb3J0IHsgSW5wdXQsIElucHV0RXZlbnROb3Rlb2ZmLCBJbnB1dEV2ZW50Tm90ZW9uLCBXZWJNaWRpIH0gZnJvbSBcIndlYm1pZGlcIjtcbmltcG9ydCB7IElNc2csIEtpbmQgfSBmcm9tIFwiLi4vTXlQeVNoZWxsXCI7XG4vLyBpbXBvcnQgKiBhcyB3ZWJtaWRpIGZyb20gJ3dlYm1pZGknXG4vLyB3ZWJtaWRpID0gd2VibWlkaSBhcyBXZWJNaWRpO1xuXG5jb25zdCBXZWJNaWRpID0gcmVxdWlyZSgnd2VibWlkaScpO1xuXG5leHBvcnQgY2xhc3MgTWlkaUtleWJvYXJkIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBcbiAgICBwcml2YXRlIGNvbm5lY3RlZERldmljZXM6IE1hcDxzdHJpbmcsIElucHV0PiA9IG5ldyBNYXAoKTtcbiAgICByZWFkb25seSByZWFkeTogUHJvbWlzZTx1bmtub3duPjtcbiAgICByZWFkb25seSBtc2dzOiBJTXNnW10gPSBbXTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgY29uc29sZS5ncm91cChgTWlkaUtleWJvYXJkLmNvbnN0cnVjdG9yKClgKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMucmVhZHkgPSBuZXcgUHJvbWlzZSgoZG9uZSwgZXJyb3IpID0+IHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgV2ViTWlkaS5lbmFibGUoKGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIGUgKSB7XG4gICAgICAgICAgICAgICAgICAgIGVycm9yKGUpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFdlYk1pZGkuYWRkTGlzdGVuZXIoJ2Nvbm5lY3RlZCcsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCVjV2ViTWlkaSBjb25uZWN0ZWQgKG5hbWU6ICR7ZXZlbnQucG9ydC5uYW1lfSwgdHlwZTogJHtldmVudC5wb3J0LnR5cGV9KWAsICdjb2xvcjogIzBGOUQ1OCcsIGV2ZW50KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBldmVudC5wb3J0LnR5cGUgPT09ICdpbnB1dCcgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9hZGRMaXN0ZW5lcnMoZXZlbnQucG9ydClcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIFdlYk1pZGkuYWRkTGlzdGVuZXIoJ2Rpc2Nvbm5lY3RlZCcsIChldmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJWNXZWJNaWRpIGRpc2Nvbm5lY3RlZCAobmFtZTogJHtldmVudC5wb3J0Lm5hbWV9LCB0eXBlOiAke2V2ZW50LnBvcnQudHlwZX0pYCwgJ2NvbG9yOiAjREI0NDM3JywgZXZlbnQpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZW1vdmVMaXN0ZW5lcnMoZXZlbnQucG9ydClcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBkb25lKClcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIF9hZGRMaXN0ZW5lcnMoZGV2aWNlOiBJbnB1dCk6IHZvaWQge1xuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGlmICggIXRoaXMuY29ubmVjdGVkRGV2aWNlcy5oYXMoZGV2aWNlLmlkKSApIHtcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGVkRGV2aWNlcy5zZXQoZGV2aWNlLmlkLCBkZXZpY2UpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYGNvbm5lY3RlZCBkZXZpY2UgaWQ6ICR7ZGV2aWNlLmlkfWApO1xuICAgICAgICAgICAgZGV2aWNlLmFkZExpc3RlbmVyKCdub3Rlb24nLCAnYWxsJywgKGV2ZW50OiBJbnB1dEV2ZW50Tm90ZW9uKSA9PiB7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgbXNnID0ge1xuICAgICAgICAgICAgICAgICAgICB0aW1lIDogZXZlbnQudGltZXN0YW1wIC8gMTAwMCxcbiAgICAgICAgICAgICAgICAgICAgbm90ZSA6IGV2ZW50Lm5vdGUubnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICBraW5kIDogJ29uJyBhcyBLaW5kLFxuICAgICAgICAgICAgICAgICAgICB2ZWxvY2l0eSA6IGV2ZW50LnJhd1ZlbG9jaXR5XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB0aGlzLm1zZ3MucHVzaChtc2cpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCclY25vdGVvbicsICdjb2xvcjogIzBGOUQ1OCcsIG1zZyk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdrZXlEb3duJywgYCR7ZXZlbnQubm90ZS5uYW1lfSR7ZXZlbnQubm90ZS5vY3RhdmV9YCwgZXZlbnQudmVsb2NpdHkpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGRldmljZS5hZGRMaXN0ZW5lcignbm90ZW9mZicsICdhbGwnLCAoZXZlbnQ6IElucHV0RXZlbnROb3Rlb2ZmKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgbXNnID0ge1xuICAgICAgICAgICAgICAgICAgICB0aW1lIDogZXZlbnQudGltZXN0YW1wIC8gMTAwMCxcbiAgICAgICAgICAgICAgICAgICAgbm90ZSA6IGV2ZW50Lm5vdGUubnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICBraW5kIDogJ29mZicgYXMgS2luZCxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCclY25vdGVvZmYnLCAnY29sb3I6ICNEQjQ0MzcnLCBtc2cpO1xuICAgICAgICAgICAgICAgIHRoaXMubXNncy5wdXNoKG1zZyk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdrZXlVcCcsIGAke2V2ZW50Lm5vdGUubmFtZX0ke2V2ZW50Lm5vdGUub2N0YXZlfWAsIGV2ZW50LnZlbG9jaXR5KVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGRldmljZS5hZGRMaXN0ZW5lcignY29udHJvbGNoYW5nZScsICdhbGwnLCAoZXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIGV2ZW50LmNvbnRyb2xsZXIubmFtZSA9PT0gJ2hvbGRwZWRhbCcgKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZW1pdChldmVudC52YWx1ZSA/ICdwZWRhbERvd24nIDogJ3BlZGFsVXAnKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgX3JlbW92ZUxpc3RlbmVycyhldmVudDogeyBpZDogYW55IH0pOiB2b2lkIHtcbiAgICAgICAgaWYgKCB0aGlzLmNvbm5lY3RlZERldmljZXMuaGFzKGV2ZW50LmlkKSApIHtcbiAgICAgICAgICAgIGNvbnN0IGRldmljZSA9IHRoaXMuY29ubmVjdGVkRGV2aWNlcy5nZXQoZXZlbnQuaWQpO1xuICAgICAgICAgICAgdGhpcy5jb25uZWN0ZWREZXZpY2VzLmRlbGV0ZShldmVudC5pZCk7XG4gICAgICAgICAgICBkZXZpY2UucmVtb3ZlTGlzdGVuZXIoJ25vdGVvbicpO1xuICAgICAgICAgICAgZGV2aWNlLnJlbW92ZUxpc3RlbmVyKCdub3Rlb2ZmJyk7XG4gICAgICAgICAgICBkZXZpY2UucmVtb3ZlTGlzdGVuZXIoJ2NvbnRyb2xjaGFuZ2UnKVxuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=