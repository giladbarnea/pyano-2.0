"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tone_1 = require("tone");
const Harmonics_1 = require("./Harmonics");
const Keybed_1 = require("./Keybed");
const Pedal_1 = require("./Pedal");
const Strings_1 = require("./Strings");
class Piano extends tone_1.ToneAudioNode {
    constructor() {
        super(tone_1.optionsFromArguments(Piano.getDefaults(), arguments));
        this.name = 'Piano';
        this.input = undefined;
        this.output = new tone_1.Gain({ context: this.context });
        this._heldNotes = new Map();
        this._loaded = false;
        const options = tone_1.optionsFromArguments(Piano.getDefaults(), arguments);
        this._heldNotes = new Map();
        this._sustainedNotes = new Map();
        this._strings = new Strings_1.PianoStrings(Object.assign({}, options, {
            enabled: true,
            volume: options.volume.strings,
        })).connect(this.output);
        this.strings = this._strings.volume;
        this._pedal = new Pedal_1.Pedal(Object.assign({}, options, {
            enabled: options.pedal,
            volume: options.volume.pedal,
        })).connect(this.output);
        this.pedal = this._pedal.volume;
        this._keybed = new Keybed_1.Keybed(Object.assign({}, options, {
            enabled: options.release,
            volume: options.volume.keybed,
        })).connect(this.output);
        this.keybed = this._keybed.volume;
        this._harmonics = new Harmonics_1.Harmonics(Object.assign({}, options, {
            enabled: options.release,
            volume: options.volume.harmonics,
        })).connect(this.output);
        this.harmonics = this._harmonics.volume;
    }
    static getDefaults() {
        return Object.assign(tone_1.ToneAudioNode.getDefaults(), {
            maxNote: 108,
            minNote: 21,
            pedal: true,
            release: false,
            samples: './audio/',
            velocities: 1,
            volume: {
                harmonics: 0,
                keybed: 0,
                pedal: 0,
                strings: 0,
            },
        });
    }
    async load() {
        await Promise.all([
            this._strings.load(),
            this._pedal.load(),
            this._keybed.load(),
            this._harmonics.load(),
        ]);
        this._loaded = true;
    }
    get loaded() {
        return this._loaded;
    }
    pedalDown(time) {
        if (this.loaded) {
            time = this.toSeconds(time);
            if (!this._pedal.isDown(time)) {
                this._pedal.down(time);
            }
        }
        return this;
    }
    pedalUp(time) {
        if (this.loaded) {
            const seconds = this.toSeconds(time);
            if (this._pedal.isDown(seconds)) {
                this._pedal.up(seconds);
                this._sustainedNotes.forEach((t, note) => {
                    if (!this._heldNotes.has(note)) {
                        this._strings.triggerRelease(note, seconds);
                    }
                });
                this._sustainedNotes.clear();
            }
        }
        return this;
    }
    keyDown(note, time = this.immediate(), velocity = 0.8) {
        if (this.loaded) {
            time = this.toSeconds(time);
            if (tone_1.isString(note)) {
                note = Math.round(tone_1.Midi(note).toMidi());
            }
            if (!this._heldNotes.has(note)) {
                this._heldNotes.set(note, { time, velocity });
                this._strings.triggerAttack(note, time, velocity);
            }
        }
        return this;
    }
    keyUp(note, time = this.immediate(), velocity = 0.8) {
        if (this.loaded) {
            time = this.toSeconds(time);
            if (tone_1.isString(note)) {
                note = Math.round(tone_1.Midi(note).toMidi());
            }
            if (this._heldNotes.has(note)) {
                const prevNote = this._heldNotes.get(note);
                this._heldNotes.delete(note);
                const holdTime = Math.pow(Math.max(time - prevNote.time, 0.1), 0.7);
                const prevVel = prevNote.velocity;
                let dampenGain = (3 / holdTime) * prevVel * velocity;
                dampenGain = Math.max(dampenGain, 0.4);
                dampenGain = Math.min(dampenGain, 4);
                if (this._pedal.isDown(time)) {
                    if (!this._sustainedNotes.has(note)) {
                        this._sustainedNotes.set(note, time);
                    }
                }
                else {
                    this._strings.triggerRelease(note, time);
                    this._harmonics.triggerAttack(note, time, dampenGain);
                }
                this._keybed.start(note, time, velocity);
            }
        }
        return this;
    }
    stopAll() {
        this.pedalUp();
        this._heldNotes.forEach((value, note) => {
            this.keyUp(note);
        });
        return this;
    }
}
exports.Piano = Piano;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGlhbm8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQaWFuby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUVrQztBQUNsQywyQ0FBdUM7QUFDdkMscUNBQWlDO0FBQ2pDLG1DQUErQjtBQUMvQix1Q0FBd0M7QUE4Q3hDLE1BQWEsS0FBTSxTQUFRLG9CQUEyQjtJQThEckQ7UUFDQyxLQUFLLENBQUMsMkJBQW9CLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUE7UUE3RG5ELFNBQUksR0FBRyxPQUFPLENBQUE7UUFDZCxVQUFLLEdBQUcsU0FBUyxDQUFBO1FBQ2pCLFdBQU0sR0FBRyxJQUFJLFdBQUksQ0FBQyxFQUFDLE9BQU8sRUFBRyxJQUFJLENBQUMsT0FBTyxFQUFDLENBQUMsQ0FBQTtRQWtENUMsZUFBVSxHQUFrQixJQUFJLEdBQUcsRUFBRSxDQUFBO1FBS3JDLFlBQU8sR0FBWSxLQUFLLENBQUE7UUFNL0IsTUFBTSxPQUFPLEdBQUcsMkJBQW9CLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFBO1FBRXBFLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUUzQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFFaEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLHNCQUFZLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFO1lBQzNELE9BQU8sRUFBRSxJQUFJO1lBQ2IsTUFBTSxFQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsT0FBTztTQUMvQixDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ3hCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUE7UUFFbkMsSUFBSSxDQUFDLE1BQU0s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QUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7d0JBQ3BDLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQTtxQkFDcEM7aUJBQ0Q7cUJBQU07b0JBRU4sSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFBO29CQUV4QyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLFVBQVUsQ0FBQyxDQUFBO2lCQUNyRDtnQkFHRCxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFBO2FBQ3hDO1NBQ0Q7UUFDRCxPQUFPLElBQUksQ0FBQTtJQUNaLENBQUM7SUFFRCxPQUFPO1FBQ04sSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1FBQ2QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDdkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNqQixDQUFDLENBQUMsQ0FBQTtRQUNGLE9BQU8sSUFBSSxDQUFBO0lBQ1osQ0FBQztDQUNEO0FBcFBELHNCQW9QQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQsIEdhaW4sIGlzU3RyaW5nLFxuXHRNaWRpLCBvcHRpb25zRnJvbUFyZ3VtZW50cywgUGFyYW0sXG5cdFRvbmVBdWRpb05vZGUsIFVuaXQgfSBmcm9tICd0b25lJ1xuaW1wb3J0IHsgSGFybW9uaWNzIH0gZnJvbSAnLi9IYXJtb25pY3MnXG5pbXBvcnQgeyBLZXliZWQgfSBmcm9tICcuL0tleWJlZCdcbmltcG9ydCB7IFBlZGFsIH0gZnJvbSAnLi9QZWRhbCdcbmltcG9ydCB7IFBpYW5vU3RyaW5ncyB9IGZyb20gJy4vU3RyaW5ncydcblxuaW50ZXJmYWNlIFBpYW5vT3B0aW9ucyB7XG5cdC8qKlxuXHQgKiBUaGUgYXVkaW8gY29udGV4dC4gRGVmYXVsdHMgdG8gdGhlIGdsb2JhbCBUb25lIGF1ZGlvIGNvbnRleHRcblx0ICovXG5cdGNvbnRleHQ6IENvbnRleHRcblx0LyoqXG5cdCAqIFRoZSBudW1iZXIgb2YgdmVsb2NpdHkgc3RlcHMgdG8gbG9hZFxuXHQgKi9cblx0dmVsb2NpdGllczogbnVtYmVyLFxuXHQvKipcblx0ICogVGhlIGxvd2VzdCBub3RlIHRvIGxvYWRcblx0ICovXG5cdG1pbk5vdGU6IG51bWJlcixcblx0LyoqXG5cdCAqIFRoZSBoaWdoZXN0IG5vdGUgdG8gbG9hZFxuXHQgKi9cblx0bWF4Tm90ZTogbnVtYmVyLFxuXHQvKipcblx0ICogSWYgaXQgc2hvdWxkIGluY2x1ZGUgYSAncmVsZWFzZScgc291bmRzIGNvbXBvc2VkIG9mIGEga2V5Y2xpY2sgYW5kIHN0cmluZyBoYXJtb25pY1xuXHQgKi9cblx0cmVsZWFzZTogYm9vbGVhbixcblx0LyoqXG5cdCAqIElmIHRoZSBwaWFubyBzaG91bGQgaW5jbHVkZSBhICdwZWRhbCcgc291bmQuXG5cdCAqL1xuXHRwZWRhbDogYm9vbGVhbixcblx0LyoqXG5cdCAqIFRoZSBkaXJlY3Rvcnkgb2YgdGhlIHNhbGFtYW5kZXIgZ3JhbmQgcGlhbm8gc2FtcGxlc1xuXHQgKi9cblx0c2FtcGxlczogc3RyaW5nLFxuXG5cdC8qKlxuXHQgKiBWb2x1bWUgbGV2ZWx0cyBmb3IgZWFjaCBvZiB0aGUgY29tcG9uZW50cyAoaW4gZGVjaWJlbHMpXG5cdCAqL1xuXHR2b2x1bWU6IHtcblx0XHRwZWRhbDogbnVtYmVyLFxuXHRcdHN0cmluZ3M6IG51bWJlcixcblx0XHRrZXliZWQ6IG51bWJlcixcblx0XHRoYXJtb25pY3M6IG51bWJlcixcblx0fVxufVxuXG4vKipcbiAqICBUaGUgUGlhbm9cbiAqL1xuZXhwb3J0IGNsYXNzIFBpYW5vIGV4dGVuZHMgVG9uZUF1ZGlvTm9kZTxQaWFub09wdGlvbnM+IHtcblxuXHRyZWFkb25seSBuYW1lID0gJ1BpYW5vJ1xuXHRyZWFkb25seSBpbnB1dCA9IHVuZGVmaW5lZFxuXHRyZWFkb25seSBvdXRwdXQgPSBuZXcgR2Fpbih7Y29udGV4dCA6IHRoaXMuY29udGV4dH0pXG5cblx0LyoqXG5cdCAqIFRoZSBzdHJpbmcgaGFybW9uaWNzXG5cdCAqL1xuXHRwcml2YXRlIF9oYXJtb25pY3M6IEhhcm1vbmljc1xuXG5cdC8qKlxuXHQgKiBUaGUga2V5YmVkIHJlbGVhc2Ugc291bmRcblx0ICovXG5cdHByaXZhdGUgX2tleWJlZDogS2V5YmVkXG5cblx0LyoqXG5cdCAqIFRoZSBwZWRhbFxuXHQgKi9cblx0cHJpdmF0ZSBfcGVkYWw6IFBlZGFsXG5cblx0LyoqXG5cdCAqIFRoZSBzdHJpbmdzXG5cdCAqL1xuXHRwcml2YXRlIF9zdHJpbmdzOiBQaWFub1N0cmluZ3NcblxuXHQvKipcblx0ICogVGhlIHZvbHVtZSBsZXZlbCBvZiB0aGUgc3RyaW5ncyBvdXRwdXQuIFRoaXMgaXMgdGhlIG1haW4gcGlhbm8gc291bmQuXG5cdCAqL1xuXHRzdHJpbmdzOiBQYXJhbTxVbml0LkRlY2liZWxzPlxuXG5cdC8qKlxuXHQgKiBUaGUgdm9sdW1lIG91dHB1dCBvZiB0aGUgcGVkYWwgdXAgYW5kIGRvd24gc291bmRzXG5cdCAqL1xuXHRwZWRhbDogUGFyYW08VW5pdC5EZWNpYmVscz5cblxuXHQvKipcblx0ICogVGhlIHZvbHVtZSBvZiB0aGUgc3RyaW5nIGhhcm1vbmljc1xuXHQgKi9cblx0aGFybW9uaWNzOiBQYXJhbTxVbml0LkRlY2liZWxzPlxuXG5cdC8qKlxuXHQgKiBUaGUgdm9sdW1lIG9mIHRoZSBrZXliZWQgY2xpY2sgc291bmRcblx0ICovXG5cdGtleWJlZDogUGFyYW08VW5pdC5EZWNpYmVscz5cblxuXHQvKipcblx0ICogVGhlIHN1c3RhaW5lZCBub3Rlc1xuXHQgKi9cblx0cHJpdmF0ZSBfc3VzdGFpbmVkTm90ZXM6IE1hcDxhbnksIGFueT5cblxuXHQvKipcblx0ICogVGhlIGN1cnJlbnRseSBoZWxkIG5vdGVzXG5cdCAqL1xuXHRwcml2YXRlIF9oZWxkTm90ZXM6IE1hcDxhbnksIGFueT4gPSBuZXcgTWFwKClcblxuXHQvKipcblx0ICogSWYgaXQncyBsb2FkZWQgb3Igbm90XG5cdCAqL1xuXHRwcml2YXRlIF9sb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZVxuXG5cdGNvbnN0cnVjdG9yKG9wdGlvbnM/OiBQYXJ0aWFsPFBpYW5vT3B0aW9ucz4pO1xuXHRjb25zdHJ1Y3RvcigpIHtcblx0XHRzdXBlcihvcHRpb25zRnJvbUFyZ3VtZW50cyhQaWFuby5nZXREZWZhdWx0cygpLCBhcmd1bWVudHMpKVxuXG5cdFx0Y29uc3Qgb3B0aW9ucyA9IG9wdGlvbnNGcm9tQXJndW1lbnRzKFBpYW5vLmdldERlZmF1bHRzKCksIGFyZ3VtZW50cylcblxuXHRcdHRoaXMuX2hlbGROb3RlcyA9IG5ldyBNYXAoKVxuXG5cdFx0dGhpcy5fc3VzdGFpbmVkTm90ZXMgPSBuZXcgTWFwKClcblxuXHRcdHRoaXMuX3N0cmluZ3MgPSBuZXcgUGlhbm9TdHJpbmdzKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHtcblx0XHRcdGVuYWJsZWQ6IHRydWUsXG5cdFx0XHR2b2x1bWUgOiBvcHRpb25zLnZvbHVtZS5zdHJpbmdzLFxuXHRcdH0pKS5jb25uZWN0KHRoaXMub3V0cHV0KVxuXHRcdHRoaXMuc3RyaW5ncyA9IHRoaXMuX3N0cmluZ3Mudm9sdW1lXG5cblx0XHR0aGlzLl9wZWRhbCA9IG5ldyBQZWRhbChPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zLCB7XG5cdFx0XHRlbmFibGVkOiBvcHRpb25zLnBlZGFsLFxuXHRcdFx0dm9sdW1lIDogb3B0aW9ucy52b2x1bWUucGVkYWwsXG5cdFx0fSkpLmNvbm5lY3QodGhpcy5vdXRwdXQpXG5cdFx0dGhpcy5wZWRhbCA9IHRoaXMuX3BlZGFsLnZvbHVtZVxuXG5cdFx0dGhpcy5fa2V5YmVkID0gbmV3IEtleWJlZChPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zLCB7XG5cdFx0XHRlbmFibGVkOiBvcHRpb25zLnJlbGVhc2UsXG5cdFx0XHR2b2x1bWUgOiBvcHRpb25zLnZvbHVtZS5rZXliZWQsXG5cdFx0fSkpLmNvbm5lY3QodGhpcy5vdXRwdXQpXG5cdFx0dGhpcy5rZXliZWQgPSB0aGlzLl9rZXliZWQudm9sdW1lXG5cblx0XHR0aGlzLl9oYXJtb25pY3MgPSBuZXcgSGFybW9uaWNzKE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMsIHtcblx0XHRcdGVuYWJsZWQ6IG9wdGlvbnMucmVsZWFzZSxcblx0XHRcdHZvbHVtZSA6IG9wdGlvbnMudm9sdW1lLmhhcm1vbmljcyxcblx0XHR9KSkuY29ubmVjdCh0aGlzLm91dHB1dClcblx0XHR0aGlzLmhhcm1vbmljcyA9IHRoaXMuX2hhcm1vbmljcy52b2x1bWVcblx0fVxuXG5cdHN0YXRpYyBnZXREZWZhdWx0cygpOiBQaWFub09wdGlvbnMge1xuXHRcdHJldHVybiBPYmplY3QuYXNzaWduKFRvbmVBdWRpb05vZGUuZ2V0RGVmYXVsdHMoKSwge1xuXHRcdFx0bWF4Tm90ZSA6IDEwOCxcblx0XHRcdG1pbk5vdGUgOiAyMSxcblx0XHRcdHBlZGFsIDogdHJ1ZSxcblx0XHRcdHJlbGVhc2UgOiBmYWxzZSxcblx0XHRcdHNhbXBsZXMgOiAnLi9hdWRpby8nLFxuXHRcdFx0dmVsb2NpdGllcyA6IDEsXG5cdFx0XHR2b2x1bWUgOiB7XG5cdFx0XHRcdGhhcm1vbmljcyA6IDAsXG5cdFx0XHRcdGtleWJlZCA6IDAsXG5cdFx0XHRcdHBlZGFsIDogMCxcblx0XHRcdFx0c3RyaW5ncyA6IDAsXG5cdFx0XHR9LFxuXHRcdH0pXG5cdH1cblxuXHQvKipcblx0ICogIExvYWQgYWxsIHRoZSBzYW1wbGVzXG5cdCAqL1xuXHRhc3luYyBsb2FkKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGF3YWl0IFByb21pc2UuYWxsKFtcblx0XHRcdHRoaXMuX3N0cmluZ3MubG9hZCgpLFxuXHRcdFx0dGhpcy5fcGVkYWwubG9hZCgpLFxuXHRcdFx0dGhpcy5fa2V5YmVkLmxvYWQoKSxcblx0XHRcdHRoaXMuX2hhcm1vbmljcy5sb2FkKCksXG5cdFx0XSlcblx0XHR0aGlzLl9sb2FkZWQgPSB0cnVlXG5cdH1cblxuXHQvKipcblx0ICogSWYgYWxsIHRoZSBzYW1wbGVzIGFyZSBsb2FkZWQgb3Igbm90XG5cdCAqL1xuXHRnZXQgbG9hZGVkKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLl9sb2FkZWRcblx0fVxuXG5cdC8qKlxuXHQgKiAgUHV0IHRoZSBwZWRhbCBkb3duIGF0IHRoZSBnaXZlbiB0aW1lLiBDYXVzZXMgc3Vic2VxdWVudFxuXHQgKiAgbm90ZXMgYW5kIGN1cnJlbnRseSBoZWxkIG5vdGVzIHRvIHN1c3RhaW4uXG5cdCAqICBAcGFyYW0gdGltZSAgVGhlIHRpbWUgdGhlIHBlZGFsIHNob3VsZCBnbyBkb3duXG5cdCAqL1xuXHRwZWRhbERvd24odGltZT86IFVuaXQuVGltZSk6IHRoaXMge1xuXG5cdFx0aWYgKHRoaXMubG9hZGVkKSB7XG5cdFx0XHR0aW1lID0gdGhpcy50b1NlY29uZHModGltZSlcblx0XHRcdGlmICghdGhpcy5fcGVkYWwuaXNEb3duKHRpbWUpKSB7XG5cdFx0XHRcdHRoaXMuX3BlZGFsLmRvd24odGltZSlcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdC8qKlxuXHQgKiAgUHV0IHRoZSBwZWRhbCB1cC4gRGFtcGVucyBzdXN0YWluZWQgbm90ZXNcblx0ICogIEBwYXJhbSB0aW1lICBUaGUgdGltZSB0aGUgcGVkYWwgc2hvdWxkIGdvIHVwXG5cdCAqL1xuXHRwZWRhbFVwKHRpbWU/OiBVbml0LlRpbWUpOiB0aGlzIHtcblxuXHRcdGlmICh0aGlzLmxvYWRlZCkge1xuXHRcdFx0Y29uc3Qgc2Vjb25kcyA9IHRoaXMudG9TZWNvbmRzKHRpbWUpXG5cdFx0XHRpZiAodGhpcy5fcGVkYWwuaXNEb3duKHNlY29uZHMpKSB7XG5cdFx0XHRcdHRoaXMuX3BlZGFsLnVwKHNlY29uZHMpXG5cdFx0XHRcdC8vIGRhbXBlbiBlYWNoIG9mIHRoZSBub3Rlc1xuXHRcdFx0XHR0aGlzLl9zdXN0YWluZWROb3Rlcy5mb3JFYWNoKCh0LCBub3RlKSA9PiB7XG5cdFx0XHRcdFx0aWYgKCF0aGlzLl9oZWxkTm90ZXMuaGFzKG5vdGUpKSB7XG5cdFx0XHRcdFx0XHR0aGlzLl9zdHJpbmdzLnRyaWdnZXJSZWxlYXNlKG5vdGUsIHNlY29uZHMpXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KVxuXHRcdFx0XHR0aGlzLl9zdXN0YWluZWROb3Rlcy5jbGVhcigpXG5cdFx0XHR9XG5cdFx0fVxuXHRcdHJldHVybiB0aGlzXG5cdH1cblxuXHQvKipcblx0ICogIFBsYXkgYSBub3RlLlxuXHQgKiAgQHBhcmFtIG5vdGVcdCAgVGhlIG5vdGUgdG8gcGxheS4gSWYgaXQgaXMgYSBudW1iZXIsIGl0IGlzIGFzc3VtZWQgdG8gYmUgTUlESVxuXHQgKiAgQHBhcmFtIHZlbG9jaXR5ICBUaGUgdmVsb2NpdHkgdG8gcGxheSB0aGUgbm90ZVxuXHQgKiAgQHBhcmFtIHRpbWVcdCAgVGhlIHRpbWUgb2YgdGhlIGV2ZW50XG5cdCAqL1xuXHRrZXlEb3duKG5vdGU6IHN0cmluZyB8IG51bWJlciwgdGltZTogVW5pdC5UaW1lID0gdGhpcy5pbW1lZGlhdGUoKSwgdmVsb2NpdHk6IG51bWJlciA9IDAuOCk6IHRoaXMge1xuXHRcdGlmICh0aGlzLmxvYWRlZCkge1xuXHRcdFx0dGltZSA9IHRoaXMudG9TZWNvbmRzKHRpbWUpXG5cblx0XHRcdGlmIChpc1N0cmluZyhub3RlKSkge1xuXHRcdFx0XHRub3RlID0gTWF0aC5yb3VuZChNaWRpKG5vdGUpLnRvTWlkaSgpKVxuXHRcdFx0fVxuXG5cdFx0XHRpZiAoIXRoaXMuX2hlbGROb3Rlcy5oYXMobm90ZSkpIHtcblx0XHRcdFx0Ly8gcmVjb3JkIHRoZSBzdGFydCB0aW1lIGFuZCB2ZWxvY2l0eVxuXHRcdFx0XHR0aGlzLl9oZWxkTm90ZXMuc2V0KG5vdGUsIHsgdGltZSwgdmVsb2NpdHkgfSlcblxuXHRcdFx0XHR0aGlzLl9zdHJpbmdzLnRyaWdnZXJBdHRhY2sobm90ZSwgdGltZSwgdmVsb2NpdHkpXG5cdFx0XHR9XG5cblx0XHR9XG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdC8qKlxuXHQgKiAgUmVsZWFzZSBhIGhlbGQgbm90ZS5cblx0ICovXG5cdGtleVVwKG5vdGU6IHN0cmluZyB8IG51bWJlciwgdGltZTogVW5pdC5UaW1lID0gdGhpcy5pbW1lZGlhdGUoKSwgdmVsb2NpdHkgPSAwLjgpOiB0aGlzIHtcblx0XHRpZiAodGhpcy5sb2FkZWQpIHtcblx0XHRcdHRpbWUgPSB0aGlzLnRvU2Vjb25kcyh0aW1lKVxuXG5cdFx0XHRpZiAoaXNTdHJpbmcobm90ZSkpIHtcblx0XHRcdFx0bm90ZSA9IE1hdGgucm91bmQoTWlkaShub3RlKS50b01pZGkoKSlcblx0XHRcdH1cblxuXHRcdFx0aWYgKHRoaXMuX2hlbGROb3Rlcy5oYXMobm90ZSkpIHtcblxuXHRcdFx0XHRjb25zdCBwcmV2Tm90ZSA9IHRoaXMuX2hlbGROb3Rlcy5nZXQobm90ZSlcblx0XHRcdFx0dGhpcy5faGVsZE5vdGVzLmRlbGV0ZShub3RlKVxuXG5cdFx0XHRcdC8vIGNvbXB1dGUgdGhlIHJlbGVhc2UgdmVsb2NpdHlcblx0XHRcdFx0Y29uc3QgaG9sZFRpbWUgPSBNYXRoLnBvdyhNYXRoLm1heCh0aW1lIC0gcHJldk5vdGUudGltZSwgMC4xKSwgMC43KVxuXHRcdFx0XHRjb25zdCBwcmV2VmVsID0gcHJldk5vdGUudmVsb2NpdHlcblx0XHRcdFx0bGV0IGRhbXBlbkdhaW4gPSAoMyAvIGhvbGRUaW1lKSAqIHByZXZWZWwgKiB2ZWxvY2l0eVxuXHRcdFx0XHRkYW1wZW5HYWluID0gTWF0aC5tYXgoZGFtcGVuR2FpbiwgMC40KVxuXHRcdFx0XHRkYW1wZW5HYWluID0gTWF0aC5taW4oZGFtcGVuR2FpbiwgNClcblxuXHRcdFx0XHRpZiAodGhpcy5fcGVkYWwuaXNEb3duKHRpbWUpKSB7XG5cdFx0XHRcdFx0aWYgKCF0aGlzLl9zdXN0YWluZWROb3Rlcy5oYXMobm90ZSkpIHtcblx0XHRcdFx0XHRcdHRoaXMuX3N1c3RhaW5lZE5vdGVzLnNldChub3RlLCB0aW1lKVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHQvLyByZWxlYXNlIHRoZSBzdHJpbmcgc291bmRcblx0XHRcdFx0XHR0aGlzLl9zdHJpbmdzLnRyaWdnZXJSZWxlYXNlKG5vdGUsIHRpbWUpXG5cdFx0XHRcdFx0Ly8gdHJpZ2dlciB0aGUgaGFybW9uaWNzIHNvdW5kXG5cdFx0XHRcdFx0dGhpcy5faGFybW9uaWNzLnRyaWdnZXJBdHRhY2sobm90ZSwgdGltZSwgZGFtcGVuR2Fpbilcblx0XHRcdFx0fVxuXG5cdFx0XHRcdC8vIHRyaWdnZXIgdGhlIGtleWJlZCByZWxlYXNlIHNvdW5kXG5cdFx0XHRcdHRoaXMuX2tleWJlZC5zdGFydChub3RlLCB0aW1lLCB2ZWxvY2l0eSlcblx0XHRcdH1cblx0XHR9XG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdHN0b3BBbGwoKTogdGhpcyB7XG5cdFx0dGhpcy5wZWRhbFVwKClcblx0XHR0aGlzLl9oZWxkTm90ZXMuZm9yRWFjaCgodmFsdWUsIG5vdGUpID0+IHtcblx0XHRcdHRoaXMua2V5VXAobm90ZSlcblx0XHR9KVxuXHRcdHJldHVybiB0aGlzXG5cdH1cbn1cbiJdfQ==