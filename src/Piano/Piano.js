"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tone_1 = require("tone");
const Harmonics_1 = require("./Harmonics");
const Keybed_1 = require("./Keybed");
const Pedal_1 = require("./Pedal");
const Strings_1 = require("./Strings");
class Piano extends tone_1.ToneAudioNode {
    constructor() {
        super(tone_1.optionsFromArguments(Piano.getDefaults(), arguments));
        this.name = 'Piano';
        this.input = undefined;
        this.output = new tone_1.Gain({ context: this.context });
        this._heldNotes = new Map();
        this._loaded = false;
        const options = tone_1.optionsFromArguments(Piano.getDefaults(), arguments);
        this._heldNotes = new Map();
        this._sustainedNotes = new Map();
        this._strings = new Strings_1.PianoStrings(Object.assign({}, options, {
            enabled: true,
            volume: options.volume.strings,
        })).connect(this.output);
        this.strings = this._strings.volume;
        this._pedal = new Pedal_1.Pedal(Object.assign({}, options, {
            enabled: options.pedal,
            volume: options.volume.pedal,
        })).connect(this.output);
        this.pedal = this._pedal.volume;
        this._keybed = new Keybed_1.Keybed(Object.assign({}, options, {
            enabled: options.release,
            volume: options.volume.keybed,
        })).connect(this.output);
        this.keybed = this._keybed.volume;
        this._harmonics = new Harmonics_1.Harmonics(Object.assign({}, options, {
            enabled: options.release,
            volume: options.volume.harmonics,
        })).connect(this.output);
        this.harmonics = this._harmonics.volume;
    }
    static getDefaults() {
        return Object.assign(tone_1.ToneAudioNode.getDefaults(), {
            maxNote: 108,
            minNote: 21,
            pedal: true,
            release: false,
            samples: './audio/',
            velocities: 1,
            volume: {
                harmonics: 0,
                keybed: 0,
                pedal: 0,
                strings: 0,
            },
        });
    }
    async load() {
        await Promise.all([
            this._strings.load(),
            this._pedal.load(),
            this._keybed.load(),
            this._harmonics.load(),
        ]);
        this._loaded = true;
    }
    get loaded() {
        return this._loaded;
    }
    pedalDown(time) {
        if (this.loaded) {
            time = this.toSeconds(time);
            if (!this._pedal.isDown(time)) {
                this._pedal.down(time);
            }
        }
        return this;
    }
    pedalUp(time) {
        if (this.loaded) {
            const seconds = this.toSeconds(time);
            if (this._pedal.isDown(seconds)) {
                this._pedal.up(seconds);
                this._sustainedNotes.forEach((t, note) => {
                    if (!this._heldNotes.has(note)) {
                        this._strings.triggerRelease(note, seconds);
                    }
                });
                this._sustainedNotes.clear();
            }
        }
        return this;
    }
    keyDown(note, time = this.immediate(), velocity = 0.8) {
        if (this.loaded) {
            time = this.toSeconds(time);
            if (tone_1.isString(note)) {
                note = Math.round(tone_1.Midi(note).toMidi());
            }
            if (!this._heldNotes.has(note)) {
                this._heldNotes.set(note, { time, velocity });
                this._strings.triggerAttack(note, time, velocity);
            }
        }
        return this;
    }
    keyUp(note, time = this.immediate(), velocity = 0.8) {
        if (this.loaded) {
            time = this.toSeconds(time);
            if (tone_1.isString(note)) {
                note = Math.round(tone_1.Midi(note).toMidi());
            }
            if (this._heldNotes.has(note)) {
                const prevNote = this._heldNotes.get(note);
                this._heldNotes.delete(note);
                const holdTime = Math.pow(Math.max(time - prevNote.time, 0.1), 0.7);
                const prevVel = prevNote.velocity;
                let dampenGain = (3 / holdTime) * prevVel * velocity;
                dampenGain = Math.max(dampenGain, 0.4);
                dampenGain = Math.min(dampenGain, 4);
                if (this._pedal.isDown(time)) {
                    if (!this._sustainedNotes.has(note)) {
                        this._sustainedNotes.set(note, time);
                    }
                }
                else {
                    this._strings.triggerRelease(note, time);
                    this._harmonics.triggerAttack(note, time, dampenGain);
                }
                this._keybed.start(note, time, velocity);
            }
        }
        return this;
    }
    stopAll() {
        this.pedalUp();
        this._heldNotes.forEach((value, note) => {
            this.keyUp(note);
        });
        return this;
    }
}
exports.Piano = Piano;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGlhbm8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQaWFuby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtCQUlhO0FBQ2IsMkNBQXVDO0FBQ3ZDLHFDQUFpQztBQUNqQyxtQ0FBK0I7QUFDL0IsdUNBQXdDO0FBOEN4QyxNQUFhLEtBQU0sU0FBUSxvQkFBMkI7SUE4RGxEO1FBQ0ksS0FBSyxDQUFDLDJCQUFvQixDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBN0R2RCxTQUFJLEdBQUcsT0FBTyxDQUFDO1FBQ2YsVUFBSyxHQUFHLFNBQVMsQ0FBQztRQUNsQixXQUFNLEdBQUcsSUFBSSxXQUFJLENBQUMsRUFBRSxPQUFPLEVBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFrRC9DLGVBQVUsR0FBa0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUt0QyxZQUFPLEdBQVksS0FBSyxDQUFDO1FBTTdCLE1BQU0sT0FBTyxHQUFHLDJCQUFvQixDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUVyRSxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFFNUIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRWpDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxzQkFBWSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRTtZQUN4RCxPQUFPLEVBQUcsSUFBSTtZQUNkLE1BQU0sRUFBRyxPQUFPLENBQUMsTUFBTSxDQUFDLE9BQU87U0FDbEMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1FBRXBDLElBQUksQ0FBQyxNQUFNLEdB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SyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFHO3dCQUNuQyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUE7cUJBQ3ZDO2lCQUNKO3FCQUFNO29CQUVILElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztvQkFFekMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQTtpQkFDeEQ7Z0JBR0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQTthQUMzQztTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUE7SUFDZixDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3BDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDcEIsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQTtJQUNmLENBQUM7Q0FDSjtBQXBQRCxzQkFvUEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICAgIENvbnRleHQsIEdhaW4sIGlzU3RyaW5nLFxuICAgIE1pZGksIG9wdGlvbnNGcm9tQXJndW1lbnRzLCBQYXJhbSxcbiAgICBUb25lQXVkaW9Ob2RlLCBVbml0XG59IGZyb20gJ3RvbmUnXG5pbXBvcnQgeyBIYXJtb25pY3MgfSBmcm9tICcuL0hhcm1vbmljcydcbmltcG9ydCB7IEtleWJlZCB9IGZyb20gJy4vS2V5YmVkJ1xuaW1wb3J0IHsgUGVkYWwgfSBmcm9tICcuL1BlZGFsJ1xuaW1wb3J0IHsgUGlhbm9TdHJpbmdzIH0gZnJvbSAnLi9TdHJpbmdzJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFBpYW5vT3B0aW9ucyB7XG4gICAgLyoqXG4gICAgICogVGhlIGF1ZGlvIGNvbnRleHQuIERlZmF1bHRzIHRvIHRoZSBnbG9iYWwgVG9uZSBhdWRpbyBjb250ZXh0XG4gICAgICovXG4gICAgY29udGV4dDogQ29udGV4dFxuICAgIC8qKlxuICAgICAqIFRoZSBudW1iZXIgb2YgdmVsb2NpdHkgc3RlcHMgdG8gbG9hZFxuICAgICAqL1xuICAgIHZlbG9jaXRpZXM6IG51bWJlcixcbiAgICAvKipcbiAgICAgKiBUaGUgbG93ZXN0IG5vdGUgdG8gbG9hZFxuICAgICAqL1xuICAgIG1pbk5vdGU6IG51bWJlcixcbiAgICAvKipcbiAgICAgKiBUaGUgaGlnaGVzdCBub3RlIHRvIGxvYWRcbiAgICAgKi9cbiAgICBtYXhOb3RlOiBudW1iZXIsXG4gICAgLyoqXG4gICAgICogSWYgaXQgc2hvdWxkIGluY2x1ZGUgYSAncmVsZWFzZScgc291bmRzIGNvbXBvc2VkIG9mIGEga2V5Y2xpY2sgYW5kIHN0cmluZyBoYXJtb25pY1xuICAgICAqL1xuICAgIHJlbGVhc2U6IGJvb2xlYW4sXG4gICAgLyoqXG4gICAgICogSWYgdGhlIHBpYW5vIHNob3VsZCBpbmNsdWRlIGEgJ3BlZGFsJyBzb3VuZC5cbiAgICAgKi9cbiAgICBwZWRhbDogYm9vbGVhbixcbiAgICAvKipcbiAgICAgKiBUaGUgZGlyZWN0b3J5IG9mIHRoZSBzYWxhbWFuZGVyIGdyYW5kIHBpYW5vIHNhbXBsZXNcbiAgICAgKi9cbiAgICBzYW1wbGVzOiBzdHJpbmcsXG4gICAgXG4gICAgLyoqXG4gICAgICogVm9sdW1lIGxldmVsdHMgZm9yIGVhY2ggb2YgdGhlIGNvbXBvbmVudHMgKGluIGRlY2liZWxzKVxuICAgICAqL1xuICAgIHZvbHVtZToge1xuICAgICAgICBwZWRhbDogbnVtYmVyLFxuICAgICAgICBzdHJpbmdzOiBudW1iZXIsXG4gICAgICAgIGtleWJlZDogbnVtYmVyLFxuICAgICAgICBoYXJtb25pY3M6IG51bWJlcixcbiAgICB9XG59XG5cbi8qKlxuICogIFRoZSBQaWFub1xuICovXG5leHBvcnQgY2xhc3MgUGlhbm8gZXh0ZW5kcyBUb25lQXVkaW9Ob2RlPFBpYW5vT3B0aW9ucz4ge1xuICAgIFxuICAgIHJlYWRvbmx5IG5hbWUgPSAnUGlhbm8nO1xuICAgIHJlYWRvbmx5IGlucHV0ID0gdW5kZWZpbmVkO1xuICAgIHJlYWRvbmx5IG91dHB1dCA9IG5ldyBHYWluKHsgY29udGV4dCA6IHRoaXMuY29udGV4dCB9KTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBUaGUgc3RyaW5nIGhhcm1vbmljc1xuICAgICAqL1xuICAgIHByaXZhdGUgX2hhcm1vbmljczogSGFybW9uaWNzO1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSBrZXliZWQgcmVsZWFzZSBzb3VuZFxuICAgICAqL1xuICAgIHByaXZhdGUgX2tleWJlZDogS2V5YmVkO1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSBwZWRhbFxuICAgICAqL1xuICAgIHByaXZhdGUgX3BlZGFsOiBQZWRhbDtcbiAgICBcbiAgICAvKipcbiAgICAgKiBUaGUgc3RyaW5nc1xuICAgICAqL1xuICAgIHByaXZhdGUgX3N0cmluZ3M6IFBpYW5vU3RyaW5ncztcbiAgICBcbiAgICAvKipcbiAgICAgKiBUaGUgdm9sdW1lIGxldmVsIG9mIHRoZSBzdHJpbmdzIG91dHB1dC4gVGhpcyBpcyB0aGUgbWFpbiBwaWFubyBzb3VuZC5cbiAgICAgKi9cbiAgICBzdHJpbmdzOiBQYXJhbTxVbml0LkRlY2liZWxzPjtcbiAgICBcbiAgICAvKipcbiAgICAgKiBUaGUgdm9sdW1lIG91dHB1dCBvZiB0aGUgcGVkYWwgdXAgYW5kIGRvd24gc291bmRzXG4gICAgICovXG4gICAgcGVkYWw6IFBhcmFtPFVuaXQuRGVjaWJlbHM+O1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSB2b2x1bWUgb2YgdGhlIHN0cmluZyBoYXJtb25pY3NcbiAgICAgKi9cbiAgICBoYXJtb25pY3M6IFBhcmFtPFVuaXQuRGVjaWJlbHM+O1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSB2b2x1bWUgb2YgdGhlIGtleWJlZCBjbGljayBzb3VuZFxuICAgICAqL1xuICAgIGtleWJlZDogUGFyYW08VW5pdC5EZWNpYmVscz47XG4gICAgXG4gICAgLyoqXG4gICAgICogVGhlIHN1c3RhaW5lZCBub3Rlc1xuICAgICAqL1xuICAgIHByaXZhdGUgX3N1c3RhaW5lZE5vdGVzOiBNYXA8YW55LCBhbnk+O1xuICAgIFxuICAgIC8qKlxuICAgICAqIFRoZSBjdXJyZW50bHkgaGVsZCBub3Rlc1xuICAgICAqL1xuICAgIHByaXZhdGUgX2hlbGROb3RlczogTWFwPGFueSwgYW55PiA9IG5ldyBNYXAoKTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBJZiBpdCdzIGxvYWRlZCBvciBub3RcbiAgICAgKi9cbiAgICBwcml2YXRlIF9sb2FkZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihvcHRpb25zPzogUGFydGlhbDxQaWFub09wdGlvbnM+KTtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIob3B0aW9uc0Zyb21Bcmd1bWVudHMoUGlhbm8uZ2V0RGVmYXVsdHMoKSwgYXJndW1lbnRzKSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBvcHRpb25zID0gb3B0aW9uc0Zyb21Bcmd1bWVudHMoUGlhbm8uZ2V0RGVmYXVsdHMoKSwgYXJndW1lbnRzKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuX2hlbGROb3RlcyA9IG5ldyBNYXAoKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuX3N1c3RhaW5lZE5vdGVzID0gbmV3IE1hcCgpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5fc3RyaW5ncyA9IG5ldyBQaWFub1N0cmluZ3MoT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucywge1xuICAgICAgICAgICAgZW5hYmxlZCA6IHRydWUsXG4gICAgICAgICAgICB2b2x1bWUgOiBvcHRpb25zLnZvbHVtZS5zdHJpbmdzLFxuICAgICAgICB9KSkuY29ubmVjdCh0aGlzLm91dHB1dCk7XG4gICAgICAgIHRoaXMuc3RyaW5ncyA9IHRoaXMuX3N0cmluZ3Mudm9sdW1lO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5fcGVkYWwgPSBuZXcgUGVkYWwoT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucywge1xuICAgICAgICAgICAgZW5hYmxlZCA6IG9wdGlvbnMucGVkYWwsXG4gICAgICAgICAgICB2b2x1bWUgOiBvcHRpb25zLnZvbHVtZS5wZWRhbCxcbiAgICAgICAgfSkpLmNvbm5lY3QodGhpcy5vdXRwdXQpO1xuICAgICAgICB0aGlzLnBlZGFsID0gdGhpcy5fcGVkYWwudm9sdW1lO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5fa2V5YmVkID0gbmV3IEtleWJlZChPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zLCB7XG4gICAgICAgICAgICBlbmFibGVkIDogb3B0aW9ucy5yZWxlYXNlLFxuICAgICAgICAgICAgdm9sdW1lIDogb3B0aW9ucy52b2x1bWUua2V5YmVkLFxuICAgICAgICB9KSkuY29ubmVjdCh0aGlzLm91dHB1dCk7XG4gICAgICAgIHRoaXMua2V5YmVkID0gdGhpcy5fa2V5YmVkLnZvbHVtZTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuX2hhcm1vbmljcyA9IG5ldyBIYXJtb25pY3MoT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucywge1xuICAgICAgICAgICAgZW5hYmxlZCA6IG9wdGlvbnMucmVsZWFzZSxcbiAgICAgICAgICAgIHZvbHVtZSA6IG9wdGlvbnMudm9sdW1lLmhhcm1vbmljcyxcbiAgICAgICAgfSkpLmNvbm5lY3QodGhpcy5vdXRwdXQpO1xuICAgICAgICB0aGlzLmhhcm1vbmljcyA9IHRoaXMuX2hhcm1vbmljcy52b2x1bWVcbiAgICB9XG4gICAgXG4gICAgc3RhdGljIGdldERlZmF1bHRzKCk6IFBpYW5vT3B0aW9ucyB7XG4gICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKFRvbmVBdWRpb05vZGUuZ2V0RGVmYXVsdHMoKSwge1xuICAgICAgICAgICAgbWF4Tm90ZSA6IDEwOCxcbiAgICAgICAgICAgIG1pbk5vdGUgOiAyMSxcbiAgICAgICAgICAgIHBlZGFsIDogdHJ1ZSxcbiAgICAgICAgICAgIHJlbGVhc2UgOiBmYWxzZSxcbiAgICAgICAgICAgIHNhbXBsZXMgOiAnLi9hdWRpby8nLFxuICAgICAgICAgICAgdmVsb2NpdGllcyA6IDEsXG4gICAgICAgICAgICB2b2x1bWUgOiB7XG4gICAgICAgICAgICAgICAgaGFybW9uaWNzIDogMCxcbiAgICAgICAgICAgICAgICBrZXliZWQgOiAwLFxuICAgICAgICAgICAgICAgIHBlZGFsIDogMCxcbiAgICAgICAgICAgICAgICBzdHJpbmdzIDogMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIH0pXG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqICBMb2FkIGFsbCB0aGUgc2FtcGxlc1xuICAgICAqL1xuICAgIGFzeW5jIGxvYWQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMuX3N0cmluZ3MubG9hZCgpLFxuICAgICAgICAgICAgdGhpcy5fcGVkYWwubG9hZCgpLFxuICAgICAgICAgICAgdGhpcy5fa2V5YmVkLmxvYWQoKSxcbiAgICAgICAgICAgIHRoaXMuX2hhcm1vbmljcy5sb2FkKCksXG4gICAgICAgIF0pO1xuICAgICAgICB0aGlzLl9sb2FkZWQgPSB0cnVlXG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIElmIGFsbCB0aGUgc2FtcGxlcyBhcmUgbG9hZGVkIG9yIG5vdFxuICAgICAqL1xuICAgIGdldCBsb2FkZWQoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sb2FkZWRcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogIFB1dCB0aGUgcGVkYWwgZG93biBhdCB0aGUgZ2l2ZW4gdGltZS4gQ2F1c2VzIHN1YnNlcXVlbnRcbiAgICAgKiAgbm90ZXMgYW5kIGN1cnJlbnRseSBoZWxkIG5vdGVzIHRvIHN1c3RhaW4uXG4gICAgICogIEBwYXJhbSB0aW1lICBUaGUgdGltZSB0aGUgcGVkYWwgc2hvdWxkIGdvIGRvd25cbiAgICAgKi9cbiAgICBwZWRhbERvd24odGltZT86IFVuaXQuVGltZSk6IHRoaXMge1xuICAgICAgICBcbiAgICAgICAgaWYgKCB0aGlzLmxvYWRlZCApIHtcbiAgICAgICAgICAgIHRpbWUgPSB0aGlzLnRvU2Vjb25kcyh0aW1lKTtcbiAgICAgICAgICAgIGlmICggIXRoaXMuX3BlZGFsLmlzRG93bih0aW1lKSApIHtcbiAgICAgICAgICAgICAgICB0aGlzLl9wZWRhbC5kb3duKHRpbWUpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogIFB1dCB0aGUgcGVkYWwgdXAuIERhbXBlbnMgc3VzdGFpbmVkIG5vdGVzXG4gICAgICogIEBwYXJhbSB0aW1lICBUaGUgdGltZSB0aGUgcGVkYWwgc2hvdWxkIGdvIHVwXG4gICAgICovXG4gICAgcGVkYWxVcCh0aW1lPzogVW5pdC5UaW1lKTogdGhpcyB7XG4gICAgICAgIFxuICAgICAgICBpZiAoIHRoaXMubG9hZGVkICkge1xuICAgICAgICAgICAgY29uc3Qgc2Vjb25kcyA9IHRoaXMudG9TZWNvbmRzKHRpbWUpO1xuICAgICAgICAgICAgaWYgKCB0aGlzLl9wZWRhbC5pc0Rvd24oc2Vjb25kcykgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5fcGVkYWwudXAoc2Vjb25kcyk7XG4gICAgICAgICAgICAgICAgLy8gZGFtcGVuIGVhY2ggb2YgdGhlIG5vdGVzXG4gICAgICAgICAgICAgICAgdGhpcy5fc3VzdGFpbmVkTm90ZXMuZm9yRWFjaCgodCwgbm90ZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoICF0aGlzLl9oZWxkTm90ZXMuaGFzKG5vdGUpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3RyaW5ncy50cmlnZ2VyUmVsZWFzZShub3RlLCBzZWNvbmRzKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3VzdGFpbmVkTm90ZXMuY2xlYXIoKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqICBQbGF5IGEgbm90ZS5cbiAgICAgKiAgQHBhcmFtIG5vdGUgICAgICBUaGUgbm90ZSB0byBwbGF5LiBJZiBpdCBpcyBhIG51bWJlciwgaXQgaXMgYXNzdW1lZCB0byBiZSBNSURJXG4gICAgICogIEBwYXJhbSB2ZWxvY2l0eSAgVGhlIHZlbG9jaXR5IHRvIHBsYXkgdGhlIG5vdGVcbiAgICAgKiAgQHBhcmFtIHRpbWUgICAgICBUaGUgdGltZSBvZiB0aGUgZXZlbnRcbiAgICAgKi9cbiAgICBrZXlEb3duKG5vdGU6IHN0cmluZyB8IG51bWJlciwgdGltZTogVW5pdC5UaW1lID0gdGhpcy5pbW1lZGlhdGUoKSwgdmVsb2NpdHk6IG51bWJlciA9IDAuOCk6IHRoaXMge1xuICAgICAgICBpZiAoIHRoaXMubG9hZGVkICkge1xuICAgICAgICAgICAgdGltZSA9IHRoaXMudG9TZWNvbmRzKHRpbWUpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoIGlzU3RyaW5nKG5vdGUpICkge1xuICAgICAgICAgICAgICAgIG5vdGUgPSBNYXRoLnJvdW5kKE1pZGkobm90ZSkudG9NaWRpKCkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICggIXRoaXMuX2hlbGROb3Rlcy5oYXMobm90ZSkgKSB7XG4gICAgICAgICAgICAgICAgLy8gcmVjb3JkIHRoZSBzdGFydCB0aW1lIGFuZCB2ZWxvY2l0eVxuICAgICAgICAgICAgICAgIHRoaXMuX2hlbGROb3Rlcy5zZXQobm90ZSwgeyB0aW1lLCB2ZWxvY2l0eSB9KTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB0aGlzLl9zdHJpbmdzLnRyaWdnZXJBdHRhY2sobm90ZSwgdGltZSwgdmVsb2NpdHkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpc1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiAgUmVsZWFzZSBhIGhlbGQgbm90ZS5cbiAgICAgKi9cbiAgICBrZXlVcChub3RlOiBzdHJpbmcgfCBudW1iZXIsIHRpbWU6IFVuaXQuVGltZSA9IHRoaXMuaW1tZWRpYXRlKCksIHZlbG9jaXR5ID0gMC44KTogdGhpcyB7XG4gICAgICAgIGlmICggdGhpcy5sb2FkZWQgKSB7XG4gICAgICAgICAgICB0aW1lID0gdGhpcy50b1NlY29uZHModGltZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICggaXNTdHJpbmcobm90ZSkgKSB7XG4gICAgICAgICAgICAgICAgbm90ZSA9IE1hdGgucm91bmQoTWlkaShub3RlKS50b01pZGkoKSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCB0aGlzLl9oZWxkTm90ZXMuaGFzKG5vdGUpICkge1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGNvbnN0IHByZXZOb3RlID0gdGhpcy5faGVsZE5vdGVzLmdldChub3RlKTtcbiAgICAgICAgICAgICAgICB0aGlzLl9oZWxkTm90ZXMuZGVsZXRlKG5vdGUpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIGNvbXB1dGUgdGhlIHJlbGVhc2UgdmVsb2NpdHlcbiAgICAgICAgICAgICAgICBjb25zdCBob2xkVGltZSA9IE1hdGgucG93KE1hdGgubWF4KHRpbWUgLSBwcmV2Tm90ZS50aW1lLCAwLjEpLCAwLjcpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHByZXZWZWwgPSBwcmV2Tm90ZS52ZWxvY2l0eTtcbiAgICAgICAgICAgICAgICBsZXQgZGFtcGVuR2FpbiA9ICgzIC8gaG9sZFRpbWUpICogcHJldlZlbCAqIHZlbG9jaXR5O1xuICAgICAgICAgICAgICAgIGRhbXBlbkdhaW4gPSBNYXRoLm1heChkYW1wZW5HYWluLCAwLjQpO1xuICAgICAgICAgICAgICAgIGRhbXBlbkdhaW4gPSBNYXRoLm1pbihkYW1wZW5HYWluLCA0KTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIHRoaXMuX3BlZGFsLmlzRG93bih0aW1lKSApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCAhdGhpcy5fc3VzdGFpbmVkTm90ZXMuaGFzKG5vdGUpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3VzdGFpbmVkTm90ZXMuc2V0KG5vdGUsIHRpbWUpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvLyByZWxlYXNlIHRoZSBzdHJpbmcgc291bmRcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3RyaW5ncy50cmlnZ2VyUmVsZWFzZShub3RlLCB0aW1lKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gdHJpZ2dlciB0aGUgaGFybW9uaWNzIHNvdW5kXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2hhcm1vbmljcy50cmlnZ2VyQXR0YWNrKG5vdGUsIHRpbWUsIGRhbXBlbkdhaW4pXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIHRyaWdnZXIgdGhlIGtleWJlZCByZWxlYXNlIHNvdW5kXG4gICAgICAgICAgICAgICAgdGhpcy5fa2V5YmVkLnN0YXJ0KG5vdGUsIHRpbWUsIHZlbG9jaXR5KVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgfVxuICAgIFxuICAgIHN0b3BBbGwoKTogdGhpcyB7XG4gICAgICAgIHRoaXMucGVkYWxVcCgpO1xuICAgICAgICB0aGlzLl9oZWxkTm90ZXMuZm9yRWFjaCgodmFsdWUsIG5vdGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMua2V5VXAobm90ZSlcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0aGlzXG4gICAgfVxufVxuIl19