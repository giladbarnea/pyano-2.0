"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../bhe");
const fs = require("fs");
const util_1 = require("../../util");
const MyPyShell_1 = require("../../MyPyShell");
class Video extends bhe_1.VisualBHE {
    constructor() {
        super({ tag: 'video', cls: 'player' });
    }
    async init(readonlyTruth) {
        console.group(`Video.initVideo()`);
        const src = bhe_1.elem({ tag: 'source' }).attr({ src: readonlyTruth.mp4.absPath, type: 'video/mp4' });
        this.append(src);
        let data = JSON.parse(fs.readFileSync(readonlyTruth.onsets.absPath));
        this.firstOnset = parseFloat(data.onsets[data.first_onset_index]);
        this.lastOnset = parseFloat(data.onsets.last());
        const video = this.e;
        video.load();
        const loadeddata = new Promise(resolve => video.onloadeddata = resolve);
        const canplay = new Promise(resolve => video.oncanplay = resolve);
        const canplaythrough = new Promise(resolve => video.oncanplaythrough = resolve);
        await Promise.all([
            loadeddata,
            canplay,
            canplaythrough
        ]);
        console.log('Done awaiting loadeddata, canplay, canplaythrough');
        video.currentTime = this.firstOnset - 0.1;
        const PY_getOnOffPairs = new MyPyShell_1.MyPyShell('-m txt.get_on_off_pairs', {
            mode: "json",
            args: [readonlyTruth.name]
        });
        const { pairs } = await PY_getOnOffPairs.runAsync();
        console.log({ pairs });
        this.onOffPairs = pairs;
        console.groupEnd();
    }
    async intro() {
        console.group(`Video.intro()`);
        const video = this.e;
        video.play();
        console.log(`Playing, currentTime: ${video.currentTime}`);
        await util_1.wait((this.lastOnset - video.currentTime) * 1000 + 2000, false);
        while (video.volume > 0.05) {
            video.volume -= 0.05;
            await util_1.wait(10, false);
        }
        video.volume = 0;
        video.pause();
        this.allOff();
        console.log('video ended!');
        console.groupEnd();
    }
    getDuration(notes) {
        const [__, last_off] = this.onOffPairs[notes - 1];
        const [first_on, _] = this.onOffPairs[0];
        const duration = last_off.time - first_on.time;
        return duration;
    }
    async levelIntro(notes) {
        console.group(`Video.levelIntro(notes : ${notes})`);
        const video = this.e;
        const duration = this.getDuration(notes);
        video.play();
        console.log(`Playing, currentTime: ${video.currentTime}`);
        await util_1.wait(duration * 1000 - 200, false);
        while (video.volume > 0.05) {
            video.volume -= 0.05;
            await util_1.wait(10, false);
        }
        video.volume = 0;
        video.pause();
        this.allOff();
        console.log('video ended!');
        console.groupEnd();
    }
}
exports.default = Video;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ2aWRlby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUE0QztBQUM1Qyx5QkFBeUI7QUFDekIscUNBQWtDO0FBQ2xDLCtDQUFvRDtBQUdwRCxNQUFNLEtBQU0sU0FBUSxlQUFTO0lBTXpCO1FBQ0ksS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFHLE9BQU8sRUFBRSxHQUFHLEVBQUcsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUE0QjtRQUNuQyxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFbkMsTUFBTSxHQUFHLEdBQUcsVUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFHLFFBQVEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsR0FBRyxFQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQ25HLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFakIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7UUFDbEUsSUFBSSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckIsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2IsTUFBTSxVQUFVLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FB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QUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzFELE1BQU0sV0FBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLE9BQVEsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLEVBQUc7WUFDMUIsS0FBSyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUM7WUFDckIsTUFBTSxXQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3pCO1FBQ0QsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDakIsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1QixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDdkIsQ0FBQztDQUNKO0FBRUQsa0JBQWUsS0FBSyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZWxlbSwgVmlzdWFsQkhFIH0gZnJvbSBcIi4uLy4uL2JoZVwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgeyB3YWl0IH0gZnJvbSBcIi4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IElQYWlycywgTXlQeVNoZWxsIH0gZnJvbSBcIi4uLy4uL015UHlTaGVsbFwiO1xuaW1wb3J0IHsgUmVhZG9ubHlUcnV0aCB9IGZyb20gXCIuLi8uLi9UcnV0aFwiO1xuXG5jbGFzcyBWaWRlbyBleHRlbmRzIFZpc3VhbEJIRSB7XG4gICAgcHJpdmF0ZSBmaXJzdE9uc2V0OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBsYXN0T25zZXQ6IG51bWJlcjtcbiAgICBwcml2YXRlIG9uT2ZmUGFpcnM6IElQYWlycztcbiAgICBlOiBIVE1MVmlkZW9FbGVtZW50O1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcih7IHRhZyA6ICd2aWRlbycsIGNscyA6ICdwbGF5ZXInIH0pO1xuICAgIH1cbiAgICBcbiAgICBhc3luYyBpbml0KHJlYWRvbmx5VHJ1dGg6IFJlYWRvbmx5VHJ1dGgpIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgVmlkZW8uaW5pdFZpZGVvKClgKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHNyYyA9IGVsZW0oeyB0YWcgOiAnc291cmNlJyB9KS5hdHRyKHsgc3JjIDogcmVhZG9ubHlUcnV0aC5tcDQuYWJzUGF0aCwgdHlwZSA6ICd2aWRlby9tcDQnIH0pO1xuICAgICAgICB0aGlzLmFwcGVuZChzcmMpO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGxldCBkYXRhID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocmVhZG9ubHlUcnV0aC5vbnNldHMuYWJzUGF0aCkpO1xuICAgICAgICB0aGlzLmZpcnN0T25zZXQgPSBwYXJzZUZsb2F0KGRhdGEub25zZXRzW2RhdGEuZmlyc3Rfb25zZXRfaW5kZXhdKTtcbiAgICAgICAgdGhpcy5sYXN0T25zZXQgPSBwYXJzZUZsb2F0KGRhdGEub25zZXRzLmxhc3QoKSk7XG4gICAgICAgIGNvbnN0IHZpZGVvID0gdGhpcy5lO1xuICAgICAgICB2aWRlby5sb2FkKCk7XG4gICAgICAgIGNvbnN0IGxvYWRlZGRhdGEgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHZpZGVvLm9ubG9hZGVkZGF0YSA9IHJlc29sdmUpO1xuICAgICAgICBjb25zdCBjYW5wbGF5ID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB2aWRlby5vbmNhbnBsYXkgPSByZXNvbHZlKTtcbiAgICAgICAgY29uc3QgY2FucGxheXRocm91Z2ggPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHZpZGVvLm9uY2FucGxheXRocm91Z2ggPSByZXNvbHZlKTtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgbG9hZGVkZGF0YSxcbiAgICAgICAgICAgIGNhbnBsYXksXG4gICAgICAgICAgICBjYW5wbGF5dGhyb3VnaFxuICAgICAgICBdKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKCdEb25lIGF3YWl0aW5nIGxvYWRlZGRhdGEsIGNhbnBsYXksIGNhbnBsYXl0aHJvdWdoJyk7XG4gICAgICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gdGhpcy5maXJzdE9uc2V0IC0gMC4xO1xuICAgICAgICBjb25zdCBQWV9nZXRPbk9mZlBhaXJzID0gbmV3IE15UHlTaGVsbCgnLW0gdHh0LmdldF9vbl9vZmZfcGFpcnMnLCB7XG4gICAgICAgICAgICBtb2RlIDogXCJqc29uXCIsXG4gICAgICAgICAgICBhcmdzIDogWyByZWFkb25seVRydXRoLm5hbWUgXVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgeyBwYWlycyB9ID0gYXdhaXQgUFlfZ2V0T25PZmZQYWlycy5ydW5Bc3luYzxJUGFpcnM+KCk7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgcGFpcnMgfSk7XG4gICAgICAgIHRoaXMub25PZmZQYWlycyA9IHBhaXJzO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGFzeW5jIGludHJvKCkge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBWaWRlby5pbnRybygpYCk7XG4gICAgICAgIGNvbnN0IHZpZGVvID0gdGhpcy5lO1xuICAgICAgICBcbiAgICAgICAgdmlkZW8ucGxheSgpO1xuICAgICAgICBjb25zb2xlLmxvZyhgUGxheWluZywgY3VycmVudFRpbWU6ICR7dmlkZW8uY3VycmVudFRpbWV9YCk7XG4gICAgICAgIGF3YWl0IHdhaXQoKHRoaXMubGFzdE9uc2V0IC0gdmlkZW8uY3VycmVudFRpbWUpICogMTAwMCArIDIwMDAsIGZhbHNlKTtcbiAgICAgICAgd2hpbGUgKCB2aWRlby52b2x1bWUgPiAwLjA1ICkge1xuICAgICAgICAgICAgdmlkZW8udm9sdW1lIC09IDAuMDU7XG4gICAgICAgICAgICBhd2FpdCB3YWl0KDEwLCBmYWxzZSk7XG4gICAgICAgIH1cbiAgICAgICAgdmlkZW8udm9sdW1lID0gMDtcbiAgICAgICAgdmlkZW8ucGF1c2UoKTtcbiAgICAgICAgdGhpcy5hbGxPZmYoKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3ZpZGVvIGVuZGVkIScpO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGdldER1cmF0aW9uKG5vdGVzOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBbIF9fLCBsYXN0X29mZiBdID0gdGhpcy5vbk9mZlBhaXJzW25vdGVzIC0gMV07XG4gICAgICAgIGNvbnN0IFsgZmlyc3Rfb24sIF8gXSA9IHRoaXMub25PZmZQYWlyc1swXTtcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBsYXN0X29mZi50aW1lIC0gZmlyc3Rfb24udGltZTtcbiAgICAgICAgcmV0dXJuIGR1cmF0aW9uO1xuICAgIH1cbiAgICBcbiAgICBhc3luYyBsZXZlbEludHJvKG5vdGVzOiBudW1iZXIpIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgVmlkZW8ubGV2ZWxJbnRybyhub3RlcyA6ICR7bm90ZXN9KWApO1xuICAgICAgICBjb25zdCB2aWRlbyA9IHRoaXMuZTtcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSB0aGlzLmdldER1cmF0aW9uKG5vdGVzKTtcbiAgICAgICAgdmlkZW8ucGxheSgpO1xuICAgICAgICBjb25zb2xlLmxvZyhgUGxheWluZywgY3VycmVudFRpbWU6ICR7dmlkZW8uY3VycmVudFRpbWV9YCk7XG4gICAgICAgIGF3YWl0IHdhaXQoZHVyYXRpb24gKiAxMDAwIC0gMjAwLCBmYWxzZSk7IC8vLyBGYWRlb3V0ID09IDIwMG1zXG4gICAgICAgIHdoaWxlICggdmlkZW8udm9sdW1lID4gMC4wNSApIHtcbiAgICAgICAgICAgIHZpZGVvLnZvbHVtZSAtPSAwLjA1O1xuICAgICAgICAgICAgYXdhaXQgd2FpdCgxMCwgZmFsc2UpO1xuICAgICAgICB9XG4gICAgICAgIHZpZGVvLnZvbHVtZSA9IDA7XG4gICAgICAgIHZpZGVvLnBhdXNlKCk7XG4gICAgICAgIHRoaXMuYWxsT2ZmKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCd2aWRlbyBlbmRlZCEnKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVmlkZW87XG4iXX0=