"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../bhe");
const fs = require("fs");
const util_1 = require("../../util");
const MyPyShell_1 = require("../../MyPyShell");
class Video extends bhe_1.VisualBHE {
    constructor() {
        super({ tag: 'video', cls: 'player' });
    }
    async init(readonlyTruth) {
        console.group(`Video.init()`);
        const src = bhe_1.elem({ tag: 'source' }).attr({ src: readonlyTruth.mp4.absPath, type: 'video/mp4' });
        this.append(src);
        let data = JSON.parse(fs.readFileSync(readonlyTruth.onsets.absPath));
        this.firstOnset = parseFloat(data.onsets[data.first_onset_index]);
        this.lastOnset = parseFloat(data.onsets.last());
        const video = this.e;
        video.load();
        const loadeddata = new Promise(resolve => video.onloadeddata = resolve);
        const canplay = new Promise(resolve => video.oncanplay = resolve);
        const canplaythrough = new Promise(resolve => video.oncanplaythrough = resolve);
        await Promise.all([
            loadeddata,
            canplay,
            canplaythrough
        ]);
        console.log('Done awaiting loadeddata, canplay, canplaythrough');
        video.currentTime = this.firstOnset - 0.1;
        const PY_getOnOffPairs = new MyPyShell_1.MyPyShell('-m txt.get_on_off_pairs', {
            mode: "json",
            args: [readonlyTruth.name]
        });
        const { pairs } = await PY_getOnOffPairs.runAsync();
        console.log({ pairs });
        this.onOffPairs = pairs;
        console.groupEnd();
    }
    async intro() {
        console.group(`Video.intro()`);
        const video = this.e;
        video.play();
        console.log(`Playing, currentTime: ${video.currentTime}`);
        await util_1.wait((this.lastOnset - video.currentTime) * 1000 + 2000, false);
        while (video.volume > 0.05) {
            video.volume -= 0.05;
            await util_1.wait(10, false);
        }
        video.volume = 0;
        video.pause();
        this.allOff();
        console.log('video ended!');
        console.groupEnd();
    }
    getDuration(notes, rate) {
        const [__, last_off] = this.onOffPairs[notes - 1];
        const [first_on, _] = this.onOffPairs[0];
        const duration = last_off.time - first_on.time;
        return duration / rate;
    }
    async levelIntro(notes, rate) {
        console.group(`Video.levelIntro(notes : ${notes})`);
        const video = this.e;
        const duration = this.getDuration(notes, rate);
        video.playbackRate = rate;
        video.play();
        console.log(`Playing, currentTime: ${video.currentTime}`);
        await util_1.wait(duration * 1000 - 200, false);
        while (video.volume > 0.05) {
            video.volume -= 0.05;
            await util_1.wait(10, false);
        }
        video.volume = 0;
        video.pause();
        this.allOff();
        console.log('video ended!');
        console.groupEnd();
    }
}
exports.default = Video;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ2aWRlby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUE0QztBQUM1Qyx5QkFBeUI7QUFDekIscUNBQWtDO0FBQ2xDLCtDQUFvRDtBQUdwRCxNQUFNLEtBQU0sU0FBUSxlQUFTO0lBTXpCO1FBQ0ksS0FBSyxDQUFDLEVBQUUsR0FBRyxFQUFHLE9BQU8sRUFBRSxHQUFHLEVBQUcsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsS0FBSyxDQUFDLElBQUksQ0FBQyxhQUE0QjtRQUNuQyxPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzlCLE1BQU0sR0FBRyxHQUFHLFVBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxRQUFRLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUcsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNuRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWpCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNoRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLE1BQU0sVUFBVSxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsQ0FBQztRQUN4RSxNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLENBQUM7UUFDbEUsTUFBTSxjQUFjLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLENBQUM7UUFDaEYsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ2QsVUFBVTtZQUNWLE9BQU87WUFDUCxjQUFjO1NBQ2pCLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxHQUFHLENBQUMsbURBQW1ELENBQUMsQ0FBQztRQUNqRSxLQUFLLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxVQUFVLEdBQUcsR0FBRyxDQUFDO1FBQzFDLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxxQkFBUyxDQUFDLHlCQUF5QixFQUFFO1lBQzlELElBQUksRUFBRyxNQUFNO1lBQ2IsSUFBSSxFQUFHLENBQUUsYUFBYSxDQUFDLElBQUksQ0FBRTtTQUNoQyxDQUFDLENBQUM7UUFDSCxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQyxRQUFRLEVBQVUsQ0FBQztRQUM1RCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztRQUN4QixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUdELEtBQUssQ0FBQyxLQUFLO1FBQ1AsT0FBTyxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMvQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBRXJCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLE9BQU8sQ0FBQyxHQUFHLENBQUMseUJBQXlCLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQzFELE1BQU0sV0FBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0RSxPQUFRLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxFQUFHO1lBQzFCLEtBQUssQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDO1lBQ3JCLE1BQU0sV0FBSSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUN6QjtRQUNELEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNkLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDNUIsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBRXZCLENBQUM7SUFFTyxXQUFXLENBQUMsS0FBYSxFQUFFLElBQVk7UUFDM0MsTUFBTSxDQUFFLEVBQUUsRUFBRSxRQUFRLENBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNwRCxNQUFNLENBQUUsUUFBUSxFQUFFLENBQUMsQ0FBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0MsTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQy9DLE9BQU8sUUFBUSxHQUFHLElBQUksQ0FBQztJQUMzQixDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFhLEVBQUUsSUFBWTtRQUN4QyxPQUFPLENBQUMsS0FBSyxDQUFDLDRCQUE0QixLQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0MsS0FBSyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7UUFDMUIsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2IsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDMUQsTUFBTSxXQUFJLENBQUMsUUFBUSxHQUFHLElBQUksR0FBRyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDekMsT0FBUSxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksRUFBRztZQUMxQixLQUFLLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQztZQUNyQixNQUFNLFdBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDekI7UUFDRCxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNqQixLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzVCLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUN2QixDQUFDO0NBQ0o7QUFFRCxrQkFBZSxLQUFLLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbGVtLCBWaXN1YWxCSEUgfSBmcm9tIFwiLi4vLi4vYmhlXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IHdhaXQgfSBmcm9tIFwiLi4vLi4vdXRpbFwiO1xuaW1wb3J0IHsgSVBhaXJzLCBNeVB5U2hlbGwgfSBmcm9tIFwiLi4vLi4vTXlQeVNoZWxsXCI7XG5pbXBvcnQgeyBSZWFkb25seVRydXRoIH0gZnJvbSBcIi4uLy4uL1RydXRoXCI7XG5cbmNsYXNzIFZpZGVvIGV4dGVuZHMgVmlzdWFsQkhFIHtcbiAgICBwcml2YXRlIGZpcnN0T25zZXQ6IG51bWJlcjtcbiAgICBwcml2YXRlIGxhc3RPbnNldDogbnVtYmVyO1xuICAgIHByaXZhdGUgb25PZmZQYWlyczogSVBhaXJzO1xuICAgIGU6IEhUTUxWaWRlb0VsZW1lbnQ7XG4gICAgXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKHsgdGFnIDogJ3ZpZGVvJywgY2xzIDogJ3BsYXllcicgfSk7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGluaXQocmVhZG9ubHlUcnV0aDogUmVhZG9ubHlUcnV0aCkge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBWaWRlby5pbml0KClgKTtcbiAgICAgICAgY29uc3Qgc3JjID0gZWxlbSh7IHRhZyA6ICdzb3VyY2UnIH0pLmF0dHIoeyBzcmMgOiByZWFkb25seVRydXRoLm1wNC5hYnNQYXRoLCB0eXBlIDogJ3ZpZGVvL21wNCcgfSk7XG4gICAgICAgIHRoaXMuYXBwZW5kKHNyYyk7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgbGV0IGRhdGEgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhyZWFkb25seVRydXRoLm9uc2V0cy5hYnNQYXRoKSk7XG4gICAgICAgIHRoaXMuZmlyc3RPbnNldCA9IHBhcnNlRmxvYXQoZGF0YS5vbnNldHNbZGF0YS5maXJzdF9vbnNldF9pbmRleF0pO1xuICAgICAgICB0aGlzLmxhc3RPbnNldCA9IHBhcnNlRmxvYXQoZGF0YS5vbnNldHMubGFzdCgpKTtcbiAgICAgICAgY29uc3QgdmlkZW8gPSB0aGlzLmU7XG4gICAgICAgIHZpZGVvLmxvYWQoKTtcbiAgICAgICAgY29uc3QgbG9hZGVkZGF0YSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdmlkZW8ub25sb2FkZWRkYXRhID0gcmVzb2x2ZSk7XG4gICAgICAgIGNvbnN0IGNhbnBsYXkgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHZpZGVvLm9uY2FucGxheSA9IHJlc29sdmUpO1xuICAgICAgICBjb25zdCBjYW5wbGF5dGhyb3VnaCA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdmlkZW8ub25jYW5wbGF5dGhyb3VnaCA9IHJlc29sdmUpO1xuICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICBsb2FkZWRkYXRhLFxuICAgICAgICAgICAgY2FucGxheSxcbiAgICAgICAgICAgIGNhbnBsYXl0aHJvdWdoXG4gICAgICAgIF0pO1xuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2coJ0RvbmUgYXdhaXRpbmcgbG9hZGVkZGF0YSwgY2FucGxheSwgY2FucGxheXRocm91Z2gnKTtcbiAgICAgICAgdmlkZW8uY3VycmVudFRpbWUgPSB0aGlzLmZpcnN0T25zZXQgLSAwLjE7XG4gICAgICAgIGNvbnN0IFBZX2dldE9uT2ZmUGFpcnMgPSBuZXcgTXlQeVNoZWxsKCctbSB0eHQuZ2V0X29uX29mZl9wYWlycycsIHtcbiAgICAgICAgICAgIG1vZGUgOiBcImpzb25cIixcbiAgICAgICAgICAgIGFyZ3MgOiBbIHJlYWRvbmx5VHJ1dGgubmFtZSBdXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB7IHBhaXJzIH0gPSBhd2FpdCBQWV9nZXRPbk9mZlBhaXJzLnJ1bkFzeW5jPElQYWlycz4oKTtcbiAgICAgICAgY29uc29sZS5sb2coeyBwYWlycyB9KTtcbiAgICAgICAgdGhpcy5vbk9mZlBhaXJzID0gcGFpcnM7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgaW50cm8oKSB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoYFZpZGVvLmludHJvKClgKTtcbiAgICAgICAgY29uc3QgdmlkZW8gPSB0aGlzLmU7XG4gICAgICAgIFxuICAgICAgICB2aWRlby5wbGF5KCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBQbGF5aW5nLCBjdXJyZW50VGltZTogJHt2aWRlby5jdXJyZW50VGltZX1gKTtcbiAgICAgICAgYXdhaXQgd2FpdCgodGhpcy5sYXN0T25zZXQgLSB2aWRlby5jdXJyZW50VGltZSkgKiAxMDAwICsgMjAwMCwgZmFsc2UpO1xuICAgICAgICB3aGlsZSAoIHZpZGVvLnZvbHVtZSA+IDAuMDUgKSB7XG4gICAgICAgICAgICB2aWRlby52b2x1bWUgLT0gMC4wNTtcbiAgICAgICAgICAgIGF3YWl0IHdhaXQoMTAsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB2aWRlby52b2x1bWUgPSAwO1xuICAgICAgICB2aWRlby5wYXVzZSgpO1xuICAgICAgICB0aGlzLmFsbE9mZigpO1xuICAgICAgICBjb25zb2xlLmxvZygndmlkZW8gZW5kZWQhJyk7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZ2V0RHVyYXRpb24obm90ZXM6IG51bWJlciwgcmF0ZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgY29uc3QgWyBfXywgbGFzdF9vZmYgXSA9IHRoaXMub25PZmZQYWlyc1tub3RlcyAtIDFdO1xuICAgICAgICBjb25zdCBbIGZpcnN0X29uLCBfIF0gPSB0aGlzLm9uT2ZmUGFpcnNbMF07XG4gICAgICAgIGNvbnN0IGR1cmF0aW9uID0gbGFzdF9vZmYudGltZSAtIGZpcnN0X29uLnRpbWU7XG4gICAgICAgIHJldHVybiBkdXJhdGlvbiAvIHJhdGU7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGxldmVsSW50cm8obm90ZXM6IG51bWJlciwgcmF0ZTogbnVtYmVyKSB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoYFZpZGVvLmxldmVsSW50cm8obm90ZXMgOiAke25vdGVzfSlgKTtcbiAgICAgICAgY29uc3QgdmlkZW8gPSB0aGlzLmU7XG4gICAgICAgIGNvbnN0IGR1cmF0aW9uID0gdGhpcy5nZXREdXJhdGlvbihub3RlcywgcmF0ZSk7XG4gICAgICAgIHZpZGVvLnBsYXliYWNrUmF0ZSA9IHJhdGU7XG4gICAgICAgIHZpZGVvLnBsYXkoKTtcbiAgICAgICAgY29uc29sZS5sb2coYFBsYXlpbmcsIGN1cnJlbnRUaW1lOiAke3ZpZGVvLmN1cnJlbnRUaW1lfWApO1xuICAgICAgICBhd2FpdCB3YWl0KGR1cmF0aW9uICogMTAwMCAtIDIwMCwgZmFsc2UpOyAvLy8gRmFkZW91dCA9PSAyMDBtc1xuICAgICAgICB3aGlsZSAoIHZpZGVvLnZvbHVtZSA+IDAuMDUgKSB7XG4gICAgICAgICAgICB2aWRlby52b2x1bWUgLT0gMC4wNTtcbiAgICAgICAgICAgIGF3YWl0IHdhaXQoMTAsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB2aWRlby52b2x1bWUgPSAwO1xuICAgICAgICB2aWRlby5wYXVzZSgpO1xuICAgICAgICB0aGlzLmFsbE9mZigpO1xuICAgICAgICBjb25zb2xlLmxvZygndmlkZW8gZW5kZWQhJyk7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFZpZGVvO1xuIl19