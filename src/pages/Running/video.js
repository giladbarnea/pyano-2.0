"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../bhe");
const fs = require("fs");
const util_1 = require("../../util");
class Video extends bhe_1.VisualBHE {
    constructor() {
        super({ tag: 'video' });
    }
    async initVideo(mp4path, onsetsPath) {
        console.group(`Video.initVideo()`);
        const src = bhe_1.elem({ tag: 'source' }).attr({ src: mp4path, type: 'video/mp4' });
        this.append(src);
        let data = JSON.parse(fs.readFileSync(onsetsPath));
        this.firstOnset = parseFloat(data.onsets[data.first_onset_index]);
        this.lastOnset = parseFloat(data.onsets.last());
        const video = this.e;
        video.load();
        const loadeddata = new Promise(resolve => video.onloadeddata = resolve);
        const canplay = new Promise(resolve => video.oncanplay = resolve);
        const canplaythrough = new Promise(resolve => video.oncanplaythrough = resolve);
        await Promise.all([
            loadeddata,
            canplay,
            canplaythrough
        ]);
        console.log('Done awaiting loadeddata, canplay, canplaythrough');
        video.currentTime = this.firstOnset - 0.1;
        console.groupEnd();
    }
    async intro() {
        console.group(`Video.intro()`);
        const video = this.e;
        video.play();
        console.log(`Playing, currentTime: ${video.currentTime}`);
        await util_1.wait((this.lastOnset - video.currentTime) * 1000 + 2000, false);
        while (video.volume > 0.05) {
            video.volume -= 0.05;
            await util_1.wait(10, false);
        }
        video.volume = 0;
        this.allOff();
        console.log('video ended!');
        console.groupEnd();
    }
}
exports.default = Video;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ2aWRlby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUE0QztBQUM1Qyx5QkFBeUI7QUFDekIscUNBQWtDO0FBRWxDLE1BQU0sS0FBTSxTQUFRLGVBQVM7SUFNekI7UUFDSSxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUcsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFlLEVBQUUsVUFBa0I7UUFDL0MsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1FBQ25DLE1BQU0sR0FBRyxHQUFHLFVBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxRQUFRLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxPQUFPLEVBQUUsSUFBSSxFQUFHLFdBQVcsRUFBRSxDQUFDLENBQUM7UUFDakYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVqQixJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7UUFDbEUsSUFBSSxDQUFDLFNBQVMsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckIsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2IsTUFBTSxVQUFVLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQyxDQUFDO1FBQ3hFLE1BQU0sT0FBTyxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsQ0FBQztRQUNsRSxNQUFNLGNBQWMsR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsQ0FBQztRQUNoRixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUM7WUFDZCxVQUFVO1lBQ1YsT0FBTztZQUNQLGNBQWM7U0FDakIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO1FBQ2pFLEtBQUssQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsR0FBRyxHQUFHLENBQUM7UUFFMUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFHRCxLQUFLLENBQUMsS0FBSztRQUNQLE9BQU8sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDL0IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVyQixLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDYixPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUMxRCxNQUFNLFdBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLElBQUksR0FBRyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDdEUsT0FBUSxLQUFLLENBQUMsTUFBTSxHQUFHLElBQUksRUFBRztZQUMxQixLQUFLLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQztZQUNyQixNQUFNLFdBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDekI7UUFDRCxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzVCLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUV2QixDQUFDO0NBQ0o7QUFFRCxrQkFBZSxLQUFLLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbGVtLCBWaXN1YWxCSEUgfSBmcm9tIFwiLi4vLi4vYmhlXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcbmltcG9ydCB7IHdhaXQgfSBmcm9tIFwiLi4vLi4vdXRpbFwiO1xuXG5jbGFzcyBWaWRlbyBleHRlbmRzIFZpc3VhbEJIRSB7XG4gICAgcHJpdmF0ZSBmaXJzdE9uc2V0OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBsYXN0T25zZXQ6IG51bWJlcjtcbiAgICBcbiAgICBlOiBIVE1MVmlkZW9FbGVtZW50O1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcih7IHRhZyA6ICd2aWRlbycgfSk7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGluaXRWaWRlbyhtcDRwYXRoOiBzdHJpbmcsIG9uc2V0c1BhdGg6IHN0cmluZykge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBWaWRlby5pbml0VmlkZW8oKWApO1xuICAgICAgICBjb25zdCBzcmMgPSBlbGVtKHsgdGFnIDogJ3NvdXJjZScgfSkuYXR0cih7IHNyYyA6IG1wNHBhdGgsIHR5cGUgOiAndmlkZW8vbXA0JyB9KTtcbiAgICAgICAgdGhpcy5hcHBlbmQoc3JjKTtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBsZXQgZGF0YSA9IEpTT04ucGFyc2UoZnMucmVhZEZpbGVTeW5jKG9uc2V0c1BhdGgpKTtcbiAgICAgICAgdGhpcy5maXJzdE9uc2V0ID0gcGFyc2VGbG9hdChkYXRhLm9uc2V0c1tkYXRhLmZpcnN0X29uc2V0X2luZGV4XSk7XG4gICAgICAgIHRoaXMubGFzdE9uc2V0ID0gcGFyc2VGbG9hdChkYXRhLm9uc2V0cy5sYXN0KCkpO1xuICAgICAgICBjb25zdCB2aWRlbyA9IHRoaXMuZTtcbiAgICAgICAgdmlkZW8ubG9hZCgpO1xuICAgICAgICBjb25zdCBsb2FkZWRkYXRhID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB2aWRlby5vbmxvYWRlZGRhdGEgPSByZXNvbHZlKTtcbiAgICAgICAgY29uc3QgY2FucGxheSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gdmlkZW8ub25jYW5wbGF5ID0gcmVzb2x2ZSk7XG4gICAgICAgIGNvbnN0IGNhbnBsYXl0aHJvdWdoID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB2aWRlby5vbmNhbnBsYXl0aHJvdWdoID0gcmVzb2x2ZSk7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIGxvYWRlZGRhdGEsXG4gICAgICAgICAgICBjYW5wbGF5LFxuICAgICAgICAgICAgY2FucGxheXRocm91Z2hcbiAgICAgICAgXSk7XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZygnRG9uZSBhd2FpdGluZyBsb2FkZWRkYXRhLCBjYW5wbGF5LCBjYW5wbGF5dGhyb3VnaCcpO1xuICAgICAgICB2aWRlby5jdXJyZW50VGltZSA9IHRoaXMuZmlyc3RPbnNldCAtIDAuMTtcbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgaW50cm8oKSB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoYFZpZGVvLmludHJvKClgKTtcbiAgICAgICAgY29uc3QgdmlkZW8gPSB0aGlzLmU7XG4gICAgICAgIFxuICAgICAgICB2aWRlby5wbGF5KCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGBQbGF5aW5nLCBjdXJyZW50VGltZTogJHt2aWRlby5jdXJyZW50VGltZX1gKTtcbiAgICAgICAgYXdhaXQgd2FpdCgodGhpcy5sYXN0T25zZXQgLSB2aWRlby5jdXJyZW50VGltZSkgKiAxMDAwICsgMjAwMCwgZmFsc2UpO1xuICAgICAgICB3aGlsZSAoIHZpZGVvLnZvbHVtZSA+IDAuMDUgKSB7XG4gICAgICAgICAgICB2aWRlby52b2x1bWUgLT0gMC4wNTtcbiAgICAgICAgICAgIGF3YWl0IHdhaXQoMTAsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB2aWRlby52b2x1bWUgPSAwO1xuICAgICAgICB0aGlzLmFsbE9mZigpO1xuICAgICAgICBjb25zb2xlLmxvZygndmlkZW8gZW5kZWQhJyk7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgXG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBWaWRlbztcbiJdfQ==