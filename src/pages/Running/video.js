"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const betterhtmlelement_1 = require("betterhtmlelement");
const fs = require("fs");
const util_1 = require("../../util");
const MyPyShell_1 = require("../../MyPyShell");
const extra_js_1 = require("../../bhe/extra.js");
class Video extends extra_js_1.VisualBHE {
    constructor() {
        super({ tag: 'video', cls: 'player' });
    }
    async init(readonlyTruth) {
        console.group(`Video.init()`);
        const src = betterhtmlelement_1.elem({ tag: 'source' }).attr({ src: readonlyTruth.mp4.absPath, type: 'video/mp4' });
        this.append(src);
        let data = JSON.parse(fs.readFileSync(readonlyTruth.onsets.absPath));
        this.firstOnset = parseFloat(data.onsets[data.first_onset_index]);
        this.lastOnset = parseFloat(data.onsets.last());
        const video = this.e;
        video.load();
        const loadeddata = new Promise(resolve => video.onloadeddata = resolve);
        const canplay = new Promise(resolve => video.oncanplay = resolve);
        const canplaythrough = new Promise(resolve => video.oncanplaythrough = resolve);
        await Promise.all([
            loadeddata,
            canplay,
            canplaythrough
        ]);
        console.log('Done awaiting loadeddata, canplay, canplaythrough');
        this.resetCurrentTime();
        console.time(`PY_getOnOffPairs`);
        const PY_getOnOffPairs = new MyPyShell_1.MyPyShell('-m txt.get_on_off_pairs', {
            mode: "json",
            args: [readonlyTruth.name]
        });
        const { pairs } = await PY_getOnOffPairs.runAsync();
        console.timeEnd(`PY_getOnOffPairs`);
        console.log({ pairs });
        this.onOffPairs = pairs;
        console.groupEnd();
    }
    resetCurrentTime() {
        this.e.currentTime = this.firstOnset - 0.1;
    }
    getDuration(notes, rate) {
        const [__, last_off] = this.onOffPairs[notes - 1];
        const [first_on, _] = this.onOffPairs[0];
        const duration = last_off.time - first_on.time;
        return duration / rate;
    }
    async play(notes, rate) {
        const video = this.e;
        let duration;
        if (notes && rate) {
            duration = this.getDuration(notes, rate);
        }
        else {
            duration = this.lastOnset - video.currentTime + 3;
        }
        if (rate) {
            video.playbackRate = rate;
        }
        video.volume = 1;
        video.play();
        const { volume, playbackRate, currentTime, paused } = video;
        console.log(`Playing, `, { notes, rate, volume, playbackRate, currentTime, paused, duration });
        await util_1.wait(duration * 1000 - 200, false);
        while (video.volume > 0.05) {
            video.volume -= 0.05;
            await util_1.wait(10, false);
        }
        video.volume = 0;
        video.pause();
        this.allOff();
        console.log('video ended!');
    }
    async intro() {
        console.group(`Video.intro()`);
        await this.play();
        console.groupEnd();
    }
    async levelIntro(notes, rate) {
        console.group(`Video.levelIntro(notes:${notes}, rate:${rate})`);
        await this.play(notes, rate);
        console.groupEnd();
    }
    async hide() {
        await super.hide();
        this.resetCurrentTime();
    }
}
exports.default = Video;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ2aWRlby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlEQUF5QztBQUN6Qyx5QkFBeUI7QUFDekIscUNBQWtDO0FBQ2xDLCtDQUFvRDtBQUVwRCxpREFBK0M7QUFFL0MsTUFBTSxLQUFNLFNBQVEsb0JBQVM7SUFNekI7UUFDSSxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUcsT0FBTyxFQUFFLEdBQUcsRUFBRyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFFRCxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQTRCO1FBQ25DLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDOUIsTUFBTSxHQUFHLEdBQUcsd0JBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxRQUFRLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxhQUFhLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUcsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUNuRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWpCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxTQUFTLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNoRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLE1BQU0sVUFBVSxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFlBQVksR0FBRyxPQUFPLENBQUMsQ0FBQztRQUN4RSxNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLENBQUM7UUFDbEUsTUFBTSxjQUFjLEdBQUcsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLENBQUM7UUFDaEYsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO1lBQ2QsVUFBVTtZQUNWLE9BQU87WUFDUCxjQUFjO1NBQ2pCLENBQUMsQ0FBQztRQUVILE9BQU8sQ0FBQyxHQUFHLENBQUMsbURBQW1ELENBQUMsQ0FBQztRQUNqRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUV4QixPQUFPLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDakMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLHFCQUFTLENBQUMseUJBQXlCLEVBQUU7WUFDOUQsSUFBSSxFQUFHLE1BQU07WUFDYixJQUFJLEVBQUcsQ0FBRSxhQUFhLENBQUMsSUFBSSxDQUFFO1NBQ2hDLENBQUMsQ0FBQztRQUNILE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLGdCQUFnQixDQUFDLFFBQVEsRUFBVSxDQUFDO1FBQzVELE9BQU8sQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUNwQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztRQUN2QixJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQztRQUN4QixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVPLGdCQUFnQjtRQUNwQixJQUFJLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsVUFBVSxHQUFHLEdBQUcsQ0FBQztJQUMvQyxDQUFDO0lBRU8sV0FBVyxDQUFDLEtBQWEsRUFBRSxJQUFZO1FBQzNDLE1BQU0sQ0FBRSxFQUFFLEVBQUUsUUFBUSxDQUFFLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDcEQsTUFBTSxDQUFFLFFBQVEsRUFBRSxDQUFDLENBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQztRQUMvQyxPQUFPLFFBQVEsR0FBRyxJQUFJLENBQUM7SUFDM0IsQ0FBQztJQUVPLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBYyxFQUFFLElBQWE7UUFDNUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNyQixJQUFJLFFBQVEsQ0FBQztRQUNiLElBQUssS0FBSyxJQUFJLElBQUksRUFBRztZQUNqQixRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDNUM7YUFBTTtZQUNILFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO1NBQ3JEO1FBQ0QsSUFBSyxJQUFJLEVBQUc7WUFDUixLQUFLLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztTQUM3QjtRQUNELEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLE1BQU0sRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFDNUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQy9GLE1BQU0sV0FBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3pDLE9BQVEsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLEVBQUc7WUFDMUIsS0FBSyxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUM7WUFDckIsTUFBTSxXQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3pCO1FBQ0QsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDakIsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2QsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUs7UUFDUCxPQUFPLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQy9CLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBY2xCLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUV2QixDQUFDO0lBR0QsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFhLEVBQUUsSUFBWTtRQUN4QyxPQUFPLENBQUMsS0FBSyxDQUFDLDBCQUEwQixLQUFLLFVBQVUsSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNoRSxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBaUI3QixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDdkIsQ0FBQztJQUVELEtBQUssQ0FBQyxJQUFJO1FBQ04sTUFBTSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDNUIsQ0FBQztDQUNKO0FBRUQsa0JBQWUsS0FBSyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZWxlbSB9IGZyb20gXCJiZXR0ZXJodG1sZWxlbWVudFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5pbXBvcnQgeyB3YWl0IH0gZnJvbSBcIi4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IElQYWlycywgTXlQeVNoZWxsIH0gZnJvbSBcIi4uLy4uL015UHlTaGVsbFwiO1xuaW1wb3J0IHsgUmVhZG9ubHlUcnV0aCB9IGZyb20gXCIuLi8uLi9UcnV0aFwiO1xuaW1wb3J0IHsgVmlzdWFsQkhFIH0gZnJvbSBcIi4uLy4uL2JoZS9leHRyYS5qc1wiO1xuXG5jbGFzcyBWaWRlbyBleHRlbmRzIFZpc3VhbEJIRSB7XG4gICAgcHJpdmF0ZSBmaXJzdE9uc2V0OiBudW1iZXI7XG4gICAgcHJpdmF0ZSBsYXN0T25zZXQ6IG51bWJlcjtcbiAgICBwcml2YXRlIG9uT2ZmUGFpcnM6IElQYWlycztcbiAgICBlOiBIVE1MVmlkZW9FbGVtZW50O1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBzdXBlcih7IHRhZyA6ICd2aWRlbycsIGNscyA6ICdwbGF5ZXInIH0pO1xuICAgIH1cbiAgICBcbiAgICBhc3luYyBpbml0KHJlYWRvbmx5VHJ1dGg6IFJlYWRvbmx5VHJ1dGgpIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgVmlkZW8uaW5pdCgpYCk7XG4gICAgICAgIGNvbnN0IHNyYyA9IGVsZW0oeyB0YWcgOiAnc291cmNlJyB9KS5hdHRyKHsgc3JjIDogcmVhZG9ubHlUcnV0aC5tcDQuYWJzUGF0aCwgdHlwZSA6ICd2aWRlby9tcDQnIH0pO1xuICAgICAgICB0aGlzLmFwcGVuZChzcmMpO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGxldCBkYXRhID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMocmVhZG9ubHlUcnV0aC5vbnNldHMuYWJzUGF0aCkpO1xuICAgICAgICB0aGlzLmZpcnN0T25zZXQgPSBwYXJzZUZsb2F0KGRhdGEub25zZXRzW2RhdGEuZmlyc3Rfb25zZXRfaW5kZXhdKTtcbiAgICAgICAgdGhpcy5sYXN0T25zZXQgPSBwYXJzZUZsb2F0KGRhdGEub25zZXRzLmxhc3QoKSk7XG4gICAgICAgIGNvbnN0IHZpZGVvID0gdGhpcy5lO1xuICAgICAgICB2aWRlby5sb2FkKCk7XG4gICAgICAgIGNvbnN0IGxvYWRlZGRhdGEgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHZpZGVvLm9ubG9hZGVkZGF0YSA9IHJlc29sdmUpO1xuICAgICAgICBjb25zdCBjYW5wbGF5ID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB2aWRlby5vbmNhbnBsYXkgPSByZXNvbHZlKTtcbiAgICAgICAgY29uc3QgY2FucGxheXRocm91Z2ggPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHZpZGVvLm9uY2FucGxheXRocm91Z2ggPSByZXNvbHZlKTtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgbG9hZGVkZGF0YSxcbiAgICAgICAgICAgIGNhbnBsYXksXG4gICAgICAgICAgICBjYW5wbGF5dGhyb3VnaFxuICAgICAgICBdKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKCdEb25lIGF3YWl0aW5nIGxvYWRlZGRhdGEsIGNhbnBsYXksIGNhbnBsYXl0aHJvdWdoJyk7XG4gICAgICAgIHRoaXMucmVzZXRDdXJyZW50VGltZSgpO1xuICAgICAgICAvLyB2aWRlby5jdXJyZW50VGltZSA9IHRoaXMuZmlyc3RPbnNldCAtIDAuMTtcbiAgICAgICAgY29uc29sZS50aW1lKGBQWV9nZXRPbk9mZlBhaXJzYCk7XG4gICAgICAgIGNvbnN0IFBZX2dldE9uT2ZmUGFpcnMgPSBuZXcgTXlQeVNoZWxsKCctbSB0eHQuZ2V0X29uX29mZl9wYWlycycsIHtcbiAgICAgICAgICAgIG1vZGUgOiBcImpzb25cIixcbiAgICAgICAgICAgIGFyZ3MgOiBbIHJlYWRvbmx5VHJ1dGgubmFtZSBdXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB7IHBhaXJzIH0gPSBhd2FpdCBQWV9nZXRPbk9mZlBhaXJzLnJ1bkFzeW5jPElQYWlycz4oKTtcbiAgICAgICAgY29uc29sZS50aW1lRW5kKGBQWV9nZXRPbk9mZlBhaXJzYCk7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgcGFpcnMgfSk7XG4gICAgICAgIHRoaXMub25PZmZQYWlycyA9IHBhaXJzO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgcmVzZXRDdXJyZW50VGltZSgpIHtcbiAgICAgICAgdGhpcy5lLmN1cnJlbnRUaW1lID0gdGhpcy5maXJzdE9uc2V0IC0gMC4xO1xuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGdldER1cmF0aW9uKG5vdGVzOiBudW1iZXIsIHJhdGU6IG51bWJlcik6IG51bWJlciB7XG4gICAgICAgIGNvbnN0IFsgX18sIGxhc3Rfb2ZmIF0gPSB0aGlzLm9uT2ZmUGFpcnNbbm90ZXMgLSAxXTtcbiAgICAgICAgY29uc3QgWyBmaXJzdF9vbiwgXyBdID0gdGhpcy5vbk9mZlBhaXJzWzBdO1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IGxhc3Rfb2ZmLnRpbWUgLSBmaXJzdF9vbi50aW1lO1xuICAgICAgICByZXR1cm4gZHVyYXRpb24gLyByYXRlO1xuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGFzeW5jIHBsYXkobm90ZXM/OiBudW1iZXIsIHJhdGU/OiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgdmlkZW8gPSB0aGlzLmU7XG4gICAgICAgIGxldCBkdXJhdGlvbjtcbiAgICAgICAgaWYgKCBub3RlcyAmJiByYXRlICkge1xuICAgICAgICAgICAgZHVyYXRpb24gPSB0aGlzLmdldER1cmF0aW9uKG5vdGVzLCByYXRlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGR1cmF0aW9uID0gdGhpcy5sYXN0T25zZXQgLSB2aWRlby5jdXJyZW50VGltZSArIDM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCByYXRlICkge1xuICAgICAgICAgICAgdmlkZW8ucGxheWJhY2tSYXRlID0gcmF0ZTtcbiAgICAgICAgfVxuICAgICAgICB2aWRlby52b2x1bWUgPSAxO1xuICAgICAgICB2aWRlby5wbGF5KCk7XG4gICAgICAgIGNvbnN0IHsgdm9sdW1lLCBwbGF5YmFja1JhdGUsIGN1cnJlbnRUaW1lLCBwYXVzZWQgfSA9IHZpZGVvO1xuICAgICAgICBjb25zb2xlLmxvZyhgUGxheWluZywgYCwgeyBub3RlcywgcmF0ZSwgdm9sdW1lLCBwbGF5YmFja1JhdGUsIGN1cnJlbnRUaW1lLCBwYXVzZWQsIGR1cmF0aW9uIH0pO1xuICAgICAgICBhd2FpdCB3YWl0KGR1cmF0aW9uICogMTAwMCAtIDIwMCwgZmFsc2UpOyAvLy8gRmFkZW91dCA9PSAyMDBtc1xuICAgICAgICB3aGlsZSAoIHZpZGVvLnZvbHVtZSA+IDAuMDUgKSB7XG4gICAgICAgICAgICB2aWRlby52b2x1bWUgLT0gMC4wNTtcbiAgICAgICAgICAgIGF3YWl0IHdhaXQoMTAsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgICAgICB2aWRlby52b2x1bWUgPSAwO1xuICAgICAgICB2aWRlby5wYXVzZSgpO1xuICAgICAgICB0aGlzLmFsbE9mZigpO1xuICAgICAgICBjb25zb2xlLmxvZygndmlkZW8gZW5kZWQhJyk7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGludHJvKCkge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBWaWRlby5pbnRybygpYCk7XG4gICAgICAgIGF3YWl0IHRoaXMucGxheSgpO1xuICAgICAgICAvKmNvbnN0IHZpZGVvID0gdGhpcy5lO1xuICAgICAgICAgY29uc3QgZHVyYXRpb24gPSB0aGlzLmxhc3RPbnNldCAtIHZpZGVvLmN1cnJlbnRUaW1lO1xuICAgICAgICAgdmlkZW8ucGxheSgpO1xuICAgICAgICAgY29uc29sZS5sb2coYFBsYXlpbmcsIGN1cnJlbnRUaW1lOiAke3ZpZGVvLmN1cnJlbnRUaW1lfWApO1xuICAgICAgICAgYXdhaXQgd2FpdChkdXJhdGlvbiAqIDEwMDAgKyAyMDAwLCBmYWxzZSk7XG4gICAgICAgICB3aGlsZSAoIHZpZGVvLnZvbHVtZSA+IDAuMDUgKSB7XG4gICAgICAgICB2aWRlby52b2x1bWUgLT0gMC4wNTtcbiAgICAgICAgIGF3YWl0IHdhaXQoMTAsIGZhbHNlKTtcbiAgICAgICAgIH1cbiAgICAgICAgIHZpZGVvLnZvbHVtZSA9IDA7XG4gICAgICAgICB2aWRlby5wYXVzZSgpO1xuICAgICAgICAgdGhpcy5hbGxPZmYoKTtcbiAgICAgICAgIGNvbnNvbGUubG9nKCd2aWRlbyBlbmRlZCEnKTsqL1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBcbiAgICBhc3luYyBsZXZlbEludHJvKG5vdGVzOiBudW1iZXIsIHJhdGU6IG51bWJlcikge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBWaWRlby5sZXZlbEludHJvKG5vdGVzOiR7bm90ZXN9LCByYXRlOiR7cmF0ZX0pYCk7XG4gICAgICAgIGF3YWl0IHRoaXMucGxheShub3RlcywgcmF0ZSk7XG4gICAgICAgIC8qY29uc3QgdmlkZW8gPSB0aGlzLmU7XG4gICAgICAgICBjb25zdCBkdXJhdGlvbiA9IHRoaXMuZ2V0RHVyYXRpb24obm90ZXMsIHJhdGUpO1xuICAgICAgICAgdmlkZW8ucGxheWJhY2tSYXRlID0gcmF0ZTtcbiAgICAgICAgIHZpZGVvLnZvbHVtZSA9IDE7XG4gICAgICAgICB2aWRlby5wbGF5KCk7XG4gICAgICAgICBjb25zdCB7IHZvbHVtZSwgcGxheWJhY2tSYXRlLCBjdXJyZW50VGltZSwgcGF1c2VkLCByZWFkeVN0YXRlIH0gPSB2aWRlbztcbiAgICAgICAgIGNvbnNvbGUubG9nKGBQbGF5aW5nLCBgLCB7IHZvbHVtZSwgcGxheWJhY2tSYXRlLCBjdXJyZW50VGltZSwgcGF1c2VkLCByZWFkeVN0YXRlLCBkdXJhdGlvbiB9KTtcbiAgICAgICAgIGF3YWl0IHdhaXQoZHVyYXRpb24gKiAxMDAwIC0gMjAwLCBmYWxzZSk7IC8vLyBGYWRlb3V0ID09IDIwMG1zXG4gICAgICAgICB3aGlsZSAoIHZpZGVvLnZvbHVtZSA+IDAuMDUgKSB7XG4gICAgICAgICB2aWRlby52b2x1bWUgLT0gMC4wNTtcbiAgICAgICAgIGF3YWl0IHdhaXQoMTAsIGZhbHNlKTtcbiAgICAgICAgIH1cbiAgICAgICAgIHZpZGVvLnZvbHVtZSA9IDA7XG4gICAgICAgICB2aWRlby5wYXVzZSgpO1xuICAgICAgICAgdGhpcy5hbGxPZmYoKTtcbiAgICAgICAgIGNvbnNvbGUubG9nKCd2aWRlbyBlbmRlZCEnKTsqL1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGhpZGUoKSB7XG4gICAgICAgIGF3YWl0IHN1cGVyLmhpZGUoKTtcbiAgICAgICAgdGhpcy5yZXNldEN1cnJlbnRUaW1lKCk7XG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBWaWRlbztcbiJdfQ==