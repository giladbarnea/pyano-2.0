"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dialog_1 = require("./dialog");
const animation_1 = require("./animation");
const util_1 = require("../../util");
const video_1 = require("./video");
const Glob_1 = require("../../Glob");
const index_1 = require("./index");
const bhe_1 = require("../../bhe");
const MidiKeyboard_1 = require("../../Piano/MidiKeyboard");
const MyAlert_1 = require("../../MyAlert");
const MyPyShell_1 = require("../../MyPyShell");
const MyFs_1 = require("../../MyFs");
const fs = require("fs");
class Experiment {
    constructor(subconfig) {
        this.video = undefined;
        const { demo_type, truth_file, allowed_tempo_deviation, allowed_rhythm_deviation } = subconfig;
        this.dialog = new dialog_1.default(demo_type);
        this.animation = new animation_1.default();
        this.dialog
            .insertBefore(this.animation)
            .setOpacTransDur();
        this.animation.setOpacTransDur();
        this.video = new video_1.default()
            .appendTo(Glob_1.default.MainContent);
        this.video.setOpacTransDur();
        this.keyboard = new MidiKeyboard_1.MidiKeyboard();
        this.greenButton = bhe_1.button({ setid: 'green_button', cls: 'inactive green player', html: 'Done' });
        Glob_1.default.MainContent.append(this.greenButton);
        this.demoType = demo_type;
        this.truthFile = truth_file;
        this.allowedTempoDeviation = allowed_tempo_deviation;
        this.allowedRhythmDeviation = allowed_rhythm_deviation;
    }
    async init(subconfig) {
        const readonlyTruth = subconfig.truth.toJSON();
        await Promise.all([
            this.video.init(readonlyTruth),
            this.animation.init(readonlyTruth.midi.absPath)
        ]);
        const outPathAbs = subconfig.experimentOutDirAbs();
        const existed = MyFs_1.default.createIfNotExists(outPathAbs);
        if (existed) {
            const stats = fs.statSync(outPathAbs);
            let datestr = stats.ctime.human();
            fs.renameSync(outPathAbs, `${outPathAbs}__${datestr}`);
            fs.mkdirSync(outPathAbs);
        }
    }
    async callOnClick(fn, demo) {
        const done = new Promise(resolve => Glob_1.default.Document.on({
            click: async (ev) => {
                ev.preventDefault();
                ev.stopPropagation();
                await Promise.all([
                    this.dialog.hide(),
                    Glob_1.default.hide("Title", "NavigationButtons")
                ]);
                Glob_1.default.Document.off("click");
                await index_1.tryCatch(() => fn(), `trying to run ${demo instanceof animation_1.default ? 'animation' : 'video'}`);
                await util_1.wait(1000);
                await demo.hide();
                resolve();
            }
        }));
        await demo.display();
        await done;
        await Glob_1.default.display("Title", "NavigationButtons");
        return;
    }
    async intro() {
        console.group(`Experiment.intro()`);
        await util_1.wait(0);
        await this.dialog.intro();
        let demo;
        if (Glob_1.default.BigConfig.dev.simulate_video_mode('Experiment.intro()')) {
            demo = this.video;
        }
        else if (Glob_1.default.BigConfig.dev.simulate_animation_mode('Experiment.intro()')) {
            demo = this.animation;
        }
        else {
            demo = this[this.demoType];
        }
        return await this.callOnClick(async () => {
            await demo.intro();
            console.groupEnd();
        }, demo);
    }
    async levelIntro(levelCollection) {
        console.group(`Experiment.levelIntro()`);
        let playVideo;
        if ((this.demoType === "animation"
            && !Glob_1.default.BigConfig.dev.simulate_video_mode('Experiment.levelIntro()'))
            || Glob_1.default.BigConfig.dev.simulate_animation_mode('Experiment.levelIntro()')) {
            playVideo = false;
        }
        else {
            if (levelCollection.previous) {
                playVideo = levelCollection.previous.notes !== levelCollection.current.notes;
            }
            else {
                playVideo = false;
            }
        }
        console.log({ playVideo });
        let rate = undefined;
        let temp;
        temp = Glob_1.default.BigConfig.dev.force_playback_rate('Experiment.levelIntro()');
        if (temp) {
            rate = temp;
        }
        else {
            if (levelCollection.current.rhythm) {
                rate = levelCollection.current.tempo / 100;
            }
            else {
                for (let i = levelCollection.current.index + 1; i < levelCollection.length; i++) {
                    const level = levelCollection.get(i);
                    if (level.notes === levelCollection.current.notes && level.rhythm) {
                        rate = level.tempo / 100;
                        console.warn(`level #${levelCollection.current.index} no tempo, took rate (${rate}) from level #${i}`);
                        break;
                    }
                }
                if (rate === undefined) {
                    rate = 1;
                }
            }
        }
        console.log({ rate });
        let notes;
        temp = Glob_1.default.BigConfig.dev.force_notes_number('Experiment.levelIntro()');
        if (temp) {
            notes = temp;
        }
        else {
            notes = levelCollection.current.notes;
        }
        console.log({ notes });
        if (playVideo) {
            await this.dialog.levelIntro(levelCollection.current, "video", rate);
            await this.callOnClick(async () => {
                await this.video.levelIntro(notes, rate);
            }, this.video);
        }
        await this.dialog.levelIntro(levelCollection.current, "animation", rate);
        await this.callOnClick(async () => {
            await this.animation.levelIntro(notes, rate);
        }, this.animation);
        console.groupEnd();
    }
    async record(levelCollection) {
        Glob_1.default.Title.levelh3.text(`Level 1/${levelCollection.length}`);
        Glob_1.default.Title.trialh3.text(`Trial 1/${levelCollection.current.trials}`);
        this.greenButton
            .replaceClass('inactive', 'active')
            .click(() => this.checkDoneTrial(levelCollection.current.toJSON()));
        await this.dialog.record(levelCollection.current);
    }
    async checkDoneTrial(readonlyLevel) {
        if (!util_1.bool(this.keyboard.msgs)) {
            return MyAlert_1.default.small._info({ title: 'Please play something' });
        }
        console.log('this.keyboard.notes:', this.keyboard.msgs);
        console.time(`PY_checkDoneTrial`);
        const PY_checkDoneTrial = new MyPyShell_1.MyPyShell('-m api.analyze_txt', {
            mode: "json",
            args: [
                JSON.stringify({
                    subconfig: {
                        truth_file: this.truthFile,
                        allowed_rhythm_deviation: this.allowedRhythmDeviation,
                        allowed_tempo_deviation: this.allowedTempoDeviation,
                    },
                    level: readonlyLevel,
                    experiment_type: Glob_1.default.BigConfig.experiment_type,
                    subj_msgs: this.keyboard.msgs
                }),
            ]
        });
        const response = await PY_checkDoneTrial.runAsync();
        console.log({ response });
        console.timeEnd(`PY_checkDoneTrial`);
    }
}
exports.default = Experiment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV4cGVyaW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBOEI7QUFFOUIsMkNBQW1DO0FBQ25DLHFDQUF3QztBQUN4QyxtQ0FBNEI7QUFDNUIscUNBQThCO0FBRzlCLG1DQUFtQztBQUNuQyxtQ0FBMkM7QUFDM0MsMkRBQXdEO0FBQ3hELDJDQUFvQztBQUNwQywrQ0FBNEM7QUFDNUMscUNBQTZCO0FBQzdCLHlCQUF3QjtBQUV4QixNQUFNLFVBQVU7SUFZWixZQUFZLFNBQXFCO1FBVHhCLFVBQUssR0FBVSxTQUFTLENBQUM7UUFVOUIsTUFBTSxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsdUJBQXVCLEVBQUUsd0JBQXdCLEVBQUUsR0FBRyxTQUFTLENBQUM7UUFDL0YsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGdCQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDcEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLG1CQUFTLEVBQUUsQ0FBQztRQUNqQyxJQUFJLENBQUMsTUFBTTthQUNOLFlBQVksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2FBQzVCLGVBQWUsRUFBRSxDQUFDO1FBRXZCLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFakMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGVBQUssRUFBRTthQUNuQixRQUFRLENBQUMsY0FBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFN0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLDJCQUFZLEVBQUUsQ0FBQztRQUNuQyxJQUFJLENBQUMsV0FBVyxHQUFHLFlBQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxjQUFjLEVBQUUsR0FBRyxFQUFFLHVCQUF1QixFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FB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QyxTQUFTLENBQUMsZUFBZTtvQkFDL0MsU0FBUyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSTtpQkFDaEMsQ0FBQzthQUVMO1NBQ0osQ0FBQyxDQUFDO1FBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNwRCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUMxQixPQUFPLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7SUFDekMsQ0FBQztDQUNKO0FBRUQsa0JBQWUsVUFBVSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IERpYWxvZyBmcm9tIFwiLi9kaWFsb2dcIjtcbmltcG9ydCB7IERlbW9UeXBlLCBJU3ViY29uZmlnLCBTdWJjb25maWcgfSBmcm9tIFwiLi4vLi4vTXlTdG9yZVwiO1xuaW1wb3J0IEFuaW1hdGlvbiBmcm9tICcuL2FuaW1hdGlvbidcbmltcG9ydCB7IGJvb2wsIHdhaXQgfSBmcm9tIFwiLi4vLi4vdXRpbFwiO1xuaW1wb3J0IFZpZGVvIGZyb20gXCIuL3ZpZGVvXCI7XG5pbXBvcnQgR2xvYiBmcm9tIFwiLi4vLi4vR2xvYlwiO1xuLy8gaW1wb3J0IHsgUmVhZG9ubHlUcnV0aCB9IGZyb20gXCIuLi8uLi9UcnV0aFwiO1xuaW1wb3J0IHsgSUxldmVsLCBMZXZlbENvbGxlY3Rpb24gfSBmcm9tIFwiLi4vLi4vTGV2ZWxcIjtcbmltcG9ydCB7IHRyeUNhdGNoIH0gZnJvbSBcIi4vaW5kZXhcIjtcbmltcG9ydCB7IGJ1dHRvbiwgQnV0dG9uIH0gZnJvbSBcIi4uLy4uL2JoZVwiO1xuaW1wb3J0IHsgTWlkaUtleWJvYXJkIH0gZnJvbSBcIi4uLy4uL1BpYW5vL01pZGlLZXlib2FyZFwiO1xuaW1wb3J0IE15QWxlcnQgZnJvbSBcIi4uLy4uL015QWxlcnRcIjtcbmltcG9ydCB7IE15UHlTaGVsbCB9IGZyb20gXCIuLi8uLi9NeVB5U2hlbGxcIjtcbmltcG9ydCBteWZzIGZyb20gXCIuLi8uLi9NeUZzXCJcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiXG5cbmNsYXNzIEV4cGVyaW1lbnQge1xuICAgIHJlYWRvbmx5IGRpYWxvZzogRGlhbG9nO1xuICAgIHJlYWRvbmx5IGFuaW1hdGlvbjogQW5pbWF0aW9uO1xuICAgIHJlYWRvbmx5IHZpZGVvOiBWaWRlbyA9IHVuZGVmaW5lZDtcbiAgICByZWFkb25seSBrZXlib2FyZDogTWlkaUtleWJvYXJkO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZ3JlZW5CdXR0b246IEJ1dHRvbjtcbiAgICBwcml2YXRlIHJlYWRvbmx5IGRlbW9UeXBlOiBEZW1vVHlwZTtcbiAgICBwcml2YXRlIHJlYWRvbmx5IHRydXRoRmlsZTogc3RyaW5nO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYWxsb3dlZFRlbXBvRGV2aWF0aW9uOiBudW1iZXI7XG4gICAgcHJpdmF0ZSByZWFkb25seSBhbGxvd2VkUmh5dGhtRGV2aWF0aW9uOiBudW1iZXI7XG5cblxuICAgIGNvbnN0cnVjdG9yKHN1YmNvbmZpZzogSVN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IGRlbW9fdHlwZSwgdHJ1dGhfZmlsZSwgYWxsb3dlZF90ZW1wb19kZXZpYXRpb24sIGFsbG93ZWRfcmh5dGhtX2RldmlhdGlvbiB9ID0gc3ViY29uZmlnO1xuICAgICAgICB0aGlzLmRpYWxvZyA9IG5ldyBEaWFsb2coZGVtb190eXBlKTtcbiAgICAgICAgdGhpcy5hbmltYXRpb24gPSBuZXcgQW5pbWF0aW9uKCk7XG4gICAgICAgIHRoaXMuZGlhbG9nXG4gICAgICAgICAgICAuaW5zZXJ0QmVmb3JlKHRoaXMuYW5pbWF0aW9uKVxuICAgICAgICAgICAgLnNldE9wYWNUcmFuc0R1cigpO1xuXG4gICAgICAgIHRoaXMuYW5pbWF0aW9uLnNldE9wYWNUcmFuc0R1cigpO1xuXG4gICAgICAgIHRoaXMudmlkZW8gPSBuZXcgVmlkZW8oKVxuICAgICAgICAgICAgLmFwcGVuZFRvKEdsb2IuTWFpbkNvbnRlbnQpO1xuICAgICAgICB0aGlzLnZpZGVvLnNldE9wYWNUcmFuc0R1cigpO1xuXG4gICAgICAgIHRoaXMua2V5Ym9hcmQgPSBuZXcgTWlkaUtleWJvYXJkKCk7XG4gICAgICAgIHRoaXMuZ3JlZW5CdXR0b24gPSBidXR0b24oeyBzZXRpZDogJ2dyZWVuX2J1dHRvbicsIGNsczogJ2luYWN0aXZlIGdyZWVuIHBsYXllcicsIGh0bWw6ICdEb25lJyB9KTtcbiAgICAgICAgR2xvYi5NYWluQ29udGVudC5hcHBlbmQodGhpcy5ncmVlbkJ1dHRvbik7XG5cbiAgICAgICAgdGhpcy5kZW1vVHlwZSA9IGRlbW9fdHlwZTtcbiAgICAgICAgdGhpcy50cnV0aEZpbGUgPSB0cnV0aF9maWxlO1xuICAgICAgICB0aGlzLmFsbG93ZWRUZW1wb0RldmlhdGlvbiA9IGFsbG93ZWRfdGVtcG9fZGV2aWF0aW9uO1xuICAgICAgICB0aGlzLmFsbG93ZWRSaHl0aG1EZXZpYXRpb24gPSBhbGxvd2VkX3JoeXRobV9kZXZpYXRpb247XG5cbiAgICB9XG5cbiAgICAvLyBhc3luYyBpbml0KHJlYWRvbmx5VHJ1dGg6IFJlYWRvbmx5VHJ1dGgpIHtcbiAgICBhc3luYyBpbml0KHN1YmNvbmZpZzogU3ViY29uZmlnKSB7XG4gICAgICAgIGNvbnN0IHJlYWRvbmx5VHJ1dGggPSBzdWJjb25maWcudHJ1dGgudG9KU09OKCk7XG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgIHRoaXMudmlkZW8uaW5pdChyZWFkb25seVRydXRoKSxcbiAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9uLmluaXQocmVhZG9ubHlUcnV0aC5taWRpLmFic1BhdGgpXG4gICAgICAgIF0pO1xuICAgICAgICBjb25zdCBvdXRQYXRoQWJzID0gc3ViY29uZmlnLmV4cGVyaW1lbnRPdXREaXJBYnMoKTtcbiAgICAgICAgY29uc3QgZXhpc3RlZCA9IG15ZnMuY3JlYXRlSWZOb3RFeGlzdHMob3V0UGF0aEFicyk7XG4gICAgICAgIGlmIChleGlzdGVkKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0cyA9IGZzLnN0YXRTeW5jKG91dFBhdGhBYnMpO1xuICAgICAgICAgICAgbGV0IGRhdGVzdHIgPSBzdGF0cy5jdGltZS5odW1hbigpO1xuICAgICAgICAgICAgZnMucmVuYW1lU3luYyhvdXRQYXRoQWJzLCBgJHtvdXRQYXRoQWJzfV9fJHtkYXRlc3RyfWApO1xuICAgICAgICAgICAgZnMubWtkaXJTeW5jKG91dFBhdGhBYnMpXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGFzeW5jIGNhbGxPbkNsaWNrKGZuOiAoKSA9PiBQcm9taXNlPHZvaWQ+LCBkZW1vOiBBbmltYXRpb24gfCBWaWRlbykge1xuICAgICAgICBjb25zdCBkb25lID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PlxuICAgICAgICAgICAgR2xvYi5Eb2N1bWVudC5vbih7XG4gICAgICAgICAgICAgICAgY2xpY2s6IGFzeW5jIChldjogS2V5Ym9hcmRFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgICAgICBldi5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kaWFsb2cuaGlkZSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgR2xvYi5oaWRlKFwiVGl0bGVcIiwgXCJOYXZpZ2F0aW9uQnV0dG9uc1wiKVxuXG4gICAgICAgICAgICAgICAgICAgIF0pO1xuXG4gICAgICAgICAgICAgICAgICAgIEdsb2IuRG9jdW1lbnQub2ZmKFwiY2xpY2tcIik7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRyeUNhdGNoKCgpID0+IGZuKCksIGB0cnlpbmcgdG8gcnVuICR7ZGVtbyBpbnN0YW5jZW9mIEFuaW1hdGlvbiA/ICdhbmltYXRpb24nIDogJ3ZpZGVvJ31gKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgd2FpdCgxMDAwKTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgZGVtby5oaWRlKCk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgYXdhaXQgZGVtby5kaXNwbGF5KCk7XG4gICAgICAgIGF3YWl0IGRvbmU7XG4gICAgICAgIGF3YWl0IEdsb2IuZGlzcGxheShcIlRpdGxlXCIsIFwiTmF2aWdhdGlvbkJ1dHRvbnNcIik7XG4gICAgICAgIHJldHVyblxuXG4gICAgfVxuXG4gICAgYXN5bmMgaW50cm8oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoYEV4cGVyaW1lbnQuaW50cm8oKWApO1xuICAgICAgICBhd2FpdCB3YWl0KDApO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuZGlhbG9nLmludHJvKCk7XG5cbiAgICAgICAgLy8vIHZpZGVvIC8gYW5pbWF0aW9uXG4gICAgICAgIGxldCBkZW1vO1xuICAgICAgICBpZiAoR2xvYi5CaWdDb25maWcuZGV2LnNpbXVsYXRlX3ZpZGVvX21vZGUoJ0V4cGVyaW1lbnQuaW50cm8oKScpKSB7XG4gICAgICAgICAgICBkZW1vID0gdGhpcy52aWRlbztcbiAgICAgICAgfSBlbHNlIGlmIChHbG9iLkJpZ0NvbmZpZy5kZXYuc2ltdWxhdGVfYW5pbWF0aW9uX21vZGUoJ0V4cGVyaW1lbnQuaW50cm8oKScpKSB7XG4gICAgICAgICAgICBkZW1vID0gdGhpcy5hbmltYXRpb247XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBkZW1vID0gdGhpc1t0aGlzLmRlbW9UeXBlXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmNhbGxPbkNsaWNrKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IGRlbW8uaW50cm8oKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgfSwgZGVtbyk7XG5cbiAgICB9XG5cblxuICAgIGFzeW5jIGxldmVsSW50cm8obGV2ZWxDb2xsZWN0aW9uOiBMZXZlbENvbGxlY3Rpb24pIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgRXhwZXJpbWVudC5sZXZlbEludHJvKClgKTtcblxuICAgICAgICBsZXQgcGxheVZpZGVvO1xuICAgICAgICBpZiAoKHRoaXMuZGVtb1R5cGUgPT09IFwiYW5pbWF0aW9uXCJcbiAgICAgICAgICAgICYmICFHbG9iLkJpZ0NvbmZpZy5kZXYuc2ltdWxhdGVfdmlkZW9fbW9kZSgnRXhwZXJpbWVudC5sZXZlbEludHJvKCknKSlcbiAgICAgICAgICAgIHx8IEdsb2IuQmlnQ29uZmlnLmRldi5zaW11bGF0ZV9hbmltYXRpb25fbW9kZSgnRXhwZXJpbWVudC5sZXZlbEludHJvKCknKSkge1xuICAgICAgICAgICAgcGxheVZpZGVvID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobGV2ZWxDb2xsZWN0aW9uLnByZXZpb3VzKSB7XG4gICAgICAgICAgICAgICAgcGxheVZpZGVvID0gbGV2ZWxDb2xsZWN0aW9uLnByZXZpb3VzLm5vdGVzICE9PSBsZXZlbENvbGxlY3Rpb24uY3VycmVudC5ub3RlcztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGxheVZpZGVvID0gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyh7IHBsYXlWaWRlbyB9KTtcbiAgICAgICAgbGV0IHJhdGU6IG51bWJlciA9IHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IHRlbXA7XG4gICAgICAgIHRlbXAgPSBHbG9iLkJpZ0NvbmZpZy5kZXYuZm9yY2VfcGxheWJhY2tfcmF0ZSgnRXhwZXJpbWVudC5sZXZlbEludHJvKCknKTtcbiAgICAgICAgaWYgKHRlbXApIHtcbiAgICAgICAgICAgIHJhdGUgPSB0ZW1wO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGxldmVsQ29sbGVjdGlvbi5jdXJyZW50LnJoeXRobSkge1xuICAgICAgICAgICAgICAgIHJhdGUgPSBsZXZlbENvbGxlY3Rpb24uY3VycmVudC50ZW1wbyAvIDEwMDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IGxldmVsQ29sbGVjdGlvbi5jdXJyZW50LmluZGV4ICsgMTsgaSA8IGxldmVsQ29sbGVjdGlvbi5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsZXZlbCA9IGxldmVsQ29sbGVjdGlvbi5nZXQoaSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsZXZlbC5ub3RlcyA9PT0gbGV2ZWxDb2xsZWN0aW9uLmN1cnJlbnQubm90ZXMgJiYgbGV2ZWwucmh5dGhtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByYXRlID0gbGV2ZWwudGVtcG8gLyAxMDA7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYGxldmVsICMke2xldmVsQ29sbGVjdGlvbi5jdXJyZW50LmluZGV4fSBubyB0ZW1wbywgdG9vayByYXRlICgke3JhdGV9KSBmcm9tIGxldmVsICMke2l9YCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChyYXRlID09PSB1bmRlZmluZWQpIHsgLy8gSGF2ZW4ndCBmb3VuZCBpbiBmb3JcbiAgICAgICAgICAgICAgICAgICAgcmF0ZSA9IDE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKHsgcmF0ZSB9KTtcbiAgICAgICAgbGV0IG5vdGVzO1xuICAgICAgICB0ZW1wID0gR2xvYi5CaWdDb25maWcuZGV2LmZvcmNlX25vdGVzX251bWJlcignRXhwZXJpbWVudC5sZXZlbEludHJvKCknKTtcbiAgICAgICAgaWYgKHRlbXApIHtcbiAgICAgICAgICAgIG5vdGVzID0gdGVtcDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vdGVzID0gbGV2ZWxDb2xsZWN0aW9uLmN1cnJlbnQubm90ZXM7XG5cbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyh7IG5vdGVzIH0pO1xuICAgICAgICBpZiAocGxheVZpZGVvKSB7XG5cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZGlhbG9nLmxldmVsSW50cm8obGV2ZWxDb2xsZWN0aW9uLmN1cnJlbnQsIFwidmlkZW9cIiwgcmF0ZSk7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmNhbGxPbkNsaWNrKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnZpZGVvLmxldmVsSW50cm8obm90ZXMsIHJhdGUpO1xuXG4gICAgICAgICAgICB9LCB0aGlzLnZpZGVvKTtcblxuICAgICAgICB9XG4gICAgICAgIGF3YWl0IHRoaXMuZGlhbG9nLmxldmVsSW50cm8obGV2ZWxDb2xsZWN0aW9uLmN1cnJlbnQsIFwiYW5pbWF0aW9uXCIsIHJhdGUpO1xuICAgICAgICBhd2FpdCB0aGlzLmNhbGxPbkNsaWNrKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYW5pbWF0aW9uLmxldmVsSW50cm8obm90ZXMsIHJhdGUpO1xuXG4gICAgICAgIH0sIHRoaXMuYW5pbWF0aW9uKTtcblxuXG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICB9XG5cbiAgICBhc3luYyByZWNvcmQobGV2ZWxDb2xsZWN0aW9uOiBMZXZlbENvbGxlY3Rpb24pIHtcbiAgICAgICAgR2xvYi5UaXRsZS5sZXZlbGgzLnRleHQoYExldmVsIDEvJHtsZXZlbENvbGxlY3Rpb24ubGVuZ3RofWApO1xuICAgICAgICBHbG9iLlRpdGxlLnRyaWFsaDMudGV4dChgVHJpYWwgMS8ke2xldmVsQ29sbGVjdGlvbi5jdXJyZW50LnRyaWFsc31gKTtcblxuICAgICAgICB0aGlzLmdyZWVuQnV0dG9uXG4gICAgICAgICAgICAucmVwbGFjZUNsYXNzKCdpbmFjdGl2ZScsICdhY3RpdmUnKVxuICAgICAgICAgICAgLmNsaWNrKCgpID0+IHRoaXMuY2hlY2tEb25lVHJpYWwobGV2ZWxDb2xsZWN0aW9uLmN1cnJlbnQudG9KU09OKCkpKTtcbiAgICAgICAgYXdhaXQgdGhpcy5kaWFsb2cucmVjb3JkKGxldmVsQ29sbGVjdGlvbi5jdXJyZW50KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGNoZWNrRG9uZVRyaWFsKHJlYWRvbmx5TGV2ZWw6IElMZXZlbCkge1xuICAgICAgICBpZiAoIWJvb2wodGhpcy5rZXlib2FyZC5tc2dzKSkge1xuICAgICAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwuX2luZm8oeyB0aXRsZTogJ1BsZWFzZSBwbGF5IHNvbWV0aGluZycgfSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKCd0aGlzLmtleWJvYXJkLm5vdGVzOicsIHRoaXMua2V5Ym9hcmQubXNncyk7XG4gICAgICAgIGNvbnNvbGUudGltZShgUFlfY2hlY2tEb25lVHJpYWxgKTtcbiAgICAgICAgY29uc3QgUFlfY2hlY2tEb25lVHJpYWwgPSBuZXcgTXlQeVNoZWxsKCctbSBhcGkuYW5hbHl6ZV90eHQnLCB7XG4gICAgICAgICAgICBtb2RlOiBcImpzb25cIixcbiAgICAgICAgICAgIGFyZ3M6IFtcbiAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAgICAgICAgIHN1YmNvbmZpZzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHJ1dGhfZmlsZTogdGhpcy50cnV0aEZpbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxvd2VkX3JoeXRobV9kZXZpYXRpb246IHRoaXMuYWxsb3dlZFJoeXRobURldmlhdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbG93ZWRfdGVtcG9fZGV2aWF0aW9uOiB0aGlzLmFsbG93ZWRUZW1wb0RldmlhdGlvbixcblxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBsZXZlbDogcmVhZG9ubHlMZXZlbCxcbiAgICAgICAgICAgICAgICAgICAgZXhwZXJpbWVudF90eXBlOiBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGUsXG4gICAgICAgICAgICAgICAgICAgIHN1YmpfbXNnczogdGhpcy5rZXlib2FyZC5tc2dzXG4gICAgICAgICAgICAgICAgfSksXG5cbiAgICAgICAgICAgIF1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgUFlfY2hlY2tEb25lVHJpYWwucnVuQXN5bmMoKTtcbiAgICAgICAgY29uc29sZS5sb2coeyByZXNwb25zZSB9KTtcbiAgICAgICAgY29uc29sZS50aW1lRW5kKGBQWV9jaGVja0RvbmVUcmlhbGApO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgRXhwZXJpbWVudDtcbiJdfQ==