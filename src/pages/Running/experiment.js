"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dialog_1 = require("./dialog");
const animation_1 = require("./animation");
const util_1 = require("../../util");
const video_1 = require("./video");
const Glob_1 = require("../../Glob");
const MyPyShell_1 = require("../../MyPyShell");
class Experiment {
    constructor(demoType) {
        this.video = undefined;
        this.dialog = new dialog_1.default(demoType);
        this.animation = new animation_1.default();
        this.dialog
            .insertBefore(this.animation)
            .setOpacTransDur();
        this.animation.setOpacTransDur();
        if (demoType === "video" || Glob_1.default.BigConfig.dev.force_play_video()) {
            this.video = new video_1.default()
                .appendTo(Glob_1.default.MainContent);
            this.video.setOpacTransDur();
        }
        this.demoType = demoType;
    }
    async init(readonlyTruth) {
        const promises = [];
        if (this.video) {
            promises.push(this.video.init(readonlyTruth.mp4.absPath, readonlyTruth.onsets.absPath));
        }
        else {
            promises.push(this.animation.init(readonlyTruth.midi.absPath));
        }
        return await Promise.all(promises);
    }
    async intro() {
        console.group(`Experiment.intro()`);
        await util_1.wait(0);
        await this.dialog.intro();
        let demo;
        if (Glob_1.default.BigConfig.dev.force_play_video()) {
            demo = this.video;
        }
        else {
            demo = this[this.demoType];
        }
        await demo.display();
        const promiseDone = new Promise(resolve => {
            Glob_1.default.Document.on({
                click: async (ev) => {
                    ev.preventDefault();
                    ev.stopPropagation();
                    await Promise.all([
                        this.dialog.hide(),
                        Glob_1.default.hide("Title", "NavigationButtons")
                    ]);
                    Glob_1.default.Document.off("click");
                    await demo.intro();
                    console.log(`done playing ${this.demoType}`);
                    await util_1.wait(1000);
                    await demo.hide();
                    resolve();
                }
            });
        });
        console.groupEnd();
        return await promiseDone;
    }
    async levelIntro(levelCollection) {
        var _a;
        Glob_1.default.Title.levelh3.text(`Level 1/${levelCollection.length}`);
        Glob_1.default.Title.trialh3.text(`Trial 1/${levelCollection.current.trials}`);
        let playVideo;
        if (Glob_1.default.BigConfig.dev.force_play_video()) {
            playVideo = true;
        }
        else {
            if (this.demoType === "animation") {
                playVideo = false;
            }
            else {
                playVideo = ((_a = levelCollection.previous) === null || _a === void 0 ? void 0 : _a.notes) !== levelCollection.current.notes;
                if (playVideo)
                    console.warn(`playVideo`, playVideo);
            }
        }
        const promises = [
            Glob_1.default.display("Title", "NavigationButtons"),
            this.dialog.levelIntro(levelCollection, playVideo)
        ];
        await Promise.all(promises);
        const PY_getOnOffPairs = new MyPyShell_1.MyPyShell('-m txt.get_on_off_pairs', {
            mode: "json",
            args: ['FIRSTarg']
        });
        const messages = await PY_getOnOffPairs.runAsync();
        console.log(messages);
        for (let m of messages) {
            console.log(JSON.parse(m));
        }
    }
}
exports.default = Experiment;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwZXJpbWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImV4cGVyaW1lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQ0FBOEI7QUFFOUIsMkNBQW1DO0FBQ25DLHFDQUFrQztBQUNsQyxtQ0FBNEI7QUFDNUIscUNBQThCO0FBRzlCLCtDQUE0QztBQUc1QyxNQUFNLFVBQVU7SUFNWixZQUFZLFFBQWtCO1FBSHJCLFVBQUssR0FBVSxTQUFTLENBQUM7UUFJOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLGdCQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLG1CQUFTLEVBQUUsQ0FBQztRQUNqQyxJQUFJLENBQUMsTUFBTTthQUNOLFlBQVksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDO2FBQzVCLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDakMsSUFBSyxRQUFRLEtBQUssT0FBTyxJQUFJLGNBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLEVBQUc7WUFDakUsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGVBQUssRUFBRTtpQkFDbkIsUUFBUSxDQUFDLGNBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxDQUFDO1NBQ2hDO1FBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDN0IsQ0FBQztJQUVELEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBNEI7UUFDbkMsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ3BCLElBQUssSUFBSSxDQUFDLEtBQUssRUFBRztZQUNkLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO1NBQzFGO2FBQU07WUFDSCxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtTQUNqRTtRQUNELE9BQU8sTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNQLE9BQU8sQ0FBQyxLQUFLLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUNwQyxNQUFNLFdBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQVlkLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUcxQixJQUFJLElBQUksQ0FBQztRQUNULElBQUssY0FBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsRUFBRztZQUN6QyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztTQUNyQjthQUFNO1lBQ0gsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDOUI7UUFDRCxNQUFNLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUVyQixNQUFNLFdBQVcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUd0QyxjQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDYixLQUFLLEVBQUcsS0FBSyxFQUFFLEVBQWlCLEVBQUUsRUFBRTtvQkFDaEMsRUFBRSxDQUFDLGNBQWMsRUFBRSxDQUFDO29CQUNwQixFQUFFLENBQUMsZUFBZSxFQUFFLENBQUM7b0JBQ3JCLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FBQzt3QkFDZCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTt3QkFDbEIsY0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsbUJBQW1CLENBQUM7cUJBRTFDLENBQUMsQ0FBQztvQkFFSCxjQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDM0IsTUFBTSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQ25CLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO29CQUM3QyxNQUFNLFdBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDakIsTUFBTSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ2xCLE9BQU8sRUFBRSxDQUFDO2dCQUVkLENBQUM7YUFDSixDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNuQixPQUFPLE1BQU0sV0FBVyxDQUFDO0lBRTdCLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUFDLGVBQWdDOztRQUM3QyxjQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxlQUFlLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUM3RCxjQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxlQUFlLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7UUFDckUsSUFBSSxTQUFTLENBQUM7UUFDZCxJQUFLLGNBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLEVBQUc7WUFDekMsU0FBUyxHQUFHLElBQUksQ0FBQztTQUVwQjthQUFNO1lBQ0gsSUFBSyxJQUFJLENBQUMsUUFBUSxLQUFLLFdBQVcsRUFBRztnQkFDakMsU0FBUyxHQUFHLEtBQUssQ0FBQzthQUNyQjtpQkFBTTtnQkFFSCxTQUFTLEdBQUcsT0FBQSxlQUFlLENBQUMsUUFBUSwwQ0FBRSxLQUFLLE1BQUssZUFBZSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7Z0JBQzlFLElBQUssU0FBUztvQkFBRyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQzthQUN6RDtTQUNKO1FBQ0QsTUFBTSxRQUFRLEdBQUc7WUFDYixjQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxtQkFBbUIsQ0FBQztZQUMxQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxlQUFlLEVBQUUsU0FBUyxDQUFDO1NBQ3JELENBQUM7UUFDRixNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUIsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLHFCQUFTLENBQUMseUJBQXlCLEVBQUU7WUFDOUQsSUFBSSxFQUFHLE1BQU07WUFDYixJQUFJLEVBQUcsQ0FBRSxVQUFVLENBQUU7U0FDeEIsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxRQUFRLEdBQUcsTUFBTSxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNuRCxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RCLEtBQU0sSUFBSSxDQUFDLElBQUksUUFBUSxFQUFHO1lBQ3RCLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzlCO0lBNkJMLENBQUM7Q0FFSjtBQUVELGtCQUFlLFVBQVUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBEaWFsb2cgZnJvbSBcIi4vZGlhbG9nXCI7XG5pbXBvcnQgeyBEZW1vVHlwZSB9IGZyb20gXCIuLi8uLi9NeVN0b3JlXCI7XG5pbXBvcnQgQW5pbWF0aW9uIGZyb20gJy4vYW5pbWF0aW9uJ1xuaW1wb3J0IHsgd2FpdCB9IGZyb20gXCIuLi8uLi91dGlsXCI7XG5pbXBvcnQgVmlkZW8gZnJvbSBcIi4vdmlkZW9cIjtcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi9HbG9iXCI7XG5pbXBvcnQgeyBSZWFkb25seVRydXRoIH0gZnJvbSBcIi4uLy4uL1RydXRoXCI7XG5pbXBvcnQgeyBMZXZlbENvbGxlY3Rpb24gfSBmcm9tIFwiLi4vLi4vTGV2ZWxcIjtcbmltcG9ydCB7IE15UHlTaGVsbCB9IGZyb20gXCIuLi8uLi9NeVB5U2hlbGxcIjtcblxuXG5jbGFzcyBFeHBlcmltZW50IHtcbiAgICByZWFkb25seSBkaWFsb2c6IERpYWxvZztcbiAgICByZWFkb25seSBhbmltYXRpb246IEFuaW1hdGlvbjtcbiAgICByZWFkb25seSB2aWRlbzogVmlkZW8gPSB1bmRlZmluZWQ7XG4gICAgcHJpdmF0ZSByZWFkb25seSBkZW1vVHlwZTogRGVtb1R5cGU7XG4gICAgXG4gICAgY29uc3RydWN0b3IoZGVtb1R5cGU6IERlbW9UeXBlKSB7XG4gICAgICAgIHRoaXMuZGlhbG9nID0gbmV3IERpYWxvZyhkZW1vVHlwZSk7XG4gICAgICAgIHRoaXMuYW5pbWF0aW9uID0gbmV3IEFuaW1hdGlvbigpO1xuICAgICAgICB0aGlzLmRpYWxvZ1xuICAgICAgICAgICAgLmluc2VydEJlZm9yZSh0aGlzLmFuaW1hdGlvbilcbiAgICAgICAgICAgIC5zZXRPcGFjVHJhbnNEdXIoKTtcbiAgICAgICAgdGhpcy5hbmltYXRpb24uc2V0T3BhY1RyYW5zRHVyKCk7XG4gICAgICAgIGlmICggZGVtb1R5cGUgPT09IFwidmlkZW9cIiB8fCBHbG9iLkJpZ0NvbmZpZy5kZXYuZm9yY2VfcGxheV92aWRlbygpICkge1xuICAgICAgICAgICAgdGhpcy52aWRlbyA9IG5ldyBWaWRlbygpXG4gICAgICAgICAgICAgICAgLmFwcGVuZFRvKEdsb2IuTWFpbkNvbnRlbnQpO1xuICAgICAgICAgICAgdGhpcy52aWRlby5zZXRPcGFjVHJhbnNEdXIoKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRlbW9UeXBlID0gZGVtb1R5cGU7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGluaXQocmVhZG9ubHlUcnV0aDogUmVhZG9ubHlUcnV0aCkge1xuICAgICAgICBjb25zdCBwcm9taXNlcyA9IFtdO1xuICAgICAgICBpZiAoIHRoaXMudmlkZW8gKSB7XG4gICAgICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMudmlkZW8uaW5pdChyZWFkb25seVRydXRoLm1wNC5hYnNQYXRoLCByZWFkb25seVRydXRoLm9uc2V0cy5hYnNQYXRoKSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHByb21pc2VzLnB1c2godGhpcy5hbmltYXRpb24uaW5pdChyZWFkb25seVRydXRoLm1pZGkuYWJzUGF0aCkpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICB9XG4gICAgXG4gICAgYXN5bmMgaW50cm8oKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoYEV4cGVyaW1lbnQuaW50cm8oKWApO1xuICAgICAgICBhd2FpdCB3YWl0KDApO1xuICAgICAgICBcbiAgICAgICAgLypjb25zdCBwcm9taXNlcyA9IFtcbiAgICAgICAgIHRoaXMuZGlhbG9nLmludHJvKCksXG4gICAgICAgICBcbiAgICAgICAgIF07XG4gICAgICAgICBpZiAoIHRoaXMudmlkZW8gKSB7XG4gICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMudmlkZW8uaW5pdChyZWFkb25seVRydXRoLm1wNC5hYnNQYXRoLCByZWFkb25seVRydXRoLm9uc2V0cy5hYnNQYXRoKSlcbiAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICBwcm9taXNlcy5wdXNoKHRoaXMuYW5pbWF0aW9uLmluaXQocmVhZG9ubHlUcnV0aC5taWRpLmFic1BhdGgpKVxuICAgICAgICAgfVxuICAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpOyovXG4gICAgICAgIGF3YWl0IHRoaXMuZGlhbG9nLmludHJvKCk7XG4gICAgICAgIFxuICAgICAgICAvLy8gdmlkZW8gLyBhbmltYXRpb25cbiAgICAgICAgbGV0IGRlbW87XG4gICAgICAgIGlmICggR2xvYi5CaWdDb25maWcuZGV2LmZvcmNlX3BsYXlfdmlkZW8oKSApIHtcbiAgICAgICAgICAgIGRlbW8gPSB0aGlzLnZpZGVvO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZGVtbyA9IHRoaXNbdGhpcy5kZW1vVHlwZV07XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgZGVtby5kaXNwbGF5KCk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBwcm9taXNlRG9uZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIEdsb2IuRG9jdW1lbnQub24oe1xuICAgICAgICAgICAgICAgIGNsaWNrIDogYXN5bmMgKGV2OiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgIGV2LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpYWxvZy5oaWRlKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBHbG9iLmhpZGUoXCJUaXRsZVwiLCBcIk5hdmlnYXRpb25CdXR0b25zXCIpXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIEdsb2IuRG9jdW1lbnQub2ZmKFwiY2xpY2tcIik7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRlbW8uaW50cm8oKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYGRvbmUgcGxheWluZyAke3RoaXMuZGVtb1R5cGV9YCk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHdhaXQoMTAwMCk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGRlbW8uaGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgICAgICByZXR1cm4gYXdhaXQgcHJvbWlzZURvbmU7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBhc3luYyBsZXZlbEludHJvKGxldmVsQ29sbGVjdGlvbjogTGV2ZWxDb2xsZWN0aW9uKSB7XG4gICAgICAgIEdsb2IuVGl0bGUubGV2ZWxoMy50ZXh0KGBMZXZlbCAxLyR7bGV2ZWxDb2xsZWN0aW9uLmxlbmd0aH1gKTtcbiAgICAgICAgR2xvYi5UaXRsZS50cmlhbGgzLnRleHQoYFRyaWFsIDEvJHtsZXZlbENvbGxlY3Rpb24uY3VycmVudC50cmlhbHN9YCk7XG4gICAgICAgIGxldCBwbGF5VmlkZW87XG4gICAgICAgIGlmICggR2xvYi5CaWdDb25maWcuZGV2LmZvcmNlX3BsYXlfdmlkZW8oKSApIHtcbiAgICAgICAgICAgIHBsYXlWaWRlbyA9IHRydWU7XG4gICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICggdGhpcy5kZW1vVHlwZSA9PT0gXCJhbmltYXRpb25cIiApIHtcbiAgICAgICAgICAgICAgICBwbGF5VmlkZW8gPSBmYWxzZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gZG9uJ3QgZmxpcCBiZWNhdXNlIHVuZGVmaW5lZCAhPT0gbnVtYmVyXG4gICAgICAgICAgICAgICAgcGxheVZpZGVvID0gbGV2ZWxDb2xsZWN0aW9uLnByZXZpb3VzPy5ub3RlcyAhPT0gbGV2ZWxDb2xsZWN0aW9uLmN1cnJlbnQubm90ZXM7XG4gICAgICAgICAgICAgICAgaWYgKCBwbGF5VmlkZW8gKSBjb25zb2xlLndhcm4oYHBsYXlWaWRlb2AsIHBsYXlWaWRlbyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBbXG4gICAgICAgICAgICBHbG9iLmRpc3BsYXkoXCJUaXRsZVwiLCBcIk5hdmlnYXRpb25CdXR0b25zXCIpLFxuICAgICAgICAgICAgdGhpcy5kaWFsb2cubGV2ZWxJbnRybyhsZXZlbENvbGxlY3Rpb24sIHBsYXlWaWRlbylcbiAgICAgICAgXTtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgICAgICBjb25zdCBQWV9nZXRPbk9mZlBhaXJzID0gbmV3IE15UHlTaGVsbCgnLW0gdHh0LmdldF9vbl9vZmZfcGFpcnMnLCB7XG4gICAgICAgICAgICBtb2RlIDogXCJqc29uXCIsXG4gICAgICAgICAgICBhcmdzIDogWyAnRklSU1RhcmcnIF1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2VzID0gYXdhaXQgUFlfZ2V0T25PZmZQYWlycy5ydW5Bc3luYygpO1xuICAgICAgICBjb25zb2xlLmxvZyhtZXNzYWdlcyk7XG4gICAgICAgIGZvciAoIGxldCBtIG9mIG1lc3NhZ2VzICkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5wYXJzZShtKSk7XG4gICAgICAgIH1cbiAgICAgICAgLypcbiAgICAgICAgIGlmICggcGxheVZpZGVvICkge1xuICAgICAgICAgYXdhaXQgdGhpcy52aWRlby5kaXNwbGF5KCk7XG4gICAgICAgICBjb25zdCB2aWRlb0RvbmUgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgIFxuICAgICAgICAgXG4gICAgICAgICBHbG9iLkRvY3VtZW50Lm9uKHtcbiAgICAgICAgIGNsaWNrIDogYXN5bmMgKGV2OiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgZXYuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgICB0aGlzLmRpYWxvZy5oaWRlKCksXG4gICAgICAgICBHbG9iLmhpZGUoXCJUaXRsZVwiLCBcIk5hdmlnYXRpb25CdXR0b25zXCIpXG4gICAgICAgICBcbiAgICAgICAgIF0pO1xuICAgICAgICAgXG4gICAgICAgICBHbG9iLkRvY3VtZW50Lm9mZihcImNsaWNrXCIpO1xuICAgICAgICAgYXdhaXQgdGhpcy52aWRlby5sZXZlbEludHJvKGxldmVsQ29sbGVjdGlvbi5jdXJyZW50Lm5vdGVzKTtcbiAgICAgICAgIGNvbnNvbGUubG9nKGBkb25lIHBsYXlpbmcgJHt0aGlzLmRlbW9UeXBlfWApO1xuICAgICAgICAgYXdhaXQgd2FpdCgxMDAwKTtcbiAgICAgICAgIGF3YWl0IHRoaXMudmlkZW8uaGlkZSgpO1xuICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgXG4gICAgICAgICB9XG4gICAgICAgICB9KTtcbiAgICAgICAgIH0pO1xuICAgICAgICAgfVxuICAgICAgICAgKi9cbiAgICB9XG4gICAgXG59XG5cbmV4cG9ydCBkZWZhdWx0IEV4cGVyaW1lbnQ7XG4iXX0=