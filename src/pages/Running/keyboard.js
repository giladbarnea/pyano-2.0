"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util = require("../../util");
const Glob_1 = require("../../Glob");
const Piano_1 = require("../../Piano");
const midi_1 = require("@tonejs/midi");
const Tone = require("tone");
const bhe_1 = require("../../bhe");
class Keyboard extends bhe_1.VisualBHE {
    constructor() {
        const keys = {
            A0: {
                '[data-note="A0"]': {
                    'A#0': '[data-note="A#0"]'
                }
            },
            B0: '[data-note="B0"]',
        };
        const indexToLetter = {
            1: "C",
            2: "D",
            3: "E",
            4: "F",
            5: "G",
            6: "A",
            7: "B"
        };
        const noblacks = [3, 7];
        for (let register of util.range(1, 7)) {
            for (let keyIndex of util.range(1, 7)) {
                let letter = indexToLetter[keyIndex];
                let name = `${letter}${register}`;
                let value;
                if (noblacks.includes(keyIndex)) {
                    value = `[data-note="${name}"]`;
                }
                else {
                    let query = `[data-note="${name}"]`;
                    let subname = `${letter}#${register}`;
                    let subquery = `[data-note="${subname}"]`;
                    let subvalue = {};
                    subvalue[subname] = subquery;
                    value = {};
                    value[query] = subvalue;
                }
                keys[name] = value;
            }
        }
        super({
            id: 'keyboard', children: keys
        });
    }
    async intro() {
        console.group(`Keyboard.intro()`);
        let noteOffObjs = [];
        let noteOnObjs = [];
        let notes;
        const maxAnimationNotes = Glob_1.default.BigConfig.dev.max_animation_notes();
        if (maxAnimationNotes) {
            notes = this.notes.slice(0, maxAnimationNotes);
        }
        else {
            notes = this.notes;
        }
        for (let note of notes) {
            let { name, velocity, duration, time: timeOn } = note;
            let timeOff = timeOn + duration;
            noteOffObjs.push({ name, time: timeOff });
            noteOnObjs.push({ name, time: timeOn, duration, velocity });
        }
        const promiseDone = new Promise(resolve => {
            let count = 0;
            const noteOffCallback = async (time, event) => {
                Tone.Draw.schedule(() => this.paintKey(event, "green", false), time);
                this.piano.keyUp(event.name, time);
                count++;
                if (noteOffEvents.length === count) {
                    const now = Tone.Transport.now();
                    const util = require("../../util");
                    const diff = now - time;
                    await util.wait((diff * 1000), false);
                    resolve();
                    console.log('intro done', { event, time, now, diff, });
                }
            };
            const noteOnCallback = (time, event) => {
                Tone.Draw.schedule(() => this.paintKey(event, "green", true), time);
                this.piano.keyDown(event.name, time, event.velocity);
            };
            const noteOffEvents = new Tone.Part(noteOffCallback, noteOffObjs).start();
            const noteOnEvents = new Tone.Part(noteOnCallback, noteOnObjs).start();
            console.log({ noteOffEvents });
        });
        remote.globalShortcut.register("CommandOrControl+M", () => Tone.Transport.toggle());
        console.groupEnd();
        return await promiseDone;
    }
    paintKey({ name }, color, on) {
        let child;
        if (name.includes('#')) {
            let nohash = name.replace('#', '');
            child = this[nohash][name];
        }
        else {
            child = this[name];
        }
        child.toggleClass(color, on);
    }
    async initPiano(midiAbsPath) {
        console.group(`Keyboard.initPiano()`);
        const pianoOptions = {
            samples: SALAMANDER_PATH_ABS,
            release: true,
            pedal: false,
            velocities: Glob_1.default.BigConfig.velocities,
        };
        if (Glob_1.default.BigConfig.dev.mute_animation()) {
            pianoOptions.volume = { strings: -Infinity, harmonics: -Infinity, keybed: -Infinity, pedal: -Infinity };
        }
        this.piano = new Piano_1.Piano(pianoOptions).toDestination();
        const promisePianoLoaded = this.piano.load();
        const promiseMidiLoaded = midi_1.Midi.fromUrl(midiAbsPath);
        const [_, midi] = await Promise.all([promisePianoLoaded, promiseMidiLoaded]);
        console.log('piano loaded');
        console.log('midi loaded', midi);
        this.notes = midi.tracks[0].notes;
        Tone.Transport.start();
        console.groupEnd();
        return;
    }
}
exports.default = Keyboard;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5Ym9hcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJrZXlib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUFrQztBQUNsQyxxQ0FBOEI7QUFDOUIsdUNBQWtEO0FBQ2xELHVDQUFvQztBQUNwQyw2QkFBNkI7QUFHN0IsbUNBQXNDO0FBUXRDLE1BQU0sUUFBUyxTQUFRLGVBQVM7SUFJNUI7UUFFSSxNQUFNLElBQUksR0FBRztZQUNULEVBQUUsRUFBRztnQkFDRCxrQkFBa0IsRUFBRztvQkFDakIsS0FBSyxFQUFHLG1CQUFtQjtpQkFDOUI7YUFDSjtZQUNELEVBQUUsRUFBRyxrQkFBa0I7U0FDMUIsQ0FBQztRQUNGLE1BQU0sYUFBYSxHQUFHO1lBQ2xCLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1NBQ1YsQ0FBQztRQUNGLE1BQU0sUUFBUSxHQUFHLENBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBRSxDQUFDO1FBQzFCLEtBQU0sSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUc7WUFDckMsS0FBTSxJQUFJLFFBQVEsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRztnQkFDckMsSUFBSSxNQUFNLEdBQUcsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNyQyxJQUFJLElBQUksR0FBRyxHQUFHLE1BQU0sR0FBRyxRQUFRLEVBQUUsQ0FBQztnQkFDbEMsSUFBSSxLQUFLLENBQUM7Z0JBQ1YsSUFBSyxRQUFRLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFHO29CQUMvQixLQUFLLEdBQUcsZUFBZSxJQUFJLElBQUksQ0FBQTtp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QkFBaUIsQ0FBRSxDQUFDLENBQUM7UUFFakYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdkIsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25CLE9BQU87SUFjWCxDQUFDO0NBQ0o7QUFFRCxrQkFBZSxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi91dGlsXCJcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi9HbG9iXCI7XG5pbXBvcnQgeyBQaWFubywgUGlhbm9PcHRpb25zIH0gZnJvbSBcIi4uLy4uL1BpYW5vXCI7XG5pbXBvcnQgeyBNaWRpIH0gZnJvbSBcIkB0b25lanMvbWlkaVwiO1xuaW1wb3J0ICogYXMgVG9uZSBmcm9tIFwidG9uZVwiO1xuaW1wb3J0IHsgTm90ZSB9IGZyb20gXCJAdG9uZWpzL21pZGkvZGlzdC9Ob3RlXCI7XG5pbXBvcnQgeyB3YWl0VW50aWwgfSBmcm9tIFwiLi4vLi4vdXRpbFwiO1xuaW1wb3J0IHsgVmlzdWFsQkhFIH0gZnJvbSBcIi4uLy4uL2JoZVwiO1xuXG50eXBlIE5vdGVFdmVudCA9IHsgbmFtZTogc3RyaW5nIH07XG4vLyB0eXBlIE5vdGVPZmZFdmVudCA9IHsgbmFtZTogc3RyaW5nIH07XG50eXBlIE5vdGVPbkV2ZW50ID0gTm90ZUV2ZW50ICYgeyB2ZWxvY2l0eTogbnVtYmVyIH07XG50eXBlIE5vdGVPZmYgPSBOb3RlRXZlbnQgJiB7IHRpbWU6IFRvbmUuVW5pdC5UaW1lIH07XG50eXBlIE5vdGVPbiA9IE5vdGVPbkV2ZW50ICYgeyB0aW1lOiBUb25lLlVuaXQuVGltZSwgZHVyYXRpb246IG51bWJlciB9O1xuXG5jbGFzcyBLZXlib2FyZCBleHRlbmRzIFZpc3VhbEJIRSB7XG4gICAgcHJpdmF0ZSBub3RlczogTm90ZVtdO1xuICAgIHByaXZhdGUgcGlhbm86IFBpYW5vO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBcbiAgICAgICAgY29uc3Qga2V5cyA9IHtcbiAgICAgICAgICAgIEEwIDoge1xuICAgICAgICAgICAgICAgICdbZGF0YS1ub3RlPVwiQTBcIl0nIDoge1xuICAgICAgICAgICAgICAgICAgICAnQSMwJyA6ICdbZGF0YS1ub3RlPVwiQSMwXCJdJ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBCMCA6ICdbZGF0YS1ub3RlPVwiQjBcIl0nLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBpbmRleFRvTGV0dGVyID0ge1xuICAgICAgICAgICAgMSA6IFwiQ1wiLFxuICAgICAgICAgICAgMiA6IFwiRFwiLFxuICAgICAgICAgICAgMyA6IFwiRVwiLFxuICAgICAgICAgICAgNCA6IFwiRlwiLFxuICAgICAgICAgICAgNSA6IFwiR1wiLFxuICAgICAgICAgICAgNiA6IFwiQVwiLFxuICAgICAgICAgICAgNyA6IFwiQlwiXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IG5vYmxhY2tzID0gWyAzLCA3IF07IC8vIEUsIEJcbiAgICAgICAgZm9yICggbGV0IHJlZ2lzdGVyIG9mIHV0aWwucmFuZ2UoMSwgNykgKSB7XG4gICAgICAgICAgICBmb3IgKCBsZXQga2V5SW5kZXggb2YgdXRpbC5yYW5nZSgxLCA3KSApIHtcbiAgICAgICAgICAgICAgICBsZXQgbGV0dGVyID0gaW5kZXhUb0xldHRlcltrZXlJbmRleF07XG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSBgJHtsZXR0ZXJ9JHtyZWdpc3Rlcn1gO1xuICAgICAgICAgICAgICAgIGxldCB2YWx1ZTtcbiAgICAgICAgICAgICAgICBpZiAoIG5vYmxhY2tzLmluY2x1ZGVzKGtleUluZGV4KSApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBgW2RhdGEtbm90ZT1cIiR7bmFtZX1cIl1gXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHF1ZXJ5ID0gYFtkYXRhLW5vdGU9XCIke25hbWV9XCJdYDtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1Ym5hbWUgPSBgJHtsZXR0ZXJ9IyR7cmVnaXN0ZXJ9YDtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1YnF1ZXJ5ID0gYFtkYXRhLW5vdGU9XCIke3N1Ym5hbWV9XCJdYDtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1YnZhbHVlID0ge307XG4gICAgICAgICAgICAgICAgICAgIHN1YnZhbHVlW3N1Ym5hbWVdID0gc3VicXVlcnk7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0ge307XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlW3F1ZXJ5XSA9IHN1YnZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBrZXlzW25hbWVdID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc3VwZXIoe1xuICAgICAgICAgICAgaWQgOiAna2V5Ym9hcmQnLCBjaGlsZHJlbiA6IGtleXNcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIHRoaXMuaW5pdFBpYW5vKCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgYXN5bmMgaW50cm8oKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoYEtleWJvYXJkLmludHJvKClgKTtcbiAgICAgICAgbGV0IG5vdGVPZmZPYmpzOiBOb3RlT2ZmW10gPSBbXTtcbiAgICAgICAgbGV0IG5vdGVPbk9ianM6IE5vdGVPbltdID0gW107XG4gICAgICAgIGxldCBub3RlczogTm90ZVtdO1xuICAgICAgICBjb25zdCBtYXhBbmltYXRpb25Ob3RlcyA9IEdsb2IuQmlnQ29uZmlnLmRldi5tYXhfYW5pbWF0aW9uX25vdGVzKCk7XG4gICAgICAgIGlmICggbWF4QW5pbWF0aW9uTm90ZXMgKSB7XG4gICAgICAgICAgICBub3RlcyA9IHRoaXMubm90ZXMuc2xpY2UoMCwgbWF4QW5pbWF0aW9uTm90ZXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm90ZXMgPSB0aGlzLm5vdGVzO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoIGxldCBub3RlIG9mIG5vdGVzICkge1xuICAgICAgICAgICAgbGV0IHsgbmFtZSwgdmVsb2NpdHksIGR1cmF0aW9uLCB0aW1lIDogdGltZU9uIH0gPSBub3RlO1xuICAgICAgICAgICAgbGV0IHRpbWVPZmYgPSB0aW1lT24gKyBkdXJhdGlvbjtcbiAgICAgICAgICAgIG5vdGVPZmZPYmpzLnB1c2goeyBuYW1lLCB0aW1lIDogdGltZU9mZiB9KTtcbiAgICAgICAgICAgIG5vdGVPbk9ianMucHVzaCh7IG5hbWUsIHRpbWUgOiB0aW1lT24sIGR1cmF0aW9uLCB2ZWxvY2l0eSB9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwcm9taXNlRG9uZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgICAgICAgbGV0IGNvdW50ID0gMDtcbiAgICAgICAgICAgIC8vIGxldCBkb25lID0gZmFsc2U7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IG5vdGVPZmZDYWxsYmFjayA9IGFzeW5jICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCBcImdyZWVuXCIsIGZhbHNlKSwgdGltZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5waWFuby5rZXlVcChldmVudC5uYW1lLCB0aW1lKTtcbiAgICAgICAgICAgICAgICBjb3VudCsrO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICggbm90ZU9mZkV2ZW50cy5sZW5ndGggPT09IGNvdW50ICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBub3cgPSBUb25lLlRyYW5zcG9ydC5ub3coKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXRpbCA9IHJlcXVpcmUoXCIuLi8uLi91dGlsXCIpO1xuICAgICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRpZmYgPSBub3cgLSB0aW1lO1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoKGRpZmYgKiAxMDAwKSwgZmFsc2UpO1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgICAgIC8vIGRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnaW50cm8gZG9uZScsIHsgZXZlbnQsIHRpbWUsIG5vdywgZGlmZiwgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3Qgbm90ZU9uQ2FsbGJhY2sgPSAodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlT25FdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCBcImdyZWVuXCIsIHRydWUpLCB0aW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBpYW5vLmtleURvd24oZXZlbnQubmFtZSwgdGltZSwgZXZlbnQudmVsb2NpdHkpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIC8vIGNvbnN0IG5vdyA9IFRvbmUuVHJhbnNwb3J0Lm5vdygpO1xuICAgICAgICAgICAgY29uc3Qgbm90ZU9mZkV2ZW50cyA9IG5ldyBUb25lLlBhcnQobm90ZU9mZkNhbGxiYWNrLCBub3RlT2ZmT2Jqcykuc3RhcnQoKTtcbiAgICAgICAgICAgIGNvbnN0IG5vdGVPbkV2ZW50cyA9IG5ldyBUb25lLlBhcnQobm90ZU9uQ2FsbGJhY2ssIG5vdGVPbk9ianMpLnN0YXJ0KCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc29sZS5sb2coeyBub3RlT2ZmRXZlbnRzIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgcmVtb3RlLmdsb2JhbFNob3J0Y3V0LnJlZ2lzdGVyKFwiQ29tbWFuZE9yQ29udHJvbCtNXCIsICgpID0+IFRvbmUuVHJhbnNwb3J0LnRvZ2dsZSgpKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgICAgICByZXR1cm4gYXdhaXQgcHJvbWlzZURvbmU7XG4gICAgICAgIC8vIHJldHVybiBhd2FpdCB3YWl0VW50aWwoKCkgPT4gZG9uZSwgNTAwKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIHBhaW50S2V5KHsgbmFtZSB9OiBOb3RlRXZlbnQsIGNvbG9yOiBcInJlZFwiIHwgXCJncmVlblwiIHwgXCJibHVlXCIsIG9uOiBib29sZWFuKSB7XG4gICAgICAgIGxldCBjaGlsZDtcbiAgICAgICAgaWYgKCBuYW1lLmluY2x1ZGVzKCcjJykgKSB7XG4gICAgICAgICAgICBsZXQgbm9oYXNoID0gbmFtZS5yZXBsYWNlKCcjJywgJycpO1xuICAgICAgICAgICAgY2hpbGQgPSB0aGlzW25vaGFzaF1bbmFtZV07XG4gICAgICAgICAgICAvLyB0aGlzW25vaGFzaF1bbmFtZV0udG9nZ2xlQ2xhc3MoJ29uJywgb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gdGhpc1tuYW1lXS50b2dnbGVDbGFzcygnb24nLCBvbik7XG4gICAgICAgICAgICBjaGlsZCA9IHRoaXNbbmFtZV07XG4gICAgICAgIH1cbiAgICAgICAgY2hpbGQudG9nZ2xlQ2xhc3MoY29sb3IsIG9uKTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgaW5pdFBpYW5vKG1pZGlBYnNQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgS2V5Ym9hcmQuaW5pdFBpYW5vKClgKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHBpYW5vT3B0aW9uczogUGFydGlhbDxQaWFub09wdGlvbnM+ID0ge1xuICAgICAgICAgICAgc2FtcGxlcyA6IFNBTEFNQU5ERVJfUEFUSF9BQlMsXG4gICAgICAgICAgICByZWxlYXNlIDogdHJ1ZSxcbiAgICAgICAgICAgIHBlZGFsIDogZmFsc2UsXG4gICAgICAgICAgICB2ZWxvY2l0aWVzIDogR2xvYi5CaWdDb25maWcudmVsb2NpdGllcyxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKCBHbG9iLkJpZ0NvbmZpZy5kZXYubXV0ZV9hbmltYXRpb24oKSApIHtcbiAgICAgICAgICAgIHBpYW5vT3B0aW9ucy52b2x1bWUgPSB7IHN0cmluZ3MgOiAtSW5maW5pdHksIGhhcm1vbmljcyA6IC1JbmZpbml0eSwga2V5YmVkIDogLUluZmluaXR5LCBwZWRhbCA6IC1JbmZpbml0eSB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5waWFubyA9IG5ldyBQaWFubyhwaWFub09wdGlvbnMpLnRvRGVzdGluYXRpb24oKTtcbiAgICAgICAgY29uc3QgcHJvbWlzZVBpYW5vTG9hZGVkID0gdGhpcy5waWFuby5sb2FkKCk7XG4gICAgICAgIGNvbnN0IHByb21pc2VNaWRpTG9hZGVkID0gTWlkaS5mcm9tVXJsKG1pZGlBYnNQYXRoKTtcbiAgICAgICAgY29uc3QgWyBfLCBtaWRpIF0gPSBhd2FpdCBQcm9taXNlLmFsbChbIHByb21pc2VQaWFub0xvYWRlZCwgcHJvbWlzZU1pZGlMb2FkZWQgXSk7XG4gICAgICAgIC8vIGNvbnN0IG1pZGkgPSBhd2FpdCBNaWRpLmZyb21Vcmwoc3ViY29uZmlnLnRydXRoLm1pZGkuYWJzUGF0aCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdwaWFubyBsb2FkZWQnKTtcbiAgICAgICAgY29uc29sZS5sb2coJ21pZGkgbG9hZGVkJywgbWlkaSk7XG4gICAgICAgIHRoaXMubm90ZXMgPSBtaWRpLnRyYWNrc1swXS5ub3RlcztcbiAgICAgICAgVG9uZS5UcmFuc3BvcnQuc3RhcnQoKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgICAgICByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAvLyBjb25zdCBub3RlT2ZmQ2FsbGJhY2sgPSAodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlRXZlbnQpID0+IHtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCBmYWxzZSksIHRpbWUpO1xuICAgICAgICAvLyAgICAgcGlhbm8ua2V5VXAoZXZlbnQubmFtZSwgdGltZSk7XG4gICAgICAgIC8vIH07XG4gICAgICAgIFxuICAgICAgICAvLyBjb25zdCBub3RlT25DYWxsYmFjayA9ICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPbkV2ZW50KSA9PiB7XG4gICAgICAgIC8vICAgICBUb25lLkRyYXcuc2NoZWR1bGUoKCkgPT4gdGhpcy5wYWludEtleShldmVudCwgdHJ1ZSksIHRpbWUpO1xuICAgICAgICAvLyAgICAgcGlhbm8ua2V5RG93bihldmVudC5uYW1lLCB0aW1lLCBldmVudC52ZWxvY2l0eSk7XG4gICAgICAgIC8vIH07XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEtleWJvYXJkO1xuIl19