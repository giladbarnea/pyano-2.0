"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../bhe");
const util = require("../../util");
const Glob_1 = require("../../Glob");
const Piano_1 = require("../../Piano");
const midi_1 = require("@tonejs/midi");
const Tone = require("tone");
class Keyboard extends bhe_1.BetterHTMLElement {
    constructor() {
        console.group('Keyboard ctor');
        const keys = {
            A0: {
                '[data-note="A0"]': {
                    'A#0': '[data-note="A#0"]'
                }
            },
            B0: '[data-note="B0"]',
        };
        const indexToLetter = {
            1: "C",
            2: "D",
            3: "E",
            4: "F",
            5: "G",
            6: "A",
            7: "B"
        };
        const noblacks = [3, 7];
        for (let register of util.range(1, 7)) {
            for (let keyIndex of util.range(1, 7)) {
                let letter = indexToLetter[keyIndex];
                let name = `${letter}${register}`;
                let value;
                if (noblacks.includes(keyIndex)) {
                    value = `[data-note="${name}"]`;
                }
                else {
                    let query = `[data-note="${name}"]`;
                    let subname = `${letter}#${register}`;
                    let subquery = `[data-note="${subname}"]`;
                    let subvalue = {};
                    subvalue[subname] = subquery;
                    value = {};
                    value[query] = subvalue;
                }
                keys[name] = value;
            }
        }
        console.log({ keys });
        super({
            id: 'keyboard', children: keys
        });
        console.groupEnd();
    }
    async intro() {
        let noteOffObjs = [];
        let noteOnObjs = [];
        let notes;
        const maxAnimationNotes = Glob_1.default.BigConfig.dev.max_animation_notes();
        if (maxAnimationNotes) {
            notes = this.notes.slice(0, maxAnimationNotes);
        }
        else {
            notes = this.notes;
        }
        for (let note of notes) {
            let { name, velocity, duration, time: timeOn } = note;
            let timeOff = timeOn + duration;
            noteOffObjs.push({ name, time: timeOff });
            noteOnObjs.push({ name, time: timeOn, duration, velocity });
        }
        const noteOffCallback = (time, event) => {
            Tone.Draw.schedule(() => this.paintKey(event, false), time);
            this.piano.keyUp(event.name, time);
        };
        const noteOnCallback = (time, event) => {
            Tone.Draw.schedule(() => this.paintKey(event, true), time);
            this.piano.keyDown(event.name, time, event.velocity);
        };
        const now = Tone.Transport.now();
        const noteOffEvents = new Tone.Part(noteOffCallback, noteOffObjs).start();
        const noteOnEvents = new Tone.Part(noteOnCallback, noteOnObjs).start();
        Tone.Transport.start();
        remote.globalShortcut.register("CommandOrControl+M", () => Tone.Transport.toggle());
    }
    paintKey(event, on) {
        if (event.name.includes('#')) {
            let nohash = event.name.replace('#', '');
            this[nohash][event.name].toggleClass('on', on);
        }
        else {
            this[event.name].toggleClass('on', on);
        }
    }
    noteOffCallback(time, event) {
        Tone.Draw.schedule(() => this.paintKey(event, false), time);
        this.piano.keyUp(event.name, time);
    }
    noteOnCallback(time, event) {
        Tone.Draw.schedule(() => this.paintKey(event, true), time);
        this.piano.keyDown(event.name, time, event.velocity);
    }
    async initPiano() {
        console.group(`initPiano()`);
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const pianoOptions = {
            samples: SALAMANDER_PATH_ABS,
            release: true,
            pedal: false,
            velocities: Glob_1.default.BigConfig.velocities,
        };
        if (Glob_1.default.BigConfig.dev.mute_animation()) {
            pianoOptions.volume = { strings: -Infinity, harmonics: -Infinity, keybed: -Infinity, pedal: -Infinity };
        }
        this.piano = new Piano_1.Piano(pianoOptions).toDestination();
        const promisePianoLoaded = this.piano.load();
        const promiseMidiLoaded = midi_1.Midi.fromUrl(subconfig.truth.midi.absPath);
        const [_, midi] = await Promise.all([promisePianoLoaded, promiseMidiLoaded]);
        console.log('piano loaded');
        console.log('midi loaded', midi);
        this.notes = midi.tracks[0].notes;
        console.groupEnd();
        return;
    }
}
exports.default = Keyboard;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5Ym9hcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJrZXlib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUE4QztBQUM5QyxtQ0FBa0M7QUFDbEMscUNBQThCO0FBQzlCLHVDQUFrRDtBQUNsRCx1Q0FBb0M7QUFDcEMsNkJBQTZCO0FBWTdCLE1BQU0sUUFBUyxTQUFRLHVCQUFpQjtJQUlwQztRQUNJLE9BQU8sQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFL0IsTUFBTSxJQUFJLEdBQUc7WUFDVCxFQUFFLEVBQUc7Z0JBQ0Qsa0JBQWtCLEVBQUc7b0JBQ2pCLEtBQUssRUFBRyxtQkFBbUI7aUJBQzlCO2FBQ0o7WUFDRCxFQUFFLEVBQUcsa0JBQWtCO1NBQzFCLENBQUM7UUFDRixNQUFNLGFBQWEsR0FBRztZQUNsQixDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztTQUNWLENBQUM7UUFDRixNQUFNLFFBQVEsR0FBRyxDQUFFLENBQUMsRUFBRSxDQUFDLENBQUUsQ0FBQztRQUMxQixLQUFNLElBQUksUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFHO1lBQ3JDLEtBQU0sSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUc7Z0JBQ3JDLElBQUksTUFBTSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDckMsSUFBSSxJQUFJLEdBQUcsR0FBRyxNQUFNLEdBQUcsUUFBUSxFQUFFLENBQUM7Z0JBQ2xDLElBQUksS0FBSyxDQUFDO2dCQUNWLElBQUssUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMs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QU0sQ0FBRSxDQUFDLEVBQUUsSUFBSSxDQUFFLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUUsa0JBQWtCLEVBQUUsaUJBQWlCLENBQUUsQ0FBQyxDQUFDO1FBRWpGLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDNUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQztRQUNsQyxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDbkIsT0FBTztJQWNYLENBQUM7Q0FDSjtBQUdELGtCQUFlLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJldHRlckhUTUxFbGVtZW50IH0gZnJvbSBcIi4uLy4uL2JoZVwiO1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tIFwiLi4vLi4vdXRpbFwiXG5pbXBvcnQgR2xvYiBmcm9tIFwiLi4vLi4vR2xvYlwiO1xuaW1wb3J0IHsgUGlhbm8sIFBpYW5vT3B0aW9ucyB9IGZyb20gXCIuLi8uLi9QaWFub1wiO1xuaW1wb3J0IHsgTWlkaSB9IGZyb20gXCJAdG9uZWpzL21pZGlcIjtcbmltcG9ydCAqIGFzIFRvbmUgZnJvbSBcInRvbmVcIjtcbmltcG9ydCB7IE5vdGUgfSBmcm9tIFwiQHRvbmVqcy9taWRpL2Rpc3QvTm90ZVwiO1xuLy8gaW1wb3J0ICogYXMgVG9uZSBmcm9tIFwidG9uZVwiO1xuLy8gaW1wb3J0IE5vdGUgPSBUb25lLkVuY29kaW5nLk5vdGU7XG4vLyBpbXBvcnQgYXN4IGZyb20gXCIuLi8uLi9hc3hcIjtcblxuXG50eXBlIE5vdGVPZmZFdmVudCA9IHsgbmFtZTogc3RyaW5nIH07XG50eXBlIE5vdGVPbkV2ZW50ID0gTm90ZU9mZkV2ZW50ICYgeyB2ZWxvY2l0eTogbnVtYmVyIH07XG50eXBlIE5vdGVPZmYgPSBOb3RlT2ZmRXZlbnQgJiB7IHRpbWU6IFRvbmUuVW5pdC5UaW1lIH07XG50eXBlIE5vdGVPbiA9IE5vdGVPbkV2ZW50ICYgeyB0aW1lOiBUb25lLlVuaXQuVGltZSwgZHVyYXRpb246IG51bWJlciB9O1xuXG5jbGFzcyBLZXlib2FyZCBleHRlbmRzIEJldHRlckhUTUxFbGVtZW50IHtcbiAgICBwcml2YXRlIG5vdGVzOiBOb3RlW107XG4gICAgcHJpdmF0ZSBwaWFubzogUGlhbm87XG4gICAgXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoJ0tleWJvYXJkIGN0b3InKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGtleXMgPSB7XG4gICAgICAgICAgICBBMCA6IHtcbiAgICAgICAgICAgICAgICAnW2RhdGEtbm90ZT1cIkEwXCJdJyA6IHtcbiAgICAgICAgICAgICAgICAgICAgJ0EjMCcgOiAnW2RhdGEtbm90ZT1cIkEjMFwiXSdcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgQjAgOiAnW2RhdGEtbm90ZT1cIkIwXCJdJyxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgaW5kZXhUb0xldHRlciA9IHtcbiAgICAgICAgICAgIDEgOiBcIkNcIixcbiAgICAgICAgICAgIDIgOiBcIkRcIixcbiAgICAgICAgICAgIDMgOiBcIkVcIixcbiAgICAgICAgICAgIDQgOiBcIkZcIixcbiAgICAgICAgICAgIDUgOiBcIkdcIixcbiAgICAgICAgICAgIDYgOiBcIkFcIixcbiAgICAgICAgICAgIDcgOiBcIkJcIlxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBub2JsYWNrcyA9IFsgMywgNyBdOyAvLyBFLCBCXG4gICAgICAgIGZvciAoIGxldCByZWdpc3RlciBvZiB1dGlsLnJhbmdlKDEsIDcpICkge1xuICAgICAgICAgICAgZm9yICggbGV0IGtleUluZGV4IG9mIHV0aWwucmFuZ2UoMSwgNykgKSB7XG4gICAgICAgICAgICAgICAgbGV0IGxldHRlciA9IGluZGV4VG9MZXR0ZXJba2V5SW5kZXhdO1xuICAgICAgICAgICAgICAgIGxldCBuYW1lID0gYCR7bGV0dGVyfSR7cmVnaXN0ZXJ9YDtcbiAgICAgICAgICAgICAgICBsZXQgdmFsdWU7XG4gICAgICAgICAgICAgICAgaWYgKCBub2JsYWNrcy5pbmNsdWRlcyhrZXlJbmRleCkgKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYFtkYXRhLW5vdGU9XCIke25hbWV9XCJdYFxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBxdWVyeSA9IGBbZGF0YS1ub3RlPVwiJHtuYW1lfVwiXWA7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJuYW1lID0gYCR7bGV0dGVyfSMke3JlZ2lzdGVyfWA7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJxdWVyeSA9IGBbZGF0YS1ub3RlPVwiJHtzdWJuYW1lfVwiXWA7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJ2YWx1ZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBzdWJ2YWx1ZVtzdWJuYW1lXSA9IHN1YnF1ZXJ5O1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZVtxdWVyeV0gPSBzdWJ2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAga2V5c1tuYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKHsga2V5cyB9KTtcbiAgICAgICAgc3VwZXIoe1xuICAgICAgICAgICAgaWQgOiAna2V5Ym9hcmQnLCBjaGlsZHJlbiA6IGtleXNcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIHRoaXMuaW5pdFBpYW5vKCk7XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBhc3luYyBpbnRybygpIHtcbiAgICAgICAgbGV0IG5vdGVPZmZPYmpzOiBOb3RlT2ZmW10gPSBbXTtcbiAgICAgICAgbGV0IG5vdGVPbk9ianM6IE5vdGVPbltdID0gW107XG4gICAgICAgIGxldCBub3RlczogTm90ZVtdO1xuICAgICAgICBjb25zdCBtYXhBbmltYXRpb25Ob3RlcyA9IEdsb2IuQmlnQ29uZmlnLmRldi5tYXhfYW5pbWF0aW9uX25vdGVzKCk7XG4gICAgICAgIGlmICggbWF4QW5pbWF0aW9uTm90ZXMgKSB7XG4gICAgICAgICAgICBub3RlcyA9IHRoaXMubm90ZXMuc2xpY2UoMCwgbWF4QW5pbWF0aW9uTm90ZXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm90ZXMgPSB0aGlzLm5vdGVzO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoIGxldCBub3RlIG9mIG5vdGVzICkge1xuICAgICAgICAgICAgbGV0IHsgbmFtZSwgdmVsb2NpdHksIGR1cmF0aW9uLCB0aW1lIDogdGltZU9uIH0gPSBub3RlO1xuICAgICAgICAgICAgbGV0IHRpbWVPZmYgPSB0aW1lT24gKyBkdXJhdGlvbjtcbiAgICAgICAgICAgIG5vdGVPZmZPYmpzLnB1c2goeyBuYW1lLCB0aW1lIDogdGltZU9mZiB9KTtcbiAgICAgICAgICAgIG5vdGVPbk9ianMucHVzaCh7IG5hbWUsIHRpbWUgOiB0aW1lT24sIGR1cmF0aW9uLCB2ZWxvY2l0eSB9KTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBub3RlT2ZmQ2FsbGJhY2sgPSAodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlT2ZmRXZlbnQpID0+IHtcbiAgICAgICAgICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCBmYWxzZSksIHRpbWUpO1xuICAgICAgICAgICAgdGhpcy5waWFuby5rZXlVcChldmVudC5uYW1lLCB0aW1lKTtcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IG5vdGVPbkNhbGxiYWNrID0gKHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBldmVudDogTm90ZU9uRXZlbnQpID0+IHtcbiAgICAgICAgICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCB0cnVlKSwgdGltZSk7XG4gICAgICAgICAgICB0aGlzLnBpYW5vLmtleURvd24oZXZlbnQubmFtZSwgdGltZSwgZXZlbnQudmVsb2NpdHkpO1xuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgY29uc3Qgbm93ID0gVG9uZS5UcmFuc3BvcnQubm93KCk7XG4gICAgICAgIGNvbnN0IG5vdGVPZmZFdmVudHMgPSBuZXcgVG9uZS5QYXJ0KG5vdGVPZmZDYWxsYmFjaywgbm90ZU9mZk9ianMpLnN0YXJ0KCk7XG4gICAgICAgIGNvbnN0IG5vdGVPbkV2ZW50cyA9IG5ldyBUb25lLlBhcnQobm90ZU9uQ2FsbGJhY2ssIG5vdGVPbk9ianMpLnN0YXJ0KCk7XG4gICAgICAgIFRvbmUuVHJhbnNwb3J0LnN0YXJ0KCk7XG4gICAgICAgIFxuICAgICAgICByZW1vdGUuZ2xvYmFsU2hvcnRjdXQucmVnaXN0ZXIoXCJDb21tYW5kT3JDb250cm9sK01cIiwgKCkgPT4gVG9uZS5UcmFuc3BvcnQudG9nZ2xlKCkpO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgcGFpbnRLZXkoZXZlbnQsIG9uOiBib29sZWFuKSB7XG4gICAgICAgIGlmICggZXZlbnQubmFtZS5pbmNsdWRlcygnIycpICkge1xuICAgICAgICAgICAgbGV0IG5vaGFzaCA9IGV2ZW50Lm5hbWUucmVwbGFjZSgnIycsICcnKTtcbiAgICAgICAgICAgIHRoaXNbbm9oYXNoXVtldmVudC5uYW1lXS50b2dnbGVDbGFzcygnb24nLCBvbik7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzW2V2ZW50Lm5hbWVdLnRvZ2dsZUNsYXNzKCdvbicsIG9uKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIG5vdGVPZmZDYWxsYmFjayh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPZmZFdmVudCkge1xuICAgICAgICBUb25lLkRyYXcuc2NoZWR1bGUoKCkgPT4gdGhpcy5wYWludEtleShldmVudCwgZmFsc2UpLCB0aW1lKTtcbiAgICAgICAgdGhpcy5waWFuby5rZXlVcChldmVudC5uYW1lLCB0aW1lKTtcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBub3RlT25DYWxsYmFjayh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPbkV2ZW50KSB7XG4gICAgICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCB0cnVlKSwgdGltZSk7XG4gICAgICAgIHRoaXMucGlhbm8ua2V5RG93bihldmVudC5uYW1lLCB0aW1lLCBldmVudC52ZWxvY2l0eSk7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGluaXRQaWFubygpIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgaW5pdFBpYW5vKClgKTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnID0gR2xvYi5CaWdDb25maWcuZ2V0U3ViY29uZmlnKCk7XG4gICAgICAgIGNvbnN0IHBpYW5vT3B0aW9uczogUGFydGlhbDxQaWFub09wdGlvbnM+ID0ge1xuICAgICAgICAgICAgc2FtcGxlcyA6IFNBTEFNQU5ERVJfUEFUSF9BQlMsXG4gICAgICAgICAgICByZWxlYXNlIDogdHJ1ZSxcbiAgICAgICAgICAgIHBlZGFsIDogZmFsc2UsXG4gICAgICAgICAgICB2ZWxvY2l0aWVzIDogR2xvYi5CaWdDb25maWcudmVsb2NpdGllcyxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKCBHbG9iLkJpZ0NvbmZpZy5kZXYubXV0ZV9hbmltYXRpb24oKSApIHtcbiAgICAgICAgICAgIHBpYW5vT3B0aW9ucy52b2x1bWUgPSB7IHN0cmluZ3MgOiAtSW5maW5pdHksIGhhcm1vbmljcyA6IC1JbmZpbml0eSwga2V5YmVkIDogLUluZmluaXR5LCBwZWRhbCA6IC1JbmZpbml0eSB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5waWFubyA9IG5ldyBQaWFubyhwaWFub09wdGlvbnMpLnRvRGVzdGluYXRpb24oKTtcbiAgICAgICAgY29uc3QgcHJvbWlzZVBpYW5vTG9hZGVkID0gdGhpcy5waWFuby5sb2FkKCk7XG4gICAgICAgIGNvbnN0IHByb21pc2VNaWRpTG9hZGVkID0gTWlkaS5mcm9tVXJsKHN1YmNvbmZpZy50cnV0aC5taWRpLmFic1BhdGgpO1xuICAgICAgICBjb25zdCBbIF8sIG1pZGkgXSA9IGF3YWl0IFByb21pc2UuYWxsKFsgcHJvbWlzZVBpYW5vTG9hZGVkLCBwcm9taXNlTWlkaUxvYWRlZCBdKTtcbiAgICAgICAgLy8gY29uc3QgbWlkaSA9IGF3YWl0IE1pZGkuZnJvbVVybChzdWJjb25maWcudHJ1dGgubWlkaS5hYnNQYXRoKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3BpYW5vIGxvYWRlZCcpO1xuICAgICAgICBjb25zb2xlLmxvZygnbWlkaSBsb2FkZWQnLCBtaWRpKTtcbiAgICAgICAgdGhpcy5ub3RlcyA9IG1pZGkudHJhY2tzWzBdLm5vdGVzO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgIC8vIGNvbnN0IG5vdGVPZmZDYWxsYmFjayA9ICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPZmZFdmVudCkgPT4ge1xuICAgICAgICAvL1xuICAgICAgICAvLyAgICAgVG9uZS5EcmF3LnNjaGVkdWxlKCgpID0+IHRoaXMucGFpbnRLZXkoZXZlbnQsIGZhbHNlKSwgdGltZSk7XG4gICAgICAgIC8vICAgICBwaWFuby5rZXlVcChldmVudC5uYW1lLCB0aW1lKTtcbiAgICAgICAgLy8gfTtcbiAgICAgICAgXG4gICAgICAgIC8vIGNvbnN0IG5vdGVPbkNhbGxiYWNrID0gKHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBldmVudDogTm90ZU9uRXZlbnQpID0+IHtcbiAgICAgICAgLy8gICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCB0cnVlKSwgdGltZSk7XG4gICAgICAgIC8vICAgICBwaWFuby5rZXlEb3duKGV2ZW50Lm5hbWUsIHRpbWUsIGV2ZW50LnZlbG9jaXR5KTtcbiAgICAgICAgLy8gfTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbn1cblxuLy8gY29uc3Qga2V5Ym9hcmQgPSBuZXcgS2V5Ym9hcmQoKTtcbmV4cG9ydCBkZWZhdWx0IEtleWJvYXJkO1xuIl19