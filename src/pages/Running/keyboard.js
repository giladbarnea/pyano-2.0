"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util = require("../../util");
const Glob_1 = require("../../Glob");
const Piano_1 = require("../../Piano");
const midi_1 = require("@tonejs/midi");
const Tone = require("tone");
const util_1 = require("../../util");
const bhe_1 = require("../../bhe");
class Keyboard extends bhe_1.VisualBHE {
    constructor() {
        const keys = {
            A0: {
                '[data-note="A0"]': {
                    'A#0': '[data-note="A#0"]'
                }
            },
            B0: '[data-note="B0"]',
        };
        const indexToLetter = {
            1: "C",
            2: "D",
            3: "E",
            4: "F",
            5: "G",
            6: "A",
            7: "B"
        };
        const noblacks = [3, 7];
        for (let register of util.range(1, 7)) {
            for (let keyIndex of util.range(1, 7)) {
                let letter = indexToLetter[keyIndex];
                let name = `${letter}${register}`;
                let value;
                if (noblacks.includes(keyIndex)) {
                    value = `[data-note="${name}"]`;
                }
                else {
                    let query = `[data-note="${name}"]`;
                    let subname = `${letter}#${register}`;
                    let subquery = `[data-note="${subname}"]`;
                    let subvalue = {};
                    subvalue[subname] = subquery;
                    value = {};
                    value[query] = subvalue;
                }
                keys[name] = value;
            }
        }
        super({
            id: 'keyboard', children: keys
        });
    }
    async intro() {
        console.group(`Keyboard.intro()`);
        let noteOffObjs = [];
        let noteOnObjs = [];
        let notes;
        const maxAnimationNotes = Glob_1.default.BigConfig.dev.max_animation_notes();
        if (maxAnimationNotes) {
            notes = this.notes.slice(0, maxAnimationNotes);
        }
        else {
            notes = this.notes;
        }
        for (let note of notes) {
            let { name, velocity, duration, time: timeOn } = note;
            let timeOff = timeOn + duration;
            noteOffObjs.push({ name, time: timeOff });
            noteOnObjs.push({ name, time: timeOn, duration, velocity });
        }
        let count = 0;
        let done = false;
        const noteOffCallback = async (time, event) => {
            Tone.Draw.schedule(() => this.paintKey(event, false), time);
            this.piano.keyUp(event.name, time);
            count++;
            if (noteOffEvents.length === count) {
                const now = Tone.Transport.now();
                const util = require("../../util");
                const diff = now - time;
                await util.wait((diff * 1000), false);
                done = true;
                console.log('intro done', { event, time, now, diff, });
            }
        };
        const noteOnCallback = (time, event) => {
            Tone.Draw.schedule(() => this.paintKey(event, true), time);
            this.piano.keyDown(event.name, time, event.velocity);
        };
        const noteOffEvents = new Tone.Part(noteOffCallback, noteOffObjs).start();
        const noteOnEvents = new Tone.Part(noteOnCallback, noteOnObjs).start();
        console.log({ noteOffEvents });
        remote.globalShortcut.register("CommandOrControl+M", () => Tone.Transport.toggle());
        console.groupEnd();
        return await util_1.waitUntil(() => done, 5000, 300);
    }
    paintKey(event, on) {
        if (event.name.includes('#')) {
            let nohash = event.name.replace('#', '');
            this[nohash][event.name].toggleClass('on', on);
        }
        else {
            this[event.name].toggleClass('on', on);
        }
    }
    async initPiano(midiAbsPath) {
        console.group(`Keyboard.initPiano()`);
        const pianoOptions = {
            samples: SALAMANDER_PATH_ABS,
            release: true,
            pedal: false,
            velocities: Glob_1.default.BigConfig.velocities,
        };
        if (Glob_1.default.BigConfig.dev.mute_animation()) {
            pianoOptions.volume = { strings: -Infinity, harmonics: -Infinity, keybed: -Infinity, pedal: -Infinity };
        }
        this.piano = new Piano_1.Piano(pianoOptions).toDestination();
        const promisePianoLoaded = this.piano.load();
        const promiseMidiLoaded = midi_1.Midi.fromUrl(midiAbsPath);
        const [_, midi] = await Promise.all([promisePianoLoaded, promiseMidiLoaded]);
        console.log('piano loaded');
        console.log('midi loaded', midi);
        this.notes = midi.tracks[0].notes;
        Tone.Transport.start();
        console.groupEnd();
        return;
    }
}
exports.default = Keyboard;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia2V5Ym9hcmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJrZXlib2FyZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1DQUFrQztBQUNsQyxxQ0FBOEI7QUFDOUIsdUNBQWtEO0FBQ2xELHVDQUFvQztBQUNwQyw2QkFBNkI7QUFFN0IscUNBQXVDO0FBQ3ZDLG1DQUFzQztBQVF0QyxNQUFNLFFBQVMsU0FBUSxlQUFTO0lBSTVCO1FBRUksTUFBTSxJQUFJLEdBQUc7WUFDVCxFQUFFLEVBQUc7Z0JBQ0Qsa0JBQWtCLEVBQUc7b0JBQ2pCLEtBQUssRUFBRyxtQkFBbUI7aUJBQzlCO2FBQ0o7WUFDRCxFQUFFLEVBQUcsa0JBQWtCO1NBQzFCLENBQUM7UUFDRixNQUFNLGFBQWEsR0FBRztZQUNsQixDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztTQUNWLENBQUM7UUFDRixNQUFNLFFBQVEsR0FBRyxDQUFFLENBQUMsRUFBRSxDQUFDLENBQUUsQ0FBQztRQUMxQixLQUFNLElBQUksUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFHO1lBQ3JDLEtBQU0sSUFBSSxRQUFRLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUc7Z0JBQ3JDLElBQUksTUFBTSxHQUFHLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDckMsSUFBSSxJQUFJLEdBQUcsR0FBRyxNQUFNLEdBQUcsUUFBUSxFQUFFLENBQUM7Z0JBQ2xDLElBQUksS0FBSyxDQUFDO2dCQUNWLElBQUssUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRztvQkFDL0IsS0FBSyxHQUFHLGVBQWUsSUFB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QkFBaUIsQ0FBRSxDQUFDLENBQUM7UUFFakYsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1QixPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNqQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdkIsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25CLE9BQU87SUFjWCxDQUFDO0NBQ0o7QUFFRCxrQkFBZSxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi91dGlsXCJcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi9HbG9iXCI7XG5pbXBvcnQgeyBQaWFubywgUGlhbm9PcHRpb25zIH0gZnJvbSBcIi4uLy4uL1BpYW5vXCI7XG5pbXBvcnQgeyBNaWRpIH0gZnJvbSBcIkB0b25lanMvbWlkaVwiO1xuaW1wb3J0ICogYXMgVG9uZSBmcm9tIFwidG9uZVwiO1xuaW1wb3J0IHsgTm90ZSB9IGZyb20gXCJAdG9uZWpzL21pZGkvZGlzdC9Ob3RlXCI7XG5pbXBvcnQgeyB3YWl0VW50aWwgfSBmcm9tIFwiLi4vLi4vdXRpbFwiO1xuaW1wb3J0IHsgVmlzdWFsQkhFIH0gZnJvbSBcIi4uLy4uL2JoZVwiO1xuXG5cbnR5cGUgTm90ZU9mZkV2ZW50ID0geyBuYW1lOiBzdHJpbmcgfTtcbnR5cGUgTm90ZU9uRXZlbnQgPSBOb3RlT2ZmRXZlbnQgJiB7IHZlbG9jaXR5OiBudW1iZXIgfTtcbnR5cGUgTm90ZU9mZiA9IE5vdGVPZmZFdmVudCAmIHsgdGltZTogVG9uZS5Vbml0LlRpbWUgfTtcbnR5cGUgTm90ZU9uID0gTm90ZU9uRXZlbnQgJiB7IHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBkdXJhdGlvbjogbnVtYmVyIH07XG5cbmNsYXNzIEtleWJvYXJkIGV4dGVuZHMgVmlzdWFsQkhFIHtcbiAgICBwcml2YXRlIG5vdGVzOiBOb3RlW107XG4gICAgcHJpdmF0ZSBwaWFubzogUGlhbm87XG4gICAgXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBrZXlzID0ge1xuICAgICAgICAgICAgQTAgOiB7XG4gICAgICAgICAgICAgICAgJ1tkYXRhLW5vdGU9XCJBMFwiXScgOiB7XG4gICAgICAgICAgICAgICAgICAgICdBIzAnIDogJ1tkYXRhLW5vdGU9XCJBIzBcIl0nXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIEIwIDogJ1tkYXRhLW5vdGU9XCJCMFwiXScsXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IGluZGV4VG9MZXR0ZXIgPSB7XG4gICAgICAgICAgICAxIDogXCJDXCIsXG4gICAgICAgICAgICAyIDogXCJEXCIsXG4gICAgICAgICAgICAzIDogXCJFXCIsXG4gICAgICAgICAgICA0IDogXCJGXCIsXG4gICAgICAgICAgICA1IDogXCJHXCIsXG4gICAgICAgICAgICA2IDogXCJBXCIsXG4gICAgICAgICAgICA3IDogXCJCXCJcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3Qgbm9ibGFja3MgPSBbIDMsIDcgXTsgLy8gRSwgQlxuICAgICAgICBmb3IgKCBsZXQgcmVnaXN0ZXIgb2YgdXRpbC5yYW5nZSgxLCA3KSApIHtcbiAgICAgICAgICAgIGZvciAoIGxldCBrZXlJbmRleCBvZiB1dGlsLnJhbmdlKDEsIDcpICkge1xuICAgICAgICAgICAgICAgIGxldCBsZXR0ZXIgPSBpbmRleFRvTGV0dGVyW2tleUluZGV4XTtcbiAgICAgICAgICAgICAgICBsZXQgbmFtZSA9IGAke2xldHRlcn0ke3JlZ2lzdGVyfWA7XG4gICAgICAgICAgICAgICAgbGV0IHZhbHVlO1xuICAgICAgICAgICAgICAgIGlmICggbm9ibGFja3MuaW5jbHVkZXMoa2V5SW5kZXgpICkge1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGBbZGF0YS1ub3RlPVwiJHtuYW1lfVwiXWBcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsZXQgcXVlcnkgPSBgW2RhdGEtbm90ZT1cIiR7bmFtZX1cIl1gO1xuICAgICAgICAgICAgICAgICAgICBsZXQgc3VibmFtZSA9IGAke2xldHRlcn0jJHtyZWdpc3Rlcn1gO1xuICAgICAgICAgICAgICAgICAgICBsZXQgc3VicXVlcnkgPSBgW2RhdGEtbm90ZT1cIiR7c3VibmFtZX1cIl1gO1xuICAgICAgICAgICAgICAgICAgICBsZXQgc3VidmFsdWUgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgc3VidmFsdWVbc3VibmFtZV0gPSBzdWJxdWVyeTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVbcXVlcnldID0gc3VidmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGtleXNbbmFtZV0gPSB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBzdXBlcih7XG4gICAgICAgICAgICBpZCA6ICdrZXlib2FyZCcsIGNoaWxkcmVuIDoga2V5c1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gdGhpcy5pbml0UGlhbm8oKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBhc3luYyBpbnRybygpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc29sZS5ncm91cChgS2V5Ym9hcmQuaW50cm8oKWApO1xuICAgICAgICBsZXQgbm90ZU9mZk9ianM6IE5vdGVPZmZbXSA9IFtdO1xuICAgICAgICBsZXQgbm90ZU9uT2JqczogTm90ZU9uW10gPSBbXTtcbiAgICAgICAgbGV0IG5vdGVzOiBOb3RlW107XG4gICAgICAgIGNvbnN0IG1heEFuaW1hdGlvbk5vdGVzID0gR2xvYi5CaWdDb25maWcuZGV2Lm1heF9hbmltYXRpb25fbm90ZXMoKTtcbiAgICAgICAgaWYgKCBtYXhBbmltYXRpb25Ob3RlcyApIHtcbiAgICAgICAgICAgIG5vdGVzID0gdGhpcy5ub3Rlcy5zbGljZSgwLCBtYXhBbmltYXRpb25Ob3Rlcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBub3RlcyA9IHRoaXMubm90ZXM7XG4gICAgICAgIH1cbiAgICAgICAgZm9yICggbGV0IG5vdGUgb2Ygbm90ZXMgKSB7XG4gICAgICAgICAgICBsZXQgeyBuYW1lLCB2ZWxvY2l0eSwgZHVyYXRpb24sIHRpbWUgOiB0aW1lT24gfSA9IG5vdGU7XG4gICAgICAgICAgICBsZXQgdGltZU9mZiA9IHRpbWVPbiArIGR1cmF0aW9uO1xuICAgICAgICAgICAgbm90ZU9mZk9ianMucHVzaCh7IG5hbWUsIHRpbWUgOiB0aW1lT2ZmIH0pO1xuICAgICAgICAgICAgbm90ZU9uT2Jqcy5wdXNoKHsgbmFtZSwgdGltZSA6IHRpbWVPbiwgZHVyYXRpb24sIHZlbG9jaXR5IH0pO1xuICAgICAgICB9XG4gICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgIGxldCBkb25lID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IG5vdGVPZmZDYWxsYmFjayA9IGFzeW5jICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPZmZFdmVudCkgPT4ge1xuICAgICAgICAgICAgVG9uZS5EcmF3LnNjaGVkdWxlKCgpID0+IHRoaXMucGFpbnRLZXkoZXZlbnQsIGZhbHNlKSwgdGltZSk7XG4gICAgICAgICAgICB0aGlzLnBpYW5vLmtleVVwKGV2ZW50Lm5hbWUsIHRpbWUpO1xuICAgICAgICAgICAgY291bnQrKztcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCBub3RlT2ZmRXZlbnRzLmxlbmd0aCA9PT0gY291bnQgKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgbm93ID0gVG9uZS5UcmFuc3BvcnQubm93KCk7XG4gICAgICAgICAgICAgICAgY29uc3QgdXRpbCA9IHJlcXVpcmUoXCIuLi8uLi91dGlsXCIpO1xuICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICBjb25zdCBkaWZmID0gbm93IC0gdGltZTtcbiAgICAgICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoKGRpZmYgKiAxMDAwKSwgZmFsc2UpO1xuICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbnRybyBkb25lJywgeyBldmVudCwgdGltZSwgbm93LCBkaWZmLCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICBjb25zdCBub3RlT25DYWxsYmFjayA9ICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPbkV2ZW50KSA9PiB7XG4gICAgICAgICAgICBUb25lLkRyYXcuc2NoZWR1bGUoKCkgPT4gdGhpcy5wYWludEtleShldmVudCwgdHJ1ZSksIHRpbWUpO1xuICAgICAgICAgICAgdGhpcy5waWFuby5rZXlEb3duKGV2ZW50Lm5hbWUsIHRpbWUsIGV2ZW50LnZlbG9jaXR5KTtcbiAgICAgICAgfTtcbiAgICAgICAgLy8gY29uc3Qgbm93ID0gVG9uZS5UcmFuc3BvcnQubm93KCk7XG4gICAgICAgIGNvbnN0IG5vdGVPZmZFdmVudHMgPSBuZXcgVG9uZS5QYXJ0KG5vdGVPZmZDYWxsYmFjaywgbm90ZU9mZk9ianMpLnN0YXJ0KCk7XG4gICAgICAgIGNvbnN0IG5vdGVPbkV2ZW50cyA9IG5ldyBUb25lLlBhcnQobm90ZU9uQ2FsbGJhY2ssIG5vdGVPbk9ianMpLnN0YXJ0KCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2coeyBub3RlT2ZmRXZlbnRzIH0pO1xuICAgICAgICByZW1vdGUuZ2xvYmFsU2hvcnRjdXQucmVnaXN0ZXIoXCJDb21tYW5kT3JDb250cm9sK01cIiwgKCkgPT4gVG9uZS5UcmFuc3BvcnQudG9nZ2xlKCkpO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIHJldHVybiBhd2FpdCB3YWl0VW50aWwoKCkgPT4gZG9uZSwgNTAwMCwgMzAwKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIHBhaW50S2V5KGV2ZW50LCBvbjogYm9vbGVhbikge1xuICAgICAgICBpZiAoIGV2ZW50Lm5hbWUuaW5jbHVkZXMoJyMnKSApIHtcbiAgICAgICAgICAgIGxldCBub2hhc2ggPSBldmVudC5uYW1lLnJlcGxhY2UoJyMnLCAnJyk7XG4gICAgICAgICAgICB0aGlzW25vaGFzaF1bZXZlbnQubmFtZV0udG9nZ2xlQ2xhc3MoJ29uJywgb24pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpc1tldmVudC5uYW1lXS50b2dnbGVDbGFzcygnb24nLCBvbik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgaW5pdFBpYW5vKG1pZGlBYnNQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgS2V5Ym9hcmQuaW5pdFBpYW5vKClgKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHBpYW5vT3B0aW9uczogUGFydGlhbDxQaWFub09wdGlvbnM+ID0ge1xuICAgICAgICAgICAgc2FtcGxlcyA6IFNBTEFNQU5ERVJfUEFUSF9BQlMsXG4gICAgICAgICAgICByZWxlYXNlIDogdHJ1ZSxcbiAgICAgICAgICAgIHBlZGFsIDogZmFsc2UsXG4gICAgICAgICAgICB2ZWxvY2l0aWVzIDogR2xvYi5CaWdDb25maWcudmVsb2NpdGllcyxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKCBHbG9iLkJpZ0NvbmZpZy5kZXYubXV0ZV9hbmltYXRpb24oKSApIHtcbiAgICAgICAgICAgIHBpYW5vT3B0aW9ucy52b2x1bWUgPSB7IHN0cmluZ3MgOiAtSW5maW5pdHksIGhhcm1vbmljcyA6IC1JbmZpbml0eSwga2V5YmVkIDogLUluZmluaXR5LCBwZWRhbCA6IC1JbmZpbml0eSB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5waWFubyA9IG5ldyBQaWFubyhwaWFub09wdGlvbnMpLnRvRGVzdGluYXRpb24oKTtcbiAgICAgICAgY29uc3QgcHJvbWlzZVBpYW5vTG9hZGVkID0gdGhpcy5waWFuby5sb2FkKCk7XG4gICAgICAgIGNvbnN0IHByb21pc2VNaWRpTG9hZGVkID0gTWlkaS5mcm9tVXJsKG1pZGlBYnNQYXRoKTtcbiAgICAgICAgY29uc3QgWyBfLCBtaWRpIF0gPSBhd2FpdCBQcm9taXNlLmFsbChbIHByb21pc2VQaWFub0xvYWRlZCwgcHJvbWlzZU1pZGlMb2FkZWQgXSk7XG4gICAgICAgIC8vIGNvbnN0IG1pZGkgPSBhd2FpdCBNaWRpLmZyb21Vcmwoc3ViY29uZmlnLnRydXRoLm1pZGkuYWJzUGF0aCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdwaWFubyBsb2FkZWQnKTtcbiAgICAgICAgY29uc29sZS5sb2coJ21pZGkgbG9hZGVkJywgbWlkaSk7XG4gICAgICAgIHRoaXMubm90ZXMgPSBtaWRpLnRyYWNrc1swXS5ub3RlcztcbiAgICAgICAgVG9uZS5UcmFuc3BvcnQuc3RhcnQoKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgICAgICByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAvLyBjb25zdCBub3RlT2ZmQ2FsbGJhY2sgPSAodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlT2ZmRXZlbnQpID0+IHtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCBmYWxzZSksIHRpbWUpO1xuICAgICAgICAvLyAgICAgcGlhbm8ua2V5VXAoZXZlbnQubmFtZSwgdGltZSk7XG4gICAgICAgIC8vIH07XG4gICAgICAgIFxuICAgICAgICAvLyBjb25zdCBub3RlT25DYWxsYmFjayA9ICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPbkV2ZW50KSA9PiB7XG4gICAgICAgIC8vICAgICBUb25lLkRyYXcuc2NoZWR1bGUoKCkgPT4gdGhpcy5wYWludEtleShldmVudCwgdHJ1ZSksIHRpbWUpO1xuICAgICAgICAvLyAgICAgcGlhbm8ua2V5RG93bihldmVudC5uYW1lLCB0aW1lLCBldmVudC52ZWxvY2l0eSk7XG4gICAgICAgIC8vIH07XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEtleWJvYXJkO1xuIl19