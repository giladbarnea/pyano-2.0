"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Glob_1 = require("../../Glob");
const util = require("../../util");
const bhe_1 = require("../../bhe");
const keyboard_1 = require("./keyboard");
const dialog_1 = require("./dialog");
const Piano_1 = require("../../Piano");
const midi_1 = require("@tonejs/midi");
const Tone = require("tone");
async function load(reload) {
    console.group(`pages.Running.index.load(${reload})`);
    Glob_1.default.BigConfig.last_page = "running";
    if (reload) {
        console.groupEnd();
        return util.reloadPage();
    }
    Tone.context.latencyHint = "playback";
    Glob_1.default.Sidebar.remove();
    const subconfig = Glob_1.default.BigConfig.getSubconfig();
    const pianoOptions = {
        samples: SALAMANDER_PATH_ABS,
        release: true,
        pedal: false,
        velocities: Glob_1.default.BigConfig.velocities,
    };
    if (Glob_1.default.BigConfig.dev.mute_animation()) {
        pianoOptions.volume = { strings: -Infinity, harmonics: -Infinity, keybed: -Infinity, pedal: -Infinity };
    }
    const piano = new Piano_1.Piano(pianoOptions).toDestination();
    await piano.load();
    console.log('piano loaded');
    const midi = await midi_1.Midi.fromUrl(subconfig.truth.midi.absPath);
    console.log('midi loaded');
    function noteOffCallback(time, event) {
        Tone.Draw.schedule(function () {
            console.log(event.name);
            if (event.name.includes('#')) {
                let nohash = event.name.replace('#', '');
                keyboard_1.default[nohash][event.name].removeClass('on');
            }
            else {
                keyboard_1.default[event.name].removeClass('on');
            }
        }, time);
        piano.keyUp(event.name, time);
    }
    function noteOnCallback(time, event) {
        Tone.Draw.schedule(function () {
            console.log(event.name);
            if (event.name.includes('#')) {
                let nohash = event.name.replace('#', '');
                keyboard_1.default[nohash][event.name].addClass('on');
            }
            else {
                keyboard_1.default[event.name].addClass('on');
            }
        }, time);
        piano.keyDown(event.name, time, event.velocity);
    }
    let noteOffObjs = [];
    let noteOnObjs = [];
    let notes;
    const maxAnimationNotes = Glob_1.default.BigConfig.dev.max_animation_notes();
    if (maxAnimationNotes) {
        notes = midi.tracks[0].notes.slice(0, maxAnimationNotes);
    }
    else {
        notes = midi.tracks[0].notes;
    }
    for (let note of notes) {
        let { name, velocity, duration, time: timeOn } = note;
        let timeOff = timeOn + duration;
        noteOffObjs.push({ name, time: timeOff });
        noteOnObjs.push({ name, time: timeOn, duration, velocity });
    }
    const now = Tone.Transport.now();
    const noteOffEvents = new Tone.Part(noteOffCallback, noteOffObjs).start(now);
    const noteOnEvents = new Tone.Part(noteOnCallback, noteOnObjs).start(now);
    Tone.Transport.start(now);
    remote.globalShortcut.register("CommandOrControl+M", () => Tone.Transport.toggle());
    console.log({ subconfig, midi, piano, "Tone.Context.getDefaults()": Tone.Context.getDefaults(), });
    Glob_1.default.Title.html(`${subconfig.truth.name}`);
    const subtitle = bhe_1.elem({ tag: 'h3', text: '1/1' });
    const dialog = new dialog_1.default(subconfig.demo_type);
    keyboard_1.default.class('active').before(subtitle, dialog);
    console.groupEnd();
}
exports.load = load;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUE4QjtBQUM5QixtQ0FBbUM7QUFDbkMsbUNBQWlDO0FBQ2pDLHlDQUFpQztBQUNqQyxxQ0FBNkI7QUFFN0IsdUNBQWlEO0FBQ2pELHVDQUFvQztBQUNwQyw2QkFBNkI7QUFPN0IsS0FBSyxVQUFVLElBQUksQ0FBQyxNQUFlO0lBRS9CLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFFckQsY0FBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQ3JDLElBQUssTUFBTSxFQUFHO1FBQ1YsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0tBQzVCO0lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDO0lBQ3RDLGNBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDdEIsTUFBTSxTQUFTLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNoRCxNQUFNLFlBQVksR0FBMEI7UUFDeEMsT0FBTyxFQUFHLG1CQUFtQjtRQUM3QixPQUFPLEVBQUcsSUFBSTtRQUNkLEtBQUssRUFBRyxLQUFLO1FBQ2IsVUFBVSxFQUFHLGNBQUksQ0FBQyxTQUFTLENBQUMsVUFBVTtLQUN6QyxDQUFDO0lBQ0YsSUFBSyxjQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsRUFBRztRQUN2QyxZQUFZLENBQUMsTUFBTSxHQUFHLEVBQUUsT0FBTyxFQUFHLENBQUMsUUFBUSxFQUFFLFNBQVMsRUFBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFHLENBQUMsUUFBUSxFQUFFLENBQUE7S0FDOUc7SUFD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QztJQUNwRCxNQUFNLE1BQU0sR0FBRyxJQUFJLGdCQUFNLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQy9DLGtCQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FDM0IsUUFBUSxFQUNSLE1BQU0sQ0FDVCxDQUFDO0lBSUYsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBRXZCLENBQUM7QUFFUSxvQkFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi9HbG9iXCI7XG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi91dGlsXCI7XG5pbXBvcnQgeyBlbGVtIH0gZnJvbSBcIi4uLy4uL2JoZVwiO1xuaW1wb3J0IGtleWJvYXJkIGZyb20gJy4va2V5Ym9hcmQnXG5pbXBvcnQgRGlhbG9nIGZyb20gJy4vZGlhbG9nJ1xuLy8gaW1wb3J0IHsgUGlhbm8gfSBmcm9tIFwiLi4vLi4vUGlhbm9cIlxuaW1wb3J0IHsgUGlhbm8sIFBpYW5vT3B0aW9ucyB9IGZyb20gXCIuLi8uLi9QaWFub1wiXG5pbXBvcnQgeyBNaWRpIH0gZnJvbSBcIkB0b25lanMvbWlkaVwiO1xuaW1wb3J0ICogYXMgVG9uZSBmcm9tIFwidG9uZVwiO1xuXG4vLyBjb25zdCB7IFBpYW5vIH0gPSByZXF1aXJlKFwiQHRvbmVqcy9waWFub1wiKTtcblxuXG4vKippbXBvcnQgKiBhcyBydW5uaW5nUGFnZSBmcm9tIFwiLi4vUnVubmluZ1wiXG4gKiByZXF1aXJlKCcuL1J1bm5pbmcnKSovXG5hc3luYyBmdW5jdGlvbiBsb2FkKHJlbG9hZDogYm9vbGVhbikge1xuICAgIC8vICoqICBQZXJmb3JtYW5jZSwgdmlzdWFscyBzeW5jOiBodHRwczovL2dpdGh1Yi5jb20vVG9uZWpzL1RvbmUuanMvd2lraS9QZXJmb3JtYW5jZVxuICAgIGNvbnNvbGUuZ3JvdXAoYHBhZ2VzLlJ1bm5pbmcuaW5kZXgubG9hZCgke3JlbG9hZH0pYCk7XG4gICAgXG4gICAgR2xvYi5CaWdDb25maWcubGFzdF9wYWdlID0gXCJydW5uaW5nXCI7XG4gICAgaWYgKCByZWxvYWQgKSB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgcmV0dXJuIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgIH1cbiAgICBUb25lLmNvbnRleHQubGF0ZW5jeUhpbnQgPSBcInBsYXliYWNrXCI7XG4gICAgR2xvYi5TaWRlYmFyLnJlbW92ZSgpO1xuICAgIGNvbnN0IHN1YmNvbmZpZyA9IEdsb2IuQmlnQ29uZmlnLmdldFN1YmNvbmZpZygpO1xuICAgIGNvbnN0IHBpYW5vT3B0aW9uczogUGFydGlhbDxQaWFub09wdGlvbnM+ID0ge1xuICAgICAgICBzYW1wbGVzIDogU0FMQU1BTkRFUl9QQVRIX0FCUyxcbiAgICAgICAgcmVsZWFzZSA6IHRydWUsXG4gICAgICAgIHBlZGFsIDogZmFsc2UsXG4gICAgICAgIHZlbG9jaXRpZXMgOiBHbG9iLkJpZ0NvbmZpZy52ZWxvY2l0aWVzLFxuICAgIH07XG4gICAgaWYgKCBHbG9iLkJpZ0NvbmZpZy5kZXYubXV0ZV9hbmltYXRpb24oKSApIHtcbiAgICAgICAgcGlhbm9PcHRpb25zLnZvbHVtZSA9IHsgc3RyaW5ncyA6IC1JbmZpbml0eSwgaGFybW9uaWNzIDogLUluZmluaXR5LCBrZXliZWQgOiAtSW5maW5pdHksIHBlZGFsIDogLUluZmluaXR5IH1cbiAgICB9XG4gICAgY29uc3QgcGlhbm8gPSBuZXcgUGlhbm8ocGlhbm9PcHRpb25zKS50b0Rlc3RpbmF0aW9uKCk7XG4gICAgYXdhaXQgcGlhbm8ubG9hZCgpO1xuICAgIGNvbnNvbGUubG9nKCdwaWFubyBsb2FkZWQnKTtcbiAgICBjb25zdCBtaWRpID0gYXdhaXQgTWlkaS5mcm9tVXJsKHN1YmNvbmZpZy50cnV0aC5taWRpLmFic1BhdGgpO1xuICAgIGNvbnNvbGUubG9nKCdtaWRpIGxvYWRlZCcpO1xuICAgIFxuICAgIFxuICAgIHR5cGUgTm90ZU9mZkV2ZW50ID0geyBuYW1lOiBzdHJpbmcgfTtcbiAgICB0eXBlIE5vdGVPbkV2ZW50ID0gTm90ZU9mZkV2ZW50ICYgeyB2ZWxvY2l0eTogbnVtYmVyIH07XG4gICAgdHlwZSBOb3RlT2ZmID0gTm90ZU9mZkV2ZW50ICYgeyB0aW1lOiBUb25lLlVuaXQuVGltZSB9O1xuICAgIHR5cGUgTm90ZU9uID0gTm90ZU9uRXZlbnQgJiB7IHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBkdXJhdGlvbjogbnVtYmVyIH07XG4gICAgXG4gICAgZnVuY3Rpb24gbm90ZU9mZkNhbGxiYWNrKHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBldmVudDogTm90ZU9mZkV2ZW50KSB7XG4gICAgICAgIFRvbmUuRHJhdy5zY2hlZHVsZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhldmVudC5uYW1lKTtcbiAgICAgICAgICAgIGlmICggZXZlbnQubmFtZS5pbmNsdWRlcygnIycpICkge1xuICAgICAgICAgICAgICAgIGxldCBub2hhc2ggPSBldmVudC5uYW1lLnJlcGxhY2UoJyMnLCAnJyk7XG4gICAgICAgICAgICAgICAga2V5Ym9hcmRbbm9oYXNoXVtldmVudC5uYW1lXS5yZW1vdmVDbGFzcygnb24nKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAga2V5Ym9hcmRbZXZlbnQubmFtZV0ucmVtb3ZlQ2xhc3MoJ29uJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIHRpbWUpO1xuICAgICAgICBwaWFuby5rZXlVcChldmVudC5uYW1lLCB0aW1lKTtcbiAgICB9XG4gICAgXG4gICAgZnVuY3Rpb24gbm90ZU9uQ2FsbGJhY2sodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlT25FdmVudCkge1xuICAgICAgICBUb25lLkRyYXcuc2NoZWR1bGUoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZXZlbnQubmFtZSk7XG4gICAgICAgICAgICBpZiAoIGV2ZW50Lm5hbWUuaW5jbHVkZXMoJyMnKSApIHtcbiAgICAgICAgICAgICAgICBsZXQgbm9oYXNoID0gZXZlbnQubmFtZS5yZXBsYWNlKCcjJywgJycpO1xuICAgICAgICAgICAgICAgIGtleWJvYXJkW25vaGFzaF1bZXZlbnQubmFtZV0uYWRkQ2xhc3MoJ29uJyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGtleWJvYXJkW2V2ZW50Lm5hbWVdLmFkZENsYXNzKCdvbicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCB0aW1lKTtcbiAgICAgICAgcGlhbm8ua2V5RG93bihldmVudC5uYW1lLCB0aW1lLCBldmVudC52ZWxvY2l0eSk7XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGxldCBub3RlT2ZmT2JqczogTm90ZU9mZltdID0gW107XG4gICAgbGV0IG5vdGVPbk9ianM6IE5vdGVPbltdID0gW107XG4gICAgbGV0IG5vdGVzO1xuICAgIGNvbnN0IG1heEFuaW1hdGlvbk5vdGVzID0gR2xvYi5CaWdDb25maWcuZGV2Lm1heF9hbmltYXRpb25fbm90ZXMoKTtcbiAgICBpZiAoIG1heEFuaW1hdGlvbk5vdGVzICkge1xuICAgICAgICBub3RlcyA9IG1pZGkudHJhY2tzWzBdLm5vdGVzLnNsaWNlKDAsIG1heEFuaW1hdGlvbk5vdGVzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBub3RlcyA9IG1pZGkudHJhY2tzWzBdLm5vdGVzO1xuICAgIH1cbiAgICBmb3IgKCBsZXQgbm90ZSBvZiBub3RlcyApIHtcbiAgICAgICAgbGV0IHsgbmFtZSwgdmVsb2NpdHksIGR1cmF0aW9uLCB0aW1lIDogdGltZU9uIH0gPSBub3RlO1xuICAgICAgICBsZXQgdGltZU9mZiA9IHRpbWVPbiArIGR1cmF0aW9uO1xuICAgICAgICBub3RlT2ZmT2Jqcy5wdXNoKHsgbmFtZSwgdGltZSA6IHRpbWVPZmYgfSk7XG4gICAgICAgIG5vdGVPbk9ianMucHVzaCh7IG5hbWUsIHRpbWUgOiB0aW1lT24sIGR1cmF0aW9uLCB2ZWxvY2l0eSB9KTtcbiAgICB9XG4gICAgY29uc3Qgbm93ID0gVG9uZS5UcmFuc3BvcnQubm93KCk7XG4gICAgY29uc3Qgbm90ZU9mZkV2ZW50cyA9IG5ldyBUb25lLlBhcnQobm90ZU9mZkNhbGxiYWNrLCBub3RlT2ZmT2Jqcykuc3RhcnQobm93KTtcbiAgICBjb25zdCBub3RlT25FdmVudHMgPSBuZXcgVG9uZS5QYXJ0KG5vdGVPbkNhbGxiYWNrLCBub3RlT25PYmpzKS5zdGFydChub3cpO1xuICAgIFRvbmUuVHJhbnNwb3J0LnN0YXJ0KG5vdyk7XG4gICAgXG4gICAgcmVtb3RlLmdsb2JhbFNob3J0Y3V0LnJlZ2lzdGVyKFwiQ29tbWFuZE9yQ29udHJvbCtNXCIsICgpID0+IFRvbmUuVHJhbnNwb3J0LnRvZ2dsZSgpKTtcbiAgICBcbiAgICBjb25zb2xlLmxvZyh7IHN1YmNvbmZpZywgbWlkaSwgcGlhbm8sIFwiVG9uZS5Db250ZXh0LmdldERlZmF1bHRzKClcIiA6IFRvbmUuQ29udGV4dC5nZXREZWZhdWx0cygpLCB9KTtcbiAgICBHbG9iLlRpdGxlLmh0bWwoYCR7c3ViY29uZmlnLnRydXRoLm5hbWV9YCk7XG4gICAgXG4gICAgY29uc3Qgc3VidGl0bGUgPSBlbGVtKHsgdGFnIDogJ2gzJywgdGV4dCA6ICcxLzEnIH0pO1xuICAgIGNvbnN0IGRpYWxvZyA9IG5ldyBEaWFsb2coc3ViY29uZmlnLmRlbW9fdHlwZSk7XG4gICAga2V5Ym9hcmQuY2xhc3MoJ2FjdGl2ZScpLmJlZm9yZShcbiAgICAgICAgc3VidGl0bGUsXG4gICAgICAgIGRpYWxvZ1xuICAgICk7XG4gICAgLy8gR2xvYi5NYWluQ29udGVudC5hcHBlbmQoXG4gICAgLy9cbiAgICAvLyApO1xuICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICBcbn1cblxuZXhwb3J0IHsgbG9hZCB9XG4iXX0=