"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Glob_1 = require("../../Glob");
const util = require("../../util");
const bhe_1 = require("../../bhe");
const keyboard_1 = require("./keyboard");
const dialog_1 = require("./dialog");
const Piano_1 = require("../../Piano");
const midi_1 = require("@tonejs/midi");
const Tone = require("tone");
async function load(reload) {
    console.group(`pages.Running.index.load(${reload})`);
    Glob_1.default.BigConfig.last_page = "running";
    if (reload) {
        console.groupEnd();
        return util.reloadPage();
    }
    Tone.context.latencyHint = "playback";
    Glob_1.default.Sidebar.remove();
    const subconfig = Glob_1.default.BigConfig.getSubconfig();
    const pianoOptions = {
        samples: SALAMANDER_PATH_ABS,
        release: true,
        pedal: false,
        velocities: 1,
    };
    if (Glob_1.default.BigConfig.dev.mute_animation()) {
        pianoOptions.volume = { strings: -Infinity, harmonics: -Infinity, keybed: -Infinity, pedal: -Infinity };
    }
    const piano = new Piano_1.Piano(pianoOptions).toDestination();
    await piano.load();
    console.log('piano loaded');
    const midi = await midi_1.Midi.fromUrl(subconfig.truth.midi.absPath);
    console.log('midi loaded');
    function noteOffCallback(time, event) {
        piano.keyUp(event.name, time);
    }
    function noteOnCallback(time, event) {
        Tone.Draw.schedule(function () {
        }, time);
        piano.keyDown(event.name, time, event.velocity);
    }
    let noteOffObjs = [];
    let noteOnObjs = [];
    let notes;
    const maxAnimationNotes = Glob_1.default.BigConfig.dev.max_animation_notes();
    if (maxAnimationNotes) {
        notes = midi.tracks[0].notes.slice(0, maxAnimationNotes);
    }
    else {
        notes = midi.tracks[0].notes;
    }
    for (let note of notes) {
        let { name, velocity, duration, time: timeOn } = note;
        let timeOff = timeOn + duration;
        noteOffObjs.push({ name, time: timeOff });
        noteOnObjs.push({ name, time: timeOn, duration, velocity });
    }
    const now = Tone.Transport.now();
    const noteOffEvents = new Tone.Part(noteOffCallback, noteOffObjs).start(now);
    await util.wait(500);
    const noteOnEvents = new Tone.Part(noteOnCallback, noteOnObjs).start(now);
    Tone.Transport.start(now);
    remote.globalShortcut.register("CommandOrControl+M", () => Tone.Transport.toggle());
    console.log({ subconfig, midi, piano, "Tone.Context.getDefaults()": Tone.Context.getDefaults(), });
    Glob_1.default.Title.html(`${subconfig.truth.name}`);
    const subtitle = bhe_1.elem({ tag: 'h3', text: '1/1' });
    const dialog = new dialog_1.default(subconfig.demo_type);
    keyboard_1.default.class('active').before(subtitle, dialog);
    console.groupEnd();
}
exports.load = load;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQUE4QjtBQUM5QixtQ0FBbUM7QUFDbkMsbUNBQWlDO0FBQ2pDLHlDQUFpQztBQUNqQyxxQ0FBNkI7QUFFN0IsdUNBQWlEO0FBQ2pELHVDQUFvQztBQUNwQyw2QkFBNkI7QUFPN0IsS0FBSyxVQUFVLElBQUksQ0FBQyxNQUFlO0lBRS9CLE9BQU8sQ0FBQyxLQUFLLENBQUMsNEJBQTRCLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFFckQsY0FBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO0lBQ3JDLElBQUssTUFBTSxFQUFHO1FBQ1YsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25CLE9BQU8sSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0tBQzVCO0lBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDO0lBQ3RDLGNBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDdEIsTUFBTSxTQUFTLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUNoRCxNQUFNLFlBQVksR0FBMEI7UUFDeEMsT0FBTyxFQUFHLG1CQUFtQjtRQUM3QixPQUFPLEVBQUcsSUFBSTtRQUNkLEtBQUssRUFBRyxLQUFLO1FBQ2IsVUFBVSxFQUFHLENBQUM7S0FDakIsQ0FBQztJQUNGLElBQUssY0FBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLEVBQUc7UUFDdkMsWUFBWSxDQUFDLE1BQU0sR0FBRyxFQUFFLE9BQU8sRUFBRyxDQUFDLFFBQVEsRUFBRSxTQUFTLEVBQUcsQ0FBQyxRQUFRLEVBQUUsTUFBTSxFQUFHLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRyxDQUFDLFFBQVEsRUFBRSxDQUFBO0tBQzlHO0lBQ0QsTUFBTSxLQUFLLEdBQUcsSUFB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LGNBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBRTNDLE1BQU0sUUFBUSxHQUFHLFVBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxJQUFJLEVBQUUsSUFBSSxFQUFHLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDcEQsTUFBTSxNQUFNLEdBQUcsSUFBSSxnQkFBTSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMvQyxrQkFBUSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQzNCLFFBQVEsRUFDUixNQUFNLENBQ1QsQ0FBQztJQUlGLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUV2QixDQUFDO0FBRVEsb0JBQUkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgR2xvYiBmcm9tIFwiLi4vLi4vR2xvYlwiO1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tIFwiLi4vLi4vdXRpbFwiO1xuaW1wb3J0IHsgZWxlbSB9IGZyb20gXCIuLi8uLi9iaGVcIjtcbmltcG9ydCBrZXlib2FyZCBmcm9tICcuL2tleWJvYXJkJ1xuaW1wb3J0IERpYWxvZyBmcm9tICcuL2RpYWxvZydcbi8vIGltcG9ydCB7IFBpYW5vIH0gZnJvbSBcIi4uLy4uL1BpYW5vXCJcbmltcG9ydCB7IFBpYW5vLCBQaWFub09wdGlvbnMgfSBmcm9tIFwiLi4vLi4vUGlhbm9cIlxuaW1wb3J0IHsgTWlkaSB9IGZyb20gXCJAdG9uZWpzL21pZGlcIjtcbmltcG9ydCAqIGFzIFRvbmUgZnJvbSBcInRvbmVcIjtcblxuLy8gY29uc3QgeyBQaWFubyB9ID0gcmVxdWlyZShcIkB0b25lanMvcGlhbm9cIik7XG5cblxuLyoqaW1wb3J0ICogYXMgcnVubmluZ1BhZ2UgZnJvbSBcIi4uL1J1bm5pbmdcIlxuICogcmVxdWlyZSgnLi9SdW5uaW5nJykqL1xuYXN5bmMgZnVuY3Rpb24gbG9hZChyZWxvYWQ6IGJvb2xlYW4pIHtcbiAgICAvLyAqKiAgUGVyZm9ybWFuY2UsIHZpc3VhbHMgc3luYzogaHR0cHM6Ly9naXRodWIuY29tL1RvbmVqcy9Ub25lLmpzL3dpa2kvUGVyZm9ybWFuY2VcbiAgICBjb25zb2xlLmdyb3VwKGBwYWdlcy5SdW5uaW5nLmluZGV4LmxvYWQoJHtyZWxvYWR9KWApO1xuICAgIFxuICAgIEdsb2IuQmlnQ29uZmlnLmxhc3RfcGFnZSA9IFwicnVubmluZ1wiO1xuICAgIGlmICggcmVsb2FkICkge1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIHJldHVybiB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICB9XG4gICAgVG9uZS5jb250ZXh0LmxhdGVuY3lIaW50ID0gXCJwbGF5YmFja1wiO1xuICAgIEdsb2IuU2lkZWJhci5yZW1vdmUoKTtcbiAgICBjb25zdCBzdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZy5nZXRTdWJjb25maWcoKTtcbiAgICBjb25zdCBwaWFub09wdGlvbnM6IFBhcnRpYWw8UGlhbm9PcHRpb25zPiA9IHtcbiAgICAgICAgc2FtcGxlcyA6IFNBTEFNQU5ERVJfUEFUSF9BQlMsXG4gICAgICAgIHJlbGVhc2UgOiB0cnVlLFxuICAgICAgICBwZWRhbCA6IGZhbHNlLFxuICAgICAgICB2ZWxvY2l0aWVzIDogMSxcbiAgICB9O1xuICAgIGlmICggR2xvYi5CaWdDb25maWcuZGV2Lm11dGVfYW5pbWF0aW9uKCkgKSB7XG4gICAgICAgIHBpYW5vT3B0aW9ucy52b2x1bWUgPSB7IHN0cmluZ3MgOiAtSW5maW5pdHksIGhhcm1vbmljcyA6IC1JbmZpbml0eSwga2V5YmVkIDogLUluZmluaXR5LCBwZWRhbCA6IC1JbmZpbml0eSB9XG4gICAgfVxuICAgIGNvbnN0IHBpYW5vID0gbmV3IFBpYW5vKHBpYW5vT3B0aW9ucykudG9EZXN0aW5hdGlvbigpO1xuICAgIGF3YWl0IHBpYW5vLmxvYWQoKTtcbiAgICBjb25zb2xlLmxvZygncGlhbm8gbG9hZGVkJyk7XG4gICAgY29uc3QgbWlkaSA9IGF3YWl0IE1pZGkuZnJvbVVybChzdWJjb25maWcudHJ1dGgubWlkaS5hYnNQYXRoKTtcbiAgICBjb25zb2xlLmxvZygnbWlkaSBsb2FkZWQnKTtcbiAgICBcbiAgICBcbiAgICB0eXBlIE5vdGVPZmZFdmVudCA9IHsgbmFtZTogc3RyaW5nIHwgbnVtYmVyIH07XG4gICAgdHlwZSBOb3RlT25FdmVudCA9IE5vdGVPZmZFdmVudCAmIHsgdmVsb2NpdHk6IG51bWJlciB9O1xuICAgIHR5cGUgTm90ZU9mZiA9IE5vdGVPZmZFdmVudCAmIHsgdGltZTogVG9uZS5Vbml0LlRpbWUgfTtcbiAgICB0eXBlIE5vdGVPbiA9IE5vdGVPbkV2ZW50ICYgeyB0aW1lOiBUb25lLlVuaXQuVGltZSwgZHVyYXRpb246IG51bWJlciB9O1xuICAgIFxuICAgIGZ1bmN0aW9uIG5vdGVPZmZDYWxsYmFjayh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPZmZFdmVudCkge1xuICAgICAgICBwaWFuby5rZXlVcChldmVudC5uYW1lLCB0aW1lKTtcbiAgICB9XG4gICAgXG4gICAgZnVuY3Rpb24gbm90ZU9uQ2FsbGJhY2sodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlT25FdmVudCkge1xuICAgICAgICBUb25lLkRyYXcuc2NoZWR1bGUoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ0RyYXdpbmchJyk7XG4gICAgICAgIH0sIHRpbWUpO1xuICAgICAgICBwaWFuby5rZXlEb3duKGV2ZW50Lm5hbWUsIHRpbWUsIGV2ZW50LnZlbG9jaXR5KTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgbGV0IG5vdGVPZmZPYmpzOiBOb3RlT2ZmW10gPSBbXTtcbiAgICBsZXQgbm90ZU9uT2JqczogTm90ZU9uW10gPSBbXTtcbiAgICBsZXQgbm90ZXM7XG4gICAgY29uc3QgbWF4QW5pbWF0aW9uTm90ZXMgPSBHbG9iLkJpZ0NvbmZpZy5kZXYubWF4X2FuaW1hdGlvbl9ub3RlcygpO1xuICAgIGlmICggbWF4QW5pbWF0aW9uTm90ZXMgKSB7XG4gICAgICAgIG5vdGVzID0gbWlkaS50cmFja3NbMF0ubm90ZXMuc2xpY2UoMCwgbWF4QW5pbWF0aW9uTm90ZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIG5vdGVzID0gbWlkaS50cmFja3NbMF0ubm90ZXM7XG4gICAgfVxuICAgIGZvciAoIGxldCBub3RlIG9mIG5vdGVzICkge1xuICAgICAgICBsZXQgeyBuYW1lLCB2ZWxvY2l0eSwgZHVyYXRpb24sIHRpbWUgOiB0aW1lT24gfSA9IG5vdGU7XG4gICAgICAgIGxldCB0aW1lT2ZmID0gdGltZU9uICsgZHVyYXRpb247XG4gICAgICAgIG5vdGVPZmZPYmpzLnB1c2goeyBuYW1lLCB0aW1lIDogdGltZU9mZiB9KTtcbiAgICAgICAgbm90ZU9uT2Jqcy5wdXNoKHsgbmFtZSwgdGltZSA6IHRpbWVPbiwgZHVyYXRpb24sIHZlbG9jaXR5IH0pO1xuICAgIH1cbiAgICBjb25zdCBub3cgPSBUb25lLlRyYW5zcG9ydC5ub3coKTtcbiAgICBjb25zdCBub3RlT2ZmRXZlbnRzID0gbmV3IFRvbmUuUGFydChub3RlT2ZmQ2FsbGJhY2ssIG5vdGVPZmZPYmpzKS5zdGFydChub3cpO1xuICAgIGF3YWl0IHV0aWwud2FpdCg1MDApO1xuICAgIGNvbnN0IG5vdGVPbkV2ZW50cyA9IG5ldyBUb25lLlBhcnQobm90ZU9uQ2FsbGJhY2ssIG5vdGVPbk9ianMpLnN0YXJ0KG5vdyk7XG4gICAgVG9uZS5UcmFuc3BvcnQuc3RhcnQobm93KTtcbiAgICBcbiAgICByZW1vdGUuZ2xvYmFsU2hvcnRjdXQucmVnaXN0ZXIoXCJDb21tYW5kT3JDb250cm9sK01cIiwgKCkgPT4gVG9uZS5UcmFuc3BvcnQudG9nZ2xlKCkpO1xuICAgIFxuICAgIGNvbnNvbGUubG9nKHsgc3ViY29uZmlnLCBtaWRpLCBwaWFubywgXCJUb25lLkNvbnRleHQuZ2V0RGVmYXVsdHMoKVwiIDogVG9uZS5Db250ZXh0LmdldERlZmF1bHRzKCksIH0pO1xuICAgIEdsb2IuVGl0bGUuaHRtbChgJHtzdWJjb25maWcudHJ1dGgubmFtZX1gKTtcbiAgICBcbiAgICBjb25zdCBzdWJ0aXRsZSA9IGVsZW0oeyB0YWcgOiAnaDMnLCB0ZXh0IDogJzEvMScgfSk7XG4gICAgY29uc3QgZGlhbG9nID0gbmV3IERpYWxvZyhzdWJjb25maWcuZGVtb190eXBlKTtcbiAgICBrZXlib2FyZC5jbGFzcygnYWN0aXZlJykuYmVmb3JlKFxuICAgICAgICBzdWJ0aXRsZSxcbiAgICAgICAgZGlhbG9nXG4gICAgKTtcbiAgICAvLyBHbG9iLk1haW5Db250ZW50LmFwcGVuZChcbiAgICAvL1xuICAgIC8vICk7XG4gICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgIFxufVxuXG5leHBvcnQgeyBsb2FkIH1cbiJdfQ==