"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util = require("../../util");
const Glob_1 = require("../../Glob");
const Piano_1 = require("../../Piano");
const midi_1 = require("@tonejs/midi");
const Tone = require("tone");
const bhe_1 = require("../../bhe");
class Animation extends bhe_1.VisualBHE {
    constructor() {
        const keys = {
            A0: {
                '[data-note="A0"]': {
                    'A#0': '[data-note="A#0"]'
                }
            },
            B0: '[data-note="B0"]',
        };
        const indexToLetter = {
            1: "C",
            2: "D",
            3: "E",
            4: "F",
            5: "G",
            6: "A",
            7: "B"
        };
        const noblacks = [3, 7];
        for (let register of util.range(1, 7)) {
            for (let keyIndex of util.range(1, 7)) {
                let letter = indexToLetter[keyIndex];
                let name = `${letter}${register}`;
                let value;
                if (noblacks.includes(keyIndex)) {
                    value = `[data-note="${name}"]`;
                }
                else {
                    let query = `[data-note="${name}"]`;
                    let subname = `${letter}#${register}`;
                    let subquery = `[data-note="${subname}"]`;
                    let subvalue = {};
                    subvalue[subname] = subquery;
                    value = {};
                    value[query] = subvalue;
                }
                keys[name] = value;
            }
        }
        super({
            id: 'animation', children: keys
        });
    }
    async intro() {
        console.group(`Keyboard.intro()`);
        let noteOffObjs = [];
        let noteOnObjs = [];
        let notes;
        const maxAnimationNotes = Glob_1.default.BigConfig.dev.max_animation_notes();
        if (maxAnimationNotes) {
            notes = this.notes.slice(0, maxAnimationNotes);
        }
        else {
            notes = this.notes;
        }
        for (let note of notes) {
            let { name, velocity, duration, time: timeOn } = note;
            let timeOff = timeOn + duration;
            noteOffObjs.push({ name, time: timeOff });
            noteOnObjs.push({ name, time: timeOn, duration, velocity });
        }
        const promiseDone = new Promise(resolve => {
            let count = 0;
            const noteOffCallback = async (time, event) => {
                Tone.Draw.schedule(() => this.paintKey(event, "green", false), time);
                this.piano.keyUp(event.name, time);
                count++;
                if (noteOffEvents.length === count) {
                    const now = Tone.Transport.now();
                    const util = require("../../util");
                    const diff = now - time;
                    await util.wait((diff * 1000), false);
                    resolve();
                    console.log('intro done', { event, time, now, diff, });
                }
            };
            const noteOnCallback = (time, event) => {
                Tone.Draw.schedule(() => this.paintKey(event, "green", true), time);
                this.piano.keyDown(event.name, time, event.velocity);
            };
            const noteOffEvents = new Tone.Part(noteOffCallback, noteOffObjs).start();
            const noteOnEvents = new Tone.Part(noteOnCallback, noteOnObjs).start();
            console.log({ noteOffEvents });
        });
        remote.globalShortcut.register("CommandOrControl+M", () => Tone.Transport.toggle());
        console.groupEnd();
        return await promiseDone;
    }
    paintKey({ name }, color, on) {
        let child;
        if (name.includes('#')) {
            let nohash = name.replace('#', '');
            child = this[nohash][name];
        }
        else {
            child = this[name];
        }
        child.toggleClass(color, on);
    }
    async init(midiAbsPath) {
        console.group(`Keyboard.initPiano()`);
        const pianoOptions = {
            samples: SALAMANDER_PATH_ABS,
            release: true,
            pedal: false,
            velocities: Glob_1.default.BigConfig.velocities,
        };
        if (Glob_1.default.BigConfig.dev.mute_animation()) {
            pianoOptions.volume = { strings: -Infinity, harmonics: -Infinity, keybed: -Infinity, pedal: -Infinity };
        }
        this.piano = new Piano_1.Piano(pianoOptions).toDestination();
        const promisePianoLoaded = this.piano.load();
        const promiseMidiLoaded = midi_1.Midi.fromUrl(midiAbsPath);
        const [_, midi] = await Promise.all([promisePianoLoaded, promiseMidiLoaded]);
        console.log('piano loaded');
        console.log('midi loaded', midi);
        this.notes = midi.tracks[0].notes;
        Tone.context.latencyHint = "playback";
        Tone.Transport.start();
        console.groupEnd();
        return;
    }
}
exports.default = Animation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYW5pbWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQWtDO0FBQ2xDLHFDQUE4QjtBQUM5Qix1Q0FBa0Q7QUFDbEQsdUNBQW9DO0FBQ3BDLDZCQUE2QjtBQUU3QixtQ0FBc0M7QUFRdEMsTUFBTSxTQUFVLFNBQVEsZUFBUztJQUk3QjtRQUVJLE1BQU0sSUFBSSxHQUFHO1lBQ1QsRUFBRSxFQUFHO2dCQUNELGtCQUFrQixFQUFHO29CQUNqQixLQUFLLEVBQUcsbUJBQW1CO2lCQUM5QjthQUNKO1lBQ0QsRUFBRSxFQUFHLGtCQUFrQjtTQUMxQixDQUFDO1FBQ0YsTUFBTSxhQUFhLEdBQUc7WUFDbEIsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7U0FDVixDQUFDO1FBQ0YsTUFBTSxRQUFRLEdBQUcsQ0FBRSxDQUFDLEVBQUUsQ0FBQyxDQUFFLENBQUM7UUFDMUIsS0FBTSxJQUFJLFFBQVEsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRztZQUNyQyxLQUFNLElBQUksUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFHO2dCQUNyQyxJQUFJLE1BQU0sR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3JDLElBQUksSUFBSSxHQUFHLEdBQUcsTUFBTSxHQUFHLFFBQVEsRUFBRSxDQUFDO2dCQUNsQyxJQUFJLEtBQUssQ0FBQztnQkFDVixJQUFLLFFBQVEsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUc7b0JBQy9CLEtBQUssR0FBRyxlQUFlLElBQUksSUFBSSxDQUFB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LGlCQUFpQixDQUFFLENBQUMsQ0FBQztRQUVqRixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDbEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdkIsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25CLE9BQU87SUFjWCxDQUFDO0NBQ0o7QUFFRCxrQkFBZSxTQUFTLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi91dGlsXCJcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi9HbG9iXCI7XG5pbXBvcnQgeyBQaWFubywgUGlhbm9PcHRpb25zIH0gZnJvbSBcIi4uLy4uL1BpYW5vXCI7XG5pbXBvcnQgeyBNaWRpIH0gZnJvbSBcIkB0b25lanMvbWlkaVwiO1xuaW1wb3J0ICogYXMgVG9uZSBmcm9tIFwidG9uZVwiO1xuaW1wb3J0IHsgTm90ZSB9IGZyb20gXCJAdG9uZWpzL21pZGkvZGlzdC9Ob3RlXCI7XG5pbXBvcnQgeyBWaXN1YWxCSEUgfSBmcm9tIFwiLi4vLi4vYmhlXCI7XG5cbnR5cGUgTm90ZUV2ZW50ID0geyBuYW1lOiBzdHJpbmcgfTtcbi8vIHR5cGUgTm90ZU9mZkV2ZW50ID0geyBuYW1lOiBzdHJpbmcgfTtcbnR5cGUgTm90ZU9uRXZlbnQgPSBOb3RlRXZlbnQgJiB7IHZlbG9jaXR5OiBudW1iZXIgfTtcbnR5cGUgTm90ZU9mZiA9IE5vdGVFdmVudCAmIHsgdGltZTogVG9uZS5Vbml0LlRpbWUgfTtcbnR5cGUgTm90ZU9uID0gTm90ZU9uRXZlbnQgJiB7IHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBkdXJhdGlvbjogbnVtYmVyIH07XG5cbmNsYXNzIEFuaW1hdGlvbiBleHRlbmRzIFZpc3VhbEJIRSB7XG4gICAgcHJpdmF0ZSBub3RlczogTm90ZVtdO1xuICAgIHByaXZhdGUgcGlhbm86IFBpYW5vO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBcbiAgICAgICAgY29uc3Qga2V5cyA9IHtcbiAgICAgICAgICAgIEEwIDoge1xuICAgICAgICAgICAgICAgICdbZGF0YS1ub3RlPVwiQTBcIl0nIDoge1xuICAgICAgICAgICAgICAgICAgICAnQSMwJyA6ICdbZGF0YS1ub3RlPVwiQSMwXCJdJ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBCMCA6ICdbZGF0YS1ub3RlPVwiQjBcIl0nLFxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBpbmRleFRvTGV0dGVyID0ge1xuICAgICAgICAgICAgMSA6IFwiQ1wiLFxuICAgICAgICAgICAgMiA6IFwiRFwiLFxuICAgICAgICAgICAgMyA6IFwiRVwiLFxuICAgICAgICAgICAgNCA6IFwiRlwiLFxuICAgICAgICAgICAgNSA6IFwiR1wiLFxuICAgICAgICAgICAgNiA6IFwiQVwiLFxuICAgICAgICAgICAgNyA6IFwiQlwiXG4gICAgICAgIH07XG4gICAgICAgIGNvbnN0IG5vYmxhY2tzID0gWyAzLCA3IF07IC8vIEUsIEJcbiAgICAgICAgZm9yICggbGV0IHJlZ2lzdGVyIG9mIHV0aWwucmFuZ2UoMSwgNykgKSB7XG4gICAgICAgICAgICBmb3IgKCBsZXQga2V5SW5kZXggb2YgdXRpbC5yYW5nZSgxLCA3KSApIHtcbiAgICAgICAgICAgICAgICBsZXQgbGV0dGVyID0gaW5kZXhUb0xldHRlcltrZXlJbmRleF07XG4gICAgICAgICAgICAgICAgbGV0IG5hbWUgPSBgJHtsZXR0ZXJ9JHtyZWdpc3Rlcn1gO1xuICAgICAgICAgICAgICAgIGxldCB2YWx1ZTtcbiAgICAgICAgICAgICAgICBpZiAoIG5vYmxhY2tzLmluY2x1ZGVzKGtleUluZGV4KSApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBgW2RhdGEtbm90ZT1cIiR7bmFtZX1cIl1gXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHF1ZXJ5ID0gYFtkYXRhLW5vdGU9XCIke25hbWV9XCJdYDtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1Ym5hbWUgPSBgJHtsZXR0ZXJ9IyR7cmVnaXN0ZXJ9YDtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1YnF1ZXJ5ID0gYFtkYXRhLW5vdGU9XCIke3N1Ym5hbWV9XCJdYDtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHN1YnZhbHVlID0ge307XG4gICAgICAgICAgICAgICAgICAgIHN1YnZhbHVlW3N1Ym5hbWVdID0gc3VicXVlcnk7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0ge307XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlW3F1ZXJ5XSA9IHN1YnZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBrZXlzW25hbWVdID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgc3VwZXIoe1xuICAgICAgICAgICAgaWQgOiAnYW5pbWF0aW9uJywgY2hpbGRyZW4gOiBrZXlzXG4gICAgICAgIH0pO1xuICAgICAgICAvLyB0aGlzLmluaXRQaWFubygpO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGludHJvKCk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBLZXlib2FyZC5pbnRybygpYCk7XG4gICAgICAgIGxldCBub3RlT2ZmT2JqczogTm90ZU9mZltdID0gW107XG4gICAgICAgIGxldCBub3RlT25PYmpzOiBOb3RlT25bXSA9IFtdO1xuICAgICAgICBsZXQgbm90ZXM6IE5vdGVbXTtcbiAgICAgICAgY29uc3QgbWF4QW5pbWF0aW9uTm90ZXMgPSBHbG9iLkJpZ0NvbmZpZy5kZXYubWF4X2FuaW1hdGlvbl9ub3RlcygpO1xuICAgICAgICBpZiAoIG1heEFuaW1hdGlvbk5vdGVzICkge1xuICAgICAgICAgICAgbm90ZXMgPSB0aGlzLm5vdGVzLnNsaWNlKDAsIG1heEFuaW1hdGlvbk5vdGVzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vdGVzID0gdGhpcy5ub3RlcztcbiAgICAgICAgfVxuICAgICAgICBmb3IgKCBsZXQgbm90ZSBvZiBub3RlcyApIHtcbiAgICAgICAgICAgIGxldCB7IG5hbWUsIHZlbG9jaXR5LCBkdXJhdGlvbiwgdGltZSA6IHRpbWVPbiB9ID0gbm90ZTtcbiAgICAgICAgICAgIGxldCB0aW1lT2ZmID0gdGltZU9uICsgZHVyYXRpb247XG4gICAgICAgICAgICBub3RlT2ZmT2Jqcy5wdXNoKHsgbmFtZSwgdGltZSA6IHRpbWVPZmYgfSk7XG4gICAgICAgICAgICBub3RlT25PYmpzLnB1c2goeyBuYW1lLCB0aW1lIDogdGltZU9uLCBkdXJhdGlvbiwgdmVsb2NpdHkgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcHJvbWlzZURvbmUgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgICAgICAvLyBsZXQgZG9uZSA9IGZhbHNlO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBub3RlT2ZmQ2FsbGJhY2sgPSBhc3luYyAodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBUb25lLkRyYXcuc2NoZWR1bGUoKCkgPT4gdGhpcy5wYWludEtleShldmVudCwgXCJncmVlblwiLCBmYWxzZSksIHRpbWUpO1xuICAgICAgICAgICAgICAgIHRoaXMucGlhbm8ua2V5VXAoZXZlbnQubmFtZSwgdGltZSk7XG4gICAgICAgICAgICAgICAgY291bnQrKztcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIG5vdGVPZmZFdmVudHMubGVuZ3RoID09PSBjb3VudCApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm93ID0gVG9uZS5UcmFuc3BvcnQubm93KCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHV0aWwgPSByZXF1aXJlKFwiLi4vLi4vdXRpbFwiKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICBjb25zdCBkaWZmID0gbm93IC0gdGltZTtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KChkaWZmICogMTAwMCksIGZhbHNlKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAvLyBkb25lID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2ludHJvIGRvbmUnLCB7IGV2ZW50LCB0aW1lLCBub3csIGRpZmYsIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IG5vdGVPbkNhbGxiYWNrID0gKHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBldmVudDogTm90ZU9uRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICBUb25lLkRyYXcuc2NoZWR1bGUoKCkgPT4gdGhpcy5wYWludEtleShldmVudCwgXCJncmVlblwiLCB0cnVlKSwgdGltZSk7XG4gICAgICAgICAgICAgICAgdGhpcy5waWFuby5rZXlEb3duKGV2ZW50Lm5hbWUsIHRpbWUsIGV2ZW50LnZlbG9jaXR5KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyBjb25zdCBub3cgPSBUb25lLlRyYW5zcG9ydC5ub3coKTtcbiAgICAgICAgICAgIGNvbnN0IG5vdGVPZmZFdmVudHMgPSBuZXcgVG9uZS5QYXJ0KG5vdGVPZmZDYWxsYmFjaywgbm90ZU9mZk9ianMpLnN0YXJ0KCk7XG4gICAgICAgICAgICBjb25zdCBub3RlT25FdmVudHMgPSBuZXcgVG9uZS5QYXJ0KG5vdGVPbkNhbGxiYWNrLCBub3RlT25PYmpzKS5zdGFydCgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHsgbm90ZU9mZkV2ZW50cyB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJlbW90ZS5nbG9iYWxTaG9ydGN1dC5yZWdpc3RlcihcIkNvbW1hbmRPckNvbnRyb2wrTVwiLCAoKSA9PiBUb25lLlRyYW5zcG9ydC50b2dnbGUoKSk7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHByb21pc2VEb25lO1xuICAgICAgICAvLyByZXR1cm4gYXdhaXQgd2FpdFVudGlsKCgpID0+IGRvbmUsIDUwMCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBwYWludEtleSh7IG5hbWUgfTogTm90ZUV2ZW50LCBjb2xvcjogXCJyZWRcIiB8IFwiZ3JlZW5cIiB8IFwiYmx1ZVwiLCBvbjogYm9vbGVhbikge1xuICAgICAgICBsZXQgY2hpbGQ7XG4gICAgICAgIGlmICggbmFtZS5pbmNsdWRlcygnIycpICkge1xuICAgICAgICAgICAgbGV0IG5vaGFzaCA9IG5hbWUucmVwbGFjZSgnIycsICcnKTtcbiAgICAgICAgICAgIGNoaWxkID0gdGhpc1tub2hhc2hdW25hbWVdO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2hpbGQgPSB0aGlzW25hbWVdO1xuICAgICAgICB9XG4gICAgICAgIGNoaWxkLnRvZ2dsZUNsYXNzKGNvbG9yLCBvbik7XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGFzeW5jIGluaXQobWlkaUFic1BhdGg6IHN0cmluZykge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBLZXlib2FyZC5pbml0UGlhbm8oKWApO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcGlhbm9PcHRpb25zOiBQYXJ0aWFsPFBpYW5vT3B0aW9ucz4gPSB7XG4gICAgICAgICAgICBzYW1wbGVzIDogU0FMQU1BTkRFUl9QQVRIX0FCUyxcbiAgICAgICAgICAgIHJlbGVhc2UgOiB0cnVlLFxuICAgICAgICAgICAgcGVkYWwgOiBmYWxzZSxcbiAgICAgICAgICAgIHZlbG9jaXRpZXMgOiBHbG9iLkJpZ0NvbmZpZy52ZWxvY2l0aWVzLFxuICAgICAgICB9O1xuICAgICAgICBpZiAoIEdsb2IuQmlnQ29uZmlnLmRldi5tdXRlX2FuaW1hdGlvbigpICkge1xuICAgICAgICAgICAgcGlhbm9PcHRpb25zLnZvbHVtZSA9IHsgc3RyaW5ncyA6IC1JbmZpbml0eSwgaGFybW9uaWNzIDogLUluZmluaXR5LCBrZXliZWQgOiAtSW5maW5pdHksIHBlZGFsIDogLUluZmluaXR5IH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBpYW5vID0gbmV3IFBpYW5vKHBpYW5vT3B0aW9ucykudG9EZXN0aW5hdGlvbigpO1xuICAgICAgICBjb25zdCBwcm9taXNlUGlhbm9Mb2FkZWQgPSB0aGlzLnBpYW5vLmxvYWQoKTtcbiAgICAgICAgY29uc3QgcHJvbWlzZU1pZGlMb2FkZWQgPSBNaWRpLmZyb21VcmwobWlkaUFic1BhdGgpO1xuICAgICAgICBjb25zdCBbIF8sIG1pZGkgXSA9IGF3YWl0IFByb21pc2UuYWxsKFsgcHJvbWlzZVBpYW5vTG9hZGVkLCBwcm9taXNlTWlkaUxvYWRlZCBdKTtcbiAgICAgICAgLy8gY29uc3QgbWlkaSA9IGF3YWl0IE1pZGkuZnJvbVVybChzdWJjb25maWcudHJ1dGgubWlkaS5hYnNQYXRoKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3BpYW5vIGxvYWRlZCcpO1xuICAgICAgICBjb25zb2xlLmxvZygnbWlkaSBsb2FkZWQnLCBtaWRpKTtcbiAgICAgICAgdGhpcy5ub3RlcyA9IG1pZGkudHJhY2tzWzBdLm5vdGVzO1xuICAgICAgICBUb25lLmNvbnRleHQubGF0ZW5jeUhpbnQgPSBcInBsYXliYWNrXCI7XG4gICAgICAgIFRvbmUuVHJhbnNwb3J0LnN0YXJ0KCk7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgICBcbiAgICAgICAgLy8gY29uc3Qgbm90ZU9mZkNhbGxiYWNrID0gKHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBldmVudDogTm90ZUV2ZW50KSA9PiB7XG4gICAgICAgIC8vXG4gICAgICAgIC8vICAgICBUb25lLkRyYXcuc2NoZWR1bGUoKCkgPT4gdGhpcy5wYWludEtleShldmVudCwgZmFsc2UpLCB0aW1lKTtcbiAgICAgICAgLy8gICAgIHBpYW5vLmtleVVwKGV2ZW50Lm5hbWUsIHRpbWUpO1xuICAgICAgICAvLyB9O1xuICAgICAgICBcbiAgICAgICAgLy8gY29uc3Qgbm90ZU9uQ2FsbGJhY2sgPSAodGltZTogVG9uZS5Vbml0LlRpbWUsIGV2ZW50OiBOb3RlT25FdmVudCkgPT4ge1xuICAgICAgICAvLyAgICAgVG9uZS5EcmF3LnNjaGVkdWxlKCgpID0+IHRoaXMucGFpbnRLZXkoZXZlbnQsIHRydWUpLCB0aW1lKTtcbiAgICAgICAgLy8gICAgIHBpYW5vLmtleURvd24oZXZlbnQubmFtZSwgdGltZSwgZXZlbnQudmVsb2NpdHkpO1xuICAgICAgICAvLyB9O1xuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBBbmltYXRpb247XG4iXX0=