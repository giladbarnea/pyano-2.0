"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util = require("../../util");
const Glob_1 = require("../../Glob");
const Piano_1 = require("../../Piano");
const midi_1 = require("@tonejs/midi");
const Tone = require("tone");
const bhe_1 = require("../../bhe");
class Animation extends bhe_1.VisualBHE {
    constructor() {
        const keys = {
            A0: {
                '[data-note="A0"]': {
                    'A#0': '[data-note="A#0"]'
                }
            },
            B0: '[data-note="B0"]',
        };
        const indexToLetter = {
            1: "C",
            2: "D",
            3: "E",
            4: "F",
            5: "G",
            6: "A",
            7: "B"
        };
        const noblacks = [3, 7];
        for (let register of util.range(1, 7)) {
            for (let keyIndex of util.range(1, 7)) {
                let letter = indexToLetter[keyIndex];
                let name = `${letter}${register}`;
                let value;
                if (noblacks.includes(keyIndex)) {
                    value = `[data-note="${name}"]`;
                }
                else {
                    let query = `[data-note="${name}"]`;
                    let subname = `${letter}#${register}`;
                    let subquery = `[data-note="${subname}"]`;
                    let subvalue = {};
                    subvalue[subname] = subquery;
                    value = {};
                    value[query] = subvalue;
                }
                keys[name] = value;
            }
        }
        super({
            id: 'animation', children: keys
        });
    }
    async init(midiAbsPath) {
        console.group(`Animation.init()`);
        const pianoOptions = {
            samples: SALAMANDER_PATH_ABS,
            release: true,
            pedal: false,
            velocities: Glob_1.default.BigConfig.velocities,
        };
        if (Glob_1.default.BigConfig.dev.mute_animation()) {
            pianoOptions.volume = { strings: -Infinity, harmonics: -Infinity, keybed: -Infinity, pedal: -Infinity };
        }
        this.piano = new Piano_1.Piano(pianoOptions).toDestination();
        const loadPiano = this.piano.load();
        const loadMidi = midi_1.Midi.fromUrl(midiAbsPath);
        const [_, midi] = await Promise.all([loadPiano, loadMidi]);
        console.log('piano loaded, midi loaded: ', midi);
        const notes = midi.tracks[0].notes;
        Tone.context.latencyHint = "playback";
        Tone.Transport.start();
        let noteOns = [];
        let noteOffs = [];
        for (let note of notes) {
            let { name, velocity, duration, time: timeOn } = note;
            let timeOff = timeOn + duration;
            noteOns.push({ name, time: timeOn, duration, velocity });
            noteOffs.push({ name, time: timeOff });
        }
        this.noteOns = noteOns;
        this.noteOffs = noteOffs;
        console.groupEnd();
        return;
    }
    paintKey({ name }, color, on) {
        let child;
        if (name.includes('#')) {
            let nohash = name.replace('#', '');
            child = this[nohash][name];
        }
        else {
            child = this[name];
        }
        child.toggleClass(color, on);
    }
    play(notes) {
        return new Promise(resolve => {
            let count = 0;
            const noteOnCallback = (time, event) => {
                Tone.Draw.schedule(() => this.paintKey(event, "green", true), time);
                this.piano.keyDown(event.name, time, event.velocity);
            };
            const noteOffCallback = async (time, event) => {
                Tone.Draw.schedule(() => this.paintKey(event, "green", false), time);
                this.piano.keyUp(event.name, time);
                count++;
                if (noteOffEvents.length === count) {
                    const now = Tone.Transport.now();
                    const util = require("../../util");
                    const diff = now - time;
                    await util.wait((diff * 1000), false);
                    console.log('animation ended!');
                    resolve();
                }
            };
            let noteOffs;
            let noteOns;
            if (notes) {
                noteOns = this.noteOns.slice(0, notes);
                noteOffs = this.noteOffs.slice(0, notes);
            }
            else {
                noteOns = this.noteOns;
                noteOffs = this.noteOffs;
            }
            const noteOnEvents = new Tone.Part(noteOnCallback, noteOns).start();
            const noteOffEvents = new Tone.Part(noteOffCallback, noteOffs).start();
        });
    }
    async intro() {
        console.group(`Animation.intro()`);
        await this.play();
        console.groupEnd();
        return;
    }
    async levelIntro(notes) {
        console.group(`Animation.levelIntro()`);
        await this.play(notes);
        console.groupEnd();
        return;
    }
}
exports.default = Animation;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYW5pbWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsbUNBQWtDO0FBQ2xDLHFDQUE4QjtBQUM5Qix1Q0FBa0Q7QUFDbEQsdUNBQW9DO0FBQ3BDLDZCQUE2QjtBQUU3QixtQ0FBc0M7QUFTdEMsTUFBTSxTQUFVLFNBQVEsZUFBUztJQUs3QjtRQUVJLE1BQU0sSUFBSSxHQUFHO1lBQ1QsRUFBRSxFQUFHO2dCQUNELGtCQUFrQixFQUFHO29CQUNqQixLQUFLLEVBQUcsbUJBQW1CO2lCQUM5QjthQUNKO1lBQ0QsRUFBRSxFQUFHLGtCQUFrQjtTQUMxQixDQUFDO1FBQ0YsTUFBTSxhQUFhLEdBQUc7WUFDbEIsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7WUFDUCxDQUFDLEVBQUcsR0FBRztZQUNQLENBQUMsRUFBRyxHQUFHO1lBQ1AsQ0FBQyxFQUFHLEdBQUc7U0FDVixDQUFDO1FBQ0YsTUFBTSxRQUFRLEdBQUcsQ0FBRSxDQUFDLEVBQUUsQ0FBQyxDQUFFLENBQUM7UUFDMUIsS0FBTSxJQUFJLFFBQVEsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRztZQUNyQyxLQUFNLElBQUksUUFBUSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFHO2dCQUNyQyxJQUFJLE1BQU0sR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3JDLElBQUksSUFBSSxHQUFHLEdBQUcsTUFBTSxHQUFHLFFBQVEsRUFBRSxDQUFDO2dCQUNsQyxJQUFJLEtBQUssQ0FBQztnQkFDVixJQUFLLFFBQVEsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUc7b0JBQy9CLEtBQUssR0FBRyxlQUFlLElBQUksSUFBSSxDQUFB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QUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxRQUFRLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUczRSxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNQLE9BQU8sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNuQyxNQUFNLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNsQixPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDbkIsT0FBTztJQW9DWCxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FBQyxLQUFhO1FBQzFCLE9BQU8sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztRQUN4QyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDdkIsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ25CLE9BQU87SUFDWCxDQUFDO0NBR0o7QUFFRCxrQkFBZSxTQUFTLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi91dGlsXCJcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi9HbG9iXCI7XG5pbXBvcnQgeyBQaWFubywgUGlhbm9PcHRpb25zIH0gZnJvbSBcIi4uLy4uL1BpYW5vXCI7XG5pbXBvcnQgeyBNaWRpIH0gZnJvbSBcIkB0b25lanMvbWlkaVwiO1xuaW1wb3J0ICogYXMgVG9uZSBmcm9tIFwidG9uZVwiO1xuaW1wb3J0IHsgTm90ZSB9IGZyb20gXCJAdG9uZWpzL21pZGkvZGlzdC9Ob3RlXCI7XG5pbXBvcnQgeyBWaXN1YWxCSEUgfSBmcm9tIFwiLi4vLi4vYmhlXCI7XG5pbXBvcnQgeyBMZXZlbENvbGxlY3Rpb24gfSBmcm9tIFwiLi4vLi4vTGV2ZWxcIjtcblxudHlwZSBOb3RlRXZlbnQgPSB7IG5hbWU6IHN0cmluZyB9O1xuLy8gdHlwZSBOb3RlT2ZmRXZlbnQgPSB7IG5hbWU6IHN0cmluZyB9O1xudHlwZSBOb3RlT25FdmVudCA9IE5vdGVFdmVudCAmIHsgdmVsb2NpdHk6IG51bWJlciB9O1xudHlwZSBOb3RlT2ZmID0gTm90ZUV2ZW50ICYgeyB0aW1lOiBUb25lLlVuaXQuVGltZSB9O1xudHlwZSBOb3RlT24gPSBOb3RlT25FdmVudCAmIHsgdGltZTogVG9uZS5Vbml0LlRpbWUsIGR1cmF0aW9uOiBudW1iZXIgfTtcblxuY2xhc3MgQW5pbWF0aW9uIGV4dGVuZHMgVmlzdWFsQkhFIHtcbiAgICBwcml2YXRlIHBpYW5vOiBQaWFubztcbiAgICBwcml2YXRlIG5vdGVPbnM6IE5vdGVPbltdO1xuICAgIHByaXZhdGUgbm90ZU9mZnM6IE5vdGVPZmZbXTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGtleXMgPSB7XG4gICAgICAgICAgICBBMCA6IHtcbiAgICAgICAgICAgICAgICAnW2RhdGEtbm90ZT1cIkEwXCJdJyA6IHtcbiAgICAgICAgICAgICAgICAgICAgJ0EjMCcgOiAnW2RhdGEtbm90ZT1cIkEjMFwiXSdcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgQjAgOiAnW2RhdGEtbm90ZT1cIkIwXCJdJyxcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3QgaW5kZXhUb0xldHRlciA9IHtcbiAgICAgICAgICAgIDEgOiBcIkNcIixcbiAgICAgICAgICAgIDIgOiBcIkRcIixcbiAgICAgICAgICAgIDMgOiBcIkVcIixcbiAgICAgICAgICAgIDQgOiBcIkZcIixcbiAgICAgICAgICAgIDUgOiBcIkdcIixcbiAgICAgICAgICAgIDYgOiBcIkFcIixcbiAgICAgICAgICAgIDcgOiBcIkJcIlxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBub2JsYWNrcyA9IFsgMywgNyBdOyAvLyBFLCBCXG4gICAgICAgIGZvciAoIGxldCByZWdpc3RlciBvZiB1dGlsLnJhbmdlKDEsIDcpICkge1xuICAgICAgICAgICAgZm9yICggbGV0IGtleUluZGV4IG9mIHV0aWwucmFuZ2UoMSwgNykgKSB7XG4gICAgICAgICAgICAgICAgbGV0IGxldHRlciA9IGluZGV4VG9MZXR0ZXJba2V5SW5kZXhdO1xuICAgICAgICAgICAgICAgIGxldCBuYW1lID0gYCR7bGV0dGVyfSR7cmVnaXN0ZXJ9YDtcbiAgICAgICAgICAgICAgICBsZXQgdmFsdWU7XG4gICAgICAgICAgICAgICAgaWYgKCBub2JsYWNrcy5pbmNsdWRlcyhrZXlJbmRleCkgKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gYFtkYXRhLW5vdGU9XCIke25hbWV9XCJdYFxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxldCBxdWVyeSA9IGBbZGF0YS1ub3RlPVwiJHtuYW1lfVwiXWA7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJuYW1lID0gYCR7bGV0dGVyfSMke3JlZ2lzdGVyfWA7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJxdWVyeSA9IGBbZGF0YS1ub3RlPVwiJHtzdWJuYW1lfVwiXWA7XG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWJ2YWx1ZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICBzdWJ2YWx1ZVtzdWJuYW1lXSA9IHN1YnF1ZXJ5O1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHt9O1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZVtxdWVyeV0gPSBzdWJ2YWx1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAga2V5c1tuYW1lXSA9IHZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHN1cGVyKHtcbiAgICAgICAgICAgIGlkIDogJ2FuaW1hdGlvbicsIGNoaWxkcmVuIDoga2V5c1xuICAgICAgICB9KTtcbiAgICAgICAgLy8gdGhpcy5pbml0UGlhbm8oKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBhc3luYyBpbml0KG1pZGlBYnNQYXRoOiBzdHJpbmcpIHtcbiAgICAgICAgY29uc29sZS5ncm91cChgQW5pbWF0aW9uLmluaXQoKWApO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcGlhbm9PcHRpb25zOiBQYXJ0aWFsPFBpYW5vT3B0aW9ucz4gPSB7XG4gICAgICAgICAgICBzYW1wbGVzIDogU0FMQU1BTkRFUl9QQVRIX0FCUyxcbiAgICAgICAgICAgIHJlbGVhc2UgOiB0cnVlLFxuICAgICAgICAgICAgcGVkYWwgOiBmYWxzZSxcbiAgICAgICAgICAgIHZlbG9jaXRpZXMgOiBHbG9iLkJpZ0NvbmZpZy52ZWxvY2l0aWVzLFxuICAgICAgICB9O1xuICAgICAgICBpZiAoIEdsb2IuQmlnQ29uZmlnLmRldi5tdXRlX2FuaW1hdGlvbigpICkge1xuICAgICAgICAgICAgcGlhbm9PcHRpb25zLnZvbHVtZSA9IHsgc3RyaW5ncyA6IC1JbmZpbml0eSwgaGFybW9uaWNzIDogLUluZmluaXR5LCBrZXliZWQgOiAtSW5maW5pdHksIHBlZGFsIDogLUluZmluaXR5IH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBpYW5vID0gbmV3IFBpYW5vKHBpYW5vT3B0aW9ucykudG9EZXN0aW5hdGlvbigpO1xuICAgICAgICBjb25zdCBsb2FkUGlhbm8gPSB0aGlzLnBpYW5vLmxvYWQoKTtcbiAgICAgICAgY29uc3QgbG9hZE1pZGkgPSBNaWRpLmZyb21VcmwobWlkaUFic1BhdGgpO1xuICAgICAgICBjb25zdCBbIF8sIG1pZGkgXSA9IGF3YWl0IFByb21pc2UuYWxsKFsgbG9hZFBpYW5vLCBsb2FkTWlkaSBdKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3BpYW5vIGxvYWRlZCwgbWlkaSBsb2FkZWQ6ICcsIG1pZGkpO1xuICAgICAgICBjb25zdCBub3RlcyA9IG1pZGkudHJhY2tzWzBdLm5vdGVzO1xuICAgICAgICBUb25lLmNvbnRleHQubGF0ZW5jeUhpbnQgPSBcInBsYXliYWNrXCI7XG4gICAgICAgIFRvbmUuVHJhbnNwb3J0LnN0YXJ0KCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgbGV0IG5vdGVPbnM6IE5vdGVPbltdID0gW107XG4gICAgICAgIGxldCBub3RlT2ZmczogTm90ZU9mZltdID0gW107XG4gICAgICAgIFxuICAgICAgICBmb3IgKCBsZXQgbm90ZSBvZiBub3RlcyApIHtcbiAgICAgICAgICAgIGxldCB7IG5hbWUsIHZlbG9jaXR5LCBkdXJhdGlvbiwgdGltZSA6IHRpbWVPbiB9ID0gbm90ZTtcbiAgICAgICAgICAgIGxldCB0aW1lT2ZmID0gdGltZU9uICsgZHVyYXRpb247XG4gICAgICAgICAgICBub3RlT25zLnB1c2goeyBuYW1lLCB0aW1lIDogdGltZU9uLCBkdXJhdGlvbiwgdmVsb2NpdHkgfSk7XG4gICAgICAgICAgICBub3RlT2Zmcy5wdXNoKHsgbmFtZSwgdGltZSA6IHRpbWVPZmYgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5ub3RlT25zID0gbm90ZU9ucztcbiAgICAgICAgdGhpcy5ub3RlT2ZmcyA9IG5vdGVPZmZzO1xuICAgICAgICBjb25zb2xlLmdyb3VwRW5kKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIHBhaW50S2V5KHsgbmFtZSB9OiBOb3RlRXZlbnQsIGNvbG9yOiBcInJlZFwiIHwgXCJncmVlblwiIHwgXCJibHVlXCIsIG9uOiBib29sZWFuKSB7XG4gICAgICAgIGxldCBjaGlsZDtcbiAgICAgICAgaWYgKCBuYW1lLmluY2x1ZGVzKCcjJykgKSB7XG4gICAgICAgICAgICBsZXQgbm9oYXNoID0gbmFtZS5yZXBsYWNlKCcjJywgJycpO1xuICAgICAgICAgICAgY2hpbGQgPSB0aGlzW25vaGFzaF1bbmFtZV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjaGlsZCA9IHRoaXNbbmFtZV07XG4gICAgICAgIH1cbiAgICAgICAgY2hpbGQudG9nZ2xlQ2xhc3MoY29sb3IsIG9uKTtcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBwbGF5KG5vdGVzPzogbnVtYmVyKTogUHJvbWlzZTx1bmtub3duPiB7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7XG4gICAgICAgICAgICBsZXQgY291bnQgPSAwO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBub3RlT25DYWxsYmFjayA9ICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVPbkV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgVG9uZS5EcmF3LnNjaGVkdWxlKCgpID0+IHRoaXMucGFpbnRLZXkoZXZlbnQsIFwiZ3JlZW5cIiwgdHJ1ZSksIHRpbWUpO1xuICAgICAgICAgICAgICAgIHRoaXMucGlhbm8ua2V5RG93bihldmVudC5uYW1lLCB0aW1lLCBldmVudC52ZWxvY2l0eSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgY29uc3Qgbm90ZU9mZkNhbGxiYWNrID0gYXN5bmMgKHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBldmVudDogTm90ZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgVG9uZS5EcmF3LnNjaGVkdWxlKCgpID0+IHRoaXMucGFpbnRLZXkoZXZlbnQsIFwiZ3JlZW5cIiwgZmFsc2UpLCB0aW1lKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBpYW5vLmtleVVwKGV2ZW50Lm5hbWUsIHRpbWUpO1xuICAgICAgICAgICAgICAgIGNvdW50Kys7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCBub3RlT2ZmRXZlbnRzLmxlbmd0aCA9PT0gY291bnQgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5vdyA9IFRvbmUuVHJhbnNwb3J0Lm5vdygpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB1dGlsID0gcmVxdWlyZShcIi4uLy4uL3V0aWxcIik7XG4gICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGlmZiA9IG5vdyAtIHRpbWU7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgoZGlmZiAqIDEwMDApLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdhbmltYXRpb24gZW5kZWQhJyk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIGNvbnN0IG5vdyA9IFRvbmUuVHJhbnNwb3J0Lm5vdygpO1xuICAgICAgICAgICAgbGV0IG5vdGVPZmZzO1xuICAgICAgICAgICAgbGV0IG5vdGVPbnM7XG4gICAgICAgICAgICBpZiAoIG5vdGVzICkge1xuICAgICAgICAgICAgICAgIG5vdGVPbnMgPSB0aGlzLm5vdGVPbnMuc2xpY2UoMCwgbm90ZXMpO1xuICAgICAgICAgICAgICAgIG5vdGVPZmZzID0gdGhpcy5ub3RlT2Zmcy5zbGljZSgwLCBub3Rlcyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5vdGVPbnMgPSB0aGlzLm5vdGVPbnM7XG4gICAgICAgICAgICAgICAgbm90ZU9mZnMgPSB0aGlzLm5vdGVPZmZzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3Qgbm90ZU9uRXZlbnRzID0gbmV3IFRvbmUuUGFydChub3RlT25DYWxsYmFjaywgbm90ZU9ucykuc3RhcnQoKTtcbiAgICAgICAgICAgIGNvbnN0IG5vdGVPZmZFdmVudHMgPSBuZXcgVG9uZS5QYXJ0KG5vdGVPZmZDYWxsYmFjaywgbm90ZU9mZnMpLnN0YXJ0KCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGludHJvKCk6IFByb21pc2U8dW5rbm93bj4ge1xuICAgICAgICBjb25zb2xlLmdyb3VwKGBBbmltYXRpb24uaW50cm8oKWApO1xuICAgICAgICBhd2FpdCB0aGlzLnBsYXkoKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgICAgICByZXR1cm47XG4gICAgICAgIC8qY29uc3QgcHJvbWlzZURvbmUgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHtcbiAgICAgICAgIGxldCBjb3VudCA9IDA7XG4gICAgICAgICBcbiAgICAgICAgIGNvbnN0IG5vdGVPZmZDYWxsYmFjayA9IGFzeW5jICh0aW1lOiBUb25lLlVuaXQuVGltZSwgZXZlbnQ6IE5vdGVFdmVudCkgPT4ge1xuICAgICAgICAgVG9uZS5EcmF3LnNjaGVkdWxlKCgpID0+IHRoaXMucGFpbnRLZXkoZXZlbnQsIFwiZ3JlZW5cIiwgZmFsc2UpLCB0aW1lKTtcbiAgICAgICAgIHRoaXMucGlhbm8ua2V5VXAoZXZlbnQubmFtZSwgdGltZSk7XG4gICAgICAgICBjb3VudCsrO1xuICAgICAgICAgXG4gICAgICAgICBpZiAoIG5vdGVPZmZFdmVudHMubGVuZ3RoID09PSBjb3VudCApIHtcbiAgICAgICAgIGNvbnN0IG5vdyA9IFRvbmUuVHJhbnNwb3J0Lm5vdygpO1xuICAgICAgICAgY29uc3QgdXRpbCA9IHJlcXVpcmUoXCIuLi8uLi91dGlsXCIpO1xuICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgY29uc3QgZGlmZiA9IG5vdyAtIHRpbWU7XG4gICAgICAgICBhd2FpdCB1dGlsLndhaXQoKGRpZmYgKiAxMDAwKSwgZmFsc2UpO1xuICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgfVxuICAgICAgICAgXG4gICAgICAgICBcbiAgICAgICAgIH07XG4gICAgICAgICBcbiAgICAgICAgIGNvbnN0IG5vdGVPbkNhbGxiYWNrID0gKHRpbWU6IFRvbmUuVW5pdC5UaW1lLCBldmVudDogTm90ZU9uRXZlbnQpID0+IHtcbiAgICAgICAgIFRvbmUuRHJhdy5zY2hlZHVsZSgoKSA9PiB0aGlzLnBhaW50S2V5KGV2ZW50LCBcImdyZWVuXCIsIHRydWUpLCB0aW1lKTtcbiAgICAgICAgIHRoaXMucGlhbm8ua2V5RG93bihldmVudC5uYW1lLCB0aW1lLCBldmVudC52ZWxvY2l0eSk7XG4gICAgICAgICB9O1xuICAgICAgICAgLy8gY29uc3Qgbm93ID0gVG9uZS5UcmFuc3BvcnQubm93KCk7XG4gICAgICAgICBjb25zdCBub3RlT2ZmRXZlbnRzID0gbmV3IFRvbmUuUGFydChub3RlT2ZmQ2FsbGJhY2ssIHRoaXMubm90ZU9mZnMpLnN0YXJ0KCk7XG4gICAgICAgICBjb25zdCBub3RlT25FdmVudHMgPSBuZXcgVG9uZS5QYXJ0KG5vdGVPbkNhbGxiYWNrLCB0aGlzLm5vdGVPbnMpLnN0YXJ0KCk7XG4gICAgICAgICBcbiAgICAgICAgIFxuICAgICAgICAgfSk7Ki9cbiAgICAgICAgLy8gcmVtb3RlLmdsb2JhbFNob3J0Y3V0LnJlZ2lzdGVyKFwiQ29tbWFuZE9yQ29udHJvbCtNXCIsICgpID0+IFRvbmUuVHJhbnNwb3J0LnRvZ2dsZSgpKTtcbiAgICAgICAgLy8gY29uc29sZS5ncm91cEVuZCgpO1xuICAgICAgICAvLyByZXR1cm4gYXdhaXQgcHJvbWlzZURvbmU7XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgYXN5bmMgbGV2ZWxJbnRybyhub3RlczogbnVtYmVyKSB7XG4gICAgICAgIGNvbnNvbGUuZ3JvdXAoYEFuaW1hdGlvbi5sZXZlbEludHJvKClgKTtcbiAgICAgICAgYXdhaXQgdGhpcy5wbGF5KG5vdGVzKTtcbiAgICAgICAgY29uc29sZS5ncm91cEVuZCgpO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIFxuICAgIFxufVxuXG5leHBvcnQgZGVmYXVsdCBBbmltYXRpb247XG4iXX0=