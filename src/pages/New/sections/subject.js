"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const util_1 = require("../../../util");
const Glob_1 = require("../../../Glob");
const electron_1 = require("electron");
class Input extends bhe_1.Div {
    constructor() {
        super({ cls: 'input' });
        const editable = bhe_1.span({ cls: 'editable' });
        this
            .attr({ contenteditable: true })
            .on({
            keydown: (ev) => this.doAutocomplete(ev),
            focus: (ev) => {
                console.log('input focus');
                this.sendEnd();
                electron_1.remote.getCurrentWindow().webContents.sendInputEvent({
                    type: "keyDown",
                    keyCode: 'Home',
                    modifiers: ['shift']
                });
            },
        })
            .cacheAppend({
            editable,
            autocomplete: bhe_1.span({ cls: 'autocomplete', text: 'Subject Id' }).on({
                focus: () => {
                    console.log('autocomplete focus');
                },
                change: (ev) => {
                    console.log('autocomplete change');
                },
            })
        });
    }
    reset({ inputMissing }) {
        if (inputMissing) {
            this.addClass('input-missing');
        }
        this.autocomplete.text('Subject Id');
        this.editable.text('');
    }
    sendEnd() {
        electron_1.remote.getCurrentWindow().webContents.sendInputEvent({
            type: "keyDown",
            keyCode: 'End',
            modifiers: []
        });
    }
    doAutocomplete(ev) {
        console.log('\ndoAutocomplete', ev);
        if (ev.ctrlKey || ['Backspace', 'Home', 'End', 'Delete'].includes(ev.key) || ev.key.includes('Arrow')) {
            if (ev.key === 'Backspace') {
                console.log(`Backspace, returning. editable text len: ${this.editable.text().length}, autocomplete text len: ${this.autocomplete.text().length}
                activeElement: ${document.activeElement.className}`, ev);
                const oldText = this.editable.text();
                if (oldText.length === 0) {
                    console.warn('oldText.length === 0, preventDefault, "Subject Id" and return');
                    this.autocomplete.text('Subject Id');
                    return ev.preventDefault();
                }
                this.autocomplete.text('');
                const newText = oldText.slice(0, oldText.length - 1);
                if (ev.ctrlKey || !util_1.bool(newText)) {
                    console.warn('!bool(newText) || ctrlKey, editable(""), preventDefault, "Subject Id" and return');
                    this.editable.text('');
                    this.autocomplete.text('Subject Id');
                    return ev.preventDefault();
                }
                this.editable.text(newText);
                this.sendEnd();
            }
            else {
                console.log('Functional, returning', ev);
            }
            return;
        }
        ev.preventDefault();
        if (ev.key === 'Tab') {
            this.editable.text(this.editable.text() + this.autocomplete.text());
            this.autocomplete.text('');
            this.sendEnd();
            return;
        }
        if (ev.key.match(/^[A-Z]/)) {
            console.log('Matched ^[A-Z], returning', ev);
            return;
        }
        const oldText = this.editable.text().lower().removeAll(/[^(a-z0-9|_)]/);
        let txt;
        if (util_1.bool(oldText))
            txt = oldText.toLowerCase() + ev.key;
        else
            txt = ev.key;
        this.editable.text(txt);
        const subjectSuggestion = subjects.find(s => s.startsWith(txt));
        this.removeClass('input-missing');
        if (subjectSuggestion) {
            this.autocomplete.html(subjectSuggestion.substr(txt.length));
            console.warn('changed autocomplete');
            this.sendEnd();
        }
        else {
            if (this.autocomplete.html()) {
                this.autocomplete.html('');
                console.warn('reset autocomplete');
            }
        }
        console.log({ txt, subjectSuggestion, 'this.autocomplete.text()': this.autocomplete.text() });
        console.log('\n');
    }
    onKeyDown(ev) {
        console.log('onKeyDown', ev);
        if (ev.key === 'Tab') {
            const value = this.editable.text() + this.autocomplete.text();
            this.editable.text(value);
            this.autocomplete.text('');
        }
    }
}
class SubjectDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const input = new Input();
        this.cacheAppend({ input });
    }
}
const subjectDiv = new SubjectDiv({ id: 'subject_div' });
const subjects = Glob_1.default.BigConfig.subjects;
exports.default = subjectDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ViamVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN1YmplY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFLQSxzQ0FBMEU7QUFDMUUsd0NBQXFDO0FBRXJDLHdDQUFnQztBQUNoQyx1Q0FBa0M7QUFFbEMsTUFBTSxLQUFNLFNBQVEsU0FBRztJQUluQjtRQUNJLEtBQUssQ0FBQyxFQUFFLEdBQUcsRUFBRyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ3pCLE1BQU0sUUFBUSxHQUFHLFVBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBUzVDLElBQUk7YUFDQyxJQUFJLENBQUMsRUFBRSxlQUFlLEVBQUcsSUFBSSxFQUFFLENBQUM7YUFFaEMsRUFBRSxDQUFDO1lBQ0EsT0FBTyxFQUFHLENBQUMsRUFBaUIsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7WUFDeEQsS0FBSyxFQUFHLENBQUMsRUFBYyxFQUFFLEVBQUU7Z0JBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQzNCLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDZixpQkFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQztvQkFDakQsSUFBSSxFQUFHLFNBQVM7b0JBQ2hCLE9BQU8sRUFBRyxNQUFNO29CQUNoQixTQUFTLEVBQUcsQ0FBRSxPQUFPLENBQUU7aUJBQzFCLENBQUMsQ0FBQTtZQUNOLENBQUM7U0FFSixDQUFDO2FBQ0QsV0FBVyxDQUFDO1lBQ1QsUUFBUTtZQUNSLFlBQVksRUFBRyxVQUFJLENBQUMsRUFBRSxHQUFHLEVBQUcsY0FBYyxFQUFFLElBQUksRUFBRyxZQUFZLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDbEUsS0FBSyxFQUFHLEdBQUcsRUFBRTtvQkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLENB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QUssRUFBRSxDQUFDLENBQUE7SUFDL0IsQ0FBQztDQUdKO0FBRUQsTUFBTSxVQUFVLEdBQUcsSUFBSSxVQUFVLENBQUMsRUFBRSxFQUFFLEVBQUcsYUFBYSxFQUFFLENBQUMsQ0FBQztBQUMxRCxNQUFNLFFBQVEsR0FBRyxjQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQztBQUN6QyxrQkFBZSxVQUFVLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyAqICBwYWdlcy9OZXcvc2VjdGlvbnMvc3ViamVjdFxuXG4vKipcbiAqIGltcG9ydCBzZWN0aW9ucyBmcm9tIFwiLi9zZWN0aW9uc1wiXG4gKiBzZWN0aW9ucy5zdWJqZWN0Ki9cbmltcG9ydCB7IGRpdiwgZWxlbSwgYnV0dG9uLCBzcGFuLCBEaXYsIEJ1dHRvbiwgU3BhbiB9IGZyb20gXCIuLi8uLi8uLi9iaGVcIjtcbmltcG9ydCB7IGJvb2wgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbFwiO1xuaW1wb3J0IE15QWxlcnQgZnJvbSAnLi4vLi4vLi4vTXlBbGVydCdcbmltcG9ydCBHbG9iIGZyb20gJy4uLy4uLy4uL0dsb2InXG5pbXBvcnQgeyByZW1vdGUgfSBmcm9tIFwiZWxlY3Ryb25cIjtcblxuY2xhc3MgSW5wdXQgZXh0ZW5kcyBEaXYge1xuICAgIGVkaXRhYmxlOiBTcGFuO1xuICAgIGF1dG9jb21wbGV0ZTogU3BhbjtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgc3VwZXIoeyBjbHMgOiAnaW5wdXQnIH0pO1xuICAgICAgICBjb25zdCBlZGl0YWJsZSA9IHNwYW4oeyBjbHMgOiAnZWRpdGFibGUnIH0pO1xuICAgICAgICAvLyAuYXR0cih7IGNvbnRlbnRlZGl0YWJsZSA6IHRydWUgfSk7XG4gICAgICAgIC8qLm9uKHtcbiAgICAgICAgIC8vIGlucHV0IDogKGV2OiBJbnB1dEV2ZW50KSA9PiB0aGlzLmRvQXV0b2NvbXBsZXRlKGV2KSxcbiAgICAgICAgIC8vIGZvY3VzIDogKGV2OiBGb2N1c0V2ZW50KSA9PiB7XG4gICAgICAgICAvLyAgICAgY29uc29sZS5sb2coJ2VkaXRhYmxlIGZvY3VzJyk7XG4gICAgICAgICAvLyB9LFxuICAgICAgICAgLy8ga2V5ZG93biA6IChldjogS2V5Ym9hcmRFdmVudCkgPT4gdGhpcy5vbktleURvd24oZXYpLFxuICAgICAgICAgfSk7Ki9cbiAgICAgICAgdGhpc1xuICAgICAgICAgICAgLmF0dHIoeyBjb250ZW50ZWRpdGFibGUgOiB0cnVlIH0pXG4gICAgICAgICAgICAvLyAuZm9jdXMoKCkgPT4gZWRpdGFibGUuZm9jdXMoKSlcbiAgICAgICAgICAgIC5vbih7XG4gICAgICAgICAgICAgICAga2V5ZG93biA6IChldjogS2V5Ym9hcmRFdmVudCkgPT4gdGhpcy5kb0F1dG9jb21wbGV0ZShldiksXG4gICAgICAgICAgICAgICAgZm9jdXMgOiAoZXY6IEZvY3VzRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2lucHV0IGZvY3VzJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VuZEVuZCgpO1xuICAgICAgICAgICAgICAgICAgICByZW1vdGUuZ2V0Q3VycmVudFdpbmRvdygpLndlYkNvbnRlbnRzLnNlbmRJbnB1dEV2ZW50KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGUgOiBcImtleURvd25cIixcbiAgICAgICAgICAgICAgICAgICAgICAgIGtleUNvZGUgOiAnSG9tZScsXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2RpZmllcnMgOiBbICdzaGlmdCcgXVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhY2hlQXBwZW5kKHtcbiAgICAgICAgICAgICAgICBlZGl0YWJsZSxcbiAgICAgICAgICAgICAgICBhdXRvY29tcGxldGUgOiBzcGFuKHsgY2xzIDogJ2F1dG9jb21wbGV0ZScsIHRleHQgOiAnU3ViamVjdCBJZCcgfSkub24oe1xuICAgICAgICAgICAgICAgICAgICBmb2N1cyA6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdhdXRvY29tcGxldGUgZm9jdXMnKVxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBjaGFuZ2UgOiAoZXY6IEtleWJvYXJkRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdhdXRvY29tcGxldGUgY2hhbmdlJylcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgcmVzZXQoeyBpbnB1dE1pc3NpbmcgfTogeyBpbnB1dE1pc3Npbmc6IGJvb2xlYW4gfSkge1xuICAgICAgICBpZiAoIGlucHV0TWlzc2luZyApIHtcbiAgICAgICAgICAgIHRoaXMuYWRkQ2xhc3MoJ2lucHV0LW1pc3NpbmcnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIC8qJHN1Ym1pdFN1YmplY3RCdG5cbiAgICAgICAgIC5hZGRDbGFzcygnaW5hY3RpdmUtYnRuJylcbiAgICAgICAgIC5yZW1vdmVDbGFzcygnYWN0aXZlLWJ0bicpXG4gICAgICAgICAuaHRtbCgnU3VibWl0Jyk7Ki9cbiAgICAgICAgXG4gICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlLnRleHQoJ1N1YmplY3QgSWQnKTtcbiAgICAgICAgdGhpcy5lZGl0YWJsZS50ZXh0KCcnKTtcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBzZW5kRW5kKCkge1xuICAgICAgICByZW1vdGUuZ2V0Q3VycmVudFdpbmRvdygpLndlYkNvbnRlbnRzLnNlbmRJbnB1dEV2ZW50KHtcbiAgICAgICAgICAgIHR5cGUgOiBcImtleURvd25cIixcbiAgICAgICAgICAgIGtleUNvZGUgOiAnRW5kJyxcbiAgICAgICAgICAgIG1vZGlmaWVycyA6IFtdXG4gICAgICAgIH0pXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZG9BdXRvY29tcGxldGUoZXY6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgY29uc29sZS5sb2coJ1xcbmRvQXV0b2NvbXBsZXRlJywgZXYpO1xuICAgICAgICBpZiAoIGV2LmN0cmxLZXkgfHwgWyAnQmFja3NwYWNlJywgJ0hvbWUnLCAnRW5kJywgJ0RlbGV0ZScgXS5pbmNsdWRlcyhldi5rZXkpIHx8IGV2LmtleS5pbmNsdWRlcygnQXJyb3cnKSApIHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCBldi5rZXkgPT09ICdCYWNrc3BhY2UnICkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBCYWNrc3BhY2UsIHJldHVybmluZy4gZWRpdGFibGUgdGV4dCBsZW46ICR7dGhpcy5lZGl0YWJsZS50ZXh0KCkubGVuZ3RofSwgYXV0b2NvbXBsZXRlIHRleHQgbGVuOiAke3RoaXMuYXV0b2NvbXBsZXRlLnRleHQoKS5sZW5ndGh9XG4gICAgICAgICAgICAgICAgYWN0aXZlRWxlbWVudDogJHtkb2N1bWVudC5hY3RpdmVFbGVtZW50LmNsYXNzTmFtZX1gLCBldik7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3Qgb2xkVGV4dCA9IHRoaXMuZWRpdGFibGUudGV4dCgpO1xuICAgICAgICAgICAgICAgIGlmICggb2xkVGV4dC5sZW5ndGggPT09IDAgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2Fybignb2xkVGV4dC5sZW5ndGggPT09IDAsIHByZXZlbnREZWZhdWx0LCBcIlN1YmplY3QgSWRcIiBhbmQgcmV0dXJuJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlLnRleHQoJ1N1YmplY3QgSWQnKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGV2LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuYXV0b2NvbXBsZXRlLnRleHQoJycpO1xuICAgICAgICAgICAgICAgIGNvbnN0IG5ld1RleHQgPSBvbGRUZXh0LnNsaWNlKDAsIG9sZFRleHQubGVuZ3RoIC0gMSk7XG4gICAgICAgICAgICAgICAgaWYgKCBldi5jdHJsS2V5IHx8ICFib29sKG5ld1RleHQpICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oJyFib29sKG5ld1RleHQpIHx8IGN0cmxLZXksIGVkaXRhYmxlKFwiXCIpLCBwcmV2ZW50RGVmYXVsdCwgXCJTdWJqZWN0IElkXCIgYW5kIHJldHVybicpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRhYmxlLnRleHQoJycpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmF1dG9jb21wbGV0ZS50ZXh0KCdTdWJqZWN0IElkJyk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRhYmxlLnRleHQobmV3VGV4dCk7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS53YXJuKCdCYWNrc3BhY2UsIGNoYW5nZWQgZWRpdGFibGUnKTtcbiAgICAgICAgICAgICAgICB0aGlzLnNlbmRFbmQoKTtcbiAgICAgICAgICAgICAgICAvLyBpZiAoIHRoaXMuYXV0b2NvbXBsZXRlLnRleHQoKS5sZW5ndGggPD0gMSApIHtcbiAgICAgICAgICAgICAgICAvLyAgICAgdGhpcy5hdXRvY29tcGxldGUudGV4dCgnU3ViamVjdCBJZCcpO1xuICAgICAgICAgICAgICAgIC8vICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgLy8gfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSBlbHNlIHsgLy8gQXJyb3csIGJhcmUgQ29udHJvbCBldGNcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRnVuY3Rpb25hbCwgcmV0dXJuaW5nJywgZXYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBldi5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICBpZiAoIGV2LmtleSA9PT0gJ1RhYicgKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRhYmxlLnRleHQodGhpcy5lZGl0YWJsZS50ZXh0KCkgKyB0aGlzLmF1dG9jb21wbGV0ZS50ZXh0KCkpO1xuICAgICAgICAgICAgdGhpcy5hdXRvY29tcGxldGUudGV4dCgnJyk7XG4gICAgICAgICAgICB0aGlzLnNlbmRFbmQoKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIGV2LmtleS5tYXRjaCgvXltBLVpdLykgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnTWF0Y2hlZCBeW0EtWl0sIHJldHVybmluZycsIGV2KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICAvKmlmICggZXYua2V5ID09PSAnYScgJiYgZXYuY3RybEtleSApIHtcbiAgICAgICAgIHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCkud2ViQ29udGVudHMuc2VuZElucHV0RXZlbnQoe1xuICAgICAgICAgdHlwZSA6IFwia2V5RG93blwiLFxuICAgICAgICAga2V5Q29kZSA6ICdIb21lJyxcbiAgICAgICAgIG1vZGlmaWVycyA6IFsgXCJzaGlmdFwiIF1cbiAgICAgICAgIH0pXG4gICAgICAgICB9Ki9cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBjb25zdCBvbGRUZXh0ID0gdGhpcy5lZGl0YWJsZS50ZXh0KCkubG93ZXIoKS5yZW1vdmVBbGwoL1teKGEtejAtOXxfKV0vKTtcbiAgICAgICAgbGV0IHR4dDtcbiAgICAgICAgaWYgKCBib29sKG9sZFRleHQpIClcbiAgICAgICAgICAgIHR4dCA9IG9sZFRleHQudG9Mb3dlckNhc2UoKSArIGV2LmtleTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdHh0ID0gZXYua2V5O1xuICAgICAgICB0aGlzLmVkaXRhYmxlLnRleHQodHh0KTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coeyAndGhpcy5lZGl0YWJsZS50ZXh0KCknIDogdGhpcy5lZGl0YWJsZS50ZXh0KCksIHR4dCB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIGlmICggIWJvb2woZWRpdGFibGVUZXh0KSApIHtcbiAgICAgICAgLy8gICAgIHJldHVybiB0aGlzLnJlc2V0KHsgaW5wdXRNaXNzaW5nIDogdHJ1ZSB9KTtcbiAgICAgICAgLy8gfVxuICAgICAgICBcbiAgICAgICAgLy8gYXV0b2NvbXBsZXRlXG4gICAgICAgIFxuICAgICAgICBjb25zdCBzdWJqZWN0U3VnZ2VzdGlvbiA9IHN1YmplY3RzLmZpbmQocyA9PiBzLnN0YXJ0c1dpdGgodHh0KSk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnJlbW92ZUNsYXNzKCdpbnB1dC1taXNzaW5nJyk7XG4gICAgICAgIC8qJHN1Ym1pdFN1YmplY3RCdG5cbiAgICAgICAgIC5yZW1vdmVDbGFzcygnaW5hY3RpdmUtYnRuJylcbiAgICAgICAgIC5hZGRDbGFzcygnYWN0aXZlLWJ0bicpXG4gICAgICAgICAuaHRtbChlZGl0YWJsZVRleHQpOyovXG4gICAgICAgIC8vIHRoaXMuZWRpdGFibGUudGV4dChlZGl0YWJsZVRleHQpO1xuICAgICAgICBpZiAoIHN1YmplY3RTdWdnZXN0aW9uICkge1xuICAgICAgICAgICAgdGhpcy5hdXRvY29tcGxldGUuaHRtbChzdWJqZWN0U3VnZ2VzdGlvbi5zdWJzdHIodHh0Lmxlbmd0aCkpO1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdjaGFuZ2VkIGF1dG9jb21wbGV0ZScpO1xuICAgICAgICAgICAgdGhpcy5zZW5kRW5kKClcbiAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCB0aGlzLmF1dG9jb21wbGV0ZS5odG1sKCkgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5hdXRvY29tcGxldGUuaHRtbCgnJyk7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCdyZXNldCBhdXRvY29tcGxldGUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIHRoaXMuc2VuZEVuZCgpXG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyh7IHR4dCwgc3ViamVjdFN1Z2dlc3Rpb24sICd0aGlzLmF1dG9jb21wbGV0ZS50ZXh0KCknIDogdGhpcy5hdXRvY29tcGxldGUudGV4dCgpIH0pO1xuICAgICAgICAvLyB0aGlzLmF1dG9jb21wbGV0ZVxuICAgICAgICAvLyAgICAgLnRleHQoc3ViamVjdFN1Z2dlc3Rpb24gPyBzdWJqZWN0U3VnZ2VzdGlvbi5zdWJzdHIoZWRpdGFibGVUZXh0Lmxlbmd0aCkgOiAnJyk7XG4gICAgICAgIC8vIE15QWxlcnQuY2xvc2UoKTtcbiAgICAgICAgY29uc29sZS5sb2coJ1xcbicpO1xuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIG9uS2V5RG93bihldjogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICBjb25zb2xlLmxvZygnb25LZXlEb3duJywgZXYpO1xuICAgICAgICBpZiAoIGV2LmtleSA9PT0gJ1RhYicgKSB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5lZGl0YWJsZS50ZXh0KCkgKyB0aGlzLmF1dG9jb21wbGV0ZS50ZXh0KCk7XG4gICAgICAgICAgICB0aGlzLmVkaXRhYmxlLnRleHQodmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5hdXRvY29tcGxldGUudGV4dCgnJyk7XG4gICAgICAgICAgICAvLyAkc3VibWl0U3ViamVjdEJ0bi5odG1sKHZhbHVlKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuXG5jbGFzcyBTdWJqZWN0RGl2IGV4dGVuZHMgRGl2IHtcbiAgICBpbnB1dDogSW5wdXQ7XG4gICAgXG4gICAgXG4gICAgY29uc3RydWN0b3IoeyBpZCB9KSB7XG4gICAgICAgIHN1cGVyKHsgaWQgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBpbnB1dCA9IG5ldyBJbnB1dCgpO1xuICAgICAgICB0aGlzLmNhY2hlQXBwZW5kKHsgaW5wdXQgfSlcbiAgICB9XG4gICAgXG4gICAgXG59XG5cbmNvbnN0IHN1YmplY3REaXYgPSBuZXcgU3ViamVjdERpdih7IGlkIDogJ3N1YmplY3RfZGl2JyB9KTtcbmNvbnN0IHN1YmplY3RzID0gR2xvYi5CaWdDb25maWcuc3ViamVjdHM7XG5leHBvcnQgZGVmYXVsdCBzdWJqZWN0RGl2O1xuXG4iXX0=