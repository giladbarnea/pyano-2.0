"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
const path = require("path");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const configSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        configSection.inputAndSubmitFlex.submitButton.click(() => this.onConfigSubmit(configs, subconfig));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submitButton: subjectSubmit } = subjectSection.inputAndSubmitFlex;
        subjectSubmit.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        const currentTruth = subconfig.truth;
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${currentTruth.name}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles,
            illegalRegex: /[^(a-z0-9A-Z|_)]/
        });
        truthSection.inputAndSubmitFlex.submitButton.click(() => this.onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles));
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, configSection, subjectSection, truthSection });
    }
    async onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles) {
        const { submitButton: truthSubmit, inputElem: truthInput } = this.truthSection.inputAndSubmitFlex;
        let value = truthInput.value;
        let valueLower = value.lower();
        if (valueLower.endsWithAny('_on', '_off')) {
            console.warn(`onTruthSubmit value not a base txt: ${valueLower}. Cutting`);
            value = value.upTo('_', true);
            valueLower = value.lower();
        }
        console.log('onTruthSubmit', { value, currentTruth });
        if (currentTruth.name.lower() === valueLower) {
            MyAlert_1.default.small.info(`${currentTruth.name} was already the chosen truth`);
            truthSubmit.replaceClass('active', 'inactive');
            return truthInput.value = '';
        }
        for (let truthName of truthsWith3TxtFiles) {
            let truthNameLower = truthName.lower();
            if (truthNameLower === valueLower) {
                subconfig.truth_file = truthName;
                truthInput.value = '';
                truthInput.placeholder = `Current: ${truthName}`;
                truthSubmit.replaceClass('active', 'inactive');
                MyAlert_1.default.small.success(`Using truth: "${truthName}"`);
                await util.wait(3000);
                return util.reloadPage();
            }
        }
        return MyAlert_1.default.small.warning(`Either this truth doesn't exist completely, or doesn't have its 3 associated .txt files. Please choose an existing one.`);
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submitButton: subjectSubmit, inputElem: subjectInput } = this.subjectSection.inputAndSubmitFlex;
        const value = subjectInput.value;
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder = `Current: ${value}`;
        }
        subjectSubmit.replaceClass('active', 'inactive');
        subjectInput.value = '';
    }
    async onConfigSubmit(configs, subconfig) {
        const { submitButton: configSubmit, inputElem: configInput } = this.configSection.inputAndSubmitFlex;
        let file = configInput.value;
        console.log('onConfigSubmit,', file);
        try {
            MyStore_1.Subconfig.validateName(file);
        }
        catch (e) {
            if (e.message === 'ExtensionError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            }
            if (e.message === 'BasenameError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning(`Insert just a file name, not a path with slashes. eg: "${path.basename(file)}"`);
            }
        }
        configInput.removeClass('invalid');
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
            configSubmit.replaceClass('active', 'inactive');
            return configInput.value = '';
        }
        let action = "create";
        for (let cfg of configs) {
            if (cfg.lower() === fileLower) {
                action = await MyAlert_1.default.big.threeButtons({
                    title: `${cfg} already exists, what do you want to do?`,
                    confirmButtonText: 'Use it',
                    thirdButtonText: 'Overwrite it',
                    thirdButtonType: "warning"
                });
                if (action === "cancel") {
                    return;
                }
                file = cfg;
                break;
            }
        }
        const ext = path.extname(file);
        const experimentType = ext.slice(1);
        Glob_1.default.BigConfig.experiment_type = experimentType;
        console.log({ action, file });
        if (action === "confirm") {
            Glob_1.default.BigConfig.setSubconfig(file);
            MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('active', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
        if (action === "create" || action === "third") {
            Glob_1.default.BigConfig.setSubconfig(file, subconfig);
            let verb = action === "third" ? 'overwritten' : 'created';
            MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('active', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
    }
}
console.group('pages.New.sections.settings.ts');
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
console.groupEnd();
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBK0Q7QUFDL0Qsc0NBQXNDO0FBQ3RDLDhDQUFxRjtBQUVyRiw2QkFBNkI7QUFFN0IsTUFBTSxXQUFZLFNBQVEsU0FBRztJQUt6QixZQUFZLEVBQUUsRUFBRSxFQUFFO1FBQ2QsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUtkLE1BQU0sU0FBUyxHQUFjLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDM0QsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNELE1BQU0sYUFBYSxHQUFHLElBQUksb0JBQVksQ0FBQztZQUNuQyxXQUFXLEVBQUcsWUFBWSxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQzFDLE1BQU0sRUFBRyxhQUFhO1lBQ3RCLFdBQVcsRUFBRyxPQUFPO1NBRXhCLENBQUMsQ0FBQztRQUVILGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFHbkcsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFFekMsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztRQUN6QyxNQUFNLGNBQWMsR0FBRyxJQUFJLG9CQUFZLENBQUM7WUFDcEMsV0FBVyxFQUFHLFlBQVksY0FBYyxFQUFFO1lBQzFDLE1BQU0sRUFBRyxTQUFTO1lBQ2xCLFdBQVcsRUFBRyxRQUFRO1NBQ3pCLENBQUMsQ0FBQztRQUNILE1BQU0sRUFBRSxZQUFZLEVBQUcsYUFBYSxFQUFFLEdBQUcsY0FBYyxDQUFDLGtCQUFrQixDQUFDO1FBQzNFLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUczRSxNQUFNLG1CQUFtQixHQUFHLGdDQUFzQixFQUFFLENBQUM7UUFDckQsTUFBTSxZQUFZLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQztRQUNyQyxNQUFNLFlBQVksR0FBRyxJQUFJLG9CQUFZLENBQUM7WUFDbEMsV0FBVyxFQUFHLFlBQVksWUFBWSxDQUFDLElBQUksRUFBRTtZQUM3QyxNQUFNLEVBQUcsT0FBTztZQUNoQixXQUFXLEVBQUcsbUJBQW1CO1lBQ2pDLFlBQVksRUFBRyxrQkFBa0I7U0FDcEMsQ0FBQyxDQUFDO1FBRUgsWUFBWSxDQUFDLGtCQUFrQixDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixDQUFDLENBQUMsQ0FBQztRQUUzSCxNQUFNLFFBQVEsR0FBRyxVQUFJLENBQUMsRUFBRSxHQUFHLEVBQUcsSUFBSSxFQUFFLElBQUksRUFBRyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFBO0lBRS9FLENBQUM7SUFFTyxLQUFLLENBQUMsYUFBYSxDQUFDLFlBQW1CLEVBQUUsU0FBb0IsRUFBRSxtQkFBNkI7UUFDaEcsTUFBTSxFQUFFLFlBQVksRUFBRyxXQUFXLEVBQUUsU0FBUyxFQUFHLFVBQVUsRUFBRSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsa0JBQWtCLENBQUM7UUFDcEcsSUFBSSxLQUFLLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQztRQUM3QixJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDL0IsSUFBSyxVQUFVLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsRUFBRztZQUN6QyxPQUFPLENBQUMsSUFBSSxDQUFDLHVDQUF1QyxVQUFVLFdBQVcsQ0FBQyxDQUFDO1lBQzNFLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUM5QixVQUFVLEdBQUcsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQzlCO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztRQUd0RCxJQUFLLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssVUFBVSxFQUFHO1lBQzVDLGlCQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLFlBQVksQ0FBQyxJQUFJLCtCQUErQixDQUFDLENBQUM7WUFDeEUsV0FBVyxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDL0MsT0FBTyxVQUFVLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztTQUVoQztRQUdELEtBQU0sSUFBSSxTQUFTLElBQUksbUJBQW1CLEVBQUc7WUFDekMsSUFBSSxjQUFjLEdBQUcsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ3ZDLElBQUssY0FBYyxLQUFLLFVBQVUsRUFBRztnQkFDakMsU0FBUyxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUM7Z0JBQ2pDLFVBQVUsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO2dCQUN0QixVQUFVLENBQUMsV0FBVyxHQUFHLFlBQVksU0FBUyxFQUFFLENBQUM7Z0JBQ2pELFdBQVcsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO2dCQUMvQyxpQkFBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsaUJBQWlCLFNBQVMsR0FBRyxDQUFDLENBQUM7Z0JBQ3JELE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDdEIsT0FBTyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7YUFDNUI7U0FDSjtRQUVELE9BQU8saUJBQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLHlIQUF5SCxDQUFDLENBQUE7SUFHM0osQ0FBQztJQUVPLGVBQWUsQ0FBQyxjQUFzQixFQUFFLFNBQW9CO1FBQ2hFLE1BQU0sRUFBRSxZQUFZLEVBQUcsYUFBYSxFQUFFLFNBQVMsRUFBRyxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGtCQUFrQixDQUFDO1FBQzFHLE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUM7UUFFakMsSUFBSyxjQUFjLEtBQUssS0FBSyxFQUFHO1lBQzVCLGlCQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsaUNBQWlDLENBQUMsQ0FBQTtTQUN6RTthQUFNO1lBQ0gsU0FBUyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7WUFDMUIsaUJBQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGdCQUFnQixLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ2hELFlBQVksQ0FBQyxXQUFXLEdBQUcsWUFBWSxLQUFLLEVBQUUsQ0FBQztTQUVsRDtRQUNELGFBQWEsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2pELFlBQVksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBRzVCLENBQUM7SUFFTyxLQUFLLENBQUMsY0FBYyxDQUFDLE9BQWlCLEVBQUUsU0FBb0I7UUFDaEUsTUFBTSxFQUFFLFlBQVksRUFBRyxZQUFZLEVBQUUsU0FBUyxFQUFHLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUM7UUFDdkcsSUFBSSxJQUFJLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQztRQUU3QixPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBRXJDLElBQUk7WUFDQSxtQkFBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNoQztRQUFDLE9BQVEsQ0FBQyxFQUFHO1lBQ1YsSUFBSyxDQUFDLENBQUMsT0FBTyxLQUFLLGdCQUFnQixFQUFHO2dCQUNsQyxXQUFXLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNoQyxPQUFPLGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO2FBQ2pGO1lBQ0QsSUFBSyxDQUFDLENBQUMsT0FBTyxLQUFLLGVBQWUsRUFBRztnQkFDakMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFDaEMsT0FBTyxpQkFBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsMERBQTBELElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ2xIO1NBQ0o7UUFHRCxXQUFXLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRW5DLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMvQixJQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssU0FBUyxFQUFHO1lBQ3hDLGlCQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxJQUFJLDhCQUE4QixDQUFDLENBQUM7WUFDcEUsWUFBWSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDaEQsT0FBTyxXQUFXLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztTQUNqQztRQUdELElBQUksTUFBTSxHQUFtQyxRQUFRLENBQUM7UUFFdEQsS0FBTSxJQUFJLEdBQUcsSUFBSSxPQUFPLEVBQUc7WUFDdkIsSUFBSyxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssU0FBUyxFQUFHO2dCQUM3QixNQUFNLEdBQUcsTUFBTSxpQkFBTyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7b0JBQ3BDLEtBQUssRUFBRyxHQUFHLEdBQUcsMENBQTBDO29CQUN4RCxpQkFBaUIsRUFBRyxRQUFRO29CQUM1QixlQUFlLEVBQUcsY0FBYztvQkFDaEMsZUFBZSxFQUFHLFNBQVM7aUJBQzlCLENBQUMsQ0FBQztnQkF3QkgsSUFBSyxNQUFNLEtBQUssUUFBUSxFQUFHO29CQUN2QixPQUFPO2lCQUNWO2dCQUVELElBQUksR0FBRyxHQUFHLENBQUM7Z0JBQ1gsTUFBTTthQUdUO1NBQ0o7UUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQy9CLE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFtQixDQUFDO1FBQ3RELGNBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxHQUFHLGNBQWMsQ0FBQztRQUNoRCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDOUIsSUFBSyxNQUFNLEtBQUssU0FBUyxFQUFHO1lBQ3hCLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ2xDLGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNqRCxXQUFXLENBQUMsV0FBVyxHQUFHLFlBQVksSUFBSSxFQUFFLENBQUM7WUFDN0MsWUFBWSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDaEQsV0FBVyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDdkIsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNyQjtRQUNELElBQUssTUFBTSxLQUFLLFFBQVEsSUFBSSxNQUFNLEtBQUssT0FBTyxFQUFHO1lBQzdDLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxTQUFTLENBQUMsQ0FBQztZQUM3QyxJQUFJLElBQUksR0FBRyxNQUFNLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztZQUMxRCxpQkFBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLEtBQUssSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNsRCxXQUFXLENBQUMsV0FBVyxHQUFHLFlBQVksSUFBSSxFQUFFLENBQUM7WUFDN0MsWUFBWSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDaEQsV0FBVyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDdkIsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNyQjtJQUdMLENBQUM7Q0FFSjtBQUVELE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztBQUNoRCxNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRyxjQUFjLEVBQUUsQ0FBQyxDQUFDO0FBQzdELE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUNuQixrQkFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyAqICBwYWdlcy9OZXcvc2VjdGlvbnMvc2V0dGluZ3NcblxuLyoqXG4gKiBpbXBvcnQgc2VjdGlvbnMgZnJvbSBcIi4vc2VjdGlvbnNcIlxuICogc2VjdGlvbnMuc2V0dGluZ3MqL1xuaW1wb3J0IHsgZWxlbSwgRGl2LCBidXR0b24sIElucHV0LCBCdXR0b24gfSBmcm9tIFwiLi4vLi4vLi4vYmhlXCI7XG5cbmltcG9ydCB7IElucHV0U2VjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGUvZXh0cmFcIjtcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi8uLi9HbG9iXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcblxuaW1wb3J0IE15QWxlcnQsIHsgQ3JlYXRlQ29uZmlybUNhbmNlbCB9IGZyb20gJy4uLy4uLy4uL015QWxlcnQnXG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi8uLi91dGlsXCI7XG5pbXBvcnQgeyBFeHBlcmltZW50VHlwZSwgZ2V0VHJ1dGhzV2l0aDNUeHRGaWxlcywgU3ViY29uZmlnIH0gZnJvbSBcIi4uLy4uLy4uL015U3RvcmVcIjtcbmltcG9ydCB7IFRydXRoIH0gZnJvbSBcIi4uLy4uLy4uL1RydXRoXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmNsYXNzIFNldHRpbmdzRGl2IGV4dGVuZHMgRGl2IHtcbiAgICBwcml2YXRlIGNvbmZpZ1NlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBwcml2YXRlIHN1YmplY3RTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG4gICAgcHJpdmF0ZSB0cnV0aFNlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBcbiAgICBjb25zdHJ1Y3Rvcih7IGlkIH0pIHtcbiAgICAgICAgc3VwZXIoeyBpZCB9KTtcbiAgICAgICAgLy8gKioqICBGaWxlXG4gICAgICAgIC8vIGNvbnN0IGV4cGVyaW1lbnRUeXBlID0gR2xvYi5CaWdDb25maWcuZXhwZXJpbWVudF90eXBlO1xuICAgICAgICAvLyBjb25zdCBzdWJjb25maWdGaWxlOiBzdHJpbmcgPSBHbG9iLkJpZ0NvbmZpZ1tgJHtleHBlcmltZW50VHlwZX1fZmlsZWBdO1xuICAgICAgICAvLyBjb25zdCBzdWJjb25maWc6IFN1YmNvbmZpZyA9IEdsb2IuQmlnQ29uZmlnW2V4cGVyaW1lbnRUeXBlXTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnOiBTdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZy5nZXRTdWJjb25maWcoKTtcbiAgICAgICAgY29uc3QgY29uZmlnczogc3RyaW5nW10gPSBmcy5yZWFkZGlyU3luYyhDT05GSUdTX1BBVEhfQUJTKTtcbiAgICAgICAgY29uc3QgY29uZmlnU2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXIgOiBgQ3VycmVudDogJHtzdWJjb25maWcubmFtZX1gLFxuICAgICAgICAgICAgaDN0ZXh0IDogYENvbmZpZyBGaWxlYCxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zIDogY29uZmlncyxcbiAgICAgICAgICAgIFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbmZpZ1NlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4LnN1Ym1pdEJ1dHRvbi5jbGljaygoKSA9PiB0aGlzLm9uQ29uZmlnU3VibWl0KGNvbmZpZ3MsIHN1YmNvbmZpZykpO1xuICAgICAgICBcbiAgICAgICAgLy8gKioqICBTdWJqZWN0XG4gICAgICAgIGNvbnN0IHN1YmplY3RzID0gR2xvYi5CaWdDb25maWcuc3ViamVjdHM7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBjdXJyZW50U3ViamVjdCA9IHN1YmNvbmZpZy5zdWJqZWN0O1xuICAgICAgICBjb25zdCBzdWJqZWN0U2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXIgOiBgQ3VycmVudDogJHtjdXJyZW50U3ViamVjdH1gLFxuICAgICAgICAgICAgaDN0ZXh0IDogJ1N1YmplY3QnLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnMgOiBzdWJqZWN0c1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiBzdWJqZWN0U3VibWl0IH0gPSBzdWJqZWN0U2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIHN1YmplY3RTdWJtaXQuY2xpY2soKCkgPT4gdGhpcy5vblN1YmplY3RTdWJtaXQoY3VycmVudFN1YmplY3QsIHN1YmNvbmZpZykpO1xuICAgICAgICBcbiAgICAgICAgLy8gKioqICBUcnV0aFxuICAgICAgICBjb25zdCB0cnV0aHNXaXRoM1R4dEZpbGVzID0gZ2V0VHJ1dGhzV2l0aDNUeHRGaWxlcygpO1xuICAgICAgICBjb25zdCBjdXJyZW50VHJ1dGggPSBzdWJjb25maWcudHJ1dGg7XG4gICAgICAgIGNvbnN0IHRydXRoU2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXIgOiBgQ3VycmVudDogJHtjdXJyZW50VHJ1dGgubmFtZX1gLFxuICAgICAgICAgICAgaDN0ZXh0IDogJ1RydXRoJyxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zIDogdHJ1dGhzV2l0aDNUeHRGaWxlcyxcbiAgICAgICAgICAgIGlsbGVnYWxSZWdleCA6IC9bXihhLXowLTlBLVp8XyldL1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHRydXRoU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXguc3VibWl0QnV0dG9uLmNsaWNrKCgpID0+IHRoaXMub25UcnV0aFN1Ym1pdChjdXJyZW50VHJ1dGgsIHN1YmNvbmZpZywgdHJ1dGhzV2l0aDNUeHRGaWxlcykpO1xuICAgICAgICBcbiAgICAgICAgY29uc3Qgc3VidGl0bGUgPSBlbGVtKHsgdGFnIDogJ2gyJywgdGV4dCA6ICdTZXR0aW5ncycgfSk7XG4gICAgICAgIHRoaXMuY2FjaGVBcHBlbmQoeyBzdWJ0aXRsZSwgY29uZmlnU2VjdGlvbiwgc3ViamVjdFNlY3Rpb24sIHRydXRoU2VjdGlvbiB9KVxuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBhc3luYyBvblRydXRoU3VibWl0KGN1cnJlbnRUcnV0aDogVHJ1dGgsIHN1YmNvbmZpZzogU3ViY29uZmlnLCB0cnV0aHNXaXRoM1R4dEZpbGVzOiBzdHJpbmdbXSkge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdEJ1dHRvbiA6IHRydXRoU3VibWl0LCBpbnB1dEVsZW0gOiB0cnV0aElucHV0IH0gPSB0aGlzLnRydXRoU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGxldCB2YWx1ZSA9IHRydXRoSW5wdXQudmFsdWU7XG4gICAgICAgIGxldCB2YWx1ZUxvd2VyID0gdmFsdWUubG93ZXIoKTtcbiAgICAgICAgaWYgKCB2YWx1ZUxvd2VyLmVuZHNXaXRoQW55KCdfb24nLCAnX29mZicpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBvblRydXRoU3VibWl0IHZhbHVlIG5vdCBhIGJhc2UgdHh0OiAke3ZhbHVlTG93ZXJ9LiBDdXR0aW5nYCk7XG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnVwVG8oJ18nLCB0cnVlKTtcbiAgICAgICAgICAgIHZhbHVlTG93ZXIgPSB2YWx1ZS5sb3dlcigpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKCdvblRydXRoU3VibWl0JywgeyB2YWx1ZSwgY3VycmVudFRydXRoIH0pO1xuICAgICAgICBcbiAgICAgICAgLy8gLyBDaG9zZW4gaXMgYWxyZWFkeSBjdXJyZW50bHkgc2V0XG4gICAgICAgIGlmICggY3VycmVudFRydXRoLm5hbWUubG93ZXIoKSA9PT0gdmFsdWVMb3dlciApIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50VHJ1dGgubmFtZX0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiB0cnV0aGApO1xuICAgICAgICAgICAgdHJ1dGhTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIHJldHVybiB0cnV0aElucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gLyBEaWZmZXJlbnQgZnJvbSBjdXJyZW50LCBjaGVjayBpZiBleGlzdHMgaW4gXCJ3aG9sZVwiIHRydXRoc1xuICAgICAgICBmb3IgKCBsZXQgdHJ1dGhOYW1lIG9mIHRydXRoc1dpdGgzVHh0RmlsZXMgKSB7XG4gICAgICAgICAgICBsZXQgdHJ1dGhOYW1lTG93ZXIgPSB0cnV0aE5hbWUubG93ZXIoKTtcbiAgICAgICAgICAgIGlmICggdHJ1dGhOYW1lTG93ZXIgPT09IHZhbHVlTG93ZXIgKSB7XG4gICAgICAgICAgICAgICAgc3ViY29uZmlnLnRydXRoX2ZpbGUgPSB0cnV0aE5hbWU7XG4gICAgICAgICAgICAgICAgdHJ1dGhJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICAgICAgICAgIHRydXRoSW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHt0cnV0aE5hbWV9YDtcbiAgICAgICAgICAgICAgICB0cnV0aFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgVXNpbmcgdHJ1dGg6IFwiJHt0cnV0aE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIC8gRWl0aGVyIGV4aXN0cyBpbiBcInBhcnRpYWxcIiB0cnV0aHMgb3Igbm90IGF0IGFsbFxuICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKGBFaXRoZXIgdGhpcyB0cnV0aCBkb2Vzbid0IGV4aXN0IGNvbXBsZXRlbHksIG9yIGRvZXNuJ3QgaGF2ZSBpdHMgMyBhc3NvY2lhdGVkIC50eHQgZmlsZXMuIFBsZWFzZSBjaG9vc2UgYW4gZXhpc3Rpbmcgb25lLmApXG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBvblN1YmplY3RTdWJtaXQoY3VycmVudFN1YmplY3Q6IHN0cmluZywgc3ViY29uZmlnOiBTdWJjb25maWcpIHtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiBzdWJqZWN0U3VibWl0LCBpbnB1dEVsZW0gOiBzdWJqZWN0SW5wdXQgfSA9IHRoaXMuc3ViamVjdFNlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4O1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHN1YmplY3RJbnB1dC52YWx1ZTtcbiAgICAgICAgXG4gICAgICAgIGlmICggY3VycmVudFN1YmplY3QgPT09IHZhbHVlICkge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke2N1cnJlbnRTdWJqZWN0fSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIHN1YmplY3RgKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3ViY29uZmlnLnN1YmplY3QgPSB2YWx1ZTtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgU3ViamVjdCBzZXQ6ICR7dmFsdWV9LmApO1xuICAgICAgICAgICAgc3ViamVjdElucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7dmFsdWV9YDtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHN1YmplY3RTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgc3ViamVjdElucHV0LnZhbHVlID0gJyc7XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBhc3luYyBvbkNvbmZpZ1N1Ym1pdChjb25maWdzOiBzdHJpbmdbXSwgc3ViY29uZmlnOiBTdWJjb25maWcpIHtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiBjb25maWdTdWJtaXQsIGlucHV0RWxlbSA6IGNvbmZpZ0lucHV0IH0gPSB0aGlzLmNvbmZpZ1NlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4O1xuICAgICAgICBsZXQgZmlsZSA9IGNvbmZpZ0lucHV0LnZhbHVlO1xuICAgICAgICAvLyBjb25zdCBbIGZpbGVuYW1lLCBleHQgXSA9IG15ZnMuc3BsaXRfZXh0KGZpbGUpO1xuICAgICAgICBjb25zb2xlLmxvZygnb25Db25maWdTdWJtaXQsJywgZmlsZSk7XG4gICAgICAgIC8vLy8gQ2hlY2sgZm9yIGJhZCBleHRlbnNpb24gb3IgYmFkIGZpbGVuYW1lXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBTdWJjb25maWcudmFsaWRhdGVOYW1lKGZpbGUpO1xuICAgICAgICB9IGNhdGNoICggZSApIHtcbiAgICAgICAgICAgIGlmICggZS5tZXNzYWdlID09PSAnRXh0ZW5zaW9uRXJyb3InICkge1xuICAgICAgICAgICAgICAgIGNvbmZpZ0lucHV0LmFkZENsYXNzKCdpbnZhbGlkJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwud2FybmluZygnRmlsZSBuYW1lIG11c3QgZW5kIHdpdGggZWl0aGVyIC5leGFtIG9yIC50ZXN0Jyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIGUubWVzc2FnZSA9PT0gJ0Jhc2VuYW1lRXJyb3InICkge1xuICAgICAgICAgICAgICAgIGNvbmZpZ0lucHV0LmFkZENsYXNzKCdpbnZhbGlkJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwud2FybmluZyhgSW5zZXJ0IGp1c3QgYSBmaWxlIG5hbWUsIG5vdCBhIHBhdGggd2l0aCBzbGFzaGVzLiBlZzogXCIke3BhdGguYmFzZW5hbWUoZmlsZSl9XCJgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8vLyBFeHRlbnNpb24gYW5kIGZpbGUgbmFtZSBvazsgY2hlY2sgaWYgdXNlciBjaG9zZSB3aGF0J3MgY3VycmVudGx5IHNldFxuICAgICAgICBjb25maWdJbnB1dC5yZW1vdmVDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgZmlsZUxvd2VyID0gZmlsZS5sb3dlcigpO1xuICAgICAgICBpZiAoIHN1YmNvbmZpZy5uYW1lLmxvd2VyKCkgPT09IGZpbGVMb3dlciApIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtzdWJjb25maWcubmFtZX0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBmaWxlYCk7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIHJldHVybiBjb25maWdJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLy8vIENob3NlbiBzb21ldGhpbmcgZWxzZTsgY2hlY2sgaWYgZXhpc3RzXG4gICAgICAgIGxldCBhY3Rpb246IENyZWF0ZUNvbmZpcm1DYW5jZWwgfCBcImNyZWF0ZVwiID0gXCJjcmVhdGVcIjsgLy8gY3JlYXRlIChkb2VzbnQgZXhpc3QpLCBjb25maXJtICh1c2UgZXhpc3RpbmcpLCBvdmVyd3JpdGUgKG9uIHRvcCBvZiBleGlzdGluZyksIGNhbmNlbFxuICAgICAgICBcbiAgICAgICAgZm9yICggbGV0IGNmZyBvZiBjb25maWdzICkge1xuICAgICAgICAgICAgaWYgKCBjZmcubG93ZXIoKSA9PT0gZmlsZUxvd2VyICkge1xuICAgICAgICAgICAgICAgIGFjdGlvbiA9IGF3YWl0IE15QWxlcnQuYmlnLnRocmVlQnV0dG9ucyh7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlIDogYCR7Y2ZnfSBhbHJlYWR5IGV4aXN0cywgd2hhdCBkbyB5b3Ugd2FudCB0byBkbz9gLFxuICAgICAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dCA6ICdVc2UgaXQnLFxuICAgICAgICAgICAgICAgICAgICB0aGlyZEJ1dHRvblRleHQgOiAnT3ZlcndyaXRlIGl0JyxcbiAgICAgICAgICAgICAgICAgICAgdGhpcmRCdXR0b25UeXBlIDogXCJ3YXJuaW5nXCJcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBNeUFsZXJ0LmJpZy5ibG9ja2luZyh7XG4gICAgICAgICAgICAgICAgIHRpdGxlIDogYCR7Y2ZnfSBhbHJlYWR5IGV4aXN0cywgd2hhdCBkbyB5b3Ugd2FudCB0byBkbz9gLFxuICAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dCA6ICdVc2UgaXQnLFxuICAgICAgICAgICAgICAgICBvbkJlZm9yZU9wZW4gOiAobW9kYWw6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgIGxldCBlbCA9IGVsZW0oeyBodG1sRWxlbWVudCA6IG1vZGFsLCBjaGlsZHJlbiA6IHsgYWN0aW9ucyA6ICcuc3dhbDItYWN0aW9ucycgfSB9KTtcbiAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICBlbC5hY3Rpb25zLmFwcGVuZChcbiAgICAgICAgICAgICAgICAgYnV0dG9uKHsgY2xzIDogXCJzd2FsMi1jb25maXJtIHN3YWwyLXN0eWxlZCB3YXJuXCIsIGh0bWwgOiAnT3ZlcndyaXRlIGl0JyB9KVxuICAgICAgICAgICAgICAgICAuYXR0cih7IHR5cGUgOiAnYnV0dG9uJyB9KVxuICAgICAgICAgICAgICAgICAuY3NzKHsgYmFja2dyb3VuZENvbG9yIDogJyNGRkM2NkQnLCBjb2xvciA6ICdibGFjaycgfSlcbiAgICAgICAgICAgICAgICAgLmNsaWNrKChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAvLyBcIk92ZXJ3cml0ZSBpdFwiXG4gICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwib3ZlcndyaXRlXCI7XG4gICAgICAgICAgICAgICAgIG92ZXJ3cml0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgIGZpbGUgPSBjZmc7IC8vIG1hdGNoIGNhc2VcbiAgICAgICAgICAgICAgICAgTXlBbGVydC5jbGlja0NhbmNlbCgpO1xuICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgaWYgKCBhY3Rpb24gPT09IFwiY2FuY2VsXCIgKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8vLyBcIk92ZXJ3cml0ZVwiIG9yIFwiVXNlIGl0XCJcbiAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8vLyBFaXRoZXIgZXhpc3RzIHRoZW4gbG9hZCBvciBvdmVyd3JpdGUgaXQsIG9yIGNvbXBsZXRlbHkgbmV3XG4gICAgICAgIGNvbnN0IGV4dCA9IHBhdGguZXh0bmFtZShmaWxlKTtcbiAgICAgICAgY29uc3QgZXhwZXJpbWVudFR5cGUgPSBleHQuc2xpY2UoMSkgYXMgRXhwZXJpbWVudFR5cGU7XG4gICAgICAgIEdsb2IuQmlnQ29uZmlnLmV4cGVyaW1lbnRfdHlwZSA9IGV4cGVyaW1lbnRUeXBlO1xuICAgICAgICBjb25zb2xlLmxvZyh7IGFjdGlvbiwgZmlsZSB9KTtcbiAgICAgICAgaWYgKCBhY3Rpb24gPT09IFwiY29uZmlybVwiICkgeyAvLyBFeGlzdHMsIFwiVXNlIGl0XCJcbiAgICAgICAgICAgIEdsb2IuQmlnQ29uZmlnLnNldFN1YmNvbmZpZyhmaWxlKTtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnIGxvYWRlZDogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7ZmlsZX1gO1xuICAgICAgICAgICAgY29uZmlnU3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICBjb25maWdJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KDMwMDApO1xuICAgICAgICAgICAgdXRpbC5yZWxvYWRQYWdlKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCBhY3Rpb24gPT09IFwiY3JlYXRlXCIgfHwgYWN0aW9uID09PSBcInRoaXJkXCIgKSB7XG4gICAgICAgICAgICBHbG9iLkJpZ0NvbmZpZy5zZXRTdWJjb25maWcoZmlsZSwgc3ViY29uZmlnKTtcbiAgICAgICAgICAgIGxldCB2ZXJiID0gYWN0aW9uID09PSBcInRoaXJkXCIgPyAnb3ZlcndyaXR0ZW4nIDogJ2NyZWF0ZWQnO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBDb25maWcgJHt2ZXJifTogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7ZmlsZX1gO1xuICAgICAgICAgICAgY29uZmlnU3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICBjb25maWdJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KDMwMDApO1xuICAgICAgICAgICAgdXRpbC5yZWxvYWRQYWdlKCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbn1cblxuY29uc29sZS5ncm91cCgncGFnZXMuTmV3LnNlY3Rpb25zLnNldHRpbmdzLnRzJyk7XG5jb25zdCBzZXR0aW5nc0RpdiA9IG5ldyBTZXR0aW5nc0Rpdih7IGlkIDogJ3NldHRpbmdzX2RpdicgfSk7XG5jb25zb2xlLmdyb3VwRW5kKCk7XG5leHBvcnQgZGVmYXVsdCBzZXR0aW5nc0RpdjtcblxuIl19