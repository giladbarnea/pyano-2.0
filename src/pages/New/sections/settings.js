"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
const path = require("path");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const configSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        configSection.inputAndSubmitFlex.submitButton.click(() => this.onConfigSubmit(configs, subconfig));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submitButton: subjectSubmit } = subjectSection.inputAndSubmitFlex;
        subjectSubmit.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        const currentTruth = subconfig.truth;
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${currentTruth.name}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles,
            illegalRegex: /[^(a-z0-9A-Z|_)]/
        });
        truthSection.inputAndSubmitFlex.submitButton.click(() => this.onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles));
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, configSection, subjectSection, truthSection });
    }
    async onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles) {
        const { submitButton: truthSubmit, inputElem: truthInput } = this.truthSection.inputAndSubmitFlex;
        let value = truthInput.value;
        let valueLower = value.lower();
        if (valueLower.endsWithAny('_on', '_off')) {
            console.warn(`onTruthSubmit value not a base txt: ${valueLower}. Cutting`);
            value = value.upTo('_', true);
            valueLower = value.lower();
        }
        console.log('onTruthSubmit', { value, currentTruth });
        if (currentTruth.name.lower() === valueLower) {
            MyAlert_1.default.small.info(`${currentTruth.name} was already the chosen truth`);
            truthSubmit.replaceClass('green', 'inactive');
            return truthInput.value = '';
        }
        for (let truthName of truthsWith3TxtFiles) {
            let truthNameLower = truthName.lower();
            if (truthNameLower === valueLower) {
                subconfig.truth_file = truthName;
                truthInput.value = '';
                truthInput.placeholder = `Current: ${truthName}`;
                truthSubmit.replaceClass('green', 'inactive');
                MyAlert_1.default.small.success(`Using truth: "${truthName}"`);
                await util.wait(3000);
                return util.reloadPage();
            }
        }
        return MyAlert_1.default.small.warning(`Either this truth doesn't exist completely, or doesn't have its 3 associated .txt files. Please choose an existing one.`);
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submitButton: subjectSubmit, inputElem: subjectInput } = this.subjectSection.inputAndSubmitFlex;
        const value = subjectInput.value;
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder = `Current: ${value}`;
        }
        subjectSubmit.replaceClass('green', 'inactive');
        subjectInput.value = '';
    }
    async onConfigSubmit(configs, subconfig) {
        const { submitButton: configSubmit, inputElem: configInput } = this.configSection.inputAndSubmitFlex;
        let file = configInput.value;
        console.log('onConfigSubmit,', file);
        try {
            MyStore_1.Subconfig.validateName(file);
        }
        catch (e) {
            if (e.message === 'ExtensionError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            }
            if (e.message === 'BasenameError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning(`Insert just a file name, not a path with slashes. eg: "${path.basename(file)}"`);
            }
        }
        configInput.removeClass('invalid');
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
            configSubmit.replaceClass('green', 'inactive');
            return configInput.value = '';
        }
        let action = "create";
        for (let cfg of configs) {
            if (cfg.lower() === fileLower) {
                action = await MyAlert_1.default.big.threeButtons({
                    title: `${cfg} already exists, what do you want to do?`,
                    confirmButtonText: 'Use it',
                    thirdButtonText: 'Overwrite it',
                    thirdButtonType: "warning"
                });
                if (action === "cancel") {
                    return;
                }
                file = cfg;
                break;
            }
        }
        const ext = path.extname(file);
        const experimentType = ext.slice(1);
        Glob_1.default.BigConfig.experiment_type = experimentType;
        console.log({ action, file });
        if (action === "confirm") {
            Glob_1.default.BigConfig.setSubconfig(file);
            MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('green', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
        if (action === "create" || action === "third") {
            Glob_1.default.BigConfig.setSubconfig(file, subconfig);
            let verb = action === "third" ? 'overwritten' : 'created';
            MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('green', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
    }
}
exports.SettingsDiv = SettingsDiv;
console.group('pages.New.sections.settings.ts');
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
console.groupEnd();
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBOEQ7QUFDOUQsc0NBQXNDO0FBQ3RDLDhDQUFxRjtBQUVyRiw2QkFBNkI7QUFFN0IsTUFBYSxXQUFZLFNBQVEsU0FBRztJQUtoQyxZQUFZLEVBQUUsRUFBRSxFQUFFO1FBQ2QsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUtkLE1BQU0sU0FBUyxHQUFjLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDM0QsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNELE1BQU0sYUFBYSxHQUFHLElBQUksb0JBQVksQ0FBQztZQUNuQyxXQUFXLEVBQUUsWUFBWSxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQ3pDLE1BQU0sRUFBRSxhQUFhO1lBQ3JCLFdBQVcsRUFBRSxPQUFPO1NBRXZCLENBQUMsQ0FBQztRQUVILGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFHbkcsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFFekMsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztRQUN6QyxNQUFNLGNBQWMsR0FBRyxJQUFJLG9CQUFZLENBQUM7WUFDcEMsV0FBVyxFQUFFLFlBQVksY0FBYyxFQUFFO1lBQ3pDLE1BQU0sRUFBRSxTQUFTO1lBQ2pCLFdBQVcsRUFBRSxRQUFRO1NBQ3hCLENBQUMsQ0FBQztRQUNILE1BQU0sRUFBRSxZQUFZLEVBQUUs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SUFBSSxHQUFHLE1BQU0sS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQzFELGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksS0FBSyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ2xELFdBQVcsQ0FBQyxXQUFXLEdBQUcsWUFBWSxJQUFJLEVBQUUsQ0FBQztZQUM3QyxZQUFZLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztZQUMvQyxXQUFXLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUN2QixNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ3JCO0lBR0wsQ0FBQztDQUVKO0FBaE5ELGtDQWdOQztBQUVELE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztBQUNoRCxNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO0FBQzVELE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUNuQixrQkFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyAqICBwYWdlcy9OZXcvc2VjdGlvbnMvc2V0dGluZ3NcblxuLyoqXG4gKiBpbXBvcnQgc2VjdGlvbnMgZnJvbSBcIi4vc2VjdGlvbnNcIlxuICogc2VjdGlvbnMuc2V0dGluZ3MqL1xuaW1wb3J0IHsgZWxlbSwgRGl2LCBidXR0b24sIElucHV0LCBCdXR0b24gfSBmcm9tIFwiLi4vLi4vLi4vYmhlXCI7XG5cbmltcG9ydCB7IElucHV0U2VjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGUvZXh0cmFcIjtcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi8uLi9HbG9iXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcblxuaW1wb3J0IE15QWxlcnQsIHsgQ3JlYXRlQ29uZmlybVRoaXJkIH0gZnJvbSAnLi4vLi4vLi4vTXlBbGVydCdcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSBcIi4uLy4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IEV4cGVyaW1lbnRUeXBlLCBnZXRUcnV0aHNXaXRoM1R4dEZpbGVzLCBTdWJjb25maWcgfSBmcm9tIFwiLi4vLi4vLi4vTXlTdG9yZVwiO1xuaW1wb3J0IHsgVHJ1dGggfSBmcm9tIFwiLi4vLi4vLi4vVHJ1dGhcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcblxuZXhwb3J0IGNsYXNzIFNldHRpbmdzRGl2IGV4dGVuZHMgRGl2IHtcbiAgICBwcml2YXRlIGNvbmZpZ1NlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBwcml2YXRlIHN1YmplY3RTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG4gICAgcHJpdmF0ZSB0cnV0aFNlY3Rpb246IElucHV0U2VjdGlvbjtcblxuICAgIGNvbnN0cnVjdG9yKHsgaWQgfSkge1xuICAgICAgICBzdXBlcih7IGlkIH0pO1xuICAgICAgICAvLyAqKiogRmlsZVxuICAgICAgICAvLyBjb25zdCBleHBlcmltZW50VHlwZSA9IEdsb2IuQmlnQ29uZmlnLmV4cGVyaW1lbnRfdHlwZTtcbiAgICAgICAgLy8gY29uc3Qgc3ViY29uZmlnRmlsZTogc3RyaW5nID0gR2xvYi5CaWdDb25maWdbYCR7ZXhwZXJpbWVudFR5cGV9X2ZpbGVgXTtcbiAgICAgICAgLy8gY29uc3Qgc3ViY29uZmlnOiBTdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZ1tleHBlcmltZW50VHlwZV07XG4gICAgICAgIGNvbnN0IHN1YmNvbmZpZzogU3ViY29uZmlnID0gR2xvYi5CaWdDb25maWcuZ2V0U3ViY29uZmlnKCk7XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IHN0cmluZ1tdID0gZnMucmVhZGRpclN5bmMoQ09ORklHU19QQVRIX0FCUyk7XG4gICAgICAgIGNvbnN0IGNvbmZpZ1NlY3Rpb24gPSBuZXcgSW5wdXRTZWN0aW9uKHtcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBgQ3VycmVudDogJHtzdWJjb25maWcubmFtZX1gLFxuICAgICAgICAgICAgaDN0ZXh0OiBgQ29uZmlnIEZpbGVgLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IGNvbmZpZ3MsXG5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uZmlnU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXguc3VibWl0QnV0dG9uLmNsaWNrKCgpID0+IHRoaXMub25Db25maWdTdWJtaXQoY29uZmlncywgc3ViY29uZmlnKSk7XG5cbiAgICAgICAgLy8gKioqIFN1YmplY3RcbiAgICAgICAgY29uc3Qgc3ViamVjdHMgPSBHbG9iLkJpZ0NvbmZpZy5zdWJqZWN0cztcblxuICAgICAgICBjb25zdCBjdXJyZW50U3ViamVjdCA9IHN1YmNvbmZpZy5zdWJqZWN0O1xuICAgICAgICBjb25zdCBzdWJqZWN0U2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXI6IGBDdXJyZW50OiAke2N1cnJlbnRTdWJqZWN0fWAsXG4gICAgICAgICAgICBoM3RleHQ6ICdTdWJqZWN0JyxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zOiBzdWJqZWN0c1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b246IHN1YmplY3RTdWJtaXQgfSA9IHN1YmplY3RTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgc3ViamVjdFN1Ym1pdC5jbGljaygoKSA9PiB0aGlzLm9uU3ViamVjdFN1Ym1pdChjdXJyZW50U3ViamVjdCwgc3ViY29uZmlnKSk7XG5cbiAgICAgICAgLy8gKioqIFRydXRoXG4gICAgICAgIGNvbnN0IHRydXRoc1dpdGgzVHh0RmlsZXMgPSBnZXRUcnV0aHNXaXRoM1R4dEZpbGVzKCk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUcnV0aCA9IHN1YmNvbmZpZy50cnV0aDtcbiAgICAgICAgY29uc3QgdHJ1dGhTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogYEN1cnJlbnQ6ICR7Y3VycmVudFRydXRoLm5hbWV9YCxcbiAgICAgICAgICAgIGgzdGV4dDogJ1RydXRoJyxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zOiB0cnV0aHNXaXRoM1R4dEZpbGVzLFxuICAgICAgICAgICAgaWxsZWdhbFJlZ2V4OiAvW14oYS16MC05QS1afF8pXS9cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdHJ1dGhTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleC5zdWJtaXRCdXR0b24uY2xpY2soKCkgPT4gdGhpcy5vblRydXRoU3VibWl0KGN1cnJlbnRUcnV0aCwgc3ViY29uZmlnLCB0cnV0aHNXaXRoM1R4dEZpbGVzKSk7XG5cbiAgICAgICAgY29uc3Qgc3VidGl0bGUgPSBlbGVtKHsgdGFnOiAnaDInLCB0ZXh0OiAnU2V0dGluZ3MnIH0pO1xuICAgICAgICB0aGlzLmNhY2hlQXBwZW5kKHsgc3VidGl0bGUsIGNvbmZpZ1NlY3Rpb24sIHN1YmplY3RTZWN0aW9uLCB0cnV0aFNlY3Rpb24gfSlcblxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgb25UcnV0aFN1Ym1pdChjdXJyZW50VHJ1dGg6IFRydXRoLCBzdWJjb25maWc6IFN1YmNvbmZpZywgdHJ1dGhzV2l0aDNUeHRGaWxlczogc3RyaW5nW10pIHtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b246IHRydXRoU3VibWl0LCBpbnB1dEVsZW06IHRydXRoSW5wdXQgfSA9IHRoaXMudHJ1dGhTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgbGV0IHZhbHVlID0gdHJ1dGhJbnB1dC52YWx1ZTtcbiAgICAgICAgbGV0IHZhbHVlTG93ZXIgPSB2YWx1ZS5sb3dlcigpO1xuICAgICAgICBpZiAodmFsdWVMb3dlci5lbmRzV2l0aEFueSgnX29uJywgJ19vZmYnKSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBvblRydXRoU3VibWl0IHZhbHVlIG5vdCBhIGJhc2UgdHh0OiAke3ZhbHVlTG93ZXJ9LiBDdXR0aW5nYCk7XG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnVwVG8oJ18nLCB0cnVlKTtcbiAgICAgICAgICAgIHZhbHVlTG93ZXIgPSB2YWx1ZS5sb3dlcigpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKCdvblRydXRoU3VibWl0JywgeyB2YWx1ZSwgY3VycmVudFRydXRoIH0pO1xuXG4gICAgICAgIC8vIC8gQ2hvc2VuIGlzIGFscmVhZHkgY3VycmVudGx5IHNldFxuICAgICAgICBpZiAoY3VycmVudFRydXRoLm5hbWUubG93ZXIoKSA9PT0gdmFsdWVMb3dlcikge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke2N1cnJlbnRUcnV0aC5uYW1lfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIHRydXRoYCk7XG4gICAgICAgICAgICB0cnV0aFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2dyZWVuJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1dGhJbnB1dC52YWx1ZSA9ICcnO1xuXG4gICAgICAgIH1cblxuICAgICAgICAvLyAvIERpZmZlcmVudCBmcm9tIGN1cnJlbnQsIGNoZWNrIGlmIGV4aXN0cyBpbiBcIndob2xlXCIgdHJ1dGhzXG4gICAgICAgIGZvciAobGV0IHRydXRoTmFtZSBvZiB0cnV0aHNXaXRoM1R4dEZpbGVzKSB7XG4gICAgICAgICAgICBsZXQgdHJ1dGhOYW1lTG93ZXIgPSB0cnV0aE5hbWUubG93ZXIoKTtcbiAgICAgICAgICAgIGlmICh0cnV0aE5hbWVMb3dlciA9PT0gdmFsdWVMb3dlcikge1xuICAgICAgICAgICAgICAgIHN1YmNvbmZpZy50cnV0aF9maWxlID0gdHJ1dGhOYW1lO1xuICAgICAgICAgICAgICAgIHRydXRoSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgICAgICB0cnV0aElucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7dHJ1dGhOYW1lfWA7XG4gICAgICAgICAgICAgICAgdHJ1dGhTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgVXNpbmcgdHJ1dGg6IFwiJHt0cnV0aE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIC8gRWl0aGVyIGV4aXN0cyBpbiBcInBhcnRpYWxcIiB0cnV0aHMgb3Igbm90IGF0IGFsbFxuICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKGBFaXRoZXIgdGhpcyB0cnV0aCBkb2Vzbid0IGV4aXN0IGNvbXBsZXRlbHksIG9yIGRvZXNuJ3QgaGF2ZSBpdHMgMyBhc3NvY2lhdGVkIC50eHQgZmlsZXMuIFBsZWFzZSBjaG9vc2UgYW4gZXhpc3Rpbmcgb25lLmApXG5cblxuICAgIH1cblxuICAgIHByaXZhdGUgb25TdWJqZWN0U3VibWl0KGN1cnJlbnRTdWJqZWN0OiBzdHJpbmcsIHN1YmNvbmZpZzogU3ViY29uZmlnKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uOiBzdWJqZWN0U3VibWl0LCBpbnB1dEVsZW06IHN1YmplY3RJbnB1dCB9ID0gdGhpcy5zdWJqZWN0U2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gc3ViamVjdElucHV0LnZhbHVlO1xuXG4gICAgICAgIGlmIChjdXJyZW50U3ViamVjdCA9PT0gdmFsdWUpIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50U3ViamVjdH0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBzdWJqZWN0YClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1YmNvbmZpZy5zdWJqZWN0ID0gdmFsdWU7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFN1YmplY3Qgc2V0OiAke3ZhbHVlfS5gKTtcbiAgICAgICAgICAgIHN1YmplY3RJbnB1dC5wbGFjZWhvbGRlciA9IGBDdXJyZW50OiAke3ZhbHVlfWA7XG5cbiAgICAgICAgfVxuICAgICAgICBzdWJqZWN0U3VibWl0LnJlcGxhY2VDbGFzcygnZ3JlZW4nLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgc3ViamVjdElucHV0LnZhbHVlID0gJyc7XG5cblxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgb25Db25maWdTdWJtaXQoY29uZmlnczogc3RyaW5nW10sIHN1YmNvbmZpZzogU3ViY29uZmlnKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uOiBjb25maWdTdWJtaXQsIGlucHV0RWxlbTogY29uZmlnSW5wdXQgfSA9IHRoaXMuY29uZmlnU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGxldCBmaWxlID0gY29uZmlnSW5wdXQudmFsdWU7XG4gICAgICAgIC8vIGNvbnN0IFsgZmlsZW5hbWUsIGV4dCBdID0gbXlmcy5zcGxpdF9leHQoZmlsZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdvbkNvbmZpZ1N1Ym1pdCwnLCBmaWxlKTtcbiAgICAgICAgLy8vLyBDaGVjayBmb3IgYmFkIGV4dGVuc2lvbiBvciBiYWQgZmlsZW5hbWVcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIFN1YmNvbmZpZy52YWxpZGF0ZU5hbWUoZmlsZSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdFeHRlbnNpb25FcnJvcicpIHtcbiAgICAgICAgICAgICAgICBjb25maWdJbnB1dC5hZGRDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBNeUFsZXJ0LnNtYWxsLndhcm5pbmcoJ0ZpbGUgbmFtZSBtdXN0IGVuZCB3aXRoIGVpdGhlciAuZXhhbSBvciAudGVzdCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGUubWVzc2FnZSA9PT0gJ0Jhc2VuYW1lRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKGBJbnNlcnQganVzdCBhIGZpbGUgbmFtZSwgbm90IGEgcGF0aCB3aXRoIHNsYXNoZXMuIGVnOiBcIiR7cGF0aC5iYXNlbmFtZShmaWxlKX1cImApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8vLyBFeHRlbnNpb24gYW5kIGZpbGUgbmFtZSBvazsgY2hlY2sgaWYgdXNlciBjaG9zZSB3aGF0J3MgY3VycmVudGx5IHNldFxuICAgICAgICBjb25maWdJbnB1dC5yZW1vdmVDbGFzcygnaW52YWxpZCcpO1xuXG4gICAgICAgIGNvbnN0IGZpbGVMb3dlciA9IGZpbGUubG93ZXIoKTtcbiAgICAgICAgaWYgKHN1YmNvbmZpZy5uYW1lLmxvd2VyKCkgPT09IGZpbGVMb3dlcikge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke3N1YmNvbmZpZy5uYW1lfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIGZpbGVgKTtcbiAgICAgICAgICAgIGNvbmZpZ1N1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2dyZWVuJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICByZXR1cm4gY29uZmlnSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgfVxuXG4gICAgICAgIC8vLy8gQ2hvc2VuIHNvbWV0aGluZyBlbHNlOyBjaGVjayBpZiBleGlzdHNcbiAgICAgICAgbGV0IGFjdGlvbjogQ3JlYXRlQ29uZmlybVRoaXJkIHwgXCJjcmVhdGVcIiA9IFwiY3JlYXRlXCI7IC8vIGNyZWF0ZSAoZG9lc250IGV4aXN0KSwgY29uZmlybSAodXNlIGV4aXN0aW5nKSwgb3ZlcndyaXRlIChvbiB0b3Agb2YgZXhpc3RpbmcpLCBjYW5jZWxcblxuICAgICAgICBmb3IgKGxldCBjZmcgb2YgY29uZmlncykge1xuICAgICAgICAgICAgaWYgKGNmZy5sb3dlcigpID09PSBmaWxlTG93ZXIpIHtcbiAgICAgICAgICAgICAgICBhY3Rpb24gPSBhd2FpdCBNeUFsZXJ0LmJpZy50aHJlZUJ1dHRvbnMoe1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogYCR7Y2ZnfSBhbHJlYWR5IGV4aXN0cywgd2hhdCBkbyB5b3Ugd2FudCB0byBkbz9gLFxuICAgICAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dDogJ1VzZSBpdCcsXG4gICAgICAgICAgICAgICAgICAgIHRoaXJkQnV0dG9uVGV4dDogJ092ZXJ3cml0ZSBpdCcsXG4gICAgICAgICAgICAgICAgICAgIHRoaXJkQnV0dG9uVHlwZTogXCJ3YXJuaW5nXCJcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBNeUFsZXJ0LmJpZy5ibG9ja2luZyh7XG4gICAgICAgICAgICAgICAgIHRpdGxlIDogYCR7Y2ZnfSBhbHJlYWR5IGV4aXN0cywgd2hhdCBkbyB5b3Ugd2FudCB0byBkbz9gLFxuICAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dCA6ICdVc2UgaXQnLFxuICAgICAgICAgICAgICAgICBvbkJlZm9yZU9wZW4gOiAobW9kYWw6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgIGxldCBlbCA9IGVsZW0oeyBodG1sRWxlbWVudCA6IG1vZGFsLCBjaGlsZHJlbiA6IHsgYWN0aW9ucyA6ICcuc3dhbDItYWN0aW9ucycgfSB9KTtcbiAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICBlbC5hY3Rpb25zLmFwcGVuZChcbiAgICAgICAgICAgICAgICAgYnV0dG9uKHsgY2xzIDogXCJzd2FsMi1jb25maXJtIHN3YWwyLXN0eWxlZCB3YXJuXCIsIGh0bWwgOiAnT3ZlcndyaXRlIGl0JyB9KVxuICAgICAgICAgICAgICAgICAuYXR0cih7IHR5cGUgOiAnYnV0dG9uJyB9KVxuICAgICAgICAgICAgICAgICAuY3NzKHsgYmFja2dyb3VuZENvbG9yIDogJyNGRkM2NkQnLCBjb2xvciA6ICdibGFjaycgfSlcbiAgICAgICAgICAgICAgICAgLmNsaWNrKChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAvLyBcIk92ZXJ3cml0ZSBpdFwiXG4gICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwib3ZlcndyaXRlXCI7XG4gICAgICAgICAgICAgICAgIG92ZXJ3cml0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgIGZpbGUgPSBjZmc7IC8vIG1hdGNoIGNhc2VcbiAgICAgICAgICAgICAgICAgTXlBbGVydC5jbGlja0NhbmNlbCgpO1xuICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uID09PSBcImNhbmNlbFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8vLyBcIk92ZXJ3cml0ZVwiIG9yIFwiVXNlIGl0XCJcbiAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cblxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vLy8gRWl0aGVyIGV4aXN0cyB0aGVuIGxvYWQgb3Igb3ZlcndyaXRlIGl0LCBvciBjb21wbGV0ZWx5IG5ld1xuICAgICAgICBjb25zdCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZSk7XG4gICAgICAgIGNvbnN0IGV4cGVyaW1lbnRUeXBlID0gZXh0LnNsaWNlKDEpIGFzIEV4cGVyaW1lbnRUeXBlO1xuICAgICAgICBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGUgPSBleHBlcmltZW50VHlwZTtcbiAgICAgICAgY29uc29sZS5sb2coeyBhY3Rpb24sIGZpbGUgfSk7XG4gICAgICAgIGlmIChhY3Rpb24gPT09IFwiY29uZmlybVwiKSB7IC8vIEV4aXN0cywgXCJVc2UgaXRcIlxuICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUpO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBDb25maWcgbG9hZGVkOiAke2ZpbGV9LmApO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHtmaWxlfWA7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhY3Rpb24gPT09IFwiY3JlYXRlXCIgfHwgYWN0aW9uID09PSBcInRoaXJkXCIpIHtcbiAgICAgICAgICAgIEdsb2IuQmlnQ29uZmlnLnNldFN1YmNvbmZpZyhmaWxlLCBzdWJjb25maWcpO1xuICAgICAgICAgICAgbGV0IHZlcmIgPSBhY3Rpb24gPT09IFwidGhpcmRcIiA/ICdvdmVyd3JpdHRlbicgOiAnY3JlYXRlZCc7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYENvbmZpZyAke3ZlcmJ9OiAke2ZpbGV9LmApO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHtmaWxlfWA7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICB9XG5cblxuICAgIH1cblxufVxuXG5jb25zb2xlLmdyb3VwKCdwYWdlcy5OZXcuc2VjdGlvbnMuc2V0dGluZ3MudHMnKTtcbmNvbnN0IHNldHRpbmdzRGl2ID0gbmV3IFNldHRpbmdzRGl2KHsgaWQ6ICdzZXR0aW5nc19kaXYnIH0pO1xuY29uc29sZS5ncm91cEVuZCgpO1xuZXhwb3J0IGRlZmF1bHQgc2V0dGluZ3NEaXY7XG5cbiJdfQ==