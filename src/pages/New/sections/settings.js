"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const MyFs_1 = require("../../../MyFs");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const experimentType = Glob_1.default.BigConfig.experiment_type;
        const subconfigFile = Glob_1.default.BigConfig[`${experimentType}_file`];
        const subconfig = Glob_1.default.BigConfig[experimentType];
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const fileSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfigFile}`,
            h3text: 'Config File',
            suggestions: configs,
        });
        const { submitButton: fileSubmit, inputElem: fileInput } = fileSection.inputAndSubmitFlex;
        fileSubmit.click(this.onFileSubmit(fileInput, subconfigFile, configs, subconfig, fileSubmit));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submitButton: subjectSubmit, inputElem: subjectInput } = subjectSection.inputAndSubmitFlex;
        subjectSubmit.click((ev) => {
            console.log('subject submit,', ev);
            const value = subjectInput.value;
            if (currentSubject === value) {
                MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
            }
            else {
                subconfig.subject = value;
                MyAlert_1.default.small.success(`Subject set: ${value}.`);
                subjectInput.placeholder = `Current: ${value}`;
            }
            subjectSubmit.replaceClass('active', 'inactive');
            subjectInput.value = '';
        });
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, fileSection, subjectSection });
    }
    onFileSubmit(fileInput, subconfigFile, configs, subconfig, fileSubmit) {
        return async (ev) => {
            const file = fileInput.value;
            console.log('file submit,', file);
            const [filename, ext] = MyFs_1.default.split_ext(file);
            if (!['.exam', '.test'].includes(ext)) {
                fileInput.addClass('invalid');
                MyAlert_1.default.small.warning('File name must end with either .exam or .test');
                return;
            }
            else {
                fileInput.removeClass('invalid');
            }
            const fileLower = file.lower();
            if (subconfigFile.lower() === fileLower) {
                MyAlert_1.default.small.info(`${subconfigFile} was already the chosen file`);
            }
            else {
                let overwrite;
                for (let cfg of configs) {
                    if (cfg.lower() === fileLower) {
                        const { value } = await MyAlert_1.default.big.blocking({
                            title: `${cfg} already exists, what do you want to do?`,
                            confirmButtonText: 'Use it',
                            onBeforeOpen: (modal) => {
                                let el = bhe_1.elem({ htmlElement: modal, children: { actions: '.swal2-actions' } });
                                el.actions.append(bhe_1.button({ cls: "swal2-confirm swal2-styled warn", html: 'Overwrite it' })
                                    .attr({ type: 'button' })
                                    .css({ backgroundColor: '#FFC66D', color: 'black' })
                                    .click((ev) => {
                                    overwrite = true;
                                    MyAlert_1.default.clickCancel();
                                }));
                            }
                        });
                        if (value) {
                            overwrite = cfg;
                            break;
                        }
                        else if (!overwrite) {
                            return;
                        }
                    }
                }
                const experimentType = ext.slice(1);
                console.log({ overwrite });
                if (typeof overwrite !== 'string') {
                    Glob_1.default.BigConfig.setSubconfig(file, experimentType, subconfig);
                    let verb = overwrite === undefined ? 'created' : 'overwritten';
                    MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
                }
                else {
                    Glob_1.default.BigConfig.setSubconfig(file, experimentType);
                    MyAlert_1.default.small.success(`Config loaded: ${file}.`);
                }
                fileInput.placeholder = `Current: ${file}`;
            }
            fileSubmit.replaceClass('active', 'inactive');
            fileInput.value = '';
        };
    }
}
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBc0M7QUFDdEMsd0NBQWlDO0FBSWpDLE1BQU0sV0FBWSxTQUFRLFNBQUc7SUFHekIsWUFBWSxFQUFFLEVBQUUsRUFBRTtRQUNkLEtBQUssQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFFZCxNQUFNLGNBQWMsR0FBRyxjQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsQ0FBQztRQUN0RCxNQUFNLGFBQWEsR0FBVyxjQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsY0FBYyxPQUFPLENBQUMsQ0FBQztRQUN2RSxNQUFNLFNBQVMsR0FBYyxjQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQzVELE1BQU0sT0FBTyxHQUFhLEVBQUUsQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMzRCxNQUFNLFdBQVcsR0FBRyxJQUFJLG9CQUFZLENBQUM7WUFDakMsV0FBVyxFQUFHLFlBQVksYUFBYSxFQUFFO1lBQ3pDLE1BQU0sRUFBRyxhQUFhO1lBQ3RCLFdBQVcsRUFBRyxPQUFPO1NBRXhCLENBQUMsQ0FBQztRQUVILE1BQU0sRUFBRSxZQUFZLEVBQUcsVUFBVSxFQUFFLFNBQVMsRUFBRyxTQUFTLEVBQUUsR0FBRyxXQUFXLENBQUMsa0JBQWtCLENBQUM7UUFDNUYsVUFBVSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxhQUFhLEVBQUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBRTlGLE1BQU0sUUFBUSxHQUFHLGNBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1FBRXpDLE1BQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxvQkFBWSxDQUFDO1lBQ3BDLFdBQVcsRUFBRyxZQUFZLGNBQWMsRUFBRTtZQUMxQyxNQUFNLEVBQUcsU0FBUztZQUNsQixXQUFXLEVBQUcsUUFBUTtTQUN6QixDQUFDLENBQUM7UUFDSCxNQUFNLEVBQUUsWUFBWSxFQUFHLGFBQWEsRUFBRSxTQUFTLEVBQUcsWUFBWSxFQUFFLEdBQUcsY0FBYyxDQUFDLGtCQUFrQixDQUFDO1FBQ3JHLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFjLEVBQUUsRUFBRTtZQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ25DLE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUM7WUFDakMsSUFBSyxjQUFjLEtBQUssS0FBSyxFQUFHO2dCQUU1QixpQkFBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxjQUFjLGlDQUFpQyxDQUFDLENBQUE7YUFDekU7aUJBQU07Z0JBQ0gsU0FBUyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7Z0JBQzFCLGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsS0FBSyxHQUFHLENBQUMsQ0FBQztnQkFDaEQsWUFBWSxDQUFDLFdBQVcsR0FBRyxZQUFZLEtBQUssRUFBRSxDQUFDO2FBRWxEO1lBQ0QsYUFBYSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDakQsWUFBWSxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFHNUIsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLFFBQVEsR0FBRyxVQUFJLENBQUMsRUFBRSxHQUFHLEVBQUcsSUFBSSxFQUFFLElBQUksRUFBRyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBQ3pELElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxRQUFRLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRSxDQUFDLENBQUE7SUFLL0QsQ0FBQztJQUdPLFlBQVksQ0FBQyxTQUFnQixFQUFFLGFBQXFCLEVBQUUsT0FBaUIsRUFBRSxTQUFvQixFQUFFLFVBQWtCO1FBQ3JILE9BQU8sS0FBSyxFQUFFLEVBQWMsRUFBRSxFQUFFO1lBQzVCLE1BQU0sSUFBSSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUM7WUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDbEMsTUFBTSxDQUFFLFFBQVEsRUFBRSxHQUFHLENBQUUsR0FBRyxjQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQy9DLElBQUssQ0FBQyxDQUFFLE9BQU8sRUFBRSxPQUFPLENBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUc7Z0JBQ3ZDLFNBQVMsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzlCLGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO2dCQUN2RSxPQUFPO2FBQ1Y7aUJBQU07Z0JBQ0gsU0FBUyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNwQztZQUNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUMvQixJQUFLLGFBQWEsQ0FBQyxLQUFLLEVBQUUsS0FBSyxTQUFTLEVBQUc7Z0JBQ3ZDLGlCQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLGFBQWEsOEJBQThCLENBQUMsQ0FBQTthQUNyRTtpQkFBTTtnQkFDSCxJQUFJLFNBQVMsQ0FBQztnQkFDZCxLQUFNLElBQUksR0FBRyxJQUFJLE9BQU8sRUFBRztvQkFDdkIsSUFBSyxHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssU0FBUyxFQUFHO3dCQUU3QixNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsTUFBTSxpQkFBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7NEJBQ3pDLEtBQUssRUFBRyxHQUFHLEdBQUcsMENBQTBDOzRCQUN4RCxpQkFBaUIsRUFBRyxRQUFROzRCQUM1QixZQUFZLEVBQUcsQ0FBQyxLQUFrQixFQUFFLEVBQUU7Z0NBQ2xDLElBQUksRUFBRSxHQUFHLFVBQUksQ0FBQyxFQUFFLFdBQVcsRUFBRyxLQUFLLEVBQUUsUUFBUSxFQUFHLEVBQUUsT0FBTyxFQUFHLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDO2dDQUVsRixFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FDYixZQUFNLENBQUMsRUFBRSxHQUFHLEVBQUcsaUNBQWlDLEVBQUUsSUFBSSxFQUFHLGNBQWMsRUFBRSxDQUFDO3FDQUNyRSxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUcsUUFBUSxFQUFFLENBQUM7cUNBQ3pCLEdBQUcsQ0FBQyxFQUFFLGVBQWUsRUFBRyxTQUFTLEVBQUUsS0FBSyxFQUFHLE9BQU8sRUFBRSxDQUFDO3FDQUNyRCxLQUFLLENBQUMsQ0FBQyxFQUFjLEVBQUUsRUFBRTtvQ0FDdEIsU0FBUyxHQUFHLElBQUksQ0FBQztvQ0FDakIsaUJBQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztnQ0FDMUIsQ0FBQyxDQUFDLENBQ1QsQ0FBQTs0QkFDTCxDQUFDO3lCQUNKLENBQUMsQ0FBQzt3QkFDSCxJQUFLLEtBQUssRUFBRzs0QkFDVCxTQUFTLEdBQUcsR0FBRyxDQUFDOzRCQUNoQixNQUFNO3lCQUNUOzZCQUFNLElBQUssQ0FBQyxTQUFTLEVBQUc7NEJBQ3JCLE9BQU87eUJBQ1Y7cUJBRUo7aUJBQ0o7Z0JBQ0QsTUFBTSxjQUFjLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQW1CLENBQUM7Z0JBRXRELE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO2dCQUMzQixJQUFLLE9BQU8sU0FBUyxLQUFLLFFBQVEsRUFBRztvQkFDakMsY0FBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDN0QsSUFBSSxJQUFJLEdBQUcsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7b0JBQy9ELGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksS0FBSyxJQUFJLEdBQUcsQ0FBQyxDQUFDO2lCQUNyRDtxQkFBTTtvQkFDSCxjQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUM7b0JBQ2xELGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsSUFBSSxHQUFHLENBQUMsQ0FBQztpQkFFcEQ7Z0JBR0QsU0FBUyxDQUFDLFdBQVcsR0FBRyxZQUFZLElBQUksRUFBRSxDQUFDO2FBSzlDO1lBQ0QsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDOUMsU0FBUyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7UUFHekIsQ0FBQyxDQUFDO0lBQ04sQ0FBQztDQUNKO0FBR0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxXQUFXLENBQUMsRUFBRSxFQUFFLEVBQUcsY0FBYyxFQUFFLENBQUMsQ0FBQztBQUM3RCxrQkFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyAqICBwYWdlcy9OZXcvc2VjdGlvbnMvc2V0dGluZ3NcblxuLyoqXG4gKiBpbXBvcnQgc2VjdGlvbnMgZnJvbSBcIi4vc2VjdGlvbnNcIlxuICogc2VjdGlvbnMuc2V0dGluZ3MqL1xuaW1wb3J0IHsgZWxlbSwgRGl2LCBidXR0b24sIElucHV0LCBCdXR0b24gfSBmcm9tIFwiLi4vLi4vLi4vYmhlXCI7XG5cbmltcG9ydCB7IElucHV0U2VjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGUvZXh0cmFcIjtcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi8uLi9HbG9iXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcblxuaW1wb3J0IE15QWxlcnQgZnJvbSAnLi4vLi4vLi4vTXlBbGVydCdcbmltcG9ydCBteWZzIGZyb20gXCIuLi8uLi8uLi9NeUZzXCI7XG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi8uLi91dGlsXCI7XG5pbXBvcnQgeyBFeHBlcmltZW50VHlwZSwgU3ViY29uZmlnIH0gZnJvbSBcIi4uLy4uLy4uL015U3RvcmVcIjtcblxuY2xhc3MgU2V0dGluZ3NEaXYgZXh0ZW5kcyBEaXYge1xuICAgIGZpbGVTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG4gICAgXG4gICAgY29uc3RydWN0b3IoeyBpZCB9KSB7XG4gICAgICAgIHN1cGVyKHsgaWQgfSk7XG4gICAgICAgIC8vICoqKiAgRmlsZVxuICAgICAgICBjb25zdCBleHBlcmltZW50VHlwZSA9IEdsb2IuQmlnQ29uZmlnLmV4cGVyaW1lbnRfdHlwZTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnRmlsZTogc3RyaW5nID0gR2xvYi5CaWdDb25maWdbYCR7ZXhwZXJpbWVudFR5cGV9X2ZpbGVgXTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnOiBTdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZ1tleHBlcmltZW50VHlwZV07XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IHN0cmluZ1tdID0gZnMucmVhZGRpclN5bmMoQ09ORklHU19QQVRIX0FCUyk7XG4gICAgICAgIGNvbnN0IGZpbGVTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlciA6IGBDdXJyZW50OiAke3N1YmNvbmZpZ0ZpbGV9YCxcbiAgICAgICAgICAgIGgzdGV4dCA6ICdDb25maWcgRmlsZScsXG4gICAgICAgICAgICBzdWdnZXN0aW9ucyA6IGNvbmZpZ3MsXG4gICAgICAgICAgICAvLyBvdmVyd3JpdGVXYXJuIDogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uIDogZmlsZVN1Ym1pdCwgaW5wdXRFbGVtIDogZmlsZUlucHV0IH0gPSBmaWxlU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGZpbGVTdWJtaXQuY2xpY2sodGhpcy5vbkZpbGVTdWJtaXQoZmlsZUlucHV0LCBzdWJjb25maWdGaWxlLCBjb25maWdzLCBzdWJjb25maWcsIGZpbGVTdWJtaXQpKTtcbiAgICAgICAgLy8gKioqICBTdWJqZWN0XG4gICAgICAgIGNvbnN0IHN1YmplY3RzID0gR2xvYi5CaWdDb25maWcuc3ViamVjdHM7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBjdXJyZW50U3ViamVjdCA9IHN1YmNvbmZpZy5zdWJqZWN0O1xuICAgICAgICBjb25zdCBzdWJqZWN0U2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXIgOiBgQ3VycmVudDogJHtjdXJyZW50U3ViamVjdH1gLFxuICAgICAgICAgICAgaDN0ZXh0IDogJ1N1YmplY3QnLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnMgOiBzdWJqZWN0c1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiBzdWJqZWN0U3VibWl0LCBpbnB1dEVsZW0gOiBzdWJqZWN0SW5wdXQgfSA9IHN1YmplY3RTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgc3ViamVjdFN1Ym1pdC5jbGljaygoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzdWJqZWN0IHN1Ym1pdCwnLCBldik7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHN1YmplY3RJbnB1dC52YWx1ZTtcbiAgICAgICAgICAgIGlmICggY3VycmVudFN1YmplY3QgPT09IHZhbHVlICkge1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50U3ViamVjdH0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBzdWJqZWN0YClcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc3ViY29uZmlnLnN1YmplY3QgPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFN1YmplY3Qgc2V0OiAke3ZhbHVlfS5gKTtcbiAgICAgICAgICAgICAgICBzdWJqZWN0SW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHt2YWx1ZX1gO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc3ViamVjdFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgc3ViamVjdElucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3Qgc3VidGl0bGUgPSBlbGVtKHsgdGFnIDogJ2gyJywgdGV4dCA6ICdTZXR0aW5ncycgfSk7XG4gICAgICAgIHRoaXMuY2FjaGVBcHBlbmQoeyBzdWJ0aXRsZSwgZmlsZVNlY3Rpb24sIHN1YmplY3RTZWN0aW9uIH0pXG4gICAgICAgIC8qdGhpcy5jYWNoZUFwcGVuZCh7XG4gICAgICAgICBhZGRMZXZlbEJ0biA6IGJ1dHRvbih7IGNscyA6ICdhY3RpdmUnLCBodG1sIDogJ0FkZCBMZXZlbCcsIGNsaWNrIDogdGhpcy5hZGRMZXZlbCB9KSxcbiAgICAgICAgIFxuICAgICAgICAgfSkqL1xuICAgIH1cbiAgICBcbiAgICBcbiAgICBwcml2YXRlIG9uRmlsZVN1Ym1pdChmaWxlSW5wdXQ6IElucHV0LCBzdWJjb25maWdGaWxlOiBzdHJpbmcsIGNvbmZpZ3M6IHN0cmluZ1tdLCBzdWJjb25maWc6IFN1YmNvbmZpZywgZmlsZVN1Ym1pdDogQnV0dG9uKSB7XG4gICAgICAgIHJldHVybiBhc3luYyAoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGUgPSBmaWxlSW5wdXQudmFsdWU7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnZmlsZSBzdWJtaXQsJywgZmlsZSk7XG4gICAgICAgICAgICBjb25zdCBbIGZpbGVuYW1lLCBleHQgXSA9IG15ZnMuc3BsaXRfZXh0KGZpbGUpO1xuICAgICAgICAgICAgaWYgKCAhWyAnLmV4YW0nLCAnLnRlc3QnIF0uaW5jbHVkZXMoZXh0KSApIHtcbiAgICAgICAgICAgICAgICBmaWxlSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLndhcm5pbmcoJ0ZpbGUgbmFtZSBtdXN0IGVuZCB3aXRoIGVpdGhlciAuZXhhbSBvciAudGVzdCcpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZmlsZUlucHV0LnJlbW92ZUNsYXNzKCdpbnZhbGlkJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBmaWxlTG93ZXIgPSBmaWxlLmxvd2VyKCk7XG4gICAgICAgICAgICBpZiAoIHN1YmNvbmZpZ0ZpbGUubG93ZXIoKSA9PT0gZmlsZUxvd2VyICkge1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtzdWJjb25maWdGaWxlfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIGZpbGVgKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsZXQgb3ZlcndyaXRlO1xuICAgICAgICAgICAgICAgIGZvciAoIGxldCBjZmcgb2YgY29uZmlncyApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBjZmcubG93ZXIoKSA9PT0gZmlsZUxvd2VyICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBNeUFsZXJ0LmJpZy5ibG9ja2luZyh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGUgOiBgJHtjZmd9IGFscmVhZHkgZXhpc3RzLCB3aGF0IGRvIHlvdSB3YW50IHRvIGRvP2AsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQgOiAnVXNlIGl0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkJlZm9yZU9wZW4gOiAobW9kYWw6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBlbCA9IGVsZW0oeyBodG1sRWxlbWVudCA6IG1vZGFsLCBjaGlsZHJlbiA6IHsgYWN0aW9ucyA6ICcuc3dhbDItYWN0aW9ucycgfSB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5hY3Rpb25zLmFwcGVuZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbih7IGNscyA6IFwic3dhbDItY29uZmlybSBzd2FsMi1zdHlsZWQgd2FyblwiLCBodG1sIDogJ092ZXJ3cml0ZSBpdCcgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXR0cih7IHR5cGUgOiAnYnV0dG9uJyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jc3MoeyBiYWNrZ3JvdW5kQ29sb3IgOiAnI0ZGQzY2RCcsIGNvbG9yIDogJ2JsYWNrJyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jbGljaygoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTXlBbGVydC5jbGlja0NhbmNlbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggdmFsdWUgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlID0gY2ZnO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggIW92ZXJ3cml0ZSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb25zdCBleHBlcmltZW50VHlwZSA9IGV4dC5zbGljZSgxKSBhcyBFeHBlcmltZW50VHlwZTtcbiAgICAgICAgICAgICAgICAvLyBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGUgPSBleHBlcmltZW50VHlwZTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh7IG92ZXJ3cml0ZSB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiBvdmVyd3JpdGUgIT09ICdzdHJpbmcnICkgeyAvLyB1bmRlZmluZWQ6IG5ldyBmaWxlLCB0cnVlOiBjbGlja2VkIG92ZXJ3cml0ZSxcbiAgICAgICAgICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUsIGV4cGVyaW1lbnRUeXBlLCBzdWJjb25maWcpO1xuICAgICAgICAgICAgICAgICAgICBsZXQgdmVyYiA9IG92ZXJ3cml0ZSA9PT0gdW5kZWZpbmVkID8gJ2NyZWF0ZWQnIDogJ292ZXJ3cml0dGVuJztcbiAgICAgICAgICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBDb25maWcgJHt2ZXJifTogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBzdHJpbmc6IFwiVXNlIGl0XCJcbiAgICAgICAgICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUsIGV4cGVyaW1lbnRUeXBlKTtcbiAgICAgICAgICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBDb25maWcgbG9hZGVkOiAke2ZpbGV9LmApO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgZmlsZUlucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7ZmlsZX1gO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgICAgICAvLyB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZpbGVTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIGZpbGVJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBcbiAgICAgICAgfTtcbiAgICB9XG59XG5cblxuY29uc3Qgc2V0dGluZ3NEaXYgPSBuZXcgU2V0dGluZ3NEaXYoeyBpZCA6ICdzZXR0aW5nc19kaXYnIH0pO1xuZXhwb3J0IGRlZmF1bHQgc2V0dGluZ3NEaXY7XG5cbiJdfQ==