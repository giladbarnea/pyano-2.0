"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const MyFs_1 = require("../../../MyFs");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const fileSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        const { submitButton: fileSubmit, inputElem: fileInput } = fileSection.inputAndSubmitFlex;
        fileSubmit.click(() => this.onFileSubmit(configs, subconfig));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submitButton: subjectSubmit, inputElem: subjectInput } = subjectSection.inputAndSubmitFlex;
        subjectSubmit.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        console.log({ truthsWith3TxtFiles });
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.truth_file}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles
        });
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, fileSection, subjectSection, truthSection });
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submitButton: subjectSubmit, inputElem: subjectInput } = this.subjectSection.inputAndSubmitFlex;
        const value = subjectInput.value;
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder = `Current: ${value}`;
        }
        subjectSubmit.replaceClass('active', 'inactive');
        subjectInput.value = '';
    }
    async onFileSubmit(configs, subconfig) {
        const { submitButton: fileSubmit, inputElem: fileInput } = this.fileSection.inputAndSubmitFlex;
        let file = fileInput.value;
        console.log('file submit,', file);
        const [filename, ext] = MyFs_1.default.split_ext(file);
        if (!['.exam', '.test'].includes(ext)) {
            fileInput.addClass('invalid');
            MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            return;
        }
        else {
            fileInput.removeClass('invalid');
        }
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
        }
        else {
            let action = "create";
            let overwrite = undefined;
            for (let cfg of configs) {
                if (cfg.lower() === fileLower) {
                    const { value } = await MyAlert_1.default.big.blocking({
                        title: `${cfg} already exists, what do you want to do?`,
                        confirmButtonText: 'Use it',
                        onBeforeOpen: (modal) => {
                            let el = bhe_1.elem({ htmlElement: modal, children: { actions: '.swal2-actions' } });
                            el.actions.append(bhe_1.button({ cls: "swal2-confirm swal2-styled warn", html: 'Overwrite it' })
                                .attr({ type: 'button' })
                                .css({ backgroundColor: '#FFC66D', color: 'black' })
                                .click((ev) => {
                                action = "overwrite";
                                overwrite = true;
                                file = cfg;
                                MyAlert_1.default.clickCancel();
                            }));
                        }
                    });
                    if (value) {
                        file = cfg;
                        action = "use";
                        overwrite = cfg;
                        console.log('Use it', { file, cfg, overwrite });
                        break;
                    }
                    else if (!overwrite) {
                        return;
                    }
                }
            }
            const experimentType = ext.slice(1);
            Glob_1.default.BigConfig.experiment_type = experimentType;
            console.log({ overwrite, action, file });
            if (typeof overwrite !== 'string') {
                Glob_1.default.BigConfig.setSubconfig(file, experimentType, subconfig);
                let verb = overwrite === undefined ? 'created' : 'overwritten';
                MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            }
            else {
                Glob_1.default.BigConfig.setSubconfig(file, experimentType);
                MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            }
            fileInput.placeholder = `Current: ${file}`;
            fileSubmit.replaceClass('active', 'inactive');
            fileInput.value = '';
            if (Glob_1.default.BigConfig.dev.reload_page_on_submit()) {
                await util.wait(3000);
                util.reloadPage();
            }
        }
        fileSubmit.replaceClass('active', 'inactive');
        fileInput.value = '';
    }
}
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBc0M7QUFDdEMsd0NBQWlDO0FBQ2pDLHNDQUFzQztBQUN0Qyw4Q0FBcUY7QUFFckYsTUFBTSxXQUFZLFNBQVEsU0FBRztJQUl6QixZQUFZLEVBQUUsRUFBRSxFQUFFO1FBQ2QsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUtkLE1BQU0sU0FBUyxHQUFjLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDM0QsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNELE1BQU0sV0FBVyxHQUFHLElBQUksb0JBQVksQ0FBQztZQUNqQyxXQUFXLEVBQUcsWUFBWSxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQzFDLE1BQU0sRUFBRyxhQUFhO1lBQ3RCLFdBQVcsRUFBRyxPQUFPO1NBRXhCLENBQUMsQ0FBQztRQUVILE1BQU0sRUFBRSxZQUFZLEVBQUcsVUFBVSxFQUFFLFNBQVMsRUFBRyxTQUFTLEVBQUUsR0FBRyxXQUFXLENBQUMsa0JBQWtCLENBQUM7UUFDNUYsVUFBVSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBRzlELE1BQU0sUUFBUSxHQUFHLGNBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1FBRXpDLE1BQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxvQkFBWSxDQUFDO1lBQ3BDLFdBQVcsRUFBRyxZQUFZLGNBQWMsRUFBRTtZQUMxQyxNQUFNLEVBQUcsU0FBUztZQUNsQixXQUFXLEVBQUcsUUFBUTtTQUN6QixDQUFDLENBQUM7UUFDSCxNQUFNLEVBQUUsWUFBWSxFQUFHLGFBQWEsRUFBRSxTQUFTLEVBQUcsWUFBWSxFQUFFLEdBQUcsY0FBYyxDQUFDLGtCQUFrQixDQUFDO1FBQ3JHLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUczRSxNQUFNLG1CQUFtQixHQUFHLGdDQUFzQixFQUFFLENBQUM7UUFDckQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQztRQUVyQyxNQUFNLFlBQVksR0FBRyxJQUFJLG9CQUFZLENBQUM7WUFDbEMsV0FBVyxFQUFHLFlBQVksU0FBUyxDQUFDLFVBQVUsRUFBRTtZQUNoRCxNQUFNLEVBQUcsT0FBTztZQUNoQixXQUFXLEVBQUcsbUJBQW1CO1NBQ3BDLENBQUMsQ0FBQztRQUVILE1BQU0sUUFBUSxHQUFHLFVBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRyxJQUFJLEVBQUUsSUFBSSxFQUFHLFVBQVUsRUFBRSxDQUFDLENBQUM7UUFDekQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUE7SUFLN0UsQ0FBQztJQUVPLGVBQWUsQ0FBQyxjQUFzQixFQUFFLFNBQW9CO1FBQ2hFLE1BQU0sRUFBRSxZQUFZLEVBQUcsYUFBYSxFQUFFLFNBQVMsRUFBRyxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLGtCQUFrQixDQUFDO1FBQzFHLE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUM7UUFDakMsSUFBSyxjQUFjLEtBQUssS0FBSyxFQUFHO1lBRTVCLGlCQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsaUNBQWlDLENBQUMsQ0FBQTtTQUN6RTthQUFNO1lBQ0gsU0FBUyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7WUFDMUIsaUJBQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLGdCQUFnQixLQUFLLEdBQUcsQ0FBQyxDQUFDO1lBQ2hELFlBQVksQ0FBQyxXQUFXLEdBQUcsWUFBWSxLQUFLLEVBQUUsQ0FBQztTQUVsRDtRQUNELGFBQWEsQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQ2pELFlBQVksQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDO0lBRzVCLENBQUM7SUFFTyxLQUFLLENBQUMsWUFBWSxDQUFDLE9BQWlCLEVBQUUsU0FBb0I7UUFDOUQsTUFBTSxFQUFFLFlBQVksRUFBRyxVQUFVLEVBQUUsU0FBUyxFQUFHLFNBQVMsRUFBRSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUM7UUFDakcsSUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQztRQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsQyxNQUFNLENBQUUsUUFBUSxFQUFFLEdBQUcsQ0FBRSxHQUFHLGNBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0MsSUFBSyxDQUFDLENBQUUsT0FBTyxFQUFFLE9BQU8sQ0FBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRztZQUN2QyxTQUFTLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzlCLGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1lBQ3ZFLE9BQU87U0FDVjthQUFNO1lBQ0gsU0FBUyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNwQztRQUNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMvQixJQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEtBQUssU0FBUyxFQUFHO1lBQ3hDLGlCQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxJQUFJLDhCQUE4QixDQUFDLENBQUE7U0FDdEU7YUFBTTtZQUNILElBQUksTUFBTSxHQUFtQyxRQUFRLENBQUM7WUFDdEQsSUFBSSxTQUFTLEdBQUcsU0FBUyxDQUFDO1lBQzFCLEtBQU0sSUFBSSxHQUFHLElBQUksT0FBTyxFQUFHO2dCQUN2QixJQUFLLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxTQUFTLEVBQUc7b0JBRTdCLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLGlCQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQzt3QkFDekMsS0FBSyxFQUFHLEdBQUcsR0FBRywwQ0FBMEM7d0JBQ3hELGlCQUFpQixFQUFHLFFBQVE7d0JBQzVCLFlBQVksRUFBRyxDQUFDLEtBQWtCLEVBQUUsRUFBRTs0QkFDbEMsSUFBSSxFQUFFLEdBQUcsVUFBSSxDQUFDLEVBQUUsV0FBVyxFQUFHLEtBQUssRUFBRSxRQUFRLEVBQUcsRUFBRSxPQUFPLEVBQUcsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUM7NEJBRWxGLEVBQUUsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUNiLFlBQU0sQ0FBQyxFQUFFLEdBQUcsRUFBRyxpQ0FBaUMsRUFBRSxJQUFJLEVBQUcsY0FBYyxFQUFFLENBQUM7aUNBQ3JFLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRyxRQUFRLEVBQUUsQ0FBQztpQ0FDekIsR0FBRyxDQUFDLEVBQUUsZUFBZSxFQUFHLFNBQVMsRUFBRSxLQUFLLEVBQUcsT0FBTyxFQUFFLENBQUM7aUNBQ3JELEtBQUssQ0FBQyxDQUFDLEVBQWMsRUFBRSxFQUFFO2dDQUV0QixNQUFNLEdBQUcsV0FBVyxDQUFDO2dDQUNyQixTQUFTLEdBQUcsSUFBSSxDQUFDO2dDQUNqQixJQUFJLEdBQUcsR0FBRyxDQUFDO2dDQUNYLGlCQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7NEJBQzFCLENBQUMsQ0FBQyxDQUNULENBQUE7d0JBQ0wsQ0FBQztxQkFDSixDQUFDLENBQUM7b0JBQ0gsSUFBSyxLQUFLLEVBQUc7d0JBQ1QsSUFBSSxHQUFHLEdBQUcsQ0FBQzt3QkFDWCxNQUFNLEdBQUcsS0FBSyxDQUFDO3dCQUNmLFNBQVMsR0FBRyxHQUFHLENBQUM7d0JBQ2hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO3dCQUNoRCxNQUFNO3FCQUNUO3lCQUFNLElBQUssQ0FBQyxTQUFTLEVBQUc7d0JBQ3JCLE9BQU87cUJBQ1Y7aUJBRUo7YUFDSjtZQUNELE1BQU0sY0FBYyxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFtQixDQUFDO1lBQ3RELGNBQUksQ0FBQyxTQUFTLENBQUMsZUFBZSxHQUFHLGNBQWMsQ0FBQztZQUNoRCxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3pDLElBQUssT0FBTyxTQUFTLEtBQUssUUFBUSxFQUFHO2dCQUNqQyxjQUFJLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO2dCQUM3RCxJQUFJLElBQUksR0FBRyxTQUFTLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQztnQkFDL0QsaUJBQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxLQUFLLElBQUksR0FBRyxDQUFDLENBQUM7YUFDckQ7aUJBQU07Z0JBQ0gsY0FBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxDQUFDO2dCQUNsRCxpQkFBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsa0JBQWtCLElBQUksR0FBRyxDQUFDLENBQUM7YUFFcEQ7WUFHRCxTQUFTLENBQUMsV0FBVyxHQUFHLFlBQVksSUFBSSxFQUFFLENBQUM7WUFDM0MsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFDOUMsU0FBUyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDckIsSUFBSyxjQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsRUFBRSxFQUFHO2dCQUM5QyxNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQzthQUNyQjtTQUVKO1FBQ0QsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDOUMsU0FBUyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7SUFHekIsQ0FBQztDQUVKO0FBR0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxXQUFXLENBQUMsRUFBRSxFQUFFLEVBQUcsY0FBYyxFQUFFLENBQUMsQ0FBQztBQUM3RCxrQkFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyAqICBwYWdlcy9OZXcvc2VjdGlvbnMvc2V0dGluZ3NcblxuLyoqXG4gKiBpbXBvcnQgc2VjdGlvbnMgZnJvbSBcIi4vc2VjdGlvbnNcIlxuICogc2VjdGlvbnMuc2V0dGluZ3MqL1xuaW1wb3J0IHsgZWxlbSwgRGl2LCBidXR0b24sIElucHV0LCBCdXR0b24gfSBmcm9tIFwiLi4vLi4vLi4vYmhlXCI7XG5cbmltcG9ydCB7IElucHV0U2VjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGUvZXh0cmFcIjtcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi8uLi9HbG9iXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcblxuaW1wb3J0IE15QWxlcnQgZnJvbSAnLi4vLi4vLi4vTXlBbGVydCdcbmltcG9ydCBteWZzIGZyb20gXCIuLi8uLi8uLi9NeUZzXCI7XG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi8uLi91dGlsXCI7XG5pbXBvcnQgeyBFeHBlcmltZW50VHlwZSwgZ2V0VHJ1dGhzV2l0aDNUeHRGaWxlcywgU3ViY29uZmlnIH0gZnJvbSBcIi4uLy4uLy4uL015U3RvcmVcIjtcblxuY2xhc3MgU2V0dGluZ3NEaXYgZXh0ZW5kcyBEaXYge1xuICAgIGZpbGVTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG4gICAgcHJpdmF0ZSBzdWJqZWN0U2VjdGlvbjogSW5wdXRTZWN0aW9uO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKHsgaWQgfSkge1xuICAgICAgICBzdXBlcih7IGlkIH0pO1xuICAgICAgICAvLyAqKiogIEZpbGVcbiAgICAgICAgLy8gY29uc3QgZXhwZXJpbWVudFR5cGUgPSBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGU7XG4gICAgICAgIC8vIGNvbnN0IHN1YmNvbmZpZ0ZpbGU6IHN0cmluZyA9IEdsb2IuQmlnQ29uZmlnW2Ake2V4cGVyaW1lbnRUeXBlfV9maWxlYF07XG4gICAgICAgIC8vIGNvbnN0IHN1YmNvbmZpZzogU3ViY29uZmlnID0gR2xvYi5CaWdDb25maWdbZXhwZXJpbWVudFR5cGVdO1xuICAgICAgICBjb25zdCBzdWJjb25maWc6IFN1YmNvbmZpZyA9IEdsb2IuQmlnQ29uZmlnLmdldFN1YmNvbmZpZygpO1xuICAgICAgICBjb25zdCBjb25maWdzOiBzdHJpbmdbXSA9IGZzLnJlYWRkaXJTeW5jKENPTkZJR1NfUEFUSF9BQlMpO1xuICAgICAgICBjb25zdCBmaWxlU2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXIgOiBgQ3VycmVudDogJHtzdWJjb25maWcubmFtZX1gLFxuICAgICAgICAgICAgaDN0ZXh0IDogYENvbmZpZyBGaWxlYCxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zIDogY29uZmlncyxcbiAgICAgICAgICAgIC8vIG92ZXJ3cml0ZVdhcm4gOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiBmaWxlU3VibWl0LCBpbnB1dEVsZW0gOiBmaWxlSW5wdXQgfSA9IGZpbGVTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgZmlsZVN1Ym1pdC5jbGljaygoKSA9PiB0aGlzLm9uRmlsZVN1Ym1pdChjb25maWdzLCBzdWJjb25maWcpKTtcbiAgICAgICAgXG4gICAgICAgIC8vICoqKiAgU3ViamVjdFxuICAgICAgICBjb25zdCBzdWJqZWN0cyA9IEdsb2IuQmlnQ29uZmlnLnN1YmplY3RzO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgY3VycmVudFN1YmplY3QgPSBzdWJjb25maWcuc3ViamVjdDtcbiAgICAgICAgY29uc3Qgc3ViamVjdFNlY3Rpb24gPSBuZXcgSW5wdXRTZWN0aW9uKHtcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyIDogYEN1cnJlbnQ6ICR7Y3VycmVudFN1YmplY3R9YCxcbiAgICAgICAgICAgIGgzdGV4dCA6ICdTdWJqZWN0JyxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zIDogc3ViamVjdHNcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uIDogc3ViamVjdFN1Ym1pdCwgaW5wdXRFbGVtIDogc3ViamVjdElucHV0IH0gPSBzdWJqZWN0U2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIHN1YmplY3RTdWJtaXQuY2xpY2soKCkgPT4gdGhpcy5vblN1YmplY3RTdWJtaXQoY3VycmVudFN1YmplY3QsIHN1YmNvbmZpZykpO1xuICAgICAgICBcbiAgICAgICAgLy8gKioqICBUcnV0aFxuICAgICAgICBjb25zdCB0cnV0aHNXaXRoM1R4dEZpbGVzID0gZ2V0VHJ1dGhzV2l0aDNUeHRGaWxlcygpO1xuICAgICAgICBjb25zb2xlLmxvZyh7IHRydXRoc1dpdGgzVHh0RmlsZXMgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB0cnV0aFNlY3Rpb24gPSBuZXcgSW5wdXRTZWN0aW9uKHtcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyIDogYEN1cnJlbnQ6ICR7c3ViY29uZmlnLnRydXRoX2ZpbGV9YCxcbiAgICAgICAgICAgIGgzdGV4dCA6ICdUcnV0aCcsXG4gICAgICAgICAgICBzdWdnZXN0aW9ucyA6IHRydXRoc1dpdGgzVHh0RmlsZXNcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzdWJ0aXRsZSA9IGVsZW0oeyB0YWcgOiAnaDInLCB0ZXh0IDogJ1NldHRpbmdzJyB9KTtcbiAgICAgICAgdGhpcy5jYWNoZUFwcGVuZCh7IHN1YnRpdGxlLCBmaWxlU2VjdGlvbiwgc3ViamVjdFNlY3Rpb24sIHRydXRoU2VjdGlvbiB9KVxuICAgICAgICAvKnRoaXMuY2FjaGVBcHBlbmQoe1xuICAgICAgICAgYWRkTGV2ZWxCdG4gOiBidXR0b24oeyBjbHMgOiAnYWN0aXZlJywgaHRtbCA6ICdBZGQgTGV2ZWwnLCBjbGljayA6IHRoaXMuYWRkTGV2ZWwgfSksXG4gICAgICAgICBcbiAgICAgICAgIH0pKi9cbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBvblN1YmplY3RTdWJtaXQoY3VycmVudFN1YmplY3Q6IHN0cmluZywgc3ViY29uZmlnOiBTdWJjb25maWcpIHtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiBzdWJqZWN0U3VibWl0LCBpbnB1dEVsZW0gOiBzdWJqZWN0SW5wdXQgfSA9IHRoaXMuc3ViamVjdFNlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4O1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHN1YmplY3RJbnB1dC52YWx1ZTtcbiAgICAgICAgaWYgKCBjdXJyZW50U3ViamVjdCA9PT0gdmFsdWUgKSB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50U3ViamVjdH0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBzdWJqZWN0YClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1YmNvbmZpZy5zdWJqZWN0ID0gdmFsdWU7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFN1YmplY3Qgc2V0OiAke3ZhbHVlfS5gKTtcbiAgICAgICAgICAgIHN1YmplY3RJbnB1dC5wbGFjZWhvbGRlciA9IGBDdXJyZW50OiAke3ZhbHVlfWA7XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBzdWJqZWN0U3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgIHN1YmplY3RJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgYXN5bmMgb25GaWxlU3VibWl0KGNvbmZpZ3M6IHN0cmluZ1tdLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdEJ1dHRvbiA6IGZpbGVTdWJtaXQsIGlucHV0RWxlbSA6IGZpbGVJbnB1dCB9ID0gdGhpcy5maWxlU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGxldCBmaWxlID0gZmlsZUlucHV0LnZhbHVlO1xuICAgICAgICBjb25zb2xlLmxvZygnZmlsZSBzdWJtaXQsJywgZmlsZSk7XG4gICAgICAgIGNvbnN0IFsgZmlsZW5hbWUsIGV4dCBdID0gbXlmcy5zcGxpdF9leHQoZmlsZSk7XG4gICAgICAgIGlmICggIVsgJy5leGFtJywgJy50ZXN0JyBdLmluY2x1ZGVzKGV4dCkgKSB7XG4gICAgICAgICAgICBmaWxlSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwud2FybmluZygnRmlsZSBuYW1lIG11c3QgZW5kIHdpdGggZWl0aGVyIC5leGFtIG9yIC50ZXN0Jyk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBmaWxlSW5wdXQucmVtb3ZlQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBmaWxlTG93ZXIgPSBmaWxlLmxvd2VyKCk7XG4gICAgICAgIGlmICggc3ViY29uZmlnLm5hbWUubG93ZXIoKSA9PT0gZmlsZUxvd2VyICkge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke3N1YmNvbmZpZy5uYW1lfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIGZpbGVgKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IGFjdGlvbjogXCJ1c2VcIiB8IFwib3ZlcndyaXRlXCIgfCBcImNyZWF0ZVwiID0gXCJjcmVhdGVcIjtcbiAgICAgICAgICAgIGxldCBvdmVyd3JpdGUgPSB1bmRlZmluZWQ7IC8vIHRydWUgd2hlbiBjbGlja3MgT3ZlcndyaXRlO1xuICAgICAgICAgICAgZm9yICggbGV0IGNmZyBvZiBjb25maWdzICkge1xuICAgICAgICAgICAgICAgIGlmICggY2ZnLmxvd2VyKCkgPT09IGZpbGVMb3dlciApIHtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IGF3YWl0IE15QWxlcnQuYmlnLmJsb2NraW5nKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlIDogYCR7Y2ZnfSBhbHJlYWR5IGV4aXN0cywgd2hhdCBkbyB5b3Ugd2FudCB0byBkbz9gLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQgOiAnVXNlIGl0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQmVmb3JlT3BlbiA6IChtb2RhbDogSFRNTEVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgZWwgPSBlbGVtKHsgaHRtbEVsZW1lbnQgOiBtb2RhbCwgY2hpbGRyZW4gOiB7IGFjdGlvbnMgOiAnLnN3YWwyLWFjdGlvbnMnIH0gfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLmFjdGlvbnMuYXBwZW5kKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b24oeyBjbHMgOiBcInN3YWwyLWNvbmZpcm0gc3dhbDItc3R5bGVkIHdhcm5cIiwgaHRtbCA6ICdPdmVyd3JpdGUgaXQnIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXR0cih7IHR5cGUgOiAnYnV0dG9uJyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNzcyh7IGJhY2tncm91bmRDb2xvciA6ICcjRkZDNjZEJywgY29sb3IgOiAnYmxhY2snIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY2xpY2soKGV2OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gXCJPdmVyd3JpdGUgaXRcIlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwib3ZlcndyaXRlXCI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTXlBbGVydC5jbGlja0NhbmNlbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIHZhbHVlICkgeyAvLyBcIlVzZSBpdFwiXG4gICAgICAgICAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb24gPSBcInVzZVwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlID0gY2ZnO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzZSBpdCcsIHsgZmlsZSwgY2ZnLCBvdmVyd3JpdGUgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggIW92ZXJ3cml0ZSApIHsgLy8gXCJDYW5jZWxcIlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGV4cGVyaW1lbnRUeXBlID0gZXh0LnNsaWNlKDEpIGFzIEV4cGVyaW1lbnRUeXBlO1xuICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuZXhwZXJpbWVudF90eXBlID0gZXhwZXJpbWVudFR5cGU7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyh7IG92ZXJ3cml0ZSwgYWN0aW9uLCBmaWxlIH0pO1xuICAgICAgICAgICAgaWYgKCB0eXBlb2Ygb3ZlcndyaXRlICE9PSAnc3RyaW5nJyApIHsgLy8gdW5kZWZpbmVkOiBuZXcgZmlsZSwgdHJ1ZTogY2xpY2tlZCBvdmVyd3JpdGUsXG4gICAgICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUsIGV4cGVyaW1lbnRUeXBlLCBzdWJjb25maWcpO1xuICAgICAgICAgICAgICAgIGxldCB2ZXJiID0gb3ZlcndyaXRlID09PSB1bmRlZmluZWQgPyAnY3JlYXRlZCcgOiAnb3ZlcndyaXR0ZW4nO1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnICR7dmVyYn06ICR7ZmlsZX0uYCk7XG4gICAgICAgICAgICB9IGVsc2UgeyAvLyBzdHJpbmc6IFwiVXNlIGl0XCJcbiAgICAgICAgICAgICAgICBHbG9iLkJpZ0NvbmZpZy5zZXRTdWJjb25maWcoZmlsZSwgZXhwZXJpbWVudFR5cGUpO1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnIGxvYWRlZDogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBmaWxlSW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHtmaWxlfWA7XG4gICAgICAgICAgICBmaWxlU3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICBmaWxlSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIGlmICggR2xvYi5CaWdDb25maWcuZGV2LnJlbG9hZF9wYWdlX29uX3N1Ym1pdCgpICkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgICAgICB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIGZpbGVTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgZmlsZUlucHV0LnZhbHVlID0gJyc7XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG59XG5cblxuY29uc3Qgc2V0dGluZ3NEaXYgPSBuZXcgU2V0dGluZ3NEaXYoeyBpZCA6ICdzZXR0aW5nc19kaXYnIH0pO1xuZXhwb3J0IGRlZmF1bHQgc2V0dGluZ3NEaXY7XG5cbiJdfQ==