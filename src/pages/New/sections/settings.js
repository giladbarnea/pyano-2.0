"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
const path = require("path");
const bhe_1 = require("../../../bhe");
class SettingsDiv extends bhe_1.Div {
    constructor({ setid }) {
        super({ setid });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const configSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        configSection.flex.submit.click(() => this.onConfigSubmit(configs, subconfig));
        configSection.flex.cacheAppend({ edit: bhe_1.button({ cls: 'edit' }) });
        configSection.flex.edit.click(async () => {
            const { spawnSync } = require('child_process');
            const { status } = spawnSync('code', [Glob_1.default.BigConfig.path]);
            if (status === null) {
                MyAlert_1.default.big.oneButton({
                    title: `Failed running command:\ncode ${Glob_1.default.BigConfig.path}`,
                    html: `Make sure Visual Studio Code is installed, and available through terminal by running:\n<code>code .</code>`
                });
            }
        });
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        subjectSection.flex.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        const currentTruth = subconfig.truth;
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${currentTruth.name}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles,
            illegalRegex: /[^(a-z0-9A-Z|_)]/
        });
        truthSection.flex.submit.click(() => this.onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles));
        const subtitle = bhe_1.elem({ tag: 'h2', html: 'Settings' });
        this.cacheAppend({ subtitle, configSection, subjectSection, truthSection });
    }
    async onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles) {
        const { submit: truthSubmit, input: truthInput } = this.truthSection.flex;
        let value = truthInput.value();
        let valueLower = value.lower();
        if (valueLower.endsWithAny('_on', '_off')) {
            console.warn(`onTruthSubmit value not a base txt: ${valueLower}. Cutting`);
            value = value.upTo('_', true);
            valueLower = value.lower();
        }
        console.log('onTruthSubmit', { value, currentTruth });
        if (currentTruth.name.lower() === valueLower) {
            MyAlert_1.default.small.info(`${currentTruth.name} was already the chosen truth`);
            truthSubmit.replaceClass('green', 'inactive');
            return truthInput.clear();
        }
        for (let truthName of truthsWith3TxtFiles) {
            let truthNameLower = truthName.lower();
            if (truthNameLower === valueLower) {
                subconfig.truth_file = truthName;
                truthInput.clear();
                truthInput.placeholder(`Current: ${truthName}`);
                truthSubmit.replaceClass('green', 'inactive');
                MyAlert_1.default.small.success(`Using truth: "${truthName}"`);
                await util.wait(3000);
                return util.reloadPage();
            }
        }
        return MyAlert_1.default.small.warning(`Either this truth doesn't exist completely, or doesn't have its 3 associated .txt files. Please choose an existing one.`);
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submit: subjectSubmit, input: subjectInput } = this.subjectSection.flex;
        const value = subjectInput.value();
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder(`Current: ${value}`);
        }
        subjectSubmit.replaceClass('green', 'inactive');
        subjectInput.clear();
    }
    async onConfigSubmit(configs, subconfig) {
        const { submit: configSubmit, input: configInput } = this.configSection.flex;
        let file = configInput.value();
        console.log('onConfigSubmit,', file);
        try {
            MyStore_1.Subconfig.validateName(file);
        }
        catch (e) {
            if (e.message === 'ExtensionError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            }
            if (e.message === 'BasenameError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning(`Insert just a file name, not a path with slashes. eg: "${path.basename(file)}"`);
            }
        }
        configInput.removeClass('invalid');
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
            configSubmit.replaceClass('green', 'inactive');
            return configInput.clear();
        }
        let action = "create";
        for (let cfg of configs) {
            if (cfg.lower() === fileLower) {
                action = await MyAlert_1.default.big.threeButtons({
                    title: `${cfg} already exists, what do you want to do?`,
                    confirmButtonText: 'Use it',
                    thirdButtonText: 'Overwrite it',
                    thirdButtonType: "warning"
                });
                if (action === "cancel") {
                    return;
                }
                file = cfg;
                break;
            }
        }
        const ext = path.extname(file);
        const experimentType = ext.slice(1);
        Glob_1.default.BigConfig.experiment_type = experimentType;
        console.log({ action, file });
        if (action === "confirm") {
            Glob_1.default.BigConfig.setSubconfig(file);
            MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            configInput.placeholder(`Current: ${file}`);
            configSubmit.replaceClass('green', 'inactive');
            configInput.clear();
            await util.wait(3000);
            util.reloadPage();
        }
        if (action === "create" || action === "third") {
            Glob_1.default.BigConfig.setSubconfig(file, subconfig);
            let verb = action === "third" ? 'overwritten' : 'created';
            MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            configInput.placeholder(`Current: ${file}`);
            configSubmit.replaceClass('green', 'inactive');
            configInput.clear();
            await util.wait(3000);
            util.reloadPage();
        }
    }
}
exports.SettingsDiv = SettingsDiv;
console.group('pages.New.sections.settings.ts');
const settingsDiv = new SettingsDiv({ setid: 'settings_div' });
console.groupEnd();
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQU1BLDhDQUFrRDtBQUNsRCx3Q0FBaUM7QUFDakMseUJBQXlCO0FBRXpCLDhDQUE4RDtBQUM5RCxzQ0FBc0M7QUFDdEMsOENBQXFGO0FBRXJGLDZCQUE2QjtBQUM3QixzQ0FBeUQ7QUFJekQsTUFBYSxXQUFZLFNBQVEsU0FBRztJQUtoQyxZQUFZLEVBQUUsS0FBSyxFQUFFO1FBQ2pCLEtBQUssQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFLakIsTUFBTSxTQUFTLEdBQWMsY0FBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMzRCxNQUFNLE9BQU8sR0FBYSxFQUFFLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0QsTUFBTSxhQUFhLEdBQUcsSUFBSSxvQkFBWSxDQUFDO1lBQ25DLFdBQVcsRUFBRSxZQUFZLFNBQVMsQ0FBQyxJQUFJLEVBQUU7WUFDekMsTUFBTSxFQUFFLGFBQWE7WUFDckIsV0FBVyxFQUFFLE9BQU87U0FDdkIsQ0FBQyxDQUFDO1FBRUgsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDL0UsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxJQUFJLEVBQUUsWUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWxFLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNyQyxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sRUFBRSxNQUFN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SUFBSSxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztBQUMvRCxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDbkIsa0JBQWUsV0FBVyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gKiAgcGFnZXMvTmV3L3NlY3Rpb25zL3NldHRpbmdzXG5cbi8qKlxuICogaW1wb3J0IHNlY3Rpb25zIGZyb20gXCIuL3NlY3Rpb25zXCJcbiAqIHNlY3Rpb25zLnNldHRpbmdzKi9cblxuaW1wb3J0IHsgSW5wdXRTZWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2JoZS9leHRyYVwiO1xuaW1wb3J0IEdsb2IgZnJvbSBcIi4uLy4uLy4uL0dsb2JcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuXG5pbXBvcnQgTXlBbGVydCwgeyBDcmVhdGVDb25maXJtVGhpcmQgfSBmcm9tICcuLi8uLi8uLi9NeUFsZXJ0J1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tIFwiLi4vLi4vLi4vdXRpbFwiO1xuaW1wb3J0IHsgRXhwZXJpbWVudFR5cGUsIGdldFRydXRoc1dpdGgzVHh0RmlsZXMsIFN1YmNvbmZpZyB9IGZyb20gXCIuLi8uLi8uLi9NeVN0b3JlXCI7XG5pbXBvcnQgeyBUcnV0aCB9IGZyb20gXCIuLi8uLi8uLi9UcnV0aFwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgYnV0dG9uLCBCdXR0b24sIERpdiwgZWxlbSB9IGZyb20gXCIuLi8uLi8uLi9iaGVcIjtcbi8vIFRPRE8gKENPTlRJTlVFKTpcbi8vICBiZXR0ZXJodG1sZWxlbWVudCBpbXBvcnRzIGRvbnQgd29yayBiZWNhdXNlIGkgZG9uJ3Qga25vdyBob3cgdG8gYnVuZGxlLlxuLy8gIGVpdGhlciBjbG9uZSBiaGUgYW5kIGNvbXBpbGUgb3IgdXNlIHdlYnBhY2s/XG5leHBvcnQgY2xhc3MgU2V0dGluZ3NEaXYgZXh0ZW5kcyBEaXYge1xuICAgIHByaXZhdGUgY29uZmlnU2VjdGlvbjogSW5wdXRTZWN0aW9uICYgeyBmbGV4OiB7IGVkaXQ6IEJ1dHRvbiB9IH07XG4gICAgcHJpdmF0ZSBzdWJqZWN0U2VjdGlvbjogSW5wdXRTZWN0aW9uO1xuICAgIHByaXZhdGUgdHJ1dGhTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG5cbiAgICBjb25zdHJ1Y3Rvcih7IHNldGlkIH0pIHtcbiAgICAgICAgc3VwZXIoeyBzZXRpZCB9KTtcbiAgICAgICAgLy8gKioqIEZpbGVcbiAgICAgICAgLy8gY29uc3QgZXhwZXJpbWVudFR5cGUgPSBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGU7XG4gICAgICAgIC8vIGNvbnN0IHN1YmNvbmZpZ0ZpbGU6IHN0cmluZyA9IEdsb2IuQmlnQ29uZmlnW2Ake2V4cGVyaW1lbnRUeXBlfV9maWxlYF07XG4gICAgICAgIC8vIGNvbnN0IHN1YmNvbmZpZzogU3ViY29uZmlnID0gR2xvYi5CaWdDb25maWdbZXhwZXJpbWVudFR5cGVdO1xuICAgICAgICBjb25zdCBzdWJjb25maWc6IFN1YmNvbmZpZyA9IEdsb2IuQmlnQ29uZmlnLmdldFN1YmNvbmZpZygpO1xuICAgICAgICBjb25zdCBjb25maWdzOiBzdHJpbmdbXSA9IGZzLnJlYWRkaXJTeW5jKENPTkZJR1NfUEFUSF9BQlMpO1xuICAgICAgICBjb25zdCBjb25maWdTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogYEN1cnJlbnQ6ICR7c3ViY29uZmlnLm5hbWV9YCxcbiAgICAgICAgICAgIGgzdGV4dDogYENvbmZpZyBGaWxlYCxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zOiBjb25maWdzLFxuICAgICAgICB9KTtcblxuICAgICAgICBjb25maWdTZWN0aW9uLmZsZXguc3VibWl0LmNsaWNrKCgpID0+IHRoaXMub25Db25maWdTdWJtaXQoY29uZmlncywgc3ViY29uZmlnKSk7XG4gICAgICAgIGNvbmZpZ1NlY3Rpb24uZmxleC5jYWNoZUFwcGVuZCh7IGVkaXQ6IGJ1dHRvbih7IGNsczogJ2VkaXQnIH0pIH0pO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbmZpZ1NlY3Rpb24uZmxleC5lZGl0LmNsaWNrKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHsgc3Bhd25TeW5jIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG4gICAgICAgICAgICBjb25zdCB7IHN0YXR1cyB9ID0gc3Bhd25TeW5jKCdjb2RlJywgW0dsb2IuQmlnQ29uZmlnLnBhdGhdKTtcbiAgICAgICAgICAgIGlmIChzdGF0dXMgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBNeUFsZXJ0LmJpZy5vbmVCdXR0b24oe1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogYEZhaWxlZCBydW5uaW5nIGNvbW1hbmQ6XFxuY29kZSAke0dsb2IuQmlnQ29uZmlnLnBhdGh9YCxcbiAgICAgICAgICAgICAgICAgICAgaHRtbDogYE1ha2Ugc3VyZSBWaXN1YWwgU3R1ZGlvIENvZGUgaXMgaW5zdGFsbGVkLCBhbmQgYXZhaWxhYmxlIHRocm91Z2ggdGVybWluYWwgYnkgcnVubmluZzpcXG48Y29kZT5jb2RlIC48L2NvZGU+YFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgICAgIC8vICoqKiBTdWJqZWN0XG4gICAgICAgIGNvbnN0IHN1YmplY3RzID0gR2xvYi5CaWdDb25maWcuc3ViamVjdHM7XG5cbiAgICAgICAgY29uc3QgY3VycmVudFN1YmplY3QgPSBzdWJjb25maWcuc3ViamVjdDtcbiAgICAgICAgY29uc3Qgc3ViamVjdFNlY3Rpb24gPSBuZXcgSW5wdXRTZWN0aW9uKHtcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBgQ3VycmVudDogJHtjdXJyZW50U3ViamVjdH1gLFxuICAgICAgICAgICAgaDN0ZXh0OiAnU3ViamVjdCcsXG4gICAgICAgICAgICBzdWdnZXN0aW9uczogc3ViamVjdHNcbiAgICAgICAgfSk7XG4gICAgICAgIHN1YmplY3RTZWN0aW9uLmZsZXguY2xpY2soKCkgPT4gdGhpcy5vblN1YmplY3RTdWJtaXQoY3VycmVudFN1YmplY3QsIHN1YmNvbmZpZykpO1xuXG4gICAgICAgIC8vICoqKiBUcnV0aFxuICAgICAgICBjb25zdCB0cnV0aHNXaXRoM1R4dEZpbGVzID0gZ2V0VHJ1dGhzV2l0aDNUeHRGaWxlcygpO1xuICAgICAgICBjb25zdCBjdXJyZW50VHJ1dGggPSBzdWJjb25maWcudHJ1dGg7XG4gICAgICAgIGNvbnN0IHRydXRoU2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXI6IGBDdXJyZW50OiAke2N1cnJlbnRUcnV0aC5uYW1lfWAsXG4gICAgICAgICAgICBoM3RleHQ6ICdUcnV0aCcsXG4gICAgICAgICAgICBzdWdnZXN0aW9uczogdHJ1dGhzV2l0aDNUeHRGaWxlcyxcbiAgICAgICAgICAgIGlsbGVnYWxSZWdleDogL1teKGEtejAtOUEtWnxfKV0vXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRydXRoU2VjdGlvbi5mbGV4LnN1Ym1pdC5jbGljaygoKSA9PiB0aGlzLm9uVHJ1dGhTdWJtaXQoY3VycmVudFRydXRoLCBzdWJjb25maWcsIHRydXRoc1dpdGgzVHh0RmlsZXMpKTtcblxuICAgICAgICBjb25zdCBzdWJ0aXRsZSA9IGVsZW0oeyB0YWc6ICdoMicsIGh0bWw6ICdTZXR0aW5ncycgfSk7XG4gICAgICAgIHRoaXMuY2FjaGVBcHBlbmQoeyBzdWJ0aXRsZSwgY29uZmlnU2VjdGlvbiwgc3ViamVjdFNlY3Rpb24sIHRydXRoU2VjdGlvbiB9KVxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBvblRydXRoU3VibWl0KGN1cnJlbnRUcnV0aDogVHJ1dGgsIHN1YmNvbmZpZzogU3ViY29uZmlnLCB0cnV0aHNXaXRoM1R4dEZpbGVzOiBzdHJpbmdbXSkge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdDogdHJ1dGhTdWJtaXQsIGlucHV0OiB0cnV0aElucHV0IH0gPSB0aGlzLnRydXRoU2VjdGlvbi5mbGV4O1xuICAgICAgICBsZXQgdmFsdWUgPSB0cnV0aElucHV0LnZhbHVlKCk7XG4gICAgICAgIGxldCB2YWx1ZUxvd2VyID0gdmFsdWUubG93ZXIoKTtcbiAgICAgICAgaWYgKHZhbHVlTG93ZXIuZW5kc1dpdGhBbnkoJ19vbicsICdfb2ZmJykpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2Fybihgb25UcnV0aFN1Ym1pdCB2YWx1ZSBub3QgYSBiYXNlIHR4dDogJHt2YWx1ZUxvd2VyfS4gQ3V0dGluZ2ApO1xuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS51cFRvKCdfJywgdHJ1ZSk7XG4gICAgICAgICAgICB2YWx1ZUxvd2VyID0gdmFsdWUubG93ZXIoKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZygnb25UcnV0aFN1Ym1pdCcsIHsgdmFsdWUsIGN1cnJlbnRUcnV0aCB9KTtcblxuICAgICAgICAvLyAvIENob3NlbiBpcyBhbHJlYWR5IGN1cnJlbnRseSBzZXRcbiAgICAgICAgaWYgKGN1cnJlbnRUcnV0aC5uYW1lLmxvd2VyKCkgPT09IHZhbHVlTG93ZXIpIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50VHJ1dGgubmFtZX0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiB0cnV0aGApO1xuICAgICAgICAgICAgdHJ1dGhTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgcmV0dXJuIHRydXRoSW5wdXQuY2xlYXIoKTtcblxuICAgICAgICB9XG5cbiAgICAgICAgLy8gLyBEaWZmZXJlbnQgZnJvbSBjdXJyZW50LCBjaGVjayBpZiBleGlzdHMgaW4gXCJ3aG9sZVwiIHRydXRoc1xuICAgICAgICBmb3IgKGxldCB0cnV0aE5hbWUgb2YgdHJ1dGhzV2l0aDNUeHRGaWxlcykge1xuICAgICAgICAgICAgbGV0IHRydXRoTmFtZUxvd2VyID0gdHJ1dGhOYW1lLmxvd2VyKCk7XG4gICAgICAgICAgICBpZiAodHJ1dGhOYW1lTG93ZXIgPT09IHZhbHVlTG93ZXIpIHtcbiAgICAgICAgICAgICAgICBzdWJjb25maWcudHJ1dGhfZmlsZSA9IHRydXRoTmFtZTtcbiAgICAgICAgICAgICAgICB0cnV0aElucHV0LmNsZWFyKCk7XG4gICAgICAgICAgICAgICAgdHJ1dGhJbnB1dC5wbGFjZWhvbGRlcihgQ3VycmVudDogJHt0cnV0aE5hbWV9YCk7XG4gICAgICAgICAgICAgICAgdHJ1dGhTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgVXNpbmcgdHJ1dGg6IFwiJHt0cnV0aE5hbWV9XCJgKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vIC8gRWl0aGVyIGV4aXN0cyBpbiBcInBhcnRpYWxcIiB0cnV0aHMgb3Igbm90IGF0IGFsbFxuICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKGBFaXRoZXIgdGhpcyB0cnV0aCBkb2Vzbid0IGV4aXN0IGNvbXBsZXRlbHksIG9yIGRvZXNuJ3QgaGF2ZSBpdHMgMyBhc3NvY2lhdGVkIC50eHQgZmlsZXMuIFBsZWFzZSBjaG9vc2UgYW4gZXhpc3Rpbmcgb25lLmApXG5cblxuICAgIH1cblxuICAgIHByaXZhdGUgb25TdWJqZWN0U3VibWl0KGN1cnJlbnRTdWJqZWN0OiBzdHJpbmcsIHN1YmNvbmZpZzogU3ViY29uZmlnKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0OiBzdWJqZWN0U3VibWl0LCBpbnB1dDogc3ViamVjdElucHV0IH0gPSB0aGlzLnN1YmplY3RTZWN0aW9uLmZsZXg7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gc3ViamVjdElucHV0LnZhbHVlKCk7XG5cbiAgICAgICAgaWYgKGN1cnJlbnRTdWJqZWN0ID09PSB2YWx1ZSkge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke2N1cnJlbnRTdWJqZWN0fSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIHN1YmplY3RgKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3ViY29uZmlnLnN1YmplY3QgPSB2YWx1ZTtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgU3ViamVjdCBzZXQ6ICR7dmFsdWV9LmApO1xuICAgICAgICAgICAgc3ViamVjdElucHV0LnBsYWNlaG9sZGVyKGBDdXJyZW50OiAke3ZhbHVlfWApO1xuXG4gICAgICAgIH1cbiAgICAgICAgc3ViamVjdFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2dyZWVuJywgJ2luYWN0aXZlJyk7XG4gICAgICAgIHN1YmplY3RJbnB1dC5jbGVhcigpO1xuXG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIG9uQ29uZmlnU3VibWl0KGNvbmZpZ3M6IHN0cmluZ1tdLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdDogY29uZmlnU3VibWl0LCBpbnB1dDogY29uZmlnSW5wdXQgfSA9IHRoaXMuY29uZmlnU2VjdGlvbi5mbGV4O1xuICAgICAgICBsZXQgZmlsZSA9IGNvbmZpZ0lucHV0LnZhbHVlKCk7XG4gICAgICAgIC8vIGNvbnN0IFsgZmlsZW5hbWUsIGV4dCBdID0gbXlmcy5zcGxpdF9leHQoZmlsZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdvbkNvbmZpZ1N1Ym1pdCwnLCBmaWxlKTtcbiAgICAgICAgLy8vLyBDaGVjayBmb3IgYmFkIGV4dGVuc2lvbiBvciBiYWQgZmlsZW5hbWVcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIFN1YmNvbmZpZy52YWxpZGF0ZU5hbWUoZmlsZSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdFeHRlbnNpb25FcnJvcicpIHtcbiAgICAgICAgICAgICAgICBjb25maWdJbnB1dC5hZGRDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBNeUFsZXJ0LnNtYWxsLndhcm5pbmcoJ0ZpbGUgbmFtZSBtdXN0IGVuZCB3aXRoIGVpdGhlciAuZXhhbSBvciAudGVzdCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGUubWVzc2FnZSA9PT0gJ0Jhc2VuYW1lRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKGBJbnNlcnQganVzdCBhIGZpbGUgbmFtZSwgbm90IGEgcGF0aCB3aXRoIHNsYXNoZXMuIGVnOiBcIiR7cGF0aC5iYXNlbmFtZShmaWxlKX1cImApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8vLyBFeHRlbnNpb24gYW5kIGZpbGUgbmFtZSBvazsgY2hlY2sgaWYgdXNlciBjaG9zZSB3aGF0J3MgY3VycmVudGx5IHNldFxuICAgICAgICBjb25maWdJbnB1dC5yZW1vdmVDbGFzcygnaW52YWxpZCcpO1xuXG4gICAgICAgIGNvbnN0IGZpbGVMb3dlciA9IGZpbGUubG93ZXIoKTtcbiAgICAgICAgaWYgKHN1YmNvbmZpZy5uYW1lLmxvd2VyKCkgPT09IGZpbGVMb3dlcikge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke3N1YmNvbmZpZy5uYW1lfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIGZpbGVgKTtcbiAgICAgICAgICAgIGNvbmZpZ1N1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2dyZWVuJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICByZXR1cm4gY29uZmlnSW5wdXQuY2xlYXIoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vLy8gQ2hvc2VuIHNvbWV0aGluZyBlbHNlOyBjaGVjayBpZiBleGlzdHNcbiAgICAgICAgbGV0IGFjdGlvbjogQ3JlYXRlQ29uZmlybVRoaXJkIHwgXCJjcmVhdGVcIiA9IFwiY3JlYXRlXCI7IC8vIGNyZWF0ZSAoZG9lc250IGV4aXN0KSwgY29uZmlybSAodXNlIGV4aXN0aW5nKSwgb3ZlcndyaXRlIChvbiB0b3Agb2YgZXhpc3RpbmcpLCBjYW5jZWxcblxuICAgICAgICBmb3IgKGxldCBjZmcgb2YgY29uZmlncykge1xuICAgICAgICAgICAgaWYgKGNmZy5sb3dlcigpID09PSBmaWxlTG93ZXIpIHtcbiAgICAgICAgICAgICAgICBhY3Rpb24gPSBhd2FpdCBNeUFsZXJ0LmJpZy50aHJlZUJ1dHRvbnMoe1xuICAgICAgICAgICAgICAgICAgICB0aXRsZTogYCR7Y2ZnfSBhbHJlYWR5IGV4aXN0cywgd2hhdCBkbyB5b3Ugd2FudCB0byBkbz9gLFxuICAgICAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dDogJ1VzZSBpdCcsXG4gICAgICAgICAgICAgICAgICAgIHRoaXJkQnV0dG9uVGV4dDogJ092ZXJ3cml0ZSBpdCcsXG4gICAgICAgICAgICAgICAgICAgIHRoaXJkQnV0dG9uVHlwZTogXCJ3YXJuaW5nXCJcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAvKlxuICAgICAgICAgICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBNeUFsZXJ0LmJpZy5ibG9ja2luZyh7XG4gICAgICAgICAgICAgICAgIHRpdGxlIDogYCR7Y2ZnfSBhbHJlYWR5IGV4aXN0cywgd2hhdCBkbyB5b3Ugd2FudCB0byBkbz9gLFxuICAgICAgICAgICAgICAgICBjb25maXJtQnV0dG9uVGV4dCA6ICdVc2UgaXQnLFxuICAgICAgICAgICAgICAgICBvbkJlZm9yZU9wZW4gOiAobW9kYWw6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgIGxldCBlbCA9IGVsZW0oeyBodG1sRWxlbWVudCA6IG1vZGFsLCBjaGlsZHJlbiA6IHsgYWN0aW9ucyA6ICcuc3dhbDItYWN0aW9ucycgfSB9KTtcbiAgICAgICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgICAgICBlbC5hY3Rpb25zLmFwcGVuZChcbiAgICAgICAgICAgICAgICAgYnV0dG9uKHsgY2xzIDogXCJzd2FsMi1jb25maXJtIHN3YWwyLXN0eWxlZCB3YXJuXCIsIGh0bWwgOiAnT3ZlcndyaXRlIGl0JyB9KVxuICAgICAgICAgICAgICAgICAuYXR0cih7IHR5cGUgOiAnYnV0dG9uJyB9KVxuICAgICAgICAgICAgICAgICAuY3NzKHsgYmFja2dyb3VuZENvbG9yIDogJyNGRkM2NkQnLCBjb2xvciA6ICdibGFjaycgfSlcbiAgICAgICAgICAgICAgICAgLmNsaWNrKChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAvLyBcIk92ZXJ3cml0ZSBpdFwiXG4gICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwib3ZlcndyaXRlXCI7XG4gICAgICAgICAgICAgICAgIG92ZXJ3cml0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgIGZpbGUgPSBjZmc7IC8vIG1hdGNoIGNhc2VcbiAgICAgICAgICAgICAgICAgTXlBbGVydC5jbGlja0NhbmNlbCgpO1xuICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICovXG5cbiAgICAgICAgICAgICAgICBpZiAoYWN0aW9uID09PSBcImNhbmNlbFwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8vLyBcIk92ZXJ3cml0ZVwiIG9yIFwiVXNlIGl0XCJcbiAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cblxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vLy8gRWl0aGVyIGV4aXN0cyB0aGVuIGxvYWQgb3Igb3ZlcndyaXRlIGl0LCBvciBjb21wbGV0ZWx5IG5ld1xuICAgICAgICBjb25zdCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZSk7XG4gICAgICAgIGNvbnN0IGV4cGVyaW1lbnRUeXBlID0gZXh0LnNsaWNlKDEpIGFzIEV4cGVyaW1lbnRUeXBlO1xuICAgICAgICBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGUgPSBleHBlcmltZW50VHlwZTtcbiAgICAgICAgY29uc29sZS5sb2coeyBhY3Rpb24sIGZpbGUgfSk7XG4gICAgICAgIGlmIChhY3Rpb24gPT09IFwiY29uZmlybVwiKSB7IC8vIEV4aXN0cywgXCJVc2UgaXRcIlxuICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUpO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBDb25maWcgbG9hZGVkOiAke2ZpbGV9LmApO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQucGxhY2Vob2xkZXIoYEN1cnJlbnQ6ICR7ZmlsZX1gKTtcbiAgICAgICAgICAgIGNvbmZpZ1N1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2dyZWVuJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICBjb25maWdJbnB1dC5jbGVhcigpO1xuICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KDMwMDApO1xuICAgICAgICAgICAgdXRpbC5yZWxvYWRQYWdlKCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gXCJjcmVhdGVcIiB8fCBhY3Rpb24gPT09IFwidGhpcmRcIikge1xuICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUsIHN1YmNvbmZpZyk7XG4gICAgICAgICAgICBsZXQgdmVyYiA9IGFjdGlvbiA9PT0gXCJ0aGlyZFwiID8gJ292ZXJ3cml0dGVuJyA6ICdjcmVhdGVkJztcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnICR7dmVyYn06ICR7ZmlsZX0uYCk7XG4gICAgICAgICAgICBjb25maWdJbnB1dC5wbGFjZWhvbGRlcihgQ3VycmVudDogJHtmaWxlfWApO1xuICAgICAgICAgICAgY29uZmlnU3VibWl0LnJlcGxhY2VDbGFzcygnZ3JlZW4nLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LmNsZWFyKCk7XG4gICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgfVxuXG5cbiAgICB9XG5cbn1cblxuY29uc29sZS5ncm91cCgncGFnZXMuTmV3LnNlY3Rpb25zLnNldHRpbmdzLnRzJyk7XG5jb25zdCBzZXR0aW5nc0RpdiA9IG5ldyBTZXR0aW5nc0Rpdih7IHNldGlkOiAnc2V0dGluZ3NfZGl2JyB9KTtcbmNvbnNvbGUuZ3JvdXBFbmQoKTtcbmV4cG9ydCBkZWZhdWx0IHNldHRpbmdzRGl2O1xuXG4iXX0=