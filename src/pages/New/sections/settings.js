"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const MyFs_1 = require("../../../MyFs");
const util = require("../../../util");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const experimentType = Glob_1.default.BigConfig.experiment_type;
        const subconfigFile = Glob_1.default.BigConfig[`${experimentType}_file`];
        const subconfig = Glob_1.default.BigConfig[experimentType];
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const fileSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfigFile}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        const { submitButton: fileSubmit, inputElem: fileInput } = fileSection.inputAndSubmitFlex;
        fileSubmit.click(() => this.onFileSubmit(subconfigFile, configs, subconfig));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submitButton: subjectSubmit, inputElem: subjectInput } = subjectSection.inputAndSubmitFlex;
        subjectSubmit.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, fileSection, subjectSection });
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submitButton: subjectSubmit, inputElem: subjectInput } = this.subjectSection.inputAndSubmitFlex;
        const value = subjectInput.value;
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder = `Current: ${value}`;
        }
        subjectSubmit.replaceClass('active', 'inactive');
        subjectInput.value = '';
    }
    async onFileSubmit(subconfigFile, configs, subconfig) {
        const { submitButton: fileSubmit, inputElem: fileInput } = this.fileSection.inputAndSubmitFlex;
        const file = fileInput.value;
        console.log('file submit,', file);
        const [filename, ext] = MyFs_1.default.split_ext(file);
        if (!['.exam', '.test'].includes(ext)) {
            fileInput.addClass('invalid');
            MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            return;
        }
        else {
            fileInput.removeClass('invalid');
        }
        const fileLower = file.lower();
        if (subconfigFile.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfigFile} was already the chosen file`);
        }
        else {
            let overwrite;
            for (let cfg of configs) {
                if (cfg.lower() === fileLower) {
                    const { value } = await MyAlert_1.default.big.blocking({
                        title: `${cfg} already exists, what do you want to do?`,
                        confirmButtonText: 'Use it',
                        onBeforeOpen: (modal) => {
                            let el = bhe_1.elem({ htmlElement: modal, children: { actions: '.swal2-actions' } });
                            el.actions.append(bhe_1.button({ cls: "swal2-confirm swal2-styled warn", html: 'Overwrite it' })
                                .attr({ type: 'button' })
                                .css({ backgroundColor: '#FFC66D', color: 'black' })
                                .click((ev) => {
                                overwrite = true;
                                MyAlert_1.default.clickCancel();
                            }));
                        }
                    });
                    if (value) {
                        overwrite = cfg;
                        break;
                    }
                    else if (!overwrite) {
                        return;
                    }
                }
            }
            const experimentType = ext.slice(1);
            Glob_1.default.BigConfig.experiment_type = experimentType;
            console.log({ overwrite });
            if (typeof overwrite !== 'string') {
                Glob_1.default.BigConfig.setSubconfig(file, experimentType, subconfig);
                let verb = overwrite === undefined ? 'created' : 'overwritten';
                MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            }
            else {
                Glob_1.default.BigConfig.setSubconfig(file, experimentType);
                MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            }
            fileInput.placeholder = `Current: ${file}`;
            fileSubmit.replaceClass('active', 'inactive');
            fileInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
        fileSubmit.replaceClass('active', 'inactive');
        fileInput.value = '';
    }
}
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBc0M7QUFDdEMsd0NBQWlDO0FBQ2pDLHNDQUFzQztBQUd0QyxNQUFNLFdBQVksU0FBUSxTQUFHO0lBSXpCLFlBQVksRUFBRSxFQUFFLEVBQUU7UUFDZCxLQUFLLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRWQsTUFBTSxjQUFjLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUM7UUFDdEQsTUFBTSxhQUFhLEdBQVcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLGNBQWMsT0FBTyxDQUFDLENBQUM7UUFDdkUsTUFBTSxTQUFTLEdBQWMsY0FBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUM1RCxNQUFNLE9BQU8sR0FBYSxFQUFFLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0QsTUFBTSxXQUFXLEdBQUcsSUFBSSxvQkFBWSxDQUFDO1lBQ2pDLFdBQVcsRUFBRyxZQUFZLGFBQWEsRUFBRTtZQUN6QyxNQUFNLEVBQUcsYUFBYTtZQUN0QixXQUFXLEVBQUcsT0FBTztTQUV4QixDQUFDLENBQUM7UUFFSCxNQUFNLEVBQUUsWUFBWSxFQUFHLFVBQVUsRUFBRSxTQUFTLEVBQUcsU0FBUyxFQUFFLEdBQUcsV0FBVyxDQUFDLGtCQUFrQixDQUFDO1FBQzVGLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFHN0UsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFFekMsTUFBTSxjQUFjLEdBQUcsU0FBUyxD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KipcbiAqIGltcG9ydCBzZWN0aW9ucyBmcm9tIFwiLi9zZWN0aW9uc1wiXG4gKiBzZWN0aW9ucy5zZXR0aW5ncyovXG5pbXBvcnQgeyBlbGVtLCBEaXYsIGJ1dHRvbiwgSW5wdXQsIEJ1dHRvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGVcIjtcblxuaW1wb3J0IHsgSW5wdXRTZWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2JoZS9leHRyYVwiO1xuaW1wb3J0IEdsb2IgZnJvbSBcIi4uLy4uLy4uL0dsb2JcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuXG5pbXBvcnQgTXlBbGVydCBmcm9tICcuLi8uLi8uLi9NeUFsZXJ0J1xuaW1wb3J0IG15ZnMgZnJvbSBcIi4uLy4uLy4uL015RnNcIjtcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSBcIi4uLy4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IEV4cGVyaW1lbnRUeXBlLCBTdWJjb25maWcgfSBmcm9tIFwiLi4vLi4vLi4vTXlTdG9yZVwiO1xuXG5jbGFzcyBTZXR0aW5nc0RpdiBleHRlbmRzIERpdiB7XG4gICAgZmlsZVNlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBwcml2YXRlIHN1YmplY3RTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG4gICAgXG4gICAgY29uc3RydWN0b3IoeyBpZCB9KSB7XG4gICAgICAgIHN1cGVyKHsgaWQgfSk7XG4gICAgICAgIC8vICoqKiAgRmlsZVxuICAgICAgICBjb25zdCBleHBlcmltZW50VHlwZSA9IEdsb2IuQmlnQ29uZmlnLmV4cGVyaW1lbnRfdHlwZTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnRmlsZTogc3RyaW5nID0gR2xvYi5CaWdDb25maWdbYCR7ZXhwZXJpbWVudFR5cGV9X2ZpbGVgXTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnOiBTdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZ1tleHBlcmltZW50VHlwZV07XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IHN0cmluZ1tdID0gZnMucmVhZGRpclN5bmMoQ09ORklHU19QQVRIX0FCUyk7XG4gICAgICAgIGNvbnN0IGZpbGVTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlciA6IGBDdXJyZW50OiAke3N1YmNvbmZpZ0ZpbGV9YCxcbiAgICAgICAgICAgIGgzdGV4dCA6IGBDb25maWcgRmlsZWAsXG4gICAgICAgICAgICBzdWdnZXN0aW9ucyA6IGNvbmZpZ3MsXG4gICAgICAgICAgICAvLyBvdmVyd3JpdGVXYXJuIDogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uIDogZmlsZVN1Ym1pdCwgaW5wdXRFbGVtIDogZmlsZUlucHV0IH0gPSBmaWxlU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGZpbGVTdWJtaXQuY2xpY2soKCkgPT4gdGhpcy5vbkZpbGVTdWJtaXQoc3ViY29uZmlnRmlsZSwgY29uZmlncywgc3ViY29uZmlnKSk7XG4gICAgICAgIFxuICAgICAgICAvLyAqKiogIFN1YmplY3RcbiAgICAgICAgY29uc3Qgc3ViamVjdHMgPSBHbG9iLkJpZ0NvbmZpZy5zdWJqZWN0cztcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGN1cnJlbnRTdWJqZWN0ID0gc3ViY29uZmlnLnN1YmplY3Q7XG4gICAgICAgIGNvbnN0IHN1YmplY3RTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlciA6IGBDdXJyZW50OiAke2N1cnJlbnRTdWJqZWN0fWAsXG4gICAgICAgICAgICBoM3RleHQgOiAnU3ViamVjdCcsXG4gICAgICAgICAgICBzdWdnZXN0aW9ucyA6IHN1YmplY3RzXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB7IHN1Ym1pdEJ1dHRvbiA6IHN1YmplY3RTdWJtaXQsIGlucHV0RWxlbSA6IHN1YmplY3RJbnB1dCB9ID0gc3ViamVjdFNlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4O1xuICAgICAgICBzdWJqZWN0U3VibWl0LmNsaWNrKCgpID0+IHRoaXMub25TdWJqZWN0U3VibWl0KGN1cnJlbnRTdWJqZWN0LCBzdWJjb25maWcpKTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICBjb25zdCBzdWJ0aXRsZSA9IGVsZW0oeyB0YWcgOiAnaDInLCB0ZXh0IDogJ1NldHRpbmdzJyB9KTtcbiAgICAgICAgdGhpcy5jYWNoZUFwcGVuZCh7IHN1YnRpdGxlLCBmaWxlU2VjdGlvbiwgc3ViamVjdFNlY3Rpb24gfSlcbiAgICAgICAgLyp0aGlzLmNhY2hlQXBwZW5kKHtcbiAgICAgICAgIGFkZExldmVsQnRuIDogYnV0dG9uKHsgY2xzIDogJ2FjdGl2ZScsIGh0bWwgOiAnQWRkIExldmVsJywgY2xpY2sgOiB0aGlzLmFkZExldmVsIH0pLFxuICAgICAgICAgXG4gICAgICAgICB9KSovXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgb25TdWJqZWN0U3VibWl0KGN1cnJlbnRTdWJqZWN0OiBzdHJpbmcsIHN1YmNvbmZpZzogU3ViY29uZmlnKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uIDogc3ViamVjdFN1Ym1pdCwgaW5wdXRFbGVtIDogc3ViamVjdElucHV0IH0gPSB0aGlzLnN1YmplY3RTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBzdWJqZWN0SW5wdXQudmFsdWU7XG4gICAgICAgIGlmICggY3VycmVudFN1YmplY3QgPT09IHZhbHVlICkge1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLmluZm8oYCR7Y3VycmVudFN1YmplY3R9IHdhcyBhbHJlYWR5IHRoZSBjaG9zZW4gc3ViamVjdGApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdWJjb25maWcuc3ViamVjdCA9IHZhbHVlO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBTdWJqZWN0IHNldDogJHt2YWx1ZX0uYCk7XG4gICAgICAgICAgICBzdWJqZWN0SW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHt2YWx1ZX1gO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgc3ViamVjdFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICBzdWJqZWN0SW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGFzeW5jIG9uRmlsZVN1Ym1pdChzdWJjb25maWdGaWxlOiBzdHJpbmcsIGNvbmZpZ3M6IHN0cmluZ1tdLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdEJ1dHRvbiA6IGZpbGVTdWJtaXQsIGlucHV0RWxlbSA6IGZpbGVJbnB1dCB9ID0gdGhpcy5maWxlU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGNvbnN0IGZpbGUgPSBmaWxlSW5wdXQudmFsdWU7XG4gICAgICAgIGNvbnNvbGUubG9nKCdmaWxlIHN1Ym1pdCwnLCBmaWxlKTtcbiAgICAgICAgY29uc3QgWyBmaWxlbmFtZSwgZXh0IF0gPSBteWZzLnNwbGl0X2V4dChmaWxlKTtcbiAgICAgICAgaWYgKCAhWyAnLmV4YW0nLCAnLnRlc3QnIF0uaW5jbHVkZXMoZXh0KSApIHtcbiAgICAgICAgICAgIGZpbGVJbnB1dC5hZGRDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC53YXJuaW5nKCdGaWxlIG5hbWUgbXVzdCBlbmQgd2l0aCBlaXRoZXIgLmV4YW0gb3IgLnRlc3QnKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZpbGVJbnB1dC5yZW1vdmVDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZpbGVMb3dlciA9IGZpbGUubG93ZXIoKTtcbiAgICAgICAgaWYgKCBzdWJjb25maWdGaWxlLmxvd2VyKCkgPT09IGZpbGVMb3dlciApIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtzdWJjb25maWdGaWxlfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIGZpbGVgKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbGV0IG92ZXJ3cml0ZTtcbiAgICAgICAgICAgIGZvciAoIGxldCBjZmcgb2YgY29uZmlncyApIHtcbiAgICAgICAgICAgICAgICBpZiAoIGNmZy5sb3dlcigpID09PSBmaWxlTG93ZXIgKSB7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBNeUFsZXJ0LmJpZy5ibG9ja2luZyh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZSA6IGAke2NmZ30gYWxyZWFkeSBleGlzdHMsIHdoYXQgZG8geW91IHdhbnQgdG8gZG8/YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm1CdXR0b25UZXh0IDogJ1VzZSBpdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBvbkJlZm9yZU9wZW4gOiAobW9kYWw6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGVsID0gZWxlbSh7IGh0bWxFbGVtZW50IDogbW9kYWwsIGNoaWxkcmVuIDogeyBhY3Rpb25zIDogJy5zd2FsMi1hY3Rpb25zJyB9IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5hY3Rpb25zLmFwcGVuZChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uKHsgY2xzIDogXCJzd2FsMi1jb25maXJtIHN3YWwyLXN0eWxlZCB3YXJuXCIsIGh0bWwgOiAnT3ZlcndyaXRlIGl0JyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmF0dHIoeyB0eXBlIDogJ2J1dHRvbicgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jc3MoeyBiYWNrZ3JvdW5kQ29sb3IgOiAnI0ZGQzY2RCcsIGNvbG9yIDogJ2JsYWNrJyB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNsaWNrKChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG92ZXJ3cml0ZSA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTXlBbGVydC5jbGlja0NhbmNlbCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIHZhbHVlICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgb3ZlcndyaXRlID0gY2ZnO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoICFvdmVyd3JpdGUgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgZXhwZXJpbWVudFR5cGUgPSBleHQuc2xpY2UoMSkgYXMgRXhwZXJpbWVudFR5cGU7XG4gICAgICAgICAgICBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGUgPSBleHBlcmltZW50VHlwZTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHsgb3ZlcndyaXRlIH0pO1xuICAgICAgICAgICAgaWYgKCB0eXBlb2Ygb3ZlcndyaXRlICE9PSAnc3RyaW5nJyApIHsgLy8gdW5kZWZpbmVkOiBuZXcgZmlsZSwgdHJ1ZTogY2xpY2tlZCBvdmVyd3JpdGUsXG4gICAgICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUsIGV4cGVyaW1lbnRUeXBlLCBzdWJjb25maWcpO1xuICAgICAgICAgICAgICAgIGxldCB2ZXJiID0gb3ZlcndyaXRlID09PSB1bmRlZmluZWQgPyAnY3JlYXRlZCcgOiAnb3ZlcndyaXR0ZW4nO1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnICR7dmVyYn06ICR7ZmlsZX0uYCk7XG4gICAgICAgICAgICB9IGVsc2UgeyAvLyBzdHJpbmc6IFwiVXNlIGl0XCJcbiAgICAgICAgICAgICAgICBHbG9iLkJpZ0NvbmZpZy5zZXRTdWJjb25maWcoZmlsZSwgZXhwZXJpbWVudFR5cGUpO1xuICAgICAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnIGxvYWRlZDogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBmaWxlSW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHtmaWxlfWA7XG4gICAgICAgICAgICBmaWxlU3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICBmaWxlSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgZmlsZVN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICBmaWxlSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbn1cblxuXG5jb25zdCBzZXR0aW5nc0RpdiA9IG5ldyBTZXR0aW5nc0Rpdih7IGlkIDogJ3NldHRpbmdzX2RpdicgfSk7XG5leHBvcnQgZGVmYXVsdCBzZXR0aW5nc0RpdjtcblxuIl19