"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
const path = require("path");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const configSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        configSection.flex.submit.click(() => this.onConfigSubmit(configs, subconfig));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submit: subjectSubmit } = subjectSection.flex;
        subjectSubmit.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        const currentTruth = subconfig.truth;
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${currentTruth.name}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles,
            illegalRegex: /[^(a-z0-9A-Z|_)]/
        });
        truthSection.flex.submit.click(() => this.onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles));
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, configSection, subjectSection, truthSection });
    }
    async onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles) {
        const { submit: truthSubmit, input: truthInput } = this.truthSection.flex;
        let value = truthInput.value;
        let valueLower = value.lower();
        if (valueLower.endsWithAny('_on', '_off')) {
            console.warn(`onTruthSubmit value not a base txt: ${valueLower}. Cutting`);
            value = value.upTo('_', true);
            valueLower = value.lower();
        }
        console.log('onTruthSubmit', { value, currentTruth });
        if (currentTruth.name.lower() === valueLower) {
            MyAlert_1.default.small.info(`${currentTruth.name} was already the chosen truth`);
            truthSubmit.replaceClass('green', 'inactive');
            return truthInput.value = '';
        }
        for (let truthName of truthsWith3TxtFiles) {
            let truthNameLower = truthName.lower();
            if (truthNameLower === valueLower) {
                subconfig.truth_file = truthName;
                truthInput.value = '';
                truthInput.placeholder = `Current: ${truthName}`;
                truthSubmit.replaceClass('green', 'inactive');
                MyAlert_1.default.small.success(`Using truth: "${truthName}"`);
                await util.wait(3000);
                return util.reloadPage();
            }
        }
        return MyAlert_1.default.small.warning(`Either this truth doesn't exist completely, or doesn't have its 3 associated .txt files. Please choose an existing one.`);
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submit: subjectSubmit, input: subjectInput } = this.subjectSection.flex;
        const value = subjectInput.value;
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder = `Current: ${value}`;
        }
        subjectSubmit.replaceClass('green', 'inactive');
        subjectInput.value = '';
    }
    async onConfigSubmit(configs, subconfig) {
        const { submit: configSubmit, input: configInput } = this.configSection.flex;
        let file = configInput.value;
        console.log('onConfigSubmit,', file);
        try {
            MyStore_1.Subconfig.validateName(file);
        }
        catch (e) {
            if (e.message === 'ExtensionError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            }
            if (e.message === 'BasenameError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning(`Insert just a file name, not a path with slashes. eg: "${path.basename(file)}"`);
            }
        }
        configInput.removeClass('invalid');
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
            configSubmit.replaceClass('green', 'inactive');
            return configInput.value = '';
        }
        let action = "create";
        for (let cfg of configs) {
            if (cfg.lower() === fileLower) {
                action = await MyAlert_1.default.big.threeButtons({
                    title: `${cfg} already exists, what do you want to do?`,
                    confirmButtonText: 'Use it',
                    thirdButtonText: 'Overwrite it',
                    thirdButtonType: "warning"
                });
                if (action === "cancel") {
                    return;
                }
                file = cfg;
                break;
            }
        }
        const ext = path.extname(file);
        const experimentType = ext.slice(1);
        Glob_1.default.BigConfig.experiment_type = experimentType;
        console.log({ action, file });
        if (action === "confirm") {
            Glob_1.default.BigConfig.setSubconfig(file);
            MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('green', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
        if (action === "create" || action === "third") {
            Glob_1.default.BigConfig.setSubconfig(file, subconfig);
            let verb = action === "third" ? 'overwritten' : 'created';
            MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('green', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
    }
}
exports.SettingsDiv = SettingsDiv;
console.group('pages.New.sections.settings.ts');
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
console.groupEnd();
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBOEQ7QUFDOUQsc0NBQXNDO0FBQ3RDLDhDQUFxRjtBQUVyRiw2QkFBNkI7QUFFN0IsTUFBYSxXQUFZLFNBQVEsU0FBRztJQUtoQyxZQUFZLEVBQUUsRUFBRSxFQUFFO1FBQ2QsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUtkLE1BQU0sU0FBUyxHQUFjLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDM0QsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNELE1BQU0sYUFBYSxHQUFHLElBQUksb0JBQVksQ0FBQztZQUNuQyxXQUFXLEVBQUUsWUFBWSxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQ3pDLE1BQU0sRUFBRSxhQUFhO1lBQ3JCLFdBQVcsRUFBRSxPQUFPO1NBQ3ZCLENBQUMsQ0FBQztRQUVILGFBQWEsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBRy9FLE1BQU0sUUFBUSxHQUFHLGNBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1FBRXpDLE1BQU0sY0FBYyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUM7UUFDekMsTUFBTSxjQUFjLEdBQUcsSUFBSSxvQkFBWSxDQUFDO1lBQ3BDLFdBQVcsRUFBRSxZQUFZLGNBQWMsRUFBRTtZQUN6QyxNQUFNLEVBQUUsU0FBUztZQUNqQixXQUFXLEVBQUUsUUFBUTtTQUN4QixDQUFDLENBQUM7UUFDSCxNQUFNLEVBQUUsTUFBTSxFQUFFLGFB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QU0sS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQzFELGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksS0FBSyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ2xELFdBQVcsQ0FBQyxXQUFXLEdBQUcsWUFBWSxJQUFJLEVBQUUsQ0FBQztZQUM3QyxZQUFZLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztZQUMvQyxXQUFXLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUN2QixNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ3JCO0lBR0wsQ0FBQztDQUVKO0FBL01ELGtDQStNQztBQUVELE9BQU8sQ0FBQyxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztBQUNoRCxNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxjQUFjLEVBQUUsQ0FBQyxDQUFDO0FBQzVELE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUNuQixrQkFBZSxXQUFXLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyAqICBwYWdlcy9OZXcvc2VjdGlvbnMvc2V0dGluZ3NcblxuLyoqXG4gKiBpbXBvcnQgc2VjdGlvbnMgZnJvbSBcIi4vc2VjdGlvbnNcIlxuICogc2VjdGlvbnMuc2V0dGluZ3MqL1xuaW1wb3J0IHsgZWxlbSwgRGl2LCBidXR0b24sIElucHV0LCBCdXR0b24gfSBmcm9tIFwiLi4vLi4vLi4vYmhlXCI7XG5cbmltcG9ydCB7IElucHV0U2VjdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGUvZXh0cmFcIjtcbmltcG9ydCBHbG9iIGZyb20gXCIuLi8uLi8uLi9HbG9iXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnNcIjtcblxuaW1wb3J0IE15QWxlcnQsIHsgQ3JlYXRlQ29uZmlybVRoaXJkIH0gZnJvbSAnLi4vLi4vLi4vTXlBbGVydCdcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSBcIi4uLy4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IEV4cGVyaW1lbnRUeXBlLCBnZXRUcnV0aHNXaXRoM1R4dEZpbGVzLCBTdWJjb25maWcgfSBmcm9tIFwiLi4vLi4vLi4vTXlTdG9yZVwiO1xuaW1wb3J0IHsgVHJ1dGggfSBmcm9tIFwiLi4vLi4vLi4vVHJ1dGhcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcblxuZXhwb3J0IGNsYXNzIFNldHRpbmdzRGl2IGV4dGVuZHMgRGl2IHtcbiAgICBwcml2YXRlIGNvbmZpZ1NlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBwcml2YXRlIHN1YmplY3RTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG4gICAgcHJpdmF0ZSB0cnV0aFNlY3Rpb246IElucHV0U2VjdGlvbjtcblxuICAgIGNvbnN0cnVjdG9yKHsgaWQgfSkge1xuICAgICAgICBzdXBlcih7IGlkIH0pO1xuICAgICAgICAvLyAqKiogRmlsZVxuICAgICAgICAvLyBjb25zdCBleHBlcmltZW50VHlwZSA9IEdsb2IuQmlnQ29uZmlnLmV4cGVyaW1lbnRfdHlwZTtcbiAgICAgICAgLy8gY29uc3Qgc3ViY29uZmlnRmlsZTogc3RyaW5nID0gR2xvYi5CaWdDb25maWdbYCR7ZXhwZXJpbWVudFR5cGV9X2ZpbGVgXTtcbiAgICAgICAgLy8gY29uc3Qgc3ViY29uZmlnOiBTdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZ1tleHBlcmltZW50VHlwZV07XG4gICAgICAgIGNvbnN0IHN1YmNvbmZpZzogU3ViY29uZmlnID0gR2xvYi5CaWdDb25maWcuZ2V0U3ViY29uZmlnKCk7XG4gICAgICAgIGNvbnN0IGNvbmZpZ3M6IHN0cmluZ1tdID0gZnMucmVhZGRpclN5bmMoQ09ORklHU19QQVRIX0FCUyk7XG4gICAgICAgIGNvbnN0IGNvbmZpZ1NlY3Rpb24gPSBuZXcgSW5wdXRTZWN0aW9uKHtcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBgQ3VycmVudDogJHtzdWJjb25maWcubmFtZX1gLFxuICAgICAgICAgICAgaDN0ZXh0OiBgQ29uZmlnIEZpbGVgLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IGNvbmZpZ3MsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbmZpZ1NlY3Rpb24uZmxleC5zdWJtaXQuY2xpY2soKCkgPT4gdGhpcy5vbkNvbmZpZ1N1Ym1pdChjb25maWdzLCBzdWJjb25maWcpKTtcblxuICAgICAgICAvLyAqKiogU3ViamVjdFxuICAgICAgICBjb25zdCBzdWJqZWN0cyA9IEdsb2IuQmlnQ29uZmlnLnN1YmplY3RzO1xuXG4gICAgICAgIGNvbnN0IGN1cnJlbnRTdWJqZWN0ID0gc3ViY29uZmlnLnN1YmplY3Q7XG4gICAgICAgIGNvbnN0IHN1YmplY3RTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogYEN1cnJlbnQ6ICR7Y3VycmVudFN1YmplY3R9YCxcbiAgICAgICAgICAgIGgzdGV4dDogJ1N1YmplY3QnLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IHN1YmplY3RzXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB7IHN1Ym1pdDogc3ViamVjdFN1Ym1pdCB9ID0gc3ViamVjdFNlY3Rpb24uZmxleDtcbiAgICAgICAgc3ViamVjdFN1Ym1pdC5jbGljaygoKSA9PiB0aGlzLm9uU3ViamVjdFN1Ym1pdChjdXJyZW50U3ViamVjdCwgc3ViY29uZmlnKSk7XG5cbiAgICAgICAgLy8gKioqIFRydXRoXG4gICAgICAgIGNvbnN0IHRydXRoc1dpdGgzVHh0RmlsZXMgPSBnZXRUcnV0aHNXaXRoM1R4dEZpbGVzKCk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUcnV0aCA9IHN1YmNvbmZpZy50cnV0aDtcbiAgICAgICAgY29uc3QgdHJ1dGhTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogYEN1cnJlbnQ6ICR7Y3VycmVudFRydXRoLm5hbWV9YCxcbiAgICAgICAgICAgIGgzdGV4dDogJ1RydXRoJyxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zOiB0cnV0aHNXaXRoM1R4dEZpbGVzLFxuICAgICAgICAgICAgaWxsZWdhbFJlZ2V4OiAvW14oYS16MC05QS1afF8pXS9cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdHJ1dGhTZWN0aW9uLmZsZXguc3VibWl0LmNsaWNrKCgpID0+IHRoaXMub25UcnV0aFN1Ym1pdChjdXJyZW50VHJ1dGgsIHN1YmNvbmZpZywgdHJ1dGhzV2l0aDNUeHRGaWxlcykpO1xuXG4gICAgICAgIGNvbnN0IHN1YnRpdGxlID0gZWxlbSh7IHRhZzogJ2gyJywgdGV4dDogJ1NldHRpbmdzJyB9KTtcbiAgICAgICAgdGhpcy5jYWNoZUFwcGVuZCh7IHN1YnRpdGxlLCBjb25maWdTZWN0aW9uLCBzdWJqZWN0U2VjdGlvbiwgdHJ1dGhTZWN0aW9uIH0pXG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIG9uVHJ1dGhTdWJtaXQoY3VycmVudFRydXRoOiBUcnV0aCwgc3ViY29uZmlnOiBTdWJjb25maWcsIHRydXRoc1dpdGgzVHh0RmlsZXM6IHN0cmluZ1tdKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0OiB0cnV0aFN1Ym1pdCwgaW5wdXQ6IHRydXRoSW5wdXQgfSA9IHRoaXMudHJ1dGhTZWN0aW9uLmZsZXg7XG4gICAgICAgIGxldCB2YWx1ZSA9IHRydXRoSW5wdXQudmFsdWU7XG4gICAgICAgIGxldCB2YWx1ZUxvd2VyID0gdmFsdWUubG93ZXIoKTtcbiAgICAgICAgaWYgKHZhbHVlTG93ZXIuZW5kc1dpdGhBbnkoJ19vbicsICdfb2ZmJykpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2Fybihgb25UcnV0aFN1Ym1pdCB2YWx1ZSBub3QgYSBiYXNlIHR4dDogJHt2YWx1ZUxvd2VyfS4gQ3V0dGluZ2ApO1xuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS51cFRvKCdfJywgdHJ1ZSk7XG4gICAgICAgICAgICB2YWx1ZUxvd2VyID0gdmFsdWUubG93ZXIoKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZygnb25UcnV0aFN1Ym1pdCcsIHsgdmFsdWUsIGN1cnJlbnRUcnV0aCB9KTtcblxuICAgICAgICAvLyAvIENob3NlbiBpcyBhbHJlYWR5IGN1cnJlbnRseSBzZXRcbiAgICAgICAgaWYgKGN1cnJlbnRUcnV0aC5uYW1lLmxvd2VyKCkgPT09IHZhbHVlTG93ZXIpIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50VHJ1dGgubmFtZX0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiB0cnV0aGApO1xuICAgICAgICAgICAgdHJ1dGhTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgcmV0dXJuIHRydXRoSW5wdXQudmFsdWUgPSAnJztcblxuICAgICAgICB9XG5cbiAgICAgICAgLy8gLyBEaWZmZXJlbnQgZnJvbSBjdXJyZW50LCBjaGVjayBpZiBleGlzdHMgaW4gXCJ3aG9sZVwiIHRydXRoc1xuICAgICAgICBmb3IgKGxldCB0cnV0aE5hbWUgb2YgdHJ1dGhzV2l0aDNUeHRGaWxlcykge1xuICAgICAgICAgICAgbGV0IHRydXRoTmFtZUxvd2VyID0gdHJ1dGhOYW1lLmxvd2VyKCk7XG4gICAgICAgICAgICBpZiAodHJ1dGhOYW1lTG93ZXIgPT09IHZhbHVlTG93ZXIpIHtcbiAgICAgICAgICAgICAgICBzdWJjb25maWcudHJ1dGhfZmlsZSA9IHRydXRoTmFtZTtcbiAgICAgICAgICAgICAgICB0cnV0aElucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICAgICAgdHJ1dGhJbnB1dC5wbGFjZWhvbGRlciA9IGBDdXJyZW50OiAke3RydXRoTmFtZX1gO1xuICAgICAgICAgICAgICAgIHRydXRoU3VibWl0LnJlcGxhY2VDbGFzcygnZ3JlZW4nLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFVzaW5nIHRydXRoOiBcIiR7dHJ1dGhOYW1lfVwiYCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KDMwMDApO1xuICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyAvIEVpdGhlciBleGlzdHMgaW4gXCJwYXJ0aWFsXCIgdHJ1dGhzIG9yIG5vdCBhdCBhbGxcbiAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwud2FybmluZyhgRWl0aGVyIHRoaXMgdHJ1dGggZG9lc24ndCBleGlzdCBjb21wbGV0ZWx5LCBvciBkb2Vzbid0IGhhdmUgaXRzIDMgYXNzb2NpYXRlZCAudHh0IGZpbGVzLiBQbGVhc2UgY2hvb3NlIGFuIGV4aXN0aW5nIG9uZS5gKVxuXG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU3ViamVjdFN1Ym1pdChjdXJyZW50U3ViamVjdDogc3RyaW5nLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdDogc3ViamVjdFN1Ym1pdCwgaW5wdXQ6IHN1YmplY3RJbnB1dCB9ID0gdGhpcy5zdWJqZWN0U2VjdGlvbi5mbGV4O1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHN1YmplY3RJbnB1dC52YWx1ZTtcblxuICAgICAgICBpZiAoY3VycmVudFN1YmplY3QgPT09IHZhbHVlKSB7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLmluZm8oYCR7Y3VycmVudFN1YmplY3R9IHdhcyBhbHJlYWR5IHRoZSBjaG9zZW4gc3ViamVjdGApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdWJjb25maWcuc3ViamVjdCA9IHZhbHVlO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBTdWJqZWN0IHNldDogJHt2YWx1ZX0uYCk7XG4gICAgICAgICAgICBzdWJqZWN0SW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHt2YWx1ZX1gO1xuXG4gICAgICAgIH1cbiAgICAgICAgc3ViamVjdFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2dyZWVuJywgJ2luYWN0aXZlJyk7XG4gICAgICAgIHN1YmplY3RJbnB1dC52YWx1ZSA9ICcnO1xuXG5cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIG9uQ29uZmlnU3VibWl0KGNvbmZpZ3M6IHN0cmluZ1tdLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdDogY29uZmlnU3VibWl0LCBpbnB1dDogY29uZmlnSW5wdXQgfSA9IHRoaXMuY29uZmlnU2VjdGlvbi5mbGV4O1xuICAgICAgICBsZXQgZmlsZSA9IGNvbmZpZ0lucHV0LnZhbHVlO1xuICAgICAgICAvLyBjb25zdCBbIGZpbGVuYW1lLCBleHQgXSA9IG15ZnMuc3BsaXRfZXh0KGZpbGUpO1xuICAgICAgICBjb25zb2xlLmxvZygnb25Db25maWdTdWJtaXQsJywgZmlsZSk7XG4gICAgICAgIC8vLy8gQ2hlY2sgZm9yIGJhZCBleHRlbnNpb24gb3IgYmFkIGZpbGVuYW1lXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBTdWJjb25maWcudmFsaWRhdGVOYW1lKGZpbGUpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAoZS5tZXNzYWdlID09PSAnRXh0ZW5zaW9uRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKCdGaWxlIG5hbWUgbXVzdCBlbmQgd2l0aCBlaXRoZXIgLmV4YW0gb3IgLnRlc3QnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdCYXNlbmFtZUVycm9yJykge1xuICAgICAgICAgICAgICAgIGNvbmZpZ0lucHV0LmFkZENsYXNzKCdpbnZhbGlkJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwud2FybmluZyhgSW5zZXJ0IGp1c3QgYSBmaWxlIG5hbWUsIG5vdCBhIHBhdGggd2l0aCBzbGFzaGVzLiBlZzogXCIke3BhdGguYmFzZW5hbWUoZmlsZSl9XCJgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vLy8gRXh0ZW5zaW9uIGFuZCBmaWxlIG5hbWUgb2s7IGNoZWNrIGlmIHVzZXIgY2hvc2Ugd2hhdCdzIGN1cnJlbnRseSBzZXRcbiAgICAgICAgY29uZmlnSW5wdXQucmVtb3ZlQ2xhc3MoJ2ludmFsaWQnKTtcblxuICAgICAgICBjb25zdCBmaWxlTG93ZXIgPSBmaWxlLmxvd2VyKCk7XG4gICAgICAgIGlmIChzdWJjb25maWcubmFtZS5sb3dlcigpID09PSBmaWxlTG93ZXIpIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtzdWJjb25maWcubmFtZX0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBmaWxlYCk7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ0lucHV0LnZhbHVlID0gJyc7XG4gICAgICAgIH1cblxuICAgICAgICAvLy8vIENob3NlbiBzb21ldGhpbmcgZWxzZTsgY2hlY2sgaWYgZXhpc3RzXG4gICAgICAgIGxldCBhY3Rpb246IENyZWF0ZUNvbmZpcm1UaGlyZCB8IFwiY3JlYXRlXCIgPSBcImNyZWF0ZVwiOyAvLyBjcmVhdGUgKGRvZXNudCBleGlzdCksIGNvbmZpcm0gKHVzZSBleGlzdGluZyksIG92ZXJ3cml0ZSAob24gdG9wIG9mIGV4aXN0aW5nKSwgY2FuY2VsXG5cbiAgICAgICAgZm9yIChsZXQgY2ZnIG9mIGNvbmZpZ3MpIHtcbiAgICAgICAgICAgIGlmIChjZmcubG93ZXIoKSA9PT0gZmlsZUxvd2VyKSB7XG4gICAgICAgICAgICAgICAgYWN0aW9uID0gYXdhaXQgTXlBbGVydC5iaWcudGhyZWVCdXR0b25zKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IGAke2NmZ30gYWxyZWFkeSBleGlzdHMsIHdoYXQgZG8geW91IHdhbnQgdG8gZG8/YCxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6ICdVc2UgaXQnLFxuICAgICAgICAgICAgICAgICAgICB0aGlyZEJ1dHRvblRleHQ6ICdPdmVyd3JpdGUgaXQnLFxuICAgICAgICAgICAgICAgICAgICB0aGlyZEJ1dHRvblR5cGU6IFwid2FybmluZ1wiXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gYXdhaXQgTXlBbGVydC5iaWcuYmxvY2tpbmcoe1xuICAgICAgICAgICAgICAgICB0aXRsZSA6IGAke2NmZ30gYWxyZWFkeSBleGlzdHMsIHdoYXQgZG8geW91IHdhbnQgdG8gZG8/YCxcbiAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQgOiAnVXNlIGl0JyxcbiAgICAgICAgICAgICAgICAgb25CZWZvcmVPcGVuIDogKG1vZGFsOiBIVE1MRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICBsZXQgZWwgPSBlbGVtKHsgaHRtbEVsZW1lbnQgOiBtb2RhbCwgY2hpbGRyZW4gOiB7IGFjdGlvbnMgOiAnLnN3YWwyLWFjdGlvbnMnIH0gfSk7XG4gICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgZWwuYWN0aW9ucy5hcHBlbmQoXG4gICAgICAgICAgICAgICAgIGJ1dHRvbih7IGNscyA6IFwic3dhbDItY29uZmlybSBzd2FsMi1zdHlsZWQgd2FyblwiLCBodG1sIDogJ092ZXJ3cml0ZSBpdCcgfSlcbiAgICAgICAgICAgICAgICAgLmF0dHIoeyB0eXBlIDogJ2J1dHRvbicgfSlcbiAgICAgICAgICAgICAgICAgLmNzcyh7IGJhY2tncm91bmRDb2xvciA6ICcjRkZDNjZEJywgY29sb3IgOiAnYmxhY2snIH0pXG4gICAgICAgICAgICAgICAgIC5jbGljaygoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgLy8gXCJPdmVyd3JpdGUgaXRcIlxuICAgICAgICAgICAgICAgICBhY3Rpb24gPSBcIm92ZXJ3cml0ZVwiO1xuICAgICAgICAgICAgICAgICBvdmVyd3JpdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgIE15QWxlcnQuY2xpY2tDYW5jZWwoKTtcbiAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gXCJjYW5jZWxcIikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vLy8gXCJPdmVyd3JpdGVcIiBvciBcIlVzZSBpdFwiXG4gICAgICAgICAgICAgICAgZmlsZSA9IGNmZzsgLy8gbWF0Y2ggY2FzZVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLy8vIEVpdGhlciBleGlzdHMgdGhlbiBsb2FkIG9yIG92ZXJ3cml0ZSBpdCwgb3IgY29tcGxldGVseSBuZXdcbiAgICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGUpO1xuICAgICAgICBjb25zdCBleHBlcmltZW50VHlwZSA9IGV4dC5zbGljZSgxKSBhcyBFeHBlcmltZW50VHlwZTtcbiAgICAgICAgR2xvYi5CaWdDb25maWcuZXhwZXJpbWVudF90eXBlID0gZXhwZXJpbWVudFR5cGU7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgYWN0aW9uLCBmaWxlIH0pO1xuICAgICAgICBpZiAoYWN0aW9uID09PSBcImNvbmZpcm1cIikgeyAvLyBFeGlzdHMsIFwiVXNlIGl0XCJcbiAgICAgICAgICAgIEdsb2IuQmlnQ29uZmlnLnNldFN1YmNvbmZpZyhmaWxlKTtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnIGxvYWRlZDogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7ZmlsZX1gO1xuICAgICAgICAgICAgY29uZmlnU3VibWl0LnJlcGxhY2VDbGFzcygnZ3JlZW4nLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYWN0aW9uID09PSBcImNyZWF0ZVwiIHx8IGFjdGlvbiA9PT0gXCJ0aGlyZFwiKSB7XG4gICAgICAgICAgICBHbG9iLkJpZ0NvbmZpZy5zZXRTdWJjb25maWcoZmlsZSwgc3ViY29uZmlnKTtcbiAgICAgICAgICAgIGxldCB2ZXJiID0gYWN0aW9uID09PSBcInRoaXJkXCIgPyAnb3ZlcndyaXR0ZW4nIDogJ2NyZWF0ZWQnO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBDb25maWcgJHt2ZXJifTogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7ZmlsZX1gO1xuICAgICAgICAgICAgY29uZmlnU3VibWl0LnJlcGxhY2VDbGFzcygnZ3JlZW4nLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgfVxuXG5cbiAgICB9XG5cbn1cblxuY29uc29sZS5ncm91cCgncGFnZXMuTmV3LnNlY3Rpb25zLnNldHRpbmdzLnRzJyk7XG5jb25zdCBzZXR0aW5nc0RpdiA9IG5ldyBTZXR0aW5nc0Rpdih7IGlkOiAnc2V0dGluZ3NfZGl2JyB9KTtcbmNvbnNvbGUuZ3JvdXBFbmQoKTtcbmV4cG9ydCBkZWZhdWx0IHNldHRpbmdzRGl2O1xuXG4iXX0=