"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
const path = require("path");
const bhe_1 = require("../../../bhe");
class SettingsDiv extends bhe_1.Div {
    constructor({ byid }) {
        super({ byid });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const configSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        configSection.flex.submit.click(() => this.onConfigSubmit(configs, subconfig));
        configSection.flex.cacheAppend({ edit: bhe_1.button({ cls: 'edit' }) });
        configSection.flex.edit.click(async () => {
            const { spawnSync } = require('child_process');
            const { status } = spawnSync('code', [Glob_1.default.BigConfig.path]);
            if (status === null) {
                MyAlert_1.default.big.oneButton({
                    title: `Failed running command:\ncode ${Glob_1.default.BigConfig.path}`,
                    html: `Make sure Visual Studio Code is installed, and available through terminal by running:\n<code>code .</code>`
                });
            }
        });
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        subjectSection.flex.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        const currentTruth = subconfig.truth;
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${currentTruth.name}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles,
            illegalRegex: /[^(a-z0-9A-Z|_)]/
        });
        truthSection.flex.submit.click(() => this.onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles));
        const subtitle = bhe_1.elem({ tag: 'h2', html: 'Settings' });
        this.cacheAppend({ subtitle, configSection, subjectSection, truthSection });
    }
    async onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles) {
        const { submit: truthSubmit, input: truthInput } = this.truthSection.flex;
        let value = truthInput.value();
        let valueLower = value.lower();
        if (valueLower.endsWithAny('_on', '_off')) {
            console.warn(`onTruthSubmit value not a base txt: ${valueLower}. Cutting`);
            value = value.upTo('_', true);
            valueLower = value.lower();
        }
        console.log('onTruthSubmit', { value, currentTruth });
        if (currentTruth.name.lower() === valueLower) {
            MyAlert_1.default.small.info(`${currentTruth.name} was already the chosen truth`);
            truthSubmit.replaceClass('green', 'inactive');
            return truthInput.clear();
        }
        for (let truthName of truthsWith3TxtFiles) {
            let truthNameLower = truthName.lower();
            if (truthNameLower === valueLower) {
                subconfig.truth_file = truthName;
                truthInput.clear();
                truthInput.placeholder(`Current: ${truthName}`);
                truthSubmit.replaceClass('green', 'inactive');
                MyAlert_1.default.small.success(`Using truth: "${truthName}"`);
                await util.wait(3000);
                return util.reloadPage();
            }
        }
        return MyAlert_1.default.small.warning(`Either this truth doesn't exist completely, or doesn't have its 3 associated .txt files. Please choose an existing one.`);
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submit: subjectSubmit, input: subjectInput } = this.subjectSection.flex;
        const value = subjectInput.value();
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder(`Current: ${value}`);
        }
        subjectSubmit.replaceClass('green', 'inactive');
        subjectInput.clear();
    }
    async onConfigSubmit(configs, subconfig) {
        const { submit: configSubmit, input: configInput } = this.configSection.flex;
        let file = configInput.value();
        console.log('onConfigSubmit,', file);
        try {
            MyStore_1.Subconfig.validateName(file);
        }
        catch (e) {
            if (e.message === 'ExtensionError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            }
            if (e.message === 'BasenameError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning(`Insert just a file name, not a path with slashes. eg: "${path.basename(file)}"`);
            }
        }
        configInput.removeClass('invalid');
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
            configSubmit.replaceClass('green', 'inactive');
            return configInput.clear();
        }
        let action = "create";
        for (let cfg of configs) {
            if (cfg.lower() === fileLower) {
                action = await MyAlert_1.default.big.threeButtons({
                    title: `${cfg} already exists, what do you want to do?`,
                    confirmButtonText: 'Use it',
                    thirdButtonText: 'Overwrite it',
                    thirdButtonType: "warning"
                });
                if (action === "cancel") {
                    return;
                }
                file = cfg;
                break;
            }
        }
        const ext = path.extname(file);
        const experimentType = ext.slice(1);
        Glob_1.default.BigConfig.experiment_type = experimentType;
        console.log({ action, file });
        if (action === "confirm") {
            Glob_1.default.BigConfig.setSubconfig(file);
            MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            configInput.placeholder(`Current: ${file}`);
            configSubmit.replaceClass('green', 'inactive');
            configInput.clear();
            await util.wait(3000);
            util.reloadPage();
        }
        if (action === "create" || action === "third") {
            Glob_1.default.BigConfig.setSubconfig(file, subconfig);
            let verb = action === "third" ? 'overwritten' : 'created';
            MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            configInput.placeholder(`Current: ${file}`);
            configSubmit.replaceClass('green', 'inactive');
            configInput.clear();
            await util.wait(3000);
            util.reloadPage();
        }
    }
}
exports.SettingsDiv = SettingsDiv;
console.group('pages.New.sections.settings.ts');
const settingsDiv = new SettingsDiv({ byid: 'settings_div' });
console.groupEnd();
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQU1BLDhDQUFrRDtBQUNsRCx3Q0FBaUM7QUFDakMseUJBQXlCO0FBRXpCLDhDQUE4RDtBQUM5RCxzQ0FBc0M7QUFDdEMsOENBQXFGO0FBRXJGLDZCQUE2QjtBQUM3QixzQ0FBeUQ7QUFJekQsTUFBYSxXQUFZLFNBQVEsU0FBRztJQUtoQyxZQUFZLEVBQUUsSUFBSSxFQUFFO1FBQ2hCLEtBQUssQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFLaEIsTUFBTSxTQUFTLEdBQWMsY0FBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMzRCxNQUFNLE9BQU8sR0FBYSxFQUFFLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0QsTUFBTSxhQUFhLEdBQUcsSUFBSSxvQkFBWSxDQUFDO1lBQ25DLFdBQVcsRUFBRSxZQUFZLFNBQVMsQ0FBQyxJQUFJLEVBQUU7WUFDekMsTUFBTSxFQUFFLGFBQWE7WUFDckIsV0FBVyxFQUFFLE9BQU87U0FDdkIsQ0FBQyxDQUFDO1FBRUgsYUFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDL0UsYUFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxJQUFJLEVBQUUsWUFBTSxDQUFDLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWxFLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksRUFBRTtZQUNyQyxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sRUFBRSxNQUFN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SUFBSSxXQUFXLENBQUMsRUFBRSxJQUFJLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQztBQUM5RCxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDbkIsa0JBQWUsV0FBVyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gKiAgcGFnZXMvTmV3L3NlY3Rpb25zL3NldHRpbmdzXG5cbi8qKlxuICogaW1wb3J0IHNlY3Rpb25zIGZyb20gXCIuL3NlY3Rpb25zXCJcbiAqIHNlY3Rpb25zLnNldHRpbmdzKi9cblxuaW1wb3J0IHsgSW5wdXRTZWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2JoZS9leHRyYVwiO1xuaW1wb3J0IEdsb2IgZnJvbSBcIi4uLy4uLy4uL0dsb2JcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuXG5pbXBvcnQgTXlBbGVydCwgeyBDcmVhdGVDb25maXJtVGhpcmQgfSBmcm9tICcuLi8uLi8uLi9NeUFsZXJ0J1xuaW1wb3J0ICogYXMgdXRpbCBmcm9tIFwiLi4vLi4vLi4vdXRpbFwiO1xuaW1wb3J0IHsgRXhwZXJpbWVudFR5cGUsIGdldFRydXRoc1dpdGgzVHh0RmlsZXMsIFN1YmNvbmZpZyB9IGZyb20gXCIuLi8uLi8uLi9NeVN0b3JlXCI7XG5pbXBvcnQgeyBUcnV0aCB9IGZyb20gXCIuLi8uLi8uLi9UcnV0aFwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgYnV0dG9uLCBCdXR0b24sIERpdiwgZWxlbSB9IGZyb20gXCIuLi8uLi8uLi9iaGVcIjtcbi8vIFRPRE8gKENPTlRJTlVFKTpcbi8vICBiZXR0ZXJodG1sZWxlbWVudCBpbXBvcnRzIGRvbnQgd29yayBiZWNhdXNlIGkgZG9uJ3Qga25vdyBob3cgdG8gYnVuZGxlLlxuLy8gIGVpdGhlciBjbG9uZSBiaGUgYW5kIGNvbXBpbGUgb3IgdXNlIHdlYnBhY2s/XG5leHBvcnQgY2xhc3MgU2V0dGluZ3NEaXYgZXh0ZW5kcyBEaXYge1xuICAgIHByaXZhdGUgY29uZmlnU2VjdGlvbjogSW5wdXRTZWN0aW9uICYgeyBmbGV4OiB7IGVkaXQ6IEJ1dHRvbiB9IH07XG4gICAgcHJpdmF0ZSBzdWJqZWN0U2VjdGlvbjogSW5wdXRTZWN0aW9uO1xuICAgIHByaXZhdGUgdHJ1dGhTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG5cbiAgICBjb25zdHJ1Y3Rvcih7IGJ5aWQgfSkge1xuICAgICAgICBzdXBlcih7IGJ5aWQgfSk7XG4gICAgICAgIC8vICoqKiBGaWxlXG4gICAgICAgIC8vIGNvbnN0IGV4cGVyaW1lbnRUeXBlID0gR2xvYi5CaWdDb25maWcuZXhwZXJpbWVudF90eXBlO1xuICAgICAgICAvLyBjb25zdCBzdWJjb25maWdGaWxlOiBzdHJpbmcgPSBHbG9iLkJpZ0NvbmZpZ1tgJHtleHBlcmltZW50VHlwZX1fZmlsZWBdO1xuICAgICAgICAvLyBjb25zdCBzdWJjb25maWc6IFN1YmNvbmZpZyA9IEdsb2IuQmlnQ29uZmlnW2V4cGVyaW1lbnRUeXBlXTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnOiBTdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZy5nZXRTdWJjb25maWcoKTtcbiAgICAgICAgY29uc3QgY29uZmlnczogc3RyaW5nW10gPSBmcy5yZWFkZGlyU3luYyhDT05GSUdTX1BBVEhfQUJTKTtcbiAgICAgICAgY29uc3QgY29uZmlnU2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXI6IGBDdXJyZW50OiAke3N1YmNvbmZpZy5uYW1lfWAsXG4gICAgICAgICAgICBoM3RleHQ6IGBDb25maWcgRmlsZWAsXG4gICAgICAgICAgICBzdWdnZXN0aW9uczogY29uZmlncyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uZmlnU2VjdGlvbi5mbGV4LnN1Ym1pdC5jbGljaygoKSA9PiB0aGlzLm9uQ29uZmlnU3VibWl0KGNvbmZpZ3MsIHN1YmNvbmZpZykpO1xuICAgICAgICBjb25maWdTZWN0aW9uLmZsZXguY2FjaGVBcHBlbmQoeyBlZGl0OiBidXR0b24oeyBjbHM6ICdlZGl0JyB9KSB9KTtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjb25maWdTZWN0aW9uLmZsZXguZWRpdC5jbGljayhhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB7IHNwYXduU3luYyB9ID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuICAgICAgICAgICAgY29uc3QgeyBzdGF0dXMgfSA9IHNwYXduU3luYygnY29kZScsIFtHbG9iLkJpZ0NvbmZpZy5wYXRoXSk7XG4gICAgICAgICAgICBpZiAoc3RhdHVzID09PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgTXlBbGVydC5iaWcub25lQnV0dG9uKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IGBGYWlsZWQgcnVubmluZyBjb21tYW5kOlxcbmNvZGUgJHtHbG9iLkJpZ0NvbmZpZy5wYXRofWAsXG4gICAgICAgICAgICAgICAgICAgIGh0bWw6IGBNYWtlIHN1cmUgVmlzdWFsIFN0dWRpbyBDb2RlIGlzIGluc3RhbGxlZCwgYW5kIGF2YWlsYWJsZSB0aHJvdWdoIHRlcm1pbmFsIGJ5IHJ1bm5pbmc6XFxuPGNvZGU+Y29kZSAuPC9jb2RlPmBcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pO1xuICAgICAgICAvLyAqKiogU3ViamVjdFxuICAgICAgICBjb25zdCBzdWJqZWN0cyA9IEdsb2IuQmlnQ29uZmlnLnN1YmplY3RzO1xuXG4gICAgICAgIGNvbnN0IGN1cnJlbnRTdWJqZWN0ID0gc3ViY29uZmlnLnN1YmplY3Q7XG4gICAgICAgIGNvbnN0IHN1YmplY3RTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlcjogYEN1cnJlbnQ6ICR7Y3VycmVudFN1YmplY3R9YCxcbiAgICAgICAgICAgIGgzdGV4dDogJ1N1YmplY3QnLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IHN1YmplY3RzXG4gICAgICAgIH0pO1xuICAgICAgICBzdWJqZWN0U2VjdGlvbi5mbGV4LmNsaWNrKCgpID0+IHRoaXMub25TdWJqZWN0U3VibWl0KGN1cnJlbnRTdWJqZWN0LCBzdWJjb25maWcpKTtcblxuICAgICAgICAvLyAqKiogVHJ1dGhcbiAgICAgICAgY29uc3QgdHJ1dGhzV2l0aDNUeHRGaWxlcyA9IGdldFRydXRoc1dpdGgzVHh0RmlsZXMoKTtcbiAgICAgICAgY29uc3QgY3VycmVudFRydXRoID0gc3ViY29uZmlnLnRydXRoO1xuICAgICAgICBjb25zdCB0cnV0aFNlY3Rpb24gPSBuZXcgSW5wdXRTZWN0aW9uKHtcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyOiBgQ3VycmVudDogJHtjdXJyZW50VHJ1dGgubmFtZX1gLFxuICAgICAgICAgICAgaDN0ZXh0OiAnVHJ1dGgnLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IHRydXRoc1dpdGgzVHh0RmlsZXMsXG4gICAgICAgICAgICBpbGxlZ2FsUmVnZXg6IC9bXihhLXowLTlBLVp8XyldL1xuICAgICAgICB9KTtcblxuICAgICAgICB0cnV0aFNlY3Rpb24uZmxleC5zdWJtaXQuY2xpY2soKCkgPT4gdGhpcy5vblRydXRoU3VibWl0KGN1cnJlbnRUcnV0aCwgc3ViY29uZmlnLCB0cnV0aHNXaXRoM1R4dEZpbGVzKSk7XG5cbiAgICAgICAgY29uc3Qgc3VidGl0bGUgPSBlbGVtKHsgdGFnOiAnaDInLCBodG1sOiAnU2V0dGluZ3MnIH0pO1xuICAgICAgICB0aGlzLmNhY2hlQXBwZW5kKHsgc3VidGl0bGUsIGNvbmZpZ1NlY3Rpb24sIHN1YmplY3RTZWN0aW9uLCB0cnV0aFNlY3Rpb24gfSlcblxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgb25UcnV0aFN1Ym1pdChjdXJyZW50VHJ1dGg6IFRydXRoLCBzdWJjb25maWc6IFN1YmNvbmZpZywgdHJ1dGhzV2l0aDNUeHRGaWxlczogc3RyaW5nW10pIHtcbiAgICAgICAgY29uc3QgeyBzdWJtaXQ6IHRydXRoU3VibWl0LCBpbnB1dDogdHJ1dGhJbnB1dCB9ID0gdGhpcy50cnV0aFNlY3Rpb24uZmxleDtcbiAgICAgICAgbGV0IHZhbHVlID0gdHJ1dGhJbnB1dC52YWx1ZSgpO1xuICAgICAgICBsZXQgdmFsdWVMb3dlciA9IHZhbHVlLmxvd2VyKCk7XG4gICAgICAgIGlmICh2YWx1ZUxvd2VyLmVuZHNXaXRoQW55KCdfb24nLCAnX29mZicpKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYG9uVHJ1dGhTdWJtaXQgdmFsdWUgbm90IGEgYmFzZSB0eHQ6ICR7dmFsdWVMb3dlcn0uIEN1dHRpbmdgKTtcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudXBUbygnXycsIHRydWUpO1xuICAgICAgICAgICAgdmFsdWVMb3dlciA9IHZhbHVlLmxvd2VyKCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coJ29uVHJ1dGhTdWJtaXQnLCB7IHZhbHVlLCBjdXJyZW50VHJ1dGggfSk7XG5cbiAgICAgICAgLy8gLyBDaG9zZW4gaXMgYWxyZWFkeSBjdXJyZW50bHkgc2V0XG4gICAgICAgIGlmIChjdXJyZW50VHJ1dGgubmFtZS5sb3dlcigpID09PSB2YWx1ZUxvd2VyKSB7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLmluZm8oYCR7Y3VycmVudFRydXRoLm5hbWV9IHdhcyBhbHJlYWR5IHRoZSBjaG9zZW4gdHJ1dGhgKTtcbiAgICAgICAgICAgIHRydXRoU3VibWl0LnJlcGxhY2VDbGFzcygnZ3JlZW4nLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIHJldHVybiB0cnV0aElucHV0LmNsZWFyKCk7XG5cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIC8gRGlmZmVyZW50IGZyb20gY3VycmVudCwgY2hlY2sgaWYgZXhpc3RzIGluIFwid2hvbGVcIiB0cnV0aHNcbiAgICAgICAgZm9yIChsZXQgdHJ1dGhOYW1lIG9mIHRydXRoc1dpdGgzVHh0RmlsZXMpIHtcbiAgICAgICAgICAgIGxldCB0cnV0aE5hbWVMb3dlciA9IHRydXRoTmFtZS5sb3dlcigpO1xuICAgICAgICAgICAgaWYgKHRydXRoTmFtZUxvd2VyID09PSB2YWx1ZUxvd2VyKSB7XG4gICAgICAgICAgICAgICAgc3ViY29uZmlnLnRydXRoX2ZpbGUgPSB0cnV0aE5hbWU7XG4gICAgICAgICAgICAgICAgdHJ1dGhJbnB1dC5jbGVhcigpO1xuICAgICAgICAgICAgICAgIHRydXRoSW5wdXQucGxhY2Vob2xkZXIoYEN1cnJlbnQ6ICR7dHJ1dGhOYW1lfWApO1xuICAgICAgICAgICAgICAgIHRydXRoU3VibWl0LnJlcGxhY2VDbGFzcygnZ3JlZW4nLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFVzaW5nIHRydXRoOiBcIiR7dHJ1dGhOYW1lfVwiYCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KDMwMDApO1xuICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyAvIEVpdGhlciBleGlzdHMgaW4gXCJwYXJ0aWFsXCIgdHJ1dGhzIG9yIG5vdCBhdCBhbGxcbiAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwud2FybmluZyhgRWl0aGVyIHRoaXMgdHJ1dGggZG9lc24ndCBleGlzdCBjb21wbGV0ZWx5LCBvciBkb2Vzbid0IGhhdmUgaXRzIDMgYXNzb2NpYXRlZCAudHh0IGZpbGVzLiBQbGVhc2UgY2hvb3NlIGFuIGV4aXN0aW5nIG9uZS5gKVxuXG5cbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU3ViamVjdFN1Ym1pdChjdXJyZW50U3ViamVjdDogc3RyaW5nLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdDogc3ViamVjdFN1Ym1pdCwgaW5wdXQ6IHN1YmplY3RJbnB1dCB9ID0gdGhpcy5zdWJqZWN0U2VjdGlvbi5mbGV4O1xuICAgICAgICBjb25zdCB2YWx1ZSA9IHN1YmplY3RJbnB1dC52YWx1ZSgpO1xuXG4gICAgICAgIGlmIChjdXJyZW50U3ViamVjdCA9PT0gdmFsdWUpIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50U3ViamVjdH0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBzdWJqZWN0YClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1YmNvbmZpZy5zdWJqZWN0ID0gdmFsdWU7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFN1YmplY3Qgc2V0OiAke3ZhbHVlfS5gKTtcbiAgICAgICAgICAgIHN1YmplY3RJbnB1dC5wbGFjZWhvbGRlcihgQ3VycmVudDogJHt2YWx1ZX1gKTtcblxuICAgICAgICB9XG4gICAgICAgIHN1YmplY3RTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICBzdWJqZWN0SW5wdXQuY2xlYXIoKTtcblxuXG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBvbkNvbmZpZ1N1Ym1pdChjb25maWdzOiBzdHJpbmdbXSwgc3ViY29uZmlnOiBTdWJjb25maWcpIHtcbiAgICAgICAgY29uc3QgeyBzdWJtaXQ6IGNvbmZpZ1N1Ym1pdCwgaW5wdXQ6IGNvbmZpZ0lucHV0IH0gPSB0aGlzLmNvbmZpZ1NlY3Rpb24uZmxleDtcbiAgICAgICAgbGV0IGZpbGUgPSBjb25maWdJbnB1dC52YWx1ZSgpO1xuICAgICAgICAvLyBjb25zdCBbIGZpbGVuYW1lLCBleHQgXSA9IG15ZnMuc3BsaXRfZXh0KGZpbGUpO1xuICAgICAgICBjb25zb2xlLmxvZygnb25Db25maWdTdWJtaXQsJywgZmlsZSk7XG4gICAgICAgIC8vLy8gQ2hlY2sgZm9yIGJhZCBleHRlbnNpb24gb3IgYmFkIGZpbGVuYW1lXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBTdWJjb25maWcudmFsaWRhdGVOYW1lKGZpbGUpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAoZS5tZXNzYWdlID09PSAnRXh0ZW5zaW9uRXJyb3InKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKCdGaWxlIG5hbWUgbXVzdCBlbmQgd2l0aCBlaXRoZXIgLmV4YW0gb3IgLnRlc3QnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChlLm1lc3NhZ2UgPT09ICdCYXNlbmFtZUVycm9yJykge1xuICAgICAgICAgICAgICAgIGNvbmZpZ0lucHV0LmFkZENsYXNzKCdpbnZhbGlkJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwud2FybmluZyhgSW5zZXJ0IGp1c3QgYSBmaWxlIG5hbWUsIG5vdCBhIHBhdGggd2l0aCBzbGFzaGVzLiBlZzogXCIke3BhdGguYmFzZW5hbWUoZmlsZSl9XCJgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vLy8gRXh0ZW5zaW9uIGFuZCBmaWxlIG5hbWUgb2s7IGNoZWNrIGlmIHVzZXIgY2hvc2Ugd2hhdCdzIGN1cnJlbnRseSBzZXRcbiAgICAgICAgY29uZmlnSW5wdXQucmVtb3ZlQ2xhc3MoJ2ludmFsaWQnKTtcblxuICAgICAgICBjb25zdCBmaWxlTG93ZXIgPSBmaWxlLmxvd2VyKCk7XG4gICAgICAgIGlmIChzdWJjb25maWcubmFtZS5sb3dlcigpID09PSBmaWxlTG93ZXIpIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtzdWJjb25maWcubmFtZX0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBmaWxlYCk7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ0lucHV0LmNsZWFyKCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLy8vIENob3NlbiBzb21ldGhpbmcgZWxzZTsgY2hlY2sgaWYgZXhpc3RzXG4gICAgICAgIGxldCBhY3Rpb246IENyZWF0ZUNvbmZpcm1UaGlyZCB8IFwiY3JlYXRlXCIgPSBcImNyZWF0ZVwiOyAvLyBjcmVhdGUgKGRvZXNudCBleGlzdCksIGNvbmZpcm0gKHVzZSBleGlzdGluZyksIG92ZXJ3cml0ZSAob24gdG9wIG9mIGV4aXN0aW5nKSwgY2FuY2VsXG5cbiAgICAgICAgZm9yIChsZXQgY2ZnIG9mIGNvbmZpZ3MpIHtcbiAgICAgICAgICAgIGlmIChjZmcubG93ZXIoKSA9PT0gZmlsZUxvd2VyKSB7XG4gICAgICAgICAgICAgICAgYWN0aW9uID0gYXdhaXQgTXlBbGVydC5iaWcudGhyZWVCdXR0b25zKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IGAke2NmZ30gYWxyZWFkeSBleGlzdHMsIHdoYXQgZG8geW91IHdhbnQgdG8gZG8/YCxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6ICdVc2UgaXQnLFxuICAgICAgICAgICAgICAgICAgICB0aGlyZEJ1dHRvblRleHQ6ICdPdmVyd3JpdGUgaXQnLFxuICAgICAgICAgICAgICAgICAgICB0aGlyZEJ1dHRvblR5cGU6IFwid2FybmluZ1wiXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gYXdhaXQgTXlBbGVydC5iaWcuYmxvY2tpbmcoe1xuICAgICAgICAgICAgICAgICB0aXRsZSA6IGAke2NmZ30gYWxyZWFkeSBleGlzdHMsIHdoYXQgZG8geW91IHdhbnQgdG8gZG8/YCxcbiAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQgOiAnVXNlIGl0JyxcbiAgICAgICAgICAgICAgICAgb25CZWZvcmVPcGVuIDogKG1vZGFsOiBIVE1MRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICBsZXQgZWwgPSBlbGVtKHsgaHRtbEVsZW1lbnQgOiBtb2RhbCwgY2hpbGRyZW4gOiB7IGFjdGlvbnMgOiAnLnN3YWwyLWFjdGlvbnMnIH0gfSk7XG4gICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgZWwuYWN0aW9ucy5hcHBlbmQoXG4gICAgICAgICAgICAgICAgIGJ1dHRvbih7IGNscyA6IFwic3dhbDItY29uZmlybSBzd2FsMi1zdHlsZWQgd2FyblwiLCBodG1sIDogJ092ZXJ3cml0ZSBpdCcgfSlcbiAgICAgICAgICAgICAgICAgLmF0dHIoeyB0eXBlIDogJ2J1dHRvbicgfSlcbiAgICAgICAgICAgICAgICAgLmNzcyh7IGJhY2tncm91bmRDb2xvciA6ICcjRkZDNjZEJywgY29sb3IgOiAnYmxhY2snIH0pXG4gICAgICAgICAgICAgICAgIC5jbGljaygoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgLy8gXCJPdmVyd3JpdGUgaXRcIlxuICAgICAgICAgICAgICAgICBhY3Rpb24gPSBcIm92ZXJ3cml0ZVwiO1xuICAgICAgICAgICAgICAgICBvdmVyd3JpdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgIE15QWxlcnQuY2xpY2tDYW5jZWwoKTtcbiAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gXCJjYW5jZWxcIikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vLy8gXCJPdmVyd3JpdGVcIiBvciBcIlVzZSBpdFwiXG4gICAgICAgICAgICAgICAgZmlsZSA9IGNmZzsgLy8gbWF0Y2ggY2FzZVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLy8vIEVpdGhlciBleGlzdHMgdGhlbiBsb2FkIG9yIG92ZXJ3cml0ZSBpdCwgb3IgY29tcGxldGVseSBuZXdcbiAgICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGUpO1xuICAgICAgICBjb25zdCBleHBlcmltZW50VHlwZSA9IGV4dC5zbGljZSgxKSBhcyBFeHBlcmltZW50VHlwZTtcbiAgICAgICAgR2xvYi5CaWdDb25maWcuZXhwZXJpbWVudF90eXBlID0gZXhwZXJpbWVudFR5cGU7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgYWN0aW9uLCBmaWxlIH0pO1xuICAgICAgICBpZiAoYWN0aW9uID09PSBcImNvbmZpcm1cIikgeyAvLyBFeGlzdHMsIFwiVXNlIGl0XCJcbiAgICAgICAgICAgIEdsb2IuQmlnQ29uZmlnLnNldFN1YmNvbmZpZyhmaWxlKTtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnIGxvYWRlZDogJHtmaWxlfS5gKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnBsYWNlaG9sZGVyKGBDdXJyZW50OiAke2ZpbGV9YCk7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdncmVlbicsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQuY2xlYXIoKTtcbiAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChhY3Rpb24gPT09IFwiY3JlYXRlXCIgfHwgYWN0aW9uID09PSBcInRoaXJkXCIpIHtcbiAgICAgICAgICAgIEdsb2IuQmlnQ29uZmlnLnNldFN1YmNvbmZpZyhmaWxlLCBzdWJjb25maWcpO1xuICAgICAgICAgICAgbGV0IHZlcmIgPSBhY3Rpb24gPT09IFwidGhpcmRcIiA/ICdvdmVyd3JpdHRlbicgOiAnY3JlYXRlZCc7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYENvbmZpZyAke3ZlcmJ9OiAke2ZpbGV9LmApO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQucGxhY2Vob2xkZXIoYEN1cnJlbnQ6ICR7ZmlsZX1gKTtcbiAgICAgICAgICAgIGNvbmZpZ1N1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2dyZWVuJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICBjb25maWdJbnB1dC5jbGVhcigpO1xuICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KDMwMDApO1xuICAgICAgICAgICAgdXRpbC5yZWxvYWRQYWdlKCk7XG4gICAgICAgIH1cblxuXG4gICAgfVxuXG59XG5cbmNvbnNvbGUuZ3JvdXAoJ3BhZ2VzLk5ldy5zZWN0aW9ucy5zZXR0aW5ncy50cycpO1xuY29uc3Qgc2V0dGluZ3NEaXYgPSBuZXcgU2V0dGluZ3NEaXYoeyBieWlkOiAnc2V0dGluZ3NfZGl2JyB9KTtcbmNvbnNvbGUuZ3JvdXBFbmQoKTtcbmV4cG9ydCBkZWZhdWx0IHNldHRpbmdzRGl2O1xuXG4iXX0=