"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
const path = require("path");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const configSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        configSection.inputAndSubmitFlex.submitButton.click(() => this.onConfigSubmit(configs, subconfig));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submitButton: subjectSubmit } = subjectSection.inputAndSubmitFlex;
        subjectSubmit.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        console.log({ truthsWith3TxtFiles });
        const currentTruth = subconfig.truth;
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${currentTruth.name}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles,
            illegalRegex: /[^(a-z0-9A-Z|_)]/
        });
        truthSection.inputAndSubmitFlex.submitButton.click(() => this.onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles));
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, configSection, subjectSection, truthSection });
    }
    async onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles) {
        const { submitButton: truthSubmit, inputElem: truthInput } = this.truthSection.inputAndSubmitFlex;
        let value = truthInput.value;
        let valueLower = value.lower();
        if (valueLower.endsWithAny('_on', '_off')) {
            console.warn(`onTruthSubmit value not a base txt: ${valueLower}. Cutting`);
            value = value.upTo('_', true);
            valueLower = value.lower();
        }
        console.log('onTruthSubmit', { value, currentTruth });
        if (currentTruth.name.lower() === valueLower) {
            MyAlert_1.default.small.info(`${currentTruth.name} was already the chosen truth`);
            truthSubmit.replaceClass('active', 'inactive');
            return truthInput.value = '';
        }
        for (let truthName of truthsWith3TxtFiles) {
            let truthNameLower = truthName.lower();
            if (truthNameLower === valueLower) {
                subconfig.truth_file = truthName;
                truthInput.value = '';
                truthInput.placeholder = `Current: ${truthName}`;
                truthSubmit.replaceClass('active', 'inactive');
                MyAlert_1.default.small.success(`Using truth: "${truthName}"`);
                await util.wait(3000);
                return util.reloadPage();
            }
        }
        return MyAlert_1.default.small.warning(`Either this truth doesn't exist completely, or doesn't have its 3 associated .txt files. Please choose an existing one.`);
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submitButton: subjectSubmit, inputElem: subjectInput } = this.subjectSection.inputAndSubmitFlex;
        const value = subjectInput.value;
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder = `Current: ${value}`;
        }
        subjectSubmit.replaceClass('active', 'inactive');
        subjectInput.value = '';
    }
    async onConfigSubmit(configs, subconfig) {
        const { submitButton: configSubmit, inputElem: configInput } = this.configSection.inputAndSubmitFlex;
        let file = configInput.value;
        console.log('onConfigSubmit,', file);
        try {
            MyStore_1.Subconfig.validateName(file);
        }
        catch (e) {
            if (e.message === 'ExtensionError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            }
            if (e.message === 'BasenameError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning(`Insert just a file name, not a path with slashes. eg: "${path.basename(file)}"`);
            }
        }
        configInput.removeClass('invalid');
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
            configSubmit.replaceClass('active', 'inactive');
            return configInput.value = '';
        }
        let action = "create";
        for (let cfg of configs) {
            if (cfg.lower() === fileLower) {
                action = await MyAlert_1.default.big.threeButtons({
                    title: `${cfg} already exists, what do you want to do?`,
                    confirmButtonText: 'Use it',
                    thirdButtonText: 'Overwrite it',
                    thirdButtonType: "warning"
                });
                if (action === "cancel") {
                    return;
                }
                file = cfg;
                break;
            }
        }
        const ext = path.extname(file);
        const experimentType = ext.slice(1);
        Glob_1.default.BigConfig.experiment_type = experimentType;
        console.log({ action, file });
        if (action === "confirm") {
            Glob_1.default.BigConfig.setSubconfig(file);
            MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('active', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
        if (action === "create" || action === "third") {
            Glob_1.default.BigConfig.setSubconfig(file, subconfig);
            let verb = action === "third" ? 'overwritten' : 'created';
            MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('active', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
    }
}
console.group('pages.New.sections.settings.py');
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
console.groupEnd();
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBK0Q7QUFFL0Qsc0NBQXNDO0FBQ3RDLDhDQUFxRjtBQUVyRiw2QkFBNkI7QUFFN0IsTUFBTSxXQUFZLFNBQVEsU0FBRztJQUt6QixZQUFZLEVBQUUsRUFBRSxFQUFFO1FBQ2QsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUtkLE1BQU0sU0FBUyxHQUFjLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDM0QsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNELE1BQU0sYUFBYSxHQUFHLElBQUksb0JBQVksQ0FBQztZQUNuQyxXQUFXLEVBQUcsWUFBWSxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQzFDLE1BQU0sRUFBRyxhQUFhO1lBQ3RCLFdBQVcsRUFBRyxPQUFPO1NBRXhCLENBQUMsQ0FBQztRQUVILGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFHbkcsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFFekMsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztRQUN6QyxNQUFNLGNBQWMsR0FBRyxJQUFJLG9CQUFZLENBQUM7WUFDcEMsV0FBVyxFQUFHLFlBQVksY0FBYyxFQUFFO1lBQzFDLE1BQU0sRUFBRyxTQUFTO1lBQ2xCLFdBQVcsRUFBRyxRQUFRO1NBQ3pCLENBQUMsQ0FBQztRQUNILE1BQU0sRUFBRSxZQUFZLEVBQUcs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QVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzdDLElBQUksSUFBSSxHQUFHLE1BQU0sS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQzFELGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksS0FBSyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ2xELFdBQVcsQ0FBQyxXQUFXLEdBQUcsWUFBWSxJQUFJLEVBQUUsQ0FBQztZQUM3QyxZQUFZLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNoRCxXQUFXLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUN2QixNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ3JCO0lBR0wsQ0FBQztDQUVKO0FBRUQsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ2hELE1BQU0sV0FBVyxHQUFHLElBQUksV0FBVyxDQUFDLEVBQUUsRUFBRSxFQUFHLGNBQWMsRUFBRSxDQUFDLENBQUM7QUFDN0QsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ25CLGtCQUFlLFdBQVcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vICogIHBhZ2VzL05ldy9zZWN0aW9ucy9zZXR0aW5nc1xuXG4vKipcbiAqIGltcG9ydCBzZWN0aW9ucyBmcm9tIFwiLi9zZWN0aW9uc1wiXG4gKiBzZWN0aW9ucy5zZXR0aW5ncyovXG5pbXBvcnQgeyBlbGVtLCBEaXYsIGJ1dHRvbiwgSW5wdXQsIEJ1dHRvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGVcIjtcblxuaW1wb3J0IHsgSW5wdXRTZWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2JoZS9leHRyYVwiO1xuaW1wb3J0IEdsb2IgZnJvbSBcIi4uLy4uLy4uL0dsb2JcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuXG5pbXBvcnQgTXlBbGVydCwgeyBDcmVhdGVDb25maXJtQ2FuY2VsIH0gZnJvbSAnLi4vLi4vLi4vTXlBbGVydCdcbmltcG9ydCBteWZzIGZyb20gXCIuLi8uLi8uLi9NeUZzXCI7XG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gXCIuLi8uLi8uLi91dGlsXCI7XG5pbXBvcnQgeyBFeHBlcmltZW50VHlwZSwgZ2V0VHJ1dGhzV2l0aDNUeHRGaWxlcywgU3ViY29uZmlnIH0gZnJvbSBcIi4uLy4uLy4uL015U3RvcmVcIjtcbmltcG9ydCB7IFRydXRoIH0gZnJvbSBcIi4uLy4uLy4uL1RydXRoXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5cbmNsYXNzIFNldHRpbmdzRGl2IGV4dGVuZHMgRGl2IHtcbiAgICBwcml2YXRlIGNvbmZpZ1NlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBwcml2YXRlIHN1YmplY3RTZWN0aW9uOiBJbnB1dFNlY3Rpb247XG4gICAgcHJpdmF0ZSB0cnV0aFNlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBcbiAgICBjb25zdHJ1Y3Rvcih7IGlkIH0pIHtcbiAgICAgICAgc3VwZXIoeyBpZCB9KTtcbiAgICAgICAgLy8gKioqICBGaWxlXG4gICAgICAgIC8vIGNvbnN0IGV4cGVyaW1lbnRUeXBlID0gR2xvYi5CaWdDb25maWcuZXhwZXJpbWVudF90eXBlO1xuICAgICAgICAvLyBjb25zdCBzdWJjb25maWdGaWxlOiBzdHJpbmcgPSBHbG9iLkJpZ0NvbmZpZ1tgJHtleHBlcmltZW50VHlwZX1fZmlsZWBdO1xuICAgICAgICAvLyBjb25zdCBzdWJjb25maWc6IFN1YmNvbmZpZyA9IEdsb2IuQmlnQ29uZmlnW2V4cGVyaW1lbnRUeXBlXTtcbiAgICAgICAgY29uc3Qgc3ViY29uZmlnOiBTdWJjb25maWcgPSBHbG9iLkJpZ0NvbmZpZy5nZXRTdWJjb25maWcoKTtcbiAgICAgICAgY29uc3QgY29uZmlnczogc3RyaW5nW10gPSBmcy5yZWFkZGlyU3luYyhDT05GSUdTX1BBVEhfQUJTKTtcbiAgICAgICAgY29uc3QgY29uZmlnU2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXIgOiBgQ3VycmVudDogJHtzdWJjb25maWcubmFtZX1gLFxuICAgICAgICAgICAgaDN0ZXh0IDogYENvbmZpZyBGaWxlYCxcbiAgICAgICAgICAgIHN1Z2dlc3Rpb25zIDogY29uZmlncyxcbiAgICAgICAgICAgIFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGNvbmZpZ1NlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4LnN1Ym1pdEJ1dHRvbi5jbGljaygoKSA9PiB0aGlzLm9uQ29uZmlnU3VibWl0KGNvbmZpZ3MsIHN1YmNvbmZpZykpO1xuICAgICAgICBcbiAgICAgICAgLy8gKioqICBTdWJqZWN0XG4gICAgICAgIGNvbnN0IHN1YmplY3RzID0gR2xvYi5CaWdDb25maWcuc3ViamVjdHM7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBjdXJyZW50U3ViamVjdCA9IHN1YmNvbmZpZy5zdWJqZWN0O1xuICAgICAgICBjb25zdCBzdWJqZWN0U2VjdGlvbiA9IG5ldyBJbnB1dFNlY3Rpb24oe1xuICAgICAgICAgICAgcGxhY2Vob2xkZXIgOiBgQ3VycmVudDogJHtjdXJyZW50U3ViamVjdH1gLFxuICAgICAgICAgICAgaDN0ZXh0IDogJ1N1YmplY3QnLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnMgOiBzdWJqZWN0c1xuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiBzdWJqZWN0U3VibWl0IH0gPSBzdWJqZWN0U2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIHN1YmplY3RTdWJtaXQuY2xpY2soKCkgPT4gdGhpcy5vblN1YmplY3RTdWJtaXQoY3VycmVudFN1YmplY3QsIHN1YmNvbmZpZykpO1xuICAgICAgICBcbiAgICAgICAgLy8gKioqICBUcnV0aFxuICAgICAgICBjb25zdCB0cnV0aHNXaXRoM1R4dEZpbGVzID0gZ2V0VHJ1dGhzV2l0aDNUeHRGaWxlcygpO1xuICAgICAgICBjb25zb2xlLmxvZyh7IHRydXRoc1dpdGgzVHh0RmlsZXMgfSk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRUcnV0aCA9IHN1YmNvbmZpZy50cnV0aDtcbiAgICAgICAgY29uc3QgdHJ1dGhTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlciA6IGBDdXJyZW50OiAke2N1cnJlbnRUcnV0aC5uYW1lfWAsXG4gICAgICAgICAgICBoM3RleHQgOiAnVHJ1dGgnLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnMgOiB0cnV0aHNXaXRoM1R4dEZpbGVzLFxuICAgICAgICAgICAgaWxsZWdhbFJlZ2V4IDogL1teKGEtejAtOUEtWnxfKV0vXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgdHJ1dGhTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleC5zdWJtaXRCdXR0b24uY2xpY2soKCkgPT4gdGhpcy5vblRydXRoU3VibWl0KGN1cnJlbnRUcnV0aCwgc3ViY29uZmlnLCB0cnV0aHNXaXRoM1R4dEZpbGVzKSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzdWJ0aXRsZSA9IGVsZW0oeyB0YWcgOiAnaDInLCB0ZXh0IDogJ1NldHRpbmdzJyB9KTtcbiAgICAgICAgdGhpcy5jYWNoZUFwcGVuZCh7IHN1YnRpdGxlLCBjb25maWdTZWN0aW9uLCBzdWJqZWN0U2VjdGlvbiwgdHJ1dGhTZWN0aW9uIH0pXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGFzeW5jIG9uVHJ1dGhTdWJtaXQoY3VycmVudFRydXRoOiBUcnV0aCwgc3ViY29uZmlnOiBTdWJjb25maWcsIHRydXRoc1dpdGgzVHh0RmlsZXM6IHN0cmluZ1tdKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uIDogdHJ1dGhTdWJtaXQsIGlucHV0RWxlbSA6IHRydXRoSW5wdXQgfSA9IHRoaXMudHJ1dGhTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgbGV0IHZhbHVlID0gdHJ1dGhJbnB1dC52YWx1ZTtcbiAgICAgICAgbGV0IHZhbHVlTG93ZXIgPSB2YWx1ZS5sb3dlcigpO1xuICAgICAgICBpZiAoIHZhbHVlTG93ZXIuZW5kc1dpdGhBbnkoJ19vbicsICdfb2ZmJykgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYG9uVHJ1dGhTdWJtaXQgdmFsdWUgbm90IGEgYmFzZSB0eHQ6ICR7dmFsdWVMb3dlcn0uIEN1dHRpbmdgKTtcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudXBUbygnXycsIHRydWUpO1xuICAgICAgICAgICAgdmFsdWVMb3dlciA9IHZhbHVlLmxvd2VyKCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coJ29uVHJ1dGhTdWJtaXQnLCB7IHZhbHVlLCBjdXJyZW50VHJ1dGggfSk7XG4gICAgICAgIFxuICAgICAgICAvLyAvIENob3NlbiBpcyBhbHJlYWR5IGN1cnJlbnRseSBzZXRcbiAgICAgICAgaWYgKCBjdXJyZW50VHJ1dGgubmFtZS5sb3dlcigpID09PSB2YWx1ZUxvd2VyICkge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke2N1cnJlbnRUcnV0aC5uYW1lfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIHRydXRoYCk7XG4gICAgICAgICAgICB0cnV0aFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgcmV0dXJuIHRydXRoSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyAvIERpZmZlcmVudCBmcm9tIGN1cnJlbnQsIGNoZWNrIGlmIGV4aXN0cyBpbiBcIndob2xlXCIgdHJ1dGhzXG4gICAgICAgIGZvciAoIGxldCB0cnV0aE5hbWUgb2YgdHJ1dGhzV2l0aDNUeHRGaWxlcyApIHtcbiAgICAgICAgICAgIGxldCB0cnV0aE5hbWVMb3dlciA9IHRydXRoTmFtZS5sb3dlcigpO1xuICAgICAgICAgICAgaWYgKCB0cnV0aE5hbWVMb3dlciA9PT0gdmFsdWVMb3dlciApIHtcbiAgICAgICAgICAgICAgICBzdWJjb25maWcudHJ1dGhfZmlsZSA9IHRydXRoTmFtZTtcbiAgICAgICAgICAgICAgICB0cnV0aElucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICAgICAgdHJ1dGhJbnB1dC5wbGFjZWhvbGRlciA9IGBDdXJyZW50OiAke3RydXRoTmFtZX1gO1xuICAgICAgICAgICAgICAgIHRydXRoU3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBVc2luZyB0cnV0aDogXCIke3RydXRoTmFtZX1cImApO1xuICAgICAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdXRpbC5yZWxvYWRQYWdlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gLyBFaXRoZXIgZXhpc3RzIGluIFwicGFydGlhbFwiIHRydXRocyBvciBub3QgYXQgYWxsXG4gICAgICAgIHJldHVybiBNeUFsZXJ0LnNtYWxsLndhcm5pbmcoYEVpdGhlciB0aGlzIHRydXRoIGRvZXNuJ3QgZXhpc3QgY29tcGxldGVseSwgb3IgZG9lc24ndCBoYXZlIGl0cyAzIGFzc29jaWF0ZWQgLnR4dCBmaWxlcy4gUGxlYXNlIGNob29zZSBhbiBleGlzdGluZyBvbmUuYClcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIG9uU3ViamVjdFN1Ym1pdChjdXJyZW50U3ViamVjdDogc3RyaW5nLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdEJ1dHRvbiA6IHN1YmplY3RTdWJtaXQsIGlucHV0RWxlbSA6IHN1YmplY3RJbnB1dCB9ID0gdGhpcy5zdWJqZWN0U2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gc3ViamVjdElucHV0LnZhbHVlO1xuICAgICAgICBcbiAgICAgICAgaWYgKCBjdXJyZW50U3ViamVjdCA9PT0gdmFsdWUgKSB7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLmluZm8oYCR7Y3VycmVudFN1YmplY3R9IHdhcyBhbHJlYWR5IHRoZSBjaG9zZW4gc3ViamVjdGApXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdWJjb25maWcuc3ViamVjdCA9IHZhbHVlO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBTdWJqZWN0IHNldDogJHt2YWx1ZX0uYCk7XG4gICAgICAgICAgICBzdWJqZWN0SW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHt2YWx1ZX1gO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgc3ViamVjdFN1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICBzdWJqZWN0SW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGFzeW5jIG9uQ29uZmlnU3VibWl0KGNvbmZpZ3M6IHN0cmluZ1tdLCBzdWJjb25maWc6IFN1YmNvbmZpZykge1xuICAgICAgICBjb25zdCB7IHN1Ym1pdEJ1dHRvbiA6IGNvbmZpZ1N1Ym1pdCwgaW5wdXRFbGVtIDogY29uZmlnSW5wdXQgfSA9IHRoaXMuY29uZmlnU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXg7XG4gICAgICAgIGxldCBmaWxlID0gY29uZmlnSW5wdXQudmFsdWU7XG4gICAgICAgIC8vIGNvbnN0IFsgZmlsZW5hbWUsIGV4dCBdID0gbXlmcy5zcGxpdF9leHQoZmlsZSk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdvbkNvbmZpZ1N1Ym1pdCwnLCBmaWxlKTtcbiAgICAgICAgLy8vLyBDaGVjayBmb3IgYmFkIGV4dGVuc2lvbiBvciBiYWQgZmlsZW5hbWVcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIFN1YmNvbmZpZy52YWxpZGF0ZU5hbWUoZmlsZSk7XG4gICAgICAgIH0gY2F0Y2ggKCBlICkge1xuICAgICAgICAgICAgaWYgKCBlLm1lc3NhZ2UgPT09ICdFeHRlbnNpb25FcnJvcicgKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKCdGaWxlIG5hbWUgbXVzdCBlbmQgd2l0aCBlaXRoZXIgLmV4YW0gb3IgLnRlc3QnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICggZS5tZXNzYWdlID09PSAnQmFzZW5hbWVFcnJvcicgKSB7XG4gICAgICAgICAgICAgICAgY29uZmlnSW5wdXQuYWRkQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gTXlBbGVydC5zbWFsbC53YXJuaW5nKGBJbnNlcnQganVzdCBhIGZpbGUgbmFtZSwgbm90IGEgcGF0aCB3aXRoIHNsYXNoZXMuIGVnOiBcIiR7cGF0aC5iYXNlbmFtZShmaWxlKX1cImApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLy8vIEV4dGVuc2lvbiBhbmQgZmlsZSBuYW1lIG9rOyBjaGVjayBpZiB1c2VyIGNob3NlIHdoYXQncyBjdXJyZW50bHkgc2V0XG4gICAgICAgIGNvbmZpZ0lucHV0LnJlbW92ZUNsYXNzKCdpbnZhbGlkJyk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBmaWxlTG93ZXIgPSBmaWxlLmxvd2VyKCk7XG4gICAgICAgIGlmICggc3ViY29uZmlnLm5hbWUubG93ZXIoKSA9PT0gZmlsZUxvd2VyICkge1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5pbmZvKGAke3N1YmNvbmZpZy5uYW1lfSB3YXMgYWxyZWFkeSB0aGUgY2hvc2VuIGZpbGVgKTtcbiAgICAgICAgICAgIGNvbmZpZ1N1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZ0lucHV0LnZhbHVlID0gJyc7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vLy8gQ2hvc2VuIHNvbWV0aGluZyBlbHNlOyBjaGVjayBpZiBleGlzdHNcbiAgICAgICAgbGV0IGFjdGlvbjogQ3JlYXRlQ29uZmlybUNhbmNlbCB8IFwiY3JlYXRlXCIgPSBcImNyZWF0ZVwiOyAvLyBjcmVhdGUgKGRvZXNudCBleGlzdCksIGNvbmZpcm0gKHVzZSBleGlzdGluZyksIG92ZXJ3cml0ZSAob24gdG9wIG9mIGV4aXN0aW5nKSwgY2FuY2VsXG4gICAgICAgIFxuICAgICAgICBmb3IgKCBsZXQgY2ZnIG9mIGNvbmZpZ3MgKSB7XG4gICAgICAgICAgICBpZiAoIGNmZy5sb3dlcigpID09PSBmaWxlTG93ZXIgKSB7XG4gICAgICAgICAgICAgICAgYWN0aW9uID0gYXdhaXQgTXlBbGVydC5iaWcudGhyZWVCdXR0b25zKHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGUgOiBgJHtjZmd9IGFscmVhZHkgZXhpc3RzLCB3aGF0IGRvIHlvdSB3YW50IHRvIGRvP2AsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpcm1CdXR0b25UZXh0IDogJ1VzZSBpdCcsXG4gICAgICAgICAgICAgICAgICAgIHRoaXJkQnV0dG9uVGV4dCA6ICdPdmVyd3JpdGUgaXQnLFxuICAgICAgICAgICAgICAgICAgICB0aGlyZEJ1dHRvblR5cGUgOiBcIndhcm5pbmdcIlxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIC8qXG4gICAgICAgICAgICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IGF3YWl0IE15QWxlcnQuYmlnLmJsb2NraW5nKHtcbiAgICAgICAgICAgICAgICAgdGl0bGUgOiBgJHtjZmd9IGFscmVhZHkgZXhpc3RzLCB3aGF0IGRvIHlvdSB3YW50IHRvIGRvP2AsXG4gICAgICAgICAgICAgICAgIGNvbmZpcm1CdXR0b25UZXh0IDogJ1VzZSBpdCcsXG4gICAgICAgICAgICAgICAgIG9uQmVmb3JlT3BlbiA6IChtb2RhbDogSFRNTEVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgbGV0IGVsID0gZWxlbSh7IGh0bWxFbGVtZW50IDogbW9kYWwsIGNoaWxkcmVuIDogeyBhY3Rpb25zIDogJy5zd2FsMi1hY3Rpb25zJyB9IH0pO1xuICAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgIGVsLmFjdGlvbnMuYXBwZW5kKFxuICAgICAgICAgICAgICAgICBidXR0b24oeyBjbHMgOiBcInN3YWwyLWNvbmZpcm0gc3dhbDItc3R5bGVkIHdhcm5cIiwgaHRtbCA6ICdPdmVyd3JpdGUgaXQnIH0pXG4gICAgICAgICAgICAgICAgIC5hdHRyKHsgdHlwZSA6ICdidXR0b24nIH0pXG4gICAgICAgICAgICAgICAgIC5jc3MoeyBiYWNrZ3JvdW5kQ29sb3IgOiAnI0ZGQzY2RCcsIGNvbG9yIDogJ2JsYWNrJyB9KVxuICAgICAgICAgICAgICAgICAuY2xpY2soKGV2OiBNb3VzZUV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgIC8vIFwiT3ZlcndyaXRlIGl0XCJcbiAgICAgICAgICAgICAgICAgYWN0aW9uID0gXCJvdmVyd3JpdGVcIjtcbiAgICAgICAgICAgICAgICAgb3ZlcndyaXRlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgZmlsZSA9IGNmZzsgLy8gbWF0Y2ggY2FzZVxuICAgICAgICAgICAgICAgICBNeUFsZXJ0LmNsaWNrQ2FuY2VsKCk7XG4gICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIGFjdGlvbiA9PT0gXCJjYW5jZWxcIiApIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLy8vIFwiT3ZlcndyaXRlXCIgb3IgXCJVc2UgaXRcIlxuICAgICAgICAgICAgICAgIGZpbGUgPSBjZmc7IC8vIG1hdGNoIGNhc2VcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLy8vIEVpdGhlciBleGlzdHMgdGhlbiBsb2FkIG9yIG92ZXJ3cml0ZSBpdCwgb3IgY29tcGxldGVseSBuZXdcbiAgICAgICAgY29uc3QgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGUpO1xuICAgICAgICBjb25zdCBleHBlcmltZW50VHlwZSA9IGV4dC5zbGljZSgxKSBhcyBFeHBlcmltZW50VHlwZTtcbiAgICAgICAgR2xvYi5CaWdDb25maWcuZXhwZXJpbWVudF90eXBlID0gZXhwZXJpbWVudFR5cGU7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgYWN0aW9uLCBmaWxlIH0pO1xuICAgICAgICBpZiAoIGFjdGlvbiA9PT0gXCJjb25maXJtXCIgKSB7IC8vIEV4aXN0cywgXCJVc2UgaXRcIlxuICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUpO1xuICAgICAgICAgICAgTXlBbGVydC5zbWFsbC5zdWNjZXNzKGBDb25maWcgbG9hZGVkOiAke2ZpbGV9LmApO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHtmaWxlfWA7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIGFjdGlvbiA9PT0gXCJjcmVhdGVcIiB8fCBhY3Rpb24gPT09IFwidGhpcmRcIiApIHtcbiAgICAgICAgICAgIEdsb2IuQmlnQ29uZmlnLnNldFN1YmNvbmZpZyhmaWxlLCBzdWJjb25maWcpO1xuICAgICAgICAgICAgbGV0IHZlcmIgPSBhY3Rpb24gPT09IFwidGhpcmRcIiA/ICdvdmVyd3JpdHRlbicgOiAnY3JlYXRlZCc7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYENvbmZpZyAke3ZlcmJ9OiAke2ZpbGV9LmApO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQucGxhY2Vob2xkZXIgPSBgQ3VycmVudDogJHtmaWxlfWA7XG4gICAgICAgICAgICBjb25maWdTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgIGNvbmZpZ0lucHV0LnZhbHVlID0gJyc7XG4gICAgICAgICAgICBhd2FpdCB1dGlsLndhaXQoMzAwMCk7XG4gICAgICAgICAgICB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxufVxuXG5jb25zb2xlLmdyb3VwKCdwYWdlcy5OZXcuc2VjdGlvbnMuc2V0dGluZ3MucHknKTtcbmNvbnN0IHNldHRpbmdzRGl2ID0gbmV3IFNldHRpbmdzRGl2KHsgaWQgOiAnc2V0dGluZ3NfZGl2JyB9KTtcbmNvbnNvbGUuZ3JvdXBFbmQoKTtcbmV4cG9ydCBkZWZhdWx0IHNldHRpbmdzRGl2O1xuXG4iXX0=