"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const bhe_1 = require("../../../bhe");
const extra_1 = require("../../../bhe/extra");
const Glob_1 = require("../../../Glob");
const fs = require("fs");
const MyAlert_1 = require("../../../MyAlert");
const util = require("../../../util");
const MyStore_1 = require("../../../MyStore");
const path = require("path");
class SettingsDiv extends bhe_1.Div {
    constructor({ id }) {
        super({ id });
        const subconfig = Glob_1.default.BigConfig.getSubconfig();
        const configs = fs.readdirSync(CONFIGS_PATH_ABS);
        const configSection = new extra_1.InputSection({
            placeholder: `Current: ${subconfig.name}`,
            h3text: `Config File`,
            suggestions: configs,
        });
        configSection.inputAndSubmitFlex.submitButton.click(() => this.onConfigSubmit(configs, subconfig));
        const subjects = Glob_1.default.BigConfig.subjects;
        const currentSubject = subconfig.subject;
        const subjectSection = new extra_1.InputSection({
            placeholder: `Current: ${currentSubject}`,
            h3text: 'Subject',
            suggestions: subjects
        });
        const { submitButton: subjectSubmit } = subjectSection.inputAndSubmitFlex;
        subjectSubmit.click(() => this.onSubjectSubmit(currentSubject, subconfig));
        const truthsWith3TxtFiles = MyStore_1.getTruthsWith3TxtFiles();
        console.log({ truthsWith3TxtFiles });
        const currentTruth = subconfig.truth;
        const truthSection = new extra_1.InputSection({
            placeholder: `Current: ${currentTruth.name}`,
            h3text: 'Truth',
            suggestions: truthsWith3TxtFiles,
            illegalRegex: /[^(a-z0-9A-Z|_)]/
        });
        truthSection.inputAndSubmitFlex.submitButton.click(() => this.onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles));
        const subtitle = bhe_1.elem({ tag: 'h2', text: 'Settings' });
        this.cacheAppend({ subtitle, configSection, subjectSection, truthSection });
    }
    async onTruthSubmit(currentTruth, subconfig, truthsWith3TxtFiles) {
        const { submitButton: truthSubmit, inputElem: truthInput } = this.truthSection.inputAndSubmitFlex;
        let value = truthInput.value;
        let valueLower = value.lower();
        if (valueLower.endsWithAny('_on', '_off')) {
            console.warn(`onTruthSubmit value not a base txt: ${valueLower}. Cutting`);
            value = value.upTo('_', true);
            valueLower = value.lower();
        }
        console.log('onTruthSubmit', { value, currentTruth });
        if (currentTruth.name.lower() === valueLower) {
            MyAlert_1.default.small.info(`${currentTruth.name} was already the chosen truth`);
            truthSubmit.replaceClass('active', 'inactive');
            return truthInput.value = '';
        }
        for (let truthName of truthsWith3TxtFiles) {
            let truthNameLower = truthName.lower();
            if (truthNameLower === valueLower) {
                subconfig.truth_file = truthName;
                truthInput.value = '';
                truthInput.placeholder = `Current: ${truthName}`;
                truthSubmit.replaceClass('active', 'inactive');
                MyAlert_1.default.small.success(`Using truth: "${truthName}"`);
                await util.wait(3000);
                return util.reloadPage();
            }
        }
        return MyAlert_1.default.small.warning(`Either this truth doesn't exist completely, or doesn't have its 3 associated .txt files. Please choose an existing one.`);
    }
    onSubjectSubmit(currentSubject, subconfig) {
        const { submitButton: subjectSubmit, inputElem: subjectInput } = this.subjectSection.inputAndSubmitFlex;
        const value = subjectInput.value;
        if (currentSubject === value) {
            MyAlert_1.default.small.info(`${currentSubject} was already the chosen subject`);
        }
        else {
            subconfig.subject = value;
            MyAlert_1.default.small.success(`Subject set: ${value}.`);
            subjectInput.placeholder = `Current: ${value}`;
        }
        subjectSubmit.replaceClass('active', 'inactive');
        subjectInput.value = '';
    }
    async onConfigSubmit(configs, subconfig) {
        const { submitButton: configSubmit, inputElem: configInput } = this.configSection.inputAndSubmitFlex;
        let file = configInput.value;
        console.log('onConfigSubmit,', file);
        try {
            MyStore_1.Subconfig.validateName(file);
        }
        catch (e) {
            if (e.message === 'ExtensionError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning('File name must end with either .exam or .test');
            }
            if (e.message === 'BasenameError') {
                configInput.addClass('invalid');
                return MyAlert_1.default.small.warning(`Insert just a file name, not a path with slashes. eg: "${path.basename(file)}"`);
            }
        }
        configInput.removeClass('invalid');
        const fileLower = file.lower();
        if (subconfig.name.lower() === fileLower) {
            MyAlert_1.default.small.info(`${subconfig.name} was already the chosen file`);
            configSubmit.replaceClass('active', 'inactive');
            return configInput.value = '';
        }
        let action = "create";
        for (let cfg of configs) {
            if (cfg.lower() === fileLower) {
                action = await MyAlert_1.default.big.threeButtons({
                    title: `${cfg} already exists, what do you want to do?`,
                    confirmButtonText: 'Use it',
                    thirdButtonText: 'Overwrite it',
                    thirdButtonType: "warning"
                });
                if (action === "cancel") {
                    return;
                }
                file = cfg;
                break;
            }
        }
        const ext = path.extname(file);
        const experimentType = ext.slice(1);
        Glob_1.default.BigConfig.experiment_type = experimentType;
        console.log({ action, file });
        if (action === "confirm") {
            Glob_1.default.BigConfig.setSubconfig(file);
            MyAlert_1.default.small.success(`Config loaded: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('active', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
        if (action === "create" || action === "third") {
            Glob_1.default.BigConfig.setSubconfig(file, subconfig);
            let verb = action === "third" ? 'overwritten' : 'created';
            MyAlert_1.default.small.success(`Config ${verb}: ${file}.`);
            configInput.placeholder = `Current: ${file}`;
            configSubmit.replaceClass('active', 'inactive');
            configInput.value = '';
            await util.wait(3000);
            util.reloadPage();
        }
    }
}
console.group('pages.New.sections.settings.ts');
const settingsDiv = new SettingsDiv({ id: 'settings_div' });
console.groupEnd();
exports.default = settingsDiv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZXR0aW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUtBLHNDQUFnRTtBQUVoRSw4Q0FBa0Q7QUFDbEQsd0NBQWlDO0FBQ2pDLHlCQUF5QjtBQUV6Qiw4Q0FBK0Q7QUFDL0Qsc0NBQXNDO0FBQ3RDLDhDQUFxRjtBQUVyRiw2QkFBNkI7QUFFN0IsTUFBTSxXQUFZLFNBQVEsU0FBRztJQUt6QixZQUFZLEVBQUUsRUFBRSxFQUFFO1FBQ2QsS0FBSyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUtkLE1BQU0sU0FBUyxHQUFjLGNBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDM0QsTUFBTSxPQUFPLEdBQWEsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzNELE1BQU0sYUFBYSxHQUFHLElBQUksb0JBQVksQ0FBQztZQUNuQyxXQUFXLEVBQUcsWUFBWSxTQUFTLENBQUMsSUFBSSxFQUFFO1lBQzFDLE1BQU0sRUFBRyxhQUFhO1lBQ3RCLFdBQVcsRUFBRyxPQUFPO1NBRXhCLENBQUMsQ0FBQztRQUVILGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFHbkcsTUFBTSxRQUFRLEdBQUcsY0FBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFFekMsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQztRQUN6QyxNQUFNLGNBQWMsR0FBRyxJQUFJLG9CQUFZLENBQUM7WUFDcEMsV0FBVyxFQUFHLFlBQVksY0FBYyxFQUFFO1lBQzFDLE1BQU0sRUFBRyxTQUFTO1lBQ2xCLFdBQVcsRUFBRyxRQUFRO1NBQ3pCLENBQUMsQ0FBQztRQUNILE1BQU0sRUFBRSxZQUFZLEVBQUcs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QVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQzdDLElBQUksSUFBSSxHQUFHLE1BQU0sS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQzFELGlCQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxVQUFVLElBQUksS0FBSyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQ2xELFdBQVcsQ0FBQyxXQUFXLEdBQUcsWUFBWSxJQUFJLEVBQUUsQ0FBQztZQUM3QyxZQUFZLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNoRCxXQUFXLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztZQUN2QixNQUFNLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQ3JCO0lBR0wsQ0FBQztDQUVKO0FBRUQsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ2hELE1BQU0sV0FBVyxHQUFHLElBQUksV0FBVyxDQUFDLEVBQUUsRUFBRSxFQUFHLGNBQWMsRUFBRSxDQUFDLENBQUM7QUFDN0QsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ25CLGtCQUFlLFdBQVcsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vICogIHBhZ2VzL05ldy9zZWN0aW9ucy9zZXR0aW5nc1xuXG4vKipcbiAqIGltcG9ydCBzZWN0aW9ucyBmcm9tIFwiLi9zZWN0aW9uc1wiXG4gKiBzZWN0aW9ucy5zZXR0aW5ncyovXG5pbXBvcnQgeyBlbGVtLCBEaXYsIGJ1dHRvbiwgSW5wdXQsIEJ1dHRvbiB9IGZyb20gXCIuLi8uLi8uLi9iaGVcIjtcblxuaW1wb3J0IHsgSW5wdXRTZWN0aW9uIH0gZnJvbSBcIi4uLy4uLy4uL2JoZS9leHRyYVwiO1xuaW1wb3J0IEdsb2IgZnJvbSBcIi4uLy4uLy4uL0dsb2JcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuXG5pbXBvcnQgTXlBbGVydCwgeyBDcmVhdGVDb25maXJtQ2FuY2VsIH0gZnJvbSAnLi4vLi4vLi4vTXlBbGVydCdcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSBcIi4uLy4uLy4uL3V0aWxcIjtcbmltcG9ydCB7IEV4cGVyaW1lbnRUeXBlLCBnZXRUcnV0aHNXaXRoM1R4dEZpbGVzLCBTdWJjb25maWcgfSBmcm9tIFwiLi4vLi4vLi4vTXlTdG9yZVwiO1xuaW1wb3J0IHsgVHJ1dGggfSBmcm9tIFwiLi4vLi4vLi4vVHJ1dGhcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcblxuY2xhc3MgU2V0dGluZ3NEaXYgZXh0ZW5kcyBEaXYge1xuICAgIHByaXZhdGUgY29uZmlnU2VjdGlvbjogSW5wdXRTZWN0aW9uO1xuICAgIHByaXZhdGUgc3ViamVjdFNlY3Rpb246IElucHV0U2VjdGlvbjtcbiAgICBwcml2YXRlIHRydXRoU2VjdGlvbjogSW5wdXRTZWN0aW9uO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKHsgaWQgfSkge1xuICAgICAgICBzdXBlcih7IGlkIH0pO1xuICAgICAgICAvLyAqKiogIEZpbGVcbiAgICAgICAgLy8gY29uc3QgZXhwZXJpbWVudFR5cGUgPSBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGU7XG4gICAgICAgIC8vIGNvbnN0IHN1YmNvbmZpZ0ZpbGU6IHN0cmluZyA9IEdsb2IuQmlnQ29uZmlnW2Ake2V4cGVyaW1lbnRUeXBlfV9maWxlYF07XG4gICAgICAgIC8vIGNvbnN0IHN1YmNvbmZpZzogU3ViY29uZmlnID0gR2xvYi5CaWdDb25maWdbZXhwZXJpbWVudFR5cGVdO1xuICAgICAgICBjb25zdCBzdWJjb25maWc6IFN1YmNvbmZpZyA9IEdsb2IuQmlnQ29uZmlnLmdldFN1YmNvbmZpZygpO1xuICAgICAgICBjb25zdCBjb25maWdzOiBzdHJpbmdbXSA9IGZzLnJlYWRkaXJTeW5jKENPTkZJR1NfUEFUSF9BQlMpO1xuICAgICAgICBjb25zdCBjb25maWdTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlciA6IGBDdXJyZW50OiAke3N1YmNvbmZpZy5uYW1lfWAsXG4gICAgICAgICAgICBoM3RleHQgOiBgQ29uZmlnIEZpbGVgLFxuICAgICAgICAgICAgc3VnZ2VzdGlvbnMgOiBjb25maWdzLFxuICAgICAgICAgICAgXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgY29uZmlnU2VjdGlvbi5pbnB1dEFuZFN1Ym1pdEZsZXguc3VibWl0QnV0dG9uLmNsaWNrKCgpID0+IHRoaXMub25Db25maWdTdWJtaXQoY29uZmlncywgc3ViY29uZmlnKSk7XG4gICAgICAgIFxuICAgICAgICAvLyAqKiogIFN1YmplY3RcbiAgICAgICAgY29uc3Qgc3ViamVjdHMgPSBHbG9iLkJpZ0NvbmZpZy5zdWJqZWN0cztcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGN1cnJlbnRTdWJqZWN0ID0gc3ViY29uZmlnLnN1YmplY3Q7XG4gICAgICAgIGNvbnN0IHN1YmplY3RTZWN0aW9uID0gbmV3IElucHV0U2VjdGlvbih7XG4gICAgICAgICAgICBwbGFjZWhvbGRlciA6IGBDdXJyZW50OiAke2N1cnJlbnRTdWJqZWN0fWAsXG4gICAgICAgICAgICBoM3RleHQgOiAnU3ViamVjdCcsXG4gICAgICAgICAgICBzdWdnZXN0aW9ucyA6IHN1YmplY3RzXG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB7IHN1Ym1pdEJ1dHRvbiA6IHN1YmplY3RTdWJtaXQgfSA9IHN1YmplY3RTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgc3ViamVjdFN1Ym1pdC5jbGljaygoKSA9PiB0aGlzLm9uU3ViamVjdFN1Ym1pdChjdXJyZW50U3ViamVjdCwgc3ViY29uZmlnKSk7XG4gICAgICAgIFxuICAgICAgICAvLyAqKiogIFRydXRoXG4gICAgICAgIGNvbnN0IHRydXRoc1dpdGgzVHh0RmlsZXMgPSBnZXRUcnV0aHNXaXRoM1R4dEZpbGVzKCk7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgdHJ1dGhzV2l0aDNUeHRGaWxlcyB9KTtcbiAgICAgICAgY29uc3QgY3VycmVudFRydXRoID0gc3ViY29uZmlnLnRydXRoO1xuICAgICAgICBjb25zdCB0cnV0aFNlY3Rpb24gPSBuZXcgSW5wdXRTZWN0aW9uKHtcbiAgICAgICAgICAgIHBsYWNlaG9sZGVyIDogYEN1cnJlbnQ6ICR7Y3VycmVudFRydXRoLm5hbWV9YCxcbiAgICAgICAgICAgIGgzdGV4dCA6ICdUcnV0aCcsXG4gICAgICAgICAgICBzdWdnZXN0aW9ucyA6IHRydXRoc1dpdGgzVHh0RmlsZXMsXG4gICAgICAgICAgICBpbGxlZ2FsUmVnZXggOiAvW14oYS16MC05QS1afF8pXS9cbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICB0cnV0aFNlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4LnN1Ym1pdEJ1dHRvbi5jbGljaygoKSA9PiB0aGlzLm9uVHJ1dGhTdWJtaXQoY3VycmVudFRydXRoLCBzdWJjb25maWcsIHRydXRoc1dpdGgzVHh0RmlsZXMpKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHN1YnRpdGxlID0gZWxlbSh7IHRhZyA6ICdoMicsIHRleHQgOiAnU2V0dGluZ3MnIH0pO1xuICAgICAgICB0aGlzLmNhY2hlQXBwZW5kKHsgc3VidGl0bGUsIGNvbmZpZ1NlY3Rpb24sIHN1YmplY3RTZWN0aW9uLCB0cnV0aFNlY3Rpb24gfSlcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgYXN5bmMgb25UcnV0aFN1Ym1pdChjdXJyZW50VHJ1dGg6IFRydXRoLCBzdWJjb25maWc6IFN1YmNvbmZpZywgdHJ1dGhzV2l0aDNUeHRGaWxlczogc3RyaW5nW10pIHtcbiAgICAgICAgY29uc3QgeyBzdWJtaXRCdXR0b24gOiB0cnV0aFN1Ym1pdCwgaW5wdXRFbGVtIDogdHJ1dGhJbnB1dCB9ID0gdGhpcy50cnV0aFNlY3Rpb24uaW5wdXRBbmRTdWJtaXRGbGV4O1xuICAgICAgICBsZXQgdmFsdWUgPSB0cnV0aElucHV0LnZhbHVlO1xuICAgICAgICBsZXQgdmFsdWVMb3dlciA9IHZhbHVlLmxvd2VyKCk7XG4gICAgICAgIGlmICggdmFsdWVMb3dlci5lbmRzV2l0aEFueSgnX29uJywgJ19vZmYnKSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2Fybihgb25UcnV0aFN1Ym1pdCB2YWx1ZSBub3QgYSBiYXNlIHR4dDogJHt2YWx1ZUxvd2VyfS4gQ3V0dGluZ2ApO1xuICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS51cFRvKCdfJywgdHJ1ZSk7XG4gICAgICAgICAgICB2YWx1ZUxvd2VyID0gdmFsdWUubG93ZXIoKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZygnb25UcnV0aFN1Ym1pdCcsIHsgdmFsdWUsIGN1cnJlbnRUcnV0aCB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIC8gQ2hvc2VuIGlzIGFscmVhZHkgY3VycmVudGx5IHNldFxuICAgICAgICBpZiAoIGN1cnJlbnRUcnV0aC5uYW1lLmxvd2VyKCkgPT09IHZhbHVlTG93ZXIgKSB7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLmluZm8oYCR7Y3VycmVudFRydXRoLm5hbWV9IHdhcyBhbHJlYWR5IHRoZSBjaG9zZW4gdHJ1dGhgKTtcbiAgICAgICAgICAgIHRydXRoU3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICByZXR1cm4gdHJ1dGhJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIC8gRGlmZmVyZW50IGZyb20gY3VycmVudCwgY2hlY2sgaWYgZXhpc3RzIGluIFwid2hvbGVcIiB0cnV0aHNcbiAgICAgICAgZm9yICggbGV0IHRydXRoTmFtZSBvZiB0cnV0aHNXaXRoM1R4dEZpbGVzICkge1xuICAgICAgICAgICAgbGV0IHRydXRoTmFtZUxvd2VyID0gdHJ1dGhOYW1lLmxvd2VyKCk7XG4gICAgICAgICAgICBpZiAoIHRydXRoTmFtZUxvd2VyID09PSB2YWx1ZUxvd2VyICkge1xuICAgICAgICAgICAgICAgIHN1YmNvbmZpZy50cnV0aF9maWxlID0gdHJ1dGhOYW1lO1xuICAgICAgICAgICAgICAgIHRydXRoSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgICAgICB0cnV0aElucHV0LnBsYWNlaG9sZGVyID0gYEN1cnJlbnQ6ICR7dHJ1dGhOYW1lfWA7XG4gICAgICAgICAgICAgICAgdHJ1dGhTdWJtaXQucmVwbGFjZUNsYXNzKCdhY3RpdmUnLCAnaW5hY3RpdmUnKTtcbiAgICAgICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFVzaW5nIHRydXRoOiBcIiR7dHJ1dGhOYW1lfVwiYCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdXRpbC53YWl0KDMwMDApO1xuICAgICAgICAgICAgICAgIHJldHVybiB1dGlsLnJlbG9hZFBhZ2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyAvIEVpdGhlciBleGlzdHMgaW4gXCJwYXJ0aWFsXCIgdHJ1dGhzIG9yIG5vdCBhdCBhbGxcbiAgICAgICAgcmV0dXJuIE15QWxlcnQuc21hbGwud2FybmluZyhgRWl0aGVyIHRoaXMgdHJ1dGggZG9lc24ndCBleGlzdCBjb21wbGV0ZWx5LCBvciBkb2Vzbid0IGhhdmUgaXRzIDMgYXNzb2NpYXRlZCAudHh0IGZpbGVzLiBQbGVhc2UgY2hvb3NlIGFuIGV4aXN0aW5nIG9uZS5gKVxuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgb25TdWJqZWN0U3VibWl0KGN1cnJlbnRTdWJqZWN0OiBzdHJpbmcsIHN1YmNvbmZpZzogU3ViY29uZmlnKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uIDogc3ViamVjdFN1Ym1pdCwgaW5wdXRFbGVtIDogc3ViamVjdElucHV0IH0gPSB0aGlzLnN1YmplY3RTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBzdWJqZWN0SW5wdXQudmFsdWU7XG4gICAgICAgIFxuICAgICAgICBpZiAoIGN1cnJlbnRTdWJqZWN0ID09PSB2YWx1ZSApIHtcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuaW5mbyhgJHtjdXJyZW50U3ViamVjdH0gd2FzIGFscmVhZHkgdGhlIGNob3NlbiBzdWJqZWN0YClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHN1YmNvbmZpZy5zdWJqZWN0ID0gdmFsdWU7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYFN1YmplY3Qgc2V0OiAke3ZhbHVlfS5gKTtcbiAgICAgICAgICAgIHN1YmplY3RJbnB1dC5wbGFjZWhvbGRlciA9IGBDdXJyZW50OiAke3ZhbHVlfWA7XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBzdWJqZWN0U3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgIHN1YmplY3RJbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgYXN5bmMgb25Db25maWdTdWJtaXQoY29uZmlnczogc3RyaW5nW10sIHN1YmNvbmZpZzogU3ViY29uZmlnKSB7XG4gICAgICAgIGNvbnN0IHsgc3VibWl0QnV0dG9uIDogY29uZmlnU3VibWl0LCBpbnB1dEVsZW0gOiBjb25maWdJbnB1dCB9ID0gdGhpcy5jb25maWdTZWN0aW9uLmlucHV0QW5kU3VibWl0RmxleDtcbiAgICAgICAgbGV0IGZpbGUgPSBjb25maWdJbnB1dC52YWx1ZTtcbiAgICAgICAgLy8gY29uc3QgWyBmaWxlbmFtZSwgZXh0IF0gPSBteWZzLnNwbGl0X2V4dChmaWxlKTtcbiAgICAgICAgY29uc29sZS5sb2coJ29uQ29uZmlnU3VibWl0LCcsIGZpbGUpO1xuICAgICAgICAvLy8vIENoZWNrIGZvciBiYWQgZXh0ZW5zaW9uIG9yIGJhZCBmaWxlbmFtZVxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgU3ViY29uZmlnLnZhbGlkYXRlTmFtZShmaWxlKTtcbiAgICAgICAgfSBjYXRjaCAoIGUgKSB7XG4gICAgICAgICAgICBpZiAoIGUubWVzc2FnZSA9PT0gJ0V4dGVuc2lvbkVycm9yJyApIHtcbiAgICAgICAgICAgICAgICBjb25maWdJbnB1dC5hZGRDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBNeUFsZXJ0LnNtYWxsLndhcm5pbmcoJ0ZpbGUgbmFtZSBtdXN0IGVuZCB3aXRoIGVpdGhlciAuZXhhbSBvciAudGVzdCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCBlLm1lc3NhZ2UgPT09ICdCYXNlbmFtZUVycm9yJyApIHtcbiAgICAgICAgICAgICAgICBjb25maWdJbnB1dC5hZGRDbGFzcygnaW52YWxpZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybiBNeUFsZXJ0LnNtYWxsLndhcm5pbmcoYEluc2VydCBqdXN0IGEgZmlsZSBuYW1lLCBub3QgYSBwYXRoIHdpdGggc2xhc2hlcy4gZWc6IFwiJHtwYXRoLmJhc2VuYW1lKGZpbGUpfVwiYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vLy8gRXh0ZW5zaW9uIGFuZCBmaWxlIG5hbWUgb2s7IGNoZWNrIGlmIHVzZXIgY2hvc2Ugd2hhdCdzIGN1cnJlbnRseSBzZXRcbiAgICAgICAgY29uZmlnSW5wdXQucmVtb3ZlQ2xhc3MoJ2ludmFsaWQnKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGZpbGVMb3dlciA9IGZpbGUubG93ZXIoKTtcbiAgICAgICAgaWYgKCBzdWJjb25maWcubmFtZS5sb3dlcigpID09PSBmaWxlTG93ZXIgKSB7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLmluZm8oYCR7c3ViY29uZmlnLm5hbWV9IHdhcyBhbHJlYWR5IHRoZSBjaG9zZW4gZmlsZWApO1xuICAgICAgICAgICAgY29uZmlnU3VibWl0LnJlcGxhY2VDbGFzcygnYWN0aXZlJywgJ2luYWN0aXZlJyk7XG4gICAgICAgICAgICByZXR1cm4gY29uZmlnSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8vLyBDaG9zZW4gc29tZXRoaW5nIGVsc2U7IGNoZWNrIGlmIGV4aXN0c1xuICAgICAgICBsZXQgYWN0aW9uOiBDcmVhdGVDb25maXJtQ2FuY2VsIHwgXCJjcmVhdGVcIiA9IFwiY3JlYXRlXCI7IC8vIGNyZWF0ZSAoZG9lc250IGV4aXN0KSwgY29uZmlybSAodXNlIGV4aXN0aW5nKSwgb3ZlcndyaXRlIChvbiB0b3Agb2YgZXhpc3RpbmcpLCBjYW5jZWxcbiAgICAgICAgXG4gICAgICAgIGZvciAoIGxldCBjZmcgb2YgY29uZmlncyApIHtcbiAgICAgICAgICAgIGlmICggY2ZnLmxvd2VyKCkgPT09IGZpbGVMb3dlciApIHtcbiAgICAgICAgICAgICAgICBhY3Rpb24gPSBhd2FpdCBNeUFsZXJ0LmJpZy50aHJlZUJ1dHRvbnMoe1xuICAgICAgICAgICAgICAgICAgICB0aXRsZSA6IGAke2NmZ30gYWxyZWFkeSBleGlzdHMsIHdoYXQgZG8geW91IHdhbnQgdG8gZG8/YCxcbiAgICAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQgOiAnVXNlIGl0JyxcbiAgICAgICAgICAgICAgICAgICAgdGhpcmRCdXR0b25UZXh0IDogJ092ZXJ3cml0ZSBpdCcsXG4gICAgICAgICAgICAgICAgICAgIHRoaXJkQnV0dG9uVHlwZSA6IFwid2FybmluZ1wiXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gYXdhaXQgTXlBbGVydC5iaWcuYmxvY2tpbmcoe1xuICAgICAgICAgICAgICAgICB0aXRsZSA6IGAke2NmZ30gYWxyZWFkeSBleGlzdHMsIHdoYXQgZG8geW91IHdhbnQgdG8gZG8/YCxcbiAgICAgICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQgOiAnVXNlIGl0JyxcbiAgICAgICAgICAgICAgICAgb25CZWZvcmVPcGVuIDogKG1vZGFsOiBIVE1MRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgICAgICBsZXQgZWwgPSBlbGVtKHsgaHRtbEVsZW1lbnQgOiBtb2RhbCwgY2hpbGRyZW4gOiB7IGFjdGlvbnMgOiAnLnN3YWwyLWFjdGlvbnMnIH0gfSk7XG4gICAgICAgICAgICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgICAgICAgICAgZWwuYWN0aW9ucy5hcHBlbmQoXG4gICAgICAgICAgICAgICAgIGJ1dHRvbih7IGNscyA6IFwic3dhbDItY29uZmlybSBzd2FsMi1zdHlsZWQgd2FyblwiLCBodG1sIDogJ092ZXJ3cml0ZSBpdCcgfSlcbiAgICAgICAgICAgICAgICAgLmF0dHIoeyB0eXBlIDogJ2J1dHRvbicgfSlcbiAgICAgICAgICAgICAgICAgLmNzcyh7IGJhY2tncm91bmRDb2xvciA6ICcjRkZDNjZEJywgY29sb3IgOiAnYmxhY2snIH0pXG4gICAgICAgICAgICAgICAgIC5jbGljaygoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgLy8gXCJPdmVyd3JpdGUgaXRcIlxuICAgICAgICAgICAgICAgICBhY3Rpb24gPSBcIm92ZXJ3cml0ZVwiO1xuICAgICAgICAgICAgICAgICBvdmVyd3JpdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICBmaWxlID0gY2ZnOyAvLyBtYXRjaCBjYXNlXG4gICAgICAgICAgICAgICAgIE15QWxlcnQuY2xpY2tDYW5jZWwoKTtcbiAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICggYWN0aW9uID09PSBcImNhbmNlbFwiICkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vLy8gXCJPdmVyd3JpdGVcIiBvciBcIlVzZSBpdFwiXG4gICAgICAgICAgICAgICAgZmlsZSA9IGNmZzsgLy8gbWF0Y2ggY2FzZVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIC8vLy8gRWl0aGVyIGV4aXN0cyB0aGVuIGxvYWQgb3Igb3ZlcndyaXRlIGl0LCBvciBjb21wbGV0ZWx5IG5ld1xuICAgICAgICBjb25zdCBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZSk7XG4gICAgICAgIGNvbnN0IGV4cGVyaW1lbnRUeXBlID0gZXh0LnNsaWNlKDEpIGFzIEV4cGVyaW1lbnRUeXBlO1xuICAgICAgICBHbG9iLkJpZ0NvbmZpZy5leHBlcmltZW50X3R5cGUgPSBleHBlcmltZW50VHlwZTtcbiAgICAgICAgY29uc29sZS5sb2coeyBhY3Rpb24sIGZpbGUgfSk7XG4gICAgICAgIGlmICggYWN0aW9uID09PSBcImNvbmZpcm1cIiApIHsgLy8gRXhpc3RzLCBcIlVzZSBpdFwiXG4gICAgICAgICAgICBHbG9iLkJpZ0NvbmZpZy5zZXRTdWJjb25maWcoZmlsZSk7XG4gICAgICAgICAgICBNeUFsZXJ0LnNtYWxsLnN1Y2Nlc3MoYENvbmZpZyBsb2FkZWQ6ICR7ZmlsZX0uYCk7XG4gICAgICAgICAgICBjb25maWdJbnB1dC5wbGFjZWhvbGRlciA9IGBDdXJyZW50OiAke2ZpbGV9YDtcbiAgICAgICAgICAgIGNvbmZpZ1N1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICggYWN0aW9uID09PSBcImNyZWF0ZVwiIHx8IGFjdGlvbiA9PT0gXCJ0aGlyZFwiICkge1xuICAgICAgICAgICAgR2xvYi5CaWdDb25maWcuc2V0U3ViY29uZmlnKGZpbGUsIHN1YmNvbmZpZyk7XG4gICAgICAgICAgICBsZXQgdmVyYiA9IGFjdGlvbiA9PT0gXCJ0aGlyZFwiID8gJ292ZXJ3cml0dGVuJyA6ICdjcmVhdGVkJztcbiAgICAgICAgICAgIE15QWxlcnQuc21hbGwuc3VjY2VzcyhgQ29uZmlnICR7dmVyYn06ICR7ZmlsZX0uYCk7XG4gICAgICAgICAgICBjb25maWdJbnB1dC5wbGFjZWhvbGRlciA9IGBDdXJyZW50OiAke2ZpbGV9YDtcbiAgICAgICAgICAgIGNvbmZpZ1N1Ym1pdC5yZXBsYWNlQ2xhc3MoJ2FjdGl2ZScsICdpbmFjdGl2ZScpO1xuICAgICAgICAgICAgY29uZmlnSW5wdXQudmFsdWUgPSAnJztcbiAgICAgICAgICAgIGF3YWl0IHV0aWwud2FpdCgzMDAwKTtcbiAgICAgICAgICAgIHV0aWwucmVsb2FkUGFnZSgpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG59XG5cbmNvbnNvbGUuZ3JvdXAoJ3BhZ2VzLk5ldy5zZWN0aW9ucy5zZXR0aW5ncy50cycpO1xuY29uc3Qgc2V0dGluZ3NEaXYgPSBuZXcgU2V0dGluZ3NEaXYoeyBpZCA6ICdzZXR0aW5nc19kaXYnIH0pO1xuY29uc29sZS5ncm91cEVuZCgpO1xuZXhwb3J0IGRlZmF1bHQgc2V0dGluZ3NEaXY7XG5cbiJdfQ==