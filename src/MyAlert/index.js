"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
console.log('src/MyAlert/index.ts');
const sweetalert2_1 = require("sweetalert2");
const bhe_1 = require("../bhe");
const path = require("path");
const util_1 = require("../util");
const smallMixin = sweetalert2_1.default.mixin({
    animation: false,
    customClass: 'animated fadeIn',
    position: "bottom-start",
    showConfirmButton: false,
    timer: 8000,
    toast: true,
});
const withConfirm = {
    cancelButtonText: "No",
    confirmButtonText: "Yes",
    showCancelButton: true,
    showConfirmButton: true,
    timer: null,
};
const blockingOptions = {
    allowEnterKey: false,
    allowEscapeKey: false,
    allowOutsideClick: false,
    animation: false,
    customClass: 'animated fadeIn',
    showCancelButton: false,
    showCloseButton: false,
    showConfirmButton: false,
    width: "75vw",
};
const threeButtonsOptions = Object.assign(Object.assign({}, blockingOptions), { showConfirmButton: true, showCancelButton: true });
const blockingSwalMixin = sweetalert2_1.default.mixin(blockingOptions);
const small = {
    _question(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'question' }));
    },
    _info(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'info' }));
    },
    _success(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'success' }));
    },
    _error(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'error' }));
    },
    _warning(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { showConfirmButton: true, type: 'warning' }));
    },
    error(title, text) {
        return smallMixin.fire({
            title,
            text,
            type: "error",
        });
    },
    info(title, text = null, showConfirmBtns = false) {
        let infoOptions = {
            title,
            text,
            type: "info",
        };
        if (showConfirmBtns)
            infoOptions = Object.assign(Object.assign({}, infoOptions), withConfirm);
        return smallMixin.fire(infoOptions);
    },
    success(title, text = null, timer = 6000) {
        return smallMixin.fire({
            title,
            text,
            type: "success",
            timer
        });
    },
    warning(title, text = null) {
        let warningOptions = {
            title,
            text,
            showConfirmButton: true,
            timer: null,
            type: "warning"
        };
        return smallMixin.fire(warningOptions);
    },
};
const big = {
    async error(options) {
        var _a;
        if (((_a = options) === null || _a === void 0 ? void 0 : _a.html) instanceof Error) {
            const error = options.html;
            const { what, where, cleanstack } = error.toObj();
            console.log({ cleanstack });
            options.html = `${what}<p>${where}</p>`;
        }
        const dirname = new Date().human();
        const { default: Glob } = require('../Glob');
        if (LOG || Glob.BigConfig.get('dev')) {
            options.onOpen = async () => {
                await util_1.takeScreenshot(dirname);
            };
            options.onAfterClose = async () => {
                await util_1.wait(500);
                await util_1.takeScreenshot(dirname);
            };
            options.html += `<p>Logs and screenshot saved to errors/${path.basename(SESSION_PATH_ABS)}/${dirname}</p>`;
        }
        return blockingSwalMixin.fire(Object.assign({ type: 'error', showConfirmButton: true }, options));
    },
    warning(options) {
        if (options.animation === false)
            options = Object.assign({ customClass: null }, options);
        return blockingSwalMixin.fire(Object.assign(Object.assign(Object.assign({}, withConfirm), { type: 'warning' }), options));
    },
    blocking(options, moreOptions) {
        if (moreOptions && moreOptions.strings && moreOptions.clickFn) {
            let { strings, clickFn } = moreOptions;
            let paragraphs = strings
                .map(s => bhe_1.paragraph({ cls: 'clickable', text: s }))
                .map(pElem => pElem.click(() => clickFn(pElem)));
            options = Object.assign(Object.assign({}, options), { onBeforeOpen(modalElement) {
                    console.log('modalElement:', modalElement);
                    return bhe_1.elem({ id: 'swal2-content' })
                        .append(...paragraphs);
                } });
        }
        else {
            options = Object.assign({ showConfirmButton: true, showCancelButton: true }, options);
        }
        if (options.showConfirmButton || options.showCancelButton || options.onOpen) {
            return sweetalert2_1.default.fire(Object.assign(Object.assign({}, blockingOptions), options));
        }
        else {
            return new Promise(resolve => sweetalert2_1.default.fire(Object.assign(Object.assign(Object.assign({}, blockingOptions), options), { onOpen: v => resolve(v) })));
        }
    },
    oneButton(title, options) {
        return blockingSwalMixin.fire(Object.assign({ title: title, showConfirmButton: true, customClass: 'animated fadeIn' }, options));
    },
    async twoButtons(options) {
        const { value } = await sweetalert2_1.default.fire(Object.assign({ showCancelButton: true, customClass: 'animated fadeIn' }, options));
        return value ? "confirm" : "second";
    },
    async threeButtons(options) {
        let thirdButtonCss;
        if (options.thirdButtonType === "warning") {
            thirdButtonCss = { backgroundColor: '#FFC66D', color: 'black' };
        }
        console.log({ thirdButtonCss });
        let action;
        const onBeforeOpen = (modal) => {
            let el = bhe_1.elem({
                htmlElement: modal,
                children: { actions: '.swal2-actions' }
            });
            el.actions.append(bhe_1.button({ cls: `swal2-confirm swal2-styled`, html: options.thirdButtonText })
                .css(thirdButtonCss)
                .click((ev) => {
                action = "third";
                sweetalert2_1.default.clickConfirm();
            }));
        };
        options = Object.assign(Object.assign({}, options), { onBeforeOpen, showCancelButton: true });
        const { value } = await sweetalert2_1.default.fire(options);
        if (value) {
            if (action === undefined) {
                action = "confirm";
            }
        }
        else {
            action = "cancel";
        }
        return action;
    }
};
exports.default = Object.assign({ small, big }, sweetalert2_1.default);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNwQyw2Q0FBd0U7QUFDeEUsZ0NBQW9FO0FBQ3BFLDZCQUE2QjtBQUM3QixrQ0FBK0M7QUFFL0MsTUFBTSxVQUFVLEdBQWdCLHFCQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3ZDLFNBQVMsRUFBRyxLQUFLO0lBQ2pCLFdBQVcsRUFBRyxpQkFBaUI7SUFDL0IsUUFBUSxFQUFHLGNBQWM7SUFDekIsaUJBQWlCLEVBQUcsS0FBSztJQUN6QixLQUFLLEVBQUcsSUFBSTtJQUNaLEtBQUssRUFBRyxJQUFJO0NBRWYsQ0FBQyxDQUFDO0FBQ0gsTUFBTSxXQUFXLEdBQXNCO0lBQ25DLGdCQUFnQixFQUFHLElBQUk7SUFDdkIsaUJBQWlCLEVBQUcsS0FBSztJQUN6QixnQkFBZ0IsRUFBRyxJQUFJO0lBQ3ZCLGlCQUFpQixFQUFHLElBQUk7SUFDeEIsS0FBSyxFQUFHLElBQUk7Q0FFZixDQUFDO0FBQ0YsTUFBTSxlQUFlLEdBQXNCO0lBQ3ZDLGFBQWEsRUFBRyxLQUFLO0lBQ3JCLGNBQWMsRUFBRyxLQUFLO0lBQ3RCLGlCQUFpQixFQUFHLEtBQUs7SUFDekIsU0FBUyxFQUFHLEtBQUs7SUFDakIsV0FBVyxFQUFHLGlCQUFpQjtJQUMvQixnQkFBZ0IsRUFBRyxLQUFLO0lBQ3hCLGVBQWUsRUFBRyxLQUFLO0lBQ3ZCLGlCQUFpQixFQUFHLEtBQUs7SUFDekIsS0FBSyxFQUFHLE1BQU07Q0FHakIsQ0FBQztBQUNGLE1BQU0sbUJBQW1CLG1DQUNsQixlQUFlLEtBQ2xCLGlCQUFpQixFQUFHLElBQUksRUFDeEIsZ0JBQWdCLEVBQUcsSUFBSSxHQUMxQixDQUFDO0FBQ0YsTUFBTSxpQkFBaUIsR0FBRyxxQkFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztBQWF0RCxN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LENBQUM7UUFDaEUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0scUJBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0MsSUFBSyxLQUFLLEVBQUc7WUFFVCxJQUFLLE1BQU0sS0FBSyxTQUFTLEVBQUc7Z0JBQ3hCLE1BQU0sR0FBRyxTQUFTLENBQUM7YUFDdEI7U0FDSjthQUFNO1lBQ0gsTUFBTSxHQUFHLFFBQVEsQ0FBQztTQUNyQjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Q0FDSixDQUFDO0FBRUYsa0NBQWlCLEtBQUssRUFBRSxHQUFHLElBQUsscUJBQUksRUFBRyIsInNvdXJjZXNDb250ZW50IjpbIi8qKmltcG9ydCBBbGVydCBmcm9tICdNeUFsZXJ0JyAob3IgYW55IG90aGVyIG5hbWUpKi9cblxuXG5jb25zb2xlLmxvZygnc3JjL015QWxlcnQvaW5kZXgudHMnKTtcbmltcG9ydCBTd2FsLCB7IFN3ZWV0QWxlcnRSZXN1bHQsIFN3ZWV0QWxlcnRPcHRpb25zIH0gZnJvbSAnc3dlZXRhbGVydDInO1xuaW1wb3J0IHsgcGFyYWdyYXBoLCBlbGVtLCBCZXR0ZXJIVE1MRWxlbWVudCwgYnV0dG9uIH0gZnJvbSBcIi4uL2JoZVwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0IHsgd2FpdCwgdGFrZVNjcmVlbnNob3QgfSBmcm9tIFwiLi4vdXRpbFwiO1xuXG5jb25zdCBzbWFsbE1peGluOiB0eXBlb2YgU3dhbCA9IFN3YWwubWl4aW4oe1xuICAgIGFuaW1hdGlvbiA6IGZhbHNlLFxuICAgIGN1c3RvbUNsYXNzIDogJ2FuaW1hdGVkIGZhZGVJbicsXG4gICAgcG9zaXRpb24gOiBcImJvdHRvbS1zdGFydFwiLFxuICAgIHNob3dDb25maXJtQnV0dG9uIDogZmFsc2UsXG4gICAgdGltZXIgOiA4MDAwLFxuICAgIHRvYXN0IDogdHJ1ZSxcbiAgICBcbn0pO1xuY29uc3Qgd2l0aENvbmZpcm06IFN3ZWV0QWxlcnRPcHRpb25zID0ge1xuICAgIGNhbmNlbEJ1dHRvblRleHQgOiBcIk5vXCIsXG4gICAgY29uZmlybUJ1dHRvblRleHQgOiBcIlllc1wiLFxuICAgIHNob3dDYW5jZWxCdXR0b24gOiB0cnVlLFxuICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSxcbiAgICB0aW1lciA6IG51bGwsXG4gICAgXG59O1xuY29uc3QgYmxvY2tpbmdPcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyA9IHtcbiAgICBhbGxvd0VudGVyS2V5IDogZmFsc2UsXG4gICAgYWxsb3dFc2NhcGVLZXkgOiBmYWxzZSxcbiAgICBhbGxvd091dHNpZGVDbGljayA6IGZhbHNlLFxuICAgIGFuaW1hdGlvbiA6IGZhbHNlLFxuICAgIGN1c3RvbUNsYXNzIDogJ2FuaW1hdGVkIGZhZGVJbicsXG4gICAgc2hvd0NhbmNlbEJ1dHRvbiA6IGZhbHNlLCAvLyBkZWZhdWx0IGZhbHNlXG4gICAgc2hvd0Nsb3NlQnV0dG9uIDogZmFsc2UsIC8vIGRlZmF1bHQgZmFsc2VcbiAgICBzaG93Q29uZmlybUJ1dHRvbiA6IGZhbHNlLFxuICAgIHdpZHRoIDogXCI3NXZ3XCIsXG4gICAgXG4gICAgXG59O1xuY29uc3QgdGhyZWVCdXR0b25zT3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMgPSB7XG4gICAgLi4uYmxvY2tpbmdPcHRpb25zLFxuICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSxcbiAgICBzaG93Q2FuY2VsQnV0dG9uIDogdHJ1ZSxcbn07XG5jb25zdCBibG9ja2luZ1N3YWxNaXhpbiA9IFN3YWwubWl4aW4oYmxvY2tpbmdPcHRpb25zKTtcbnR5cGUgU21hbGwgPSB7XG4gICAgX2Vycm9yKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBfaW5mbyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgX3F1ZXN0aW9uKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBfc3VjY2VzcyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgX3dhcm5pbmcob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIGVycm9yKHRpdGxlOiBzdHJpbmcsIHRleHQ6IHN0cmluZyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgaW5mbyh0aXRsZTogc3RyaW5nLCB0ZXh0PzogKHN0cmluZyB8IG51bGwpLCBzaG93Q29uZmlybUJ0bnM/OiBib29sZWFuKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBzdWNjZXNzKHRpdGxlOiBzdHJpbmcsIHRleHQ/OiAoc3RyaW5nIHwgbnVsbCksIHRpbWVyPzogbnVtYmVyKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICB3YXJuaW5nKHRpdGxlOiBzdHJpbmcsIHRleHQ/OiAoc3RyaW5nIHwgbnVsbCksIHNob3dDb25maXJtQnRucz86IGJvb2xlYW4pOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxufVxuXG5jb25zdCBzbWFsbDogU21hbGwgPSB7XG4gICAgX3F1ZXN0aW9uKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh7IC4uLm9wdGlvbnMsIHR5cGUgOiAncXVlc3Rpb24nIH0pXG4gICAgfSxcbiAgICBfaW5mbyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoeyAuLi5vcHRpb25zLCB0eXBlIDogJ2luZm8nIH0pXG4gICAgfSxcbiAgICBfc3VjY2VzcyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoeyAuLi5vcHRpb25zLCB0eXBlIDogJ3N1Y2Nlc3MnIH0pXG4gICAgfSxcbiAgICBfZXJyb3Iob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHsgLi4ub3B0aW9ucywgdHlwZSA6ICdlcnJvcicgfSlcbiAgICB9LFxuICAgIF93YXJuaW5nKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh7XG4gICAgICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLCB0eXBlIDogJ3dhcm5pbmcnXG4gICAgICAgIH0pXG4gICAgfSxcbiAgICBlcnJvcih0aXRsZSwgdGV4dCkge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHtcbiAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgICAgIHR5cGUgOiBcImVycm9yXCIsXG4gICAgICAgICAgICBcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBpbmZvKHRpdGxlLCB0ZXh0ID0gbnVsbCwgc2hvd0NvbmZpcm1CdG5zID0gZmFsc2UpIHtcbiAgICAgICAgbGV0IGluZm9PcHRpb25zID0ge1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgdHlwZSA6IFwiaW5mb1wiLFxuICAgICAgICB9O1xuICAgICAgICBpZiAoIHNob3dDb25maXJtQnRucyApXG4gICAgICAgICAgICBpbmZvT3B0aW9ucyA9IHsgLi4uaW5mb09wdGlvbnMsIC4uLndpdGhDb25maXJtIH07XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZShpbmZvT3B0aW9ucyk7XG4gICAgfSxcbiAgICBzdWNjZXNzKHRpdGxlLCB0ZXh0ID0gbnVsbCwgdGltZXIgPSA2MDAwKSB7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHtcbiAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgICAgIHR5cGUgOiBcInN1Y2Nlc3NcIixcbiAgICAgICAgICAgIHRpbWVyXG4gICAgICAgIH0pXG4gICAgfSxcbiAgICB3YXJuaW5nKHRpdGxlLCB0ZXh0ID0gbnVsbCkge1xuICAgICAgICBsZXQgd2FybmluZ09wdGlvbnMgPSB7XG4gICAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbiA6IHRydWUsXG4gICAgICAgICAgICB0aW1lciA6IG51bGwsXG4gICAgICAgICAgICB0eXBlIDogXCJ3YXJuaW5nXCJcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh3YXJuaW5nT3B0aW9ucyk7XG4gICAgfSxcbiAgICBcbn07XG5leHBvcnQgdHlwZSBDcmVhdGVDb25maXJtVGhpcmQgPSBcImNvbmZpcm1cIiB8IFwiY2FuY2VsXCIgfCBcInRoaXJkXCI7XG50eXBlIEJpZyA9IHtcbiAgICBcbiAgICBlcnJvcihvcHRpb25zOiBPbWl0PFN3ZWV0QWxlcnRPcHRpb25zLCAnb25PcGVuJyB8ICdvbkFmdGVyQ2xvc2UnPiAmIHsgaHRtbDogc3RyaW5nIHwgRXJyb3IgfSk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgd2FybmluZyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgYmxvY2tpbmcob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMsIG1vcmVPcHRpb25zPzogeyBzdHJpbmdzOiBzdHJpbmdbXSwgY2xpY2tGbjogKGJoZTogQmV0dGVySFRNTEVsZW1lbnQpID0+IGFueSB9KTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBvbmVCdXR0b24odGl0bGU6IHN0cmluZywgb3B0aW9ucz86IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICB0d29CdXR0b25zKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxcImNvbmZpcm1cIiB8IFwic2Vjb25kXCI+XG4gICAgdGhyZWVCdXR0b25zKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zICYgeyB0aGlyZEJ1dHRvblRleHQ6IHN0cmluZywgdGhpcmRCdXR0b25UeXBlPzogXCJjb25maXJtXCIgfCBcIndhcm5pbmdcIiB9KTogUHJvbWlzZTxDcmVhdGVDb25maXJtVGhpcmQ+XG59XG5cbmNvbnN0IGJpZzogQmlnID0ge1xuICAgIGFzeW5jIGVycm9yKG9wdGlvbnMpIHtcbiAgICAgICAgXG4gICAgICAgIGlmICggb3B0aW9ucz8uaHRtbCBpbnN0YW5jZW9mIEVycm9yICkge1xuICAgICAgICAgICAgY29uc3QgZXJyb3IgPSBvcHRpb25zLmh0bWw7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgeyB3aGF0LCB3aGVyZSwgY2xlYW5zdGFjayB9ID0gZXJyb3IudG9PYmooKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHsgY2xlYW5zdGFjayB9KTtcbiAgICAgICAgICAgIG9wdGlvbnMuaHRtbCA9IGAke3doYXR9PHA+JHt3aGVyZX08L3A+YFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRpcm5hbWUgPSBuZXcgRGF0ZSgpLmh1bWFuKCk7XG4gICAgICAgIGNvbnN0IHsgZGVmYXVsdCA6IEdsb2IgfSA9IHJlcXVpcmUoJy4uL0dsb2InKTtcbiAgICAgICAgaWYgKCBMT0cgfHwgR2xvYi5CaWdDb25maWcuZ2V0KCdkZXYnKSApIHtcbiAgICAgICAgICAgIG9wdGlvbnMub25PcGVuID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRha2VTY3JlZW5zaG90KGRpcm5hbWUpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG9wdGlvbnMub25BZnRlckNsb3NlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGF3YWl0IHdhaXQoNTAwKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB0YWtlU2NyZWVuc2hvdChkaXJuYW1lKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBvcHRpb25zLmh0bWwgKz0gYDxwPkxvZ3MgYW5kIHNjcmVlbnNob3Qgc2F2ZWQgdG8gZXJyb3JzLyR7cGF0aC5iYXNlbmFtZShTRVNTSU9OX1BBVEhfQUJTKX0vJHtkaXJuYW1lfTwvcD5gXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBibG9ja2luZ1N3YWxNaXhpbi5maXJlKHtcbiAgICAgICAgICAgIHR5cGUgOiAnZXJyb3InLFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLFxuICAgICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHdhcm5pbmcob3B0aW9ucykge1xuICAgICAgICBpZiAoIG9wdGlvbnMuYW5pbWF0aW9uID09PSBmYWxzZSApXG4gICAgICAgICAgICBvcHRpb25zID0geyBjdXN0b21DbGFzcyA6IG51bGwsIC4uLm9wdGlvbnMgfTtcbiAgICAgICAgcmV0dXJuIGJsb2NraW5nU3dhbE1peGluLmZpcmUoeyAuLi53aXRoQ29uZmlybSwgdHlwZSA6ICd3YXJuaW5nJywgLi4ub3B0aW9ucyB9KTtcbiAgICB9LFxuICAgIFxuICAgIGJsb2NraW5nKG9wdGlvbnMsIG1vcmVPcHRpb25zKSB7XG4gICAgICAgIFxuICAgICAgICBpZiAoIG1vcmVPcHRpb25zICYmIG1vcmVPcHRpb25zLnN0cmluZ3MgJiYgbW9yZU9wdGlvbnMuY2xpY2tGbiApIHtcbiAgICAgICAgICAgIGxldCB7IHN0cmluZ3MsIGNsaWNrRm4gfSA9IG1vcmVPcHRpb25zO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcGFyYWdyYXBocyA9IHN0cmluZ3NcbiAgICAgICAgICAgICAgICAvLyAubWFwKHMgPT4gJChgPHAgY2xhc3M9XCJjbGlja2FibGVcIj4ke3N9PC9wPmApKVxuICAgICAgICAgICAgICAgIC5tYXAocyA9PiBwYXJhZ3JhcGgoeyBjbHMgOiAnY2xpY2thYmxlJywgdGV4dCA6IHMgfSkpXG4gICAgICAgICAgICAgICAgLm1hcChwRWxlbSA9PiBwRWxlbS5jbGljaygoKSA9PiBjbGlja0ZuKHBFbGVtKSkpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICAgICAgb25CZWZvcmVPcGVuKG1vZGFsRWxlbWVudDogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ21vZGFsRWxlbWVudDonLCBtb2RhbEVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbSh7IGlkIDogJ3N3YWwyLWNvbnRlbnQnIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAuc2hvdygpXG4gICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKC4uLnBhcmFncmFwaHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7IC8vIGZvcmNlIGNvbmZpcm0gYW5kIGNhbmNlbCBidXR0b25zXG4gICAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIG9wdGlvbnMuc2hvd0NvbmZpcm1CdXR0b24gfHwgb3B0aW9ucy5zaG93Q2FuY2VsQnV0dG9uIHx8IG9wdGlvbnMub25PcGVuICkge1xuICAgICAgICAgICAgLy8gLyBIYXBwZW5zIHdoZW4gbm90IG9yIGJhZCBtb3JlT3B0aW9uc1xuICAgICAgICAgICAgcmV0dXJuIFN3YWwuZmlyZSh7IC4uLmJsb2NraW5nT3B0aW9ucywgLi4ub3B0aW9ucyB9KTtcbiAgICAgICAgfSBlbHNlIHsgLy8gVE9ETzogb25PcGVuIDogcmVzb2x2ZT9cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gU3dhbC5maXJlKHsgLi4uYmxvY2tpbmdPcHRpb25zLCAuLi5vcHRpb25zLCBvbk9wZW4gOiB2ID0+IHJlc29sdmUodikgfSkpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBcbiAgICBvbmVCdXR0b24odGl0bGUsIG9wdGlvbnMpIHtcbiAgICAgICAgLypjb25zb2xlLmxvZyh7IHRpdGxlLCBvcHRpb25zIH0pO1xuICAgICAgICAgY29uc3QgdHlwZW9mdGl0bGUgPSB0eXBlb2YgdGl0bGU7XG4gICAgICAgICBpZiAoIHR5cGVvZnRpdGxlID09PSBcIm9iamVjdFwiICkge1xuICAgICAgICAgaWYgKCBvcHRpb25zICkge1xuICAgICAgICAgaWYgKCBvcHRpb25zLmh0bWwgKSB7XG4gICAgICAgICBvcHRpb25zLmh0bWwgKz0gJzxicj4nO1xuICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgIG9wdGlvbnMuaHRtbCA9ICcnO1xuICAgICAgICAgfVxuICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgIG9wdGlvbnMgPSB7IGh0bWwgOiAnJyB9O1xuICAgICAgICAgfVxuICAgICAgICAgaWYgKCB0aXRsZSBpbnN0YW5jZW9mIEVycm9yICkge1xuICAgICAgICAgdGl0bGUgPSAnQW4gZXJyb3IgaGFzIG9jY3VycmVkJztcbiAgICAgICAgIG9wdGlvbnMuaHRtbCArPSB0aXRsZS5tZXNzYWdlO1xuICAgICAgICAgY29uc29sZS5sb2coeyB0aXRsZSwgb3B0aW9ucyB9KTtcbiAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICBsZXQgaHRtbCA9IGA8c3R5bGU+XG4gICAgICAgICBzcGFuIHtcbiAgICAgICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7XG4gICAgICAgICBtYXJnaW4tbGVmdDogNDBweDtcbiAgICAgICAgIH1cbiAgICAgICAgIDwvc3R5bGU+XG4gICAgICAgICA8ZGl2IHN0eWxlPVwidGV4dC1hbGlnbjogbGVmdFwiPlxuICAgICAgICAgXG4gICAgICAgICBgO1xuICAgICAgICAgZm9yICggbGV0IGtleSBvZiBPYmplY3Qua2V5cyh0aXRsZSkgKSB7XG4gICAgICAgICBodG1sICs9IGA8cD48Yj4ke2tleX06PC9iPiA8c3Bhbj4ke3RpdGxlW2tleV19PC9zcGFuPjwvcD5gXG4gICAgICAgICB9XG4gICAgICAgICBodG1sICs9IGA8L2Rpdj5gO1xuICAgICAgICAgb3B0aW9ucy5odG1sICs9IGh0bWw7XG4gICAgICAgICB0aXRsZSA9ICdTb21ldGhpbmcgaGFwcGVuZWQnO1xuICAgICAgICAgXG4gICAgICAgICB9XG4gICAgICAgICB9IGVsc2UgaWYgKCBBcnJheS5pc0FycmF5KHRpdGxlKSApIHtcbiAgICAgICAgIHRpdGxlID0gJ1RoaXMgaXMgd2VpcmQnO1xuICAgICAgICAgb3B0aW9ucy5odG1sICs9IHRpdGxlLmpvaW4oJzwvYnI+JylcbiAgICAgICAgIH0qL1xuICAgICAgICByZXR1cm4gYmxvY2tpbmdTd2FsTWl4aW4uZmlyZSh7XG4gICAgICAgICAgICB0aXRsZSA6IHRpdGxlIGFzIHN0cmluZyxcbiAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgIGN1c3RvbUNsYXNzIDogJ2FuaW1hdGVkIGZhZGVJbicsXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC4uLm9wdGlvbnNcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBhc3luYyB0d29CdXR0b25zKG9wdGlvbnMpIHtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IGF3YWl0IFN3YWwuZmlyZSh7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b24gOiB0cnVlLFxuICAgICAgICAgICAgY3VzdG9tQ2xhc3MgOiAnYW5pbWF0ZWQgZmFkZUluJyxcbiAgICAgICAgICAgIC4uLm9wdGlvbnNcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdmFsdWUgPyBcImNvbmZpcm1cIiA6IFwic2Vjb25kXCI7XG4gICAgfSxcbiAgICBhc3luYyB0aHJlZUJ1dHRvbnMob3B0aW9ucykge1xuICAgICAgICBcbiAgICAgICAgLy8gY29uc3QgdGhpcmRCdXR0b25UZXh0ID0gb3B0aW9ucy50aGlyZEJ1dHRvblRleHQgPz8gJ092ZXJ3cml0ZSc7XG4gICAgICAgIGxldCB0aGlyZEJ1dHRvbkNzcztcbiAgICAgICAgaWYgKCBvcHRpb25zLnRoaXJkQnV0dG9uVHlwZSA9PT0gXCJ3YXJuaW5nXCIgKSB7XG4gICAgICAgICAgICB0aGlyZEJ1dHRvbkNzcyA9IHsgYmFja2dyb3VuZENvbG9yIDogJyNGRkM2NkQnLCBjb2xvciA6ICdibGFjaycgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZyh7IHRoaXJkQnV0dG9uQ3NzIH0pO1xuICAgICAgICBsZXQgYWN0aW9uOiBDcmVhdGVDb25maXJtVGhpcmQ7XG4gICAgICAgIGNvbnN0IG9uQmVmb3JlT3BlbiA9IChtb2RhbDogSFRNTEVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBlbCA9IGVsZW0oe1xuICAgICAgICAgICAgICAgIGh0bWxFbGVtZW50IDogbW9kYWwsXG4gICAgICAgICAgICAgICAgY2hpbGRyZW4gOiB7IGFjdGlvbnMgOiAnLnN3YWwyLWFjdGlvbnMnIH1cbiAgICAgICAgICAgIH0pIGFzIEJldHRlckhUTUxFbGVtZW50ICYgeyBhY3Rpb25zOiBCZXR0ZXJIVE1MRWxlbWVudCB9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBlbC5hY3Rpb25zLmFwcGVuZChcbiAgICAgICAgICAgICAgICBidXR0b24oeyBjbHMgOiBgc3dhbDItY29uZmlybSBzd2FsMi1zdHlsZWRgLCBodG1sIDogb3B0aW9ucy50aGlyZEJ1dHRvblRleHQgfSlcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC5jc3ModGhpcmRCdXR0b25Dc3MpXG4gICAgICAgICAgICAgICAgICAgIC5jbGljaygoZXY6IE1vdXNlRXZlbnQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbiA9IFwidGhpcmRcIjtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN3YWwuY2xpY2tDb25maXJtKCk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgIH07XG4gICAgICAgIG9wdGlvbnMgPSB7IC4uLm9wdGlvbnMsIG9uQmVmb3JlT3Blbiwgc2hvd0NhbmNlbEJ1dHRvbiA6IHRydWUgfTtcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gYXdhaXQgU3dhbC5maXJlKG9wdGlvbnMpO1xuICAgICAgICBpZiAoIHZhbHVlICkge1xuICAgICAgICAgICAgLy8vIEVpdGhlciB1c2VyIGNsaWNrZWQgQ29uZmlybSAoYWN0aW9uIGlzIHVuZGVmaW5lZCkgb3IgU3dhbC5jbGlja0NvbmZpcm0oKSAoYWN0aW9uIGlzIFwidGhpcmRcIilcbiAgICAgICAgICAgIGlmICggYWN0aW9uID09PSB1bmRlZmluZWQgKSB7XG4gICAgICAgICAgICAgICAgYWN0aW9uID0gXCJjb25maXJtXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb24gPSBcImNhbmNlbFwiO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gYWN0aW9uO1xuICAgIH1cbn07XG4vLyBleHBvcnQgZGVmYXVsdCB7IGFsZXJ0Rm4sIHNtYWxsLCBiaWcsIGNsb3NlIDogU3dhbC5jbG9zZSwgaXNWaXNpYmxlIDogU3dhbC5pc1Zpc2libGUgfTtcbmV4cG9ydCBkZWZhdWx0IHsgc21hbGwsIGJpZywgLi4uU3dhbCB9O1xuIl19