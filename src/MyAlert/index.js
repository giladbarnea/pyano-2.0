"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
console.log('src/MyAlert/index.ts');
const sweetalert2_1 = require("sweetalert2");
const bhe_1 = require("../bhe");
const path = require("path");
const util_1 = require("../util");
const MyFs_1 = require("../MyFs");
const smallMixin = sweetalert2_1.default.mixin({
    animation: false,
    customClass: 'animated fadeIn',
    position: "bottom-start",
    showConfirmButton: false,
    timer: 8000,
    toast: true,
});
const withConfirm = {
    cancelButtonText: "No",
    confirmButtonText: "Yes",
    showCancelButton: true,
    showConfirmButton: true,
    timer: null,
};
const blockingOptions = {
    allowEnterKey: false,
    allowEscapeKey: false,
    allowOutsideClick: false,
    animation: false,
    customClass: 'animated fadeIn',
    showCancelButton: false,
    showCloseButton: false,
    showConfirmButton: false,
    width: "75vw",
};
const threeButtonsOptions = Object.assign(Object.assign({}, blockingOptions), { showConfirmButton: true, showCancelButton: true });
const blockingSwalMixin = sweetalert2_1.default.mixin(blockingOptions);
const small = {
    _question(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'question' }));
    },
    _info(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'info' }));
    },
    _success(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'success' }));
    },
    _error(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'error' }));
    },
    _warning(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { showConfirmButton: true, type: 'warning' }));
    },
    error(title, text) {
        return smallMixin.fire({
            title,
            text,
            type: "error",
        });
    },
    info(title, text = null, showConfirmBtns = false) {
        let infoOptions = {
            title,
            text,
            type: "info",
        };
        if (showConfirmBtns)
            infoOptions = Object.assign(Object.assign({}, infoOptions), withConfirm);
        return smallMixin.fire(infoOptions);
    },
    success(title, text = null, timer = 6000) {
        return smallMixin.fire({
            title,
            text,
            type: "success",
            timer
        });
    },
    warning(title, text = null) {
        let warningOptions = {
            title,
            text,
            showConfirmButton: true,
            timer: null,
            type: "warning"
        };
        return smallMixin.fire(warningOptions);
    },
};
const big = {
    error(options) {
        var _a;
        if (((_a = options) === null || _a === void 0 ? void 0 : _a.html) instanceof Error) {
            const error = options.html;
            const { what, where, cleanstack } = error.toObj();
            console.log({ cleanstack });
            options.html = `${what}<p>${where}</p>`;
        }
        if (LOG) {
            if (options.onOpen) {
                console.warn(`MyAlert.big.error options had 'onOpen' but will be overridden to save screenshots`);
            }
            const dirname = new Date().human();
            options.onOpen = async () => {
                await util_1.wait(500);
                const webContents = remote.getCurrentWebContents();
                const image = await webContents.capturePage();
                const dirnameAbs = path.join(SESSION_PATH_ABS, dirname);
                MyFs_1.default.createIfNotExists(dirnameAbs);
                fs.writeFileSync(path.join(dirnameAbs, 'page.png'), image.toPNG());
                await webContents.savePage(path.join(dirnameAbs, 'screenshot.html'), "HTMLComplete");
            };
            options.html += `<p>Logs and screenshot saved to errors/${path.basename(SESSION_PATH_ABS)}/${dirname}</p>`;
        }
        return blockingSwalMixin.fire(Object.assign({ type: 'error', showConfirmButton: true }, options));
    },
    warning(options) {
        if (options.animation === false)
            options = Object.assign({ customClass: null }, options);
        return blockingSwalMixin.fire(Object.assign(Object.assign(Object.assign({}, withConfirm), { type: 'warning' }), options));
    },
    blocking(options, moreOptions) {
        if (moreOptions && moreOptions.strings && moreOptions.clickFn) {
            let { strings, clickFn } = moreOptions;
            let paragraphs = strings
                .map(s => bhe_1.paragraph({ cls: 'clickable', text: s }))
                .map(pElem => pElem.click(() => clickFn(pElem)));
            options = Object.assign(Object.assign({}, options), { onBeforeOpen(modalElement) {
                    console.log('modalElement:', modalElement);
                    return bhe_1.elem({ id: 'swal2-content' })
                        .append(...paragraphs);
                } });
        }
        else {
            options = Object.assign({ showConfirmButton: true, showCancelButton: true }, options);
        }
        if (options.showConfirmButton || options.showCancelButton || options.onOpen) {
            return sweetalert2_1.default.fire(Object.assign(Object.assign({}, blockingOptions), options));
        }
        else {
            return new Promise(resolve => sweetalert2_1.default.fire(Object.assign(Object.assign(Object.assign({}, blockingOptions), options), { onOpen: v => resolve(v) })));
        }
    },
    oneButton(title, options) {
        return blockingSwalMixin.fire(Object.assign({ title: title, showConfirmButton: true, customClass: 'animated fadeIn' }, options));
    },
    async twoButtons(title, options) {
        const { value } = await sweetalert2_1.default.fire(Object.assign({ title, showCancelButton: true, customClass: 'animated fadeIn' }, options));
        return value ? "confirm" : "cancel";
    },
    async threeButtons(options) {
        let thirdButtonCss;
        if (options.thirdButtonType === "warning") {
            thirdButtonCss = { backgroundColor: '#FFC66D', color: 'black' };
        }
        console.log({ thirdButtonCss });
        let action;
        const onBeforeOpen = (modal) => {
            let el = bhe_1.elem({
                htmlElement: modal,
                children: { actions: '.swal2-actions' }
            });
            el.actions.append(bhe_1.button({ cls: `swal2-confirm swal2-styled`, html: options.thirdButtonText })
                .css(thirdButtonCss)
                .click((ev) => {
                action = "third";
                sweetalert2_1.default.clickConfirm();
            }));
        };
        options = Object.assign(Object.assign({}, options), { onBeforeOpen, showCancelButton: true });
        const { value } = await sweetalert2_1.default.fire(options);
        if (value) {
            if (action === undefined) {
                action = "confirm";
            }
        }
        else {
            action = "cancel";
        }
        return action;
    }
};
exports.default = Object.assign({ small, big }, sweetalert2_1.default);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLHlCQUF5QjtBQUV6QixPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDcEMsNkNBQXdFO0FBQ3hFLGdDQUFvRTtBQUNwRSw2QkFBNkI7QUFDN0Isa0NBQStCO0FBQy9CLGtDQUEwQjtBQUUxQixNQUFNLFVBQVUsR0FBZ0IscUJBQUksQ0FBQyxLQUFLLENBQUM7SUFDdkMsU0FBUyxFQUFHLEtBQUs7SUFDakIsV0FBVyxFQUFHLGlCQUFpQjtJQUMvQixRQUFRLEVBQUcsY0FBYztJQUN6QixpQkFBaUIsRUFBRyxLQUFLO0lBQ3pCLEtBQUssRUFBRyxJQUFJO0lBQ1osS0FBSyxFQUFHLElBQUk7Q0FFZixDQUFDLENBQUM7QUFDSCxNQUFNLFdBQVcsR0FBc0I7SUFDbkMsZ0JBQWdCLEVBQUcsSUFBSTtJQUN2QixpQkFBaUIsRUFBRyxLQUFLO0lBQ3pCLGdCQUFnQixFQUFHLElBQUk7SUFDdkIsaUJBQWlCLEVBQUcsSUFBSTtJQUN4QixLQUFLLEVBQUcsSUFBSTtDQUVmLENBQUM7QUFDRixNQUFNLGVBQWUsR0FBc0I7SUFDdkMsYUFBYSxFQUFHLEtBQUs7SUFDckIsY0FBYyxFQUFHLEtBQUs7SUFDdEIsaUJBQWlCLEVBQUcsS0FBSztJQUN6QixTQUFTLEVBQUcsS0FBSztJQUNqQixXQUFXLEVBQUcsaUJBQWlCO0lBQy9CLGdCQUFnQixFQUFHLEtBQUs7SUFDeEIsZUFBZSxFQUFHLEtBQUs7SUFDdkIsaUJBQWlCLEVBQUcsS0FBSztJQUN6QixLQUFLLEVBQUcsTUFBTTtDQUdqQixDQUFDO0FBQ0YsTUFBTSxtQkFBbUIsbUNBQ2xCLGVBQWUsS0FDbEIsaUJBQWlCLEVBQUcsSUFBSSxFQUN4QixnQkFBZ0IsRUFBRyxJQUFJLEdBQzFCLENBQUM7QUFDRixNQUFNLGlCQUFpQixHQUFHLHFCQUFJLENBQUMsS0FBSyxD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QUUsR0FBRyxFQUFHLDRCQUE0QixFQUFFLElBQUksRUFBRyxPQUFPLENBQUMsZUFBZSxFQUFFLENBQUM7aUJBRXpFLEdBQUcsQ0FBQyxjQUFjLENBQUM7aUJBQ25CLEtBQUssQ0FBQyxDQUFDLEVBQWMsRUFBRSxFQUFFO2dCQUN0QixNQUFNLEdBQUcsT0FBTyxDQUFDO2dCQUNqQixxQkFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3hCLENBQUMsQ0FBQyxDQUNULENBQUE7UUFDTCxDQUFDLENBQUM7UUFDRixPQUFPLG1DQUFRLE9BQU8sS0FBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUcsSUFBSSxHQUFFLENBQUM7UUFDaEUsTUFBTSxFQUFFLEtBQUssRUFBRSxHQUFHLE1BQU0scUJBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0MsSUFBSyxLQUFLLEVBQUc7WUFFVCxJQUFLLE1BQU0sS0FBSyxTQUFTLEVBQUc7Z0JBQ3hCLE1BQU0sR0FBRyxTQUFTLENBQUM7YUFDdEI7U0FDSjthQUFNO1lBQ0gsTUFBTSxHQUFHLFFBQVEsQ0FBQztTQUNyQjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Q0FDSixDQUFDO0FBRUYsa0NBQWlCLEtBQUssRUFBRSxHQUFHLElBQUsscUJBQUksRUFBRyIsInNvdXJjZXNDb250ZW50IjpbIi8qKmltcG9ydCBBbGVydCBmcm9tICdNeUFsZXJ0JyAob3IgYW55IG90aGVyIG5hbWUpKi9cblxuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzXCI7XG5cbmNvbnNvbGUubG9nKCdzcmMvTXlBbGVydC9pbmRleC50cycpO1xuaW1wb3J0IFN3YWwsIHsgU3dlZXRBbGVydFJlc3VsdCwgU3dlZXRBbGVydE9wdGlvbnMgfSBmcm9tICdzd2VldGFsZXJ0Mic7XG5pbXBvcnQgeyBwYXJhZ3JhcGgsIGVsZW0sIEJldHRlckhUTUxFbGVtZW50LCBidXR0b24gfSBmcm9tIFwiLi4vYmhlXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyB3YWl0IH0gZnJvbSBcIi4uL3V0aWxcIjtcbmltcG9ydCBteWZzIGZyb20gJy4uL015RnMnXG5cbmNvbnN0IHNtYWxsTWl4aW46IHR5cGVvZiBTd2FsID0gU3dhbC5taXhpbih7XG4gICAgYW5pbWF0aW9uIDogZmFsc2UsXG4gICAgY3VzdG9tQ2xhc3MgOiAnYW5pbWF0ZWQgZmFkZUluJyxcbiAgICBwb3NpdGlvbiA6IFwiYm90dG9tLXN0YXJ0XCIsXG4gICAgc2hvd0NvbmZpcm1CdXR0b24gOiBmYWxzZSxcbiAgICB0aW1lciA6IDgwMDAsXG4gICAgdG9hc3QgOiB0cnVlLFxuICAgIFxufSk7XG5jb25zdCB3aXRoQ29uZmlybTogU3dlZXRBbGVydE9wdGlvbnMgPSB7XG4gICAgY2FuY2VsQnV0dG9uVGV4dCA6IFwiTm9cIixcbiAgICBjb25maXJtQnV0dG9uVGV4dCA6IFwiWWVzXCIsXG4gICAgc2hvd0NhbmNlbEJ1dHRvbiA6IHRydWUsXG4gICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLFxuICAgIHRpbWVyIDogbnVsbCxcbiAgICBcbn07XG5jb25zdCBibG9ja2luZ09wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zID0ge1xuICAgIGFsbG93RW50ZXJLZXkgOiBmYWxzZSxcbiAgICBhbGxvd0VzY2FwZUtleSA6IGZhbHNlLFxuICAgIGFsbG93T3V0c2lkZUNsaWNrIDogZmFsc2UsXG4gICAgYW5pbWF0aW9uIDogZmFsc2UsXG4gICAgY3VzdG9tQ2xhc3MgOiAnYW5pbWF0ZWQgZmFkZUluJyxcbiAgICBzaG93Q2FuY2VsQnV0dG9uIDogZmFsc2UsIC8vIGRlZmF1bHQgZmFsc2VcbiAgICBzaG93Q2xvc2VCdXR0b24gOiBmYWxzZSwgLy8gZGVmYXVsdCBmYWxzZVxuICAgIHNob3dDb25maXJtQnV0dG9uIDogZmFsc2UsXG4gICAgd2lkdGggOiBcIjc1dndcIixcbiAgICBcbiAgICBcbn07XG5jb25zdCB0aHJlZUJ1dHRvbnNPcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyA9IHtcbiAgICAuLi5ibG9ja2luZ09wdGlvbnMsXG4gICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLFxuICAgIHNob3dDYW5jZWxCdXR0b24gOiB0cnVlLFxufTtcbmNvbnN0IGJsb2NraW5nU3dhbE1peGluID0gU3dhbC5taXhpbihibG9ja2luZ09wdGlvbnMpO1xudHlwZSBTbWFsbCA9IHtcbiAgICBfZXJyb3Iob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIF9pbmZvKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBfcXVlc3Rpb24ob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIF9zdWNjZXNzKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBfd2FybmluZyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgZXJyb3IodGl0bGU6IHN0cmluZywgdGV4dDogc3RyaW5nKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBpbmZvKHRpdGxlOiBzdHJpbmcsIHRleHQ/OiAoc3RyaW5nIHwgbnVsbCksIHNob3dDb25maXJtQnRucz86IGJvb2xlYW4pOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIHN1Y2Nlc3ModGl0bGU6IHN0cmluZywgdGV4dD86IChzdHJpbmcgfCBudWxsKSwgdGltZXI/OiBudW1iZXIpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIHdhcm5pbmcodGl0bGU6IHN0cmluZywgdGV4dD86IChzdHJpbmcgfCBudWxsKSwgc2hvd0NvbmZpcm1CdG5zPzogYm9vbGVhbik6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG59XG5cbmNvbnN0IHNtYWxsOiBTbWFsbCA9IHtcbiAgICBfcXVlc3Rpb24ob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHsgLi4ub3B0aW9ucywgdHlwZSA6ICdxdWVzdGlvbicgfSlcbiAgICB9LFxuICAgIF9pbmZvKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh7IC4uLm9wdGlvbnMsIHR5cGUgOiAnaW5mbycgfSlcbiAgICB9LFxuICAgIF9zdWNjZXNzKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh7IC4uLm9wdGlvbnMsIHR5cGUgOiAnc3VjY2VzcycgfSlcbiAgICB9LFxuICAgIF9lcnJvcihvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoeyAuLi5vcHRpb25zLCB0eXBlIDogJ2Vycm9yJyB9KVxuICAgIH0sXG4gICAgX3dhcm5pbmcob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHtcbiAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbiA6IHRydWUsIHR5cGUgOiAnd2FybmluZydcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIGVycm9yKHRpdGxlLCB0ZXh0KSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoe1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgdHlwZSA6IFwiZXJyb3JcIixcbiAgICAgICAgICAgIFxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGluZm8odGl0bGUsIHRleHQgPSBudWxsLCBzaG93Q29uZmlybUJ0bnMgPSBmYWxzZSkge1xuICAgICAgICBsZXQgaW5mb09wdGlvbnMgPSB7XG4gICAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICB0eXBlIDogXCJpbmZvXCIsXG4gICAgICAgIH07XG4gICAgICAgIGlmICggc2hvd0NvbmZpcm1CdG5zIClcbiAgICAgICAgICAgIGluZm9PcHRpb25zID0geyAuLi5pbmZvT3B0aW9ucywgLi4ud2l0aENvbmZpcm0gfTtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKGluZm9PcHRpb25zKTtcbiAgICB9LFxuICAgIHN1Y2Nlc3ModGl0bGUsIHRleHQgPSBudWxsLCB0aW1lciA9IDYwMDApIHtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoe1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgdHlwZSA6IFwic3VjY2Vzc1wiLFxuICAgICAgICAgICAgdGltZXJcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIHdhcm5pbmcodGl0bGUsIHRleHQgPSBudWxsKSB7XG4gICAgICAgIGxldCB3YXJuaW5nT3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgIHRpbWVyIDogbnVsbCxcbiAgICAgICAgICAgIHR5cGUgOiBcIndhcm5pbmdcIlxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHdhcm5pbmdPcHRpb25zKTtcbiAgICB9LFxuICAgIFxufTtcbmV4cG9ydCB0eXBlIENyZWF0ZUNvbmZpcm1DYW5jZWwgPSBcImNvbmZpcm1cIiB8IFwiY2FuY2VsXCIgfCBcInRoaXJkXCI7XG50eXBlIEJpZyA9IHtcbiAgICBcbiAgICBlcnJvcihvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyAmIHsgaHRtbDogc3RyaW5nIHwgRXJyb3IgfSk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgd2FybmluZyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgYmxvY2tpbmcob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMsIG1vcmVPcHRpb25zPzogeyBzdHJpbmdzOiBzdHJpbmdbXSwgY2xpY2tGbjogKGJoZTogQmV0dGVySFRNTEVsZW1lbnQpID0+IGFueSB9KTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBvbmVCdXR0b24odGl0bGU6IHN0cmluZywgb3B0aW9ucz86IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICB0d29CdXR0b25zKHRpdGxlOiBzdHJpbmcsIG9wdGlvbnM/OiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8XCJjb25maXJtXCIgfCBcImNhbmNlbFwiPlxuICAgIHRocmVlQnV0dG9ucyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyAmIHsgdGhpcmRCdXR0b25UZXh0OiBzdHJpbmcsIHRoaXJkQnV0dG9uVHlwZT86IFwiY29uZmlybVwiIHwgXCJ3YXJuaW5nXCIgfSk6IFByb21pc2U8Q3JlYXRlQ29uZmlybUNhbmNlbD5cbn1cblxuY29uc3QgYmlnOiBCaWcgPSB7XG4gICAgZXJyb3Iob3B0aW9ucykge1xuICAgICAgICBcbiAgICAgICAgaWYgKCBvcHRpb25zPy5odG1sIGluc3RhbmNlb2YgRXJyb3IgKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IG9wdGlvbnMuaHRtbDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCB7IHdoYXQsIHdoZXJlLCBjbGVhbnN0YWNrIH0gPSBlcnJvci50b09iaigpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coeyBjbGVhbnN0YWNrIH0pO1xuICAgICAgICAgICAgb3B0aW9ucy5odG1sID0gYCR7d2hhdH08cD4ke3doZXJlfTwvcD5gXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCBMT0cgKSB7XG4gICAgICAgICAgICBpZiAoIG9wdGlvbnMub25PcGVuICkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgTXlBbGVydC5iaWcuZXJyb3Igb3B0aW9ucyBoYWQgJ29uT3BlbicgYnV0IHdpbGwgYmUgb3ZlcnJpZGRlbiB0byBzYXZlIHNjcmVlbnNob3RzYCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBkaXJuYW1lID0gbmV3IERhdGUoKS5odW1hbigpO1xuICAgICAgICAgICAgb3B0aW9ucy5vbk9wZW4gPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXdhaXQgd2FpdCg1MDApO1xuICAgICAgICAgICAgICAgIGNvbnN0IHdlYkNvbnRlbnRzID0gcmVtb3RlLmdldEN1cnJlbnRXZWJDb250ZW50cygpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGltYWdlID0gYXdhaXQgd2ViQ29udGVudHMuY2FwdHVyZVBhZ2UoKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zdCBkaXJuYW1lQWJzID0gcGF0aC5qb2luKFNFU1NJT05fUEFUSF9BQlMsIGRpcm5hbWUpO1xuICAgICAgICAgICAgICAgIG15ZnMuY3JlYXRlSWZOb3RFeGlzdHMoZGlybmFtZUFicyk7XG4gICAgICAgICAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwYXRoLmpvaW4oZGlybmFtZUFicywgJ3BhZ2UucG5nJyksIGltYWdlLnRvUE5HKCkpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGF3YWl0IHdlYkNvbnRlbnRzLnNhdmVQYWdlKHBhdGguam9pbihkaXJuYW1lQWJzLCAnc2NyZWVuc2hvdC5odG1sJyksIFwiSFRNTENvbXBsZXRlXCIpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG9wdGlvbnMuaHRtbCArPSBgPHA+TG9ncyBhbmQgc2NyZWVuc2hvdCBzYXZlZCB0byBlcnJvcnMvJHtwYXRoLmJhc2VuYW1lKFNFU1NJT05fUEFUSF9BQlMpfS8ke2Rpcm5hbWV9PC9wPmBcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBibG9ja2luZ1N3YWxNaXhpbi5maXJlKHtcbiAgICAgICAgICAgIHR5cGUgOiAnZXJyb3InLFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLFxuICAgICAgICAgICAgLy8gY29uZmlybUJ1dHRvblRleHQgOiAnUmVtZW1iZXIgdG8gdGFrZSBhIHNjcmVlbnNob3QgYmVmb3JlIHByZXNzaW5nIHRoaXMnLFxuICAgICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9KTtcbiAgICB9LFxuICAgIHdhcm5pbmcob3B0aW9ucykge1xuICAgICAgICBpZiAoIG9wdGlvbnMuYW5pbWF0aW9uID09PSBmYWxzZSApXG4gICAgICAgICAgICBvcHRpb25zID0geyBjdXN0b21DbGFzcyA6IG51bGwsIC4uLm9wdGlvbnMgfTtcbiAgICAgICAgcmV0dXJuIGJsb2NraW5nU3dhbE1peGluLmZpcmUoeyAuLi53aXRoQ29uZmlybSwgdHlwZSA6ICd3YXJuaW5nJywgLi4ub3B0aW9ucyB9KTtcbiAgICB9LFxuICAgIFxuICAgIGJsb2NraW5nKG9wdGlvbnMsIG1vcmVPcHRpb25zKSB7XG4gICAgICAgIFxuICAgICAgICBpZiAoIG1vcmVPcHRpb25zICYmIG1vcmVPcHRpb25zLnN0cmluZ3MgJiYgbW9yZU9wdGlvbnMuY2xpY2tGbiApIHtcbiAgICAgICAgICAgIGxldCB7IHN0cmluZ3MsIGNsaWNrRm4gfSA9IG1vcmVPcHRpb25zO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgcGFyYWdyYXBocyA9IHN0cmluZ3NcbiAgICAgICAgICAgICAgICAvLyAubWFwKHMgPT4gJChgPHAgY2xhc3M9XCJjbGlja2FibGVcIj4ke3N9PC9wPmApKVxuICAgICAgICAgICAgICAgIC5tYXAocyA9PiBwYXJhZ3JhcGgoeyBjbHMgOiAnY2xpY2thYmxlJywgdGV4dCA6IHMgfSkpXG4gICAgICAgICAgICAgICAgLm1hcChwRWxlbSA9PiBwRWxlbS5jbGljaygoKSA9PiBjbGlja0ZuKHBFbGVtKSkpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICAgICAgb25CZWZvcmVPcGVuKG1vZGFsRWxlbWVudDogSFRNTEVsZW1lbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ21vZGFsRWxlbWVudDonLCBtb2RhbEVsZW1lbnQpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxlbSh7IGlkIDogJ3N3YWwyLWNvbnRlbnQnIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAuc2hvdygpXG4gICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKC4uLnBhcmFncmFwaHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7IC8vIGZvcmNlIGNvbmZpcm0gYW5kIGNhbmNlbCBidXR0b25zXG4gICAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIG9wdGlvbnMuc2hvd0NvbmZpcm1CdXR0b24gfHwgb3B0aW9ucy5zaG93Q2FuY2VsQnV0dG9uIHx8IG9wdGlvbnMub25PcGVuICkge1xuICAgICAgICAgICAgLy8gLyBIYXBwZW5zIHdoZW4gbm90IG9yIGJhZCBtb3JlT3B0aW9uc1xuICAgICAgICAgICAgcmV0dXJuIFN3YWwuZmlyZSh7IC4uLmJsb2NraW5nT3B0aW9ucywgLi4ub3B0aW9ucyB9KTtcbiAgICAgICAgfSBlbHNlIHsgLy8gVE9ETzogb25PcGVuIDogcmVzb2x2ZT9cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gU3dhbC5maXJlKHsgLi4uYmxvY2tpbmdPcHRpb25zLCAuLi5vcHRpb25zLCBvbk9wZW4gOiB2ID0+IHJlc29sdmUodikgfSkpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBcbiAgICBvbmVCdXR0b24odGl0bGUsIG9wdGlvbnMpIHtcbiAgICAgICAgLypjb25zb2xlLmxvZyh7IHRpdGxlLCBvcHRpb25zIH0pO1xuICAgICAgICAgY29uc3QgdHlwZW9mdGl0bGUgPSB0eXBlb2YgdGl0bGU7XG4gICAgICAgICBpZiAoIHR5cGVvZnRpdGxlID09PSBcIm9iamVjdFwiICkge1xuICAgICAgICAgaWYgKCBvcHRpb25zICkge1xuICAgICAgICAgaWYgKCBvcHRpb25zLmh0bWwgKSB7XG4gICAgICAgICBvcHRpb25zLmh0bWwgKz0gJzxicj4nO1xuICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgIG9wdGlvbnMuaHRtbCA9ICcnO1xuICAgICAgICAgfVxuICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgIG9wdGlvbnMgPSB7IGh0bWwgOiAnJyB9O1xuICAgICAgICAgfVxuICAgICAgICAgaWYgKCB0aXRsZSBpbnN0YW5jZW9mIEVycm9yICkge1xuICAgICAgICAgdGl0bGUgPSAnQW4gZXJyb3IgaGFzIG9jY3VycmVkJztcbiAgICAgICAgIG9wdGlvbnMuaHRtbCArPSB0aXRsZS5tZXNzYWdlO1xuICAgICAgICAgY29uc29sZS5sb2coeyB0aXRsZSwgb3B0aW9ucyB9KTtcbiAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICBsZXQgaHRtbCA9IGA8c3R5bGU+XG4gICAgICAgICBzcGFuIHtcbiAgICAgICAgIGZvbnQtZmFtaWx5OiBtb25vc3BhY2U7XG4gICAgICAgICBtYXJnaW4tbGVmdDogNDBweDtcbiAgICAgICAgIH1cbiAgICAgICAgIDwvc3R5bGU+XG4gICAgICAgICA8ZGl2IHN0eWxlPVwidGV4dC1hbGlnbjogbGVmdFwiPlxuICAgICAgICAgXG4gICAgICAgICBgO1xuICAgICAgICAgZm9yICggbGV0IGtleSBvZiBPYmplY3Qua2V5cyh0aXRsZSkgKSB7XG4gICAgICAgICBodG1sICs9IGA8cD48Yj4ke2tleX06PC9iPiA8c3Bhbj4ke3RpdGxlW2tleV19PC9zcGFuPjwvcD5gXG4gICAgICAgICB9XG4gICAgICAgICBodG1sICs9IGA8L2Rpdj5gO1xuICAgICAgICAgb3B0aW9ucy5odG1sICs9IGh0bWw7XG4gICAgICAgICB0aXRsZSA9ICdTb21ldGhpbmcgaGFwcGVuZWQnO1xuICAgICAgICAgXG4gICAgICAgICB9XG4gICAgICAgICB9IGVsc2UgaWYgKCBBcnJheS5pc0FycmF5KHRpdGxlKSApIHtcbiAgICAgICAgIHRpdGxlID0gJ1RoaXMgaXMgd2VpcmQnO1xuICAgICAgICAgb3B0aW9ucy5odG1sICs9IHRpdGxlLmpvaW4oJzwvYnI+JylcbiAgICAgICAgIH0qL1xuICAgICAgICByZXR1cm4gYmxvY2tpbmdTd2FsTWl4aW4uZmlyZSh7XG4gICAgICAgICAgICB0aXRsZSA6IHRpdGxlIGFzIHN0cmluZyxcbiAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgIGN1c3RvbUNsYXNzIDogJ2FuaW1hdGVkIGZhZGVJbicsXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC4uLm9wdGlvbnNcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBhc3luYyB0d29CdXR0b25zKHRpdGxlLCBvcHRpb25zKSB7XG4gICAgICAgIFxuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBTd2FsLmZpcmUoe1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uIDogdHJ1ZSxcbiAgICAgICAgICAgIGN1c3RvbUNsYXNzIDogJ2FuaW1hdGVkIGZhZGVJbicsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHZhbHVlID8gXCJjb25maXJtXCIgOiBcImNhbmNlbFwiO1xuICAgIH0sXG4gICAgYXN5bmMgdGhyZWVCdXR0b25zKG9wdGlvbnMpIHtcbiAgICAgICAgXG4gICAgICAgIC8vIGNvbnN0IHRoaXJkQnV0dG9uVGV4dCA9IG9wdGlvbnMudGhpcmRCdXR0b25UZXh0ID8/ICdPdmVyd3JpdGUnO1xuICAgICAgICBsZXQgdGhpcmRCdXR0b25Dc3M7XG4gICAgICAgIGlmICggb3B0aW9ucy50aGlyZEJ1dHRvblR5cGUgPT09IFwid2FybmluZ1wiICkge1xuICAgICAgICAgICAgdGhpcmRCdXR0b25Dc3MgPSB7IGJhY2tncm91bmRDb2xvciA6ICcjRkZDNjZEJywgY29sb3IgOiAnYmxhY2snIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2coeyB0aGlyZEJ1dHRvbkNzcyB9KTtcbiAgICAgICAgbGV0IGFjdGlvbjogQ3JlYXRlQ29uZmlybUNhbmNlbDtcbiAgICAgICAgY29uc3Qgb25CZWZvcmVPcGVuID0gKG1vZGFsOiBIVE1MRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGVsID0gZWxlbSh7XG4gICAgICAgICAgICAgICAgaHRtbEVsZW1lbnQgOiBtb2RhbCxcbiAgICAgICAgICAgICAgICBjaGlsZHJlbiA6IHsgYWN0aW9ucyA6ICcuc3dhbDItYWN0aW9ucycgfVxuICAgICAgICAgICAgfSkgYXMgQmV0dGVySFRNTEVsZW1lbnQgJiB7IGFjdGlvbnM6IEJldHRlckhUTUxFbGVtZW50IH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGVsLmFjdGlvbnMuYXBwZW5kKFxuICAgICAgICAgICAgICAgIGJ1dHRvbih7IGNscyA6IGBzd2FsMi1jb25maXJtIHN3YWwyLXN0eWxlZGAsIGh0bWwgOiBvcHRpb25zLnRoaXJkQnV0dG9uVGV4dCB9KVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLmNzcyh0aGlyZEJ1dHRvbkNzcylcbiAgICAgICAgICAgICAgICAgICAgLmNsaWNrKChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gXCJ0aGlyZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgU3dhbC5jbGlja0NvbmZpcm0oKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgfTtcbiAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgb25CZWZvcmVPcGVuLCBzaG93Q2FuY2VsQnV0dG9uIDogdHJ1ZSB9O1xuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBTd2FsLmZpcmUob3B0aW9ucyk7XG4gICAgICAgIGlmICggdmFsdWUgKSB7XG4gICAgICAgICAgICAvLy8gRWl0aGVyIHVzZXIgY2xpY2tlZCBDb25maXJtIChhY3Rpb24gaXMgdW5kZWZpbmVkKSBvciBTd2FsLmNsaWNrQ29uZmlybSgpIChhY3Rpb24gaXMgXCJ0aGlyZFwiKVxuICAgICAgICAgICAgaWYgKCBhY3Rpb24gPT09IHVuZGVmaW5lZCApIHtcbiAgICAgICAgICAgICAgICBhY3Rpb24gPSBcImNvbmZpcm1cIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFjdGlvbiA9IFwiY2FuY2VsXCI7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBhY3Rpb247XG4gICAgfVxufTtcbi8vIGV4cG9ydCBkZWZhdWx0IHsgYWxlcnRGbiwgc21hbGwsIGJpZywgY2xvc2UgOiBTd2FsLmNsb3NlLCBpc1Zpc2libGUgOiBTd2FsLmlzVmlzaWJsZSB9O1xuZXhwb3J0IGRlZmF1bHQgeyBzbWFsbCwgYmlnLCAuLi5Td2FsIH07XG4iXX0=