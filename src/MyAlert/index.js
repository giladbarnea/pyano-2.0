"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
console.log('src/MyAlert/index.ts');
const sweetalert2_1 = require("sweetalert2");
const bhe_1 = require("../bhe");
const path = require("path");
const util_1 = require("../util");
const smallMixin = sweetalert2_1.default.mixin({
    animation: false,
    customClass: 'animated fadeIn',
    position: "bottom-start",
    showConfirmButton: false,
    timer: 8000,
    toast: true,
});
const withConfirm = {
    cancelButtonText: "No",
    confirmButtonText: "Yes",
    showCancelButton: true,
    showConfirmButton: true,
    timer: null,
};
const blockingOptions = {
    allowEnterKey: false,
    allowEscapeKey: false,
    allowOutsideClick: false,
    animation: false,
    customClass: 'animated fadeIn',
    showCancelButton: false,
    showCloseButton: false,
    showConfirmButton: false,
    width: "75vw",
};
const threeButtonsOptions = Object.assign(Object.assign({}, blockingOptions), { showConfirmButton: true, showCancelButton: true });
const blockingSwalMixin = sweetalert2_1.default.mixin(blockingOptions);
const small = {
    _question(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'question' }));
    },
    _info(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'info' }));
    },
    _success(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'success' }));
    },
    _error(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'error' }));
    },
    _warning(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { showConfirmButton: true, type: 'warning' }));
    },
    error(title, text) {
        return smallMixin.fire({
            title,
            text,
            type: "error",
        });
    },
    info(title, text = null, showConfirmBtns = false) {
        let infoOptions = {
            title,
            text,
            type: "info",
        };
        if (showConfirmBtns)
            infoOptions = Object.assign(Object.assign({}, infoOptions), withConfirm);
        return smallMixin.fire(infoOptions);
    },
    success(title, text = null, timer = 6000) {
        return smallMixin.fire({
            title,
            text,
            type: "success",
            timer
        });
    },
    warning(title, text = null) {
        let warningOptions = {
            title,
            text,
            showConfirmButton: true,
            timer: null,
            type: "warning"
        };
        return smallMixin.fire(warningOptions);
    },
};
const big = {
    async error(options) {
        var _a;
        if (((_a = options) === null || _a === void 0 ? void 0 : _a.html) instanceof Error) {
            const error = options.html;
            const { what, where, cleanstack } = error.toObj();
            console.log({ cleanstack });
            options.html = `${what}<p>${where}</p>`;
        }
        const dirname = new Date().human();
        if (LOG) {
            options.onOpen = async () => {
                await util_1.wait(500);
                await util_1.takeScreenshot(dirname);
            };
            options.html += `<p>Logs and screenshot saved to errors/${path.basename(SESSION_PATH_ABS)}/${dirname}</p>`;
        }
        else {
            const { default: Glob } = require('../Glob');
            if (Glob.BigConfig.get('dev')) {
                options.onAfterClose = async () => {
                    await util_1.wait(500);
                    await util_1.takeScreenshot(dirname);
                };
            }
        }
        return blockingSwalMixin.fire(Object.assign({ type: 'error', showConfirmButton: true }, options));
    },
    warning(options) {
        if (options.animation === false)
            options = Object.assign({ customClass: null }, options);
        return blockingSwalMixin.fire(Object.assign(Object.assign(Object.assign({}, withConfirm), { type: 'warning' }), options));
    },
    blocking(options, moreOptions) {
        if (moreOptions && moreOptions.strings && moreOptions.clickFn) {
            let { strings, clickFn } = moreOptions;
            let paragraphs = strings
                .map(s => bhe_1.paragraph({ cls: 'clickable', text: s }))
                .map(pElem => pElem.click(() => clickFn(pElem)));
            options = Object.assign(Object.assign({}, options), { onBeforeOpen(modalElement) {
                    console.log('modalElement:', modalElement);
                    return bhe_1.elem({ id: 'swal2-content' })
                        .append(...paragraphs);
                } });
        }
        else {
            options = Object.assign({ showConfirmButton: true, showCancelButton: true }, options);
        }
        if (options.showConfirmButton || options.showCancelButton || options.onOpen) {
            return sweetalert2_1.default.fire(Object.assign(Object.assign({}, blockingOptions), options));
        }
        else {
            return new Promise(resolve => sweetalert2_1.default.fire(Object.assign(Object.assign(Object.assign({}, blockingOptions), options), { onOpen: v => resolve(v) })));
        }
    },
    oneButton(title, options) {
        return blockingSwalMixin.fire(Object.assign({ title: title, showConfirmButton: true, customClass: 'animated fadeIn' }, options));
    },
    async twoButtons(options) {
        const { value } = await sweetalert2_1.default.fire(Object.assign({ showCancelButton: true, customClass: 'animated fadeIn' }, options));
        return value ? "confirm" : "second";
    },
    async threeButtons(options) {
        let thirdButtonCss;
        if (options.thirdButtonType === "warning") {
            thirdButtonCss = { backgroundColor: '#FFC66D', color: 'black' };
        }
        console.log({ thirdButtonCss });
        let action;
        const onBeforeOpen = (modal) => {
            let el = bhe_1.elem({
                htmlElement: modal,
                children: { actions: '.swal2-actions' }
            });
            el.actions.append(bhe_1.button({ cls: `swal2-confirm swal2-styled`, html: options.thirdButtonText })
                .css(thirdButtonCss)
                .click((ev) => {
                action = "third";
                sweetalert2_1.default.clickConfirm();
            }));
        };
        options = Object.assign(Object.assign({}, options), { onBeforeOpen, showCancelButton: true });
        const { value } = await sweetalert2_1.default.fire(options);
        if (value) {
            if (action === undefined) {
                action = "confirm";
            }
        }
        else {
            action = "cancel";
        }
        return action;
    }
};
exports.default = Object.assign({ small, big }, sweetalert2_1.default);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNwQyw2Q0FBd0U7QUFDeEUsZ0NBQW9FO0FBQ3BFLDZCQUE2QjtBQUM3QixrQ0FBK0M7QUFFL0MsTUFBTSxVQUFVLEdBQWdCLHFCQUFJLENBQUMsS0FBSyxDQUFDO0lBQ3ZDLFNBQVMsRUFBRyxLQUFLO0lBQ2pCLFdBQVcsRUFBRyxpQkFBaUI7SUFDL0IsUUFBUSxFQUFHLGNBQWM7SUFDekIsaUJBQWlCLEVBQUcsS0FBSztJQUN6QixLQUFLLEVBQUcsSUFBSTtJQUNaLEtBQUssRUFBRyxJQUFJO0NBRWYsQ0FBQyxDQUFDO0FBQ0gsTUFBTSxXQUFXLEdBQXNCO0lBQ25DLGdCQUFnQixFQUFHLElBQUk7SUFDdkIsaUJBQWlCLEVBQUcsS0FBSztJQUN6QixnQkFBZ0IsRUFBRyxJQUFJO0lBQ3ZCLGlCQUFpQixFQUFHLElBQUk7SUFDeEIsS0FBSyxFQUFHLElBQUk7Q0FFZixDQUFDO0FBQ0YsTUFBTSxlQUFlLEdBQXNCO0lBQ3ZDLGFBQWEsRUFBRyxLQUFLO0lBQ3JCLGNBQWMsRUFBRyxLQUFLO0lBQ3RCLGlCQUFpQixFQUFHLEtBQUs7SUFDekIsU0FBUyxFQUFHLEtBQUs7SUFDakIsV0FBVyxFQUFHLGlCQUFpQjtJQUMvQixnQkFBZ0IsRUFBRyxLQUFLO0lBQ3hCLGVBQWUsRUFBRyxLQUFLO0lBQ3ZCLGlCQUFpQixFQUFHLEtBQUs7SUFDekIsS0FBSyxFQUFHLE1BQU07Q0FHakIsQ0FBQztBQUNGLE1BQU0sbUJBQW1CLG1DQUNsQixlQUFlLEtBQ2xCLGlCQUFpQixFQUFHLElBQUksRUFDeEIsZ0JBQWdCLEVBQUcsSUFBSSxHQUMxQixDQUFDO0FBQ0YsTUFBTSxpQkFBaUIsR0FBRyxxQkFBSSxDQUFDLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztBQWF0RCxN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QyxDQUFDO1FBQ0YsT0FBTyxtQ0FBUSxPQUFPLEtBQUUsWUFBWSxFQUFFLGdCQUFnQixFQUFHLElBQUksR0FBRSxDQUFDO1FBQ2hFLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxNQUFNLHFCQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNDLElBQUssS0FBSyxFQUFHO1lBRVQsSUFBSyxNQUFNLEtBQUssU0FBUyxFQUFHO2dCQUN4QixNQUFNLEdBQUcsU0FBUyxDQUFDO2FBQ3RCO1NBQ0o7YUFBTTtZQUNILE1BQU0sR0FBRyxRQUFRLENBQUM7U0FDckI7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0NBQ0osQ0FBQztBQUVGLGtDQUFpQixLQUFLLEVBQUUsR0FBRyxJQUFLLHFCQUFJLEVBQUciLCJzb3VyY2VzQ29udGVudCI6WyIvKippbXBvcnQgQWxlcnQgZnJvbSAnTXlBbGVydCcgKG9yIGFueSBvdGhlciBuYW1lKSovXG5cblxuY29uc29sZS5sb2coJ3NyYy9NeUFsZXJ0L2luZGV4LnRzJyk7XG5pbXBvcnQgU3dhbCwgeyBTd2VldEFsZXJ0UmVzdWx0LCBTd2VldEFsZXJ0T3B0aW9ucyB9IGZyb20gJ3N3ZWV0YWxlcnQyJztcbmltcG9ydCB7IHBhcmFncmFwaCwgZWxlbSwgQmV0dGVySFRNTEVsZW1lbnQsIGJ1dHRvbiB9IGZyb20gXCIuLi9iaGVcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IHdhaXQsIHRha2VTY3JlZW5zaG90IH0gZnJvbSBcIi4uL3V0aWxcIjtcblxuY29uc3Qgc21hbGxNaXhpbjogdHlwZW9mIFN3YWwgPSBTd2FsLm1peGluKHtcbiAgICBhbmltYXRpb24gOiBmYWxzZSxcbiAgICBjdXN0b21DbGFzcyA6ICdhbmltYXRlZCBmYWRlSW4nLFxuICAgIHBvc2l0aW9uIDogXCJib3R0b20tc3RhcnRcIixcbiAgICBzaG93Q29uZmlybUJ1dHRvbiA6IGZhbHNlLFxuICAgIHRpbWVyIDogODAwMCxcbiAgICB0b2FzdCA6IHRydWUsXG4gICAgXG59KTtcbmNvbnN0IHdpdGhDb25maXJtOiBTd2VldEFsZXJ0T3B0aW9ucyA9IHtcbiAgICBjYW5jZWxCdXR0b25UZXh0IDogXCJOb1wiLFxuICAgIGNvbmZpcm1CdXR0b25UZXh0IDogXCJZZXNcIixcbiAgICBzaG93Q2FuY2VsQnV0dG9uIDogdHJ1ZSxcbiAgICBzaG93Q29uZmlybUJ1dHRvbiA6IHRydWUsXG4gICAgdGltZXIgOiBudWxsLFxuICAgIFxufTtcbmNvbnN0IGJsb2NraW5nT3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMgPSB7XG4gICAgYWxsb3dFbnRlcktleSA6IGZhbHNlLFxuICAgIGFsbG93RXNjYXBlS2V5IDogZmFsc2UsXG4gICAgYWxsb3dPdXRzaWRlQ2xpY2sgOiBmYWxzZSxcbiAgICBhbmltYXRpb24gOiBmYWxzZSxcbiAgICBjdXN0b21DbGFzcyA6ICdhbmltYXRlZCBmYWRlSW4nLFxuICAgIHNob3dDYW5jZWxCdXR0b24gOiBmYWxzZSwgLy8gZGVmYXVsdCBmYWxzZVxuICAgIHNob3dDbG9zZUJ1dHRvbiA6IGZhbHNlLCAvLyBkZWZhdWx0IGZhbHNlXG4gICAgc2hvd0NvbmZpcm1CdXR0b24gOiBmYWxzZSxcbiAgICB3aWR0aCA6IFwiNzV2d1wiLFxuICAgIFxuICAgIFxufTtcbmNvbnN0IHRocmVlQnV0dG9uc09wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zID0ge1xuICAgIC4uLmJsb2NraW5nT3B0aW9ucyxcbiAgICBzaG93Q29uZmlybUJ1dHRvbiA6IHRydWUsXG4gICAgc2hvd0NhbmNlbEJ1dHRvbiA6IHRydWUsXG59O1xuY29uc3QgYmxvY2tpbmdTd2FsTWl4aW4gPSBTd2FsLm1peGluKGJsb2NraW5nT3B0aW9ucyk7XG50eXBlIFNtYWxsID0ge1xuICAgIF9lcnJvcihvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgX2luZm8ob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIF9xdWVzdGlvbihvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgX3N1Y2Nlc3Mob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIF93YXJuaW5nKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBlcnJvcih0aXRsZTogc3RyaW5nLCB0ZXh0OiBzdHJpbmcpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIGluZm8odGl0bGU6IHN0cmluZywgdGV4dD86IChzdHJpbmcgfCBudWxsKSwgc2hvd0NvbmZpcm1CdG5zPzogYm9vbGVhbik6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgc3VjY2Vzcyh0aXRsZTogc3RyaW5nLCB0ZXh0PzogKHN0cmluZyB8IG51bGwpLCB0aW1lcj86IG51bWJlcik6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgd2FybmluZyh0aXRsZTogc3RyaW5nLCB0ZXh0PzogKHN0cmluZyB8IG51bGwpLCBzaG93Q29uZmlybUJ0bnM/OiBib29sZWFuKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0Pixcbn1cblxuY29uc3Qgc21hbGw6IFNtYWxsID0ge1xuICAgIF9xdWVzdGlvbihvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoeyAuLi5vcHRpb25zLCB0eXBlIDogJ3F1ZXN0aW9uJyB9KVxuICAgIH0sXG4gICAgX2luZm8ob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHsgLi4ub3B0aW9ucywgdHlwZSA6ICdpbmZvJyB9KVxuICAgIH0sXG4gICAgX3N1Y2Nlc3Mob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHsgLi4ub3B0aW9ucywgdHlwZSA6ICdzdWNjZXNzJyB9KVxuICAgIH0sXG4gICAgX2Vycm9yKG9wdGlvbnMpIHtcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh7IC4uLm9wdGlvbnMsIHR5cGUgOiAnZXJyb3InIH0pXG4gICAgfSxcbiAgICBfd2FybmluZyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoe1xuICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uIDogdHJ1ZSwgdHlwZSA6ICd3YXJuaW5nJ1xuICAgICAgICB9KVxuICAgIH0sXG4gICAgZXJyb3IodGl0bGUsIHRleHQpIHtcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh7XG4gICAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICB0eXBlIDogXCJlcnJvclwiLFxuICAgICAgICAgICAgXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgaW5mbyh0aXRsZSwgdGV4dCA9IG51bGwsIHNob3dDb25maXJtQnRucyA9IGZhbHNlKSB7XG4gICAgICAgIGxldCBpbmZvT3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgICAgIHR5cGUgOiBcImluZm9cIixcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKCBzaG93Q29uZmlybUJ0bnMgKVxuICAgICAgICAgICAgaW5mb09wdGlvbnMgPSB7IC4uLmluZm9PcHRpb25zLCAuLi53aXRoQ29uZmlybSB9O1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoaW5mb09wdGlvbnMpO1xuICAgIH0sXG4gICAgc3VjY2Vzcyh0aXRsZSwgdGV4dCA9IG51bGwsIHRpbWVyID0gNjAwMCkge1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHNtYWxsTWl4aW4uZmlyZSh7XG4gICAgICAgICAgICB0aXRsZSxcbiAgICAgICAgICAgIHRleHQsXG4gICAgICAgICAgICB0eXBlIDogXCJzdWNjZXNzXCIsXG4gICAgICAgICAgICB0aW1lclxuICAgICAgICB9KVxuICAgIH0sXG4gICAgd2FybmluZyh0aXRsZSwgdGV4dCA9IG51bGwpIHtcbiAgICAgICAgbGV0IHdhcm5pbmdPcHRpb25zID0ge1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLFxuICAgICAgICAgICAgdGltZXIgOiBudWxsLFxuICAgICAgICAgICAgdHlwZSA6IFwid2FybmluZ1wiXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUod2FybmluZ09wdGlvbnMpO1xuICAgIH0sXG4gICAgXG59O1xuZXhwb3J0IHR5cGUgQ3JlYXRlQ29uZmlybVRoaXJkID0gXCJjb25maXJtXCIgfCBcImNhbmNlbFwiIHwgXCJ0aGlyZFwiO1xudHlwZSBCaWcgPSB7XG4gICAgXG4gICAgZXJyb3Iob3B0aW9uczogT21pdDxTd2VldEFsZXJ0T3B0aW9ucywgJ29uT3Blbic+ICYgeyBodG1sOiBzdHJpbmcgfCBFcnJvciB9KTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICB3YXJuaW5nKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBibG9ja2luZyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucywgbW9yZU9wdGlvbnM/OiB7IHN0cmluZ3M6IHN0cmluZ1tdLCBjbGlja0ZuOiAoYmhlOiBCZXR0ZXJIVE1MRWxlbWVudCkgPT4gYW55IH0pOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIG9uZUJ1dHRvbih0aXRsZTogc3RyaW5nLCBvcHRpb25zPzogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIHR3b0J1dHRvbnMob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFwiY29uZmlybVwiIHwgXCJzZWNvbmRcIj5cbiAgICB0aHJlZUJ1dHRvbnMob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMgJiB7IHRoaXJkQnV0dG9uVGV4dDogc3RyaW5nLCB0aGlyZEJ1dHRvblR5cGU/OiBcImNvbmZpcm1cIiB8IFwid2FybmluZ1wiIH0pOiBQcm9taXNlPENyZWF0ZUNvbmZpcm1UaGlyZD5cbn1cblxuY29uc3QgYmlnOiBCaWcgPSB7XG4gICAgYXN5bmMgZXJyb3Iob3B0aW9ucykge1xuICAgICAgICBcbiAgICAgICAgaWYgKCBvcHRpb25zPy5odG1sIGluc3RhbmNlb2YgRXJyb3IgKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IG9wdGlvbnMuaHRtbDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCB7IHdoYXQsIHdoZXJlLCBjbGVhbnN0YWNrIH0gPSBlcnJvci50b09iaigpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coeyBjbGVhbnN0YWNrIH0pO1xuICAgICAgICAgICAgb3B0aW9ucy5odG1sID0gYCR7d2hhdH08cD4ke3doZXJlfTwvcD5gXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGlybmFtZSA9IG5ldyBEYXRlKCkuaHVtYW4oKTtcbiAgICAgICAgaWYgKCBMT0cgKSB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgb3B0aW9ucy5vbk9wZW4gPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXdhaXQgd2FpdCg1MDApO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRha2VTY3JlZW5zaG90KGRpcm5hbWUpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIG9wdGlvbnMuaHRtbCArPSBgPHA+TG9ncyBhbmQgc2NyZWVuc2hvdCBzYXZlZCB0byBlcnJvcnMvJHtwYXRoLmJhc2VuYW1lKFNFU1NJT05fUEFUSF9BQlMpfS8ke2Rpcm5hbWV9PC9wPmBcbiAgICAgICAgICAgIFxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc3QgeyBkZWZhdWx0IDogR2xvYiB9ID0gcmVxdWlyZSgnLi4vR2xvYicpO1xuICAgICAgICAgICAgaWYgKCBHbG9iLkJpZ0NvbmZpZy5nZXQoJ2RldicpICkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMub25BZnRlckNsb3NlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB3YWl0KDUwMCk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRha2VTY3JlZW5zaG90KGRpcm5hbWUpO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGJsb2NraW5nU3dhbE1peGluLmZpcmUoe1xuICAgICAgICAgICAgdHlwZSA6ICdlcnJvcicsXG4gICAgICAgICAgICBzaG93Q29uZmlybUJ1dHRvbiA6IHRydWUsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgd2FybmluZyhvcHRpb25zKSB7XG4gICAgICAgIGlmICggb3B0aW9ucy5hbmltYXRpb24gPT09IGZhbHNlIClcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7IGN1c3RvbUNsYXNzIDogbnVsbCwgLi4ub3B0aW9ucyB9O1xuICAgICAgICByZXR1cm4gYmxvY2tpbmdTd2FsTWl4aW4uZmlyZSh7IC4uLndpdGhDb25maXJtLCB0eXBlIDogJ3dhcm5pbmcnLCAuLi5vcHRpb25zIH0pO1xuICAgIH0sXG4gICAgXG4gICAgYmxvY2tpbmcob3B0aW9ucywgbW9yZU9wdGlvbnMpIHtcbiAgICAgICAgXG4gICAgICAgIGlmICggbW9yZU9wdGlvbnMgJiYgbW9yZU9wdGlvbnMuc3RyaW5ncyAmJiBtb3JlT3B0aW9ucy5jbGlja0ZuICkge1xuICAgICAgICAgICAgbGV0IHsgc3RyaW5ncywgY2xpY2tGbiB9ID0gbW9yZU9wdGlvbnM7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGxldCBwYXJhZ3JhcGhzID0gc3RyaW5nc1xuICAgICAgICAgICAgICAgIC8vIC5tYXAocyA9PiAkKGA8cCBjbGFzcz1cImNsaWNrYWJsZVwiPiR7c308L3A+YCkpXG4gICAgICAgICAgICAgICAgLm1hcChzID0+IHBhcmFncmFwaCh7IGNscyA6ICdjbGlja2FibGUnLCB0ZXh0IDogcyB9KSlcbiAgICAgICAgICAgICAgICAubWFwKHBFbGVtID0+IHBFbGVtLmNsaWNrKCgpID0+IGNsaWNrRm4ocEVsZW0pKSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgICAgICBvbkJlZm9yZU9wZW4obW9kYWxFbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnbW9kYWxFbGVtZW50OicsIG1vZGFsRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtKHsgaWQgOiAnc3dhbDItY29udGVudCcgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC5zaG93KClcbiAgICAgICAgICAgICAgICAgICAgICAgIC5hcHBlbmQoLi4ucGFyYWdyYXBocyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHsgLy8gZm9yY2UgY29uZmlybSBhbmQgY2FuY2VsIGJ1dHRvbnNcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLFxuICAgICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b24gOiB0cnVlLFxuICAgICAgICAgICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIGlmICggb3B0aW9ucy5zaG93Q29uZmlybUJ1dHRvbiB8fCBvcHRpb25zLnNob3dDYW5jZWxCdXR0b24gfHwgb3B0aW9ucy5vbk9wZW4gKSB7XG4gICAgICAgICAgICAvLyAvIEhhcHBlbnMgd2hlbiBub3Qgb3IgYmFkIG1vcmVPcHRpb25zXG4gICAgICAgICAgICByZXR1cm4gU3dhbC5maXJlKHsgLi4uYmxvY2tpbmdPcHRpb25zLCAuLi5vcHRpb25zIH0pO1xuICAgICAgICB9IGVsc2UgeyAvLyBUT0RPOiBvbk9wZW4gOiByZXNvbHZlP1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBTd2FsLmZpcmUoeyAuLi5ibG9ja2luZ09wdGlvbnMsIC4uLm9wdGlvbnMsIG9uT3BlbiA6IHYgPT4gcmVzb2x2ZSh2KSB9KSk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIFxuICAgIG9uZUJ1dHRvbih0aXRsZSwgb3B0aW9ucykge1xuICAgICAgICAvKmNvbnNvbGUubG9nKHsgdGl0bGUsIG9wdGlvbnMgfSk7XG4gICAgICAgICBjb25zdCB0eXBlb2Z0aXRsZSA9IHR5cGVvZiB0aXRsZTtcbiAgICAgICAgIGlmICggdHlwZW9mdGl0bGUgPT09IFwib2JqZWN0XCIgKSB7XG4gICAgICAgICBpZiAoIG9wdGlvbnMgKSB7XG4gICAgICAgICBpZiAoIG9wdGlvbnMuaHRtbCApIHtcbiAgICAgICAgIG9wdGlvbnMuaHRtbCArPSAnPGJyPic7XG4gICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgb3B0aW9ucy5odG1sID0gJyc7XG4gICAgICAgICB9XG4gICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgb3B0aW9ucyA9IHsgaHRtbCA6ICcnIH07XG4gICAgICAgICB9XG4gICAgICAgICBpZiAoIHRpdGxlIGluc3RhbmNlb2YgRXJyb3IgKSB7XG4gICAgICAgICB0aXRsZSA9ICdBbiBlcnJvciBoYXMgb2NjdXJyZWQnO1xuICAgICAgICAgb3B0aW9ucy5odG1sICs9IHRpdGxlLm1lc3NhZ2U7XG4gICAgICAgICBjb25zb2xlLmxvZyh7IHRpdGxlLCBvcHRpb25zIH0pO1xuICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgIGxldCBodG1sID0gYDxzdHlsZT5cbiAgICAgICAgIHNwYW4ge1xuICAgICAgICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTtcbiAgICAgICAgIG1hcmdpbi1sZWZ0OiA0MHB4O1xuICAgICAgICAgfVxuICAgICAgICAgPC9zdHlsZT5cbiAgICAgICAgIDxkaXYgc3R5bGU9XCJ0ZXh0LWFsaWduOiBsZWZ0XCI+XG4gICAgICAgICBcbiAgICAgICAgIGA7XG4gICAgICAgICBmb3IgKCBsZXQga2V5IG9mIE9iamVjdC5rZXlzKHRpdGxlKSApIHtcbiAgICAgICAgIGh0bWwgKz0gYDxwPjxiPiR7a2V5fTo8L2I+IDxzcGFuPiR7dGl0bGVba2V5XX08L3NwYW4+PC9wPmBcbiAgICAgICAgIH1cbiAgICAgICAgIGh0bWwgKz0gYDwvZGl2PmA7XG4gICAgICAgICBvcHRpb25zLmh0bWwgKz0gaHRtbDtcbiAgICAgICAgIHRpdGxlID0gJ1NvbWV0aGluZyBoYXBwZW5lZCc7XG4gICAgICAgICBcbiAgICAgICAgIH1cbiAgICAgICAgIH0gZWxzZSBpZiAoIEFycmF5LmlzQXJyYXkodGl0bGUpICkge1xuICAgICAgICAgdGl0bGUgPSAnVGhpcyBpcyB3ZWlyZCc7XG4gICAgICAgICBvcHRpb25zLmh0bWwgKz0gdGl0bGUuam9pbignPC9icj4nKVxuICAgICAgICAgfSovXG4gICAgICAgIHJldHVybiBibG9ja2luZ1N3YWxNaXhpbi5maXJlKHtcbiAgICAgICAgICAgIHRpdGxlIDogdGl0bGUgYXMgc3RyaW5nLFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b24gOiB0cnVlLFxuICAgICAgICAgICAgY3VzdG9tQ2xhc3MgOiAnYW5pbWF0ZWQgZmFkZUluJyxcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGFzeW5jIHR3b0J1dHRvbnMob3B0aW9ucykge1xuICAgICAgICBcbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gYXdhaXQgU3dhbC5maXJlKHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgc2hvd0NhbmNlbEJ1dHRvbiA6IHRydWUsXG4gICAgICAgICAgICBjdXN0b21DbGFzcyA6ICdhbmltYXRlZCBmYWRlSW4nLFxuICAgICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiB2YWx1ZSA/IFwiY29uZmlybVwiIDogXCJzZWNvbmRcIjtcbiAgICB9LFxuICAgIGFzeW5jIHRocmVlQnV0dG9ucyhvcHRpb25zKSB7XG4gICAgICAgIFxuICAgICAgICAvLyBjb25zdCB0aGlyZEJ1dHRvblRleHQgPSBvcHRpb25zLnRoaXJkQnV0dG9uVGV4dCA/PyAnT3ZlcndyaXRlJztcbiAgICAgICAgbGV0IHRoaXJkQnV0dG9uQ3NzO1xuICAgICAgICBpZiAoIG9wdGlvbnMudGhpcmRCdXR0b25UeXBlID09PSBcIndhcm5pbmdcIiApIHtcbiAgICAgICAgICAgIHRoaXJkQnV0dG9uQ3NzID0geyBiYWNrZ3JvdW5kQ29sb3IgOiAnI0ZGQzY2RCcsIGNvbG9yIDogJ2JsYWNrJyB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnNvbGUubG9nKHsgdGhpcmRCdXR0b25Dc3MgfSk7XG4gICAgICAgIGxldCBhY3Rpb246IENyZWF0ZUNvbmZpcm1UaGlyZDtcbiAgICAgICAgY29uc3Qgb25CZWZvcmVPcGVuID0gKG1vZGFsOiBIVE1MRWxlbWVudCkgPT4ge1xuICAgICAgICAgICAgbGV0IGVsID0gZWxlbSh7XG4gICAgICAgICAgICAgICAgaHRtbEVsZW1lbnQgOiBtb2RhbCxcbiAgICAgICAgICAgICAgICBjaGlsZHJlbiA6IHsgYWN0aW9ucyA6ICcuc3dhbDItYWN0aW9ucycgfVxuICAgICAgICAgICAgfSkgYXMgQmV0dGVySFRNTEVsZW1lbnQgJiB7IGFjdGlvbnM6IEJldHRlckhUTUxFbGVtZW50IH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGVsLmFjdGlvbnMuYXBwZW5kKFxuICAgICAgICAgICAgICAgIGJ1dHRvbih7IGNscyA6IGBzd2FsMi1jb25maXJtIHN3YWwyLXN0eWxlZGAsIGh0bWwgOiBvcHRpb25zLnRoaXJkQnV0dG9uVGV4dCB9KVxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgLmNzcyh0aGlyZEJ1dHRvbkNzcylcbiAgICAgICAgICAgICAgICAgICAgLmNsaWNrKChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gXCJ0aGlyZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgU3dhbC5jbGlja0NvbmZpcm0oKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgfTtcbiAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgb25CZWZvcmVPcGVuLCBzaG93Q2FuY2VsQnV0dG9uIDogdHJ1ZSB9O1xuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCBTd2FsLmZpcmUob3B0aW9ucyk7XG4gICAgICAgIGlmICggdmFsdWUgKSB7XG4gICAgICAgICAgICAvLy8gRWl0aGVyIHVzZXIgY2xpY2tlZCBDb25maXJtIChhY3Rpb24gaXMgdW5kZWZpbmVkKSBvciBTd2FsLmNsaWNrQ29uZmlybSgpIChhY3Rpb24gaXMgXCJ0aGlyZFwiKVxuICAgICAgICAgICAgaWYgKCBhY3Rpb24gPT09IHVuZGVmaW5lZCApIHtcbiAgICAgICAgICAgICAgICBhY3Rpb24gPSBcImNvbmZpcm1cIjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFjdGlvbiA9IFwiY2FuY2VsXCI7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBhY3Rpb247XG4gICAgfVxufTtcbi8vIGV4cG9ydCBkZWZhdWx0IHsgYWxlcnRGbiwgc21hbGwsIGJpZywgY2xvc2UgOiBTd2FsLmNsb3NlLCBpc1Zpc2libGUgOiBTd2FsLmlzVmlzaWJsZSB9O1xuZXhwb3J0IGRlZmF1bHQgeyBzbWFsbCwgYmlnLCAuLi5Td2FsIH07XG4iXX0=