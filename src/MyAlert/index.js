"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
console.log('src/MyAlert/index.ts');
const sweetalert2_1 = require("sweetalert2");
const bhe_1 = require("../bhe");
const path = require("path");
const util_1 = require("../util");
const Glob_1 = require("../Glob");
const swalTypes = {
    info: 0,
    success: 1,
    question: 2,
    warning: 3,
    error: 4
};
function activeIsToast() {
    if (!sweetalert2_1.default.isVisible()) {
        return false;
    }
    return sweetalert2_1.default.getPopup().classList.contains('swal2-toast');
}
function activeType() {
    if (!sweetalert2_1.default.isVisible()) {
        return undefined;
    }
    const classes = sweetalert2_1.default.getIcons().find(div => div.style.display != 'none').classList.value;
    for (let type of ['success', 'error', 'warning', 'info', 'question']) {
        if (classes.includes(type)) {
            return type;
        }
    }
    console.warn(`MyAlert.index.ts activeType() couldnt find type. classes: ${classes}`);
}
async function generic(options) {
    let propname;
    let propval;
    function _format_value(_propval) {
        if (typeof _propval === 'string') {
            if (_propval.includes('\n')) {
                _propval = _propval.replaceAll('\n', '<br>');
            }
        }
        else if (util_1.isObject(_propval)) {
            _propval = JSON.stringify(_propval);
        }
        return _propval;
    }
    if (options.text || options.html) {
        if (options.text) {
            propname = 'text';
            propval = options.text;
        }
        else if (options.html) {
            propname = 'html';
            propval = options.html;
        }
        propval = _format_value(propval);
        options[propname] = propval;
    }
    if (options.title) {
        options['title'] = _format_value(options.title);
    }
    options = Object.assign({ animation: false, width: '90vw', position: options.toast ? "bottom" : "center", showConfirmButton: !options.toast, timer: 8000 }, options);
    if (sweetalert2_1.default.isVisible()) {
        const takePrecedence = (!options.toast && activeIsToast()) || (swalTypes[options.type] > swalTypes[activeType()]);
        if (takePrecedence) {
            return sweetalert2_1.default.fire(options);
        }
        const currentQueueStep = sweetalert2_1.default.getQueueStep();
        if (currentQueueStep === null) {
            const timedout = !(await util_1.waitUntil(() => !sweetalert2_1.default.isVisible(), 500, 60000));
            if (timedout) {
                console.warn(`Swal.generic() | time out waiting for existing swal to close`);
                return undefined;
            }
            const results = await sweetalert2_1.default.queue([options]);
            return results[0];
        }
        else {
            sweetalert2_1.default.insertQueueStep(options);
            return;
        }
    }
    const results = await sweetalert2_1.default.queue([options]);
    return results[0];
}
const smallMixin = sweetalert2_1.default.mixin({
    position: "bottom-start",
    showConfirmButton: false,
    timer: 8000,
    toast: true,
});
const withConfirm = {
    cancelButtonText: "No",
    confirmButtonText: "Yes",
    showCancelButton: true,
    showConfirmButton: true,
    timer: null,
};
const blockingOptions = {
    allowEnterKey: false,
    allowEscapeKey: false,
    allowOutsideClick: false,
    showCancelButton: false,
    showCloseButton: false,
    showConfirmButton: false,
    timer: null
};
const threeButtonsOptions = Object.assign(Object.assign({}, blockingOptions), { showConfirmButton: true, showCancelButton: true });
const blockingSwalMixin = sweetalert2_1.default.mixin(blockingOptions);
const small = {
    _question(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'question' }));
    },
    _info(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'info' }));
    },
    _success(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'success' }));
    },
    _error(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { type: 'error' }));
    },
    _warning(options) {
        return smallMixin.fire(Object.assign(Object.assign({}, options), { showConfirmButton: true, type: 'warning' }));
    },
    error(title, text) {
        return smallMixin.fire({
            title,
            text,
            type: "error",
        });
    },
    info(title, text = null, showConfirmBtns = false) {
        let infoOptions = {
            title,
            text,
            type: "info",
        };
        if (showConfirmBtns) {
            infoOptions = Object.assign(Object.assign({}, infoOptions), withConfirm);
        }
        return smallMixin.fire(infoOptions);
    },
    success(title, text = null) {
        return generic({
            title,
            text,
            type: "success",
            toast: true
        });
    },
    warning(title, text = null) {
        let warningOptions = {
            title,
            text,
            showConfirmButton: true,
            timer: null,
            type: "warning"
        };
        return smallMixin.fire(warningOptions);
    },
};
const big = {
    async error(options) {
        var _a;
        if (((_a = options) === null || _a === void 0 ? void 0 : _a.html) instanceof Error) {
            const error = options.html;
            const { what, where, cleanstack } = error.toObj();
            console.warn('Error!', error, { cleanstack });
            options.html = `${what}<p>${where}</p>`;
        }
        const dirname = new Date().human();
        if (LOG || !Glob_1.default.BigConfig.get('dev')) {
            options.onOpen = async () => {
                await util_1.takeScreenshot(dirname);
            };
            options.onAfterClose = async () => {
                await util_1.wait(500);
                await util_1.takeScreenshot(dirname);
            };
            options.html += `<p>Logs and screenshot saved to errors/${path.basename(SESSION_PATH_ABS)}/${dirname}</p>`;
        }
        return blockingSwalMixin.fire(Object.assign({ type: 'error', showConfirmButton: true }, options));
    },
    warning(options) {
        return this.oneButton(Object.assign({ type: 'warning' }, options));
    },
    async confirm(options) {
        const { value } = await this.oneButton(Object.assign({ type: 'question', cancelButtonText: "No", confirmButtonText: "Yes", showCancelButton: true, showConfirmButton: true }, options));
        return !!value;
    },
    blocking(options, moreOptions) {
        if (moreOptions && moreOptions.strings && moreOptions.clickFn) {
            let { strings, clickFn } = moreOptions;
            let paragraphs = strings
                .map(s => bhe_1.paragraph({ cls: 'clickable', text: s }))
                .map(pElem => pElem.click(() => clickFn(pElem)));
            options = Object.assign(Object.assign({}, options), { onBeforeOpen(modalElement) {
                    console.log('modalElement:', modalElement);
                    return bhe_1.elem({ byid: 'swal2-content' })
                        .append(...paragraphs);
                } });
        }
        else {
            options = Object.assign({ showConfirmButton: true, showCancelButton: true }, options);
        }
        if (options.showConfirmButton || options.showCancelButton || options.onOpen) {
            return sweetalert2_1.default.fire(Object.assign(Object.assign({}, blockingOptions), options));
        }
        else {
            return new Promise(resolve => sweetalert2_1.default.fire(Object.assign(Object.assign(Object.assign({}, blockingOptions), options), { onOpen: v => resolve(v) })));
        }
    },
    oneButton(options) {
        return generic(Object.assign(Object.assign(Object.assign({}, blockingOptions), { showConfirmButton: true }), options));
    },
    async twoButtons(options) {
        const { value } = await sweetalert2_1.default.fire(Object.assign({ showCancelButton: true }, options));
        return value ? "confirm" : "second";
    },
    async threeButtons(options) {
        let thirdButtonCss;
        if (options.thirdButtonType === "warning") {
            thirdButtonCss = { backgroundColor: '#FFC66D', color: 'black' };
        }
        console.log({ thirdButtonCss });
        let action;
        const onBeforeOpen = (modal) => {
            let el = bhe_1.elem({
                htmlElement: modal,
                children: { actions: '.swal2-actions' }
            });
            el.actions.append(bhe_1.button({ cls: `swal2-confirm swal2-styled`, html: options.thirdButtonText })
                .css(thirdButtonCss)
                .click(async (ev) => {
                action = "third";
                sweetalert2_1.default.clickConfirm();
            }));
        };
        options = Object.assign(Object.assign({}, options), { onBeforeOpen, showCancelButton: true });
        const { value } = await sweetalert2_1.default.fire(options);
        if (value) {
            if (action === undefined) {
                action = "confirm";
            }
        }
        else {
            action = "cancel";
        }
        return action;
    }
};
exports.default = Object.assign({ small, big }, sweetalert2_1.default);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUNwQyw2Q0FBd0Y7QUFDeEYsZ0NBQW9FO0FBQ3BFLDZCQUE2QjtBQUM3QixrQ0FBb0U7QUFDcEUsa0NBQTJCO0FBRTNCLE1BQU0sU0FBUyxHQUFHO0lBQ2QsSUFBSSxFQUFFLENBQUM7SUFDUCxPQUFPLEVBQUUsQ0FBQztJQUNWLFFBQVEsRUFBRSxDQUFDO0lBQ1gsT0FBTyxFQUFFLENBQUM7SUFDVixLQUFLLEVBQUUsQ0FBQztDQUNYLENBQUM7QUFFRixTQUFTLGFBQWE7SUFDbEIsSUFBSSxDQUFDLHFCQUFJLENBQUMsU0FBUyxFQUFFLEVBQUU7UUFDbkIsT0FBTyxLQUFLLENBQUM7S0FDaEI7SUFFRCxPQUFPLHFCQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQTtBQUM1RCxDQUFDO0FBRUQsU0FBUyxVQUFVO0lBQ2YsSUFBSSxDQUFDLHFCQUFJLENBQUMsU0FBUyxFQUFFLEVBQUU7UUFDbkIsT0FBTyxTQUFTLENBQUE7S0FDbkI7SUFDRCxNQUFNLE9BQU8sR0FBRyxxQkFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUM7SUFDekYsS0FBSyxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxVQUFVLENBQUMsRUFBRTtRQUNsRSxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDeEIsT0FBTyxJQUFzQixDQUFBO1NBQ2hDO0tBQ0o7SUFDRCxPQUFPLENB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QU0sR0FBRyxTQUFTLENBQUM7YUFDdEI7U0FDSjthQUFNO1lBQ0gsTUFBTSxHQUFHLFFBQVEsQ0FBQztTQUNyQjtRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7Q0FDSixDQUFDO0FBRUYsa0NBQWlCLEtBQUssRUFBRSxHQUFHLElBQUsscUJBQUksRUFBRyIsInNvdXJjZXNDb250ZW50IjpbIi8qKmltcG9ydCBBbGVydCBmcm9tICdNeUFsZXJ0JyAob3IgYW55IG90aGVyIG5hbWUpKi9cblxuXG5jb25zb2xlLmxvZygnc3JjL015QWxlcnQvaW5kZXgudHMnKTtcbmltcG9ydCBTd2FsLCB7IFN3ZWV0QWxlcnRPcHRpb25zLCBTd2VldEFsZXJ0UmVzdWx0LCBTd2VldEFsZXJ0VHlwZSB9IGZyb20gJ3N3ZWV0YWxlcnQyJztcbmltcG9ydCB7IEJldHRlckhUTUxFbGVtZW50LCBidXR0b24sIGVsZW0sIHBhcmFncmFwaCB9IGZyb20gXCIuLi9iaGVcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCB7IGlzT2JqZWN0LCB0YWtlU2NyZWVuc2hvdCwgd2FpdCwgd2FpdFVudGlsIH0gZnJvbSBcIi4uL3V0aWxcIjtcbmltcG9ydCBHbG9iIGZyb20gXCIuLi9HbG9iXCI7XG5cbmNvbnN0IHN3YWxUeXBlcyA9IHtcbiAgICBpbmZvOiAwLFxuICAgIHN1Y2Nlc3M6IDEsXG4gICAgcXVlc3Rpb246IDIsXG4gICAgd2FybmluZzogMyxcbiAgICBlcnJvcjogNFxufTtcblxuZnVuY3Rpb24gYWN0aXZlSXNUb2FzdCgpOiBib29sZWFuIHtcbiAgICBpZiAoIVN3YWwuaXNWaXNpYmxlKCkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgcmV0dXJuIFN3YWwuZ2V0UG9wdXAoKS5jbGFzc0xpc3QuY29udGFpbnMoJ3N3YWwyLXRvYXN0Jylcbn1cblxuZnVuY3Rpb24gYWN0aXZlVHlwZSgpOiBTd2VldEFsZXJ0VHlwZSB7XG4gICAgaWYgKCFTd2FsLmlzVmlzaWJsZSgpKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICB9XG4gICAgY29uc3QgY2xhc3NlcyA9IFN3YWwuZ2V0SWNvbnMoKS5maW5kKGRpdiA9PiBkaXYuc3R5bGUuZGlzcGxheSAhPSAnbm9uZScpLmNsYXNzTGlzdC52YWx1ZTtcbiAgICBmb3IgKGxldCB0eXBlIG9mIFsnc3VjY2VzcycsICdlcnJvcicsICd3YXJuaW5nJywgJ2luZm8nLCAncXVlc3Rpb24nXSkge1xuICAgICAgICBpZiAoY2xhc3Nlcy5pbmNsdWRlcyh0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHR5cGUgYXMgU3dlZXRBbGVydFR5cGVcbiAgICAgICAgfVxuICAgIH1cbiAgICBjb25zb2xlLndhcm4oYE15QWxlcnQuaW5kZXgudHMgYWN0aXZlVHlwZSgpIGNvdWxkbnQgZmluZCB0eXBlLiBjbGFzc2VzOiAke2NsYXNzZXN9YClcbn1cblxuLyoqQ29udmVydHMgbmV3bGluZXMgdG8gaHRtbCA8YnI+LCBhZXN0aGV0aWMgZGVmYXVsdHMgKHRpbWVyOm51bGwpLCBhbmQgbWFuYWdlcyBTd2FsIHF1ZXVlLiovXG5hc3luYyBmdW5jdGlvbiBnZW5lcmljKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PiB7XG4gICAgbGV0IHByb3BuYW1lO1xuICAgIGxldCBwcm9wdmFsO1xuXG4gICAgZnVuY3Rpb24gX2Zvcm1hdF92YWx1ZShfcHJvcHZhbCk6IHN0cmluZyB7XG4gICAgICAgIGlmICh0eXBlb2YgX3Byb3B2YWwgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBpZiAoX3Byb3B2YWwuaW5jbHVkZXMoJ1xcbicpKSB7XG4gICAgICAgICAgICAgICAgX3Byb3B2YWwgPSBfcHJvcHZhbC5yZXBsYWNlQWxsKCdcXG4nLCAnPGJyPicpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSBpZiAoaXNPYmplY3QoX3Byb3B2YWwpKSB7XG4gICAgICAgICAgICBfcHJvcHZhbCA9IEpTT04uc3RyaW5naWZ5KF9wcm9wdmFsKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBfcHJvcHZhbFxuICAgIH1cblxuICAgIGlmIChvcHRpb25zLnRleHQgfHwgb3B0aW9ucy5odG1sKSB7XG4gICAgICAgIGlmIChvcHRpb25zLnRleHQpIHtcbiAgICAgICAgICAgIHByb3BuYW1lID0gJ3RleHQnO1xuICAgICAgICAgICAgcHJvcHZhbCA9IG9wdGlvbnMudGV4dDtcbiAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmh0bWwpIHtcbiAgICAgICAgICAgIHByb3BuYW1lID0gJ2h0bWwnO1xuICAgICAgICAgICAgcHJvcHZhbCA9IG9wdGlvbnMuaHRtbDtcbiAgICAgICAgfVxuICAgICAgICBwcm9wdmFsID0gX2Zvcm1hdF92YWx1ZShwcm9wdmFsKTtcbiAgICAgICAgb3B0aW9uc1twcm9wbmFtZV0gPSBwcm9wdmFsO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy50aXRsZSkge1xuICAgICAgICBvcHRpb25zWyd0aXRsZSddID0gX2Zvcm1hdF92YWx1ZShvcHRpb25zLnRpdGxlKVxuICAgIH1cbiAgICBvcHRpb25zID0ge1xuICAgICAgICBhbmltYXRpb246IGZhbHNlLFxuICAgICAgICB3aWR0aDogJzkwdncnLFxuICAgICAgICBwb3NpdGlvbjogb3B0aW9ucy50b2FzdCA/IFwiYm90dG9tXCIgOiBcImNlbnRlclwiLFxuICAgICAgICBzaG93Q29uZmlybUJ1dHRvbjogIW9wdGlvbnMudG9hc3QsXG4gICAgICAgIHRpbWVyOiA4MDAwLFxuICAgICAgICAvLyB0aW1lcjogbnVsbCxcbiAgICAgICAgLi4ub3B0aW9uc1xuICAgIH07XG4gICAgaWYgKFN3YWwuaXNWaXNpYmxlKCkpIHtcbiAgICAgICAgLy8gbm90LXRvYXN0IHRydW1wcyB0b2FzdCwgd2FybmluZyB0cnVtcHMgc3VjY2Vzc1xuICAgICAgICBjb25zdCB0YWtlUHJlY2VkZW5jZSA9ICghb3B0aW9ucy50b2FzdCAmJiBhY3RpdmVJc1RvYXN0KCkpIHx8IChzd2FsVHlwZXNbb3B0aW9ucy50eXBlXSA+IHN3YWxUeXBlc1thY3RpdmVUeXBlKCldKTtcbiAgICAgICAgaWYgKHRha2VQcmVjZWRlbmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gU3dhbC5maXJlKG9wdGlvbnMpXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY3VycmVudFF1ZXVlU3RlcCA9IFN3YWwuZ2V0UXVldWVTdGVwKCk7XG4gICAgICAgIGlmIChjdXJyZW50UXVldWVTdGVwID09PSBudWxsKSB7XG4gICAgICAgICAgICAvLyAqIFN3YWwgZXhpc3RzLCBidXQgZmlyZWQgdGhyb3VnaCBgZmlyZWAgYW5kIG5vdCBgcXVldWVgXG4gICAgICAgICAgICBjb25zdCB0aW1lZG91dCA9ICEoYXdhaXQgd2FpdFVudGlsKCgpID0+ICFTd2FsLmlzVmlzaWJsZSgpLCA1MDAsIDYwMDAwKSk7XG4gICAgICAgICAgICBpZiAodGltZWRvdXQpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYFN3YWwuZ2VuZXJpYygpIHwgdGltZSBvdXQgd2FpdGluZyBmb3IgZXhpc3Rpbmcgc3dhbCB0byBjbG9zZWApO1xuICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBTd2FsLnF1ZXVlKFtvcHRpb25zXSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0c1swXVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gKiBTd2FsIGV4aXN0cywgYW5kIGZpcmVkIHRocm91Z2ggYHF1ZXVlYFxuICAgICAgICAgICAgU3dhbC5pbnNlcnRRdWV1ZVN0ZXAob3B0aW9ucyk7XG4gICAgICAgICAgICByZXR1cm5cblxuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBTd2FsLnF1ZXVlKFtvcHRpb25zXSk7XG4gICAgcmV0dXJuIHJlc3VsdHNbMF1cbn1cblxuY29uc3Qgc21hbGxNaXhpbjogdHlwZW9mIFN3YWwgPSBTd2FsLm1peGluKHtcbiAgICBwb3NpdGlvbjogXCJib3R0b20tc3RhcnRcIixcbiAgICBzaG93Q29uZmlybUJ1dHRvbjogZmFsc2UsXG4gICAgdGltZXI6IDgwMDAsXG4gICAgdG9hc3Q6IHRydWUsXG5cbn0pO1xuY29uc3Qgd2l0aENvbmZpcm06IFN3ZWV0QWxlcnRPcHRpb25zID0ge1xuICAgIGNhbmNlbEJ1dHRvblRleHQ6IFwiTm9cIixcbiAgICBjb25maXJtQnV0dG9uVGV4dDogXCJZZXNcIixcbiAgICBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlLFxuICAgIHNob3dDb25maXJtQnV0dG9uOiB0cnVlLFxuICAgIHRpbWVyOiBudWxsLFxuXG59O1xuY29uc3QgYmxvY2tpbmdPcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyA9IHtcbiAgICBhbGxvd0VudGVyS2V5OiBmYWxzZSxcbiAgICBhbGxvd0VzY2FwZUtleTogZmFsc2UsXG4gICAgYWxsb3dPdXRzaWRlQ2xpY2s6IGZhbHNlLFxuICAgIHNob3dDYW5jZWxCdXR0b246IGZhbHNlLCAvLyBkZWZhdWx0IGZhbHNlXG4gICAgc2hvd0Nsb3NlQnV0dG9uOiBmYWxzZSwgLy8gZGVmYXVsdCBmYWxzZVxuICAgIHNob3dDb25maXJtQnV0dG9uOiBmYWxzZSxcbiAgICB0aW1lcjogbnVsbFxuICAgIC8vIHdpZHRoIDogXCI5MHZ3XCIsXG5cblxufTtcbmNvbnN0IHRocmVlQnV0dG9uc09wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zID0ge1xuICAgIC4uLmJsb2NraW5nT3B0aW9ucyxcbiAgICBzaG93Q29uZmlybUJ1dHRvbjogdHJ1ZSxcbiAgICBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlLFxufTtcbmNvbnN0IGJsb2NraW5nU3dhbE1peGluID0gU3dhbC5taXhpbihibG9ja2luZ09wdGlvbnMpO1xudHlwZSBTbWFsbCA9IHtcbiAgICBfZXJyb3Iob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIF9pbmZvKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBfcXVlc3Rpb24ob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIF9zdWNjZXNzKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBfd2FybmluZyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgZXJyb3IodGl0bGU6IHN0cmluZywgdGV4dDogc3RyaW5nKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBpbmZvKHRpdGxlOiBzdHJpbmcsIHRleHQ/OiAoc3RyaW5nIHwgbnVsbCksIHNob3dDb25maXJtQnRucz86IGJvb2xlYW4pOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIHN1Y2Nlc3ModGl0bGU6IHN0cmluZywgdGV4dD86IChzdHJpbmcgfCBudWxsKSwgdGltZXI/OiBudW1iZXIpOiBQcm9taXNlPFN3ZWV0QWxlcnRSZXN1bHQ+LFxuICAgIHdhcm5pbmcodGl0bGU6IHN0cmluZywgdGV4dD86IChzdHJpbmcgfCBudWxsKSwgc2hvd0NvbmZpcm1CdG5zPzogYm9vbGVhbik6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG59XG5cbmNvbnN0IHNtYWxsOiBTbWFsbCA9IHtcbiAgICBfcXVlc3Rpb24ob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHsgLi4ub3B0aW9ucywgdHlwZTogJ3F1ZXN0aW9uJyB9KVxuICAgIH0sXG4gICAgX2luZm8ob3B0aW9ucykge1xuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHsgLi4ub3B0aW9ucywgdHlwZTogJ2luZm8nIH0pXG4gICAgfSxcbiAgICBfc3VjY2VzcyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoeyAuLi5vcHRpb25zLCB0eXBlOiAnc3VjY2VzcycgfSlcbiAgICB9LFxuICAgIF9lcnJvcihvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoeyAuLi5vcHRpb25zLCB0eXBlOiAnZXJyb3InIH0pXG4gICAgfSxcbiAgICBfd2FybmluZyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoe1xuICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiB0cnVlLCB0eXBlOiAnd2FybmluZydcbiAgICAgICAgfSlcbiAgICB9LFxuICAgIGVycm9yKHRpdGxlLCB0ZXh0KSB7XG4gICAgICAgIHJldHVybiBzbWFsbE1peGluLmZpcmUoe1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgdHlwZTogXCJlcnJvclwiLFxuXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgaW5mbyh0aXRsZSwgdGV4dCA9IG51bGwsIHNob3dDb25maXJtQnRucyA9IGZhbHNlKSB7XG4gICAgICAgIGxldCBpbmZvT3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHRpdGxlLFxuICAgICAgICAgICAgdGV4dCxcbiAgICAgICAgICAgIHR5cGU6IFwiaW5mb1wiLFxuICAgICAgICB9O1xuICAgICAgICBpZiAoc2hvd0NvbmZpcm1CdG5zKSB7XG4gICAgICAgICAgICBpbmZvT3B0aW9ucyA9IHsgLi4uaW5mb09wdGlvbnMsIC4uLndpdGhDb25maXJtIH07XG4gICAgICAgIH1cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKGluZm9PcHRpb25zKTtcbiAgICB9LFxuICAgIHN1Y2Nlc3ModGl0bGUsIHRleHQgPSBudWxsKSB7XG5cbiAgICAgICAgcmV0dXJuIGdlbmVyaWMoe1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgdHlwZTogXCJzdWNjZXNzXCIsXG4gICAgICAgICAgICB0b2FzdDogdHJ1ZVxuICAgICAgICB9KVxuICAgIH0sXG4gICAgd2FybmluZyh0aXRsZSwgdGV4dCA9IG51bGwpIHtcbiAgICAgICAgbGV0IHdhcm5pbmdPcHRpb25zID0ge1xuICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICB0ZXh0LFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IHRydWUsXG4gICAgICAgICAgICB0aW1lcjogbnVsbCxcbiAgICAgICAgICAgIHR5cGU6IFwid2FybmluZ1wiXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gc21hbGxNaXhpbi5maXJlKHdhcm5pbmdPcHRpb25zKTtcbiAgICB9LFxuXG59O1xuZXhwb3J0IHR5cGUgQ3JlYXRlQ29uZmlybVRoaXJkID0gXCJjb25maXJtXCIgfCBcImNhbmNlbFwiIHwgXCJ0aGlyZFwiO1xudHlwZSBCaWcgPSB7XG5cbiAgICBlcnJvcihvcHRpb25zOiBPbWl0PFN3ZWV0QWxlcnRPcHRpb25zLCAnb25PcGVuJyB8ICdvbkFmdGVyQ2xvc2UnPiAmIHsgaHRtbDogc3RyaW5nIHwgRXJyb3IgfSk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgd2FybmluZyhvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8U3dlZXRBbGVydFJlc3VsdD4sXG4gICAgY29uZmlybShvcHRpb25zOiBTd2VldEFsZXJ0T3B0aW9ucyk6IFByb21pc2U8Ym9vbGVhbj4sXG4gICAgYmxvY2tpbmcob3B0aW9uczogU3dlZXRBbGVydE9wdGlvbnMsIG1vcmVPcHRpb25zPzogeyBzdHJpbmdzOiBzdHJpbmdbXSwgY2xpY2tGbjogKGJoZTogQmV0dGVySFRNTEVsZW1lbnQpID0+IGFueSB9KTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICBvbmVCdXR0b24ob3B0aW9ucz86IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxTd2VldEFsZXJ0UmVzdWx0PixcbiAgICB0d29CdXR0b25zKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKTogUHJvbWlzZTxcImNvbmZpcm1cIiB8IFwic2Vjb25kXCI+XG4gICAgdGhyZWVCdXR0b25zKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zICYgeyB0aGlyZEJ1dHRvblRleHQ6IHN0cmluZywgdGhpcmRCdXR0b25UeXBlPzogXCJjb25maXJtXCIgfCBcIndhcm5pbmdcIiB9KTogUHJvbWlzZTxDcmVhdGVDb25maXJtVGhpcmQ+XG59XG5cbmNvbnN0IGJpZzogQmlnID0ge1xuXG4gICAgYXN5bmMgZXJyb3Iob3B0aW9ucykge1xuXG4gICAgICAgIGlmIChvcHRpb25zPy5odG1sIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gb3B0aW9ucy5odG1sO1xuXG5cbiAgICAgICAgICAgIGNvbnN0IHsgd2hhdCwgd2hlcmUsIGNsZWFuc3RhY2sgfSA9IGVycm9yLnRvT2JqKCk7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ0Vycm9yIScsIGVycm9yLCB7IGNsZWFuc3RhY2sgfSk7XG4gICAgICAgICAgICBvcHRpb25zLmh0bWwgPSBgJHt3aGF0fTxwPiR7d2hlcmV9PC9wPmBcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkaXJuYW1lID0gbmV3IERhdGUoKS5odW1hbigpO1xuICAgICAgICAvLyBjb25zdCB7IGRlZmF1bHQ6IEdsb2IgfSA9IHJlcXVpcmUoJy4uL0dsb2InKTtcbiAgICAgICAgaWYgKExPRyB8fCAhR2xvYi5CaWdDb25maWcuZ2V0KCdkZXYnKSkge1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgb3B0aW9ucy5vbk9wZW4gPSBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGFrZVNjcmVlbnNob3QoZGlybmFtZSk7XG5cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICBvcHRpb25zLm9uQWZ0ZXJDbG9zZSA9IGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB3YWl0KDUwMCk7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGFrZVNjcmVlbnNob3QoZGlybmFtZSk7XG5cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBvcHRpb25zLmh0bWwgKz0gYDxwPkxvZ3MgYW5kIHNjcmVlbnNob3Qgc2F2ZWQgdG8gZXJyb3JzLyR7cGF0aC5iYXNlbmFtZShTRVNTSU9OX1BBVEhfQUJTKX0vJHtkaXJuYW1lfTwvcD5gXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYmxvY2tpbmdTd2FsTWl4aW4uZmlyZSh7XG4gICAgICAgICAgICB0eXBlOiAnZXJyb3InLFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IHRydWUsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgd2FybmluZyhvcHRpb25zKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm9uZUJ1dHRvbih7IHR5cGU6ICd3YXJuaW5nJywgLi4ub3B0aW9ucyB9KTtcbiAgICB9LFxuICAgIGFzeW5jIGNvbmZpcm0ob3B0aW9ucykge1xuICAgICAgICBjb25zdCB7IHZhbHVlIH0gPSBhd2FpdCB0aGlzLm9uZUJ1dHRvbih7XG4gICAgICAgICAgICB0eXBlOiAncXVlc3Rpb24nLFxuICAgICAgICAgICAgY2FuY2VsQnV0dG9uVGV4dDogXCJOb1wiLFxuICAgICAgICAgICAgY29uZmlybUJ1dHRvblRleHQ6IFwiWWVzXCIsXG4gICAgICAgICAgICBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlLFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IHRydWUsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gISF2YWx1ZTtcbiAgICB9LFxuXG4gICAgYmxvY2tpbmcob3B0aW9ucywgbW9yZU9wdGlvbnMpIHtcblxuICAgICAgICBpZiAobW9yZU9wdGlvbnMgJiYgbW9yZU9wdGlvbnMuc3RyaW5ncyAmJiBtb3JlT3B0aW9ucy5jbGlja0ZuKSB7XG4gICAgICAgICAgICBsZXQgeyBzdHJpbmdzLCBjbGlja0ZuIH0gPSBtb3JlT3B0aW9ucztcblxuICAgICAgICAgICAgbGV0IHBhcmFncmFwaHMgPSBzdHJpbmdzXG4gICAgICAgICAgICAgICAgLy8gLm1hcChzID0+ICQoYDxwIGNsYXNzPVwiY2xpY2thYmxlXCI+JHtzfTwvcD5gKSlcbiAgICAgICAgICAgICAgICAubWFwKHMgPT4gcGFyYWdyYXBoKHsgY2xzOiAnY2xpY2thYmxlJywgdGV4dDogcyB9KSlcbiAgICAgICAgICAgICAgICAubWFwKHBFbGVtID0+IHBFbGVtLmNsaWNrKCgpID0+IGNsaWNrRm4ocEVsZW0pKSk7XG5cbiAgICAgICAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgICAgICBvbkJlZm9yZU9wZW4obW9kYWxFbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnbW9kYWxFbGVtZW50OicsIG1vZGFsRWxlbWVudCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBlbGVtKHsgYnlpZDogJ3N3YWwyLWNvbnRlbnQnIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyAuc2hvdygpXG4gICAgICAgICAgICAgICAgICAgICAgICAuYXBwZW5kKC4uLnBhcmFncmFwaHMpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7IC8vIGZvcmNlIGNvbmZpcm0gYW5kIGNhbmNlbCBidXR0b25zXG4gICAgICAgICAgICBvcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIHNob3dDb25maXJtQnV0dG9uOiB0cnVlLFxuICAgICAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IHRydWUsXG4gICAgICAgICAgICAgICAgLi4ub3B0aW9ucyxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG9wdGlvbnMuc2hvd0NvbmZpcm1CdXR0b24gfHwgb3B0aW9ucy5zaG93Q2FuY2VsQnV0dG9uIHx8IG9wdGlvbnMub25PcGVuKSB7XG4gICAgICAgICAgICAvLyAvIEhhcHBlbnMgd2hlbiBub3Qgb3IgYmFkIG1vcmVPcHRpb25zXG4gICAgICAgICAgICByZXR1cm4gU3dhbC5maXJlKHsgLi4uYmxvY2tpbmdPcHRpb25zLCAuLi5vcHRpb25zIH0pO1xuICAgICAgICB9IGVsc2UgeyAvLyBUT0RPOiBvbk9wZW4gOiByZXNvbHZlP1xuXG4gICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBTd2FsLmZpcmUoeyAuLi5ibG9ja2luZ09wdGlvbnMsIC4uLm9wdGlvbnMsIG9uT3BlbjogdiA9PiByZXNvbHZlKHYpIH0pKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgb25lQnV0dG9uKG9wdGlvbnM6IFN3ZWV0QWxlcnRPcHRpb25zKSB7XG4gICAgICAgIC8qY29uc29sZS5sb2coeyB0aXRsZSwgb3B0aW9ucyB9KTtcbiAgICAgICAgIGNvbnN0IHR5cGVvZnRpdGxlID0gdHlwZW9mIHRpdGxlO1xuICAgICAgICAgaWYgKCB0eXBlb2Z0aXRsZSA9PT0gXCJvYmplY3RcIiApIHtcbiAgICAgICAgIGlmICggb3B0aW9ucyApIHtcbiAgICAgICAgIGlmICggb3B0aW9ucy5odG1sICkge1xuICAgICAgICAgb3B0aW9ucy5odG1sICs9ICc8YnI+JztcbiAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICBvcHRpb25zLmh0bWwgPSAnJztcbiAgICAgICAgIH1cbiAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICBvcHRpb25zID0geyBodG1sIDogJycgfTtcbiAgICAgICAgIH1cbiAgICAgICAgIGlmICggdGl0bGUgaW5zdGFuY2VvZiBFcnJvciApIHtcbiAgICAgICAgIHRpdGxlID0gJ0FuIGVycm9yIGhhcyBvY2N1cnJlZCc7XG4gICAgICAgICBvcHRpb25zLmh0bWwgKz0gdGl0bGUubWVzc2FnZTtcbiAgICAgICAgIGNvbnNvbGUubG9nKHsgdGl0bGUsIG9wdGlvbnMgfSk7XG4gICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgbGV0IGh0bWwgPSBgPHN0eWxlPlxuICAgICAgICAgc3BhbiB7XG4gICAgICAgICBmb250LWZhbWlseTogbW9ub3NwYWNlO1xuICAgICAgICAgbWFyZ2luLWxlZnQ6IDQwcHg7XG4gICAgICAgICB9XG4gICAgICAgICA8L3N0eWxlPlxuICAgICAgICAgPGRpdiBzdHlsZT1cInRleHQtYWxpZ246IGxlZnRcIj5cblxuICAgICAgICAgYDtcbiAgICAgICAgIGZvciAoIGxldCBrZXkgb2YgT2JqZWN0LmtleXModGl0bGUpICkge1xuICAgICAgICAgaHRtbCArPSBgPHA+PGI+JHtrZXl9OjwvYj4gPHNwYW4+JHt0aXRsZVtrZXldfTwvc3Bhbj48L3A+YFxuICAgICAgICAgfVxuICAgICAgICAgaHRtbCArPSBgPC9kaXY+YDtcbiAgICAgICAgIG9wdGlvbnMuaHRtbCArPSBodG1sO1xuICAgICAgICAgdGl0bGUgPSAnU29tZXRoaW5nIGhhcHBlbmVkJztcblxuICAgICAgICAgfVxuICAgICAgICAgfSBlbHNlIGlmICggQXJyYXkuaXNBcnJheSh0aXRsZSkgKSB7XG4gICAgICAgICB0aXRsZSA9ICdUaGlzIGlzIHdlaXJkJztcbiAgICAgICAgIG9wdGlvbnMuaHRtbCArPSB0aXRsZS5qb2luKCc8L2JyPicpXG4gICAgICAgICB9Ki9cbiAgICAgICAgcmV0dXJuIGdlbmVyaWMoe1xuICAgICAgICAgICAgLi4uYmxvY2tpbmdPcHRpb25zLFxuICAgICAgICAgICAgc2hvd0NvbmZpcm1CdXR0b246IHRydWUsXG4gICAgICAgICAgICAuLi5vcHRpb25zLFxuXG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgYXN5bmMgdHdvQnV0dG9ucyhvcHRpb25zKSB7XG5cbiAgICAgICAgY29uc3QgeyB2YWx1ZSB9ID0gYXdhaXQgU3dhbC5maXJlKHtcbiAgICAgICAgICAgIHNob3dDYW5jZWxCdXR0b246IHRydWUsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiB2YWx1ZSA/IFwiY29uZmlybVwiIDogXCJzZWNvbmRcIjtcbiAgICB9LFxuICAgIGFzeW5jIHRocmVlQnV0dG9ucyhvcHRpb25zKSB7XG5cbiAgICAgICAgLy8gY29uc3QgdGhpcmRCdXR0b25UZXh0ID0gb3B0aW9ucy50aGlyZEJ1dHRvblRleHQgPz8gJ092ZXJ3cml0ZSc7XG4gICAgICAgIGxldCB0aGlyZEJ1dHRvbkNzcztcbiAgICAgICAgaWYgKG9wdGlvbnMudGhpcmRCdXR0b25UeXBlID09PSBcIndhcm5pbmdcIikge1xuICAgICAgICAgICAgdGhpcmRCdXR0b25Dc3MgPSB7IGJhY2tncm91bmRDb2xvcjogJyNGRkM2NkQnLCBjb2xvcjogJ2JsYWNrJyB9XG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmxvZyh7IHRoaXJkQnV0dG9uQ3NzIH0pO1xuICAgICAgICBsZXQgYWN0aW9uOiBDcmVhdGVDb25maXJtVGhpcmQ7XG4gICAgICAgIGNvbnN0IG9uQmVmb3JlT3BlbiA9IChtb2RhbDogSFRNTEVsZW1lbnQpID0+IHtcbiAgICAgICAgICAgIGxldCBlbCA9IGVsZW0oe1xuICAgICAgICAgICAgICAgIGh0bWxFbGVtZW50OiBtb2RhbCxcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogeyBhY3Rpb25zOiAnLnN3YWwyLWFjdGlvbnMnIH1cbiAgICAgICAgICAgIH0pIGFzIEJldHRlckhUTUxFbGVtZW50ICYgeyBhY3Rpb25zOiBCZXR0ZXJIVE1MRWxlbWVudCB9O1xuXG4gICAgICAgICAgICBlbC5hY3Rpb25zLmFwcGVuZChcbiAgICAgICAgICAgICAgICBidXR0b24oeyBjbHM6IGBzd2FsMi1jb25maXJtIHN3YWwyLXN0eWxlZGAsIGh0bWw6IG9wdGlvbnMudGhpcmRCdXR0b25UZXh0IH0pXG5cbiAgICAgICAgICAgICAgICAgICAgLmNzcyh0aGlyZEJ1dHRvbkNzcylcbiAgICAgICAgICAgICAgICAgICAgLmNsaWNrKGFzeW5jIChldjogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uID0gXCJ0aGlyZFwiO1xuICAgICAgICAgICAgICAgICAgICAgICAgU3dhbC5jbGlja0NvbmZpcm0oKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgfTtcbiAgICAgICAgb3B0aW9ucyA9IHsgLi4ub3B0aW9ucywgb25CZWZvcmVPcGVuLCBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlIH07XG4gICAgICAgIGNvbnN0IHsgdmFsdWUgfSA9IGF3YWl0IFN3YWwuZmlyZShvcHRpb25zKTtcbiAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAvLy8gRWl0aGVyIHVzZXIgY2xpY2tlZCBDb25maXJtIChhY3Rpb24gaXMgdW5kZWZpbmVkKSBvciBTd2FsLmNsaWNrQ29uZmlybSgpIChhY3Rpb24gaXMgXCJ0aGlyZFwiKVxuICAgICAgICAgICAgaWYgKGFjdGlvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgYWN0aW9uID0gXCJjb25maXJtXCI7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY3Rpb24gPSBcImNhbmNlbFwiO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFjdGlvbjtcbiAgICB9XG59O1xuLy8gZXhwb3J0IGRlZmF1bHQgeyBhbGVydEZuLCBzbWFsbCwgYmlnLCBjbG9zZSA6IFN3YWwuY2xvc2UsIGlzVmlzaWJsZSA6IFN3YWwuaXNWaXNpYmxlIH07XG5leHBvcnQgZGVmYXVsdCB7IHNtYWxsLCBiaWcsIC4uLlN3YWwgfTtcbiJdfQ==