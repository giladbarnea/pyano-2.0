"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../util");
class Level {
    constructor(level, index, internalTrialIndex) {
        if (index === undefined) {
            console.error(`Level ctor, index is undefined. Continuing with index=0`);
            index = 0;
        }
        const { notes, rhythm, tempo, trials } = level;
        this.notes = notes;
        this.rhythm = rhythm;
        this.tempo = tempo;
        this.trials = trials;
        this.index = index;
        this.internalTrialIndex = internalTrialIndex;
    }
    toJSON() {
        const { notes, rhythm, tempo, trials } = this;
        return { notes, rhythm, tempo, trials };
    }
    isFirstTrial() {
        if (this.internalTrialIndex === undefined)
            throw new Error("internalTrialIndex is undefined");
        return this.internalTrialIndex === 0;
    }
    isLastTrial() {
        return this.internalTrialIndex === this.trials - 1;
    }
    hasZeroes() {
        return !util_1.bool(this.notes) || !util_1.bool(this.trials);
    }
    valuesOk() {
        if (!util_1.bool(this.notes) || !util_1.bool(this.trials)) {
            return false;
        }
        if (this.rhythm) {
            if (!util_1.bool(this.tempo)) {
                return false;
            }
        }
        else {
            if (util_1.bool(this.tempo)) {
                return false;
            }
        }
        return true;
    }
}
exports.Level = Level;
class LevelCollection {
    constructor(levels, currentLevelIndex, currentInternalTrialIndex) {
        this._levels = levels.map((level, index) => new Level(level, index));
        if (currentLevelIndex !== undefined) {
            this.current = this._levels[currentLevelIndex];
            this.current.internalTrialIndex = currentInternalTrialIndex;
        }
    }
    get length() {
        return this._levels.length;
    }
    get previous() {
        return this.get(this.current.index - 1);
    }
    get(i) {
        return this._levels[i];
    }
    badLevels() {
        const badLevels = [];
        for (let [i, level] of util_1.enumerate(this._levels)) {
            if (!level.valuesOk()) {
                badLevels.push(`${i.human()} level `);
            }
        }
        return badLevels;
    }
    someHaveZeroes() {
        return this._levels.some(level => level.hasZeroes());
    }
    slicesByNotes() {
        let byNotes = {};
        for (let level of this._levels) {
            if (level.notes in byNotes)
                byNotes[level.notes].addLevel(level);
            else
                byNotes[level.notes] = new LevelCollection([level]);
        }
        return Object.values(byNotes);
    }
    addLevel(level) {
        this._levels.push(level);
    }
    getNextTempoOfThisNotes() {
        if (this.current.rhythm)
            return this.current.tempo;
        for (let i = this.current.index; i < this._levels.length; i++) {
            const lvl = this._levels[i];
            if (lvl.notes != this.current.notes)
                return 100;
            if (lvl.tempo != null)
                return lvl.tempo;
        }
        return 100;
    }
    isCurrentLastLevel() {
        return this.current.index == this.length - 1;
    }
    maxNotes() {
        return Math.max(...this._levels.map(lvl => lvl.notes));
    }
    [Symbol.iterator]() {
        return this._levels.values();
    }
}
exports.LevelCollection = LevelCollection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtDQUEwQztBQVMxQyxNQUFhLEtBQUs7SUFRZCxZQUFZLEtBQWEsRUFBRSxLQUFhLEVBQUUsa0JBQTJCO1FBQ2pFLElBQUssS0FBSyxLQUFLLFNBQVMsRUFBRztZQUN2QixPQUFPLENBQUMsS0FBSyxDQUFDLHlEQUF5RCxDQUFDLENBQUM7WUFDekUsS0FBSyxHQUFHLENBQUMsQ0FBQztTQUNiO1FBQ0QsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQztRQUMvQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNuQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7SUFDakQsQ0FBQztJQUVELE1BQU07UUFDRixNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzlDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBR0QsWUFBWTtRQUNSLElBQUssSUFBSSxDQUFDLGtCQUFrQixLQUFLLFNBQVM7WUFDdEMsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1FBQ3ZELE9BQU8sSUFBSSxDQUFDLGtCQUFrQixLQUFLLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBR0QsV0FBVztRQUNQLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixL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OlsiaW1wb3J0IHsgYm9vbCwgZW51bWVyYXRlIH0gZnJvbSBcIi4uL3V0aWxcIjtcblxuZXhwb3J0IGludGVyZmFjZSBJTGV2ZWwge1xuICAgIG5vdGVzOiBudW1iZXI7XG4gICAgcmh5dGhtOiBib29sZWFuO1xuICAgIHRlbXBvOiBudW1iZXIgfCBudWxsO1xuICAgIHRyaWFsczogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgTGV2ZWwgaW1wbGVtZW50cyBJTGV2ZWwge1xuICAgIHJlYWRvbmx5IG5vdGVzOiBudW1iZXI7XG4gICAgcmVhZG9ubHkgcmh5dGhtOiBib29sZWFuO1xuICAgIHJlYWRvbmx5IHRlbXBvOiBudW1iZXIgfCBudWxsO1xuICAgIHJlYWRvbmx5IHRyaWFsczogbnVtYmVyO1xuICAgIHJlYWRvbmx5IGluZGV4OiBudW1iZXI7XG4gICAgaW50ZXJuYWxUcmlhbEluZGV4OiBudW1iZXI7XG4gICAgXG4gICAgY29uc3RydWN0b3IobGV2ZWw6IElMZXZlbCwgaW5kZXg6IG51bWJlciwgaW50ZXJuYWxUcmlhbEluZGV4PzogbnVtYmVyKSB7XG4gICAgICAgIGlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYExldmVsIGN0b3IsIGluZGV4IGlzIHVuZGVmaW5lZC4gQ29udGludWluZyB3aXRoIGluZGV4PTBgKTtcbiAgICAgICAgICAgIGluZGV4ID0gMDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IG5vdGVzLCByaHl0aG0sIHRlbXBvLCB0cmlhbHMgfSA9IGxldmVsO1xuICAgICAgICB0aGlzLm5vdGVzID0gbm90ZXM7XG4gICAgICAgIHRoaXMucmh5dGhtID0gcmh5dGhtO1xuICAgICAgICB0aGlzLnRlbXBvID0gdGVtcG87XG4gICAgICAgIHRoaXMudHJpYWxzID0gdHJpYWxzO1xuICAgICAgICB0aGlzLmluZGV4ID0gaW5kZXg7XG4gICAgICAgIHRoaXMuaW50ZXJuYWxUcmlhbEluZGV4ID0gaW50ZXJuYWxUcmlhbEluZGV4O1xuICAgIH1cbiAgICBcbiAgICB0b0pTT04oKTogSUxldmVsIHtcbiAgICAgICAgY29uc3QgeyBub3Rlcywgcmh5dGhtLCB0ZW1wbywgdHJpYWxzIH0gPSB0aGlzO1xuICAgICAgICByZXR1cm4geyBub3Rlcywgcmh5dGhtLCB0ZW1wbywgdHJpYWxzIH07XG4gICAgfVxuICAgIFxuICAgIC8qKkBkZXByZWNhdGVkKi9cbiAgICBpc0ZpcnN0VHJpYWwoKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICggdGhpcy5pbnRlcm5hbFRyaWFsSW5kZXggPT09IHVuZGVmaW5lZCApXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnRlcm5hbFRyaWFsSW5kZXggaXMgdW5kZWZpbmVkXCIpO1xuICAgICAgICByZXR1cm4gdGhpcy5pbnRlcm5hbFRyaWFsSW5kZXggPT09IDA7XG4gICAgfVxuICAgIFxuICAgIC8qKkBkZXByZWNhdGVkKi9cbiAgICBpc0xhc3RUcmlhbCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW50ZXJuYWxUcmlhbEluZGV4ID09PSB0aGlzLnRyaWFscyAtIDE7XG4gICAgfVxuICAgIFxuICAgIC8qKkBkZXByZWNhdGVkKi9cbiAgICBoYXNaZXJvZXMoKSB7XG4gICAgICAgIHJldHVybiAhYm9vbCh0aGlzLm5vdGVzKSB8fCAhYm9vbCh0aGlzLnRyaWFscyk7XG4gICAgfVxuICAgIFxuICAgIHZhbHVlc09rKCk6IGJvb2xlYW4ge1xuICAgICAgICBpZiAoICFib29sKHRoaXMubm90ZXMpIHx8ICFib29sKHRoaXMudHJpYWxzKSApIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICB9XG4gICAgICAgIGlmICggdGhpcy5yaHl0aG0gKSB7XG4gICAgICAgICAgICBpZiAoICFib29sKHRoaXMudGVtcG8pICkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICggYm9vbCh0aGlzLnRlbXBvKSApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIFxufVxuXG5leHBvcnQgY2xhc3MgTGV2ZWxDb2xsZWN0aW9uIHtcbiAgICBwcml2YXRlIHJlYWRvbmx5IF9sZXZlbHM6IExldmVsW107XG4gICAgcmVhZG9ubHkgY3VycmVudDogTGV2ZWw7XG4gICAgXG4gICAgY29uc3RydWN0b3IobGV2ZWxzOiBJTGV2ZWxbXSwgY3VycmVudExldmVsSW5kZXg/OiBudW1iZXIsIGN1cnJlbnRJbnRlcm5hbFRyaWFsSW5kZXg/OiBudW1iZXIpIHtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuX2xldmVscyA9IGxldmVscy5tYXAoKGxldmVsLCBpbmRleCkgPT4gbmV3IExldmVsKGxldmVsLCBpbmRleCkpO1xuICAgICAgICBpZiAoIGN1cnJlbnRMZXZlbEluZGV4ICE9PSB1bmRlZmluZWQgKSB7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLl9sZXZlbHNbY3VycmVudExldmVsSW5kZXhdO1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50LmludGVybmFsVHJpYWxJbmRleCA9IGN1cnJlbnRJbnRlcm5hbFRyaWFsSW5kZXg7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGdldCBsZW5ndGgoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xldmVscy5sZW5ndGg7XG4gICAgfVxuICAgIFxuICAgIGdldCBwcmV2aW91cygpOiBMZXZlbCB7XG4gICAgICAgIHJldHVybiB0aGlzLmdldCh0aGlzLmN1cnJlbnQuaW5kZXggLSAxKVxuICAgIH1cbiAgICBcbiAgICBnZXQoaTogbnVtYmVyKTogTGV2ZWwge1xuICAgICAgICByZXR1cm4gdGhpcy5fbGV2ZWxzW2ldO1xuICAgIH1cbiAgICBcbiAgICBiYWRMZXZlbHMoKTogbnVtYmVyW10ge1xuICAgICAgICBjb25zdCBiYWRMZXZlbHMgPSBbXTtcbiAgICAgICAgZm9yICggbGV0IFsgaSwgbGV2ZWwgXSBvZiBlbnVtZXJhdGUodGhpcy5fbGV2ZWxzKSApIHtcbiAgICAgICAgICAgIGlmICggIWxldmVsLnZhbHVlc09rKCkgKSB7XG4gICAgICAgICAgICAgICAgYmFkTGV2ZWxzLnB1c2goYCR7aS5odW1hbigpfSBsZXZlbCBgKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBiYWRMZXZlbHM7XG4gICAgfVxuICAgIFxuICAgIC8qKkBkZXByZWNhdGVkKi9cbiAgICBzb21lSGF2ZVplcm9lcygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2xldmVscy5zb21lKGxldmVsID0+IGxldmVsLmhhc1plcm9lcygpKTtcbiAgICB9XG4gICAgXG4gICAgc2xpY2VzQnlOb3RlcygpOiBMZXZlbENvbGxlY3Rpb25bXSB7XG4gICAgICAgIGxldCBieU5vdGVzID0ge307XG4gICAgICAgIGZvciAoIGxldCBsZXZlbCBvZiB0aGlzLl9sZXZlbHMgKSB7XG4gICAgICAgICAgICBpZiAoIGxldmVsLm5vdGVzIGluIGJ5Tm90ZXMgKVxuICAgICAgICAgICAgICAgIGJ5Tm90ZXNbbGV2ZWwubm90ZXNdLmFkZExldmVsKGxldmVsKTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBieU5vdGVzW2xldmVsLm5vdGVzXSA9IG5ldyBMZXZlbENvbGxlY3Rpb24oWyBsZXZlbCBdKTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBPYmplY3QudmFsdWVzKGJ5Tm90ZXMpO1xuICAgIH1cbiAgICBcbiAgICBhZGRMZXZlbChsZXZlbDogTGV2ZWwpIHtcbiAgICAgICAgdGhpcy5fbGV2ZWxzLnB1c2gobGV2ZWwpO1xuICAgIH1cbiAgICBcbiAgICBnZXROZXh0VGVtcG9PZlRoaXNOb3RlcygpOiBudW1iZXIge1xuICAgICAgICBpZiAoIHRoaXMuY3VycmVudC5yaHl0aG0gKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudC50ZW1wbztcbiAgICAgICAgZm9yICggbGV0IGkgPSB0aGlzLmN1cnJlbnQuaW5kZXg7IGkgPCB0aGlzLl9sZXZlbHMubGVuZ3RoOyBpKysgKSB7XG4gICAgICAgICAgICBjb25zdCBsdmwgPSB0aGlzLl9sZXZlbHNbaV07XG4gICAgICAgICAgICBpZiAoIGx2bC5ub3RlcyAhPSB0aGlzLmN1cnJlbnQubm90ZXMgKVxuICAgICAgICAgICAgICAgIHJldHVybiAxMDA7IC8vIHdlbnQgb3ZlciBhbGwgbGV2ZWwgd2l0aCBzYW1lIG51bWJlciBvZiBub3RlcyBhbmQgZGlkbid0IGZpbmQgYW55dGhpbmdcbiAgICAgICAgICAgIGlmICggbHZsLnRlbXBvICE9IG51bGwgKVxuICAgICAgICAgICAgICAgIHJldHVybiBsdmwudGVtcG87XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIDEwMDtcbiAgICB9XG4gICAgXG4gICAgaXNDdXJyZW50TGFzdExldmVsKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50LmluZGV4ID09IHRoaXMubGVuZ3RoIC0gMTtcbiAgICB9XG4gICAgXG4gICAgbWF4Tm90ZXMoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIE1hdGgubWF4KC4uLnRoaXMuX2xldmVscy5tYXAobHZsID0+IGx2bC5ub3RlcykpO1xuICAgIH1cbiAgICBcbiAgICBbU3ltYm9sLml0ZXJhdG9yXSgpOiBJdGVyYWJsZUl0ZXJhdG9yPExldmVsPiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9sZXZlbHMudmFsdWVzKCk7XG4gICAgfVxufVxuIl19