"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../util");
console.group('MyPyShell.index.ts');
const python_shell_1 = require("python-shell");
const enginePath = path.join(SRC_PATH_ABS, "engine");
const pyExecPath = path.join(enginePath, process.platform === "linux" ? "env/bin/python" : "env/Scripts/python.exe");
const MyAlert_1 = require("../MyAlert");
python_shell_1.PythonShell.defaultOptions = {
    pythonPath: pyExecPath,
    pythonOptions: ['-OO'],
};
class MyPyShell extends python_shell_1.PythonShell {
    constructor(scriptPath, options) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        let json = false;
        if (options.mode && options.mode === "json") {
            delete options.mode;
            json = true;
        }
        super(scriptPath, options);
        this.json = json;
    }
    static handleArguments(scriptPath, options) {
        if (!util_1.bool(options)) {
            options = { args: [], pythonOptions: ['-OO'] };
        }
        else {
            if (options.args === undefined)
                options.args = [];
            if (options.pythonOptions === undefined)
                options.pythonOptions = ['-OO'];
        }
        if (scriptPath.startsWith('-m')) {
            scriptPath = scriptPath.slice(3);
            if (!options.pythonOptions) {
                options.pythonOptions = ['-m'];
            }
            else {
                if (!options.pythonOptions.includes('-m')) {
                    options.pythonOptions.push('-m');
                }
            }
        }
        options.args = [ROOT_PATH_ABS, ...options.args];
        if (DEBUG)
            options.args.push('debug');
        if (DRYRUN)
            options.args.push('dry-run');
        return [scriptPath, options];
    }
    async runAsync() {
        return new Promise((resolve, reject) => {
            const messages = [];
            let push = DEBUG;
            let warn = false;
            let error = false;
            let log = false;
            const errors = [];
            this.on('message', message => {
                if (message.startsWith('TONODE')) {
                    if (message.includes('WARN')) {
                        warn = message.endsWith('START');
                    }
                    else if (message.includes('ERROR')) {
                        error = message.endsWith('START');
                    }
                    else if (message.includes('LOG')) {
                        log = message.endsWith('START');
                    }
                    else if (message.includes('SEND')) {
                        if (message.endsWith('START')) {
                            push = true;
                        }
                        else {
                            push = DEBUG;
                        }
                    }
                    return;
                }
                if (push || warn || error || log) {
                    if (this.json) {
                        message = JSON.parse(message);
                    }
                    if (typeof message === "string") {
                        message = message.removeAll(MyPyShell.colorRegex);
                    }
                    if (push) {
                        messages.push(message);
                    }
                    if (warn) {
                        console.warn(`TONODE_WARN:`, message);
                    }
                    if (error) {
                        console.error(`TONODE_ERROR:`, message);
                        errors.push(message);
                    }
                    if (log) {
                        console.log(`TONODE_LOG:`, message);
                    }
                }
            });
            this.end((err, code, signal) => {
                if (err)
                    reject(err);
                if (util_1.bool(errors)) {
                    for (let e of errors) {
                        let html;
                        const typeofe = typeof e;
                        if (typeofe === "string") {
                            html = e.replaceAll('\n', '</br>');
                        }
                        else if (Array.isArray(e)) {
                            html = e.join('</br>');
                        }
                        else if (typeofe === "object") {
                            const { eargs, etype, filename, line, lineno } = e;
                            html = `
                 <style>
                 p > span {
                 font-family: monospace;
                 margin-left: 40px;
                 }
                 </style>
                 <div style="text-align: left">
                    <p><b>Exception args</b>: <span>${eargs.join('</br>')}</span></p>
                    <p><b>File</b>: <span>${filename}:${lineno}</span></p>
                    <p><b>Line</b>: <span>${line}</span></p>
                    <p><b>Type</b>: <span>${etype}</span></p>
                 </div>
                 
                 `;
                        }
                        else {
                            html = e;
                        }
                        MyAlert_1.default.big.error({ title: 'A python script threw an error', html });
                    }
                }
                resolve(messages[0]);
            });
        });
    }
    static run(scriptPath, options, callback) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        if (!callback) {
            callback = (err, output) => {
                if (err) {
                    console.error(err);
                }
                if (output) {
                    output = output.map(m => m.removeAll(MyPyShell.colorRegex));
                    console.log(`%c${scriptPath}\n`, 'font-weight: bold', output.join('\n'));
                }
            };
        }
        return python_shell_1.PythonShell.run(scriptPath, options, callback);
    }
}
exports.MyPyShell = MyPyShell;
MyPyShell.colorRegex = /.?\[\d{1,3}m/;
let isChecksModuleDone = NOPYTHON;
function isDone() {
    return isChecksModuleDone;
}
exports.isDone = isDone;
if (!NOPYTHON) {
    const Store = new (require("electron-store"))();
    console.log(`Store.path: `, Store.path);
    const PyChecksModule = new MyPyShell('-m checks', {
        args: [Store.path]
    });
    PyChecksModule.runAsync().then(msgs => {
        isChecksModuleDone = true;
        console.log('PyChecksModule msgs:', msgs);
    });
}
console.groupEnd();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtDQUErQjtBQWUvQixPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDcEMsK0NBQXNFO0FBRXRFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3JELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUNySCx3Q0FBZ0M7QUFFaEMsMEJBQVcsQ0FBQyxjQUFjLEdBQUc7SUFDekIsVUFBVSxFQUFHLFVBQVU7SUFFdkIsYUFBYSxFQUFHLENBQUUsS0FBSyxDQUFFO0NBQzVCLENBQUM7QUFFRixNQUFNLFNBQVUsU0FBUSwwQkFBVztJQUkvQixZQUFZLFVBQWtCLEVBQUUsT0FBaUI7UUFDN0MsQ0FBRSxVQUFVLEVBQUUsT0FBTyxDQUFFLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDekUsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLElBQUssT0FBTyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRztZQUMzQyxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDcEIsSUFBSSxHQUFHLElBQUksQ0FBQztTQUNmO1FBQ0QsS0FBSyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUVyQixDQUFDO0lBRUQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxVQUFrQixFQUFFLE9BQWlCO1FBQ3hELElBQUssQ0FBQyxXQUFJ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ZSBLaW5kID0gJ29uJyB8ICdvZmYnXG5cbmludGVyZmFjZSBJTXNnIHtcbiAgICBraW5kOiBLaW5kXG4gICAgbm90ZTogbnVtYmVyXG4gICAgdGltZTogbnVtYmVyXG4gICAgdGltZV9kZWx0YT86IG51bWJlciB8IG51bGxcbiAgICBsYXN0X29ubXNnX3RpbWU/OiBudW1iZXIgfCBudWxsXG4gICAgdmVsb2NpdHk/OiBudW1iZXIgfCBudWxsXG59XG5cbnR5cGUgSVBhaXJzID0gQXJyYXk8WyBJTXNnLCBJTXNnIF0+XG5cbmNvbnNvbGUuZ3JvdXAoJ015UHlTaGVsbC5pbmRleC50cycpO1xuaW1wb3J0IHsgT3B0aW9ucywgUHl0aG9uU2hlbGwsIFB5dGhvblNoZWxsRXJyb3IgfSBmcm9tICdweXRob24tc2hlbGwnO1xuXG5jb25zdCBlbmdpbmVQYXRoID0gcGF0aC5qb2luKFNSQ19QQVRIX0FCUywgXCJlbmdpbmVcIik7XG5jb25zdCBweUV4ZWNQYXRoID0gcGF0aC5qb2luKGVuZ2luZVBhdGgsIHByb2Nlc3MucGxhdGZvcm0gPT09IFwibGludXhcIiA/IFwiZW52L2Jpbi9weXRob25cIiA6IFwiZW52L1NjcmlwdHMvcHl0aG9uLmV4ZVwiKTtcbmltcG9ydCBNeUFsZXJ0IGZyb20gJy4uL015QWxlcnQnXG5cblB5dGhvblNoZWxsLmRlZmF1bHRPcHRpb25zID0ge1xuICAgIHB5dGhvblBhdGggOiBweUV4ZWNQYXRoLFxuICAgIC8vIHNjcmlwdFBhdGggOiBlbmdpbmVQYXRoLFxuICAgIHB5dGhvbk9wdGlvbnMgOiBbICctT08nIF0sXG59O1xuXG5jbGFzcyBNeVB5U2hlbGwgZXh0ZW5kcyBQeXRob25TaGVsbCB7XG4gICAgc3RhdGljIHJlYWRvbmx5IGNvbG9yUmVnZXggPSAvLj9cXFtcXGR7MSwzfW0vO1xuICAgIHByaXZhdGUgcmVhZG9ubHkganNvbjogYm9vbGVhbjtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihzY3JpcHRQYXRoOiBzdHJpbmcsIG9wdGlvbnM/OiBPcHRpb25zKSB7XG4gICAgICAgIFsgc2NyaXB0UGF0aCwgb3B0aW9ucyBdID0gTXlQeVNoZWxsLmhhbmRsZUFyZ3VtZW50cyhzY3JpcHRQYXRoLCBvcHRpb25zKTtcbiAgICAgICAgbGV0IGpzb24gPSBmYWxzZTtcbiAgICAgICAgaWYgKCBvcHRpb25zLm1vZGUgJiYgb3B0aW9ucy5tb2RlID09PSBcImpzb25cIiApIHtcbiAgICAgICAgICAgIGRlbGV0ZSBvcHRpb25zLm1vZGU7XG4gICAgICAgICAgICBqc29uID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBzdXBlcihzY3JpcHRQYXRoLCBvcHRpb25zKTtcbiAgICAgICAgdGhpcy5qc29uID0ganNvbjtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHN0YXRpYyBoYW5kbGVBcmd1bWVudHMoc2NyaXB0UGF0aDogc3RyaW5nLCBvcHRpb25zPzogT3B0aW9ucyk6IFsgc3RyaW5nLCBPcHRpb25zIF0ge1xuICAgICAgICBpZiAoICFib29sKG9wdGlvbnMpICkge1xuICAgICAgICAgICAgb3B0aW9ucyA9IHsgYXJncyA6IFtdLCBweXRob25PcHRpb25zIDogWyAnLU9PJyBdIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoIG9wdGlvbnMuYXJncyA9PT0gdW5kZWZpbmVkIClcbiAgICAgICAgICAgICAgICBvcHRpb25zLmFyZ3MgPSBbXTtcbiAgICAgICAgICAgIGlmICggb3B0aW9ucy5weXRob25PcHRpb25zID09PSB1bmRlZmluZWQgKVxuICAgICAgICAgICAgICAgIG9wdGlvbnMucHl0aG9uT3B0aW9ucyA9IFsgJy1PTycgXTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIGlmICggc2NyaXB0UGF0aC5zdGFydHNXaXRoKCctbScpICkge1xuICAgICAgICAgICAgc2NyaXB0UGF0aCA9IHNjcmlwdFBhdGguc2xpY2UoMyk7XG4gICAgICAgICAgICBpZiAoICFvcHRpb25zLnB5dGhvbk9wdGlvbnMgKSB7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5weXRob25PcHRpb25zID0gWyAnLW0nIF1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKCAhb3B0aW9ucy5weXRob25PcHRpb25zLmluY2x1ZGVzKCctbScpICkge1xuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLnB5dGhvbk9wdGlvbnMucHVzaCgnLW0nKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgb3B0aW9ucy5hcmdzID0gWyBST09UX1BBVEhfQUJTLCAuLi5vcHRpb25zLmFyZ3MgXTtcbiAgICAgICAgaWYgKCBERUJVRyApXG4gICAgICAgICAgICBvcHRpb25zLmFyZ3MucHVzaCgnZGVidWcnKTtcbiAgICAgICAgaWYgKCBEUllSVU4gKVxuICAgICAgICAgICAgb3B0aW9ucy5hcmdzLnB1c2goJ2RyeS1ydW4nKTtcbiAgICAgICAgcmV0dXJuIFsgc2NyaXB0UGF0aCwgb3B0aW9ucyBdXG4gICAgfVxuICAgIFxuICAgIGFzeW5jIHJ1bkFzeW5jPFQ+KCk6IFByb21pc2U8VE1hcDxUPj5cbiAgICBhc3luYyBydW5Bc3luYygpOiBQcm9taXNlPFRNYXA8YW55Pj4ge1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VzID0gW107XG4gICAgICAgICAgICBsZXQgcHVzaCA9IERFQlVHO1xuICAgICAgICAgICAgbGV0IHdhcm4gPSBmYWxzZTtcbiAgICAgICAgICAgIGxldCBlcnJvciA9IGZhbHNlO1xuICAgICAgICAgICAgbGV0IGxvZyA9IGZhbHNlO1xuICAgICAgICAgICAgY29uc3QgZXJyb3JzID0gW107XG4gICAgICAgICAgICB0aGlzLm9uKCdtZXNzYWdlJywgbWVzc2FnZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCBtZXNzYWdlLnN0YXJ0c1dpdGgoJ1RPTk9ERScpICkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIG1lc3NhZ2UuaW5jbHVkZXMoJ1dBUk4nKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdhcm4gPSBtZXNzYWdlLmVuZHNXaXRoKCdTVEFSVCcpXG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggbWVzc2FnZS5pbmNsdWRlcygnRVJST1InKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gbWVzc2FnZS5lbmRzV2l0aCgnU1RBUlQnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBtZXNzYWdlLmluY2x1ZGVzKCdMT0cnKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvZyA9IG1lc3NhZ2UuZW5kc1dpdGgoJ1NUQVJUJylcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggbWVzc2FnZS5pbmNsdWRlcygnU0VORCcpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBtZXNzYWdlLmVuZHNXaXRoKCdTVEFSVCcpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1c2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoID0gREVCVUc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKHsgcHVzaCwgd2FybiwgZXJyb3IsIG1lc3NhZ2UsIG1lc3NhZ2VzLCBcInRoaXMuanNvblwiIDogdGhpcy5qc29uLCB9KTtcbiAgICAgICAgICAgICAgICBpZiAoIHB1c2ggfHwgd2FybiB8fCBlcnJvciB8fCBsb2cgKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICggdGhpcy5qc29uICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gSlNPTi5wYXJzZShtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiBtZXNzYWdlID09PSBcInN0cmluZ1wiICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVtb3ZlQWxsKE15UHlTaGVsbC5jb2xvclJlZ2V4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHB1c2ggKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHJlc29sdmUobWVzc2FnZSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHdhcm4gKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYFRPTk9ERV9XQVJOOmAsIG1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCBlcnJvciApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFRPTk9ERV9FUlJPUjpgLCBtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICggbG9nICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFRPTk9ERV9MT0c6YCwgbWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmVuZCgoZXJyLCBjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIGVyciApIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIGlmICggYm9vbChlcnJvcnMpICkge1xuICAgICAgICAgICAgICAgICAgICBmb3IgKCBsZXQgZSBvZiBlcnJvcnMgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBodG1sO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdHlwZW9mZSA9IHR5cGVvZiBlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCB0eXBlb2ZlID09PSBcInN0cmluZ1wiICkgeyAvLy8gdG9ub2RlLmVycm9yKG15dGIuZXhjX3N0cihlLCBsb2NhbHM9RmFsc2UpKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgPSBlLnJlcGxhY2VBbGwoJ1xcbicsICc8L2JyPicpXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBBcnJheS5pc0FycmF5KGUpICkgeyAvLy8gdG9ub2RlLmVycm9yKGUuYXJncylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gZS5qb2luKCc8L2JyPicpXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCB0eXBlb2ZlID09PSBcIm9iamVjdFwiICkgeyAvLy8gdG9ub2RlLmVycm9yKG15dGIuZXhjX2RpY3QoZSwgbG9jYWxzPUZhbHNlKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGVhcmdzLCBldHlwZSwgZmlsZW5hbWUsIGxpbmUsIGxpbmVubyB9ID0gZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gYFxuICAgICAgICAgICAgICAgICA8c3R5bGU+XG4gICAgICAgICAgICAgICAgIHAgPiBzcGFuIHtcbiAgICAgICAgICAgICAgICAgZm9udC1mYW1pbHk6IG1vbm9zcGFjZTtcbiAgICAgICAgICAgICAgICAgbWFyZ2luLWxlZnQ6IDQwcHg7XG4gICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgPC9zdHlsZT5cbiAgICAgICAgICAgICAgICAgPGRpdiBzdHlsZT1cInRleHQtYWxpZ246IGxlZnRcIj5cbiAgICAgICAgICAgICAgICAgICAgPHA+PGI+RXhjZXB0aW9uIGFyZ3M8L2I+OiA8c3Bhbj4ke2VhcmdzLmpvaW4oJzwvYnI+Jyl9PC9zcGFuPjwvcD5cbiAgICAgICAgICAgICAgICAgICAgPHA+PGI+RmlsZTwvYj46IDxzcGFuPiR7ZmlsZW5hbWV9OiR7bGluZW5vfTwvc3Bhbj48L3A+XG4gICAgICAgICAgICAgICAgICAgIDxwPjxiPkxpbmU8L2I+OiA8c3Bhbj4ke2xpbmV9PC9zcGFuPjwvcD5cbiAgICAgICAgICAgICAgICAgICAgPHA+PGI+VHlwZTwvYj46IDxzcGFuPiR7ZXR5cGV9PC9zcGFuPjwvcD5cbiAgICAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICBgXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgPSBlXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICBNeUFsZXJ0LmJpZy5lcnJvcih7IHRpdGxlIDogJ0EgcHl0aG9uIHNjcmlwdCB0aHJldyBhbiBlcnJvcicsIGh0bWwgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAvKk15QWxlcnQuYmlnLm9uZUJ1dHRvbignQSBweXRob24gc2NyaXB0IHRocmV3IGFuIGVycm9yLiBQbGVhc2UgdGFrZSBhIHNjcmVlbnNob3Qgd2l0aCBQcnRTYyBidXR0b24gYW5kIHNhdmUgaXQuJywge1xuICAgICAgICAgICAgICAgICAgICAgICAgIGh0bWxcbiAgICAgICAgICAgICAgICAgICAgICAgICB9KSovXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgcmVzb2x2ZShtZXNzYWdlc1swXSlcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgc3RhdGljIHJ1bihzY3JpcHRQYXRoOiBzdHJpbmcsIG9wdGlvbnM/OiBPcHRpb25zLCBjYWxsYmFjaz86IChlcnI/OiBQeXRob25TaGVsbEVycm9yLCBvdXRwdXQ/OiBhbnlbXSkgPT4gYW55KSB7XG4gICAgICAgIFsgc2NyaXB0UGF0aCwgb3B0aW9ucyBdID0gTXlQeVNoZWxsLmhhbmRsZUFyZ3VtZW50cyhzY3JpcHRQYXRoLCBvcHRpb25zKTtcbiAgICAgICAgaWYgKCAhY2FsbGJhY2sgKSB7XG4gICAgICAgICAgICBjYWxsYmFjayA9IChlcnI6IFB5dGhvblNoZWxsRXJyb3IsIG91dHB1dDogYW55W10pID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIGVyciApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIG91dHB1dCApIHtcbiAgICAgICAgICAgICAgICAgICAgb3V0cHV0ID0gb3V0cHV0Lm1hcChtID0+IG0ucmVtb3ZlQWxsKE15UHlTaGVsbC5jb2xvclJlZ2V4KSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGAlYyR7c2NyaXB0UGF0aH1cXG5gLCAnZm9udC13ZWlnaHQ6IGJvbGQnLCBvdXRwdXQuam9pbignXFxuJykpO1xuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFB5dGhvblNoZWxsLnJ1bihzY3JpcHRQYXRoLCBvcHRpb25zLCBjYWxsYmFjaylcbiAgICB9XG59XG5cbmxldCBpc0NoZWNrc01vZHVsZURvbmUgPSBOT1BZVEhPTjsgLy8gaWYgTk9QWVRIT04gPT0gdHJ1ZSwgdGhlbiB3ZSdyZSBkb25lLlxuXG5mdW5jdGlvbiBpc0RvbmUoKTogYm9vbGVhbiB7XG4gICAgLy8gcmV0dXJuIGlzQ2hlY2tzRGlyc0RvbmUgJiYgaXNDaGVja3NDZmdEb25lXG4gICAgcmV0dXJuIGlzQ2hlY2tzTW9kdWxlRG9uZVxufVxuXG5pZiAoICFOT1BZVEhPTiApIHtcbiAgICBcbiAgICBcbiAgICBjb25zdCBTdG9yZSA9IG5ldyAocmVxdWlyZShcImVsZWN0cm9uLXN0b3JlXCIpKSgpO1xuICAgIFxuICAgIFxuICAgIGNvbnNvbGUubG9nKGBTdG9yZS5wYXRoOiBgLCBTdG9yZS5wYXRoKTtcbiAgICBjb25zdCBQeUNoZWNrc01vZHVsZSA9IG5ldyBNeVB5U2hlbGwoJy1tIGNoZWNrcycsIHtcbiAgICAgICAgYXJncyA6IFsgU3RvcmUucGF0aCBdXG4gICAgfSk7XG4gICAgUHlDaGVja3NNb2R1bGUucnVuQXN5bmMoKS50aGVuKG1zZ3MgPT4ge1xuICAgICAgICBpc0NoZWNrc01vZHVsZURvbmUgPSB0cnVlO1xuICAgICAgICBjb25zb2xlLmxvZygnUHlDaGVja3NNb2R1bGUgbXNnczonLCBtc2dzKTtcbiAgICB9KTtcbn1cbi8qY29uc3QgUHlDaGVja3NEaXJzID0gbmV3IE15UHlTaGVsbCgnY2hlY2tzLmRpcnMnLCB7XG4gcHl0aG9uT3B0aW9ucyA6IFsgJy1tJywgXSxcbiBhcmdzIDogWyBST09UX1BBVEhfQUJTLCAnZGVidWcnLCAnZHJ5LXJ1bicgXVxuIH0pO1xuIFB5Q2hlY2tzRGlycy5ydW5Bc3luYygpLnRoZW4obXNncyA9PiB7XG4gaXNDaGVja3NEaXJzRG9uZSA9IHRydWU7XG4gY29uc29sZS5sb2coJ1B5Q2hlY2tzRGlycyBtc2dzOicsIG1zZ3Muam9pbignXFxuJykpO1xuIH0pO1xuIFxuIC8vIE15UHlTaGVsbC5ydW4oXCItbSBjaGVja3MuZGlyc1wiKTtcbiBcbiAvLyAqKiAgRWxlY3Ryb24gU3RvcmVcbiBjb25zdCBTdG9yZSA9IG5ldyAocmVxdWlyZShcImVsZWN0cm9uLXN0b3JlXCIpKSgpO1xuIFxuIFxuIGNvbnNvbGUubG9nKGBTdG9yZS5wYXRoOiBgLCBTdG9yZS5wYXRoKTtcbiBjb25zdCBQeUNoZWNrc0NmZyA9IG5ldyBNeVB5U2hlbGwoJ2NoZWNrcy5jb25maWcnLCB7XG4gcHl0aG9uT3B0aW9ucyA6IFsgJy1tJyBdLFxuIGFyZ3MgOiBbIFJPT1RfUEFUSF9BQlMsIFN0b3JlLnBhdGgsICdkZWJ1ZycsICdkcnktcnVuJyBdXG4gfSk7XG4gUHlDaGVja3NDZmcucnVuQXN5bmMoKS50aGVuKG1zZ3MgPT4ge1xuIGlzQ2hlY2tzQ2ZnRG9uZSA9IHRydWU7XG4gY29uc29sZS5sb2coJ1B5Q2hlY2tzQ2ZnIG1zZ3M6JywgbXNncy5qb2luKCdcXG4nKSk7XG4gfSk7XG4gLy8gTXlQeVNoZWxsLnJ1bihcIi1tIGNoZWNrcy5jb25maWdcIiwgeyBhcmdzIDogWyBTdG9yZS5wYXRoIF0gfSk7Ki9cblxuZXhwb3J0IHsgaXNEb25lLCBNeVB5U2hlbGwsIElQYWlycywgSU1zZywgS2luZCB9O1xuY29uc29sZS5ncm91cEVuZCgpO1xuIl19