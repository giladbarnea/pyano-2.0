"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../util");
console.group('MyPyShell.index.ts');
const python_shell_1 = require("python-shell");
const enginePath = path.join(SRC_PATH_ABS, "engine");
const pyExecPath = path.join(enginePath, process.platform === "linux" ? "env/bin/python" : "env/Scripts/python.exe");
python_shell_1.PythonShell.defaultOptions = {
    pythonPath: pyExecPath,
    pythonOptions: ['-OO'],
};
class MyPyShell extends python_shell_1.PythonShell {
    constructor(scriptPath, options) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        let json = false;
        if (options.mode && options.mode === "json") {
            delete options.mode;
            json = true;
        }
        super(scriptPath, options);
        this.json = json;
    }
    static handleArguments(scriptPath, options) {
        if (!util_1.bool(options)) {
            options = { args: [], pythonOptions: ['-OO'] };
        }
        else {
            if (options.args === undefined)
                options.args = [];
            if (options.pythonOptions === undefined)
                options.pythonOptions = ['-OO'];
        }
        if (scriptPath.startsWith('-m')) {
            scriptPath = scriptPath.slice(3);
            if (!options.pythonOptions) {
                options.pythonOptions = ['-m'];
            }
            else {
                if (!options.pythonOptions.includes('-m')) {
                    options.pythonOptions.push('-m');
                }
            }
        }
        options.args = [ROOT_PATH_ABS, ...options.args];
        if (DEBUG)
            options.args.push('debug');
        if (DRYRUN)
            options.args.push('dry-run');
        return [scriptPath, options];
    }
    async runAsync() {
        return new Promise((resolve, reject) => {
            const messages = [];
            let push = DEBUG;
            let warn = false;
            let error = false;
            this.on('message', message => {
                if (message.startsWith('TONODE')) {
                    if (message.includes('WARN')) {
                        warn = message.endsWith('START');
                    }
                    else if (message.includes('ERROR')) {
                        error = message.endsWith('START');
                    }
                    else if (message.includes('SEND')) {
                        if (message.endsWith('START')) {
                            push = true;
                        }
                        else {
                            push = DEBUG;
                        }
                    }
                    return;
                }
                if (push || warn || error) {
                    if (this.json) {
                        message = JSON.parse(message);
                    }
                    if (typeof message === "string") {
                        message = message.removeAll(MyPyShell.colorRegex);
                    }
                    if (push) {
                        messages.push(message);
                    }
                    else if (warn) {
                        console.warn(`TONODE_WARN:`, message);
                    }
                    else if (error) {
                        console.error(`TONODE_ERROR:`, message);
                    }
                }
            });
            this.end((err, code, signal) => {
                if (err)
                    reject(err);
                resolve(messages);
            });
        });
    }
    static run(scriptPath, options, callback) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        if (!callback) {
            callback = (err, output) => {
                if (err) {
                    console.error(err);
                }
                if (output) {
                    output = output.map(m => m.removeAll(MyPyShell.colorRegex));
                    console.log(`%c${scriptPath}\n`, 'font-weight: bold', output.join('\n'));
                }
            };
        }
        return python_shell_1.PythonShell.run(scriptPath, options, callback);
    }
}
exports.MyPyShell = MyPyShell;
MyPyShell.colorRegex = /.?\[\d{1,3}m/;
let isChecksModuleDone = NOPYTHON;
function isDone() {
    return isChecksModuleDone;
}
exports.isDone = isDone;
if (!NOPYTHON) {
    const Store = new (require("electron-store"))();
    console.log(`Store.path: `, Store.path);
    const PyChecksModule = new MyPyShell('-m checks', {
        args: [Store.path]
    });
    PyChecksModule.runAsync().then(msgs => {
        isChecksModuleDone = true;
        console.log('PyChecksModule msgs:', msgs.join('\n'));
    });
}
console.groupEnd();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtDQUErQjtBQUUvQixPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDcEMsK0NBQXNFO0FBRXRFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3JELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUVySCwwQkFBVyxDQUFDLGNBQWMsR0FBRztJQUN6QixVQUFVLEVBQUcsVUFBVTtJQUV2QixhQUFhLEVBQUcsQ0FBRSxLQUFLLENBQUU7Q0FDNUIsQ0FBQztBQUVGLE1BQU0sU0FBVSxTQUFRLDBCQUFXO0lBSS9CLFlBQVksVUFBa0IsRUFBRSxPQUFpQjtRQUM3QyxDQUFFLFVBQVUsRUFBRSxPQUFPLENBQUUsR0FBRyxTQUFTLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN6RSxJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7UUFDakIsSUFBSyxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFHO1lBQzNDLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQztZQUNwQixJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ2Y7UUFDRCxLQUFLLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRXJCLENBQUM7SUFFRCxNQUFNLENBQUMsZUFBZSxDQUFDLFVBQWtCLEVBQUUsT0FBaUI7UUFDeEQsSUFBSyxDQUFDLFdBQUksQ0FBQyxPQUFPLENB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Q0FBQyxDQUFDLENBQUM7aUJBRTVFO1lBQ0wsQ0FBQyxDQUFBO1NBQ0o7UUFDRCxPQUFPLDBCQUFXLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUE7SUFDekQsQ0FBQzs7QUFtRFksOEJBQVM7QUFqS04sb0JBQVUsR0FBRyxjQUFjLENBQUM7QUFpSGhELElBQUksa0JBQWtCLEdBQUcsUUFBUSxDQUFDO0FBRWxDLFNBQVMsTUFBTTtJQUVYLE9BQU8sa0JBQWtCLENBQUE7QUFDN0IsQ0FBQztBQTJDUSx3QkFBTTtBQXpDZixJQUFLLENBQUMsUUFBUSxFQUFHO0lBR2IsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUdoRCxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsTUFBTSxjQUFjLEdBQUcsSUFBSSxTQUFTLENBQUMsV0FBVyxFQUFFO1FBQzlDLElBQUksRUFBRyxDQUFFLEtBQUssQ0FBQyxJQUFJLENBQUU7S0FDeEIsQ0FBQyxDQUFDO0lBQ0gsY0FBYyxDQUFDLFFBQVEsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNsQyxrQkFBa0IsR0FBRyxJQUFJLENBQUM7UUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDekQsQ0FBQyxDQUFDLENBQUM7Q0FDTjtBQTRCRCxPQUFPLENBQUMsUUFBUSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBib29sIH0gZnJvbSBcIi4uL3V0aWxcIjtcblxuY29uc29sZS5ncm91cCgnTXlQeVNoZWxsLmluZGV4LnRzJyk7XG5pbXBvcnQgeyBPcHRpb25zLCBQeXRob25TaGVsbCwgUHl0aG9uU2hlbGxFcnJvciB9IGZyb20gJ3B5dGhvbi1zaGVsbCc7XG5cbmNvbnN0IGVuZ2luZVBhdGggPSBwYXRoLmpvaW4oU1JDX1BBVEhfQUJTLCBcImVuZ2luZVwiKTtcbmNvbnN0IHB5RXhlY1BhdGggPSBwYXRoLmpvaW4oZW5naW5lUGF0aCwgcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gXCJsaW51eFwiID8gXCJlbnYvYmluL3B5dGhvblwiIDogXCJlbnYvU2NyaXB0cy9weXRob24uZXhlXCIpO1xuXG5QeXRob25TaGVsbC5kZWZhdWx0T3B0aW9ucyA9IHtcbiAgICBweXRob25QYXRoIDogcHlFeGVjUGF0aCxcbiAgICAvLyBzY3JpcHRQYXRoIDogZW5naW5lUGF0aCxcbiAgICBweXRob25PcHRpb25zIDogWyAnLU9PJyBdLFxufTtcblxuY2xhc3MgTXlQeVNoZWxsIGV4dGVuZHMgUHl0aG9uU2hlbGwge1xuICAgIHN0YXRpYyByZWFkb25seSBjb2xvclJlZ2V4ID0gLy4/XFxbXFxkezEsM31tLztcbiAgICBwcml2YXRlIHJlYWRvbmx5IGpzb246IGJvb2xlYW47XG4gICAgXG4gICAgY29uc3RydWN0b3Ioc2NyaXB0UGF0aDogc3RyaW5nLCBvcHRpb25zPzogT3B0aW9ucykge1xuICAgICAgICBbIHNjcmlwdFBhdGgsIG9wdGlvbnMgXSA9IE15UHlTaGVsbC5oYW5kbGVBcmd1bWVudHMoc2NyaXB0UGF0aCwgb3B0aW9ucyk7XG4gICAgICAgIGxldCBqc29uID0gZmFsc2U7XG4gICAgICAgIGlmICggb3B0aW9ucy5tb2RlICYmIG9wdGlvbnMubW9kZSA9PT0gXCJqc29uXCIgKSB7XG4gICAgICAgICAgICBkZWxldGUgb3B0aW9ucy5tb2RlO1xuICAgICAgICAgICAganNvbiA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgc3VwZXIoc2NyaXB0UGF0aCwgb3B0aW9ucyk7XG4gICAgICAgIHRoaXMuanNvbiA9IGpzb247XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBzdGF0aWMgaGFuZGxlQXJndW1lbnRzKHNjcmlwdFBhdGg6IHN0cmluZywgb3B0aW9ucz86IE9wdGlvbnMpOiBbIHN0cmluZywgT3B0aW9ucyBdIHtcbiAgICAgICAgaWYgKCAhYm9vbChvcHRpb25zKSApIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7IGFyZ3MgOiBbXSwgcHl0aG9uT3B0aW9ucyA6IFsgJy1PTycgXSB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKCBvcHRpb25zLmFyZ3MgPT09IHVuZGVmaW5lZCApXG4gICAgICAgICAgICAgICAgb3B0aW9ucy5hcmdzID0gW107XG4gICAgICAgICAgICBpZiAoIG9wdGlvbnMucHl0aG9uT3B0aW9ucyA9PT0gdW5kZWZpbmVkIClcbiAgICAgICAgICAgICAgICBvcHRpb25zLnB5dGhvbk9wdGlvbnMgPSBbICctT08nIF07XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBpZiAoIHNjcmlwdFBhdGguc3RhcnRzV2l0aCgnLW0nKSApIHtcbiAgICAgICAgICAgIHNjcmlwdFBhdGggPSBzY3JpcHRQYXRoLnNsaWNlKDMpO1xuICAgICAgICAgICAgaWYgKCAhb3B0aW9ucy5weXRob25PcHRpb25zICkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMucHl0aG9uT3B0aW9ucyA9IFsgJy1tJyBdXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICggIW9wdGlvbnMucHl0aG9uT3B0aW9ucy5pbmNsdWRlcygnLW0nKSApIHtcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5weXRob25PcHRpb25zLnB1c2goJy1tJylcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIG9wdGlvbnMuYXJncyA9IFsgUk9PVF9QQVRIX0FCUywgLi4ub3B0aW9ucy5hcmdzIF07XG4gICAgICAgIGlmICggREVCVUcgKVxuICAgICAgICAgICAgb3B0aW9ucy5hcmdzLnB1c2goJ2RlYnVnJyk7XG4gICAgICAgIGlmICggRFJZUlVOIClcbiAgICAgICAgICAgIG9wdGlvbnMuYXJncy5wdXNoKCdkcnktcnVuJyk7XG4gICAgICAgIHJldHVybiBbIHNjcmlwdFBhdGgsIG9wdGlvbnMgXVxuICAgIH1cbiAgICBcbiAgICBcbiAgICBhc3luYyBydW5Bc3luYygpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBbXTtcbiAgICAgICAgICAgIGxldCBwdXNoID0gREVCVUc7XG4gICAgICAgICAgICBsZXQgd2FybiA9IGZhbHNlO1xuICAgICAgICAgICAgbGV0IGVycm9yID0gZmFsc2U7XG4gICAgICAgICAgICB0aGlzLm9uKCdtZXNzYWdlJywgbWVzc2FnZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCBtZXNzYWdlLnN0YXJ0c1dpdGgoJ1RPTk9ERScpICkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIG1lc3NhZ2UuaW5jbHVkZXMoJ1dBUk4nKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdhcm4gPSBtZXNzYWdlLmVuZHNXaXRoKCdTVEFSVCcpXG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggbWVzc2FnZS5pbmNsdWRlcygnRVJST1InKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yID0gbWVzc2FnZS5lbmRzV2l0aCgnU1RBUlQnKVxuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIG1lc3NhZ2UuaW5jbHVkZXMoJ1NFTkQnKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggbWVzc2FnZS5lbmRzV2l0aCgnU1RBUlQnKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaCA9IERFQlVHO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIHB1c2ggfHwgd2FybiB8fCBlcnJvciApIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCB0aGlzLmpzb24gKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gSlNPTi5wYXJzZShtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiBtZXNzYWdlID09PSBcInN0cmluZ1wiICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVtb3ZlQWxsKE15UHlTaGVsbC5jb2xvclJlZ2V4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHB1c2ggKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCB3YXJuICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBUT05PREVfV0FSTjpgLCBtZXNzYWdlKVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBlcnJvciApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFRPTk9ERV9FUlJPUjpgLCBtZXNzYWdlKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5lbmQoKGVyciwgY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCBlcnIgKSByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG1lc3NhZ2VzKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBzdGF0aWMgcnVuKHNjcmlwdFBhdGg6IHN0cmluZywgb3B0aW9ucz86IE9wdGlvbnMsIGNhbGxiYWNrPzogKGVycj86IFB5dGhvblNoZWxsRXJyb3IsIG91dHB1dD86IGFueVtdKSA9PiBhbnkpIHtcbiAgICAgICAgWyBzY3JpcHRQYXRoLCBvcHRpb25zIF0gPSBNeVB5U2hlbGwuaGFuZGxlQXJndW1lbnRzKHNjcmlwdFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICBpZiAoICFjYWxsYmFjayApIHtcbiAgICAgICAgICAgIGNhbGxiYWNrID0gKGVycjogUHl0aG9uU2hlbGxFcnJvciwgb3V0cHV0OiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICggZXJyICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICggb3V0cHV0ICkge1xuICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBvdXRwdXQubWFwKG0gPT4gbS5yZW1vdmVBbGwoTXlQeVNoZWxsLmNvbG9yUmVnZXgpKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCVjJHtzY3JpcHRQYXRofVxcbmAsICdmb250LXdlaWdodDogYm9sZCcsIG91dHB1dC5qb2luKCdcXG4nKSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHl0aG9uU2hlbGwucnVuKHNjcmlwdFBhdGgsIG9wdGlvbnMsIGNhbGxiYWNrKVxuICAgIH1cbn1cblxubGV0IGlzQ2hlY2tzTW9kdWxlRG9uZSA9IE5PUFlUSE9OOyAvLyBpZiBOT1BZVEhPTiA9PSB0cnVlLCB0aGVuIHdlJ3JlIGRvbmUuXG5cbmZ1bmN0aW9uIGlzRG9uZSgpOiBib29sZWFuIHtcbiAgICAvLyByZXR1cm4gaXNDaGVja3NEaXJzRG9uZSAmJiBpc0NoZWNrc0NmZ0RvbmVcbiAgICByZXR1cm4gaXNDaGVja3NNb2R1bGVEb25lXG59XG5cbmlmICggIU5PUFlUSE9OICkge1xuICAgIFxuICAgIFxuICAgIGNvbnN0IFN0b3JlID0gbmV3IChyZXF1aXJlKFwiZWxlY3Ryb24tc3RvcmVcIikpKCk7XG4gICAgXG4gICAgXG4gICAgY29uc29sZS5sb2coYFN0b3JlLnBhdGg6IGAsIFN0b3JlLnBhdGgpO1xuICAgIGNvbnN0IFB5Q2hlY2tzTW9kdWxlID0gbmV3IE15UHlTaGVsbCgnLW0gY2hlY2tzJywge1xuICAgICAgICBhcmdzIDogWyBTdG9yZS5wYXRoIF1cbiAgICB9KTtcbiAgICBQeUNoZWNrc01vZHVsZS5ydW5Bc3luYygpLnRoZW4obXNncyA9PiB7XG4gICAgICAgIGlzQ2hlY2tzTW9kdWxlRG9uZSA9IHRydWU7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQeUNoZWNrc01vZHVsZSBtc2dzOicsIG1zZ3Muam9pbignXFxuJykpO1xuICAgIH0pO1xufVxuLypjb25zdCBQeUNoZWNrc0RpcnMgPSBuZXcgTXlQeVNoZWxsKCdjaGVja3MuZGlycycsIHtcbiBweXRob25PcHRpb25zIDogWyAnLW0nLCBdLFxuIGFyZ3MgOiBbIFJPT1RfUEFUSF9BQlMsICdkZWJ1ZycsICdkcnktcnVuJyBdXG4gfSk7XG4gUHlDaGVja3NEaXJzLnJ1bkFzeW5jKCkudGhlbihtc2dzID0+IHtcbiBpc0NoZWNrc0RpcnNEb25lID0gdHJ1ZTtcbiBjb25zb2xlLmxvZygnUHlDaGVja3NEaXJzIG1zZ3M6JywgbXNncy5qb2luKCdcXG4nKSk7XG4gfSk7XG4gXG4gLy8gTXlQeVNoZWxsLnJ1bihcIi1tIGNoZWNrcy5kaXJzXCIpO1xuIFxuIC8vICoqICBFbGVjdHJvbiBTdG9yZVxuIGNvbnN0IFN0b3JlID0gbmV3IChyZXF1aXJlKFwiZWxlY3Ryb24tc3RvcmVcIikpKCk7XG4gXG4gXG4gY29uc29sZS5sb2coYFN0b3JlLnBhdGg6IGAsIFN0b3JlLnBhdGgpO1xuIGNvbnN0IFB5Q2hlY2tzQ2ZnID0gbmV3IE15UHlTaGVsbCgnY2hlY2tzLmNvbmZpZycsIHtcbiBweXRob25PcHRpb25zIDogWyAnLW0nIF0sXG4gYXJncyA6IFsgUk9PVF9QQVRIX0FCUywgU3RvcmUucGF0aCwgJ2RlYnVnJywgJ2RyeS1ydW4nIF1cbiB9KTtcbiBQeUNoZWNrc0NmZy5ydW5Bc3luYygpLnRoZW4obXNncyA9PiB7XG4gaXNDaGVja3NDZmdEb25lID0gdHJ1ZTtcbiBjb25zb2xlLmxvZygnUHlDaGVja3NDZmcgbXNnczonLCBtc2dzLmpvaW4oJ1xcbicpKTtcbiB9KTtcbiAvLyBNeVB5U2hlbGwucnVuKFwiLW0gY2hlY2tzLmNvbmZpZ1wiLCB7IGFyZ3MgOiBbIFN0b3JlLnBhdGggXSB9KTsqL1xuXG5leHBvcnQgeyBpc0RvbmUsIE15UHlTaGVsbCB9O1xuY29uc29sZS5ncm91cEVuZCgpO1xuIl19