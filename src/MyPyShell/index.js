"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../util");
console.group('MyPyShell.index.ts');
const python_shell_1 = require("python-shell");
const enginePath = path.join(SRC_PATH_ABS, "engine");
const pyExecPath = path.join(enginePath, process.platform === "linux" ? "env/bin/python" : "env/Scripts/python.exe");
const MyAlert_1 = require("../MyAlert");
python_shell_1.PythonShell.defaultOptions = {
    pythonPath: pyExecPath,
    pythonOptions: ['-OO'],
};
class MyPyShell extends python_shell_1.PythonShell {
    constructor(scriptPath, options) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        let json = false;
        if (options.mode && options.mode === "json") {
            delete options.mode;
            json = true;
        }
        super(scriptPath, options);
        this.json = json;
    }
    static handleArguments(scriptPath, options) {
        if (!util_1.bool(options)) {
            options = { args: [], pythonOptions: ['-OO'] };
        }
        else {
            if (options.args === undefined)
                options.args = [];
            if (options.pythonOptions === undefined)
                options.pythonOptions = ['-OO'];
        }
        if (scriptPath.startsWith('-m')) {
            scriptPath = scriptPath.slice(3);
            if (!options.pythonOptions) {
                options.pythonOptions = ['-m'];
            }
            else {
                if (!options.pythonOptions.includes('-m')) {
                    options.pythonOptions.push('-m');
                }
            }
        }
        options.args = [ROOT_PATH_ABS, ...options.args];
        if (DEBUG)
            options.args.push('debug');
        if (DRYRUN)
            options.args.push('dry-run');
        return [scriptPath, options];
    }
    async runAsync() {
        return new Promise((resolve, reject) => {
            const messages = [];
            let push = DEBUG;
            let warn = false;
            let error = false;
            const errors = [];
            this.on('message', message => {
                if (message.startsWith('TONODE')) {
                    if (message.includes('WARN')) {
                        warn = message.endsWith('START');
                    }
                    else if (message.includes('ERROR')) {
                        error = message.endsWith('START');
                    }
                    else if (message.includes('SEND')) {
                        if (message.endsWith('START')) {
                            push = true;
                        }
                        else {
                            push = DEBUG;
                        }
                    }
                    return;
                }
                if (push || warn || error) {
                    if (this.json) {
                        message = JSON.parse(message);
                    }
                    if (typeof message === "string") {
                        message = message.removeAll(MyPyShell.colorRegex);
                    }
                    if (push) {
                        messages.push(message);
                    }
                    if (warn) {
                        console.warn(`TONODE_WARN:`, message);
                    }
                    if (error) {
                        console.error(`TONODE_ERROR:`, message);
                        errors.push(message);
                    }
                }
            });
            this.end((err, code, signal) => {
                if (err)
                    reject(err);
                if (util_1.bool(errors)) {
                    for (let e of errors) {
                        let html;
                        const typeofe = typeof e;
                        if (typeofe === "string") {
                            html = e.replaceAll('\n', '</br>');
                        }
                        else if (Array.isArray(e)) {
                            html = e.join('</br>');
                        }
                        else if (typeofe === "object") {
                            const { eargs, filename, line, lineno } = e;
                            html = `
                 <style>
                 span {
                 font-family: monospace;
                 margin-left: 40px;
                 }
                 </style>
                 <div style="text-align: left">
                 <p><b>Exception args</b>: <span>${eargs.join('</br>')}</span></p>
                 <p><b>File</b>: <span>${filename}:${lineno}</span></p>
                 <p><b>Line</b>: <span>${line}</span></p>
                 </div>
                 
                 `;
                        }
                        else {
                            html = e;
                        }
                        MyAlert_1.default.big.oneButton('A python script threw an error. Please take a screenshot with PrtSc button and save it.', {
                            html
                        });
                    }
                }
                resolve(messages[0]);
            });
        });
    }
    static run(scriptPath, options, callback) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        if (!callback) {
            callback = (err, output) => {
                if (err) {
                    console.error(err);
                }
                if (output) {
                    output = output.map(m => m.removeAll(MyPyShell.colorRegex));
                    console.log(`%c${scriptPath}\n`, 'font-weight: bold', output.join('\n'));
                }
            };
        }
        return python_shell_1.PythonShell.run(scriptPath, options, callback);
    }
}
exports.MyPyShell = MyPyShell;
MyPyShell.colorRegex = /.?\[\d{1,3}m/;
let isChecksModuleDone = NOPYTHON;
function isDone() {
    return isChecksModuleDone;
}
exports.isDone = isDone;
if (!NOPYTHON) {
    const Store = new (require("electron-store"))();
    console.log(`Store.path: `, Store.path);
    const PyChecksModule = new MyPyShell('-m checks', {
        args: [Store.path]
    });
    PyChecksModule.runAsync().then(msgs => {
        isChecksModuleDone = true;
        console.log('PyChecksModule msgs:', msgs.join('\n'));
    });
}
console.groupEnd();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtDQUErQjtBQWUvQixPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDcEMsK0NBQXNFO0FBRXRFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3JELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUNySCx3Q0FBZ0M7QUFFaEMsMEJBQVcsQ0FBQyxjQUFjLEdBQUc7SUFDekIsVUFBVSxFQUFHLFVBQVU7SUFFdkIsYUFBYSxFQUFHLENBQUUsS0FBSyxDQUFFO0NBQzVCLENBQUM7QUFFRixNQUFNLFNBQVUsU0FBUSwwQkFBVztJQUkvQixZQUFZLFVBQWtCLEVBQUUsT0FBaUI7UUFDN0MsQ0FBRSxVQUFVLEVBQUUsT0FBTyxDQUFFLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxVQUFVLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDekUsSUFBSSxJQUFJLEdBQUcsS0FBSyxDQUFDO1FBQ2pCLElBQUssT0FBTyxDQUFDLElBQUksSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRztZQUMzQyxPQUFPLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDcEIsSUFBSSxHQUFHLElBQUksQ0FBQztTQUNmO1FBQ0QsS0FBSyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUVyQixDQUFDO0lBRUQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxVQUFrQixFQUFFLE9BQWlCO1FBQ3hELElBQUssQ0FBQyxXQUFJ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OztBQW1EWSw4QkFBUztBQTFNTixvQkFBVSxHQUFHLGNBQWMsQ0FBQztBQTBKaEQsSUFBSSxrQkFBa0IsR0FBRyxRQUFRLENBQUM7QUFFbEMsU0FBUyxNQUFNO0lBRVgsT0FBTyxrQkFBa0IsQ0FBQTtBQUM3QixDQUFDO0FBMkNRLHdCQUFNO0FBekNmLElBQUssQ0FBQyxRQUFRLEVBQUc7SUFHYixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUMsRUFBRSxDQUFDO0lBR2hELE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QyxNQUFNLGNBQWMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxXQUFXLEVBQUU7UUFDOUMsSUFBSSxFQUFHLENBQUUsS0FBSyxDQUFDLElBQUksQ0FBRTtLQUN4QixDQUFDLENBQUM7SUFDSCxjQUFjLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ2xDLGtCQUFrQixHQUFHLElBQUksQ0FBQztRQUMxQixPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN6RCxDQUFDLENBQUMsQ0FBQztDQUNOO0FBNEJELE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGJvb2wgfSBmcm9tIFwiLi4vdXRpbFwiO1xuXG50eXBlIEtpbmQgPSAnb24nIHwgJ29mZidcblxuaW50ZXJmYWNlIElNc2cge1xuICAgIGtpbmQ6IEtpbmRcbiAgICBub3RlOiBudW1iZXJcbiAgICB0aW1lOiBudW1iZXJcbiAgICB0aW1lX2RlbHRhOiBudW1iZXIgfCBudWxsXG4gICAgbGFzdF9vbm1zZ190aW1lOiBudW1iZXIgfCBudWxsXG4gICAgdmVsb2NpdHk6IG51bWJlciB8IG51bGxcbn1cblxudHlwZSBJUGFpcnMgPSBBcnJheTxbIElNc2csIElNc2cgXT5cblxuY29uc29sZS5ncm91cCgnTXlQeVNoZWxsLmluZGV4LnRzJyk7XG5pbXBvcnQgeyBPcHRpb25zLCBQeXRob25TaGVsbCwgUHl0aG9uU2hlbGxFcnJvciB9IGZyb20gJ3B5dGhvbi1zaGVsbCc7XG5cbmNvbnN0IGVuZ2luZVBhdGggPSBwYXRoLmpvaW4oU1JDX1BBVEhfQUJTLCBcImVuZ2luZVwiKTtcbmNvbnN0IHB5RXhlY1BhdGggPSBwYXRoLmpvaW4oZW5naW5lUGF0aCwgcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gXCJsaW51eFwiID8gXCJlbnYvYmluL3B5dGhvblwiIDogXCJlbnYvU2NyaXB0cy9weXRob24uZXhlXCIpO1xuaW1wb3J0IE15QWxlcnQgZnJvbSAnLi4vTXlBbGVydCdcblxuUHl0aG9uU2hlbGwuZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgcHl0aG9uUGF0aCA6IHB5RXhlY1BhdGgsXG4gICAgLy8gc2NyaXB0UGF0aCA6IGVuZ2luZVBhdGgsXG4gICAgcHl0aG9uT3B0aW9ucyA6IFsgJy1PTycgXSxcbn07XG5cbmNsYXNzIE15UHlTaGVsbCBleHRlbmRzIFB5dGhvblNoZWxsIHtcbiAgICBzdGF0aWMgcmVhZG9ubHkgY29sb3JSZWdleCA9IC8uP1xcW1xcZHsxLDN9bS87XG4gICAgcHJpdmF0ZSByZWFkb25seSBqc29uOiBib29sZWFuO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKHNjcmlwdFBhdGg6IHN0cmluZywgb3B0aW9ucz86IE9wdGlvbnMpIHtcbiAgICAgICAgWyBzY3JpcHRQYXRoLCBvcHRpb25zIF0gPSBNeVB5U2hlbGwuaGFuZGxlQXJndW1lbnRzKHNjcmlwdFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICBsZXQganNvbiA9IGZhbHNlO1xuICAgICAgICBpZiAoIG9wdGlvbnMubW9kZSAmJiBvcHRpb25zLm1vZGUgPT09IFwianNvblwiICkge1xuICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMubW9kZTtcbiAgICAgICAgICAgIGpzb24gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHN1cGVyKHNjcmlwdFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmpzb24gPSBqc29uO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgc3RhdGljIGhhbmRsZUFyZ3VtZW50cyhzY3JpcHRQYXRoOiBzdHJpbmcsIG9wdGlvbnM/OiBPcHRpb25zKTogWyBzdHJpbmcsIE9wdGlvbnMgXSB7XG4gICAgICAgIGlmICggIWJvb2wob3B0aW9ucykgKSB7XG4gICAgICAgICAgICBvcHRpb25zID0geyBhcmdzIDogW10sIHB5dGhvbk9wdGlvbnMgOiBbICctT08nIF0gfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICggb3B0aW9ucy5hcmdzID09PSB1bmRlZmluZWQgKVxuICAgICAgICAgICAgICAgIG9wdGlvbnMuYXJncyA9IFtdO1xuICAgICAgICAgICAgaWYgKCBvcHRpb25zLnB5dGhvbk9wdGlvbnMgPT09IHVuZGVmaW5lZCApXG4gICAgICAgICAgICAgICAgb3B0aW9ucy5weXRob25PcHRpb25zID0gWyAnLU9PJyBdO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCBzY3JpcHRQYXRoLnN0YXJ0c1dpdGgoJy1tJykgKSB7XG4gICAgICAgICAgICBzY3JpcHRQYXRoID0gc2NyaXB0UGF0aC5zbGljZSgzKTtcbiAgICAgICAgICAgIGlmICggIW9wdGlvbnMucHl0aG9uT3B0aW9ucyApIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLnB5dGhvbk9wdGlvbnMgPSBbICctbScgXVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoICFvcHRpb25zLnB5dGhvbk9wdGlvbnMuaW5jbHVkZXMoJy1tJykgKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHl0aG9uT3B0aW9ucy5wdXNoKCctbScpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBvcHRpb25zLmFyZ3MgPSBbIFJPT1RfUEFUSF9BQlMsIC4uLm9wdGlvbnMuYXJncyBdO1xuICAgICAgICBpZiAoIERFQlVHIClcbiAgICAgICAgICAgIG9wdGlvbnMuYXJncy5wdXNoKCdkZWJ1ZycpO1xuICAgICAgICBpZiAoIERSWVJVTiApXG4gICAgICAgICAgICBvcHRpb25zLmFyZ3MucHVzaCgnZHJ5LXJ1bicpO1xuICAgICAgICByZXR1cm4gWyBzY3JpcHRQYXRoLCBvcHRpb25zIF1cbiAgICB9XG4gICAgXG4gICAgYXN5bmMgcnVuQXN5bmM8VD4oKTogUHJvbWlzZTxUTWFwPFQ+PlxuICAgIGFzeW5jIHJ1bkFzeW5jKCk6IFByb21pc2U8VE1hcDxhbnk+PiB7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWVzc2FnZXMgPSBbXTtcbiAgICAgICAgICAgIGxldCBwdXNoID0gREVCVUc7XG4gICAgICAgICAgICBsZXQgd2FybiA9IGZhbHNlO1xuICAgICAgICAgICAgbGV0IGVycm9yID0gZmFsc2U7XG4gICAgICAgICAgICBjb25zdCBlcnJvcnMgPSBbXTtcbiAgICAgICAgICAgIHRoaXMub24oJ21lc3NhZ2UnLCBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIG1lc3NhZ2Uuc3RhcnRzV2l0aCgnVE9OT0RFJykgKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICggbWVzc2FnZS5pbmNsdWRlcygnV0FSTicpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2FybiA9IG1lc3NhZ2UuZW5kc1dpdGgoJ1NUQVJUJylcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBtZXNzYWdlLmluY2x1ZGVzKCdFUlJPUicpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSBtZXNzYWdlLmVuZHNXaXRoKCdTVEFSVCcpO1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIG1lc3NhZ2UuaW5jbHVkZXMoJ1NFTkQnKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggbWVzc2FnZS5lbmRzV2l0aCgnU1RBUlQnKSApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHVzaCA9IERFQlVHO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyh7IHB1c2gsIHdhcm4sIGVycm9yLCBtZXNzYWdlLCBtZXNzYWdlcywgXCJ0aGlzLmpzb25cIiA6IHRoaXMuanNvbiwgfSk7XG4gICAgICAgICAgICAgICAgaWYgKCBwdXNoIHx8IHdhcm4gfHwgZXJyb3IgKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICggdGhpcy5qc29uICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gSlNPTi5wYXJzZShtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZiBtZXNzYWdlID09PSBcInN0cmluZ1wiICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UucmVtb3ZlQWxsKE15UHlTaGVsbC5jb2xvclJlZ2V4KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHB1c2ggKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlcy5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmV0dXJuIHJlc29sdmUobWVzc2FnZSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIHdhcm4gKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYFRPTk9ERV9XQVJOOmAsIG1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKCBlcnJvciApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFRPTk9ERV9FUlJPUjpgLCBtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5lbmQoKGVyciwgY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCBlcnIgKSByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICBpZiAoIGJvb2woZXJyb3JzKSApIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yICggbGV0IGUgb2YgZXJyb3JzICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaHRtbDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHR5cGVvZmUgPSB0eXBlb2YgZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggdHlwZW9mZSA9PT0gXCJzdHJpbmdcIiApIHsgLy8vIHRvbm9kZS5lcnJvcihteXRiLmV4Y19zdHIoZSwgbG9jYWxzPUZhbHNlKSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gZS5yZXBsYWNlQWxsKCdcXG4nLCAnPC9icj4nKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggQXJyYXkuaXNBcnJheShlKSApIHsgLy8vIHRvbm9kZS5lcnJvcihlLmFyZ3MpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCA9IGUuam9pbignPC9icj4nKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggdHlwZW9mZSA9PT0gXCJvYmplY3RcIiApIHsgLy8vIHRvbm9kZS5lcnJvcihteXRiLmV4Y19kaWN0KGUsIGxvY2Fscz1GYWxzZSkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBlYXJncywgZmlsZW5hbWUsIGxpbmUsIGxpbmVubyB9ID0gZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodG1sID0gYFxuICAgICAgICAgICAgICAgICA8c3R5bGU+XG4gICAgICAgICAgICAgICAgIHNwYW4ge1xuICAgICAgICAgICAgICAgICBmb250LWZhbWlseTogbW9ub3NwYWNlO1xuICAgICAgICAgICAgICAgICBtYXJnaW4tbGVmdDogNDBweDtcbiAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICA8L3N0eWxlPlxuICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPVwidGV4dC1hbGlnbjogbGVmdFwiPlxuICAgICAgICAgICAgICAgICA8cD48Yj5FeGNlcHRpb24gYXJnczwvYj46IDxzcGFuPiR7ZWFyZ3Muam9pbignPC9icj4nKX08L3NwYW4+PC9wPlxuICAgICAgICAgICAgICAgICA8cD48Yj5GaWxlPC9iPjogPHNwYW4+JHtmaWxlbmFtZX06JHtsaW5lbm99PC9zcGFuPjwvcD5cbiAgICAgICAgICAgICAgICAgPHA+PGI+TGluZTwvYj46IDxzcGFuPiR7bGluZX08L3NwYW4+PC9wPlxuICAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgIGBcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCA9IGVcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgTXlBbGVydC5iaWcub25lQnV0dG9uKCdBIHB5dGhvbiBzY3JpcHQgdGhyZXcgYW4gZXJyb3IuIFBsZWFzZSB0YWtlIGEgc2NyZWVuc2hvdCB3aXRoIFBydFNjIGJ1dHRvbiBhbmQgc2F2ZSBpdC4nLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaHRtbFxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXNvbHZlKG1lc3NhZ2VzWzBdKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBcbiAgICBzdGF0aWMgcnVuKHNjcmlwdFBhdGg6IHN0cmluZywgb3B0aW9ucz86IE9wdGlvbnMsIGNhbGxiYWNrPzogKGVycj86IFB5dGhvblNoZWxsRXJyb3IsIG91dHB1dD86IGFueVtdKSA9PiBhbnkpIHtcbiAgICAgICAgWyBzY3JpcHRQYXRoLCBvcHRpb25zIF0gPSBNeVB5U2hlbGwuaGFuZGxlQXJndW1lbnRzKHNjcmlwdFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICBpZiAoICFjYWxsYmFjayApIHtcbiAgICAgICAgICAgIGNhbGxiYWNrID0gKGVycjogUHl0aG9uU2hlbGxFcnJvciwgb3V0cHV0OiBhbnlbXSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICggZXJyICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICggb3V0cHV0ICkge1xuICAgICAgICAgICAgICAgICAgICBvdXRwdXQgPSBvdXRwdXQubWFwKG0gPT4gbS5yZW1vdmVBbGwoTXlQeVNoZWxsLmNvbG9yUmVnZXgpKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCVjJHtzY3JpcHRQYXRofVxcbmAsICdmb250LXdlaWdodDogYm9sZCcsIG91dHB1dC5qb2luKCdcXG4nKSk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHl0aG9uU2hlbGwucnVuKHNjcmlwdFBhdGgsIG9wdGlvbnMsIGNhbGxiYWNrKVxuICAgIH1cbn1cblxubGV0IGlzQ2hlY2tzTW9kdWxlRG9uZSA9IE5PUFlUSE9OOyAvLyBpZiBOT1BZVEhPTiA9PSB0cnVlLCB0aGVuIHdlJ3JlIGRvbmUuXG5cbmZ1bmN0aW9uIGlzRG9uZSgpOiBib29sZWFuIHtcbiAgICAvLyByZXR1cm4gaXNDaGVja3NEaXJzRG9uZSAmJiBpc0NoZWNrc0NmZ0RvbmVcbiAgICByZXR1cm4gaXNDaGVja3NNb2R1bGVEb25lXG59XG5cbmlmICggIU5PUFlUSE9OICkge1xuICAgIFxuICAgIFxuICAgIGNvbnN0IFN0b3JlID0gbmV3IChyZXF1aXJlKFwiZWxlY3Ryb24tc3RvcmVcIikpKCk7XG4gICAgXG4gICAgXG4gICAgY29uc29sZS5sb2coYFN0b3JlLnBhdGg6IGAsIFN0b3JlLnBhdGgpO1xuICAgIGNvbnN0IFB5Q2hlY2tzTW9kdWxlID0gbmV3IE15UHlTaGVsbCgnLW0gY2hlY2tzJywge1xuICAgICAgICBhcmdzIDogWyBTdG9yZS5wYXRoIF1cbiAgICB9KTtcbiAgICBQeUNoZWNrc01vZHVsZS5ydW5Bc3luYygpLnRoZW4obXNncyA9PiB7XG4gICAgICAgIGlzQ2hlY2tzTW9kdWxlRG9uZSA9IHRydWU7XG4gICAgICAgIGNvbnNvbGUubG9nKCdQeUNoZWNrc01vZHVsZSBtc2dzOicsIG1zZ3Muam9pbignXFxuJykpO1xuICAgIH0pO1xufVxuLypjb25zdCBQeUNoZWNrc0RpcnMgPSBuZXcgTXlQeVNoZWxsKCdjaGVja3MuZGlycycsIHtcbiBweXRob25PcHRpb25zIDogWyAnLW0nLCBdLFxuIGFyZ3MgOiBbIFJPT1RfUEFUSF9BQlMsICdkZWJ1ZycsICdkcnktcnVuJyBdXG4gfSk7XG4gUHlDaGVja3NEaXJzLnJ1bkFzeW5jKCkudGhlbihtc2dzID0+IHtcbiBpc0NoZWNrc0RpcnNEb25lID0gdHJ1ZTtcbiBjb25zb2xlLmxvZygnUHlDaGVja3NEaXJzIG1zZ3M6JywgbXNncy5qb2luKCdcXG4nKSk7XG4gfSk7XG4gXG4gLy8gTXlQeVNoZWxsLnJ1bihcIi1tIGNoZWNrcy5kaXJzXCIpO1xuIFxuIC8vICoqICBFbGVjdHJvbiBTdG9yZVxuIGNvbnN0IFN0b3JlID0gbmV3IChyZXF1aXJlKFwiZWxlY3Ryb24tc3RvcmVcIikpKCk7XG4gXG4gXG4gY29uc29sZS5sb2coYFN0b3JlLnBhdGg6IGAsIFN0b3JlLnBhdGgpO1xuIGNvbnN0IFB5Q2hlY2tzQ2ZnID0gbmV3IE15UHlTaGVsbCgnY2hlY2tzLmNvbmZpZycsIHtcbiBweXRob25PcHRpb25zIDogWyAnLW0nIF0sXG4gYXJncyA6IFsgUk9PVF9QQVRIX0FCUywgU3RvcmUucGF0aCwgJ2RlYnVnJywgJ2RyeS1ydW4nIF1cbiB9KTtcbiBQeUNoZWNrc0NmZy5ydW5Bc3luYygpLnRoZW4obXNncyA9PiB7XG4gaXNDaGVja3NDZmdEb25lID0gdHJ1ZTtcbiBjb25zb2xlLmxvZygnUHlDaGVja3NDZmcgbXNnczonLCBtc2dzLmpvaW4oJ1xcbicpKTtcbiB9KTtcbiAvLyBNeVB5U2hlbGwucnVuKFwiLW0gY2hlY2tzLmNvbmZpZ1wiLCB7IGFyZ3MgOiBbIFN0b3JlLnBhdGggXSB9KTsqL1xuXG5leHBvcnQgeyBpc0RvbmUsIE15UHlTaGVsbCwgSVBhaXJzLCBJTXNnLCBLaW5kIH07XG5jb25zb2xlLmdyb3VwRW5kKCk7XG4iXX0=