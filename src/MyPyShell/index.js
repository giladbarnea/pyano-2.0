"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../util");
console.group('MyPyShell.index.ts');
const python_shell_1 = require("python-shell");
const enginePath = path.join(SRC_PATH_ABS, "engine");
const pyExecPath = path.join(enginePath, process.platform === "linux" ? "env/bin/python" : "env/Scripts/python.exe");
python_shell_1.PythonShell.defaultOptions = {
    pythonPath: pyExecPath,
    pythonOptions: ['-OO'],
};
class MyPyShell extends python_shell_1.PythonShell {
    constructor(scriptPath, options) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        let json = false;
        if (options.mode && options.mode === "json") {
            delete options.mode;
            json = true;
        }
        super(scriptPath, options);
        this.json = json;
    }
    static handleArguments(scriptPath, options) {
        if (!util_1.bool(options)) {
            options = { args: [], pythonOptions: ['-OO'] };
        }
        else {
            if (options.args === undefined)
                options.args = [];
            if (options.pythonOptions === undefined)
                options.pythonOptions = ['-OO'];
        }
        if (scriptPath.startsWith('-m')) {
            scriptPath = scriptPath.slice(3);
            if (!options.pythonOptions) {
                options.pythonOptions = ['-m'];
            }
            else {
                if (!options.pythonOptions.includes('-m')) {
                    options.pythonOptions.push('-m');
                }
            }
        }
        options.args = [ROOT_PATH_ABS, ...options.args];
        if (DEBUG)
            options.args.push('debug');
        if (DRYRUN)
            options.args.push('dry-run');
        return [scriptPath, options];
    }
    async runAsync() {
        return new Promise((resolve, reject) => {
            const messages = [];
            let push = DEBUG;
            let warn = false;
            let error = false;
            this.on('message', message => {
                if (message.startsWith('TONODE')) {
                    if (message.includes('WARN')) {
                        warn = message.endsWith('START');
                    }
                    else if (message.includes('ERROR')) {
                        error = message.endsWith('START');
                    }
                    else if (message.includes('SEND')) {
                        if (message.endsWith('START')) {
                            push = true;
                        }
                        else {
                            push = DEBUG;
                        }
                    }
                    return;
                }
                if (push || warn || error) {
                    if (this.json) {
                        message = JSON.parse(message);
                    }
                    if (typeof message === "string") {
                        message = message.removeAll(MyPyShell.colorRegex);
                    }
                    if (push) {
                        return resolve(message);
                    }
                    else if (warn) {
                        console.warn(`TONODE_WARN:`, message);
                    }
                    else if (error) {
                        console.error(`TONODE_ERROR:`, message);
                    }
                }
            });
            this.end((err, code, signal) => {
                if (err)
                    reject(err);
                resolve(messages);
            });
        });
    }
    static run(scriptPath, options, callback) {
        [scriptPath, options] = MyPyShell.handleArguments(scriptPath, options);
        if (!callback) {
            callback = (err, output) => {
                if (err) {
                    console.error(err);
                }
                if (output) {
                    output = output.map(m => m.removeAll(MyPyShell.colorRegex));
                    console.log(`%c${scriptPath}\n`, 'font-weight: bold', output.join('\n'));
                }
            };
        }
        return python_shell_1.PythonShell.run(scriptPath, options, callback);
    }
}
exports.MyPyShell = MyPyShell;
MyPyShell.colorRegex = /.?\[\d{1,3}m/;
let isChecksModuleDone = NOPYTHON;
function isDone() {
    return isChecksModuleDone;
}
exports.isDone = isDone;
if (!NOPYTHON) {
    const Store = new (require("electron-store"))();
    console.log(`Store.path: `, Store.path);
    const PyChecksModule = new MyPyShell('-m checks', {
        args: [Store.path]
    });
    PyChecksModule.runAsync().then(msgs => {
        isChecksModuleDone = true;
        console.log('PyChecksModule msgs:', msgs.join('\n'));
    });
}
console.groupEnd();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLGtDQUErQjtBQUUvQixPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDcEMsK0NBQXNFO0FBRXRFLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0FBQ3JELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEtBQUssT0FBTyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUVySCwwQkFBVyxDQUFDLGNBQWMsR0FBRztJQUN6QixVQUFVLEVBQUcsVUFBVTtJQUV2QixhQUFhLEVBQUcsQ0FBRSxLQUFLLENBQUU7Q0FDNUIsQ0FBQztBQUVGLE1BQU0sU0FBVSxTQUFRLDBCQUFXO0lBSS9CLFlBQVksVUFBa0IsRUFBRSxPQUFpQjtRQUM3QyxDQUFFLFVBQVUsRUFBRSxPQUFPLENBQUUsR0FBRyxTQUFTLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN6RSxJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7UUFDakIsSUFBSyxPQUFPLENBQUMsSUFBSSxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssTUFBTSxFQUFHO1lBQzNDLE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQztZQUNwQixJQUFJLEdBQUcsSUFBSSxDQUFDO1NBQ2Y7UUFDRCxLQUFLLENBQUMsVUFBVSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBRXJCLENBQUM7SUFFRCxNQUFNLENBQUMsZUFBZSxDQUFDLFVBQWtCLEVBQUUsT0FBaUI7UUFDeEQsSUFBSyxDQUFDLFdBQUksQ0FBQyxPQUFPLENB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Q0FBQyxDQUFDO2lCQUU1RTtZQUNMLENBQUMsQ0FBQTtTQUNKO1FBQ0QsT0FBTywwQkFBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ3pELENBQUM7O0FBbURZLDhCQUFTO0FBaktOLG9CQUFVLEdBQUcsY0FBYyxDQUFDO0FBaUhoRCxJQUFJLGtCQUFrQixHQUFHLFFBQVEsQ0FBQztBQUVsQyxTQUFTLE1BQU07SUFFWCxPQUFPLGtCQUFrQixDQUFBO0FBQzdCLENBQUM7QUEyQ1Esd0JBQU07QUF6Q2YsSUFBSyxDQUFDLFFBQVEsRUFBRztJQUdiLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFHaEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3hDLE1BQU0sY0FBYyxHQUFHLElBQUksU0FBUyxDQUFDLFdBQVcsRUFBRTtRQUM5QyxJQUFJLEVBQUcsQ0FBRSxLQUFLLENBQUMsSUFBSSxDQUFFO0tBQ3hCLENBQUMsQ0FBQztJQUNILGNBQWMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDbEMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDO1FBQzFCLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQyxDQUFDO0NBQ047QUE0QkQsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgYm9vbCB9IGZyb20gXCIuLi91dGlsXCI7XG5cbmNvbnNvbGUuZ3JvdXAoJ015UHlTaGVsbC5pbmRleC50cycpO1xuaW1wb3J0IHsgT3B0aW9ucywgUHl0aG9uU2hlbGwsIFB5dGhvblNoZWxsRXJyb3IgfSBmcm9tICdweXRob24tc2hlbGwnO1xuXG5jb25zdCBlbmdpbmVQYXRoID0gcGF0aC5qb2luKFNSQ19QQVRIX0FCUywgXCJlbmdpbmVcIik7XG5jb25zdCBweUV4ZWNQYXRoID0gcGF0aC5qb2luKGVuZ2luZVBhdGgsIHByb2Nlc3MucGxhdGZvcm0gPT09IFwibGludXhcIiA/IFwiZW52L2Jpbi9weXRob25cIiA6IFwiZW52L1NjcmlwdHMvcHl0aG9uLmV4ZVwiKTtcblxuUHl0aG9uU2hlbGwuZGVmYXVsdE9wdGlvbnMgPSB7XG4gICAgcHl0aG9uUGF0aCA6IHB5RXhlY1BhdGgsXG4gICAgLy8gc2NyaXB0UGF0aCA6IGVuZ2luZVBhdGgsXG4gICAgcHl0aG9uT3B0aW9ucyA6IFsgJy1PTycgXSxcbn07XG5cbmNsYXNzIE15UHlTaGVsbCBleHRlbmRzIFB5dGhvblNoZWxsIHtcbiAgICBzdGF0aWMgcmVhZG9ubHkgY29sb3JSZWdleCA9IC8uP1xcW1xcZHsxLDN9bS87XG4gICAgcHJpdmF0ZSByZWFkb25seSBqc29uOiBib29sZWFuO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKHNjcmlwdFBhdGg6IHN0cmluZywgb3B0aW9ucz86IE9wdGlvbnMpIHtcbiAgICAgICAgWyBzY3JpcHRQYXRoLCBvcHRpb25zIF0gPSBNeVB5U2hlbGwuaGFuZGxlQXJndW1lbnRzKHNjcmlwdFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICBsZXQganNvbiA9IGZhbHNlO1xuICAgICAgICBpZiAoIG9wdGlvbnMubW9kZSAmJiBvcHRpb25zLm1vZGUgPT09IFwianNvblwiICkge1xuICAgICAgICAgICAgZGVsZXRlIG9wdGlvbnMubW9kZTtcbiAgICAgICAgICAgIGpzb24gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHN1cGVyKHNjcmlwdFBhdGgsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmpzb24gPSBqc29uO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgc3RhdGljIGhhbmRsZUFyZ3VtZW50cyhzY3JpcHRQYXRoOiBzdHJpbmcsIG9wdGlvbnM/OiBPcHRpb25zKTogWyBzdHJpbmcsIE9wdGlvbnMgXSB7XG4gICAgICAgIGlmICggIWJvb2wob3B0aW9ucykgKSB7XG4gICAgICAgICAgICBvcHRpb25zID0geyBhcmdzIDogW10sIHB5dGhvbk9wdGlvbnMgOiBbICctT08nIF0gfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmICggb3B0aW9ucy5hcmdzID09PSB1bmRlZmluZWQgKVxuICAgICAgICAgICAgICAgIG9wdGlvbnMuYXJncyA9IFtdO1xuICAgICAgICAgICAgaWYgKCBvcHRpb25zLnB5dGhvbk9wdGlvbnMgPT09IHVuZGVmaW5lZCApXG4gICAgICAgICAgICAgICAgb3B0aW9ucy5weXRob25PcHRpb25zID0gWyAnLU9PJyBdO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCBzY3JpcHRQYXRoLnN0YXJ0c1dpdGgoJy1tJykgKSB7XG4gICAgICAgICAgICBzY3JpcHRQYXRoID0gc2NyaXB0UGF0aC5zbGljZSgzKTtcbiAgICAgICAgICAgIGlmICggIW9wdGlvbnMucHl0aG9uT3B0aW9ucyApIHtcbiAgICAgICAgICAgICAgICBvcHRpb25zLnB5dGhvbk9wdGlvbnMgPSBbICctbScgXVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoICFvcHRpb25zLnB5dGhvbk9wdGlvbnMuaW5jbHVkZXMoJy1tJykgKSB7XG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMucHl0aG9uT3B0aW9ucy5wdXNoKCctbScpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBvcHRpb25zLmFyZ3MgPSBbIFJPT1RfUEFUSF9BQlMsIC4uLm9wdGlvbnMuYXJncyBdO1xuICAgICAgICBpZiAoIERFQlVHIClcbiAgICAgICAgICAgIG9wdGlvbnMuYXJncy5wdXNoKCdkZWJ1ZycpO1xuICAgICAgICBpZiAoIERSWVJVTiApXG4gICAgICAgICAgICBvcHRpb25zLmFyZ3MucHVzaCgnZHJ5LXJ1bicpO1xuICAgICAgICByZXR1cm4gWyBzY3JpcHRQYXRoLCBvcHRpb25zIF1cbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgcnVuQXN5bmMoKTogUHJvbWlzZTxUTWFwPGFueT4+IHtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlcyA9IFtdO1xuICAgICAgICAgICAgbGV0IHB1c2ggPSBERUJVRztcbiAgICAgICAgICAgIGxldCB3YXJuID0gZmFsc2U7XG4gICAgICAgICAgICBsZXQgZXJyb3IgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMub24oJ21lc3NhZ2UnLCBtZXNzYWdlID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIG1lc3NhZ2Uuc3RhcnRzV2l0aCgnVE9OT0RFJykgKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICggbWVzc2FnZS5pbmNsdWRlcygnV0FSTicpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgd2FybiA9IG1lc3NhZ2UuZW5kc1dpdGgoJ1NUQVJUJylcbiAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCBtZXNzYWdlLmluY2x1ZGVzKCdFUlJPUicpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3IgPSBtZXNzYWdlLmVuZHNXaXRoKCdTVEFSVCcpXG4gICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICggbWVzc2FnZS5pbmNsdWRlcygnU0VORCcpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCBtZXNzYWdlLmVuZHNXaXRoKCdTVEFSVCcpICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHB1c2ggPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwdXNoID0gREVCVUc7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGlmICggcHVzaCB8fCB3YXJuIHx8IGVycm9yICkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIHRoaXMuanNvbiApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnBhcnNlKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICggdHlwZW9mIG1lc3NhZ2UgPT09IFwic3RyaW5nXCIgKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5yZW1vdmVBbGwoTXlQeVNoZWxsLmNvbG9yUmVnZXgpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmICggcHVzaCApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNvbHZlKG1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIHdhcm4gKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYFRPTk9ERV9XQVJOOmAsIG1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIGVycm9yICkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgVE9OT0RFX0VSUk9SOmAsIG1lc3NhZ2UpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmVuZCgoZXJyLCBjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIGVyciApIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUobWVzc2FnZXMpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIHN0YXRpYyBydW4oc2NyaXB0UGF0aDogc3RyaW5nLCBvcHRpb25zPzogT3B0aW9ucywgY2FsbGJhY2s/OiAoZXJyPzogUHl0aG9uU2hlbGxFcnJvciwgb3V0cHV0PzogYW55W10pID0+IGFueSkge1xuICAgICAgICBbIHNjcmlwdFBhdGgsIG9wdGlvbnMgXSA9IE15UHlTaGVsbC5oYW5kbGVBcmd1bWVudHMoc2NyaXB0UGF0aCwgb3B0aW9ucyk7XG4gICAgICAgIGlmICggIWNhbGxiYWNrICkge1xuICAgICAgICAgICAgY2FsbGJhY2sgPSAoZXJyOiBQeXRob25TaGVsbEVycm9yLCBvdXRwdXQ6IGFueVtdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCBlcnIgKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCBvdXRwdXQgKSB7XG4gICAgICAgICAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dC5tYXAobSA9PiBtLnJlbW92ZUFsbChNeVB5U2hlbGwuY29sb3JSZWdleCkpO1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJWMke3NjcmlwdFBhdGh9XFxuYCwgJ2ZvbnQtd2VpZ2h0OiBib2xkJywgb3V0cHV0LmpvaW4oJ1xcbicpKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQeXRob25TaGVsbC5ydW4oc2NyaXB0UGF0aCwgb3B0aW9ucywgY2FsbGJhY2spXG4gICAgfVxufVxuXG5sZXQgaXNDaGVja3NNb2R1bGVEb25lID0gTk9QWVRIT047IC8vIGlmIE5PUFlUSE9OID09IHRydWUsIHRoZW4gd2UncmUgZG9uZS5cblxuZnVuY3Rpb24gaXNEb25lKCk6IGJvb2xlYW4ge1xuICAgIC8vIHJldHVybiBpc0NoZWNrc0RpcnNEb25lICYmIGlzQ2hlY2tzQ2ZnRG9uZVxuICAgIHJldHVybiBpc0NoZWNrc01vZHVsZURvbmVcbn1cblxuaWYgKCAhTk9QWVRIT04gKSB7XG4gICAgXG4gICAgXG4gICAgY29uc3QgU3RvcmUgPSBuZXcgKHJlcXVpcmUoXCJlbGVjdHJvbi1zdG9yZVwiKSkoKTtcbiAgICBcbiAgICBcbiAgICBjb25zb2xlLmxvZyhgU3RvcmUucGF0aDogYCwgU3RvcmUucGF0aCk7XG4gICAgY29uc3QgUHlDaGVja3NNb2R1bGUgPSBuZXcgTXlQeVNoZWxsKCctbSBjaGVja3MnLCB7XG4gICAgICAgIGFyZ3MgOiBbIFN0b3JlLnBhdGggXVxuICAgIH0pO1xuICAgIFB5Q2hlY2tzTW9kdWxlLnJ1bkFzeW5jKCkudGhlbihtc2dzID0+IHtcbiAgICAgICAgaXNDaGVja3NNb2R1bGVEb25lID0gdHJ1ZTtcbiAgICAgICAgY29uc29sZS5sb2coJ1B5Q2hlY2tzTW9kdWxlIG1zZ3M6JywgbXNncy5qb2luKCdcXG4nKSk7XG4gICAgfSk7XG59XG4vKmNvbnN0IFB5Q2hlY2tzRGlycyA9IG5ldyBNeVB5U2hlbGwoJ2NoZWNrcy5kaXJzJywge1xuIHB5dGhvbk9wdGlvbnMgOiBbICctbScsIF0sXG4gYXJncyA6IFsgUk9PVF9QQVRIX0FCUywgJ2RlYnVnJywgJ2RyeS1ydW4nIF1cbiB9KTtcbiBQeUNoZWNrc0RpcnMucnVuQXN5bmMoKS50aGVuKG1zZ3MgPT4ge1xuIGlzQ2hlY2tzRGlyc0RvbmUgPSB0cnVlO1xuIGNvbnNvbGUubG9nKCdQeUNoZWNrc0RpcnMgbXNnczonLCBtc2dzLmpvaW4oJ1xcbicpKTtcbiB9KTtcbiBcbiAvLyBNeVB5U2hlbGwucnVuKFwiLW0gY2hlY2tzLmRpcnNcIik7XG4gXG4gLy8gKiogIEVsZWN0cm9uIFN0b3JlXG4gY29uc3QgU3RvcmUgPSBuZXcgKHJlcXVpcmUoXCJlbGVjdHJvbi1zdG9yZVwiKSkoKTtcbiBcbiBcbiBjb25zb2xlLmxvZyhgU3RvcmUucGF0aDogYCwgU3RvcmUucGF0aCk7XG4gY29uc3QgUHlDaGVja3NDZmcgPSBuZXcgTXlQeVNoZWxsKCdjaGVja3MuY29uZmlnJywge1xuIHB5dGhvbk9wdGlvbnMgOiBbICctbScgXSxcbiBhcmdzIDogWyBST09UX1BBVEhfQUJTLCBTdG9yZS5wYXRoLCAnZGVidWcnLCAnZHJ5LXJ1bicgXVxuIH0pO1xuIFB5Q2hlY2tzQ2ZnLnJ1bkFzeW5jKCkudGhlbihtc2dzID0+IHtcbiBpc0NoZWNrc0NmZ0RvbmUgPSB0cnVlO1xuIGNvbnNvbGUubG9nKCdQeUNoZWNrc0NmZyBtc2dzOicsIG1zZ3Muam9pbignXFxuJykpO1xuIH0pO1xuIC8vIE15UHlTaGVsbC5ydW4oXCItbSBjaGVja3MuY29uZmlnXCIsIHsgYXJncyA6IFsgU3RvcmUucGF0aCBdIH0pOyovXG5cbmV4cG9ydCB7IGlzRG9uZSwgTXlQeVNoZWxsIH07XG5jb25zb2xlLmdyb3VwRW5kKCk7XG4iXX0=