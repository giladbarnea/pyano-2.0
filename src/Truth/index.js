"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
const MyFs_1 = require("../MyFs");
class File {
    constructor(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            throw new Error(`File constructor: passed 'absPathWithExt' is extensionless: ${absPathWithExt}`);
        }
        if (!path.isAbsolute(absPathWithExt)) {
            throw new Error(`File constructor: passed 'absPathWithExt' NOT absolute: ${absPathWithExt}`);
        }
        this._absPath = absPathWithExt;
    }
    get absPath() {
        return this._absPath;
    }
    set absPath(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            throw new Error(`File constructor: passed 'absPathWithExt' is extensionless: ${absPathWithExt}`);
        }
        if (!path.isAbsolute(absPathWithExt)) {
            throw new Error(`File constructor: passed 'absPathWithExt' NOT absolute: ${absPathWithExt}`);
        }
        this._absPath = absPathWithExt;
        fs.renameSync(this._absPath, absPathWithExt);
    }
    renameByOtherFile(other) {
        console.warn('called renameByOtherFile(), use set absPath instead');
        this.absPath = other.absPath;
    }
    renameByCTime() {
        const stats = fs.lstatSync(this.absPath);
        const datestr = stats.ctime.human();
        const newPath = MyFs_1.default.push_before_ext(this.absPath, `__CREATED_${datestr}`);
        console.log('renameByCTime() to: ', newPath);
        this.absPath = newPath;
    }
    async getBitrateAndHeight() {
        if (!this._absPath.endsWith('mp4') && !this._absPath.endsWith('mov')) {
            console.warn(`File: "${this._absPath}" isn't "mp4" or "mov"`);
            return undefined;
        }
        const { execSync } = require('child_process');
        const ffprobeCmd = `ffprobe -v quiet -print_format json -show_streams -show_format`;
        const probe = JSON.parse(execSync(`${ffprobeCmd} "${this._absPath}"`, { encoding: 'utf8' }));
        const { bit_rate, height } = probe.streams.find(s => s["codec_type"] === "video");
        return [bit_rate, height];
    }
    exists() {
        return fs.existsSync(this._absPath);
    }
    remove() {
        fs.unlinkSync(this._absPath);
    }
    size() {
        let { size } = fs.lstatSync(this._absPath);
        return size;
    }
}
class Txt {
    constructor(nameNoExt) {
        const absPath = path.join(TRUTHS_PATH_ABS, nameNoExt);
        this.base = new File(`${absPath}.txt`);
        this.on = new File(`${absPath}_on.txt`);
        this.off = new File(`${absPath}_off.txt`);
    }
    getAll() {
        return [this.base, this.on, this.off];
    }
    getExisting() {
        const existing = [];
        existing.push(this.base.exists() ? this.base : false);
        existing.push(this.on.exists() ? this.on : false);
        existing.push(this.off.exists() ? this.off : false);
        return existing;
    }
    allExist() {
        return (this.base.exists()
            && this.on.exists()
            && this.off.exists());
    }
    anyExist() {
        return (this.base.exists()
            || this.on.exists()
            || this.off.exists());
    }
    removeAll() {
        if (this.base.exists())
            this.base.remove();
        if (this.on.exists())
            this.on.remove();
        if (this.off.exists())
            this.off.remove();
    }
    renameByOtherTxt(other) {
        this.base.absPath = other.base.absPath;
        this.on.absPath = other.on.absPath;
        this.off.absPath = other.off.absPath;
    }
}
class Truth {
    constructor(nameNoExt) {
        let [name, ext] = MyFs_1.default.split_ext(nameNoExt);
        if (util_1.bool(ext)) {
            console.warn(`Truth ctor, passed name is not extensionless: ${nameNoExt}. Continuing with "${name}"`);
        }
        if (name.endsWith('off') || name.endsWith('on')) {
            name = `${name.upTo('_', true)}`;
            console.warn(`Passed path of "_on" or "_off" file and not base. Using name: "${name}"`);
        }
        this.name = name;
        this.txt = new Txt(name);
        const absPath = path.join(TRUTHS_PATH_ABS, name);
        this.midi = new File(`${absPath}.mid`);
        this.mp4 = new File(`${absPath}.mp4`);
        this.mov = new File(`${absPath}.mov`);
        this.onsets = new File(`${absPath}_onsets.json`);
    }
    numOfNotes() {
        if (!this.txt.on.exists()) {
            console.warn(`this.txt.on (${this.txt.on.absPath}) does not exist, returning undefined`);
            return undefined;
        }
        const strings = fs
            .readFileSync(this.txt.on.absPath, { encoding: 'utf8' })
            .split('\n');
        let notes = 0;
        for (let s of strings) {
            if (s.includes('\\')) {
                console.warn(`s includes backslash, ${this.txt.on}`);
            }
            else if (util_1.bool(s)) {
                notes++;
            }
        }
        return notes;
    }
}
exports.Truth = Truth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3Qix5QkFBd0I7QUFDeEIsa0NBQStCO0FBQy9CLGtDQUEwQjtBQUcxQixNQUFNLElBQUk7SUFPTixZQUFZLGNBQXNCO1FBQzlCLElBQUssQ0FBQyxXQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFHO1lBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQUMsK0RBQStELGNBQWMsRUFBRSxDQUFDLENBQUM7U0FDcEc7UUFDRCxJQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRztZQUNwQyxNQUFNLElBQUksS0FBSyxDQUFDLDJEQUEyRCxjQUFjLEVBQUUsQ0FBQyxDQUFDO1NBQ2hHO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxjQUFjLENBQUM7SUFLbkMsQ0FBQztJQUVELElBQUksT0FBTztRQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBR0QsSUFBSSxPQUFPLENBQUMsY0FBc0I7UUFDOUIsSUFBSyxDQUFDLFdBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUc7WUFDdkMsTUFBTSxJQUFJLEtBQUssQ0FBQywrREFBK0QsY0FBYyxFQUFFLENBQUMsQ0FBQztTQUNwRztRQUNELElBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxFQUFHO1lBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQUMsMkRBQTJELGNBQWMsRUFBRSxDQUFDLENBQUM7U0FDaEc7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLGNBQWMsQ0FBQztRQUMvQixFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQU1ELGlCQUFpQixDQUFDLEtB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QUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxPQUFPLE1BQU0sQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxPQUFPLE1BQU0sQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxPQUFPLGNBQWMsQ0FBQyxDQUFDO0lBRXJELENBQUM7SUFHRCxVQUFVO1FBQ04sSUFBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFHO1lBQ3pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sdUNBQXVDLENBQUMsQ0FBQztZQUN6RixPQUFPLFNBQVMsQ0FBQTtTQUNuQjtRQUNELE1BQU0sT0FBTyxHQUFHLEVBQUU7YUFDYixZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUUsUUFBUSxFQUFHLE1BQU0sRUFBRSxDQUFDO2FBQ3hELEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQixJQUFJLEtBQUssR0FBVyxDQUFDLENBQUM7UUFDdEIsS0FBTSxJQUFJLENBQUMsSUFBSSxPQUFPLEVBQUc7WUFDckIsSUFBSyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFHO2dCQUNwQixPQUFPLENBQUMsSUFBSSxDQUFDLHlCQUF5QixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7YUFDeEQ7aUJBQU0sSUFBSyxXQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUc7Z0JBQ2xCLEtBQUssRUFBRSxDQUFDO2FBQ1g7U0FFSjtRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQWhFRCxzQkFnRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcbmltcG9ydCB7IGJvb2wgfSBmcm9tIFwiLi4vdXRpbFwiO1xuaW1wb3J0IG15ZnMgZnJvbSAnLi4vTXlGcydcblxuLyoqQW4gb2JqZWN0IHdyYXBwaW5nIGFuIGFicyBwYXRoIHdpdGggZXh0ZW5zaW9uLiovXG5jbGFzcyBGaWxlIHtcbiAgICBcbiAgICAvKipUaGUgYWJzIHBhdGggV0lUSCBleHRlbnNpb24qL1xuICAgIHByaXZhdGUgX2Fic1BhdGg6IHN0cmluZztcbiAgICBcbiAgICBcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihhYnNQYXRoV2l0aEV4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICggIWJvb2wocGF0aC5leHRuYW1lKGFic1BhdGhXaXRoRXh0KSkgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGUgY29uc3RydWN0b3I6IHBhc3NlZCAnYWJzUGF0aFdpdGhFeHQnIGlzIGV4dGVuc2lvbmxlc3M6ICR7YWJzUGF0aFdpdGhFeHR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCAhcGF0aC5pc0Fic29sdXRlKGFic1BhdGhXaXRoRXh0KSApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZSBjb25zdHJ1Y3RvcjogcGFzc2VkICdhYnNQYXRoV2l0aEV4dCcgTk9UIGFic29sdXRlOiAke2Fic1BhdGhXaXRoRXh0fWApO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0aGlzLl9hYnNQYXRoID0gYWJzUGF0aFdpdGhFeHQ7XG4gICAgICAgIFxuICAgICAgICAvLyB0aGlzLnBhdGhOb0V4dCA9IG15ZnMucmVtb3ZlX2V4dChhYnNQYXRoV2l0aEV4dCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgZ2V0IGFic1BhdGgoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Fic1BhdGg7XG4gICAgfVxuICAgIFxuICAgIC8qKlNldHMgdGhpcy5fYWJzUGF0aCBhbmQgYWxzbyBSRU5BTUVTIHRoZSBhY3R1YWwgZmlsZS4qL1xuICAgIHNldCBhYnNQYXRoKGFic1BhdGhXaXRoRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCAhYm9vbChwYXRoLmV4dG5hbWUoYWJzUGF0aFdpdGhFeHQpKSApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZSBjb25zdHJ1Y3RvcjogcGFzc2VkICdhYnNQYXRoV2l0aEV4dCcgaXMgZXh0ZW5zaW9ubGVzczogJHthYnNQYXRoV2l0aEV4dH1gKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoICFwYXRoLmlzQWJzb2x1dGUoYWJzUGF0aFdpdGhFeHQpICkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlIGNvbnN0cnVjdG9yOiBwYXNzZWQgJ2Fic1BhdGhXaXRoRXh0JyBOT1QgYWJzb2x1dGU6ICR7YWJzUGF0aFdpdGhFeHR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYWJzUGF0aCA9IGFic1BhdGhXaXRoRXh0O1xuICAgICAgICBmcy5yZW5hbWVTeW5jKHRoaXMuX2Fic1BhdGgsIGFic1BhdGhXaXRoRXh0KTtcbiAgICB9XG4gICAgXG4gICAgLyp0b1N0cmluZygpIHtcbiAgICAgcmV0dXJuIHRoaXMucGF0aDtcbiAgICAgfSovXG4gICAgLyoqQGRlcHJlY2F0ZWQqL1xuICAgIHJlbmFtZUJ5T3RoZXJGaWxlKG90aGVyOiBGaWxlKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignY2FsbGVkIHJlbmFtZUJ5T3RoZXJGaWxlKCksIHVzZSBzZXQgYWJzUGF0aCBpbnN0ZWFkJyk7XG4gICAgICAgIHRoaXMuYWJzUGF0aCA9IG90aGVyLmFic1BhdGg7XG4gICAgfVxuICAgIFxuICAgIHJlbmFtZUJ5Q1RpbWUoKSB7XG4gICAgICAgIGNvbnN0IHN0YXRzID0gZnMubHN0YXRTeW5jKHRoaXMuYWJzUGF0aCk7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgZGF0ZXN0ciA9IHN0YXRzLmN0aW1lLmh1bWFuKCk7XG4gICAgICAgIGNvbnN0IG5ld1BhdGggPSBteWZzLnB1c2hfYmVmb3JlX2V4dCh0aGlzLmFic1BhdGgsIGBfX0NSRUFURURfJHtkYXRlc3RyfWApO1xuICAgICAgICBjb25zb2xlLmxvZygncmVuYW1lQnlDVGltZSgpIHRvOiAnLCBuZXdQYXRoKTtcbiAgICAgICAgdGhpcy5hYnNQYXRoID0gbmV3UGF0aDtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgZ2V0Qml0cmF0ZUFuZEhlaWdodCgpOiBQcm9taXNlPFsgc3RyaW5nLCBzdHJpbmcgXT4ge1xuICAgICAgICBpZiAoICF0aGlzLl9hYnNQYXRoLmVuZHNXaXRoKCdtcDQnKSAmJiAhdGhpcy5fYWJzUGF0aC5lbmRzV2l0aCgnbW92JykgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYEZpbGU6IFwiJHt0aGlzLl9hYnNQYXRofVwiIGlzbid0IFwibXA0XCIgb3IgXCJtb3ZcImApO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgZXhlY1N5bmMgfSA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbiAgICAgICAgY29uc3QgZmZwcm9iZUNtZCA9IGBmZnByb2JlIC12IHF1aWV0IC1wcmludF9mb3JtYXQganNvbiAtc2hvd19zdHJlYW1zIC1zaG93X2Zvcm1hdGA7XG4gICAgICAgIGNvbnN0IHByb2JlID0gSlNPTi5wYXJzZShleGVjU3luYyhgJHtmZnByb2JlQ21kfSBcIiR7dGhpcy5fYWJzUGF0aH1cImAsIHsgZW5jb2RpbmcgOiAndXRmOCcgfSkpO1xuICAgICAgICBjb25zdCB7IGJpdF9yYXRlLCBoZWlnaHQgfSA9IHByb2JlLnN0cmVhbXMuZmluZChzID0+IHNbXCJjb2RlY190eXBlXCJdID09PSBcInZpZGVvXCIpO1xuICAgICAgICByZXR1cm4gWyBiaXRfcmF0ZSwgaGVpZ2h0IF07XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGV4aXN0cygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGZzLmV4aXN0c1N5bmModGhpcy5fYWJzUGF0aCk7XG4gICAgfVxuICAgIFxuICAgIHJlbW92ZSgpIHtcbiAgICAgICAgZnMudW5saW5rU3luYyh0aGlzLl9hYnNQYXRoKTtcbiAgICB9XG4gICAgXG4gICAgc2l6ZSgpOiBudW1iZXIge1xuICAgICAgICBsZXQgeyBzaXplIH0gPSBmcy5sc3RhdFN5bmModGhpcy5fYWJzUGF0aCk7XG4gICAgICAgIHJldHVybiBzaXplO1xuICAgIH1cbn1cblxuY2xhc3MgVHh0IHtcbiAgICAvKipBIEZpbGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWJzb2x1dGUgYGAqLnR4dGBgIHBhdGguKi9cbiAgICByZWFkb25seSBiYXNlOiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBhYnNvbHV0ZSBgYCpfb24udHh0YGAgIHBhdGguKi9cbiAgICByZWFkb25seSBvbjogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWJzb2x1dGUgYGAqX29mZi50eHRgYCBwYXRoLiovXG4gICAgcmVhZG9ubHkgb2ZmOiBGaWxlO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKG5hbWVOb0V4dDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IGFic1BhdGggPSBwYXRoLmpvaW4oVFJVVEhTX1BBVEhfQUJTLCBuYW1lTm9FeHQpO1xuICAgICAgICB0aGlzLmJhc2UgPSBuZXcgRmlsZShgJHthYnNQYXRofS50eHRgKTtcbiAgICAgICAgdGhpcy5vbiA9IG5ldyBGaWxlKGAke2Fic1BhdGh9X29uLnR4dGApO1xuICAgICAgICB0aGlzLm9mZiA9IG5ldyBGaWxlKGAke2Fic1BhdGh9X29mZi50eHRgKTtcbiAgICB9XG4gICAgXG4gICAgZ2V0QWxsKCk6IFsgRmlsZSwgRmlsZSwgRmlsZSBdIHtcbiAgICAgICAgcmV0dXJuIFsgdGhpcy5iYXNlLCB0aGlzLm9uLCB0aGlzLm9mZiBdO1xuICAgIH1cbiAgICBcbiAgICBcbiAgICBnZXRFeGlzdGluZygpOiBbIChGaWxlIHwgZmFsc2UpLCAoRmlsZSB8IGZhbHNlKSwgKEZpbGUgfCBmYWxzZSkgXSB7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gW107XG4gICAgICAgIGV4aXN0aW5nLnB1c2godGhpcy5iYXNlLmV4aXN0cygpID8gdGhpcy5iYXNlIDogZmFsc2UpO1xuICAgICAgICBleGlzdGluZy5wdXNoKHRoaXMub24uZXhpc3RzKCkgPyB0aGlzLm9uIDogZmFsc2UpO1xuICAgICAgICBleGlzdGluZy5wdXNoKHRoaXMub2ZmLmV4aXN0cygpID8gdGhpcy5vZmYgOiBmYWxzZSk7XG4gICAgICAgIFxuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIHJldHVybiBleGlzdGluZztcbiAgICB9XG4gICAgXG4gICAgYWxsRXhpc3QoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmJhc2UuZXhpc3RzKClcbiAgICAgICAgICAgICYmIHRoaXMub24uZXhpc3RzKClcbiAgICAgICAgICAgICYmIHRoaXMub2ZmLmV4aXN0cygpXG4gICAgICAgICk7XG4gICAgfVxuICAgIFxuICAgIGFueUV4aXN0KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5iYXNlLmV4aXN0cygpXG4gICAgICAgICAgICB8fCB0aGlzLm9uLmV4aXN0cygpXG4gICAgICAgICAgICB8fCB0aGlzLm9mZi5leGlzdHMoKVxuICAgICAgICApO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcmVtb3ZlQWxsKCk6IHZvaWQge1xuICAgICAgICBpZiAoIHRoaXMuYmFzZS5leGlzdHMoKSApXG4gICAgICAgICAgICB0aGlzLmJhc2UucmVtb3ZlKCk7XG4gICAgICAgIGlmICggdGhpcy5vbi5leGlzdHMoKSApXG4gICAgICAgICAgICB0aGlzLm9uLnJlbW92ZSgpO1xuICAgICAgICBpZiAoIHRoaXMub2ZmLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMub2ZmLnJlbW92ZSgpO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcmVuYW1lQnlPdGhlclR4dChvdGhlcjogVHh0KTogdm9pZCB7XG4gICAgICAgIC8vIGNvbnNvbGUud2FybigncmVuYW1lQnlPdGhlclR4dDogZGlkbnQgc2V0IG5ldyB0aGlzIGJhc2UgLyBvbiAvIG9mZicpO1xuICAgICAgICB0aGlzLmJhc2UuYWJzUGF0aCA9IG90aGVyLmJhc2UuYWJzUGF0aDtcbiAgICAgICAgdGhpcy5vbi5hYnNQYXRoID0gb3RoZXIub24uYWJzUGF0aDtcbiAgICAgICAgdGhpcy5vZmYuYWJzUGF0aCA9IG90aGVyLm9mZi5hYnNQYXRoO1xuICAgICAgICAvLyBmcy5yZW5hbWVTeW5jKHRoaXMuYmFzZS5wYXRoLCBvdGhlci5iYXNlLnBhdGgpO1xuICAgICAgICAvLyBmcy5yZW5hbWVTeW5jKHRoaXMub24ucGF0aCwgb3RoZXIub24ucGF0aCk7XG4gICAgICAgIC8vIGZzLnJlbmFtZVN5bmModGhpcy5vZmYucGF0aCwgb3RoZXIub2ZmLnBhdGgpO1xuICAgICAgICBcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUcnV0aCB7XG4gICAgLy8gLyoqVGhlIGFic29sdXRlIHBhdGggd2l0aG91dCBleHRlbnNpb24uKi9cbiAgICAvLyBwcml2YXRlIHJlYWRvbmx5IHBhdGhOb0V4dDogc3RyaW5nO1xuICAgIC8qKlRoZSBiYXNlbmFtZSB3aXRob3V0IGV4dGVuc2lvbi4qL1xuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgICByZWFkb25seSB0eHQ6IFR4dDtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBtaWRpIGZpbGUuKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IG1pZGk6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbXA0IGZpbGUuKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IG1wNDogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBtb3YgZmlsZS4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbW92OiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG9uc2V0cyBmaWxlLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBvbnNldHM6IEZpbGU7XG4gICAgXG4gICAgY29uc3RydWN0b3IobmFtZU5vRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IFsgbmFtZSwgZXh0IF0gPSBteWZzLnNwbGl0X2V4dChuYW1lTm9FeHQpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCBib29sKGV4dCkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFRydXRoIGN0b3IsIHBhc3NlZCBuYW1lIGlzIG5vdCBleHRlbnNpb25sZXNzOiAke25hbWVOb0V4dH0uIENvbnRpbnVpbmcgd2l0aCBcIiR7bmFtZX1cImApO1xuICAgICAgICAgICAgLy8gbmFtZU5vRXh0ID0gbXlmcy5yZW1vdmVfZXh0KG5hbWVOb0V4dCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCBuYW1lLmVuZHNXaXRoKCdvZmYnKSB8fCBuYW1lLmVuZHNXaXRoKCdvbicpICkge1xuICAgICAgICAgICAgLy8gVE9ETzogVEhJUyBJUyBCVUdHWVxuICAgICAgICAgICAgLy8gbGV0IG5vRXh0ID0gbXlmcy5yZW1vdmVfZXh0KG5hbWUpO1xuICAgICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgICAgbmFtZSA9IGAke25hbWUudXBUbygnXycsIHRydWUpfWA7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFBhc3NlZCBwYXRoIG9mIFwiX29uXCIgb3IgXCJfb2ZmXCIgZmlsZSBhbmQgbm90IGJhc2UuIFVzaW5nIG5hbWU6IFwiJHtuYW1lfVwiYCk7XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnR4dCA9IG5ldyBUeHQobmFtZSk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBhYnNQYXRoID0gcGF0aC5qb2luKFRSVVRIU19QQVRIX0FCUywgbmFtZSk7XG4gICAgICAgIHRoaXMubWlkaSA9IG5ldyBGaWxlKGAke2Fic1BhdGh9Lm1pZGApO1xuICAgICAgICB0aGlzLm1wNCA9IG5ldyBGaWxlKGAke2Fic1BhdGh9Lm1wNGApO1xuICAgICAgICB0aGlzLm1vdiA9IG5ldyBGaWxlKGAke2Fic1BhdGh9Lm1vdmApO1xuICAgICAgICB0aGlzLm9uc2V0cyA9IG5ldyBGaWxlKGAke2Fic1BhdGh9X29uc2V0cy5qc29uYCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICAvKipDb3VudHMgdGhlIG51bWJlciBvZiBub24tZW1wdHkgbGluZXMgaW4gdGhlIHR4dCBvbiBwYXRoIGZpbGUuKi9cbiAgICBudW1PZk5vdGVzKCk6IG51bWJlciB7XG4gICAgICAgIGlmICggIXRoaXMudHh0Lm9uLmV4aXN0cygpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGB0aGlzLnR4dC5vbiAoJHt0aGlzLnR4dC5vbi5hYnNQYXRofSkgZG9lcyBub3QgZXhpc3QsIHJldHVybmluZyB1bmRlZmluZWRgKTtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdHJpbmdzID0gZnNcbiAgICAgICAgICAgIC5yZWFkRmlsZVN5bmModGhpcy50eHQub24uYWJzUGF0aCwgeyBlbmNvZGluZyA6ICd1dGY4JyB9KVxuICAgICAgICAgICAgLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgbGV0IG5vdGVzOiBudW1iZXIgPSAwO1xuICAgICAgICBmb3IgKCBsZXQgcyBvZiBzdHJpbmdzICkge1xuICAgICAgICAgICAgaWYgKCBzLmluY2x1ZGVzKCdcXFxcJykgKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBzIGluY2x1ZGVzIGJhY2tzbGFzaCwgJHt0aGlzLnR4dC5vbn1gKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGJvb2wocykgKSB7XG4gICAgICAgICAgICAgICAgbm90ZXMrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBub3RlcztcbiAgICB9XG59XG4iXX0=