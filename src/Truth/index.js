"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
const MyFs_1 = require("../MyFs");
class File {
    constructor(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            console.error(`File constructor: passed 'absPathWithExt' is extensionless: ${absPathWithExt}. Returning`);
        }
        if (!path.isAbsolute(absPathWithExt)) {
            console.error(`File constructor: passed 'absPathWithExt' NOT absolute: ${absPathWithExt}. Returning`);
        }
        this._absPath = absPathWithExt;
    }
    get absPath() {
        return this._absPath;
    }
    set absPath(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            console.error(`File set absPath: passed extensionless 'absPathWithExt': ${absPathWithExt}. Not setting`);
            return;
        }
        if (!path.isAbsolute(absPathWithExt)) {
            console.error(`File set absPath: passed non-absolute 'absPathWithExt': ${absPathWithExt}. Not setting`);
            return;
        }
        this._absPath = absPathWithExt;
        fs.renameSync(this._absPath, absPathWithExt);
    }
    renameByOtherFile(other) {
        console.warn('called renameByOtherFile(), use set absPath instead');
        this.absPath = other.absPath;
    }
    renameByCTime() {
        const stats = fs.lstatSync(this.absPath);
        const datestr = stats.ctime.human();
        const newPath = MyFs_1.default.push_before_ext(this.absPath, `__CREATED_${datestr}`);
        console.log('renameByCTime() to: ', newPath);
        this.absPath = newPath;
    }
    async getBitrateAndHeight() {
        if (!this._absPath.endsWith('mp4') && !this._absPath.endsWith('mov')) {
            console.warn(`File: "${this._absPath}" isn't "mp4" or "mov"`);
            return undefined;
        }
        const { execSync } = require('child_process');
        const ffprobeCmd = `ffprobe -v quiet -print_format json -show_streams -show_format`;
        const probe = JSON.parse(execSync(`${ffprobeCmd} "${this._absPath}"`, { encoding: 'utf8' }));
        const { bit_rate, height } = probe.streams.find(s => s["codec_type"] === "video");
        return [bit_rate, height];
    }
    exists() {
        return fs.existsSync(this._absPath);
    }
    remove() {
        fs.unlinkSync(this._absPath);
    }
    size() {
        let { size } = fs.lstatSync(this._absPath);
        return size;
    }
}
class Txt {
    constructor(absPathNoExt) {
        if (!path.isAbsolute(absPathNoExt)) {
            console.error(`Txt constructor: passed 'absPathNoExt' NOT absolute: ${absPathNoExt}. returning`);
            return;
        }
        if (util_1.bool(path.extname(absPathNoExt))) {
            console.warn(`File constructor: passed 'absPathNoExt' is NOT extensionless: ${absPathNoExt}. Removing ext`);
            absPathNoExt = MyFs_1.default.remove_ext(absPathNoExt);
        }
        this.base = new File(`${absPathNoExt}.txt`);
        this.on = new File(`${absPathNoExt}_on.txt`);
        this.off = new File(`${absPathNoExt}_off.txt`);
    }
    getAll() {
        return [this.base, this.on, this.off];
    }
    getExisting() {
        const files = {
            base: this.base.exists() ? this.base : undefined,
            on: this.on.exists() ? this.on : undefined,
            off: this.off.exists() ? this.off : undefined,
        };
        return files;
    }
    getMissing() {
        const files = [];
        if (!this.base.exists()) {
            files.push("base");
        }
        if (!this.on.exists()) {
            files.push("on");
        }
        if (!this.off.exists()) {
            files.push("off");
        }
        return files;
    }
    allExist() {
        return (this.base.exists()
            && this.on.exists()
            && this.off.exists());
    }
    anyExist() {
        return (this.base.exists()
            || this.on.exists()
            || this.off.exists());
    }
    removeAll() {
        if (this.base.exists())
            this.base.remove();
        if (this.on.exists())
            this.on.remove();
        if (this.off.exists())
            this.off.remove();
    }
    renameByOtherTxt(other) {
        this.base.absPath = other.base.absPath;
        this.on.absPath = other.on.absPath;
        this.off.absPath = other.off.absPath;
    }
}
class Truth {
    constructor(nameNoExt, dir) {
        let [name, ext] = MyFs_1.default.split_ext(nameNoExt);
        if (util_1.bool(ext)) {
            console.warn(`Truth ctor, passed name is not extensionless: ${nameNoExt}. Continuing with "${name}"`);
        }
        if (name.endsWithAny('_off', '_on')) {
            name = `${name.upTo('_', true)}`;
            console.warn(`Passed path of "_on" or "_off" file and not base. Using name: "${name}"`);
        }
        this.name = name;
        if (!util_1.bool(dir)) {
            dir = TRUTHS_PATH_ABS;
        }
        const absPathNoExt = path.join(dir, name);
        this.txt = new Txt(absPathNoExt);
        this.midi = new File(`${absPathNoExt}.mid`);
        this.mp4 = new File(`${absPathNoExt}.mp4`);
        this.mov = new File(`${absPathNoExt}.mov`);
        this.onsets = new File(`${absPathNoExt}_onsets.json`);
    }
    toReadOnly(...include) {
        let readonlyTruth = {};
        const readonlyTxt = () => ({
            base: {
                absPath: this.txt.base.absPath
            },
            on: {
                absPath: this.txt.on.absPath
            },
            off: {
                absPath: this.txt.off.absPath
            }
        });
        const readonlySubFile = (subfile) => ({
            absPath: this[subfile].absPath
        });
        if (util_1.bool(include)) {
            for (let inc of include) {
                switch (inc) {
                    case "txt":
                        readonlyTruth.txt = readonlyTxt();
                        break;
                    case "midi":
                        readonlyTruth.midi = readonlySubFile("midi");
                        break;
                    case "mp4":
                        readonlyTruth.mp4 = readonlySubFile("mp4");
                        break;
                    case "onsets":
                        readonlyTruth.onsets = readonlySubFile("onsets");
                        break;
                }
            }
        }
        else {
            readonlyTruth = {
                name: this.name,
                txt: readonlyTxt(),
                mp4: readonlySubFile("mp4"),
                onsets: readonlySubFile("onsets"),
                midi: readonlySubFile("midi")
            };
        }
        return readonlyTruth;
    }
    numOfNotes() {
        if (!this.txt.on.exists()) {
            console.warn(`this.txt.on (${this.txt.on.absPath}) does not exist, returning undefined`);
            return undefined;
        }
        const strings = fs
            .readFileSync(this.txt.on.absPath, { encoding: 'utf8' })
            .split('\n');
        let notes = 0;
        for (let s of strings) {
            if (s.includes('\\')) {
                console.warn(`s includes backslash, ${this.txt.on}`);
            }
            else if (util_1.bool(s)) {
                notes++;
            }
        }
        return notes;
    }
}
exports.Truth = Truth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3Qix5QkFBd0I7QUFDeEIsa0NBQStCO0FBQy9CLGtDQUEwQjtBQUcxQixNQUFNLElBQUk7SUFNTixZQUFZLGNBQXNCO1FBQzlCLElBQUssQ0FBQyxXQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFHO1lBQ3ZDLE9BQU8sQ0FBQyxLQUFLLENBQUMsK0RBQStELGNBQWMsYUFBYSxDQUFDLENBQUM7U0FDN0c7UUFDRCxJQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRztZQUNwQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJEQUEyRCxjQUFjLGFBQWEsQ0FBQyxDQUFDO1NBQ3pHO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxjQUFjLENBQUM7SUFLbkMsQ0FBQztJQUdELElBQUksT0FBTztRQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBR0QsSUFBSSxPQUFPLENBQUMsY0FBc0I7UUFDOUIsSUFBSyxDQUFDLFdBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUc7WUFDdkMsT0FBTyxDQUFDLEtBQUssQ0FBQyw0REFBNEQsY0FBYyxlQUFlLENBQUMsQ0FBQztZQUN6RyxPQUFPO1NBQ1Y7UUFDRCxJQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRztZQUNwQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJEQUEyRCxjQUFjLGVBQWUsQ0FBQyxDQUFDO1lBQ3hHLE9BQU87U0FDVjtRQUNELElBQUksQ0FBQyxRQUFRLEdBQUcsY0FBYyxDQUFDO1FBQy9CLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUNqRCxDQUFD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QVEsQ0FBQztnQkFDbEMsSUFBSSxFQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUM7YUFDakMsQ0FBQTtTQUNKO1FBQ0QsT0FBTyxhQUFhLENBQUM7SUFFekIsQ0FBQztJQUdELFVBQVU7UUFDTixJQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUc7WUFDekIsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsT0FBTyx1Q0FBdUMsQ0FBQyxDQUFDO1lBQ3pGLE9BQU8sU0FBUyxDQUFBO1NBQ25CO1FBQ0QsTUFBTSxPQUFPLEdBQUcsRUFBRTthQUNiLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRSxRQUFRLEVBQUcsTUFBTSxFQUFFLENBQUM7YUFDeEQsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pCLElBQUksS0FBSyxHQUFXLENBQUMsQ0FBQztRQUN0QixLQUFNLElBQUksQ0FBQyxJQUFJLE9BQU8sRUFBRztZQUNyQixJQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUc7Z0JBQ3BCLE9BQU8sQ0FBQyxJQUFJLENBQUMseUJBQXlCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQzthQUN4RDtpQkFBTSxJQUFLLFdBQUksQ0FBQyxDQUFDLENBQUMsRUFBRztnQkFDbEIsS0FBSyxFQUFFLENBQUM7YUFDWDtTQUVKO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUNKO0FBakhELHNCQWlIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IHsgYm9vbCB9IGZyb20gXCIuLi91dGlsXCI7XG5pbXBvcnQgbXlmcyBmcm9tICcuLi9NeUZzJ1xuXG4vKipBbiBvYmplY3Qgd3JhcHBpbmcgYW4gYWJzIHBhdGggd2l0aCBleHRlbnNpb24uKi9cbmNsYXNzIEZpbGUge1xuICAgIFxuICAgIC8qKlRoZSBhYnMgcGF0aCBXSVRIIGV4dGVuc2lvbiovXG4gICAgcHJpdmF0ZSBfYWJzUGF0aDogc3RyaW5nO1xuICAgIFxuICAgIFxuICAgIGNvbnN0cnVjdG9yKGFic1BhdGhXaXRoRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCAhYm9vbChwYXRoLmV4dG5hbWUoYWJzUGF0aFdpdGhFeHQpKSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZpbGUgY29uc3RydWN0b3I6IHBhc3NlZCAnYWJzUGF0aFdpdGhFeHQnIGlzIGV4dGVuc2lvbmxlc3M6ICR7YWJzUGF0aFdpdGhFeHR9LiBSZXR1cm5pbmdgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoICFwYXRoLmlzQWJzb2x1dGUoYWJzUGF0aFdpdGhFeHQpICkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRmlsZSBjb25zdHJ1Y3RvcjogcGFzc2VkICdhYnNQYXRoV2l0aEV4dCcgTk9UIGFic29sdXRlOiAke2Fic1BhdGhXaXRoRXh0fS4gUmV0dXJuaW5nYCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMuX2Fic1BhdGggPSBhYnNQYXRoV2l0aEV4dDtcbiAgICAgICAgXG4gICAgICAgIC8vIHRoaXMucGF0aE5vRXh0ID0gbXlmcy5yZW1vdmVfZXh0KGFic1BhdGhXaXRoRXh0KTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBcbiAgICBnZXQgYWJzUGF0aCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5fYWJzUGF0aDtcbiAgICB9XG4gICAgXG4gICAgLyoqU2V0cyB0aGlzLl9hYnNQYXRoIGFuZCBhbHNvIFJFTkFNRVMgdGhlIGFjdHVhbCBmaWxlLiovXG4gICAgc2V0IGFic1BhdGgoYWJzUGF0aFdpdGhFeHQ6IHN0cmluZykge1xuICAgICAgICBpZiAoICFib29sKHBhdGguZXh0bmFtZShhYnNQYXRoV2l0aEV4dCkpICkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRmlsZSBzZXQgYWJzUGF0aDogcGFzc2VkIGV4dGVuc2lvbmxlc3MgJ2Fic1BhdGhXaXRoRXh0JzogJHthYnNQYXRoV2l0aEV4dH0uIE5vdCBzZXR0aW5nYCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCAhcGF0aC5pc0Fic29sdXRlKGFic1BhdGhXaXRoRXh0KSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZpbGUgc2V0IGFic1BhdGg6IHBhc3NlZCBub24tYWJzb2x1dGUgJ2Fic1BhdGhXaXRoRXh0JzogJHthYnNQYXRoV2l0aEV4dH0uIE5vdCBzZXR0aW5nYCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5fYWJzUGF0aCA9IGFic1BhdGhXaXRoRXh0O1xuICAgICAgICBmcy5yZW5hbWVTeW5jKHRoaXMuX2Fic1BhdGgsIGFic1BhdGhXaXRoRXh0KTtcbiAgICB9XG4gICAgXG4gICAgLyp0b1N0cmluZygpIHtcbiAgICAgcmV0dXJuIHRoaXMucGF0aDtcbiAgICAgfSovXG4gICAgLyoqQGRlcHJlY2F0ZWQqL1xuICAgIHJlbmFtZUJ5T3RoZXJGaWxlKG90aGVyOiBGaWxlKSB7XG4gICAgICAgIGNvbnNvbGUud2FybignY2FsbGVkIHJlbmFtZUJ5T3RoZXJGaWxlKCksIHVzZSBzZXQgYWJzUGF0aCBpbnN0ZWFkJyk7XG4gICAgICAgIHRoaXMuYWJzUGF0aCA9IG90aGVyLmFic1BhdGg7XG4gICAgfVxuICAgIFxuICAgIHJlbmFtZUJ5Q1RpbWUoKSB7XG4gICAgICAgIGNvbnN0IHN0YXRzID0gZnMubHN0YXRTeW5jKHRoaXMuYWJzUGF0aCk7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgY29uc3QgZGF0ZXN0ciA9IHN0YXRzLmN0aW1lLmh1bWFuKCk7XG4gICAgICAgIGNvbnN0IG5ld1BhdGggPSBteWZzLnB1c2hfYmVmb3JlX2V4dCh0aGlzLmFic1BhdGgsIGBfX0NSRUFURURfJHtkYXRlc3RyfWApO1xuICAgICAgICBjb25zb2xlLmxvZygncmVuYW1lQnlDVGltZSgpIHRvOiAnLCBuZXdQYXRoKTtcbiAgICAgICAgdGhpcy5hYnNQYXRoID0gbmV3UGF0aDtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgZ2V0Qml0cmF0ZUFuZEhlaWdodCgpOiBQcm9taXNlPFsgc3RyaW5nLCBzdHJpbmcgXT4ge1xuICAgICAgICBpZiAoICF0aGlzLl9hYnNQYXRoLmVuZHNXaXRoKCdtcDQnKSAmJiAhdGhpcy5fYWJzUGF0aC5lbmRzV2l0aCgnbW92JykgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYEZpbGU6IFwiJHt0aGlzLl9hYnNQYXRofVwiIGlzbid0IFwibXA0XCIgb3IgXCJtb3ZcImApO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgZXhlY1N5bmMgfSA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbiAgICAgICAgY29uc3QgZmZwcm9iZUNtZCA9IGBmZnByb2JlIC12IHF1aWV0IC1wcmludF9mb3JtYXQganNvbiAtc2hvd19zdHJlYW1zIC1zaG93X2Zvcm1hdGA7XG4gICAgICAgIGNvbnN0IHByb2JlID0gSlNPTi5wYXJzZShleGVjU3luYyhgJHtmZnByb2JlQ21kfSBcIiR7dGhpcy5fYWJzUGF0aH1cImAsIHsgZW5jb2RpbmcgOiAndXRmOCcgfSkpO1xuICAgICAgICBjb25zdCB7IGJpdF9yYXRlLCBoZWlnaHQgfSA9IHByb2JlLnN0cmVhbXMuZmluZChzID0+IHNbXCJjb2RlY190eXBlXCJdID09PSBcInZpZGVvXCIpO1xuICAgICAgICByZXR1cm4gWyBiaXRfcmF0ZSwgaGVpZ2h0IF07XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGV4aXN0cygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGZzLmV4aXN0c1N5bmModGhpcy5fYWJzUGF0aCk7XG4gICAgfVxuICAgIFxuICAgIHJlbW92ZSgpIHtcbiAgICAgICAgZnMudW5saW5rU3luYyh0aGlzLl9hYnNQYXRoKTtcbiAgICB9XG4gICAgXG4gICAgc2l6ZSgpOiBudW1iZXIge1xuICAgICAgICBsZXQgeyBzaXplIH0gPSBmcy5sc3RhdFN5bmModGhpcy5fYWJzUGF0aCk7XG4gICAgICAgIHJldHVybiBzaXplO1xuICAgIH1cbn1cblxuXG5jbGFzcyBUeHQge1xuICAgIC8qKkEgRmlsZSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBhYnNvbHV0ZSBgYCoudHh0YGAgcGF0aC4qL1xuICAgIHJlYWRvbmx5IGJhc2U6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKl9vbi50eHRgYCAgcGF0aC4qL1xuICAgIHJlYWRvbmx5IG9uOiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBhYnNvbHV0ZSBgYCpfb2ZmLnR4dGBgIHBhdGguKi9cbiAgICByZWFkb25seSBvZmY6IEZpbGU7XG4gICAgXG4gICAgXG4gICAgY29uc3RydWN0b3IoYWJzUGF0aE5vRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCAhcGF0aC5pc0Fic29sdXRlKGFic1BhdGhOb0V4dCkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBUeHQgY29uc3RydWN0b3I6IHBhc3NlZCAnYWJzUGF0aE5vRXh0JyBOT1QgYWJzb2x1dGU6ICR7YWJzUGF0aE5vRXh0fS4gcmV0dXJuaW5nYCk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCBib29sKHBhdGguZXh0bmFtZShhYnNQYXRoTm9FeHQpKSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgRmlsZSBjb25zdHJ1Y3RvcjogcGFzc2VkICdhYnNQYXRoTm9FeHQnIGlzIE5PVCBleHRlbnNpb25sZXNzOiAke2Fic1BhdGhOb0V4dH0uIFJlbW92aW5nIGV4dGApO1xuICAgICAgICAgICAgYWJzUGF0aE5vRXh0ID0gbXlmcy5yZW1vdmVfZXh0KGFic1BhdGhOb0V4dCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5iYXNlID0gbmV3IEZpbGUoYCR7YWJzUGF0aE5vRXh0fS50eHRgKTtcbiAgICAgICAgdGhpcy5vbiA9IG5ldyBGaWxlKGAke2Fic1BhdGhOb0V4dH1fb24udHh0YCk7XG4gICAgICAgIHRoaXMub2ZmID0gbmV3IEZpbGUoYCR7YWJzUGF0aE5vRXh0fV9vZmYudHh0YCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBnZXRBbGwoKTogWyBGaWxlLCBGaWxlLCBGaWxlIF0ge1xuICAgICAgICByZXR1cm4gWyB0aGlzLmJhc2UsIHRoaXMub24sIHRoaXMub2ZmIF07XG4gICAgfVxuICAgIFxuICAgIFxuICAgIC8vIGdldEV4aXN0aW5nKCk6IFsgKEZpbGUgfCBmYWxzZSksIChGaWxlIHwgZmFsc2UpLCAoRmlsZSB8IGZhbHNlKSBdIHtcbiAgICBnZXRFeGlzdGluZygpOiB7IGJhc2U/OiBGaWxlLCBvbj86IEZpbGUsIG9mZj86IEZpbGUgfSB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0ge1xuICAgICAgICAgICAgYmFzZSA6IHRoaXMuYmFzZS5leGlzdHMoKSA/IHRoaXMuYmFzZSA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIG9uIDogdGhpcy5vbi5leGlzdHMoKSA/IHRoaXMub24gOiB1bmRlZmluZWQsXG4gICAgICAgICAgICBvZmYgOiB0aGlzLm9mZi5leGlzdHMoKSA/IHRoaXMub2ZmIDogdW5kZWZpbmVkLFxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGZpbGVzO1xuICAgIH1cbiAgICBcbiAgICBnZXRNaXNzaW5nKCk6IHN0cmluZ1tdIHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSBbXTtcbiAgICAgICAgaWYgKCAhdGhpcy5iYXNlLmV4aXN0cygpICkge1xuICAgICAgICAgICAgZmlsZXMucHVzaChcImJhc2VcIilcbiAgICAgICAgfVxuICAgICAgICBpZiAoICF0aGlzLm9uLmV4aXN0cygpICkge1xuICAgICAgICAgICAgZmlsZXMucHVzaChcIm9uXCIpXG4gICAgICAgIH1cbiAgICAgICAgaWYgKCAhdGhpcy5vZmYuZXhpc3RzKCkgKSB7XG4gICAgICAgICAgICBmaWxlcy5wdXNoKFwib2ZmXCIpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZpbGVzO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgYWxsRXhpc3QoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmJhc2UuZXhpc3RzKClcbiAgICAgICAgICAgICYmIHRoaXMub24uZXhpc3RzKClcbiAgICAgICAgICAgICYmIHRoaXMub2ZmLmV4aXN0cygpXG4gICAgICAgICk7XG4gICAgfVxuICAgIFxuICAgIGFueUV4aXN0KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5iYXNlLmV4aXN0cygpXG4gICAgICAgICAgICB8fCB0aGlzLm9uLmV4aXN0cygpXG4gICAgICAgICAgICB8fCB0aGlzLm9mZi5leGlzdHMoKVxuICAgICAgICApO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcmVtb3ZlQWxsKCk6IHZvaWQge1xuICAgICAgICBpZiAoIHRoaXMuYmFzZS5leGlzdHMoKSApXG4gICAgICAgICAgICB0aGlzLmJhc2UucmVtb3ZlKCk7XG4gICAgICAgIGlmICggdGhpcy5vbi5leGlzdHMoKSApXG4gICAgICAgICAgICB0aGlzLm9uLnJlbW92ZSgpO1xuICAgICAgICBpZiAoIHRoaXMub2ZmLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMub2ZmLnJlbW92ZSgpO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgcmVuYW1lQnlPdGhlclR4dChvdGhlcjogVHh0KTogdm9pZCB7XG4gICAgICAgIC8vIGNvbnNvbGUud2FybigncmVuYW1lQnlPdGhlclR4dDogZGlkbnQgc2V0IG5ldyB0aGlzIGJhc2UgLyBvbiAvIG9mZicpO1xuICAgICAgICB0aGlzLmJhc2UuYWJzUGF0aCA9IG90aGVyLmJhc2UuYWJzUGF0aDtcbiAgICAgICAgdGhpcy5vbi5hYnNQYXRoID0gb3RoZXIub24uYWJzUGF0aDtcbiAgICAgICAgdGhpcy5vZmYuYWJzUGF0aCA9IG90aGVyLm9mZi5hYnNQYXRoO1xuICAgICAgICAvLyBmcy5yZW5hbWVTeW5jKHRoaXMuYmFzZS5wYXRoLCBvdGhlci5iYXNlLnBhdGgpO1xuICAgICAgICAvLyBmcy5yZW5hbWVTeW5jKHRoaXMub24ucGF0aCwgb3RoZXIub24ucGF0aCk7XG4gICAgICAgIC8vIGZzLnJlbmFtZVN5bmModGhpcy5vZmYucGF0aCwgb3RoZXIub2ZmLnBhdGgpO1xuICAgICAgICBcbiAgICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVhZG9ubHlUcnV0aCB7XG4gICAgLyoqVGhlIGJhc2VuYW1lIHdpdGhvdXQgZXh0ZW5zaW9uLiovXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIHR4dDoge1xuICAgICAgICBiYXNlOiB7XG4gICAgICAgICAgICBhYnNQYXRoOiBzdHJpbmdcbiAgICAgICAgfSxcbiAgICAgICAgb246IHtcbiAgICAgICAgICAgIGFic1BhdGg6IHN0cmluZ1xuICAgICAgICB9LFxuICAgICAgICBvZmY6IHtcbiAgICAgICAgICAgIGFic1BhdGg6IHN0cmluZ1xuICAgICAgICB9XG4gICAgfSxcbiAgICBtaWRpOiB7IGFic1BhdGg6IHN0cmluZyB9LFxuICAgIG1wNDogeyBhYnNQYXRoOiBzdHJpbmcgfSxcbiAgICBvbnNldHM6IHsgYWJzUGF0aDogc3RyaW5nIH0sXG59XG5cbmV4cG9ydCBjbGFzcyBUcnV0aCBpbXBsZW1lbnRzIFJlYWRvbmx5VHJ1dGgge1xuICAgIFxuICAgIC8qKlRoZSBiYXNlbmFtZSB3aXRob3V0IGV4dGVuc2lvbi4qL1xuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgICByZWFkb25seSB0eHQ6IFR4dDtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBtaWRpIGZpbGUuKi9cbiAgICByZWFkb25seSBtaWRpOiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG1wNCBmaWxlLiovXG4gICAgcmVhZG9ubHkgbXA0OiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG1vdiBmaWxlLiovXG4gICAgcmVhZG9ubHkgbW92OiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG9uc2V0cyBmaWxlLiovXG4gICAgcmVhZG9ubHkgb25zZXRzOiBGaWxlO1xuICAgIFxuICAgIC8qKlxuICAgICAqIEBwYXJhbSBuYW1lTm9FeHQgLSBFeHBlY3RzIGEgZmlsZSBiYXNlIG5hbWUgd2l0aCBubyBleHRlbnNpb24uXG4gICAgICogQHBhcmFtIGRpciAtIE9wdGlvbmFsIGFicyBkaXIgcGF0aCBvZiB0aGUgdHJ1dGguIERlZmF1bHRzIHRvIGBUUlVUSFNfUEFUSF9BQlNgXG4gICAgICovXG4gICAgY29uc3RydWN0b3IobmFtZU5vRXh0OiBzdHJpbmcsIGRpcj86IHN0cmluZykge1xuICAgICAgICBsZXQgWyBuYW1lLCBleHQgXSA9IG15ZnMuc3BsaXRfZXh0KG5hbWVOb0V4dCk7XG4gICAgICAgIFxuICAgICAgICBpZiAoIGJvb2woZXh0KSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgVHJ1dGggY3RvciwgcGFzc2VkIG5hbWUgaXMgbm90IGV4dGVuc2lvbmxlc3M6ICR7bmFtZU5vRXh0fS4gQ29udGludWluZyB3aXRoIFwiJHtuYW1lfVwiYCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICggbmFtZS5lbmRzV2l0aEFueSgnX29mZicsICdfb24nKSApIHtcbiAgICAgICAgICAgIC8vIFRPRE86IFRISVMgSVMgQlVHR1lcbiAgICAgICAgICAgIG5hbWUgPSBgJHtuYW1lLnVwVG8oJ18nLCB0cnVlKX1gO1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBQYXNzZWQgcGF0aCBvZiBcIl9vblwiIG9yIFwiX29mZlwiIGZpbGUgYW5kIG5vdCBiYXNlLiBVc2luZyBuYW1lOiBcIiR7bmFtZX1cImApO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICBpZiAoICFib29sKGRpcikgKSB7XG4gICAgICAgICAgICBkaXIgPSBUUlVUSFNfUEFUSF9BQlM7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYWJzUGF0aE5vRXh0ID0gcGF0aC5qb2luKGRpciwgbmFtZSk7XG4gICAgICAgIHRoaXMudHh0ID0gbmV3IFR4dChhYnNQYXRoTm9FeHQpO1xuICAgICAgICB0aGlzLm1pZGkgPSBuZXcgRmlsZShgJHthYnNQYXRoTm9FeHR9Lm1pZGApO1xuICAgICAgICB0aGlzLm1wNCA9IG5ldyBGaWxlKGAke2Fic1BhdGhOb0V4dH0ubXA0YCk7XG4gICAgICAgIHRoaXMubW92ID0gbmV3IEZpbGUoYCR7YWJzUGF0aE5vRXh0fS5tb3ZgKTtcbiAgICAgICAgdGhpcy5vbnNldHMgPSBuZXcgRmlsZShgJHthYnNQYXRoTm9FeHR9X29uc2V0cy5qc29uYCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICB0b1JlYWRPbmx5KC4uLmluY2x1ZGU6IChcInR4dFwiIHwgXCJtaWRpXCIgfCBcIm1wNFwiIHwgXCJvbnNldHNcIilbXSk6IFJlYWRvbmx5VHJ1dGgge1xuICAgICAgICBsZXQgcmVhZG9ubHlUcnV0aCA9IHt9IGFzIFJlYWRvbmx5VHJ1dGg7XG4gICAgICAgIGNvbnN0IHJlYWRvbmx5VHh0ID0gKCkgPT4gKHtcbiAgICAgICAgICAgIGJhc2UgOiB7XG4gICAgICAgICAgICAgICAgYWJzUGF0aCA6IHRoaXMudHh0LmJhc2UuYWJzUGF0aFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9uIDoge1xuICAgICAgICAgICAgICAgIGFic1BhdGggOiB0aGlzLnR4dC5vbi5hYnNQYXRoXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgb2ZmIDoge1xuICAgICAgICAgICAgICAgIGFic1BhdGggOiB0aGlzLnR4dC5vZmYuYWJzUGF0aFxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgcmVhZG9ubHlTdWJGaWxlID0gKHN1YmZpbGU6IFwibWlkaVwiIHwgXCJtcDRcIiB8IFwib25zZXRzXCIpID0+ICh7XG4gICAgICAgICAgICBhYnNQYXRoIDogdGhpc1tzdWJmaWxlXS5hYnNQYXRoXG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIGJvb2woaW5jbHVkZSkgKSB7XG4gICAgICAgICAgICBmb3IgKCBsZXQgaW5jIG9mIGluY2x1ZGUgKSB7XG4gICAgICAgICAgICAgICAgc3dpdGNoICggaW5jICkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIFwidHh0XCI6XG4gICAgICAgICAgICAgICAgICAgICAgICByZWFkb25seVRydXRoLnR4dCA9IHJlYWRvbmx5VHh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1pZGlcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRvbmx5VHJ1dGgubWlkaSA9IHJlYWRvbmx5U3ViRmlsZShcIm1pZGlcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm1wNFwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmVhZG9ubHlUcnV0aC5tcDQgPSByZWFkb25seVN1YkZpbGUoXCJtcDRcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBcIm9uc2V0c1wiOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmVhZG9ubHlUcnV0aC5vbnNldHMgPSByZWFkb25seVN1YkZpbGUoXCJvbnNldHNcIik7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlYWRvbmx5VHJ1dGggPSB7XG4gICAgICAgICAgICAgICAgbmFtZSA6IHRoaXMubmFtZSxcbiAgICAgICAgICAgICAgICB0eHQgOiByZWFkb25seVR4dCgpLFxuICAgICAgICAgICAgICAgIG1wNCA6IHJlYWRvbmx5U3ViRmlsZShcIm1wNFwiKSxcbiAgICAgICAgICAgICAgICBvbnNldHMgOiByZWFkb25seVN1YkZpbGUoXCJvbnNldHNcIiksXG4gICAgICAgICAgICAgICAgbWlkaSA6IHJlYWRvbmx5U3ViRmlsZShcIm1pZGlcIilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVhZG9ubHlUcnV0aDtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8qKkNvdW50cyB0aGUgbnVtYmVyIG9mIG5vbi1lbXB0eSBsaW5lcyBpbiB0aGUgdHh0IG9uIHBhdGggZmlsZS4qL1xuICAgIG51bU9mTm90ZXMoKTogbnVtYmVyIHtcbiAgICAgICAgaWYgKCAhdGhpcy50eHQub24uZXhpc3RzKCkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYHRoaXMudHh0Lm9uICgke3RoaXMudHh0Lm9uLmFic1BhdGh9KSBkb2VzIG5vdCBleGlzdCwgcmV0dXJuaW5nIHVuZGVmaW5lZGApO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0cmluZ3MgPSBmc1xuICAgICAgICAgICAgLnJlYWRGaWxlU3luYyh0aGlzLnR4dC5vbi5hYnNQYXRoLCB7IGVuY29kaW5nIDogJ3V0ZjgnIH0pXG4gICAgICAgICAgICAuc3BsaXQoJ1xcbicpO1xuICAgICAgICBsZXQgbm90ZXM6IG51bWJlciA9IDA7XG4gICAgICAgIGZvciAoIGxldCBzIG9mIHN0cmluZ3MgKSB7XG4gICAgICAgICAgICBpZiAoIHMuaW5jbHVkZXMoJ1xcXFwnKSApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYHMgaW5jbHVkZXMgYmFja3NsYXNoLCAke3RoaXMudHh0Lm9ufWApO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggYm9vbChzKSApIHtcbiAgICAgICAgICAgICAgICBub3RlcysrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5vdGVzO1xuICAgIH1cbn1cbiJdfQ==