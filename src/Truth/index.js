"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
const MyFs_1 = require("../MyFs");
class File {
    constructor(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            throw new Error(`File constructor: passed 'absPathWithExt' is extensionless: ${absPathWithExt}`);
        }
        if (!path.isAbsolute(absPathWithExt)) {
            throw new Error(`File constructor: passed 'absPathWithExt' NOT absolute: ${absPathWithExt}`);
        }
        this._absPath = absPathWithExt;
    }
    get absPath() {
        return this._absPath;
    }
    set absPath(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            throw new Error(`File constructor: passed 'absPathWithExt' is extensionless: ${absPathWithExt}`);
        }
        if (!path.isAbsolute(absPathWithExt)) {
            throw new Error(`File constructor: passed 'absPathWithExt' NOT absolute: ${absPathWithExt}`);
        }
        this._absPath = absPathWithExt;
        fs.renameSync(this._absPath, absPathWithExt);
    }
    renameByOtherFile(other) {
        console.warn('called renameByOtherFile(), use set absPath instead');
        this.absPath = other.absPath;
    }
    renameByCTime() {
        const stats = fs.lstatSync(this.absPath);
        const datestr = stats.ctime.human();
        const newPath = MyFs_1.default.push_before_ext(this.absPath, `__CREATED_${datestr}`);
        console.log('renameByCTime() to: ', newPath);
        this.absPath = newPath;
    }
    async getBitrateAndHeight() {
        if (!this._absPath.endsWith('mp4') && !this._absPath.endsWith('mov')) {
            console.warn(`File: "${this._absPath}" isn't "mp4" or "mov"`);
            return undefined;
        }
        const { execSync } = require('child_process');
        const ffprobeCmd = `ffprobe -v quiet -print_format json -show_streams -show_format`;
        const probe = JSON.parse(execSync(`${ffprobeCmd} "${this._absPath}"`, { encoding: 'utf8' }));
        const { bit_rate, height } = probe.streams.find(s => s["codec_type"] === "video");
        return [bit_rate, height];
    }
    exists() {
        return fs.existsSync(this._absPath);
    }
    remove() {
        fs.unlinkSync(this._absPath);
    }
    size() {
        let { size } = fs.lstatSync(this._absPath);
        return size;
    }
}
class Txt {
    constructor(nameNoExt) {
        const absPath = path.join(TRUTHS_PATH_ABS, nameNoExt);
        this.base = new File(`${absPath}.txt`);
        this.on = new File(`${absPath}_on.txt`);
        this.off = new File(`${absPath}_off.txt`);
    }
    getAll() {
        return [this.base, this.on, this.off];
    }
    getExisting() {
        const files = {
            base: this.base.exists() ? this.base : undefined,
            on: this.on.exists() ? this.on : undefined,
            off: this.off.exists() ? this.off : undefined,
        };
        return files;
    }
    getMissing() {
        const files = [];
        if (!this.base.exists()) {
            files.push("base");
        }
        if (!this.on.exists()) {
            files.push("on");
        }
        if (!this.off.exists()) {
            files.push("off");
        }
        return files;
    }
    allExist() {
        return (this.base.exists()
            && this.on.exists()
            && this.off.exists());
    }
    anyExist() {
        return (this.base.exists()
            || this.on.exists()
            || this.off.exists());
    }
    removeAll() {
        if (this.base.exists())
            this.base.remove();
        if (this.on.exists())
            this.on.remove();
        if (this.off.exists())
            this.off.remove();
    }
    renameByOtherTxt(other) {
        this.base.absPath = other.base.absPath;
        this.on.absPath = other.on.absPath;
        this.off.absPath = other.off.absPath;
    }
}
class Truth {
    constructor(nameNoExt) {
        let [name, ext] = MyFs_1.default.split_ext(nameNoExt);
        if (util_1.bool(ext)) {
            console.warn(`Truth ctor, passed name is not extensionless: ${nameNoExt}. Continuing with "${name}"`);
        }
        if (name.endsWithAny('_off', '_on')) {
            name = `${name.upTo('_', true)}`;
            console.warn(`Passed path of "_on" or "_off" file and not base. Using name: "${name}"`);
        }
        this.name = name;
        this.txt = new Txt(name);
        const absPath = path.join(TRUTHS_PATH_ABS, name);
        this.midi = new File(`${absPath}.mid`);
        this.mp4 = new File(`${absPath}.mp4`);
        this.mov = new File(`${absPath}.mov`);
        this.onsets = new File(`${absPath}_onsets.json`);
    }
    numOfNotes() {
        if (!this.txt.on.exists()) {
            console.warn(`this.txt.on (${this.txt.on.absPath}) does not exist, returning undefined`);
            return undefined;
        }
        const strings = fs
            .readFileSync(this.txt.on.absPath, { encoding: 'utf8' })
            .split('\n');
        let notes = 0;
        for (let s of strings) {
            if (s.includes('\\')) {
                console.warn(`s includes backslash, ${this.txt.on}`);
            }
            else if (util_1.bool(s)) {
                notes++;
            }
        }
        return notes;
    }
}
exports.Truth = Truth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3Qix5QkFBd0I7QUFDeEIsa0NBQStCO0FBQy9CLGtDQUEwQjtBQUcxQixNQUFNLElBQUk7SUFNTixZQUFZLGNBQXNCO1FBQzlCLElBQUssQ0FBQyxXQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFHO1lBQ3ZDLE1BQU0sSUFBSSxLQUFLLENBQUMsK0RBQStELGNBQWMsRUFBRSxDQUFDLENBQUM7U0FDcEc7UUFDRCxJQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRztZQUNwQyxNQUFNLElBQUksS0FBSyxDQUFDLDJEQUEyRCxjQUFjLEVBQUUsQ0FBQyxDQUFDO1NBQ2hHO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxjQUFjLENBQUM7SUFLbkMsQ0FBQztJQUdELElBQUksT0FBTztRQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBR0QsSUFBSSxPQUFPLENBQUMsY0FBc0I7UUFDOUIsSUFBSyxDQUFDLFdBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUc7WUFDdkMsTUFBTSxJQUFJLEtBQUssQ0FBQywrREFBK0QsY0FBYyxFQUFFLENBQUMsQ0FBQztTQUNwRztRQUNELElBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxFQUFHO1lBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQUMsMkRBQTJELGNBQWMsRUFBRSxDQUFDLENBQUM7U0FDaEc7UUFDRCxJQUFJLENBQUMsUUFBUSxHQUFHLGNBQWMsQ0FBQztRQUMvQixFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDakQsQ0FBQztJQU1ELGlCQUFpQixDQUFDLEtB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RUFBRztnQkFDcEIsT0FBTyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQ3hEO2lCQUFNLElBQUssV0FBSSxDQUFDLENBQUMsQ0FBQyxFQUFHO2dCQUNsQixLQUFLLEVBQUUsQ0FBQzthQUNYO1NBRUo7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0NBQ0o7QUE5REQsc0JBOERDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyBib29sIH0gZnJvbSBcIi4uL3V0aWxcIjtcbmltcG9ydCBteWZzIGZyb20gJy4uL015RnMnXG5cbi8qKkFuIG9iamVjdCB3cmFwcGluZyBhbiBhYnMgcGF0aCB3aXRoIGV4dGVuc2lvbi4qL1xuY2xhc3MgRmlsZSB7XG4gICAgXG4gICAgLyoqVGhlIGFicyBwYXRoIFdJVEggZXh0ZW5zaW9uKi9cbiAgICBwcml2YXRlIF9hYnNQYXRoOiBzdHJpbmc7XG4gICAgXG4gICAgXG4gICAgY29uc3RydWN0b3IoYWJzUGF0aFdpdGhFeHQ6IHN0cmluZykge1xuICAgICAgICBpZiAoICFib29sKHBhdGguZXh0bmFtZShhYnNQYXRoV2l0aEV4dCkpICkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlIGNvbnN0cnVjdG9yOiBwYXNzZWQgJ2Fic1BhdGhXaXRoRXh0JyBpcyBleHRlbnNpb25sZXNzOiAke2Fic1BhdGhXaXRoRXh0fWApO1xuICAgICAgICB9XG4gICAgICAgIGlmICggIXBhdGguaXNBYnNvbHV0ZShhYnNQYXRoV2l0aEV4dCkgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGUgY29uc3RydWN0b3I6IHBhc3NlZCAnYWJzUGF0aFdpdGhFeHQnIE5PVCBhYnNvbHV0ZTogJHthYnNQYXRoV2l0aEV4dH1gKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdGhpcy5fYWJzUGF0aCA9IGFic1BhdGhXaXRoRXh0O1xuICAgICAgICBcbiAgICAgICAgLy8gdGhpcy5wYXRoTm9FeHQgPSBteWZzLnJlbW92ZV9leHQoYWJzUGF0aFdpdGhFeHQpO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIFxuICAgIGdldCBhYnNQYXRoKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hYnNQYXRoO1xuICAgIH1cbiAgICBcbiAgICAvKipTZXRzIHRoaXMuX2Fic1BhdGggYW5kIGFsc28gUkVOQU1FUyB0aGUgYWN0dWFsIGZpbGUuKi9cbiAgICBzZXQgYWJzUGF0aChhYnNQYXRoV2l0aEV4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICggIWJvb2wocGF0aC5leHRuYW1lKGFic1BhdGhXaXRoRXh0KSkgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGUgY29uc3RydWN0b3I6IHBhc3NlZCAnYWJzUGF0aFdpdGhFeHQnIGlzIGV4dGVuc2lvbmxlc3M6ICR7YWJzUGF0aFdpdGhFeHR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCAhcGF0aC5pc0Fic29sdXRlKGFic1BhdGhXaXRoRXh0KSApIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZSBjb25zdHJ1Y3RvcjogcGFzc2VkICdhYnNQYXRoV2l0aEV4dCcgTk9UIGFic29sdXRlOiAke2Fic1BhdGhXaXRoRXh0fWApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2Fic1BhdGggPSBhYnNQYXRoV2l0aEV4dDtcbiAgICAgICAgZnMucmVuYW1lU3luYyh0aGlzLl9hYnNQYXRoLCBhYnNQYXRoV2l0aEV4dCk7XG4gICAgfVxuICAgIFxuICAgIC8qdG9TdHJpbmcoKSB7XG4gICAgIHJldHVybiB0aGlzLnBhdGg7XG4gICAgIH0qL1xuICAgIC8qKkBkZXByZWNhdGVkKi9cbiAgICByZW5hbWVCeU90aGVyRmlsZShvdGhlcjogRmlsZSkge1xuICAgICAgICBjb25zb2xlLndhcm4oJ2NhbGxlZCByZW5hbWVCeU90aGVyRmlsZSgpLCB1c2Ugc2V0IGFic1BhdGggaW5zdGVhZCcpO1xuICAgICAgICB0aGlzLmFic1BhdGggPSBvdGhlci5hYnNQYXRoO1xuICAgIH1cbiAgICBcbiAgICByZW5hbWVCeUNUaW1lKCkge1xuICAgICAgICBjb25zdCBzdGF0cyA9IGZzLmxzdGF0U3luYyh0aGlzLmFic1BhdGgpO1xuICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgIGNvbnN0IGRhdGVzdHIgPSBzdGF0cy5jdGltZS5odW1hbigpO1xuICAgICAgICBjb25zdCBuZXdQYXRoID0gbXlmcy5wdXNoX2JlZm9yZV9leHQodGhpcy5hYnNQYXRoLCBgX19DUkVBVEVEXyR7ZGF0ZXN0cn1gKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3JlbmFtZUJ5Q1RpbWUoKSB0bzogJywgbmV3UGF0aCk7XG4gICAgICAgIHRoaXMuYWJzUGF0aCA9IG5ld1BhdGg7XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGFzeW5jIGdldEJpdHJhdGVBbmRIZWlnaHQoKTogUHJvbWlzZTxbIHN0cmluZywgc3RyaW5nIF0+IHtcbiAgICAgICAgaWYgKCAhdGhpcy5fYWJzUGF0aC5lbmRzV2l0aCgnbXA0JykgJiYgIXRoaXMuX2Fic1BhdGguZW5kc1dpdGgoJ21vdicpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBGaWxlOiBcIiR7dGhpcy5fYWJzUGF0aH1cIiBpc24ndCBcIm1wNFwiIG9yIFwibW92XCJgKTtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IGV4ZWNTeW5jIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG4gICAgICAgIGNvbnN0IGZmcHJvYmVDbWQgPSBgZmZwcm9iZSAtdiBxdWlldCAtcHJpbnRfZm9ybWF0IGpzb24gLXNob3dfc3RyZWFtcyAtc2hvd19mb3JtYXRgO1xuICAgICAgICBjb25zdCBwcm9iZSA9IEpTT04ucGFyc2UoZXhlY1N5bmMoYCR7ZmZwcm9iZUNtZH0gXCIke3RoaXMuX2Fic1BhdGh9XCJgLCB7IGVuY29kaW5nIDogJ3V0ZjgnIH0pKTtcbiAgICAgICAgY29uc3QgeyBiaXRfcmF0ZSwgaGVpZ2h0IH0gPSBwcm9iZS5zdHJlYW1zLmZpbmQocyA9PiBzW1wiY29kZWNfdHlwZVwiXSA9PT0gXCJ2aWRlb1wiKTtcbiAgICAgICAgcmV0dXJuIFsgYml0X3JhdGUsIGhlaWdodCBdO1xuICAgIH1cbiAgICBcbiAgICBcbiAgICBleGlzdHMoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBmcy5leGlzdHNTeW5jKHRoaXMuX2Fic1BhdGgpO1xuICAgIH1cbiAgICBcbiAgICByZW1vdmUoKSB7XG4gICAgICAgIGZzLnVubGlua1N5bmModGhpcy5fYWJzUGF0aCk7XG4gICAgfVxuICAgIFxuICAgIHNpemUoKTogbnVtYmVyIHtcbiAgICAgICAgbGV0IHsgc2l6ZSB9ID0gZnMubHN0YXRTeW5jKHRoaXMuX2Fic1BhdGgpO1xuICAgICAgICByZXR1cm4gc2l6ZTtcbiAgICB9XG59XG5cbmNsYXNzIFR4dCB7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKi50eHRgYCBwYXRoLiovXG4gICAgcmVhZG9ubHkgYmFzZTogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWJzb2x1dGUgYGAqX29uLnR4dGBgICBwYXRoLiovXG4gICAgcmVhZG9ubHkgb246IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKl9vZmYudHh0YGAgcGF0aC4qL1xuICAgIHJlYWRvbmx5IG9mZjogRmlsZTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihuYW1lTm9FeHQ6IHN0cmluZykge1xuICAgICAgICBjb25zdCBhYnNQYXRoID0gcGF0aC5qb2luKFRSVVRIU19QQVRIX0FCUywgbmFtZU5vRXh0KTtcbiAgICAgICAgdGhpcy5iYXNlID0gbmV3IEZpbGUoYCR7YWJzUGF0aH0udHh0YCk7XG4gICAgICAgIHRoaXMub24gPSBuZXcgRmlsZShgJHthYnNQYXRofV9vbi50eHRgKTtcbiAgICAgICAgdGhpcy5vZmYgPSBuZXcgRmlsZShgJHthYnNQYXRofV9vZmYudHh0YCk7XG4gICAgfVxuICAgIFxuICAgIGdldEFsbCgpOiBbIEZpbGUsIEZpbGUsIEZpbGUgXSB7XG4gICAgICAgIHJldHVybiBbIHRoaXMuYmFzZSwgdGhpcy5vbiwgdGhpcy5vZmYgXTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgLy8gZ2V0RXhpc3RpbmcoKTogWyAoRmlsZSB8IGZhbHNlKSwgKEZpbGUgfCBmYWxzZSksIChGaWxlIHwgZmFsc2UpIF0ge1xuICAgIGdldEV4aXN0aW5nKCk6IHsgYmFzZT86IEZpbGUsIG9uPzogRmlsZSwgb2ZmPzogRmlsZSB9IHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSB7XG4gICAgICAgICAgICBiYXNlIDogdGhpcy5iYXNlLmV4aXN0cygpID8gdGhpcy5iYXNlIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgb24gOiB0aGlzLm9uLmV4aXN0cygpID8gdGhpcy5vbiA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIG9mZiA6IHRoaXMub2ZmLmV4aXN0cygpID8gdGhpcy5vZmYgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZmlsZXM7XG4gICAgfVxuICAgIFxuICAgIGdldE1pc3NpbmcoKTogc3RyaW5nW10ge1xuICAgICAgICBjb25zdCBmaWxlcyA9IFtdO1xuICAgICAgICBpZiAoICF0aGlzLmJhc2UuZXhpc3RzKCkgKSB7XG4gICAgICAgICAgICBmaWxlcy5wdXNoKFwiYmFzZVwiKVxuICAgICAgICB9XG4gICAgICAgIGlmICggIXRoaXMub24uZXhpc3RzKCkgKSB7XG4gICAgICAgICAgICBmaWxlcy5wdXNoKFwib25cIilcbiAgICAgICAgfVxuICAgICAgICBpZiAoICF0aGlzLm9mZi5leGlzdHMoKSApIHtcbiAgICAgICAgICAgIGZpbGVzLnB1c2goXCJvZmZcIilcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmlsZXM7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBhbGxFeGlzdCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuYmFzZS5leGlzdHMoKVxuICAgICAgICAgICAgJiYgdGhpcy5vbi5leGlzdHMoKVxuICAgICAgICAgICAgJiYgdGhpcy5vZmYuZXhpc3RzKClcbiAgICAgICAgKTtcbiAgICB9XG4gICAgXG4gICAgYW55RXhpc3QoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmJhc2UuZXhpc3RzKClcbiAgICAgICAgICAgIHx8IHRoaXMub24uZXhpc3RzKClcbiAgICAgICAgICAgIHx8IHRoaXMub2ZmLmV4aXN0cygpXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICByZW1vdmVBbGwoKTogdm9pZCB7XG4gICAgICAgIGlmICggdGhpcy5iYXNlLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMuYmFzZS5yZW1vdmUoKTtcbiAgICAgICAgaWYgKCB0aGlzLm9uLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMub24ucmVtb3ZlKCk7XG4gICAgICAgIGlmICggdGhpcy5vZmYuZXhpc3RzKCkgKVxuICAgICAgICAgICAgdGhpcy5vZmYucmVtb3ZlKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICByZW5hbWVCeU90aGVyVHh0KG90aGVyOiBUeHQpOiB2b2lkIHtcbiAgICAgICAgLy8gY29uc29sZS53YXJuKCdyZW5hbWVCeU90aGVyVHh0OiBkaWRudCBzZXQgbmV3IHRoaXMgYmFzZSAvIG9uIC8gb2ZmJyk7XG4gICAgICAgIHRoaXMuYmFzZS5hYnNQYXRoID0gb3RoZXIuYmFzZS5hYnNQYXRoO1xuICAgICAgICB0aGlzLm9uLmFic1BhdGggPSBvdGhlci5vbi5hYnNQYXRoO1xuICAgICAgICB0aGlzLm9mZi5hYnNQYXRoID0gb3RoZXIub2ZmLmFic1BhdGg7XG4gICAgICAgIC8vIGZzLnJlbmFtZVN5bmModGhpcy5iYXNlLnBhdGgsIG90aGVyLmJhc2UucGF0aCk7XG4gICAgICAgIC8vIGZzLnJlbmFtZVN5bmModGhpcy5vbi5wYXRoLCBvdGhlci5vbi5wYXRoKTtcbiAgICAgICAgLy8gZnMucmVuYW1lU3luYyh0aGlzLm9mZi5wYXRoLCBvdGhlci5vZmYucGF0aCk7XG4gICAgICAgIFxuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRydXRoIHtcbiAgICAvLyAvKipUaGUgYWJzb2x1dGUgcGF0aCB3aXRob3V0IGV4dGVuc2lvbi4qL1xuICAgIC8vIHByaXZhdGUgcmVhZG9ubHkgcGF0aE5vRXh0OiBzdHJpbmc7XG4gICAgLyoqVGhlIGJhc2VuYW1lIHdpdGhvdXQgZXh0ZW5zaW9uLiovXG4gICAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAgIHJlYWRvbmx5IHR4dDogVHh0O1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG1pZGkgZmlsZS4qL1xuICAgIHJlYWRvbmx5IG1pZGk6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbXA0IGZpbGUuKi9cbiAgICByZWFkb25seSBtcDQ6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbW92IGZpbGUuKi9cbiAgICByZWFkb25seSBtb3Y6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgb25zZXRzIGZpbGUuKi9cbiAgICByZWFkb25seSBvbnNldHM6IEZpbGU7XG4gICAgXG4gICAgY29uc3RydWN0b3IobmFtZU5vRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IFsgbmFtZSwgZXh0IF0gPSBteWZzLnNwbGl0X2V4dChuYW1lTm9FeHQpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCBib29sKGV4dCkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFRydXRoIGN0b3IsIHBhc3NlZCBuYW1lIGlzIG5vdCBleHRlbnNpb25sZXNzOiAke25hbWVOb0V4dH0uIENvbnRpbnVpbmcgd2l0aCBcIiR7bmFtZX1cImApO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoIG5hbWUuZW5kc1dpdGhBbnkoJ19vZmYnLCAnX29uJykgKSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBUSElTIElTIEJVR0dZXG4gICAgICAgICAgICBuYW1lID0gYCR7bmFtZS51cFRvKCdfJywgdHJ1ZSl9YDtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgUGFzc2VkIHBhdGggb2YgXCJfb25cIiBvciBcIl9vZmZcIiBmaWxlIGFuZCBub3QgYmFzZS4gVXNpbmcgbmFtZTogXCIke25hbWV9XCJgKTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMudHh0ID0gbmV3IFR4dChuYW1lKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGFic1BhdGggPSBwYXRoLmpvaW4oVFJVVEhTX1BBVEhfQUJTLCBuYW1lKTtcbiAgICAgICAgdGhpcy5taWRpID0gbmV3IEZpbGUoYCR7YWJzUGF0aH0ubWlkYCk7XG4gICAgICAgIHRoaXMubXA0ID0gbmV3IEZpbGUoYCR7YWJzUGF0aH0ubXA0YCk7XG4gICAgICAgIHRoaXMubW92ID0gbmV3IEZpbGUoYCR7YWJzUGF0aH0ubW92YCk7XG4gICAgICAgIHRoaXMub25zZXRzID0gbmV3IEZpbGUoYCR7YWJzUGF0aH1fb25zZXRzLmpzb25gKTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8qKkNvdW50cyB0aGUgbnVtYmVyIG9mIG5vbi1lbXB0eSBsaW5lcyBpbiB0aGUgdHh0IG9uIHBhdGggZmlsZS4qL1xuICAgIG51bU9mTm90ZXMoKTogbnVtYmVyIHtcbiAgICAgICAgaWYgKCAhdGhpcy50eHQub24uZXhpc3RzKCkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYHRoaXMudHh0Lm9uICgke3RoaXMudHh0Lm9uLmFic1BhdGh9KSBkb2VzIG5vdCBleGlzdCwgcmV0dXJuaW5nIHVuZGVmaW5lZGApO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0cmluZ3MgPSBmc1xuICAgICAgICAgICAgLnJlYWRGaWxlU3luYyh0aGlzLnR4dC5vbi5hYnNQYXRoLCB7IGVuY29kaW5nIDogJ3V0ZjgnIH0pXG4gICAgICAgICAgICAuc3BsaXQoJ1xcbicpO1xuICAgICAgICBsZXQgbm90ZXM6IG51bWJlciA9IDA7XG4gICAgICAgIGZvciAoIGxldCBzIG9mIHN0cmluZ3MgKSB7XG4gICAgICAgICAgICBpZiAoIHMuaW5jbHVkZXMoJ1xcXFwnKSApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYHMgaW5jbHVkZXMgYmFja3NsYXNoLCAke3RoaXMudHh0Lm9ufWApO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggYm9vbChzKSApIHtcbiAgICAgICAgICAgICAgICBub3RlcysrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5vdGVzO1xuICAgIH1cbn1cbiJdfQ==