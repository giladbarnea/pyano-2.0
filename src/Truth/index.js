"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
const MyFs_1 = require("../MyFs");
class File {
    constructor(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            console.error(`File constructor: passed 'absPathWithExt' is extensionless: ${absPathWithExt}. Returning`);
        }
        if (!path.isAbsolute(absPathWithExt)) {
            console.error(`File constructor: passed 'absPathWithExt' NOT absolute: ${absPathWithExt}. Returning`);
        }
        this._absPath = absPathWithExt;
    }
    get absPath() {
        return this._absPath;
    }
    set absPath(absPathWithExt) {
        if (!util_1.bool(path.extname(absPathWithExt))) {
            console.error(`File set absPath: passed extensionless 'absPathWithExt': ${absPathWithExt}. Not setting`);
            return;
        }
        if (!path.isAbsolute(absPathWithExt)) {
            console.error(`File set absPath: passed non-absolute 'absPathWithExt': ${absPathWithExt}. Not setting`);
            return;
        }
        this._absPath = absPathWithExt;
        fs.renameSync(this._absPath, absPathWithExt);
    }
    renameByOtherFile(other) {
        console.warn('called renameByOtherFile(), use set absPath instead');
        this.absPath = other.absPath;
    }
    renameByCTime() {
        const stats = fs.lstatSync(this.absPath);
        const datestr = stats.ctime.human();
        const newPath = MyFs_1.default.push_before_ext(this.absPath, `__CREATED_${datestr}`);
        console.log('renameByCTime() to: ', newPath);
        this.absPath = newPath;
    }
    async getBitrateAndHeight() {
        if (!this._absPath.endsWith('mp4') && !this._absPath.endsWith('mov')) {
            console.warn(`File: "${this._absPath}" isn't "mp4" or "mov"`);
            return undefined;
        }
        const { execSync } = require('child_process');
        const ffprobeCmd = `ffprobe -v quiet -print_format json -show_streams -show_format`;
        const probe = JSON.parse(execSync(`${ffprobeCmd} "${this._absPath}"`, { encoding: 'utf8' }));
        const { bit_rate, height } = probe.streams.find(s => s["codec_type"] === "video");
        return [bit_rate, height];
    }
    exists() {
        return fs.existsSync(this._absPath);
    }
    remove() {
        fs.unlinkSync(this._absPath);
    }
    size() {
        let { size } = fs.lstatSync(this._absPath);
        return size;
    }
}
class Txt {
    constructor(absPathNoExt) {
        if (!path.isAbsolute(absPathNoExt)) {
            console.error(`Txt constructor: passed 'absPathNoExt' NOT absolute: ${absPathNoExt}. returning`);
            return;
        }
        if (util_1.bool(path.extname(absPathNoExt))) {
            console.warn(`File constructor: passed 'absPathNoExt' is NOT extensionless: ${absPathNoExt}. Removing ext`);
            absPathNoExt = MyFs_1.default.remove_ext(absPathNoExt);
        }
        this.base = new File(`${absPathNoExt}.txt`);
        this.on = new File(`${absPathNoExt}_on.txt`);
        this.off = new File(`${absPathNoExt}_off.txt`);
    }
    getAll() {
        return [this.base, this.on, this.off];
    }
    getExisting() {
        const files = {
            base: this.base.exists() ? this.base : undefined,
            on: this.on.exists() ? this.on : undefined,
            off: this.off.exists() ? this.off : undefined,
        };
        return files;
    }
    getMissing() {
        const files = [];
        if (!this.base.exists()) {
            files.push("base");
        }
        if (!this.on.exists()) {
            files.push("on");
        }
        if (!this.off.exists()) {
            files.push("off");
        }
        return files;
    }
    allExist() {
        return (this.base.exists()
            && this.on.exists()
            && this.off.exists());
    }
    anyExist() {
        return (this.base.exists()
            || this.on.exists()
            || this.off.exists());
    }
    removeAll() {
        if (this.base.exists())
            this.base.remove();
        if (this.on.exists())
            this.on.remove();
        if (this.off.exists())
            this.off.remove();
    }
    renameByOtherTxt(other) {
        this.base.absPath = other.base.absPath;
        this.on.absPath = other.on.absPath;
        this.off.absPath = other.off.absPath;
    }
}
class Truth {
    constructor(nameNoExt, dir) {
        let [name, ext] = MyFs_1.default.split_ext(nameNoExt);
        if (util_1.bool(ext)) {
            console.warn(`Truth ctor, passed name is not extensionless: ${nameNoExt}. Continuing with "${name}"`);
        }
        if (name.endsWithAny('_off', '_on')) {
            name = `${name.upTo('_', true)}`;
            console.warn(`Passed path of "_on" or "_off" file and not base. Using name: "${name}"`);
        }
        this.name = name;
        if (!util_1.bool(dir)) {
            dir = TRUTHS_PATH_ABS;
        }
        const absPathNoExt = path.join(dir, name);
        this.txt = new Txt(absPathNoExt);
        this.midi = new File(`${absPathNoExt}.mid`);
        this.mp4 = new File(`${absPathNoExt}.mp4`);
        this.mov = new File(`${absPathNoExt}.mov`);
        this.onsets = new File(`${absPathNoExt}_onsets.json`);
    }
    toReadOnly(...include) {
        let readonlyTruth = {};
        const readonlyTxt = () => ({
            base: {
                absPath: this.txt.base.absPath
            },
            on: {
                absPath: this.txt.on.absPath
            },
            off: {
                absPath: this.txt.off.absPath
            }
        });
        const readonlySubFile = (subfile) => ({
            absPath: this[subfile].absPath
        });
        if (include) {
            for (let inc of include) {
                switch (inc) {
                    case "txt":
                        readonlyTruth.txt = readonlyTxt();
                        break;
                    case "midi":
                        readonlyTruth.midi = readonlySubFile("midi");
                        break;
                    case "mp4":
                        readonlyTruth.mp4 = readonlySubFile("mp4");
                        break;
                    case "onsets":
                        readonlyTruth.onsets = readonlySubFile("onsets");
                        break;
                }
            }
        }
        else {
            readonlyTruth = {
                name: this.name,
                txt: readonlyTxt(),
                mp4: readonlySubFile("mp4"),
                onsets: readonlySubFile("onsets"),
                midi: readonlySubFile("midi")
            };
        }
        return readonlyTruth;
    }
    numOfNotes() {
        if (!this.txt.on.exists()) {
            console.warn(`this.txt.on (${this.txt.on.absPath}) does not exist, returning undefined`);
            return undefined;
        }
        const strings = fs
            .readFileSync(this.txt.on.absPath, { encoding: 'utf8' })
            .split('\n');
        let notes = 0;
        for (let s of strings) {
            if (s.includes('\\')) {
                console.warn(`s includes backslash, ${this.txt.on}`);
            }
            else if (util_1.bool(s)) {
                notes++;
            }
        }
        return notes;
    }
}
exports.Truth = Truth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3Qix5QkFBd0I7QUFDeEIsa0NBQStCO0FBQy9CLGtDQUEwQjtBQUcxQixNQUFNLElBQUk7SUFNTixZQUFZLGNBQXNCO1FBQzlCLElBQUssQ0FBQyxXQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxFQUFHO1lBQ3ZDLE9BQU8sQ0FBQyxLQUFLLENBQUMsK0RBQStELGNBQWMsYUFBYSxDQUFDLENBQUM7U0FDN0c7UUFDRCxJQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRztZQUNwQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJEQUEyRCxjQUFjLGFBQWEsQ0FBQyxDQUFDO1NBQ3pHO1FBRUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxjQUFjLENBQUM7SUFLbkMsQ0FBQztJQUdELElBQUksT0FBTztRQUNQLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBR0QsSUFBSSxPQUFPLENBQUMsY0FBc0I7UUFDOUIsSUFBSyxDQUFDLFdBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUc7WUFDdkMsT0FBTyxDQUFDLEtBQUssQ0FBQyw0REFBNEQsY0FBYyxlQUFlLENBQUMsQ0FBQztZQUN6RyxPQUFPO1NBQ1Y7UUFDRCxJQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUMsRUFBRztZQUNwQyxPQUFPLENBQUMsS0FBSyxDQUFDLDJEQUEyRCxjQUFjLGVBQWUsQ0FBQyxDQUFDO1lBQ3hHLE9BQU87U0FDVjtRQUNELElBQUksQ0FBQyxRQUFRLEdBQUcsY0FBYyxDQUFDO1FBQy9CLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQztJQUNqRCxDQUFD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QUFJLEVBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQzthQUNqQyxDQUFBO1NBQ0o7UUFDRCxPQUFPLGFBQWEsQ0FBQztJQUV6QixDQUFDO0lBR0QsVUFBVTtRQUNOLElBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsRUFBRztZQUN6QixPQUFPLENBQUMsSUFBSSxDQUFDLGdCQUFnQixJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLHVDQUF1QyxDQUFDLENBQUM7WUFDekYsT0FBTyxTQUFTLENBQUE7U0FDbkI7UUFDRCxNQUFNLE9BQU8sR0FBRyxFQUFFO2FBQ2IsWUFBWSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxFQUFFLFFBQVEsRUFBRyxNQUFNLEVBQUUsQ0FBQzthQUN4RCxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakIsSUFBSSxLQUFLLEdBQVcsQ0FBQyxDQUFDO1FBQ3RCLEtBQU0sSUFBSSxDQUFDLElBQUksT0FBTyxFQUFHO1lBQ3JCLElBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRztnQkFDcEIsT0FBTyxDQUFDLElBQUksQ0FBQyx5QkFBeUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2FBQ3hEO2lCQUFNLElBQUssV0FBSSxDQUFDLENBQUMsQ0FBQyxFQUFHO2dCQUNsQixLQUFLLEVBQUUsQ0FBQzthQUNYO1NBRUo7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0NBQ0o7QUFqSEQsc0JBaUhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgeyBib29sIH0gZnJvbSBcIi4uL3V0aWxcIjtcbmltcG9ydCBteWZzIGZyb20gJy4uL015RnMnXG5cbi8qKkFuIG9iamVjdCB3cmFwcGluZyBhbiBhYnMgcGF0aCB3aXRoIGV4dGVuc2lvbi4qL1xuY2xhc3MgRmlsZSB7XG4gICAgXG4gICAgLyoqVGhlIGFicyBwYXRoIFdJVEggZXh0ZW5zaW9uKi9cbiAgICBwcml2YXRlIF9hYnNQYXRoOiBzdHJpbmc7XG4gICAgXG4gICAgXG4gICAgY29uc3RydWN0b3IoYWJzUGF0aFdpdGhFeHQ6IHN0cmluZykge1xuICAgICAgICBpZiAoICFib29sKHBhdGguZXh0bmFtZShhYnNQYXRoV2l0aEV4dCkpICkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRmlsZSBjb25zdHJ1Y3RvcjogcGFzc2VkICdhYnNQYXRoV2l0aEV4dCcgaXMgZXh0ZW5zaW9ubGVzczogJHthYnNQYXRoV2l0aEV4dH0uIFJldHVybmluZ2ApO1xuICAgICAgICB9XG4gICAgICAgIGlmICggIXBhdGguaXNBYnNvbHV0ZShhYnNQYXRoV2l0aEV4dCkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBGaWxlIGNvbnN0cnVjdG9yOiBwYXNzZWQgJ2Fic1BhdGhXaXRoRXh0JyBOT1QgYWJzb2x1dGU6ICR7YWJzUGF0aFdpdGhFeHR9LiBSZXR1cm5pbmdgKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdGhpcy5fYWJzUGF0aCA9IGFic1BhdGhXaXRoRXh0O1xuICAgICAgICBcbiAgICAgICAgLy8gdGhpcy5wYXRoTm9FeHQgPSBteWZzLnJlbW92ZV9leHQoYWJzUGF0aFdpdGhFeHQpO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIFxuICAgIGdldCBhYnNQYXRoKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hYnNQYXRoO1xuICAgIH1cbiAgICBcbiAgICAvKipTZXRzIHRoaXMuX2Fic1BhdGggYW5kIGFsc28gUkVOQU1FUyB0aGUgYWN0dWFsIGZpbGUuKi9cbiAgICBzZXQgYWJzUGF0aChhYnNQYXRoV2l0aEV4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICggIWJvb2wocGF0aC5leHRuYW1lKGFic1BhdGhXaXRoRXh0KSkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBGaWxlIHNldCBhYnNQYXRoOiBwYXNzZWQgZXh0ZW5zaW9ubGVzcyAnYWJzUGF0aFdpdGhFeHQnOiAke2Fic1BhdGhXaXRoRXh0fS4gTm90IHNldHRpbmdgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoICFwYXRoLmlzQWJzb2x1dGUoYWJzUGF0aFdpdGhFeHQpICkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRmlsZSBzZXQgYWJzUGF0aDogcGFzc2VkIG5vbi1hYnNvbHV0ZSAnYWJzUGF0aFdpdGhFeHQnOiAke2Fic1BhdGhXaXRoRXh0fS4gTm90IHNldHRpbmdgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLl9hYnNQYXRoID0gYWJzUGF0aFdpdGhFeHQ7XG4gICAgICAgIGZzLnJlbmFtZVN5bmModGhpcy5fYWJzUGF0aCwgYWJzUGF0aFdpdGhFeHQpO1xuICAgIH1cbiAgICBcbiAgICAvKnRvU3RyaW5nKCkge1xuICAgICByZXR1cm4gdGhpcy5wYXRoO1xuICAgICB9Ki9cbiAgICAvKipAZGVwcmVjYXRlZCovXG4gICAgcmVuYW1lQnlPdGhlckZpbGUob3RoZXI6IEZpbGUpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdjYWxsZWQgcmVuYW1lQnlPdGhlckZpbGUoKSwgdXNlIHNldCBhYnNQYXRoIGluc3RlYWQnKTtcbiAgICAgICAgdGhpcy5hYnNQYXRoID0gb3RoZXIuYWJzUGF0aDtcbiAgICB9XG4gICAgXG4gICAgcmVuYW1lQnlDVGltZSgpIHtcbiAgICAgICAgY29uc3Qgc3RhdHMgPSBmcy5sc3RhdFN5bmModGhpcy5hYnNQYXRoKTtcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICBjb25zdCBkYXRlc3RyID0gc3RhdHMuY3RpbWUuaHVtYW4oKTtcbiAgICAgICAgY29uc3QgbmV3UGF0aCA9IG15ZnMucHVzaF9iZWZvcmVfZXh0KHRoaXMuYWJzUGF0aCwgYF9fQ1JFQVRFRF8ke2RhdGVzdHJ9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdyZW5hbWVCeUNUaW1lKCkgdG86ICcsIG5ld1BhdGgpO1xuICAgICAgICB0aGlzLmFic1BhdGggPSBuZXdQYXRoO1xuICAgIH1cbiAgICBcbiAgICBcbiAgICBhc3luYyBnZXRCaXRyYXRlQW5kSGVpZ2h0KCk6IFByb21pc2U8WyBzdHJpbmcsIHN0cmluZyBdPiB7XG4gICAgICAgIGlmICggIXRoaXMuX2Fic1BhdGguZW5kc1dpdGgoJ21wNCcpICYmICF0aGlzLl9hYnNQYXRoLmVuZHNXaXRoKCdtb3YnKSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgRmlsZTogXCIke3RoaXMuX2Fic1BhdGh9XCIgaXNuJ3QgXCJtcDRcIiBvciBcIm1vdlwiYCk7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBleGVjU3luYyB9ID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuICAgICAgICBjb25zdCBmZnByb2JlQ21kID0gYGZmcHJvYmUgLXYgcXVpZXQgLXByaW50X2Zvcm1hdCBqc29uIC1zaG93X3N0cmVhbXMgLXNob3dfZm9ybWF0YDtcbiAgICAgICAgY29uc3QgcHJvYmUgPSBKU09OLnBhcnNlKGV4ZWNTeW5jKGAke2ZmcHJvYmVDbWR9IFwiJHt0aGlzLl9hYnNQYXRofVwiYCwgeyBlbmNvZGluZyA6ICd1dGY4JyB9KSk7XG4gICAgICAgIGNvbnN0IHsgYml0X3JhdGUsIGhlaWdodCB9ID0gcHJvYmUuc3RyZWFtcy5maW5kKHMgPT4gc1tcImNvZGVjX3R5cGVcIl0gPT09IFwidmlkZW9cIik7XG4gICAgICAgIHJldHVybiBbIGJpdF9yYXRlLCBoZWlnaHQgXTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgZXhpc3RzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZnMuZXhpc3RzU3luYyh0aGlzLl9hYnNQYXRoKTtcbiAgICB9XG4gICAgXG4gICAgcmVtb3ZlKCkge1xuICAgICAgICBmcy51bmxpbmtTeW5jKHRoaXMuX2Fic1BhdGgpO1xuICAgIH1cbiAgICBcbiAgICBzaXplKCk6IG51bWJlciB7XG4gICAgICAgIGxldCB7IHNpemUgfSA9IGZzLmxzdGF0U3luYyh0aGlzLl9hYnNQYXRoKTtcbiAgICAgICAgcmV0dXJuIHNpemU7XG4gICAgfVxufVxuXG5cbmNsYXNzIFR4dCB7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKi50eHRgYCBwYXRoLiovXG4gICAgcmVhZG9ubHkgYmFzZTogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWJzb2x1dGUgYGAqX29uLnR4dGBgICBwYXRoLiovXG4gICAgcmVhZG9ubHkgb246IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKl9vZmYudHh0YGAgcGF0aC4qL1xuICAgIHJlYWRvbmx5IG9mZjogRmlsZTtcbiAgICBcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihhYnNQYXRoTm9FeHQ6IHN0cmluZykge1xuICAgICAgICBpZiAoICFwYXRoLmlzQWJzb2x1dGUoYWJzUGF0aE5vRXh0KSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFR4dCBjb25zdHJ1Y3RvcjogcGFzc2VkICdhYnNQYXRoTm9FeHQnIE5PVCBhYnNvbHV0ZTogJHthYnNQYXRoTm9FeHR9LiByZXR1cm5pbmdgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIGJvb2wocGF0aC5leHRuYW1lKGFic1BhdGhOb0V4dCkpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBGaWxlIGNvbnN0cnVjdG9yOiBwYXNzZWQgJ2Fic1BhdGhOb0V4dCcgaXMgTk9UIGV4dGVuc2lvbmxlc3M6ICR7YWJzUGF0aE5vRXh0fS4gUmVtb3ZpbmcgZXh0YCk7XG4gICAgICAgICAgICBhYnNQYXRoTm9FeHQgPSBteWZzLnJlbW92ZV9leHQoYWJzUGF0aE5vRXh0KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmJhc2UgPSBuZXcgRmlsZShgJHthYnNQYXRoTm9FeHR9LnR4dGApO1xuICAgICAgICB0aGlzLm9uID0gbmV3IEZpbGUoYCR7YWJzUGF0aE5vRXh0fV9vbi50eHRgKTtcbiAgICAgICAgdGhpcy5vZmYgPSBuZXcgRmlsZShgJHthYnNQYXRoTm9FeHR9X29mZi50eHRgKTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGdldEFsbCgpOiBbIEZpbGUsIEZpbGUsIEZpbGUgXSB7XG4gICAgICAgIHJldHVybiBbIHRoaXMuYmFzZSwgdGhpcy5vbiwgdGhpcy5vZmYgXTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgLy8gZ2V0RXhpc3RpbmcoKTogWyAoRmlsZSB8IGZhbHNlKSwgKEZpbGUgfCBmYWxzZSksIChGaWxlIHwgZmFsc2UpIF0ge1xuICAgIGdldEV4aXN0aW5nKCk6IHsgYmFzZT86IEZpbGUsIG9uPzogRmlsZSwgb2ZmPzogRmlsZSB9IHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSB7XG4gICAgICAgICAgICBiYXNlIDogdGhpcy5iYXNlLmV4aXN0cygpID8gdGhpcy5iYXNlIDogdW5kZWZpbmVkLFxuICAgICAgICAgICAgb24gOiB0aGlzLm9uLmV4aXN0cygpID8gdGhpcy5vbiA6IHVuZGVmaW5lZCxcbiAgICAgICAgICAgIG9mZiA6IHRoaXMub2ZmLmV4aXN0cygpID8gdGhpcy5vZmYgOiB1bmRlZmluZWQsXG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZmlsZXM7XG4gICAgfVxuICAgIFxuICAgIGdldE1pc3NpbmcoKTogc3RyaW5nW10ge1xuICAgICAgICBjb25zdCBmaWxlcyA9IFtdO1xuICAgICAgICBpZiAoICF0aGlzLmJhc2UuZXhpc3RzKCkgKSB7XG4gICAgICAgICAgICBmaWxlcy5wdXNoKFwiYmFzZVwiKVxuICAgICAgICB9XG4gICAgICAgIGlmICggIXRoaXMub24uZXhpc3RzKCkgKSB7XG4gICAgICAgICAgICBmaWxlcy5wdXNoKFwib25cIilcbiAgICAgICAgfVxuICAgICAgICBpZiAoICF0aGlzLm9mZi5leGlzdHMoKSApIHtcbiAgICAgICAgICAgIGZpbGVzLnB1c2goXCJvZmZcIilcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmlsZXM7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBhbGxFeGlzdCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuYmFzZS5leGlzdHMoKVxuICAgICAgICAgICAgJiYgdGhpcy5vbi5leGlzdHMoKVxuICAgICAgICAgICAgJiYgdGhpcy5vZmYuZXhpc3RzKClcbiAgICAgICAgKTtcbiAgICB9XG4gICAgXG4gICAgYW55RXhpc3QoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmJhc2UuZXhpc3RzKClcbiAgICAgICAgICAgIHx8IHRoaXMub24uZXhpc3RzKClcbiAgICAgICAgICAgIHx8IHRoaXMub2ZmLmV4aXN0cygpXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICByZW1vdmVBbGwoKTogdm9pZCB7XG4gICAgICAgIGlmICggdGhpcy5iYXNlLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMuYmFzZS5yZW1vdmUoKTtcbiAgICAgICAgaWYgKCB0aGlzLm9uLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMub24ucmVtb3ZlKCk7XG4gICAgICAgIGlmICggdGhpcy5vZmYuZXhpc3RzKCkgKVxuICAgICAgICAgICAgdGhpcy5vZmYucmVtb3ZlKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICByZW5hbWVCeU90aGVyVHh0KG90aGVyOiBUeHQpOiB2b2lkIHtcbiAgICAgICAgLy8gY29uc29sZS53YXJuKCdyZW5hbWVCeU90aGVyVHh0OiBkaWRudCBzZXQgbmV3IHRoaXMgYmFzZSAvIG9uIC8gb2ZmJyk7XG4gICAgICAgIHRoaXMuYmFzZS5hYnNQYXRoID0gb3RoZXIuYmFzZS5hYnNQYXRoO1xuICAgICAgICB0aGlzLm9uLmFic1BhdGggPSBvdGhlci5vbi5hYnNQYXRoO1xuICAgICAgICB0aGlzLm9mZi5hYnNQYXRoID0gb3RoZXIub2ZmLmFic1BhdGg7XG4gICAgICAgIC8vIGZzLnJlbmFtZVN5bmModGhpcy5iYXNlLnBhdGgsIG90aGVyLmJhc2UucGF0aCk7XG4gICAgICAgIC8vIGZzLnJlbmFtZVN5bmModGhpcy5vbi5wYXRoLCBvdGhlci5vbi5wYXRoKTtcbiAgICAgICAgLy8gZnMucmVuYW1lU3luYyh0aGlzLm9mZi5wYXRoLCBvdGhlci5vZmYucGF0aCk7XG4gICAgICAgIFxuICAgIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZWFkb25seVRydXRoIHtcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgdHh0OiB7XG4gICAgICAgIGJhc2U6IHtcbiAgICAgICAgICAgIGFic1BhdGg6IHN0cmluZ1xuICAgICAgICB9LFxuICAgICAgICBvbjoge1xuICAgICAgICAgICAgYWJzUGF0aDogc3RyaW5nXG4gICAgICAgIH0sXG4gICAgICAgIG9mZjoge1xuICAgICAgICAgICAgYWJzUGF0aDogc3RyaW5nXG4gICAgICAgIH1cbiAgICB9LFxuICAgIG1pZGk6IHsgYWJzUGF0aDogc3RyaW5nIH0sXG4gICAgbXA0OiB7IGFic1BhdGg6IHN0cmluZyB9LFxuICAgIG9uc2V0czogeyBhYnNQYXRoOiBzdHJpbmcgfSxcbn1cblxuZXhwb3J0IGNsYXNzIFRydXRoIHtcbiAgICBcbiAgICAvKipUaGUgYmFzZW5hbWUgd2l0aG91dCBleHRlbnNpb24uKi9cbiAgICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gICAgcmVhZG9ubHkgdHh0OiBUeHQ7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbWlkaSBmaWxlLiovXG4gICAgcmVhZG9ubHkgbWlkaTogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBtcDQgZmlsZS4qL1xuICAgIHJlYWRvbmx5IG1wNDogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBtb3YgZmlsZS4qL1xuICAgIHJlYWRvbmx5IG1vdjogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBvbnNldHMgZmlsZS4qL1xuICAgIHJlYWRvbmx5IG9uc2V0czogRmlsZTtcbiAgICBcbiAgICAvKipcbiAgICAgKiBAcGFyYW0gbmFtZU5vRXh0IC0gRXhwZWN0cyBhIGZpbGUgYmFzZSBuYW1lIHdpdGggbm8gZXh0ZW5zaW9uLlxuICAgICAqIEBwYXJhbSBkaXIgLSBPcHRpb25hbCBhYnMgZGlyIHBhdGggb2YgdGhlIHRydXRoLiBEZWZhdWx0cyB0byBgVFJVVEhTX1BBVEhfQUJTYFxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKG5hbWVOb0V4dDogc3RyaW5nLCBkaXI/OiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IFsgbmFtZSwgZXh0IF0gPSBteWZzLnNwbGl0X2V4dChuYW1lTm9FeHQpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCBib29sKGV4dCkgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFRydXRoIGN0b3IsIHBhc3NlZCBuYW1lIGlzIG5vdCBleHRlbnNpb25sZXNzOiAke25hbWVOb0V4dH0uIENvbnRpbnVpbmcgd2l0aCBcIiR7bmFtZX1cImApO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAoIG5hbWUuZW5kc1dpdGhBbnkoJ19vZmYnLCAnX29uJykgKSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBUSElTIElTIEJVR0dZXG4gICAgICAgICAgICBuYW1lID0gYCR7bmFtZS51cFRvKCdfJywgdHJ1ZSl9YDtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgUGFzc2VkIHBhdGggb2YgXCJfb25cIiBvciBcIl9vZmZcIiBmaWxlIGFuZCBub3QgYmFzZS4gVXNpbmcgbmFtZTogXCIke25hbWV9XCJgKTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgaWYgKCAhYm9vbChkaXIpICkge1xuICAgICAgICAgICAgZGlyID0gVFJVVEhTX1BBVEhfQUJTO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGFic1BhdGhOb0V4dCA9IHBhdGguam9pbihkaXIsIG5hbWUpO1xuICAgICAgICB0aGlzLnR4dCA9IG5ldyBUeHQoYWJzUGF0aE5vRXh0KTtcbiAgICAgICAgdGhpcy5taWRpID0gbmV3IEZpbGUoYCR7YWJzUGF0aE5vRXh0fS5taWRgKTtcbiAgICAgICAgdGhpcy5tcDQgPSBuZXcgRmlsZShgJHthYnNQYXRoTm9FeHR9Lm1wNGApO1xuICAgICAgICB0aGlzLm1vdiA9IG5ldyBGaWxlKGAke2Fic1BhdGhOb0V4dH0ubW92YCk7XG4gICAgICAgIHRoaXMub25zZXRzID0gbmV3IEZpbGUoYCR7YWJzUGF0aE5vRXh0fV9vbnNldHMuanNvbmApO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgdG9SZWFkT25seSguLi5pbmNsdWRlOiAoXCJ0eHRcIiB8IFwibWlkaVwiIHwgXCJtcDRcIiB8IFwib25zZXRzXCIpW10pOiBSZWFkb25seVRydXRoIHtcbiAgICAgICAgbGV0IHJlYWRvbmx5VHJ1dGggPSB7fSBhcyBSZWFkb25seVRydXRoO1xuICAgICAgICBjb25zdCByZWFkb25seVR4dCA9ICgpID0+ICh7XG4gICAgICAgICAgICBiYXNlIDoge1xuICAgICAgICAgICAgICAgIGFic1BhdGggOiB0aGlzLnR4dC5iYXNlLmFic1BhdGhcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvbiA6IHtcbiAgICAgICAgICAgICAgICBhYnNQYXRoIDogdGhpcy50eHQub24uYWJzUGF0aFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9mZiA6IHtcbiAgICAgICAgICAgICAgICBhYnNQYXRoIDogdGhpcy50eHQub2ZmLmFic1BhdGhcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IHJlYWRvbmx5U3ViRmlsZSA9IChzdWJmaWxlOiBcIm1pZGlcIiB8IFwibXA0XCIgfCBcIm9uc2V0c1wiKSA9PiAoe1xuICAgICAgICAgICAgYWJzUGF0aCA6IHRoaXNbc3ViZmlsZV0uYWJzUGF0aFxuICAgICAgICB9KTtcbiAgICAgICAgaWYgKCBpbmNsdWRlICkge1xuICAgICAgICAgICAgZm9yICggbGV0IGluYyBvZiBpbmNsdWRlICkge1xuICAgICAgICAgICAgICAgIHN3aXRjaCAoIGluYyApIHtcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBcInR4dFwiOlxuICAgICAgICAgICAgICAgICAgICAgICAgcmVhZG9ubHlUcnV0aC50eHQgPSByZWFkb25seVR4dCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtaWRpXCI6XG4gICAgICAgICAgICAgICAgICAgICAgICByZWFkb25seVRydXRoLm1pZGkgPSByZWFkb25seVN1YkZpbGUoXCJtaWRpXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgXCJtcDRcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRvbmx5VHJ1dGgubXA0ID0gcmVhZG9ubHlTdWJGaWxlKFwibXA0XCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgXCJvbnNldHNcIjpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlYWRvbmx5VHJ1dGgub25zZXRzID0gcmVhZG9ubHlTdWJGaWxlKFwib25zZXRzXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWFkb25seVRydXRoID0ge1xuICAgICAgICAgICAgICAgIG5hbWUgOiB0aGlzLm5hbWUsXG4gICAgICAgICAgICAgICAgdHh0IDogcmVhZG9ubHlUeHQoKSxcbiAgICAgICAgICAgICAgICBtcDQgOiByZWFkb25seVN1YkZpbGUoXCJtcDRcIiksXG4gICAgICAgICAgICAgICAgb25zZXRzIDogcmVhZG9ubHlTdWJGaWxlKFwib25zZXRzXCIpLFxuICAgICAgICAgICAgICAgIG1pZGkgOiByZWFkb25seVN1YkZpbGUoXCJtaWRpXCIpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlYWRvbmx5VHJ1dGg7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICAvKipDb3VudHMgdGhlIG51bWJlciBvZiBub24tZW1wdHkgbGluZXMgaW4gdGhlIHR4dCBvbiBwYXRoIGZpbGUuKi9cbiAgICBudW1PZk5vdGVzKCk6IG51bWJlciB7XG4gICAgICAgIGlmICggIXRoaXMudHh0Lm9uLmV4aXN0cygpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGB0aGlzLnR4dC5vbiAoJHt0aGlzLnR4dC5vbi5hYnNQYXRofSkgZG9lcyBub3QgZXhpc3QsIHJldHVybmluZyB1bmRlZmluZWRgKTtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBzdHJpbmdzID0gZnNcbiAgICAgICAgICAgIC5yZWFkRmlsZVN5bmModGhpcy50eHQub24uYWJzUGF0aCwgeyBlbmNvZGluZyA6ICd1dGY4JyB9KVxuICAgICAgICAgICAgLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgbGV0IG5vdGVzOiBudW1iZXIgPSAwO1xuICAgICAgICBmb3IgKCBsZXQgcyBvZiBzdHJpbmdzICkge1xuICAgICAgICAgICAgaWYgKCBzLmluY2x1ZGVzKCdcXFxcJykgKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGBzIGluY2x1ZGVzIGJhY2tzbGFzaCwgJHt0aGlzLnR4dC5vbn1gKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGJvb2wocykgKSB7XG4gICAgICAgICAgICAgICAgbm90ZXMrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBub3RlcztcbiAgICB9XG59XG4iXX0=