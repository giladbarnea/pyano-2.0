"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const MyFs_1 = require("../MyFs");
const str_1 = require("../str");
const MyDate_1 = require("../MyDate");
const util_1 = require("../util");
class File {
    constructor(pathWithExt) {
        if (!util_1.bool(path.extname(pathWithExt))) {
            throw new Error(`File constructor: passed 'pathWithExt' is extensionless: ${pathWithExt}`);
        }
        this.path = pathWithExt;
        this.pathNoExt = MyFs_1.default.remove_ext(this.path);
        if (path.isAbsolute(this.path))
            this.name = new File(path.basename(this.path));
    }
    toString() {
        return this.path;
    }
    renameByOtherFile(other) {
        console.warn('renameByOtherFile not setting new this.path');
        fs.renameSync(this.path, other.path);
    }
    renameByCTime() {
        console.warn('renameByCTime not setting new this.path');
        const stats = fs.lstatSync(this.path);
        const datestr = MyDate_1.date(stats.ctime).human();
        const newPath = MyFs_1.default.push_before_ext(this.path, `__CREATED_${datestr}`);
        console.log('renameByCTime() to: ', newPath);
        fs.renameSync(this.path, newPath);
    }
    async getBitrateAndHeight() {
        if (!this.path.endsWith('mp4') && !this.path.endsWith('mov')) {
            console.warn(`File: "${this.path}" isn't "mp4" or "mov"`);
            return undefined;
        }
        const { execSync } = require('child_process');
        const ffprobeCmd = `ffprobe -v quiet -print_format json -show_streams -show_format`;
        const probe = JSON.parse(execSync(`${ffprobeCmd} "${this.path}"`, { encoding: 'utf8' }));
        const { bit_rate, height } = probe.streams.find(s => s["codec_type"] === "video");
        return [bit_rate, height];
    }
    exists() {
        return fs.existsSync(this.path);
    }
    remove() {
        fs.unlinkSync(this.path);
    }
    size() {
        let { size } = fs.lstatSync(this.path);
        return size;
    }
}
class Txt {
    constructor(pathNoExt) {
        this.base = new File(`${pathNoExt}.txt`);
        this.on = new File(`${pathNoExt}_on.txt`);
        this.off = new File(`${pathNoExt}_off.txt`);
    }
    getAll() {
        return [this.base, this.on, this.off];
    }
    getExisting() {
        const existing = [];
        existing.push(this.base.exists() ? this.base : false);
        existing.push(this.on.exists() ? this.on : false);
        existing.push(this.off.exists() ? this.off : false);
        return existing;
    }
    allExist() {
        return (this.base.exists()
            && this.on.exists()
            && this.off.exists());
    }
    anyExist() {
        return (this.base.exists()
            || this.on.exists()
            || this.off.exists());
    }
    removeAll() {
        if (this.base.exists())
            this.base.remove();
        if (this.on.exists())
            this.on.remove();
        if (this.off.exists())
            this.off.remove();
    }
    renameByOtherTxt(other) {
        console.warn('renameByOtherTxt: didnt set new this base / on / off');
        fs.renameSync(this.base.path, other.base.path);
        fs.renameSync(this.on.path, other.on.path);
        fs.renameSync(this.off.path, other.off.path);
    }
}
class Truth {
    constructor(pathNoExt) {
        if (!path.isAbsolute(pathNoExt))
            throw new Error(`Passed path is not absolute: ${pathNoExt}`);
        if (util_1.bool(path.extname(pathNoExt))) {
            console.warn(`Passed path is not extensionless: ${pathNoExt}. Removing extension`);
            pathNoExt = MyFs_1.default.remove_ext(pathNoExt);
        }
        if (pathNoExt.endsWith('off') || pathNoExt.endsWith('on')) {
            console.warn(`Passed path of "_on" or "_off" file and not base: ${pathNoExt}. Using base`);
            let noExt = str_1.str(MyFs_1.default.remove_ext(pathNoExt));
            pathNoExt = `${noExt.upTo('_', true)}${path.extname(pathNoExt)}`;
        }
        this.pathNoExt = pathNoExt;
        this.name = path.basename(this.pathNoExt);
        this.txt = new Txt(this.pathNoExt);
        this.midi = new File(`${this.pathNoExt}.mid`);
        this.mp4 = new File(`${this.pathNoExt}.mp4`);
        this.mov = new File(`${this.pathNoExt}.mov`);
        this.onsets = new File(`${this.pathNoExt}_onsets.json`);
    }
    numOfNotes() {
        if (!this.txt.on.exists()) {
            console.warn(`this.txt.on (${this.txt.on}) does not exist, returning undefined`);
            return undefined;
        }
        const strings = fs
            .readFileSync(this.txt.on.path, { encoding: 'utf8' })
            .split('\n');
        let notes = 0;
        for (let s of strings) {
            if (s.includes('\\')) {
                console.warn(`s includes backslash, ${this.txt.on}`);
            }
            else if (util_1.bool(s)) {
                notes++;
            }
        }
        return notes;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3Qix5QkFBd0I7QUFDeEIsa0NBQTBCO0FBRTFCLGdDQUE2QjtBQUM3QixzQ0FBaUM7QUFDakMsa0NBQXlDO0FBS3pDLE1BQU0sSUFBSTtJQVFOLFlBQVksV0FBbUI7UUFDM0IsSUFBSyxDQUFDLFdBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUc7WUFDcEMsTUFBTSxJQUFJLEtBQUssQ0FBQyw0REFBNEQsV0FBVyxFQUFFLENBQUMsQ0FBQztTQUM5RjtRQUVELElBQUksQ0FBQyxJQUFJLEdBQUcsV0FBVyxDQUFDO1FBRXhCLElBQUksQ0FBQyxTQUFTLEdBQUcsY0FBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsSUFBSyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7WUFFM0IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBRXZELENBQUM7SUFFRCxRQUFRO1FBQ0osT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxLQUFXO1FBQ3pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsNkNBQTZDLENBQUMsQ0FBQztRQUM1RCxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRCxhQUFhO1FBQ1QsT0FBTyxDQUFDLElBQUksQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1FBQ3hELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxD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QUFHO2dCQUNsQixLQUFLLEVBQUUsQ0FBQzthQUNYO1NBRUo7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcbmltcG9ydCBteWZzIGZyb20gJy4uL015RnMnXG5pbXBvcnQgYXN4IGZyb20gJy4uL2FzeCdcbmltcG9ydCB7IHN0ciB9IGZyb20gXCIuLi9zdHJcIjtcbmltcG9ydCB7IGRhdGUgfSBmcm9tIFwiLi4vTXlEYXRlXCI7XG5pbXBvcnQgeyBib29sLCBhbGwsIGFueSB9IGZyb20gXCIuLi91dGlsXCI7XG5cbi8qKkFuIG9iamVjdCB3cmFwcGluZyBhIHBhdGggd2l0aCBleHRlbnNpb24uIENhbiBiZSBhYnNvbHV0ZSBvciBiYXNlLlxuICogYGB0b1N0cmluZygpYGAgcmV0dXJucyBgYHRoaXMucGF0aGBgLlxuICogYGBuYW1lYGAgcHJvcGVydHkgZXhpc3RzIG9ubHkgaWYgd3JhcHBpbmcgYW4gYWJzb2x1dGUgcGF0aC4qL1xuY2xhc3MgRmlsZSB7XG4gICAgLyoqVGhlIHBhdGggaW5jbHVkaW5nIGV4dGVuc2lvbi4gQ2FuIGJlIGVpdGhlciBhYnNvbHV0ZSBvciBhIGZpbGUgbmFtZS4qL1xuICAgIHJlYWRvbmx5IHBhdGg6IHN0cmluZztcbiAgICAvKipUaGUgcGF0aCB3aXRob3V0IGV4dGVuc2lvbi4gQ2FuIGJlIGVpdGhlciBhYnNvbHV0ZSBvciBhIGZpbGUgbmFtZS4qL1xuICAgIHByaXZhdGUgcGF0aE5vRXh0OiBzdHJpbmc7XG4gICAgLyoqSWYgZXhpc3RzLCBhIEZpbGUgb2JqZWN0IG9mIHRoZSBiYXNlbmFtZS4qL1xuICAgIHByaXZhdGUgbmFtZTogRmlsZTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihwYXRoV2l0aEV4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICggIWJvb2wocGF0aC5leHRuYW1lKHBhdGhXaXRoRXh0KSkgKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGUgY29uc3RydWN0b3I6IHBhc3NlZCAncGF0aFdpdGhFeHQnIGlzIGV4dGVuc2lvbmxlc3M6ICR7cGF0aFdpdGhFeHR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMucGF0aCA9IHBhdGhXaXRoRXh0O1xuICAgICAgICBcbiAgICAgICAgdGhpcy5wYXRoTm9FeHQgPSBteWZzLnJlbW92ZV9leHQodGhpcy5wYXRoKTtcbiAgICAgICAgaWYgKCBwYXRoLmlzQWJzb2x1dGUodGhpcy5wYXRoKSApXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMubmFtZSA9IG5ldyBGaWxlKHBhdGguYmFzZW5hbWUodGhpcy5wYXRoKSk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICB0b1N0cmluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucGF0aDtcbiAgICB9XG4gICAgXG4gICAgcmVuYW1lQnlPdGhlckZpbGUob3RoZXI6IEZpbGUpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdyZW5hbWVCeU90aGVyRmlsZSBub3Qgc2V0dGluZyBuZXcgdGhpcy5wYXRoJyk7XG4gICAgICAgIGZzLnJlbmFtZVN5bmModGhpcy5wYXRoLCBvdGhlci5wYXRoKTtcbiAgICB9XG4gICAgXG4gICAgcmVuYW1lQnlDVGltZSgpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdyZW5hbWVCeUNUaW1lIG5vdCBzZXR0aW5nIG5ldyB0aGlzLnBhdGgnKTtcbiAgICAgICAgY29uc3Qgc3RhdHMgPSBmcy5sc3RhdFN5bmModGhpcy5wYXRoKTtcbiAgICAgICAgY29uc3QgZGF0ZXN0ciA9IGRhdGUoc3RhdHMuY3RpbWUpLmh1bWFuKCk7XG4gICAgICAgIGNvbnN0IG5ld1BhdGggPSBteWZzLnB1c2hfYmVmb3JlX2V4dCh0aGlzLnBhdGgsIGBfX0NSRUFURURfJHtkYXRlc3RyfWApO1xuICAgICAgICBjb25zb2xlLmxvZygncmVuYW1lQnlDVGltZSgpIHRvOiAnLCBuZXdQYXRoKTtcbiAgICAgICAgZnMucmVuYW1lU3luYyh0aGlzLnBhdGgsIG5ld1BhdGgpO1xuICAgIH1cbiAgICBcbiAgICBcbiAgICBhc3luYyBnZXRCaXRyYXRlQW5kSGVpZ2h0KCk6IFByb21pc2U8WyBzdHJpbmcsIHN0cmluZyBdPiB7XG4gICAgICAgIGlmICggIXRoaXMucGF0aC5lbmRzV2l0aCgnbXA0JykgJiYgIXRoaXMucGF0aC5lbmRzV2l0aCgnbW92JykgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYEZpbGU6IFwiJHt0aGlzLnBhdGh9XCIgaXNuJ3QgXCJtcDRcIiBvciBcIm1vdlwiYCk7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgeyBleGVjU3luYyB9ID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuICAgICAgICBjb25zdCBmZnByb2JlQ21kID0gYGZmcHJvYmUgLXYgcXVpZXQgLXByaW50X2Zvcm1hdCBqc29uIC1zaG93X3N0cmVhbXMgLXNob3dfZm9ybWF0YDtcbiAgICAgICAgY29uc3QgcHJvYmUgPSBKU09OLnBhcnNlKGV4ZWNTeW5jKGAke2ZmcHJvYmVDbWR9IFwiJHt0aGlzLnBhdGh9XCJgLCB7IGVuY29kaW5nIDogJ3V0ZjgnIH0pKTtcbiAgICAgICAgY29uc3QgeyBiaXRfcmF0ZSwgaGVpZ2h0IH0gPSBwcm9iZS5zdHJlYW1zLmZpbmQocyA9PiBzW1wiY29kZWNfdHlwZVwiXSA9PT0gXCJ2aWRlb1wiKTtcbiAgICAgICAgcmV0dXJuIFsgYml0X3JhdGUsIGhlaWdodCBdO1xuICAgIH1cbiAgICBcbiAgICBcbiAgICBleGlzdHMoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBmcy5leGlzdHNTeW5jKHRoaXMucGF0aCk7XG4gICAgfVxuICAgIFxuICAgIHJlbW92ZSgpIHtcbiAgICAgICAgZnMudW5saW5rU3luYyh0aGlzLnBhdGgpO1xuICAgIH1cbiAgICBcbiAgICBzaXplKCk6IG51bWJlciB7XG4gICAgICAgIGxldCB7IHNpemUgfSA9IGZzLmxzdGF0U3luYyh0aGlzLnBhdGgpO1xuICAgICAgICByZXR1cm4gc2l6ZTtcbiAgICB9XG59XG5cbmNsYXNzIFR4dCB7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKi50eHRgYCBwYXRoLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBiYXNlOiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBhYnNvbHV0ZSBgYCpfb24udHh0YGAgIHBhdGguKi9cbiAgICByZWFkb25seSBvbjogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWJzb2x1dGUgYGAqX29mZi50eHRgYCBwYXRoLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBvZmY6IEZpbGU7XG4gICAgXG4gICAgY29uc3RydWN0b3IocGF0aE5vRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5iYXNlID0gbmV3IEZpbGUoYCR7cGF0aE5vRXh0fS50eHRgKTtcbiAgICAgICAgdGhpcy5vbiA9IG5ldyBGaWxlKGAke3BhdGhOb0V4dH1fb24udHh0YCk7XG4gICAgICAgIHRoaXMub2ZmID0gbmV3IEZpbGUoYCR7cGF0aE5vRXh0fV9vZmYudHh0YCk7XG4gICAgfVxuICAgIFxuICAgIGdldEFsbCgpOiBbIEZpbGUsIEZpbGUsIEZpbGUgXSB7XG4gICAgICAgIHJldHVybiBbIHRoaXMuYmFzZSwgdGhpcy5vbiwgdGhpcy5vZmYgXTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgZ2V0RXhpc3RpbmcoKTogWyAoRmlsZSB8IGZhbHNlKSwgKEZpbGUgfCBmYWxzZSksIChGaWxlIHwgZmFsc2UpIF0ge1xuICAgICAgICBjb25zdCBleGlzdGluZyA9IFtdO1xuICAgICAgICBleGlzdGluZy5wdXNoKHRoaXMuYmFzZS5leGlzdHMoKSA/IHRoaXMuYmFzZSA6IGZhbHNlKTtcbiAgICAgICAgZXhpc3RpbmcucHVzaCh0aGlzLm9uLmV4aXN0cygpID8gdGhpcy5vbiA6IGZhbHNlKTtcbiAgICAgICAgZXhpc3RpbmcucHVzaCh0aGlzLm9mZi5leGlzdHMoKSA/IHRoaXMub2ZmIDogZmFsc2UpO1xuICAgICAgICBcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICByZXR1cm4gZXhpc3Rpbmc7XG4gICAgfVxuICAgIFxuICAgIGFsbEV4aXN0KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgdGhpcy5iYXNlLmV4aXN0cygpXG4gICAgICAgICAgICAmJiB0aGlzLm9uLmV4aXN0cygpXG4gICAgICAgICAgICAmJiB0aGlzLm9mZi5leGlzdHMoKVxuICAgICAgICApO1xuICAgIH1cbiAgICBcbiAgICBhbnlFeGlzdCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuYmFzZS5leGlzdHMoKVxuICAgICAgICAgICAgfHwgdGhpcy5vbi5leGlzdHMoKVxuICAgICAgICAgICAgfHwgdGhpcy5vZmYuZXhpc3RzKClcbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHJlbW92ZUFsbCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKCB0aGlzLmJhc2UuZXhpc3RzKCkgKVxuICAgICAgICAgICAgdGhpcy5iYXNlLnJlbW92ZSgpO1xuICAgICAgICBpZiAoIHRoaXMub24uZXhpc3RzKCkgKVxuICAgICAgICAgICAgdGhpcy5vbi5yZW1vdmUoKTtcbiAgICAgICAgaWYgKCB0aGlzLm9mZi5leGlzdHMoKSApXG4gICAgICAgICAgICB0aGlzLm9mZi5yZW1vdmUoKTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIHJlbmFtZUJ5T3RoZXJUeHQob3RoZXI6IFR4dCk6IHZvaWQge1xuICAgICAgICBjb25zb2xlLndhcm4oJ3JlbmFtZUJ5T3RoZXJUeHQ6IGRpZG50IHNldCBuZXcgdGhpcyBiYXNlIC8gb24gLyBvZmYnKTtcbiAgICAgICAgZnMucmVuYW1lU3luYyh0aGlzLmJhc2UucGF0aCwgb3RoZXIuYmFzZS5wYXRoKTtcbiAgICAgICAgZnMucmVuYW1lU3luYyh0aGlzLm9uLnBhdGgsIG90aGVyLm9uLnBhdGgpO1xuICAgICAgICBmcy5yZW5hbWVTeW5jKHRoaXMub2ZmLnBhdGgsIG90aGVyLm9mZi5wYXRoKTtcbiAgICAgICAgXG4gICAgfVxufVxuXG5jbGFzcyBUcnV0aCB7XG4gICAgLyoqVGhlIGFic29sdXRlIHBhdGggd2l0aG91dCBleHRlbnNpb24uKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhdGhOb0V4dDogc3RyaW5nO1xuICAgIC8qKlRoZSBiYXNlbmFtZSB3aXRob3V0IGV4dGVuc2lvbi4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdHh0OiBUeHQ7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbWlkaSBmaWxlLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBtaWRpOiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG1wNCBmaWxlLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBtcDQ6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbW92IGZpbGUuKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IG1vdjogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBvbnNldHMgZmlsZS4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgb25zZXRzOiBGaWxlO1xuICAgIFxuICAgIC8qKkFuIG9iamVjdCB3cmFwcGluZyBhbiBhYnNvbHV0ZSBwYXRoIHdpdGhvdXQgZXh0ZW5zaW9uLiovXG4gICAgY29uc3RydWN0b3IocGF0aE5vRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCAhcGF0aC5pc0Fic29sdXRlKHBhdGhOb0V4dCkgKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYXNzZWQgcGF0aCBpcyBub3QgYWJzb2x1dGU6ICR7cGF0aE5vRXh0fWApO1xuICAgICAgICBpZiAoIGJvb2wocGF0aC5leHRuYW1lKHBhdGhOb0V4dCkpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBQYXNzZWQgcGF0aCBpcyBub3QgZXh0ZW5zaW9ubGVzczogJHtwYXRoTm9FeHR9LiBSZW1vdmluZyBleHRlbnNpb25gKTtcbiAgICAgICAgICAgIHBhdGhOb0V4dCA9IG15ZnMucmVtb3ZlX2V4dChwYXRoTm9FeHQpO1xuICAgICAgICB9XG4gICAgICAgIGlmICggcGF0aE5vRXh0LmVuZHNXaXRoKCdvZmYnKSB8fCBwYXRoTm9FeHQuZW5kc1dpdGgoJ29uJykgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYFBhc3NlZCBwYXRoIG9mIFwiX29uXCIgb3IgXCJfb2ZmXCIgZmlsZSBhbmQgbm90IGJhc2U6ICR7cGF0aE5vRXh0fS4gVXNpbmcgYmFzZWApO1xuICAgICAgICAgICAgbGV0IG5vRXh0ID0gc3RyKG15ZnMucmVtb3ZlX2V4dChwYXRoTm9FeHQpKTtcbiAgICAgICAgICAgIHBhdGhOb0V4dCA9IGAke25vRXh0LnVwVG8oJ18nLCB0cnVlKX0ke3BhdGguZXh0bmFtZShwYXRoTm9FeHQpfWA7XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdGhpcy5wYXRoTm9FeHQgPSBwYXRoTm9FeHQ7XG4gICAgICAgIFxuICAgICAgICB0aGlzLm5hbWUgPSBwYXRoLmJhc2VuYW1lKHRoaXMucGF0aE5vRXh0KTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMudHh0ID0gbmV3IFR4dCh0aGlzLnBhdGhOb0V4dCk7XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgdGhpcy5taWRpID0gbmV3IEZpbGUoYCR7dGhpcy5wYXRoTm9FeHR9Lm1pZGApO1xuICAgICAgICB0aGlzLm1wNCA9IG5ldyBGaWxlKGAke3RoaXMucGF0aE5vRXh0fS5tcDRgKTtcbiAgICAgICAgdGhpcy5tb3YgPSBuZXcgRmlsZShgJHt0aGlzLnBhdGhOb0V4dH0ubW92YCk7XG4gICAgICAgIHRoaXMub25zZXRzID0gbmV3IEZpbGUoYCR7dGhpcy5wYXRoTm9FeHR9X29uc2V0cy5qc29uYCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICAvKipDb3VudHMgdGhlIG51bWJlciBvZiBub24tZW1wdHkgbGluZXMgaW4gdGhlIHR4dCBvbiBwYXRoIGZpbGUuKi9cbiAgICBudW1PZk5vdGVzKCk6IG51bWJlciB7XG4gICAgICAgIGlmICggIXRoaXMudHh0Lm9uLmV4aXN0cygpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGB0aGlzLnR4dC5vbiAoJHt0aGlzLnR4dC5vbn0pIGRvZXMgbm90IGV4aXN0LCByZXR1cm5pbmcgdW5kZWZpbmVkYCk7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3RyaW5ncyA9IGZzXG4gICAgICAgICAgICAucmVhZEZpbGVTeW5jKHRoaXMudHh0Lm9uLnBhdGgsIHsgZW5jb2RpbmcgOiAndXRmOCcgfSlcbiAgICAgICAgICAgIC5zcGxpdCgnXFxuJyk7XG4gICAgICAgIGxldCBub3RlczogbnVtYmVyID0gMDtcbiAgICAgICAgZm9yICggbGV0IHMgb2Ygc3RyaW5ncyApIHtcbiAgICAgICAgICAgIGlmICggcy5pbmNsdWRlcygnXFxcXCcpICkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihgcyBpbmNsdWRlcyBiYWNrc2xhc2gsICR7dGhpcy50eHQub259YCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCBib29sKHMpICkge1xuICAgICAgICAgICAgICAgIG5vdGVzKys7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbm90ZXM7XG4gICAgfVxufVxuIl19