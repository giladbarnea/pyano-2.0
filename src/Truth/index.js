"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const MyFs_1 = require("../MyFs");
const str_1 = require("../str");
const MyDate_1 = require("../MyDate");
const util_1 = require("../util");
/**An object wrapping a path with extension. Can be absolute or base.
 * ``toString()`` returns ``this.path``.
 * ``name`` property exists only if wrapping an absolute path.*/
class File {
    constructor(pathWithExt) {
        if (!util_1.bool(path.extname(pathWithExt))) {
            throw new Error(`File constructor: passed 'pathWithExt' is extensionless: ${pathWithExt}`);
        }
        this.path = pathWithExt;
        this.pathNoExt = MyFs_1.default.remove_ext(this.path);
        if (path.isAbsolute(this.path))
            this.name = new File(path.basename(this.path));
    }
    toString() {
        return this.path;
    }
    renameByOtherFile(other) {
        console.warn('renameByOtherFile not setting new this.path');
        fs.renameSync(this.path, other.path);
    }
    renameByCTime() {
        console.warn('renameByCTime not setting new this.path');
        const stats = fs.lstatSync(this.path);
        const datestr = MyDate_1.date(stats.ctime).human();
        const newPath = MyFs_1.default.push_before_ext(this.path, `__CREATED_${datestr}`);
        console.log('renameByCTime() to: ', newPath);
        fs.renameSync(this.path, newPath);
    }
    async getBitrateAndHeight() {
        if (!this.path.endsWith('mp4') && !this.path.endsWith('mov')) {
            console.warn(`File: "${this.path}" isn't "mp4" or "mov"`);
            return undefined;
        }
        const { execSync } = require('child_process');
        const ffprobeCmd = `ffprobe -v quiet -print_format json -show_streams -show_format`;
        const probe = JSON.parse(execSync(`${ffprobeCmd} "${this.path}"`, { encoding: 'utf8' }));
        const { bit_rate, height } = probe.streams.find(s => s["codec_type"] === "video");
        return [bit_rate, height];
    }
    exists() {
        return fs.existsSync(this.path);
    }
    remove() {
        fs.unlinkSync(this.path);
    }
    size() {
        let { size } = fs.lstatSync(this.path);
        return size;
    }
}
class Txt {
    constructor(pathNoExt) {
        this.base = new File(`${pathNoExt}.txt`);
        this.on = new File(`${pathNoExt}_on.txt`);
        this.off = new File(`${pathNoExt}_off.txt`);
    }
    getAll() {
        return [this.base, this.on, this.off];
    }
    getExisting() {
        const existing = [];
        existing.push(this.base.exists() ? this.base : false);
        existing.push(this.on.exists() ? this.on : false);
        existing.push(this.off.exists() ? this.off : false);
        // @ts-ignore
        return existing;
    }
    allExist() {
        return (this.base.exists()
            && this.on.exists()
            && this.off.exists());
    }
    anyExist() {
        return (this.base.exists()
            || this.on.exists()
            || this.off.exists());
    }
    removeAll() {
        if (this.base.exists())
            this.base.remove();
        if (this.on.exists())
            this.on.remove();
        if (this.off.exists())
            this.off.remove();
    }
    renameByOtherTxt(other) {
        console.warn('renameByOtherTxt: didnt set new this base / on / off');
        fs.renameSync(this.base.path, other.base.path);
        fs.renameSync(this.on.path, other.on.path);
        fs.renameSync(this.off.path, other.off.path);
    }
}
class Truth {
    /**An object wrapping an absolute path without extension.*/
    constructor(pathNoExt) {
        if (!path.isAbsolute(pathNoExt))
            throw new Error(`Passed path is not absolute: ${pathNoExt}`);
        if (util_1.bool(path.extname(pathNoExt))) {
            console.warn(`Passed path is not extensionless: ${pathNoExt}. Removing extension`);
            pathNoExt = MyFs_1.default.remove_ext(pathNoExt);
        }
        if (pathNoExt.endsWith('off') || pathNoExt.endsWith('on')) {
            console.warn(`Passed path of "_on" or "_off" file and not base: ${pathNoExt}. Using base`);
            let noExt = str_1.str(MyFs_1.default.remove_ext(pathNoExt));
            pathNoExt = `${noExt.upTo('_', true)}${path.extname(pathNoExt)}`;
        }
        this.pathNoExt = pathNoExt;
        this.name = path.basename(this.pathNoExt);
        this.txt = new Txt(this.pathNoExt);
        this.midi = new File(`${this.pathNoExt}.mid`);
        this.mp4 = new File(`${this.pathNoExt}.mp4`);
        this.mov = new File(`${this.pathNoExt}.mov`);
        this.onsets = new File(`${this.pathNoExt}_onsets.json`);
    }
    /**Counts the number of non-empty lines in the txt on path file.*/
    numOfNotes() {
        if (!this.txt.on.exists()) {
            console.warn(`this.txt.on (${this.txt.on}) does not exist, returning undefined`);
            return undefined;
        }
        const strings = fs
            .readFileSync(this.txt.on.path, { encoding: 'utf8' })
            .split('\n');
        let notes = 0;
        for (let s of strings) {
            if (s.includes('\\')) {
                console.warn(`s includes backslash, ${this.txt.on}`);
            }
            else if (util_1.bool(s)) {
                notes++;
            }
        }
        return notes;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3Qix5QkFBd0I7QUFDeEIsa0NBQTBCO0FBRTFCLGdDQUE2QjtBQUM3QixzQ0FBaUM7QUFDakMsa0NBQXlDO0FBRXpDOztnRUFFZ0U7QUFDaEUsTUFBTSxJQUFJO0lBUU4sWUFBWSxXQUFtQjtRQUMzQixJQUFLLENBQUMsV0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRztZQUNwQyxNQUFNLElBQUksS0FBSyxDQUFDLDREQUE0RCxXQUFXLEVBQUUsQ0FBQyxDQUFDO1NBQzlGO1FBRUQsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUM7UUFFeEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxjQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxJQUFLLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUUzQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFdkQsQ0FBQztJQUVELFFBQVE7UUFDSixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUVELGlCQUFpQixDQUFDLEtBQVc7UUFDekIsT0FBTyxDQUFDLElBQUksQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDO1FBQzVELEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELGFBQWE7UUFDVCxPQUFPLENBQUMsSUFBSSxDQUFDLHlDQUF5QyxDQUFDLENBQUM7UUFDeEQsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsTUFBTSxPQUFPLEdBQUcsYUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUMxQyxNQUFNLE9BQU8sR0FBRyxjQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ3hFLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDN0MsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFHRCxLQUFLLENBQUMsbUJBQW1CO1FBQ3JCLElBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFHO1lBQzVELE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsSUFBSSx3QkFBd0IsQ0FBQyxDQUFDO1lBQzFELE9BQU8sU0FBUyxDQUFBO1NBQ25CO1FBQ0QsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUM5QyxNQUFNLFVBQVUsR0FBRyxnRUFBZ0UsQ0FBQztRQUNwRixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLFVBQVUsS0FBSyxJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsRUFBRSxRQUFRLEVBQUcsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzFGLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLEtBQUssT0FBTyxDQUFDLENBQUM7UUFDbEYsT0FBTyxDQUFFLFFBQVEsRUFBRSxNQUFNLENBQUUsQ0FBQztJQUNoQyxDQUFDO0lBR0QsTUFBTTtRQUNGLE9BQU8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUVELE1BQU07UUFDRixFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBRUQsSUFBSTtRQUNBLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0NBQ0o7QUFFRCxNQUFNLEdBQUc7SUFRTCxZQUFZLFNBQWlCO1FBQ3pCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxTQUFTLE1BQU0sQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxTQUFTLFNBQVMsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxTQUFTLFVBQVUsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFRCxNQUFNO1FBQ0YsT0FBTyxDQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFFLENBQUM7SUFDNUMsQ0FBQztJQUdELFdBQVc7UUFDUCxNQUFNLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDcEIsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0RCxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2xELFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFcEQsYUFBYTtRQUNiLE9BQU8sUUFBUSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxRQUFRO1FBQ0osT0FBTyxDQUNILElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2VBQ2YsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7ZUFDaEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FDdkIsQ0FBQztJQUNOLENBQUM7SUFFRCxRQUFRO1FBQ0osT0FBTyxDQUNILElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO2VBQ2YsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7ZUFDaEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FDdkIsQ0FBQztJQUVOLENBQUM7SUFFRCxTQUFTO1FBQ0wsSUFBSyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ3ZCLElBQUssSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUU7WUFDakIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUNyQixJQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFO1lBQ2xCLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7SUFFMUIsQ0FBQztJQUVELGdCQUFnQixDQUFDLEtBQVU7UUFDdkIsT0FBTyxDQUFDLElBQUksQ0FBQyxzREFBc0QsQ0FBQyxDQUFDO1FBQ3JFLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQyxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0MsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRWpELENBQUM7Q0FDSjtBQUVELE1BQU0sS0FBSztJQWVQLDJEQUEyRDtJQUMzRCxZQUFZLFNBQWlCO1FBQ3pCLElBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQztZQUM1QixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLElBQUssV0FBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRztZQUNqQyxPQUFPLENBQUMsSUFBSSxDQUFDLHFDQUFxQyxTQUFTLHNCQUFzQixDQUFDLENBQUM7WUFDbkYsU0FBUyxHQUFHLGNBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDMUM7UUFDRCxJQUFLLFNBQVMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRztZQUN6RCxPQUFPLENBQUMsSUFBSSxDQUFDLHFEQUFxRCxTQUFTLGNBQWMsQ0FBQyxDQUFDO1lBQzNGLElBQUksS0FBSyxHQUFHLFNBQUcsQ0FBQyxjQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsU0FBUyxHQUFHLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1NBRXBFO1FBRUQsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFFM0IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUUxQyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUduQyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsTUFBTSxDQUFDLENBQUM7UUFDOUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxNQUFNLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsY0FBYyxDQUFDLENBQUM7SUFFNUQsQ0FBQztJQUVELGtFQUFrRTtJQUNsRSxVQUFVO1FBQ04sSUFBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFHO1lBQ3pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSx1Q0FBdUMsQ0FBQyxDQUFDO1lBQ2pGLE9BQU8sU0FBUyxDQUFBO1NBQ25CO1FBQ0QsTUFBTSxPQUFPLEdBQUcsRUFBRTthQUNiLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxRQUFRLEVBQUcsTUFBTSxFQUFFLENBQUM7YUFDckQsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pCLElBQUksS0FBSyxHQUFXLENBQUMsQ0FBQztRQUN0QixLQUFNLElBQUksQ0FBQyxJQUFJLE9BQU8sRUFBRztZQUNyQixJQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUc7Z0JBQ3BCLE9BQU8sQ0FBQyxJQUFJLENBQUMseUJBQXlCLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQzthQUN4RDtpQkFBTSxJQUFLLFdBQUksQ0FBQyxDQUFDLENBQUMsRUFBRztnQkFDbEIsS0FBSyxFQUFFLENBQUM7YUFDWDtTQUVKO1FBQ0QsT0FBTyxLQUFLLENBQUM7SUFDakIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgbXlmcyBmcm9tICcuLi9NeUZzJ1xuaW1wb3J0IGFzeCBmcm9tICcuLi9hc3gnXG5pbXBvcnQgeyBzdHIgfSBmcm9tIFwiLi4vc3RyXCI7XG5pbXBvcnQgeyBkYXRlIH0gZnJvbSBcIi4uL015RGF0ZVwiO1xuaW1wb3J0IHsgYm9vbCwgYWxsLCBhbnkgfSBmcm9tIFwiLi4vdXRpbFwiO1xuXG4vKipBbiBvYmplY3Qgd3JhcHBpbmcgYSBwYXRoIHdpdGggZXh0ZW5zaW9uLiBDYW4gYmUgYWJzb2x1dGUgb3IgYmFzZS5cbiAqIGBgdG9TdHJpbmcoKWBgIHJldHVybnMgYGB0aGlzLnBhdGhgYC5cbiAqIGBgbmFtZWBgIHByb3BlcnR5IGV4aXN0cyBvbmx5IGlmIHdyYXBwaW5nIGFuIGFic29sdXRlIHBhdGguKi9cbmNsYXNzIEZpbGUge1xuICAgIC8qKlRoZSBwYXRoIGluY2x1ZGluZyBleHRlbnNpb24uIENhbiBiZSBlaXRoZXIgYWJzb2x1dGUgb3IgYSBmaWxlIG5hbWUuKi9cbiAgICByZWFkb25seSBwYXRoOiBzdHJpbmc7XG4gICAgLyoqVGhlIHBhdGggd2l0aG91dCBleHRlbnNpb24uIENhbiBiZSBlaXRoZXIgYWJzb2x1dGUgb3IgYSBmaWxlIG5hbWUuKi9cbiAgICBwcml2YXRlIHBhdGhOb0V4dDogc3RyaW5nO1xuICAgIC8qKklmIGV4aXN0cywgYSBGaWxlIG9iamVjdCBvZiB0aGUgYmFzZW5hbWUuKi9cbiAgICBwcml2YXRlIG5hbWU6IEZpbGU7XG4gICAgXG4gICAgY29uc3RydWN0b3IocGF0aFdpdGhFeHQ6IHN0cmluZykge1xuICAgICAgICBpZiAoICFib29sKHBhdGguZXh0bmFtZShwYXRoV2l0aEV4dCkpICkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGaWxlIGNvbnN0cnVjdG9yOiBwYXNzZWQgJ3BhdGhXaXRoRXh0JyBpcyBleHRlbnNpb25sZXNzOiAke3BhdGhXaXRoRXh0fWApO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0aGlzLnBhdGggPSBwYXRoV2l0aEV4dDtcbiAgICAgICAgXG4gICAgICAgIHRoaXMucGF0aE5vRXh0ID0gbXlmcy5yZW1vdmVfZXh0KHRoaXMucGF0aCk7XG4gICAgICAgIGlmICggcGF0aC5pc0Fic29sdXRlKHRoaXMucGF0aCkgKVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLm5hbWUgPSBuZXcgRmlsZShwYXRoLmJhc2VuYW1lKHRoaXMucGF0aCkpO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBhdGg7XG4gICAgfVxuICAgIFxuICAgIHJlbmFtZUJ5T3RoZXJGaWxlKG90aGVyOiBGaWxlKSB7XG4gICAgICAgIGNvbnNvbGUud2FybigncmVuYW1lQnlPdGhlckZpbGUgbm90IHNldHRpbmcgbmV3IHRoaXMucGF0aCcpO1xuICAgICAgICBmcy5yZW5hbWVTeW5jKHRoaXMucGF0aCwgb3RoZXIucGF0aCk7XG4gICAgfVxuICAgIFxuICAgIHJlbmFtZUJ5Q1RpbWUoKSB7XG4gICAgICAgIGNvbnNvbGUud2FybigncmVuYW1lQnlDVGltZSBub3Qgc2V0dGluZyBuZXcgdGhpcy5wYXRoJyk7XG4gICAgICAgIGNvbnN0IHN0YXRzID0gZnMubHN0YXRTeW5jKHRoaXMucGF0aCk7XG4gICAgICAgIGNvbnN0IGRhdGVzdHIgPSBkYXRlKHN0YXRzLmN0aW1lKS5odW1hbigpO1xuICAgICAgICBjb25zdCBuZXdQYXRoID0gbXlmcy5wdXNoX2JlZm9yZV9leHQodGhpcy5wYXRoLCBgX19DUkVBVEVEXyR7ZGF0ZXN0cn1gKTtcbiAgICAgICAgY29uc29sZS5sb2coJ3JlbmFtZUJ5Q1RpbWUoKSB0bzogJywgbmV3UGF0aCk7XG4gICAgICAgIGZzLnJlbmFtZVN5bmModGhpcy5wYXRoLCBuZXdQYXRoKTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgZ2V0Qml0cmF0ZUFuZEhlaWdodCgpOiBQcm9taXNlPFsgc3RyaW5nLCBzdHJpbmcgXT4ge1xuICAgICAgICBpZiAoICF0aGlzLnBhdGguZW5kc1dpdGgoJ21wNCcpICYmICF0aGlzLnBhdGguZW5kc1dpdGgoJ21vdicpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBGaWxlOiBcIiR7dGhpcy5wYXRofVwiIGlzbid0IFwibXA0XCIgb3IgXCJtb3ZcImApO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHsgZXhlY1N5bmMgfSA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbiAgICAgICAgY29uc3QgZmZwcm9iZUNtZCA9IGBmZnByb2JlIC12IHF1aWV0IC1wcmludF9mb3JtYXQganNvbiAtc2hvd19zdHJlYW1zIC1zaG93X2Zvcm1hdGA7XG4gICAgICAgIGNvbnN0IHByb2JlID0gSlNPTi5wYXJzZShleGVjU3luYyhgJHtmZnByb2JlQ21kfSBcIiR7dGhpcy5wYXRofVwiYCwgeyBlbmNvZGluZyA6ICd1dGY4JyB9KSk7XG4gICAgICAgIGNvbnN0IHsgYml0X3JhdGUsIGhlaWdodCB9ID0gcHJvYmUuc3RyZWFtcy5maW5kKHMgPT4gc1tcImNvZGVjX3R5cGVcIl0gPT09IFwidmlkZW9cIik7XG4gICAgICAgIHJldHVybiBbIGJpdF9yYXRlLCBoZWlnaHQgXTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgZXhpc3RzKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZnMuZXhpc3RzU3luYyh0aGlzLnBhdGgpO1xuICAgIH1cbiAgICBcbiAgICByZW1vdmUoKSB7XG4gICAgICAgIGZzLnVubGlua1N5bmModGhpcy5wYXRoKTtcbiAgICB9XG4gICAgXG4gICAgc2l6ZSgpOiBudW1iZXIge1xuICAgICAgICBsZXQgeyBzaXplIH0gPSBmcy5sc3RhdFN5bmModGhpcy5wYXRoKTtcbiAgICAgICAgcmV0dXJuIHNpemU7XG4gICAgfVxufVxuXG5jbGFzcyBUeHQge1xuICAgIC8qKkEgRmlsZSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBhYnNvbHV0ZSBgYCoudHh0YGAgcGF0aC4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFzZTogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWJzb2x1dGUgYGAqX29uLnR4dGBgICBwYXRoLiovXG4gICAgcmVhZG9ubHkgb246IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKl9vZmYudHh0YGAgcGF0aC4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgb2ZmOiBGaWxlO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKHBhdGhOb0V4dDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuYmFzZSA9IG5ldyBGaWxlKGAke3BhdGhOb0V4dH0udHh0YCk7XG4gICAgICAgIHRoaXMub24gPSBuZXcgRmlsZShgJHtwYXRoTm9FeHR9X29uLnR4dGApO1xuICAgICAgICB0aGlzLm9mZiA9IG5ldyBGaWxlKGAke3BhdGhOb0V4dH1fb2ZmLnR4dGApO1xuICAgIH1cbiAgICBcbiAgICBnZXRBbGwoKTogWyBGaWxlLCBGaWxlLCBGaWxlIF0ge1xuICAgICAgICByZXR1cm4gWyB0aGlzLmJhc2UsIHRoaXMub24sIHRoaXMub2ZmIF07XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGdldEV4aXN0aW5nKCk6IFsgKEZpbGUgfCBmYWxzZSksIChGaWxlIHwgZmFsc2UpLCAoRmlsZSB8IGZhbHNlKSBdIHtcbiAgICAgICAgY29uc3QgZXhpc3RpbmcgPSBbXTtcbiAgICAgICAgZXhpc3RpbmcucHVzaCh0aGlzLmJhc2UuZXhpc3RzKCkgPyB0aGlzLmJhc2UgOiBmYWxzZSk7XG4gICAgICAgIGV4aXN0aW5nLnB1c2godGhpcy5vbi5leGlzdHMoKSA/IHRoaXMub24gOiBmYWxzZSk7XG4gICAgICAgIGV4aXN0aW5nLnB1c2godGhpcy5vZmYuZXhpc3RzKCkgPyB0aGlzLm9mZiA6IGZhbHNlKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgcmV0dXJuIGV4aXN0aW5nO1xuICAgIH1cbiAgICBcbiAgICBhbGxFeGlzdCgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIHRoaXMuYmFzZS5leGlzdHMoKVxuICAgICAgICAgICAgJiYgdGhpcy5vbi5leGlzdHMoKVxuICAgICAgICAgICAgJiYgdGhpcy5vZmYuZXhpc3RzKClcbiAgICAgICAgKTtcbiAgICB9XG4gICAgXG4gICAgYW55RXhpc3QoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgICB0aGlzLmJhc2UuZXhpc3RzKClcbiAgICAgICAgICAgIHx8IHRoaXMub24uZXhpc3RzKClcbiAgICAgICAgICAgIHx8IHRoaXMub2ZmLmV4aXN0cygpXG4gICAgICAgICk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICByZW1vdmVBbGwoKTogdm9pZCB7XG4gICAgICAgIGlmICggdGhpcy5iYXNlLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMuYmFzZS5yZW1vdmUoKTtcbiAgICAgICAgaWYgKCB0aGlzLm9uLmV4aXN0cygpIClcbiAgICAgICAgICAgIHRoaXMub24ucmVtb3ZlKCk7XG4gICAgICAgIGlmICggdGhpcy5vZmYuZXhpc3RzKCkgKVxuICAgICAgICAgICAgdGhpcy5vZmYucmVtb3ZlKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICByZW5hbWVCeU90aGVyVHh0KG90aGVyOiBUeHQpOiB2b2lkIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdyZW5hbWVCeU90aGVyVHh0OiBkaWRudCBzZXQgbmV3IHRoaXMgYmFzZSAvIG9uIC8gb2ZmJyk7XG4gICAgICAgIGZzLnJlbmFtZVN5bmModGhpcy5iYXNlLnBhdGgsIG90aGVyLmJhc2UucGF0aCk7XG4gICAgICAgIGZzLnJlbmFtZVN5bmModGhpcy5vbi5wYXRoLCBvdGhlci5vbi5wYXRoKTtcbiAgICAgICAgZnMucmVuYW1lU3luYyh0aGlzLm9mZi5wYXRoLCBvdGhlci5vZmYucGF0aCk7XG4gICAgICAgIFxuICAgIH1cbn1cblxuY2xhc3MgVHJ1dGgge1xuICAgIC8qKlRoZSBhYnNvbHV0ZSBwYXRoIHdpdGhvdXQgZXh0ZW5zaW9uLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBwYXRoTm9FeHQ6IHN0cmluZztcbiAgICAvKipUaGUgYmFzZW5hbWUgd2l0aG91dCBleHRlbnNpb24uKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgICBwcml2YXRlIHJlYWRvbmx5IHR4dDogVHh0O1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG1pZGkgZmlsZS4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbWlkaTogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBtcDQgZmlsZS4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbXA0OiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG1vdiBmaWxlLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBtb3Y6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgb25zZXRzIGZpbGUuKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IG9uc2V0czogRmlsZTtcbiAgICBcbiAgICAvKipBbiBvYmplY3Qgd3JhcHBpbmcgYW4gYWJzb2x1dGUgcGF0aCB3aXRob3V0IGV4dGVuc2lvbi4qL1xuICAgIGNvbnN0cnVjdG9yKHBhdGhOb0V4dDogc3RyaW5nKSB7XG4gICAgICAgIGlmICggIXBhdGguaXNBYnNvbHV0ZShwYXRoTm9FeHQpIClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIHBhdGggaXMgbm90IGFic29sdXRlOiAke3BhdGhOb0V4dH1gKTtcbiAgICAgICAgaWYgKCBib29sKHBhdGguZXh0bmFtZShwYXRoTm9FeHQpKSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgUGFzc2VkIHBhdGggaXMgbm90IGV4dGVuc2lvbmxlc3M6ICR7cGF0aE5vRXh0fS4gUmVtb3ZpbmcgZXh0ZW5zaW9uYCk7XG4gICAgICAgICAgICBwYXRoTm9FeHQgPSBteWZzLnJlbW92ZV9leHQocGF0aE5vRXh0KTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIHBhdGhOb0V4dC5lbmRzV2l0aCgnb2ZmJykgfHwgcGF0aE5vRXh0LmVuZHNXaXRoKCdvbicpICkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGBQYXNzZWQgcGF0aCBvZiBcIl9vblwiIG9yIFwiX29mZlwiIGZpbGUgYW5kIG5vdCBiYXNlOiAke3BhdGhOb0V4dH0uIFVzaW5nIGJhc2VgKTtcbiAgICAgICAgICAgIGxldCBub0V4dCA9IHN0cihteWZzLnJlbW92ZV9leHQocGF0aE5vRXh0KSk7XG4gICAgICAgICAgICBwYXRoTm9FeHQgPSBgJHtub0V4dC51cFRvKCdfJywgdHJ1ZSl9JHtwYXRoLmV4dG5hbWUocGF0aE5vRXh0KX1gO1xuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMucGF0aE5vRXh0ID0gcGF0aE5vRXh0O1xuICAgICAgICBcbiAgICAgICAgdGhpcy5uYW1lID0gcGF0aC5iYXNlbmFtZSh0aGlzLnBhdGhOb0V4dCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnR4dCA9IG5ldyBUeHQodGhpcy5wYXRoTm9FeHQpO1xuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMubWlkaSA9IG5ldyBGaWxlKGAke3RoaXMucGF0aE5vRXh0fS5taWRgKTtcbiAgICAgICAgdGhpcy5tcDQgPSBuZXcgRmlsZShgJHt0aGlzLnBhdGhOb0V4dH0ubXA0YCk7XG4gICAgICAgIHRoaXMubW92ID0gbmV3IEZpbGUoYCR7dGhpcy5wYXRoTm9FeHR9Lm1vdmApO1xuICAgICAgICB0aGlzLm9uc2V0cyA9IG5ldyBGaWxlKGAke3RoaXMucGF0aE5vRXh0fV9vbnNldHMuanNvbmApO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgLyoqQ291bnRzIHRoZSBudW1iZXIgb2Ygbm9uLWVtcHR5IGxpbmVzIGluIHRoZSB0eHQgb24gcGF0aCBmaWxlLiovXG4gICAgbnVtT2ZOb3RlcygpOiBudW1iZXIge1xuICAgICAgICBpZiAoICF0aGlzLnR4dC5vbi5leGlzdHMoKSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgdGhpcy50eHQub24gKCR7dGhpcy50eHQub259KSBkb2VzIG5vdCBleGlzdCwgcmV0dXJuaW5nIHVuZGVmaW5lZGApO1xuICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN0cmluZ3MgPSBmc1xuICAgICAgICAgICAgLnJlYWRGaWxlU3luYyh0aGlzLnR4dC5vbi5wYXRoLCB7IGVuY29kaW5nIDogJ3V0ZjgnIH0pXG4gICAgICAgICAgICAuc3BsaXQoJ1xcbicpO1xuICAgICAgICBsZXQgbm90ZXM6IG51bWJlciA9IDA7XG4gICAgICAgIGZvciAoIGxldCBzIG9mIHN0cmluZ3MgKSB7XG4gICAgICAgICAgICBpZiAoIHMuaW5jbHVkZXMoJ1xcXFwnKSApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYHMgaW5jbHVkZXMgYmFja3NsYXNoLCAke3RoaXMudHh0Lm9ufWApO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggYm9vbChzKSApIHtcbiAgICAgICAgICAgICAgICBub3RlcysrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5vdGVzO1xuICAgIH1cbn1cbiJdfQ==