"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const MyFs_1 = require("../MyFs");
const asx_1 = require("../asx");
const MyDate_1 = require("../MyDate");
/**An object wrapping a path with extension. Can be absolute or base.
 * ``toString()`` returns ``this.path``.
 * ``name`` property exists only if wrapping an absolute path.*/
class File {
    constructor(pathWithExt) {
        if (!bool(path.extname(pathWithExt)))
            throw new Error(`File constructor: passed 'pathWithExt' is extensionless: ${pathWithExt}`);
        this.path = pathWithExt;
        this.pathNoExt = MyFs_1.default.remove_ext(this.path);
        if (path.isAbsolute(this.path))
            this.name = new File(path.basename(this.path));
    }
    toString() {
        return this.path;
    }
    async renameByOtherFile(other) {
        const fs = require("fs");
        await fs.renameSync(this.path, other.path);
    }
    async renameByCTime() {
        const stats = fs.lstatSync(this.path);
        const datestr = MyDate_1.date(stats.ctime).human();
        const newPath = MyFs_1.default.push_before_ext(this.path, `__CREATED_${datestr}`);
        console.log('renameByCTime() to: ', newPath);
        await fs.renameSync(this.path, newPath);
    }
    async getBitrateAndHeight() {
        if (!this.path.endsWith('mp4') && !this.path.endsWith('mov')) {
            console.warn(`File: "${this.path}" isn't "mp4" or "mov"`);
            return undefined;
        }
        const { execSync } = require('child_process');
        const ffprobeCmd = `ffprobe -v quiet -print_format json -show_streams -show_format`;
        const probe = JSON.parse(await execSync(`${ffprobeCmd} "${this.path}"`, { encoding: 'utf8' }));
        const { bit_rate, height } = probe.streams.find(s => s["codec_type"] == "video");
        return [bit_rate, height];
    }
    async exists() {
        return await MyFs_1.default.path_exists(this.path);
    }
    remove() {
        fs.unlinkSync(this.path);
    }
    size() {
        let { size } = fs.lstatSync(this.path);
        return size;
    }
}
class Txt {
    constructor(pathNoExt) {
        this.base = new File(`${pathNoExt}.txt`);
        this.on = new File(`${pathNoExt}_on.txt`);
        this.off = new File(`${pathNoExt}_off.txt`);
    }
    getAll() {
        return [this.base, this.on, this.off];
    }
    async getMissing() {
        let missing = [];
        if (!(await this.base.exists()))
            missing.push(this.base);
        if (!(await this.on.exists()))
            missing.push(this.on);
        if (!(await this.off.exists()))
            missing.push(this.off);
        return missing;
    }
    async allExist() {
        return all(await asx_1.default.concurrent(this.base.exists(), this.on.exists(), this.off.exists()));
    }
    async anyExist() {
        return any(await asx_1.default.concurrent(this.base.exists(), this.on.exists(), this.off.exists()));
    }
    async removeAll() {
        if (await this.base.exists())
            await this.base.remove();
        if (await this.on.exists())
            await this.on.remove();
        if (await this.off.exists())
            await this.off.remove();
    }
    async renameByOtherTxt(other) {
        console.warn('renameByOtherTxt: didnt set new this props');
        return await asx_1.default.concurrent(fs.renameSync(this.base.path, other.base.path), fs.renameSync(this.on.path, other.on.path), fs.renameSync(this.off.path, other.off.path));
    }
}
class Truth {
    /**An object wrapping an absolute path without extension.*/
    constructor(pathNoExt) {
        if (!path.isAbsolute(pathNoExt))
            throw new Error(`Passed path is not absolute: ${pathNoExt}`);
        if (bool(path.extname(pathNoExt)))
            throw new Error(`Passed path is not extensionless: ${pathNoExt}`);
        if (pathNoExt.endsWith('off') || pathNoExt.endsWith('on'))
            throw new Error(`Passed path of "_on" or "_off" file and not base: ${pathNoExt}`);
        this.pathNoExt = pathNoExt;
        this.name = path.basename(this.pathNoExt);
        this.txt = new Txt(this.pathNoExt);
        this.midi = new File(`${this.pathNoExt}.mid`);
        this.mp4 = new File(`${this.pathNoExt}.mp4`);
        this.mov = new File(`${this.pathNoExt}.mov`);
        this.onsets = new File(`${this.pathNoExt}_onsets.json`);
    }
    /**Counts the number of non-empty lines in the txt on path file.*/
    numOfNotes() {
        return fs
            .readFileSync(this.txt.on.path, { encoding: 'utf8' })
            .split('\n')
            .filter(line => bool(line)).length;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDZCQUE2QjtBQUM3Qix5QkFBd0I7QUFDeEIsa0NBQTBCO0FBQzFCLGdDQUF3QjtBQUV4QixzQ0FBaUM7QUFFakM7O2dFQUVnRTtBQUNoRSxNQUFNLElBQUk7SUFRTixZQUFZLFdBQVc7UUFDbkIsSUFBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQ2pDLE1BQU0sSUFBSSxLQUFLLENBQUMsNERBQTRELFdBQVcsRUFBRSxDQUFDLENBQUM7UUFFL0YsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUM7UUFFeEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxjQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1QyxJQUFLLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQztZQUUzQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFdkQsQ0FBQztJQUVELFFBQVE7UUFDSixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUVELEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxLQUFXO1FBQy9CLE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QixNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVELEtBQUssQ0FBQyxhQUFhO1FBRWYsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEMsTUFBTSxPQUFPLEdBQUcs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QUcsSUFBSSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxNQUFNLENBQUMsQ0FBQztRQUM5QyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsTUFBTSxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxTQUFTLE1BQU0sQ0FBQyxDQUFDO1FBQzdDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxjQUFjLENBQUMsQ0FBQztJQUU1RCxDQUFDO0lBRUQsa0VBQWtFO0lBQ2xFLFVBQVU7UUFDTixPQUFPLEVBQUU7YUFDSixZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUUsUUFBUSxFQUFHLE1BQU0sRUFBRSxDQUFDO2FBQ3JELEtBQUssQ0FBQyxJQUFJLENBQUM7YUFDWCxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDM0MsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXG5pbXBvcnQgbXlmcyBmcm9tICcuLi9NeUZzJ1xuaW1wb3J0IGFzeCBmcm9tICcuLi9hc3gnXG5pbXBvcnQgeyBzdHIgfSBmcm9tIFwiLi4vc3RyXCI7XG5pbXBvcnQgeyBkYXRlIH0gZnJvbSBcIi4uL015RGF0ZVwiO1xuXG4vKipBbiBvYmplY3Qgd3JhcHBpbmcgYSBwYXRoIHdpdGggZXh0ZW5zaW9uLiBDYW4gYmUgYWJzb2x1dGUgb3IgYmFzZS5cbiAqIGBgdG9TdHJpbmcoKWBgIHJldHVybnMgYGB0aGlzLnBhdGhgYC5cbiAqIGBgbmFtZWBgIHByb3BlcnR5IGV4aXN0cyBvbmx5IGlmIHdyYXBwaW5nIGFuIGFic29sdXRlIHBhdGguKi9cbmNsYXNzIEZpbGUge1xuICAgIC8qKlRoZSBwYXRoIGluY2x1ZGluZyBleHRlbnNpb24uIENhbiBiZSBlaXRoZXIgYWJzb2x1dGUgb3IgYSBmaWxlIG5hbWUuKi9cbiAgICByZWFkb25seSBwYXRoOiBzdHJpbmc7XG4gICAgLyoqVGhlIHBhdGggd2l0aG91dCBleHRlbnNpb24uIENhbiBiZSBlaXRoZXIgYWJzb2x1dGUgb3IgYSBmaWxlIG5hbWUuKi9cbiAgICBwcml2YXRlIHBhdGhOb0V4dDogc3RyaW5nO1xuICAgIC8qKklmIGV4aXN0cywgYSBGaWxlIG9iamVjdCBvZiB0aGUgYmFzZW5hbWUuKi9cbiAgICBwcml2YXRlIG5hbWU6IEZpbGU7XG4gICAgXG4gICAgY29uc3RydWN0b3IocGF0aFdpdGhFeHQpIHtcbiAgICAgICAgaWYgKCAhYm9vbChwYXRoLmV4dG5hbWUocGF0aFdpdGhFeHQpKSApXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZpbGUgY29uc3RydWN0b3I6IHBhc3NlZCAncGF0aFdpdGhFeHQnIGlzIGV4dGVuc2lvbmxlc3M6ICR7cGF0aFdpdGhFeHR9YCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnBhdGggPSBwYXRoV2l0aEV4dDtcbiAgICAgICAgXG4gICAgICAgIHRoaXMucGF0aE5vRXh0ID0gbXlmcy5yZW1vdmVfZXh0KHRoaXMucGF0aCk7XG4gICAgICAgIGlmICggcGF0aC5pc0Fic29sdXRlKHRoaXMucGF0aCkgKVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLm5hbWUgPSBuZXcgRmlsZShwYXRoLmJhc2VuYW1lKHRoaXMucGF0aCkpO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBhdGg7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIHJlbmFtZUJ5T3RoZXJGaWxlKG90aGVyOiBGaWxlKSB7XG4gICAgICAgIGNvbnN0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuICAgICAgICBhd2FpdCBmcy5yZW5hbWVTeW5jKHRoaXMucGF0aCwgb3RoZXIucGF0aCk7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIHJlbmFtZUJ5Q1RpbWUoKSB7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBzdGF0cyA9IGZzLmxzdGF0U3luYyh0aGlzLnBhdGgpO1xuICAgICAgICBjb25zdCBkYXRlc3RyID0gZGF0ZShzdGF0cy5jdGltZSkuaHVtYW4oKTtcbiAgICAgICAgY29uc3QgbmV3UGF0aCA9IG15ZnMucHVzaF9iZWZvcmVfZXh0KHRoaXMucGF0aCwgYF9fQ1JFQVRFRF8ke2RhdGVzdHJ9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdyZW5hbWVCeUNUaW1lKCkgdG86ICcsIG5ld1BhdGgpO1xuICAgICAgICBhd2FpdCBmcy5yZW5hbWVTeW5jKHRoaXMucGF0aCwgbmV3UGF0aCk7XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGFzeW5jIGdldEJpdHJhdGVBbmRIZWlnaHQoKTogUHJvbWlzZTxbIHN0cmluZywgc3RyaW5nIF0+IHtcbiAgICAgICAgaWYgKCAhdGhpcy5wYXRoLmVuZHNXaXRoKCdtcDQnKSAmJiAhdGhpcy5wYXRoLmVuZHNXaXRoKCdtb3YnKSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgRmlsZTogXCIke3RoaXMucGF0aH1cIiBpc24ndCBcIm1wNFwiIG9yIFwibW92XCJgKTtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWRcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB7IGV4ZWNTeW5jIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7XG4gICAgICAgIGNvbnN0IGZmcHJvYmVDbWQgPSBgZmZwcm9iZSAtdiBxdWlldCAtcHJpbnRfZm9ybWF0IGpzb24gLXNob3dfc3RyZWFtcyAtc2hvd19mb3JtYXRgO1xuICAgICAgICBjb25zdCBwcm9iZSA9IEpTT04ucGFyc2UoYXdhaXQgZXhlY1N5bmMoYCR7ZmZwcm9iZUNtZH0gXCIke3RoaXMucGF0aH1cImAsIHsgZW5jb2RpbmcgOiAndXRmOCcgfSkpO1xuICAgICAgICBjb25zdCB7IGJpdF9yYXRlLCBoZWlnaHQgfSA9IHByb2JlLnN0cmVhbXMuZmluZChzID0+IHNbXCJjb2RlY190eXBlXCJdID09IFwidmlkZW9cIik7XG4gICAgICAgIHJldHVybiBbIGJpdF9yYXRlLCBoZWlnaHQgXTtcbiAgICB9XG4gICAgXG4gICAgXG4gICAgYXN5bmMgZXhpc3RzKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgbXlmcy5wYXRoX2V4aXN0cyh0aGlzLnBhdGgpO1xuICAgIH1cbiAgICBcbiAgICByZW1vdmUoKSB7XG4gICAgICAgIGZzLnVubGlua1N5bmModGhpcy5wYXRoKTtcbiAgICB9XG4gICAgXG4gICAgc2l6ZSgpOiBudW1iZXIge1xuICAgICAgICBsZXQgeyBzaXplIH0gPSBmcy5sc3RhdFN5bmModGhpcy5wYXRoKTtcbiAgICAgICAgcmV0dXJuIHNpemU7XG4gICAgfVxufVxuXG5jbGFzcyBUeHQge1xuICAgIC8qKkEgRmlsZSBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBhYnNvbHV0ZSBgYCoudHh0YGAgcGF0aC4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgYmFzZTogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYWJzb2x1dGUgYGAqX29uLnR4dGBgICBwYXRoLiovXG4gICAgcmVhZG9ubHkgb246IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIGFic29sdXRlIGBgKl9vZmYudHh0YGAgcGF0aC4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgb2ZmOiBGaWxlO1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKHBhdGhOb0V4dDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuYmFzZSA9IG5ldyBGaWxlKGAke3BhdGhOb0V4dH0udHh0YCk7XG4gICAgICAgIHRoaXMub24gPSBuZXcgRmlsZShgJHtwYXRoTm9FeHR9X29uLnR4dGApO1xuICAgICAgICB0aGlzLm9mZiA9IG5ldyBGaWxlKGAke3BhdGhOb0V4dH1fb2ZmLnR4dGApO1xuICAgIH1cbiAgICBcbiAgICBnZXRBbGwoKTogWyBGaWxlLCBGaWxlLCBGaWxlIF0ge1xuICAgICAgICByZXR1cm4gWyB0aGlzLmJhc2UsIHRoaXMub24sIHRoaXMub2ZmIF07XG4gICAgfVxuICAgIFxuICAgIFxuICAgIGFzeW5jIGdldE1pc3NpbmcoKTogUHJvbWlzZTxGaWxlW10+IHtcbiAgICAgICAgbGV0IG1pc3NpbmcgPSBbXTtcbiAgICAgICAgaWYgKCAhKGF3YWl0IHRoaXMuYmFzZS5leGlzdHMoKSkgKVxuICAgICAgICAgICAgbWlzc2luZy5wdXNoKHRoaXMuYmFzZSk7XG4gICAgICAgIGlmICggIShhd2FpdCB0aGlzLm9uLmV4aXN0cygpKSApXG4gICAgICAgICAgICBtaXNzaW5nLnB1c2godGhpcy5vbik7XG4gICAgICAgIGlmICggIShhd2FpdCB0aGlzLm9mZi5leGlzdHMoKSkgKVxuICAgICAgICAgICAgbWlzc2luZy5wdXNoKHRoaXMub2ZmKTtcbiAgICAgICAgXG4gICAgICAgIHJldHVybiBtaXNzaW5nO1xuICAgIH1cbiAgICBcbiAgICBhc3luYyBhbGxFeGlzdCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIGFsbChhd2FpdCBhc3guY29uY3VycmVudChcbiAgICAgICAgICAgIHRoaXMuYmFzZS5leGlzdHMoKSxcbiAgICAgICAgICAgIHRoaXMub24uZXhpc3RzKCksXG4gICAgICAgICAgICB0aGlzLm9mZi5leGlzdHMoKSkpO1xuICAgIH1cbiAgICBcbiAgICBhc3luYyBhbnlFeGlzdCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIGFueShhd2FpdCBhc3guY29uY3VycmVudChcbiAgICAgICAgICAgIHRoaXMuYmFzZS5leGlzdHMoKSxcbiAgICAgICAgICAgIHRoaXMub24uZXhpc3RzKCksXG4gICAgICAgICAgICB0aGlzLm9mZi5leGlzdHMoKSkpO1xuICAgIH1cbiAgICBcbiAgICBhc3luYyByZW1vdmVBbGwoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICggYXdhaXQgdGhpcy5iYXNlLmV4aXN0cygpIClcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYmFzZS5yZW1vdmUoKTtcbiAgICAgICAgaWYgKCBhd2FpdCB0aGlzLm9uLmV4aXN0cygpIClcbiAgICAgICAgICAgIGF3YWl0IHRoaXMub24ucmVtb3ZlKCk7XG4gICAgICAgIGlmICggYXdhaXQgdGhpcy5vZmYuZXhpc3RzKCkgKVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5vZmYucmVtb3ZlKCk7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBhc3luYyByZW5hbWVCeU90aGVyVHh0KG90aGVyOiBUeHQpOiBQcm9taXNlPHVua25vd25bXT4ge1xuICAgICAgICBjb25zb2xlLndhcm4oJ3JlbmFtZUJ5T3RoZXJUeHQ6IGRpZG50IHNldCBuZXcgdGhpcyBwcm9wcycpO1xuICAgICAgICByZXR1cm4gYXdhaXQgYXN4LmNvbmN1cnJlbnQoXG4gICAgICAgICAgICBmcy5yZW5hbWVTeW5jKHRoaXMuYmFzZS5wYXRoLCBvdGhlci5iYXNlLnBhdGgpLFxuICAgICAgICAgICAgZnMucmVuYW1lU3luYyh0aGlzLm9uLnBhdGgsIG90aGVyLm9uLnBhdGgpLFxuICAgICAgICAgICAgZnMucmVuYW1lU3luYyh0aGlzLm9mZi5wYXRoLCBvdGhlci5vZmYucGF0aCksXG4gICAgICAgICk7XG4gICAgfVxufVxuXG5jbGFzcyBUcnV0aCB7XG4gICAgLyoqVGhlIGFic29sdXRlIHBhdGggd2l0aG91dCBleHRlbnNpb24uKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IHBhdGhOb0V4dDogc3RyaW5nO1xuICAgIC8qKlRoZSBiYXNlbmFtZSB3aXRob3V0IGV4dGVuc2lvbi4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgdHh0OiBUeHQ7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbWlkaSBmaWxlLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBtaWRpOiBGaWxlO1xuICAgIC8qKkEgRmlsZSBvYmplY3Qgb2YgdGhlIG1wNCBmaWxlLiovXG4gICAgcHJpdmF0ZSByZWFkb25seSBtcDQ6IEZpbGU7XG4gICAgLyoqQSBGaWxlIG9iamVjdCBvZiB0aGUgbW92IGZpbGUuKi9cbiAgICBwcml2YXRlIHJlYWRvbmx5IG1vdjogRmlsZTtcbiAgICAvKipBIEZpbGUgb2JqZWN0IG9mIHRoZSBvbnNldHMgZmlsZS4qL1xuICAgIHByaXZhdGUgcmVhZG9ubHkgb25zZXRzOiBGaWxlO1xuICAgIFxuICAgIC8qKkFuIG9iamVjdCB3cmFwcGluZyBhbiBhYnNvbHV0ZSBwYXRoIHdpdGhvdXQgZXh0ZW5zaW9uLiovXG4gICAgY29uc3RydWN0b3IocGF0aE5vRXh0OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKCAhcGF0aC5pc0Fic29sdXRlKHBhdGhOb0V4dCkgKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQYXNzZWQgcGF0aCBpcyBub3QgYWJzb2x1dGU6ICR7cGF0aE5vRXh0fWApO1xuICAgICAgICBpZiAoIGJvb2wocGF0aC5leHRuYW1lKHBhdGhOb0V4dCkpIClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIHBhdGggaXMgbm90IGV4dGVuc2lvbmxlc3M6ICR7cGF0aE5vRXh0fWApO1xuICAgICAgICBpZiAoIHBhdGhOb0V4dC5lbmRzV2l0aCgnb2ZmJykgfHwgcGF0aE5vRXh0LmVuZHNXaXRoKCdvbicpIClcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgUGFzc2VkIHBhdGggb2YgXCJfb25cIiBvciBcIl9vZmZcIiBmaWxlIGFuZCBub3QgYmFzZTogJHtwYXRoTm9FeHR9YCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnBhdGhOb0V4dCA9IHBhdGhOb0V4dDtcbiAgICAgICAgXG4gICAgICAgIHRoaXMubmFtZSA9IHBhdGguYmFzZW5hbWUodGhpcy5wYXRoTm9FeHQpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy50eHQgPSBuZXcgVHh0KHRoaXMucGF0aE5vRXh0KTtcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICB0aGlzLm1pZGkgPSBuZXcgRmlsZShgJHt0aGlzLnBhdGhOb0V4dH0ubWlkYCk7XG4gICAgICAgIHRoaXMubXA0ID0gbmV3IEZpbGUoYCR7dGhpcy5wYXRoTm9FeHR9Lm1wNGApO1xuICAgICAgICB0aGlzLm1vdiA9IG5ldyBGaWxlKGAke3RoaXMucGF0aE5vRXh0fS5tb3ZgKTtcbiAgICAgICAgdGhpcy5vbnNldHMgPSBuZXcgRmlsZShgJHt0aGlzLnBhdGhOb0V4dH1fb25zZXRzLmpzb25gKTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIC8qKkNvdW50cyB0aGUgbnVtYmVyIG9mIG5vbi1lbXB0eSBsaW5lcyBpbiB0aGUgdHh0IG9uIHBhdGggZmlsZS4qL1xuICAgIG51bU9mTm90ZXMoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIGZzXG4gICAgICAgICAgICAucmVhZEZpbGVTeW5jKHRoaXMudHh0Lm9uLnBhdGgsIHsgZW5jb2RpbmcgOiAndXRmOCcgfSlcbiAgICAgICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgICAgIC5maWx0ZXIobGluZSA9PiBib29sKGxpbmUpKS5sZW5ndGg7XG4gICAgfVxufVxuIl19